(unreleased)
------------
- Soc/qcom/smcinvoke: use size_add from upstream. [pppig236]
- Configs/vendor/oplus/waipio: diable oplus feedback. [pppig236]
- Configs/vendor/oplus: disable esim. [pppig236]
- Configs: oplus: Set localversion to lineage. [razorloves]
- Arm64: Fix CONFIG_64BIT leak to userspace. [Michael Bestas]

  Commit c7c0eecf894c3e353499fffd6f2ddaefc89bbd4a disabled the use of config
  options in uapi headers. Use __aarch64__ which is a compiler-defined
  method of obtaining the architecture instead of CONFIG_64BIT.

  Fixes the following error:
      error: kernel/google/raviole/arch/arm64/include/uapi/asm/sigcontext.h:
          leak CONFIG_64BIT to user-space
- Arm64: Add 32-bit sigcontext definition to uapi signcontext.h. [Ameya
  Thakur]

  The arm64 uapi sigcontext.h can be included by 32-bit userspace
  modules. Since arm and arm64 sigcontext definition are not
  compatible, add arm sigcontext definition to arm64 sigcontext.h.
- Oplus: config: Disable most of the debugging configs. [Pranav Vashi]
- Configs/vendor/oplus/waipio: Relocate tri-state-key to udon.conf.
  [pppig236]
- Waipio: build,defconfig,dtbo: Build separated soc-dtb and board-dtbos.
  [Cyan_Hsieh]
- Editorconfig: Add EditorConfig configuration. [Danny Lin]

  This automatically configures editors that support EditorConfig to
  use the correct settings (i.e. indentation, trailing whitespace,
  new-line style) for our kernel, flasher, and other components.
- Configs/oplus/waipio: disable unused archs. [Juhyung Park]
- Phy: ufs: disable other drivers than cape. [Juhyung Park]
- Configs/vendor/oplus/waipio: Move IR to udon.conf. [pppig236]
- Configs/oplus/waipio: Re-enable diwali pinctl. [pppig236]

  otherwise it boots to bootloader
- Configs/vendor/oplus/waipio: Modify CONFIG_QCOM_WATCHDOG_BARK_TIME.
  [pppig236]
- Remoteproc: qcom: pas: ignore adsp_setup_32b_dma_allocs() failures.
  [Juhyung Park]

  Commit 385297ac92f9 ("remoteproc: qcom: pas: Give 32-bit devices a
  reserved memory area") breaks older device-trees due to early return.

  Add compatibility with older device-trees by ignoring failures here.
- Oplus: ovaltine.config: Build split DTBs. [Bruno Martins]
- ARM64: Add Oplus configuration options for DTBs. [Bruno Martins]
- Arm64: Make __stack_chk_guard visible. [Sultan Alsawaf]

  When LTO is used, GCC optimizes out the __stack_chk_guard variable,
  resulting in undefined symbol errors. Fix it by explicitly making
  __stack_chk_guard visible so it doesn't disappear.
- Configs: disable more debug. [pppig236]
- Qcom-hv-haptics: don't notify from battery module. [pppig236]
- Configs/vendor/oplus/waipio: avoid stack frame too large warnings.
  [Demon000]
- Qcom-hv-haptics: Read fifo-vmax-mv from device tree for custom
  effects. [pjgowtham]

  oplus defines fifo-vmax-mv in device tree to use different vmax for constant effects vs fifo effects.
- Gpu/msm: add option for DRM_PANEL_NOTIFY. [pppig236]
- Oplus_touchpanel_v2: Fix game mode not restoring on wakeup. [LibXZR]

  * Game mode is disabled during suspend but not restored on wakeup.
  * This could cause game mode not taking effect even when "game_switch"
    is enabled.
- Synaptics_tcm_oncell: Correct bits for {LEFT,RIGHT}_VEE. [LuK1337]
- Oplus_touchscreen_v2: Always enable gestures and assign unique
  keycodes. [LuK1337]

  This is required for dt2w and ITouchscreenGesture on LineageOS.
- Oplus_touchscreen_v2: Add software only black gesture indep support.
  [LuK1337]
- Power: oplus_charger: Report discharging status on ui soc update.
  [LuK1337]

  This fixes issue where AOSP Settings thinks we are connected but not
  charging.
- Scripts: add oplus hack for charger. [pppig236]
- Makefile: add oplus hack. [pppig236]
- Android: abi: import oplus changes. [pppig236]
- Add include/ modifications. [pppig236]
- Pinctrl/qcom/msm: add gpio wakup init. [pppig236]
- Staging: import oplus pseudo sensor driver. [pppig236]
- Spi/msm-geni: import oplus changes for IR. [pppig236]
- Iio: import oplus changes for ts. [pppig236]
- I2c|tty: import oplus changes for charger. [pppig236]
- Cnss2: Propagate WLAN MAC to cnss utils. [LuK1337]

  This allows us to use platform driver MAC address provisioning in
  qcacld-3.0.
- Cnss2: Import OnePlus BDF feature. [Bruno Martins]
- Cnss2: Forward port OnePlus MAC feature. [Bruno Martins]
- Add drivers/usb/ modifications. [pppig236]
- Add drivers/thermal/ modifications. [pppig236]
- Add drivers/soc/ modifications. [pppig236]
- Add drivers/power/ modifications. [pppig236]
- Add drivers/misc/ modifications. [pppig236]
- Add drivers/leds/ modifications. [pppig236]
- Add drivers/input/ modifications. [pppig236]
- Add drivers/input/touchscreen/ modifications. [pppig236]
- Driver/base: add fw update driver for the built-in oplus fw update.
  [pppig236]
- Arm64/configs/vendor/oplus: add waipio gki fragment. [pppig236]
- ARM64: dts: vendor: Add symlink to sm8450-devicetrees. [Bruno Martins]
- Scripts: Allow QCOM devicetree overlays to be properly combined.
  [Bruno Martins]

  Apply the same logic that Qualcomm uses on their 5.15 kernel_platform
  build scripts, as seen in commit e10f5dc.

  As a sidenote, passing DTC_FLAGS externally is not an option since it
  overrides any other flags set by the kernel makefile.
- Dtc: Silence warnings by default. [Danny Lin]
- Arch: arm64: dts: Exclude standard dts if vendor dts exists. [Cosmin
  Tanislav]
- Makefile: export headers from certain external modules. [SGCMarkus]

  * audio-kernel
  * display-drivers
  * video-kernel
  * nxp driver
- HACK: Skip removal of kernel headers. [Bruno Martins]
- Revert "techpack: add tech package support" [pppig236]

  This reverts commit 50327f3450f1a032950135288d4f691bd6ddd02d.
- Android: Add empty Android.mk file. [LuK1337]

  * This prevents inclusion of drivers/staging/greybus/tools/Android.mk
    which will conflict in case we have more than 1 kernel tree in AOSP
    source dir.
- Android.bp: add soong namespace. [SGCMarkus]
- BACKPORT: UPSTREAM: kbuild: rename
  cmd_{bzip2,lzma,lzo,lz4,xzkern,zstd22} [Masahiro Yamada]

  GZIP-compressed files end with 4 byte data that represents the size
  of the original input. The decompressors (the self-extracting kernel)
  exploit it to know the vmlinux size beforehand. To mimic the GZIP's
  trailer, Kbuild provides cmd_{bzip2,lzma,lzo,lz4,xzkern,zstd22}.
  Unfortunately these macros are used everywhere despite the appended
  size data is only useful for the decompressors.

  There is no guarantee that such hand-crafted trailers are safely ignored.
  In fact, the kernel refuses compressed initramdfs with the garbage data.
  That is why usr/Makefile overrides size_append to make it no-op.

  To limit the use of such broken compressed files, this commit renames
  the existing macros as follows:

    cmd_bzip2   --> cmd_bzip2_with_size
    cmd_lzma    --> cmd_lzma_with_size
    cmd_lzo     --> cmd_lzo_with_size
    cmd_lz4     --> cmd_lz4_with_size
    cmd_xzkern  --> cmd_xzkern_with_size
    cmd_zstd22  --> cmd_zstd22_with_size

  To keep the decompressors working, I updated the following Makefiles
  accordingly:

    arch/arm/boot/compressed/Makefile
    arch/h8300/boot/compressed/Makefile
    arch/mips/boot/compressed/Makefile
    arch/parisc/boot/compressed/Makefile
    arch/s390/boot/compressed/Makefile
    arch/sh/boot/compressed/Makefile
    arch/x86/boot/compressed/Makefile

  I reused the current macro names for the normal usecases; they produce
  the compressed data in the proper format.

  I did not touch the following:

    arch/arc/boot/Makefile
    arch/arm64/boot/Makefile
    arch/csky/boot/Makefile
    arch/mips/boot/Makefile
    arch/riscv/boot/Makefile
    arch/sh/boot/Makefile
    kernel/Makefile

  This means those Makefiles will stop appending the size data.

  I dropped the 'override size_append' hack from usr/Makefile.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Reviewed-by: Nicolas Schier <n.schier@avm.de>

  Bug: 135791357
  (cherry picked from commit 7ce7e984ab2b218d6e92d5165629022fe2daf9ee
   https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git master)
  Change-Id: I3524909ef3daab85f7d22afdebc2e5bbfd5e5cf3
  [szuweilin: Resolved the conflict about non-existing zstd22 in arch/s390/boot/compressed/Makefile]
  Signed-off-by: SzuWei Lin <szuweilin@google.com>
  (cherry picked from commit dd18c291f9a958a1e285ce0e84ec6b5879fe10ab)
- BACKPORT: scripts/Makefile.clang: default to LLVM_IAS=1. [Nick
  Desaulniers]

  LLVM_IAS=1 controls enabling clang's integrated assembler via
  -integrated-as. This was an explicit opt in until we could enable
  assembler support in Clang for more architecures. Now we have support
  and CI coverage of LLVM_IAS=1 for all architecures except a few more
  bugs affecting s390 and powerpc.

  This commit flips the default from opt in via LLVM_IAS=1 to opt out via
  LLVM_IAS=0.  CI systems or developers that were previously doing builds
  with CC=clang or LLVM=1 without explicitly setting LLVM_IAS must now
  explicitly opt out via LLVM_IAS=0, otherwise they will be implicitly
  opted-in.

  This finally shortens the command line invocation when cross compiling
  with LLVM to simply:

  $ make ARCH=arm64 LLVM=1

  Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Bug: 209655537
  [nd: conflict in Documentation/kbuild/llvm.rst]
  (cherry picked from commit f12b034afeb3a977bbb1c6584dedc0f3dc666f14)
- UPSTREAM: Makefile: infer --target from ARCH for CC=clang. [Nick
  Desaulniers]

  We get constant feedback that the command line invocation of make is too
  long when compiling with LLVM. CROSS_COMPILE is helpful when a toolchain
  has a prefix of the target triple, or is an absolute path outside of
  $PATH.

  Since a Clang binary is generally multi-targeted, we can infer a given
  target from SRCARCH/ARCH.  If CROSS_COMPILE is not set, simply set
  --target= for CLANG_FLAGS, KBUILD_CFLAGS, and KBUILD_AFLAGS based on
  $SRCARCH.

  Previously, we'd cross compile via:
  $ ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- make LLVM=1 LLVM_IAS=1
  Now:
  $ ARCH=arm64 make LLVM=1 LLVM_IAS=1

  For native builds (not involving cross compilation) we now explicitly
  specify a target triple rather than rely on the implicit host triple.

  Link: https://github.com/ClangBuiltLinux/linux/issues/1399
  Suggested-by: Arnd Bergmann <arnd@kernel.org>
  Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
  Suggested-by: Masahiro Yamada <masahiroy@kernel.org>
  Suggested-by: Nathan Chancellor <nathan@kernel.org>
  Acked-by: Arnd Bergmann <arnd@kernel.org>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
  Acked-by: Miguel Ojeda <ojeda@kernel.org>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Bug: 209655537
  (cherry picked from commit 231ad7f409f16b9f9505f69e058dff488a7e6bde)
- BACKPORT: Makefile: move initial clang flag handling into
  scripts/Makefile.clang. [Nick Desaulniers]

  With some of the changes we'd like to make to CROSS_COMPILE, the initial
  block of clang flag handling which controls things like the target triple,
  whether or not to use the integrated assembler and how to find GAS,
  and erroring on unknown warnings is becoming unwieldy. Move it into its
  own file under scripts/.

  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Bug: 209655537
  [nd: conflict in MAINTAINERS]
  (cherry picked from commit 6f5b41a2f5a6314614e286274eb8e985248aac60)
- UPSTREAM: kbuild: warn if a different compiler is used for external
  module builds. [Masahiro Yamada]

  It is always safe to use the same compiler for the kernel and external
  modules, but in reality, some distributions such as Fedora release a
  different version of GCC from the one used for building the kernel.

  There was a long discussion about mixing different compilers [1].

  I do not repeat it here, but at least, showing a heads up in that
  case is better than nothing.

  Linus suggested [2]:
    And a warning might be more palatable even if different compiler
    version work fine together. Just a heads up on "it looks like you
    might be mixing compiler versions" is a valid note, and isn't
    necessarily wrong. Even when they work well together, maybe you want
    to have people at least _aware_ of it.

  This commit shows a warning unless the compiler is exactly the same.

    warning: the compiler differs from the one used to build the kernel
      The kernel was built by: gcc (GCC) 11.1.1 20210531 (Red Hat 11.1.1-3)
      You are using:           gcc (GCC) 11.2.1 20210728 (Red Hat 11.2.1-1)

  Check the difference, and if it is OK with you, please proceed at your
  risk.

  To avoid the locale issue as in commit bcbcf50f5218 ("kbuild: fix
  ld-version.sh to not be affected by locale"), pass LC_ALL=C to
  "$(CC) --version".

  [1] https://lore.kernel.org/linux-hardening/efe6b039a544da8215d5e54aa7c4b6d1986fc2b0.1611607264.git.jpoimboe@redhat.com/
  [2] https://lore.kernel.org/lkml/CAHk-=wgjwhDy-y4mQh34L+2aF=n6BjzHdqAW2=8wri5x7O04pA@mail.gmail.com/

  Acked-by: Josh Poimboeuf <jpoimboe@redhat.com>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit 6072b2c49d23eb69b6dca06ad095d3a9633b2b80)
- UPSTREAM: kbuild: split cc-option and friends to
  scripts/Makefile.compiler. [Masahiro Yamada]

  scripts/Kbuild.include is included everywhere, but macros such as
  cc-option are needed by build targets only.

  For example, when 'make clean' traverses the tree, it does not need
  to evaluate $(call cc-option,).

  Split cc-option, ld-option, etc. to scripts/Makefile.compiler, which
  is only included from the top Makefile and scripts/Makefile.build.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Bug: 209655537
  (cherry picked from commit 57fd251c789647552d32d2fc51bedd4f90d70f9f)
- UPSTREAM: kbuild: replace sed with $(subst ) or $(patsubst ) [Masahiro
  Yamada]

  For simple text replacement, it is better to use a built-in function
  instead of sed if possible. You can save one process forking.

  I do not mean to replace all sed invocations because GNU Make itself
  does not support regular expression (unless you use guile).

  I just replaced simple ones.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit 6e0839fda3f8598b164a7f23f3eec039e2db5fbc)
- UPSTREAM: Makefile: Only specify '--prefix=' when building with clang
  + GNU as. [Nathan Chancellor]

  When building with LLVM_IAS=1, there is no point to specifying
  '--prefix=' because that flag is only used to find GNU cross tools,
  which will not be used indirectly when using the integrated assembler.
  All of the tools are invoked directly from PATH or a full path specified
  via the command line, which does not depend on the value of '--prefix='.

  Sharing commands to reproduce issues becomes a little bit easier without
  a '--prefix=' value because that '--prefix=' value is specific to a
  user's machine due to it being an absolute path.

  Some further notes from Fangrui Song:

    clang can spawn GNU as (if -f?no-integrated-as is specified) and GNU
    objcopy (-f?no-integrated-as and -gsplit-dwarf and -g[123]).
    objcopy is only used for GNU as assembled object files.
    With integrated assembler, the object file streamer creates .o and
    .dwo simultaneously.
    With GNU as, two objcopy commands are needed to extract .debug*.dwo to
    .dwo files && another command to remove .debug*.dwo sections.

  A small consequence of this change (to keep things simple) is that
  '--prefix=' will always be specified now, even with a native build, when
  it was not before. This should not be an issue due to the way that the
  Makefile searches for the prefix (based on elfedit's location). This
  ends up improving the experience for host builds because PATH is better
  respected and matches GCC's behavior more closely. See the below thread
  for more details:

  https://lore.kernel.org/r/20210205213651.GA16907@Ryzen-5-4500U.localdomain/

  Signed-off-by: Nathan Chancellor <nathan@kernel.org>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit eec08090bcc113643522d4272dc0b945045aba74)
- UPSTREAM: Makefile: Remove '--gcc-toolchain' flag. [Nathan Chancellor]

  This flag was originally added to allow clang to find the GNU cross
  tools in commit 785f11aa595b ("kbuild: Add better clang cross build
  support"). This flag was not enough to find the tools at times so
  '--prefix' was added to the list in commit ef8c4ed9db80 ("kbuild: allow
  to use GCC toolchain not in Clang search path") and improved upon in
  commit ca9b31f6bb9c ("Makefile: Fix GCC_TOOLCHAIN_DIR prefix for Clang
  cross compilation"). Now that '--prefix' specifies a full path and
  prefix, '--gcc-toolchain' serves no purpose because the kernel builds
  with '-nostdinc' and '-nostdlib'.

  This has been verified with self compiled LLVM 10.0.1 and LLVM 13.0.0 as
  well as a distribution version of LLVM 11.1.0 without binutils in the
  LLVM toolchain locations.

  Link: https://reviews.llvm.org/D97902
  Signed-off-by: Nathan Chancellor <nathan@kernel.org>
  Reviewed-by: Fangrui Song <maskray@google.com>
  Reviewed-by: Nick Desaulniers <ndesaulniers@google.com>
  Tested-by: Nick Desaulniers <ndesaulniers@google.com>
  Tested-by: Sedat Dilek <sedat.dilek@gmail.com>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit c91d4e47e10ee4d3163838b1b727fe1d0664115b)
- UPSTREAM: Makefile: Remove # characters from compiler string. [Nathan
  Chancellor]

  When using AMD's Optimizing C/C++ Compiler (AOCC), the build fails due
  to a # character in the version string, which is interpreted as a
  comment:

  $ make CC=clang defconfig init/main.o
  include/config/auto.conf.cmd:1374: *** invalid syntax in conditional. Stop.

  $ sed -n 1374p include/config/auto.conf.cmd
  ifneq "$(CC_VERSION_TEXT)" "AMD clang version 11.0.0 (CLANG: AOCC_2.3.0-Build#85 2020_11_10) (based on LLVM Mirror.Version.11.0.0)"

  Remove all # characters in the version string so that the build does not
  fail unexpectedly.

  Link: https://github.com/ClangBuiltLinux/linux/issues/1298
  Reported-by: Michael Fuckner <michael@fuckner.net>
  Signed-off-by: Nathan Chancellor <nathan@kernel.org>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit c75173a26948363bdd11a0d5b90bd012ce4cc2e7)
- UPSTREAM: Makefile: reuse CC_VERSION_TEXT. [Nick Desaulniers]

  I noticed we're invoking $(CC) via $(shell) more than once to check the
  version.  Let's reuse the first string captured in $CC_VERSION_TEXT.

  Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
  [masahiro.yamada:
  CC_VERSION_TEXT is assigned by = instead of :=, so this $(shell ) is
  evaluated multiple times anyway. The number of $(CC) invocations will
  be still the same. Replacing 'grep' with the built-in $(findstring )
  will give real performance benefit.]
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit db07562aeac77923370bff4733d8b0e09cbc93c4)
- BACKPORT: kbuild: prefix $(srctree)/ to some included Makefiles.
  [Masahiro Yamada]

  VPATH is used in Kbuild to make pattern rules search for prerequisites
  in both $(objtree) and $(srctree). Some of *.c, *.S files are not real
  sources, but generated by tools such as flex, bison, perl.

  In contrast, I doubt the benefit of --include-dir=$(abs_srctree) because
  it is always clear which Makefiles are real sources, and which are not.

  So, my hope is to add $(srctree)/ prefix to all check-in Makefiles,
  then remove --include-dir=$(abs_srctree) flag in the future.

  I am touching only some Kbuild core parts for now. Treewide fixes will
  be needed to achieve this goal.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  (cherry picked from commit 3204a7fb98a3bccd0004ea0f2769fbeadc2c2dba)
  [nd: conflict in scripts/Makefile.modpost due to d7a956441fef, which is
  itself a backport of 850ded46c642]
- UPSTREAM: kbuild: remove ld-version macro. [Masahiro Yamada]

  There is no direct user of ld-version; you can use CONFIG_LD_VERSION
  if needed.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Bug: 209655537
  (cherry picked from commit 05f6bbf2d714309607d5533f0265a95d037610b4)
- UPSTREAM: kbuild: collect minimum tool versions into scripts/min-tool-
  version.sh. [Masahiro Yamada]

  The kernel build uses various tools, many of which are provided by the
  same software suite, for example, LLVM and Binutils.

  When you raise the minimum version of Clang/LLVM, you need to update
  clang_min_version in scripts/cc-version.sh and also lld_min_version in
  scripts/ld-version.sh.

  Kbuild can handle CC=clang and LD=ld.lld independently, but it does not
  make much sense to maintain their versions separately.

  Let's create a central place of minimum tool versions so you do not need
  to touch multiple files. scripts/min-tool-version.sh prints the minimum
  version of the given tool.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Acked-by: Miguel Ojeda <ojeda@kernel.org>
  Tested-by: Sedat Dilek <sedat.dilek@gmail.com>
  (cherry picked from commit e24b3ffcf4216d819b52618b6f17ba7410d1d845)
- UPSTREAM: kbuild: fix ld-version.sh to not be affected by locale.
  [Masahiro Yamada]

  ld-version.sh checks the output from $(LD) --version, but it has a
  problem on some locales.

  For example, in Italian:

    $ LC_MESSAGES=it_IT.UTF-8 ld --version | head -n 1
    ld di GNU (GNU Binutils for Debian) 2.35.2

  This makes ld-version.sh fail because it expects "GNU ld" for the
  BFD linker case.

  Add LC_ALL=C to override the user's locale.

  BTW, setting LC_MESSAGES=C (or LANG=C) is not enough because it is
  ineffective if LC_ALL is set on the user's environment.

  Link: https://bugzilla.kernel.org/show_bug.cgi?id=212105
  Reported-by: Marco Scardovi
  Reported-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Recensito-da: Nick Desaulniers <ndesaulniers@google.com>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  (cherry picked from commit bcbcf50f521843445c9ea320a0569874f88c4b7a)
- UPSTREAM: kbuild: Fix ld-version.sh script if LLD was built with
  LLD_VENDOR. [Bernhard Rosenkränzer]

  If LLD was built with -DLLD_VENDOR="xyz", ld.lld --version output
  will prefix LLD_VENDOR. Since LLD_VENDOR can contain spaces, the
  LLD identifier isn't guaranteed to be $2 either.

  Adjust the version checker to handle such versions of lld.

  Link: https://lore.kernel.org/lkml/20210302221211.1620858-1-bero@lindev.ch/
  Signed-off-by: Bernhard Rosenkränzer <bero@lindev.ch>
  [masahiro yamada: refactor the code]
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Tested-by: Nathan Chancellor <nathan@kernel.org>
  (cherry picked from commit 1f09af062556f0610c08e2f3d680a8b8bc40dd48)
- BACKPORT: kbuild: check the minimum linker version in Kconfig.
  [Masahiro Yamada]

  Unify the two scripts/ld-version.sh and scripts/lld-version.sh, and
  check the minimum linker version like scripts/cc-version.sh did.

  I tested this script for some corner cases reported in the past:

   - GNU ld version 2.25-15.fc23
     as reported by commit 8083013fc320 ("ld-version: Fix it on Fedora")

   - GNU ld (GNU Binutils) 2.20.1.20100303
     as reported by commit 0d61ed17dd30 ("ld-version: Drop the 4th and
     5th version components")

  This script show an error message if the linker is too old:

    $ make LD=ld.lld-9
      SYNC    include/config/auto.conf
    ***
    *** Linker is too old.
    ***   Your LLD version:    9.0.1
    ***   Minimum LLD version: 10.0.1
    ***
    scripts/Kconfig.include:50: Sorry, this linker is not supported.
    make[2]: *** [scripts/kconfig/Makefile:71: syncconfig] Error 1
    make[1]: *** [Makefile:600: syncconfig] Error 2
    make: *** [Makefile:708: include/config/auto.conf] Error 2

  I also moved the check for gold to this script, so gold is still rejected:

    $ make LD=gold
      SYNC    include/config/auto.conf
    gold linker is not supported as it is not capable of linking the kernel proper.
    scripts/Kconfig.include:50: Sorry, this linker is not supported.
    make[2]: *** [scripts/kconfig/Makefile:71: syncconfig] Error 1
    make[1]: *** [Makefile:600: syncconfig] Error 2
    make: *** [Makefile:708: include/config/auto.conf] Error 2

  Thanks to David Laight for suggesting shell script improvements.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Acked-by: Nick Desaulniers <ndesaulniers@google.com>
  Reviewed-by: Nathan Chancellor <nathan@kernel.org>
  Tested-by: Nathan Chancellor <nathan@kernel.org>
  [nd: conflict in scripts/lld-version.sh due to df58fb431aa3
    ("scripts/lld-version.sh: Rewrite based on upstream ld-version.sh")
    being 5.10 only]
  Bug: 210043760
  (cherry picked from commit 02aff85922043cf175ebbe5fc3430acfeaeb8393)
- UPSTREAM: kbuild: check the minimum compiler version in Kconfig.
  [Masahiro Yamada]

  Paul Gortmaker reported a regression in the GCC version check. [1]
  If you use GCC 4.8, the build breaks before showing the error message
  "error Sorry, your version of GCC is too old - please use 4.9 or newer."

  I do not want to apply his fix-up since it implies we would not be able
  to remove any cc-option test. Anyway, I admit checking the GCC version
  in <linux/compiler-gcc.h> is too late.

  Almost at the same time, Linus also suggested to move the compiler
  version error to Kconfig time. [2]

  I unified the two similar scripts, gcc-version.sh and clang-version.sh
  into cc-version.sh. The old scripts invoked the compiler multiple times
  (3 times for gcc-version.sh, 4 times for clang-version.sh). I refactored
  the code so the new one invokes the compiler just once, and also tried
  my best to use shell-builtin commands where possible.

  The new script runs faster.

    $ time ./scripts/clang-version.sh clang
    120000

    real    0m0.029s
    user    0m0.012s
    sys     0m0.021s

    $ time ./scripts/cc-version.sh clang
    Clang 120000

    real    0m0.009s
    user    0m0.006s
    sys     0m0.004s

  cc-version.sh also shows an error message if the compiler is too old:

    $ make defconfig CC=clang-9
    *** Default configuration is based on 'x86_64_defconfig'
    ***
    *** Compiler is too old.
    ***   Your Clang version:    9.0.1
    ***   Minimum Clang version: 10.0.1
    ***
    scripts/Kconfig.include:46: Sorry, this compiler is not supported.
    make[1]: *** [scripts/kconfig/Makefile:81: defconfig] Error 1
    make: *** [Makefile:602: defconfig] Error 2

  The new script takes care of ICC because we have <linux/compiler-intel.h>
  although I am not sure if building the kernel with ICC is well-supported.

  [1]: https://lore.kernel.org/r/20210110190807.134996-1-paul.gortmaker@windriver.com
  [2]: https://lore.kernel.org/r/CAHk-=wh-+TMHPTFo1qs-MYyK7tZh-OQovA=pP3=e06aCVp6_kA@mail.gmail.com

  Fixes: 87de84c9140e ("kbuild: remove cc-option test of -Werror=date-time")
  Reported-by: Paul Gortmaker <paul.gortmaker@windriver.com>
  Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
  Reviewed-by: Nick Desaulniers <ndesaulniers@google.com>
  Tested-by: Nick Desaulniers <ndesaulniers@google.com>
  Reviewed-by: Nathan Chancellor <natechancellor@gmail.com>
  Tested-by: Nathan Chancellor <natechancellor@gmail.com>
  Reviewed-by: Miguel Ojeda <ojeda@kernel.org>
  Tested-by: Miguel Ojeda <ojeda@kernel.org>
  Tested-by: Sedat Dilek <sedat.dilek@gmail.com>
  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Bug: 210043760
  (cherry picked from commit aec6c60a01d3a3170242d6a99372a388e1136dc6)
- UPSTREAM: kbuild: LD_VERSION redenomination. [Masahiro Yamada]

  Commit ccbef1674a15 ("Kbuild, lto: add ld-version and ld-ifversion
  macros") introduced scripts/ld-version.sh for GCC LTO.

  At that time, this script handled 5 version fields because GCC LTO
  needed the downstream binutils. (https://lkml.org/lkml/2014/4/8/272)

  The code snippet from the submitted patch was as follows:

      # We need HJ Lu's Linux binutils because mainline binutils does not
      # support mixing assembler and LTO code in the same ld -r object.
      # XXX check if the gcc plugin ld is the expected one too
      # XXX some Fedora binutils should also support it. How to check for that?
      ifeq ($(call ld-ifversion,-ge,22710001,y),y)
          ...

  However, GCC LTO was not merged into the mainline after all.
  (https://lkml.org/lkml/2014/4/8/272)

  So, the 4th and 5th fields were never used, and finally removed by
  commit 0d61ed17dd30 ("ld-version: Drop the 4th and 5th version
  components").

  Since then, the last 4-digits returned by this script is always zeros.

  Remove the meaningless last 4-digits. This makes the version format
  consistent with GCC_VERSION, CLANG_VERSION, LLD_VERSION.

  Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
  Acked-by: Will Deacon <will@kernel.org>
  Acked-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
  Bug: 210043760
  (cherry picked from commit 052c805a1851a4415f9e2adfa9654a0b793e0c45)
- Revert "msm: ADSPRPC: Check PD status before attach request" [Juhyung
  Park]

  This reverts commit 9ba101225e98df63d4234e576576edce70d65973.

  Incompatible with our userspace setup.
- Revert "kasan: print the original fault addr when access invalid
  shadow" [pppig236]

  This reverts commit 632c2199e52d0e957dd47d4c931d60b82cd5ff29.
- Net: add DEV_STATS_READ() helper. [Eric Dumazet]

  [ Upstream commit 0b068c714ca9479d2783cc333fff5bc2d4a6d45c ]

  Companion of DEV_STATS_INC() & DEV_STATS_ADD().

  This is going to be used in the series.

  Use it in macsec_get_stats64().
- Net: add atomic_long_t to net_device_stats fields. [Eric Dumazet]

  [ Upstream commit 6c1c5097781f563b70a81683ea6fdac21637573b ]

  Long standing KCSAN issues are caused by data-race around
  some dev->stats changes.

  Most performance critical paths already use per-cpu
  variables, or per-queue ones.

  It is reasonable (and more correct) to use atomic operations
  for the slow paths.

  This patch adds an union for each field of net_device_stats,
  so that we can convert paths that are not yet protected
  by a spinlock or a mutex.

  netdev_stats_to_stats64() no longer has an #if BITS_PER_LONG==64

  Note that the memcpy() we were using on 64bit arches
  had no provision to avoid load-tearing,
  while atomic_long_read() is providing the needed protection
  at no cost.
- Merge tag 'v5.10.208' of
  https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux into
  HEAD. [pppig236]

  This is the 5.10.208 stable release

  * tag 'v5.10.208' of https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux:
    Linux 5.10.208
    Revert "nvme: use command_id instead of req->tag in trace_nvme_complete_rq()"
    PCI: Disable ATS for specific Intel IPU E2000 devices
    PCI: Extract ATS disabling to a helper function
    netfilter: nf_tables: Reject tables of unsupported family
    drm/qxl: fix UAF on handle creation
    ipv6: remove max_size check inline with ipv4
    net: tls, update curr on splice as well
    powerpc: update ppc_save_regs to save current r1 in pt_regs
    mmc: sdhci-sprd: Fix eMMC init failure after hw reset
    mmc: core: Cancel delayed work before releasing host
    mmc: rpmb: fixes pause retune on all RPMB partitions.
    mmc: meson-mx-sdhc: Fix initialization frozen issue
    mm: fix unmap_mapping_range high bits shift bug
    i2c: core: Fix atomic xfer check for non-preempt config
    x86/kprobes: fix incorrect return address calculation in kprobe_emulate_call_indirect
    firewire: ohci: suppress unexpected system reboot in AMD Ryzen machines and ASM108x/VT630x PCIe cards
    mm/memory-failure: check the mapcount of the precise page
    net: Implement missing SO_TIMESTAMPING_NEW cmsg support
    bnxt_en: Remove mis-applied code from bnxt_cfg_ntp_filters()
    asix: Add check for usbnet_get_endpoints
    net/qla3xxx: fix potential memleak in ql_alloc_buffer_queues
    net/qla3xxx: switch from 'pci_' to 'dma_' API
    i40e: Restore VF MSI-X state during PCI reset
    ASoC: meson: g12a-tohdmitx: Fix event generation for S/PDIF mux
    ASoC: meson: g12a-toacodec: Fix event generation
    ASoC: meson: g12a-tohdmitx: Validate written enum values
    ASoC: meson: g12a-toacodec: Validate written enum values
    i40e: fix use-after-free in i40e_aqc_add_filters()
    net: Save and restore msg_namelen in sock_sendmsg
    netfilter: nft_immediate: drop chain reference counter on error
    netfilter: nftables: add loop check helper function
    net: bcmgenet: Fix FCS generation for fragmented skbuffs
    sfc: fix a double-free bug in efx_probe_filters
    ARM: sun9i: smp: Fix array-index-out-of-bounds read in sunxi_mc_smp_init
    net: sched: em_text: fix possible memory leak in em_text_destroy()
    i40e: Fix filter input checks to prevent config with invalid values
    drm/i915/dp: Fix passing the correct DPCD_REV for drm_dp_set_phy_test_pattern
    octeontx2-af: Fix marking couple of structure as __packed
    nfc: llcp_core: Hold a ref to llcp_local->dev when holding a ref to llcp_local
    ALSA: hda/realtek: Fix mute and mic-mute LEDs for HP ProBook 440 G6
    block: Don't invalidate pagecache for invalid falloc modes
    keys, dns: Fix missing size check of V1 server-list header
    Linux 5.10.207
    scsi: core: Always send batch on reset or error handling command
    Revert "scsi: core: Add scsi_prot_ref_tag() helper"
    Revert "scsi: core: Introduce scsi_get_sector()"
    Revert "scsi: core: Make scsi_get_lba() return the LBA"
    Revert "scsi: core: Use scsi_cmd_to_rq() instead of scsi_cmnd.request"
    Revert "scsi: core: Use a structure member to track the SCSI command submitter"
    Revert "scsi: core: Always send batch on reset or error handling command"
    Linux 5.10.206
    spi: atmel: Fix PDC transfer setup bug
    Bluetooth: SMP: Fix crash when receiving new connection when debug is enabled
    Revert "MIPS: Loongson64: Enable DMA noncoherent support"
    dm-integrity: don't modify bio's immutable bio_vec in integrity_metadata()
    netfilter: nf_tables: skip set commit for deleted/destroyed sets
    tracing: Fix blocked reader of snapshot buffer
    ring-buffer: Fix wake ups when buffer_percent is set to 100
    scsi: core: Always send batch on reset or error handling command
    scsi: core: Use a structure member to track the SCSI command submitter
    scsi: core: Use scsi_cmd_to_rq() instead of scsi_cmnd.request
    scsi: core: Make scsi_get_lba() return the LBA
    scsi: core: Introduce scsi_get_sector()
    scsi: core: Add scsi_prot_ref_tag() helper
    spi: atmel: Fix CS and initialization bug
    spi: atmel: Switch to transfer_one transfer method
    Bluetooth: af_bluetooth: Fix Use-After-Free in bt_sock_recvmsg
    smb: client: fix OOB in smbCalcSize()
    smb: client: fix OOB in SMB2_query_info_init()
    usb: fotg210-hcd: delete an incorrect bounds test
    Bluetooth: MGMT/SMP: Fix address type when using SMP over BREDR/LE
    Bluetooth: use inclusive language in SMP
    Bluetooth: SMP: Convert BT_ERR/BT_DBG to bt_dev_err/bt_dev_dbg
    ARM: dts: Fix occasional boot hang for am3 usb
    9p/net: fix possible memory leak in p9_check_errors()
    x86/alternatives: Sync core before enabling interrupts
    lib/vsprintf: Fix %pfwf when current node refcount == 0
    bus: ti-sysc: Flush posted write only after srst_udelay
    tracing / synthetic: Disable events after testing in synth_event_gen_test_init()
    dt-bindings: nvmem: mxs-ocotp: Document fsl,ocotp
    net: ks8851: Fix TX stall caused by TX buffer overrun
    net: rfkill: gpio: set GPIO direction
    net: 9p: avoid freeing uninit memory in p9pdu_vreadf
    Input: soc_button_array - add mapping for airplane mode button
    Bluetooth: L2CAP: Send reject on command corrupted request
    Bluetooth: hci_event: Fix not checking if HCI_OP_INQUIRY has been sent
    USB: serial: option: add Quectel RM500Q R13 firmware support
    USB: serial: option: add Foxconn T99W265 with new baseline
    USB: serial: option: add Quectel EG912Y module support
    USB: serial: ftdi_sio: update Actisense PIDs constant names
    wifi: cfg80211: fix certs build to not depend on file order
    wifi: cfg80211: Add my certificate
    iio: adc: ti_am335x_adc: Fix return value check of tiadc_request_dma()
    iio: common: ms_sensors: ms_sensors_i2c: fix humidity conversion time table
    scsi: bnx2fc: Fix skb double free in bnx2fc_rcv()
    Input: ipaq-micro-keys - add error handling for devm_kmemdup
    iio: imu: inv_mpu6050: fix an error code problem in inv_mpu6050_read_raw
    interconnect: Treat xlate() returning NULL node as an error
    btrfs: do not allow non subvolume root targets for snapshot
    smb: client: fix NULL deref in asn1_ber_decoder()
    ALSA: hda/hdmi: add force-connect quirk for NUC5CPYB
    ALSA: hda/hdmi: Add quirk to force pin connectivity on NUC10
    pinctrl: at91-pio4: use dedicated lock class for IRQ
    i2c: aspeed: Handle the coalesced stop conditions with the start conditions.
    afs: Fix overwriting of result of DNS query
    keys, dns: Allow key types (eg. DNS) to be reclaimed immediately on expiry
    net: check dev->gso_max_size in gso_features_check()
    net: warn if gso_type isn't set for a GSO SKB
    afs: Fix dynamic root lookup DNS check
    afs: Fix the dynamic root's d_delete to always delete unused dentries
    net: check vlan filter feature in vlan_vids_add_by_dev() and vlan_vids_del_by_dev()
    net/rose: fix races in rose_kill_by_device()
    ethernet: atheros: fix a memleak in atl1e_setup_ring_resources
    net: sched: ife: fix potential use-after-free
    net/mlx5e: Correct snprintf truncation handling for fw_version buffer used by representors
    net/mlx5: Fix fw tracer first block check
    net/mlx5e: Fix slab-out-of-bounds in mlx5_query_nic_vport_mac_list()
    Revert "net/mlx5e: fix double free of encap_header"
    wifi: mac80211: mesh_plink: fix matches_local logic
    s390/vx: fix save/restore of fpu kernel context
    reset: Fix crash when freeing non-existent optional resets
    ARM: OMAP2+: Fix null pointer dereference and memory leak in omap_soc_device_init
    smb: client: fix OOB in smb2_query_reparse_point()
    ksmbd: fix wrong name of SMB2_CREATE_ALLOCATION_SIZE
    Linux 5.10.205
    powerpc/ftrace: Fix stack teardown in ftrace_no_trace
    powerpc/ftrace: Create a dummy stackframe to fix stack unwind
    tty: n_gsm: add sanity check for gsm->receive in gsm_receive_buf()
    tty: n_gsm, remove duplicates of parameters
    tty: n_gsm: fix tty registration before control channel open
    USB: gadget: core: adjust uevent timing on gadget unbind
    ring-buffer: Fix a race in rb_time_cmpxchg() for 32 bit archs
    ring-buffer: Fix writing to the buffer with max_data_size
    ring-buffer: Have saved event hold the entire event
    tracing: Update snapshot buffer on resize if it is allocated
    ring-buffer: Fix memory leak of free page
    team: Fix use-after-free when an option instance allocation fails
    arm64: mm: Always make sw-dirty PTEs hw-dirty in pte_modify
    ext4: prevent the normalized size from exceeding EXT_MAX_BLOCKS
    soundwire: stream: fix NULL pointer dereference for multi_link
    perf: Fix perf_event_validate_size() lockdep splat
    HID: hid-asus: add const to read-only outgoing usb buffer
    net: usb: qmi_wwan: claim interface 4 for ZTE MF290
    asm-generic: qspinlock: fix queued_spin_value_unlocked() implementation
    HID: multitouch: Add quirk for HONOR GLO-GXXX touchpad
    HID: hid-asus: reset the backlight brightness level on resume
    HID: add ALWAYS_POLL quirk for Apple kb
    HID: glorious: fix Glorious Model I HID report
    platform/x86: intel_telemetry: Fix kernel doc descriptions
    bcache: avoid NULL checking to c->root in run_cache_set()
    bcache: add code comments for bch_btree_node_get() and __bch_btree_node_alloc()
    bcache: remove redundant assignment to variable cur_idx
    bcache: avoid oversize memory allocation by small stripe_size
    blk-throttle: fix lockdep warning of "cgroup_mutex or RCU read lock required!"
    usb: aqc111: check packet for fixup for true limit
    drm/mediatek: Add spinlock for setting vblank event in atomic_begin
    PCI: loongson: Limit MRRS to 256
    Revert "PCI: acpiphp: Reassign resources on bridge if necessary"
    ALSA: hda/realtek: Apply mute LED quirk for HP15-db
    ALSA: hda/hdmi: add force-connect quirks for ASUSTeK Z170 variants
    fuse: dax: set fc->dax to NULL in fuse_dax_conn_free()
    cred: switch to using atomic_long_t
    net: atlantic: fix double free in ring reinit logic
    appletalk: Fix Use-After-Free in atalk_ioctl
    net: stmmac: Handle disabled MDIO busses from devicetree
    net: stmmac: use dev_err_probe() for reporting mdio bus registration failure
    vsock/virtio: Fix unsigned integer wrap around in virtio_transport_has_space()
    sign-file: Fix incorrect return values check
    net: ena: Fix XDP redirection error
    net: ena: Destroy correct number of xdp queues upon failure
    net: Remove acked SYN flag from packet in the transmit queue correctly
    qed: Fix a potential use-after-free in qed_cxt_tables_alloc
    net/rose: Fix Use-After-Free in rose_ioctl
    atm: Fix Use-After-Free in do_vcc_ioctl
    net: fec: correct queue selection
    net: vlan: introduce skb_vlan_eth_hdr()
    atm: solos-pci: Fix potential deadlock on &tx_queue_lock
    atm: solos-pci: Fix potential deadlock on &cli_queue_lock
    qca_spi: Fix reset behavior
    qca_debug: Fix ethtool -G iface tx behavior
    qca_debug: Prevent crash on TX ring changes
    net: ipv6: support reporting otherwise unknown prefix flags in RTM_NEWPREFIX
    HID: lenovo: Restrict detection of patched firmware only to USB cptkbd
    afs: Fix refcount underflow from error handling race
    netfilter: nf_tables: fix 'exist' matching on bigendian arches
    Linux 5.10.204
    r8169: fix rtl8125b PAUSE frames blasting when suspended
    devcoredump: Send uevent once devcd is ready
    devcoredump : Serialize devcd_del work
    smb: client: fix potential NULL deref in parse_dfs_referrals()
    cifs: Fix non-availability of dedup breaking generic/304
    Revert "btrfs: add dmesg output for first mount and last unmount of a filesystem"
    mmc: block: Be sure to wait while busy in CQE error recovery
    platform/x86: asus-wmi: Document the dgpu_disable sysfs attribute
    tools headers UAPI: Sync linux/perf_event.h with the kernel sources
    platform/x86: asus-wmi: Fix kbd_dock_devid tablet-switch reporting
    netfilter: nft_set_pipapo: skip inactive elements during set walk
    drop_monitor: Require 'CAP_SYS_ADMIN' when joining "events" group
    psample: Require 'CAP_NET_ADMIN' when joining "packets" group
    genetlink: add CAP_NET_ADMIN test for multicast bind
    netlink: don't call ->netlink_bind with table lock held
    io_uring/af_unix: disable sending io_uring over sockets
    MIPS: Loongson64: Enable DMA noncoherent support
    MIPS: Loongson64: Reserve vgabios memory on boot
    KVM: s390/mm: Properly reset no-dat
    x86/CPU/AMD: Check vendor in the AMD microcode callback
    serial: 8250_omap: Add earlycon support for the AM654 UART controller
    serial: 8250: 8250_omap: Do not start RX DMA on THRI interrupt
    serial: 8250: 8250_omap: Clear UART_HAS_RHR_IT_DIS bit
    serial: sc16is7xx: address RX timeout interrupt errata
    ARM: PL011: Fix DMA support
    usb: typec: class: fix typec_altmode_put_partner to put plugs
    Revert "xhci: Loosen RPM as default policy to cover for AMD xHC 1.1"
    parport: Add support for Brainboxes IX/UC/PX parallel cards
    usb: gadget: f_hid: fix report descriptor allocation
    drm/amdgpu: correct the amdgpu runtime dereference usage count
    gpiolib: sysfs: Fix error handling on failed export
    perf: Fix perf_event_validate_size()
    perf/core: Add a new read format to get a number of lost samples
    tracing: Stop current tracer when resizing buffer
    tracing: Set actual size after ring buffer resize
    ring-buffer: Force absolute timestamp on discard of event
    misc: mei: client.c: fix problem of return '-EOVERFLOW' in mei_cl_write
    misc: mei: client.c: return negative error code in mei_cl_write
    arm64: dts: mediatek: mt8183: Fix unit address for scp reserved memory
    arm64: dts: mediatek: mt8173-evb: Fix regulator-fixed node names
    arm64: dts: mediatek: mt7622: fix memory node warning check
    packet: Move reference count in packet_sock to atomic_long_t
    tracing: Fix a possible race when disabling buffered events
    tracing: Fix incomplete locking when disabling buffered events
    tracing: Disable snapshot buffer when stopping instance tracers
    tracing: Always update snapshot buffer size
    checkstack: fix printed address
    nilfs2: prevent WARNING in nilfs_sufile_set_segment_usage()
    nilfs2: fix missing error check for sb_set_blocksize call
    ALSA: hda/realtek: Enable headset on Lenovo M90 Gen5
    ALSA: pcm: fix out-of-bounds in snd_pcm_state_names
    riscv: fix misaligned access handling of C.SWSP and C.SDSP
    ARM: dts: imx7: Declare timers compatible with fsl,imx6dl-gpt
    ARM: imx: Check return value of devm_kasprintf in imx_mmdc_perf_init
    scsi: be2iscsi: Fix a memleak in beiscsi_init_wrb_handle()
    tracing: Fix a warning when allocating buffered events fails
    ASoC: wm_adsp: fix memleak in wm_adsp_buffer_populate
    hwmon: (acpi_power_meter) Fix 4.29 MW bug
    RDMA/bnxt_re: Correct module description string
    RDMA/rtrs-clt: Remove the warnings for req in_use check
    arm64: dts: rockchip: Expand reg size of vdec node for RK3399
    tee: optee: Fix supplicant based device enumeration
    bpf: sockmap, updating the sg structure should also update curr
    tcp: do not accept ACK of bytes we never sent
    netfilter: xt_owner: Fix for unsafe access of sk->sk_socket
    net: hns: fix fake link up on xge port
    ipv4: ip_gre: Avoid skb_pull() failure in ipgre_xmit()
    ionic: Fix dim work handling in split interrupt mode
    ionic: fix snprintf format length warning
    net: bnxt: fix a potential use-after-free in bnxt_init_tc
    i40e: Fix unexpected MFS warning message
    arcnet: restoring support for multiple Sohard Arcnet cards
    net: arcnet: com20020 fix error handling
    mlxbf-bootctl: correctly identify secure boot with development keys
    hv_netvsc: rndis_filter needs to select NLS
    octeontx2-pf: Add missing mutex lock in otx2_get_pauseparam
    ipv6: fix potential NULL deref in fib6_add()
    of: dynamic: Fix of_reconfig_get_state_change() return value documentation
    of: Add missing 'Return' section in kerneldoc comments
    of: Fix kerneldoc output formatting
    of: base: Fix some formatting issues and provide missing descriptions
    platform/x86: asus-wmi: Move i8042 filter install to shared asus-wmi code
    platform/x86: asus-wmi: Simplify tablet-mode-switch handling
    platform/x86: asus-wmi: Simplify tablet-mode-switch probing
    platform/x86: asus-wmi: Add support for ROG X13 tablet mode
    platform/x86: asus-wmi: Adjust tablet/lidflip handling to use enum
    asus-wmi: Add dgpu disable method
    platform/x86: asus-nb-wmi: Add tablet_mode_sw=lid-flip quirk for the TP200s
    platform/x86: asus-nb-wmi: Allow configuring SW_TABLET_MODE method with a module option
    platform/x86: asus-wmi: Add support for SW_TABLET_MODE on UX360
    drm/amdgpu: correct chunk_ptr to a pointer to chunk.
    kconfig: fix memory leak from range properties
    tg3: Increment tx_dropped in tg3_tso_bug()
    tg3: Move the [rt]x_dropped counters to tg3_napi
    netfilter: ipset: fix race condition between swap/destroy and kernel side add/del/test
    i2c: designware: Fix corrupted memory seen in the ISR
    hrtimers: Push pending hrtimers away from outgoing CPU earlier
    Linux 5.10.203
    driver core: Release all resources during unbind before updating device links
    r8169: fix deadlock on RTL8125 in jumbo mtu mode
    r8169: disable ASPM in case of tx timeout
    mmc: sdhci-sprd: Fix vqmmc not shutting down after the card was pulled
    mmc: core: add helpers mmc_regulator_enable/disable_vqmmc
    mmc: block: Retry commands in CQE error recovery
    mmc: core: convert comma to semicolon
    mmc: cqhci: Fix task clearing in CQE error recovery
    mmc: cqhci: Warn of halt or task clear failure
    mmc: cqhci: Increase recovery halt timeout
    cpufreq: imx6q: Don't disable 792 Mhz OPP unnecessarily
    cpufreq: imx6q: don't warn for disabling a non-existing frequency
    scsi: qla2xxx: Fix system crash due to bad pointer access
    scsi: qla2xxx: Use scsi_cmd_to_rq() instead of scsi_cmnd.request
    scsi: core: Introduce the scsi_cmd_to_rq() function
    smb3: fix caching of ctime on setxattr
    fs: add ctime accessors infrastructure
    drm/amdgpu: don't use ATRM for external devices
    driver core: Move the "removable" attribute from USB to core
    ima: annotate iint mutex to avoid lockdep false positive warnings
    fbdev: stifb: Make the STI next font pointer a 32-bit signed offset
    misc: pci_endpoint_test: Add deviceID for J721S2 PCIe EP device support
    misc: pci_endpoint_test: Add deviceID for AM64 and J7200
    s390/cmma: fix detection of DAT pages
    s390/mm: fix phys vs virt confusion in mark_kernel_pXd() functions family
    ASoC: SOF: sof-pci-dev: Fix community key quirk detection
    ASoC: SOF: sof-pci-dev: don't use the community key on APL Chromebooks
    ASoC: SOF: sof-pci-dev: add parameter to override topology filename
    ASoC: SOF: sof-pci-dev: use community key on all Up boards
    ASoC: Intel: Move soc_intel_is_foo() helpers to a generic header
    smb3: fix touch -h of symlink
    net: ravb: Start TX queues after HW initialization succeeded
    net: ravb: Use pm_runtime_resume_and_get()
    ravb: Fix races between ravb_tx_timeout_work() and net related ops
    r8169: prevent potential deadlock in rtl8169_close
    Revert "workqueue: remove unused cancel_work()"
    octeontx2-pf: Fix adding mbox work queue entry when num_vfs > 64
    net: stmmac: xgmac: Disable FPE MMC interrupts
    selftests/net: mptcp: fix uninitialized variable warnings
    selftests/net: ipsec: fix constant out of range
    dpaa2-eth: increase the needed headroom to account for alignment
    ipv4: igmp: fix refcnt uaf issue when receiving igmp query packet
    usb: config: fix iteration issue in 'usb_get_bos_descriptor()'
    USB: core: Change configuration warnings to notices
    hv_netvsc: fix race of netvsc and VF register_netdevice
    Input: xpad - add HyperX Clutch Gladiate Support
    btrfs: make error messages more clear when getting a chunk map
    btrfs: send: ensure send_fd is writable
    btrfs: fix off-by-one when checking chunk map includes logical address
    btrfs: ref-verify: fix memory leaks in btrfs_ref_tree_mod()
    btrfs: add dmesg output for first mount and last unmount of a filesystem
    parisc: Drop the HP-UX ENOSYM and EREMOTERELEASE error codes
    powerpc: Don't clobber f0/vs0 during fp|altivec register save
    iommu/vt-d: Add MTL to quirk list to skip TE disabling
    bcache: revert replacing IS_ERR_OR_NULL with IS_ERR
    dm verity: don't perform FEC for failed readahead IO
    dm-verity: align struct dm_verity_fec_io properly
    ALSA: hda/realtek: Add supported ALC257 for ChromeOS
    ALSA: hda/realtek: Headset Mic VREF to 100%
    ALSA: hda: Disable power-save on KONTRON SinglePC
    mmc: block: Do not lose cache flush during CQE error recovery
    firewire: core: fix possible memory leak in create_units()
    pinctrl: avoid reload of p state in list iteration
    io_uring: fix off-by one bvec index
    USB: dwc3: qcom: fix wakeup after probe deferral
    usb: dwc3: set the dma max_seg_size
    usb: dwc3: Fix default mode initialization
    USB: dwc2: write HCINT with INTMASK applied
    USB: serial: option: don't claim interface 4 for ZTE MF290
    USB: serial: option: fix FM101R-GL defines
    USB: serial: option: add Fibocom L7xx modules
    bcache: fixup lock c->root error
    bcache: fixup init dirty data errors
    bcache: prevent potential division by zero error
    bcache: check return value from btree_node_alloc_replacement()
    dm-delay: fix a race between delay_presuspend and delay_bio
    hv_netvsc: Mark VF as slave before exposing it to user-mode
    hv_netvsc: Fix race of register_netdevice_notifier and VF register
    USB: serial: option: add Luat Air72*U series products
    s390/dasd: protect device queue against concurrent access
    bcache: fixup multi-threaded bch_sectors_dirty_init() wake-up race
    bcache: replace a mistaken IS_ERR() by IS_ERR_OR_NULL() in btree_gc_coalesce()
    swiotlb-xen: provide the "max_mapping_size" method
    ACPI: resource: Skip IRQ override on ASUS ExpertBook B1402CVA
    ASoC: simple-card: fixup asoc_simple_probe() error handling
    nfsd: lock_rename() needs both directories to live on the same fs
    ext4: make sure allocate pending entry not fail
    ext4: fix slab-use-after-free in ext4_es_insert_extent()
    ext4: using nofail preallocation in ext4_es_insert_extent()
    ext4: using nofail preallocation in ext4_es_insert_delayed_block()
    ext4: using nofail preallocation in ext4_es_remove_extent()
    ext4: use pre-allocated es in __es_remove_extent()
    ext4: use pre-allocated es in __es_insert_extent()
    ext4: factor out __es_alloc_extent() and __es_free_extent()
    ext4: add a new helper to check if es must be kept
    MIPS: KVM: Fix a build warning about variable set but not used
    media: ccs: Correctly initialise try compose rectangle
    lockdep: Fix block chain corruption
    USB: dwc3: qcom: fix ACPI platform device leak
    USB: dwc3: qcom: fix resource leaks on probe deferral
    nvmet: nul-terminate the NQNs passed in the connect command
    nvmet: remove unnecessary ctrl parameter
    afs: Fix file locking on R/O volumes to operate in local mode
    afs: Return ENOENT if no cell DNS record can be found
    net: axienet: Fix check for partial TX checksum
    amd-xgbe: propagate the correct speed and duplex status
    amd-xgbe: handle the corner-case during tx completion
    amd-xgbe: handle corner-case during sfp hotplug
    arm/xen: fix xen_vcpu_info allocation alignment
    net/smc: avoid data corruption caused by decline
    net: usb: ax88179_178a: fix failed operations during ax88179_reset
    ipv4: Correct/silence an endian warning in __ip_do_redirect
    HID: fix HID device resource race between HID core and debugging support
    HID: core: store the unique system identifier in hid_device
    drm/rockchip: vop: Fix color for RGB888/BGR888 format on VOP full
    ata: pata_isapnp: Add missing error check for devm_ioport_map()
    wireguard: use DEV_STATS_INC()
    drm/panel: simple: Fix Innolux G101ICE-L01 timings
    drm/panel: simple: Fix Innolux G101ICE-L01 bus flags
    drm/panel: auo,b101uan08.3: Fine tune the panel power sequence
    drm/panel: boe-tv101wum-nl6: Fine tune the panel power sequence
    afs: Make error on cell lookup failure consistent with OpenAFS
    afs: Fix afs_server_list to be cleaned up with RCU
    PCI: keystone: Drop __init from ks_pcie_add_pcie_{ep,port}()
    RDMA/irdma: Prevent zero-length STAG registration
    Linux 5.10.202
    interconnect: qcom: Add support for mask-based BCMs
    netfilter: nf_tables: disable toggling dormant table state more than once
    netfilter: nf_tables: fix table flag updates
    netfilter: nftables: update table flags from the commit phase
    tracing: Have trace_event_file have ref counters
    io_uring/fdinfo: lock SQ thread while retrieving thread cpu/pid
    drm/amd/display: Change the DMCUB mailbox memory location from FB to inbox
    drm/amdgpu: fix error handling in amdgpu_bo_list_get()
    drm/amd/pm: Handle non-terminated overdrive commands.
    ext4: remove gdb backup copy for meta bg in setup_new_flex_group_blocks
    ext4: correct the start block of counting reserved clusters
    ext4: correct return value of ext4_convert_meta_bg
    ext4: correct offset of gdb backup in non meta_bg group to update_backups
    ext4: apply umask if ACL support is disabled
    Revert "net: r8169: Disable multicast filter for RTL8168H and RTL8107E"
    media: qcom: camss: Fix vfe_get() error jump
    mm: kmem: drop __GFP_NOFAIL when allocating objcg vectors
    nfsd: fix file memleak on client_opens_release
    media: venus: hfi: add checks to handle capabilities from firmware
    media: venus: hfi: fix the check to handle session buffer requirement
    media: venus: hfi_parser: Add check to keep the number of codecs within range
    media: sharp: fix sharp encoding
    media: lirc: drop trailing space from scancode transmit
    f2fs: avoid format-overflow warning
    i2c: i801: fix potential race in i801_block_transaction_byte_by_byte
    net: phylink: initialize carrier state at creation
    net: dsa: lan9303: consequently nested-lock physical MDIO
    i2c: designware: Disable TX_EMPTY irq while waiting for block length byte
    lsm: fix default return value for inode_getsecctx
    lsm: fix default return value for vm_enough_memory
    Revert ncsi: Propagate carrier gain/loss events to the NCSI controller
    arm64: dts: qcom: ipq6018: Fix tcsr_mutex register size
    arm64: dts: qcom: ipq6018: switch TCSR mutex to MMIO
    PCI: exynos: Don't discard .remove() callback
    Bluetooth: btusb: Add 0bda:b85b for Fn-Link RTL8852BE
    Bluetooth: btusb: Add RTW8852BE device 13d3:3570 to device tables
    bluetooth: Add device 13d3:3571 to device tables
    bluetooth: Add device 0bda:887b to device tables
    Bluetooth: btusb: Add Realtek RTL8852BE support ID 0x0cb8:0xc559
    cpufreq: stats: Fix buffer overflow detection in trans_stats()
    tty: serial: meson: fix hard LOCKUP on crtscts mode
    serial: meson: Use platform_get_irq() to get the interrupt
    tty: serial: meson: retrieve port FIFO size from DT
    serial: meson: remove redundant initialization of variable id
    ALSA: hda/realtek - Enable internal speaker of ASUS K6500ZC
    ALSA: hda/realtek - Add Dell ALC295 to pin fall back table
    ALSA: info: Fix potential deadlock at disconnection
    xhci: Enable RPM on controllers that support low-power states
    parisc/pgtable: Do not drop upper 5 address bits of physical address
    parisc: Prevent booting 64-bit kernels on PA1.x machines
    i3c: master: cdns: Fix reading status register
    mtd: cfi_cmdset_0001: Byte swap OTP info
    mm/memory_hotplug: use pfn math in place of direct struct page manipulation
    mm/cma: use nth_page() in place of direct struct page manipulation
    dmaengine: stm32-mdma: correct desc prep when channel running
    mcb: fix error handling for different scenarios when parsing
    i2c: core: Run atomic i2c xfer when !preemptible
    kernel/reboot: emergency_restart: Set correct system_state
    quota: explicitly forbid quota files from being encrypted
    jbd2: fix potential data lost in recovering journal raced with synchronizing fs bdev
    PCI: keystone: Don't discard .probe() callback
    PCI: keystone: Don't discard .remove() callback
    genirq/generic_chip: Make irq_remove_generic_chip() irqdomain aware
    mmc: meson-gx: Remove setting of CMD_CFG_ERROR
    wifi: ath11k: fix htt pktlog locking
    wifi: ath11k: fix dfs radar event locking
    wifi: ath11k: fix temperature event locking
    ima: detect changes to the backing overlay file
    firmware: qcom_scm: use 64-bit calling convention only when client is 64-bit
    btrfs: don't arbitrarily slow down delalloc if we're committing
    rcu: kmemleak: Ignore kmemleak false positives when RCU-freeing objects
    PM: hibernate: Clean up sync_read handling in snapshot_write_next()
    PM: hibernate: Use __get_safe_page() rather than touching the list
    arm64: dts: qcom: ipq6018: Fix hwlock index for SMEM
    PCI/ASPM: Fix L1 substate handling in aspm_attr_store_common()
    mmc: sdhci_am654: fix start loop index for TAP value parsing
    mmc: vub300: fix an error code
    clk: qcom: ipq6018: drop the CLK_SET_RATE_PARENT flag from PLL clocks
    clk: qcom: ipq8074: drop the CLK_SET_RATE_PARENT flag from PLL clocks
    parisc/pdc: Add width field to struct pdc_model
    arm64: Restrict CPU_BIG_ENDIAN to GNU as or LLVM IAS 15.x or newer
    ACPI: resource: Do IRQ override on TongFang GMxXGxx
    watchdog: move softlockup_panic back to early_param
    PCI/sysfs: Protect driver's D3cold preference from user space
    hvc/xen: fix error path in xen_hvc_init() to always register frontend driver
    hvc/xen: fix console unplug
    tty/sysrq: replace smp_processor_id() with get_cpu()
    audit: don't WARN_ON_ONCE(!current->mm) in audit_exe_compare()
    audit: don't take task_lock() in audit_exe_compare() code path
    KVM: x86: Ignore MSR_AMD64_TW_CFG access
    KVM: x86: hyper-v: Don't auto-enable stimer on write from user-space
    x86/cpu/hygon: Fix the CPU topology evaluation for real
    scsi: megaraid_sas: Increase register read retry rount from 3 to 30 for selected registers
    scsi: mpt3sas: Fix loop logic
    bpf: Fix precision tracking for BPF_ALU | BPF_TO_BE | BPF_END
    bpf: Fix check_stack_write_fixed_off() to correctly spill imm
    randstruct: Fix gcc-plugin performance mode to stay in group
    powerpc/perf: Fix disabling BHRB and instruction sampling
    media: venus: hfi: add checks to perform sanity on queue pointers
    cifs: fix check of rc in function generate_smb3signingkey
    cifs: spnego: add ';' in HOST_KEY_LEN
    tools/power/turbostat: Fix a knl bug
    macvlan: Don't propagate promisc change to lower dev in passthru
    net/mlx5e: Check return value of snprintf writing to fw_version buffer for representors
    net/mlx5_core: Clean driver version and name
    net/mlx5e: fix double free of encap_header
    net: stmmac: fix rx budget limit check
    netfilter: nf_conntrack_bridge: initialize err to 0
    net: ethernet: cortina: Fix MTU max setting
    net: ethernet: cortina: Handle large frames
    net: ethernet: cortina: Fix max RX frame define
    bonding: stop the device in bond_setup_by_slave()
    ptp: annotate data-race around q->head and q->tail
    xen/events: fix delayed eoi list handling
    ppp: limit MRU to 64K
    tipc: Fix kernel-infoleak due to uninitialized TLV value
    net: hns3: fix VF reset fail issue
    net: hns3: fix variable may not initialized problem in hns3_init_mac_addr()
    tty: Fix uninit-value access in ppp_sync_receive()
    ipvlan: add ipvlan_route_v6_outbound() helper
    gfs2: Silence "suspicious RCU usage in gfs2_permission" warning
    SUNRPC: Fix RPC client cleaned up the freed pipefs dentries
    NFSv4.1: fix SP4_MACH_CRED protection for pnfs IO
    SUNRPC: Add an IS_ERR() check back to where it was
    SUNRPC: ECONNRESET might require a rebind
    xhci: turn cancelled td cleanup to its own function
    wifi: iwlwifi: Use FW rate for non-data frames
    pwm: Fix double shift bug
    drm/amdgpu: fix software pci_unplug on some chips
    ASoC: ti: omap-mcbsp: Fix runtime PM underflow warnings
    kgdb: Flush console before entering kgdb on panic
    drm/amd/display: Avoid NULL dereference of timing generator
    media: imon: fix access to invalid resource for the second interface
    media: cobalt: Use FIELD_GET() to extract Link Width
    gfs2: fix an oops in gfs2_permission
    gfs2: ignore negated quota changes
    media: vivid: avoid integer overflow
    media: gspca: cpia1: shift-out-of-bounds in set_flicker
    i2c: sun6i-p2wi: Prevent potential division by zero
    9p/trans_fd: Annotate data-racy writes to file::f_flags
    usb: gadget: f_ncm: Always set current gadget in ncm_bind()
    tty: vcc: Add check for kstrdup() in vcc_probe()
    exfat: support handle zero-size directory
    HID: Add quirk for Dell Pro Wireless Keyboard and Mouse KM5221W
    misc: pci_endpoint_test: Add Device ID for R-Car S4-8 PCIe controller
    scsi: libfc: Fix potential NULL pointer dereference in fc_lport_ptp_setup()
    atm: iphase: Do PCI error checks on own line
    PCI: tegra194: Use FIELD_GET()/FIELD_PREP() with Link Width fields
    ALSA: hda: Fix possible null-ptr-deref when assigning a stream
    ARM: 9320/1: fix stack depot IRQ stack filter
    HID: lenovo: Detect quirk-free fw on cptkbd and stop applying workaround
    jfs: fix array-index-out-of-bounds in diAlloc
    jfs: fix array-index-out-of-bounds in dbFindLeaf
    fs/jfs: Add validity check for db_maxag and db_agpref
    fs/jfs: Add check for negative db_l2nbperpage
    RDMA/hfi1: Use FIELD_GET() to extract Link Width
    crypto: pcrypt - Fix hungtask for PADATA_RESET
    ASoC: soc-card: Add storage for PCI SSID
    selftests/efivarfs: create-read: fix a resource leak
    drm/amdgpu: Fix a null pointer access when the smc_rreg pointer is NULL
    drm/panel: st7703: Pick different reset sequence
    drm/panel/panel-tpo-tpg110: fix a possible null pointer dereference
    drm/panel: fix a possible null pointer dereference
    drm/amdgpu: Fix potential null pointer derefernce
    drm/amd: Fix UBSAN array-index-out-of-bounds for Polaris and Tonga
    drm/amd: Fix UBSAN array-index-out-of-bounds for SMU7
    drm/msm/dp: skip validity check for DP CTS EDID checksum
    drm/komeda: drop all currently held locks if deadlock happens
    platform/x86: thinkpad_acpi: Add battery quirk for Thinkpad X120e
    Bluetooth: Fix double free in hci_conn_cleanup
    Bluetooth: btusb: Add date->evt_skb is NULL check
    wifi: ath10k: Don't touch the CE interrupt registers after power up
    net: annotate data-races around sk->sk_dst_pending_confirm
    net: annotate data-races around sk->sk_tx_queue_mapping
    wifi: ath10k: fix clang-specific fortify warning
    wifi: ath9k: fix clang-specific fortify warnings
    bpf: Detect IP == ksym.end as part of BPF program
    wifi: mac80211: don't return unset power in ieee80211_get_tx_power()
    wifi: mac80211_hwsim: fix clang-specific fortify warning
    x86/mm: Drop the 4 MB restriction on minimal NUMA node memory size
    clocksource/drivers/timer-atmel-tcb: Fix initialization on SAM9 hardware
    clocksource/drivers/timer-imx-gpt: Fix potential memory leak
    perf/core: Bail out early if the request AUX area is out of bound
    locking/ww_mutex/test: Fix potential workqueue corruption
    Linux 5.10.201
    btrfs: use u64 for buffer sizes in the tree search ioctls
    Revert "mmc: core: Capture correct oemid-bits for eMMC cards"
    tracing/kprobes: Fix the order of argument descriptions
    fbdev: fsl-diu-fb: mark wr_reg_wa() static
    fbdev: imsttfb: fix a resource leak in probe
    fbdev: imsttfb: Fix error path of imsttfb_probe()
    spi: spi-zynq-qspi: add spi-mem to driver kconfig dependencies
    drm/syncobj: fix DRM_SYNCOBJ_WAIT_FLAGS_WAIT_AVAILABLE
    x86/sev-es: Allow copy_from_kernel_nofault() in earlier boot
    x86: Share definition of __is_canonical_address()
    netfilter: nat: fix ipv6 nat redirect with mapped and scoped addresses
    netfilter: nft_redir: use `struct nf_nat_range2` throughout and deduplicate eval call-backs
    netfilter: xt_recent: fix (increase) ipv6 literal buffer length
    r8169: respect userspace disabling IFF_MULTICAST
    tg3: power down device only on SYSTEM_POWER_OFF
    net/smc: put sk reference if close work was canceled
    net/smc: allow cdc msg send rather than drop it with NULL sndbuf_desc
    net/smc: fix dangling sock under state SMC_APPFINCLOSEWAIT
    net: stmmac: xgmac: Enable support for multiple Flexible PPS outputs
    Fix termination state for idr_for_each_entry_ul()
    net: r8169: Disable multicast filter for RTL8168H and RTL8107E
    dccp/tcp: Call security_inet_conn_request() after setting IPv6 addresses.
    dccp: Call security_inet_conn_request() after setting IPv4 addresses.
    inet: shrink struct flowi_common
    tipc: Change nla_policy for bearer-related names to NLA_NUL_STRING
    hsr: Prevent use after free in prp_create_tagged_frame()
    llc: verify mac len before reading mac header
    Input: synaptics-rmi4 - fix use after free in rmi_unregister_function()
    pwm: brcmstb: Utilize appropriate clock APIs in suspend/resume
    pwm: sti: Reduce number of allocations and drop usage of chip_data
    pwm: sti: Avoid conditional gotos
    regmap: prevent noinc writes from clobbering cache
    media: dvb-usb-v2: af9035: fix missing unlock
    media: cedrus: Fix clock/reset sequence
    media: vidtv: mux: Add check and kfree for kstrdup
    media: vidtv: psi: Add check for kstrdup
    media: s3c-camif: Avoid inappropriate kfree()
    media: bttv: fix use after free error due to btv->timeout timer
    media: i2c: max9286: Fix some redundant of_node_put() calls
    pcmcia: ds: fix possible name leak in error path in pcmcia_device_add()
    pcmcia: ds: fix refcount leak in pcmcia_device_add()
    pcmcia: cs: fix possible hung task and memory leak pccardd()
    rtc: pcf85363: fix wrong mask/val parameters in regmap_update_bits call
    i3c: Fix potential refcount leak in i3c_master_register_new_i3c_devs
    perf hist: Add missing puts to hist__account_cycles
    perf machine: Avoid out of bounds LBR memory read
    usb: host: xhci-plat: fix possible kernel oops while resuming
    xhci: Loosen RPM as default policy to cover for AMD xHC 1.1
    powerpc/pseries: fix potential memory leak in init_cpu_associativity()
    powerpc/imc-pmu: Use the correct spinlock initializer.
    powerpc/xive: Fix endian conversion size
    powerpc/40x: Remove stale PTE_ATOMIC_UPDATES macro
    modpost: fix tee MODULE_DEVICE_TABLE built on big-endian host
    interconnect: qcom: sc7180: Set ACV enable_mask
    interconnect: qcom: sc7180: Retire DEFINE_QBCM
    f2fs: fix to initialize map.m_pblk in f2fs_precache_extents()
    dmaengine: pxa_dma: Remove an erroneous BUG_ON() in pxad_free_desc()
    USB: usbip: fix stub_dev hub disconnect
    tools: iio: iio_generic_buffer ensure alignment
    tools: iio: iio_generic_buffer: Fix some integer type and calculation
    tools: iio: privatize globals and functions in iio_generic_buffer.c file
    misc: st_core: Do not call kfree_skb() under spin_lock_irqsave()
    dmaengine: ti: edma: handle irq_of_parse_and_map() errors
    usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency
    livepatch: Fix missing newline character in klp_resolve_symbols()
    tty: tty_jobctrl: fix pid memleak in disassociate_ctty()
    leds: trigger: ledtrig-cpu:: Fix 'output may be truncated' issue for 'cpu'
    leds: pwm: Don't disable the PWM when the LED should be off
    mfd: dln2: Fix double put in dln2_probe
    mfd: core: Ensure disabled devices are skipped without aborting
    mfd: core: Un-constify mfd_cell.of_reg
    ASoC: ams-delta.c: use component after check
    padata: Fix refcnt handling in padata_free_shell()
    padata: Convert from atomic_t to refcount_t on parallel_data->refcnt
    ASoC: Intel: Skylake: Fix mem leak when parsing UUIDs fails
    HID: logitech-hidpp: Move get_wireless_feature_index() check to hidpp_connect_event()
    HID: logitech-hidpp: Revert "Don't restart communication if not necessary"
    HID: logitech-hidpp: Don't restart IO, instead defer hid_connect() only
    HID: logitech-hidpp: Remove HIDPP_QUIRK_NO_HIDINPUT quirk
    Revert "HID: logitech-hidpp: add a module parameter to keep firmware gestures"
    sh: bios: Revive earlyprintk support
    hid: cp2112: Fix IRQ shutdown stopping polling for all IRQs on chip
    RDMA/hfi1: Workaround truncation compilation error
    scsi: ufs: core: Leave space for '\0' in utf8 desc string
    ASoC: fsl: Fix PM disable depth imbalance in fsl_easrc_probe
    RDMA/hns: Fix signed-unsigned mixed comparisons
    RDMA/hns: Fix uninitialized ucmd in hns_roce_create_qp_common()
    IB/mlx5: Fix rdma counter binding for RAW QP
    ASoC: fsl: mpc5200_dma.c: Fix warning of Function parameter or member not described
    ext4: move 'ix' sanity check to corrent position
    ARM: 9321/1: memset: cast the constant byte to unsigned char
    hid: cp2112: Fix duplicate workqueue initialization
    crypto: qat - increase size of buffers
    crypto: qat - mask device capabilities with soft straps
    crypto: caam/jr - fix Chacha20 + Poly1305 self test failure
    crypto: caam/qi2 - fix Chacha20 + Poly1305 self test failure
    nd_btt: Make BTT lanes preemptible
    libnvdimm/of_pmem: Use devm_kstrdup instead of kstrdup and check its return value
    hwrng: geode - fix accessing registers
    crypto: hisilicon/hpre - Fix a erroneous check after snprintf()
    selftests/resctrl: Ensure the benchmark commands fits to its array
    selftests/pidfd: Fix ksft print formats
    clk: scmi: Free scmi_clk allocated when the clocks with invalid info are skipped
    firmware: ti_sci: Mark driver as non removable
    soc: qcom: llcc: Handle a second device without data corruption
    ARM: dts: qcom: mdm9615: populate vsdcc fixed regulator
    arm64: dts: qcom: sdm845-mtp: fix WiFi configuration
    arm64: dts: qcom: msm8916: Fix iommu local address range
    xen-pciback: Consider INTx disabled when MSI/MSI-X is enabled
    drm/rockchip: Fix type promotion bug in rockchip_gem_iommu_map()
    arm64/arm: xen: enlighten: Fix KPTI checks
    drm/rockchip: cdn-dp: Fix some error handling paths in cdn_dp_probe()
    drm/mediatek: Fix iommu fault during crtc enabling
    drm/bridge: tc358768: Fix bit updates
    drm/bridge: tc358768: Disable non-continuous clock mode
    drm/bridge: tc358768: Fix use of uninitialized variable
    drm/radeon: possible buffer overflow
    drm/rockchip: vop: Fix call to crtc reset helper
    drm/rockchip: vop: Fix reset of state in duplicate state crtc funcs
    hwmon: (coretemp) Fix potentially truncated sysfs attribute name
    hwmon: (axi-fan-control) Fix possible NULL pointer dereference
    hwmon: (axi-fan-control) Support temperature vs pwm points
    platform/x86: wmi: Fix opening of char device
    platform/x86: wmi: remove unnecessary initializations
    platform/x86: wmi: Fix probe failure when failing to register WMI devices
    clk: qcom: config IPQ_APSS_6018 should depend on QCOM_SMEM
    clk: mediatek: clk-mt2701: Add check for mtk_alloc_clk_data
    clk: mediatek: clk-mt7629: Add check for mtk_alloc_clk_data
    clk: mediatek: clk-mt7629-eth: Add check for mtk_alloc_clk_data
    clk: mediatek: clk-mt6797: Add check for mtk_alloc_clk_data
    clk: mediatek: clk-mt6779: Add check for mtk_alloc_clk_data
    clk: mediatek: clk-mt6765: Add check for mtk_alloc_clk_data
    clk: npcm7xx: Fix incorrect kfree
    clk: ti: fix double free in of_ti_divider_clk_setup()
    clk: ti: change ti_clk_register[_omap_hw]() API
    clk: ti: Update component clocks to use ti_dt_clk_name()
    clk: ti: Update pll and clockdomain clocks to use ti_dt_clk_name()
    clk: ti: Add ti_dt_clk_name() helper to use clock-output-names
    clk: keystone: pll: fix a couple NULL vs IS_ERR() checks
    spi: nxp-fspi: use the correct ioremap function
    clk: linux/clk-provider.h: fix kernel-doc warnings and typos
    clk: asm9260: use parent index to link the reference clock
    clk: imx: imx8mq: correct error handling path
    clk: imx: Select MXC_CLK for CLK_IMX8QXP
    clk: qcom: gcc-sm8150: Fix gcc_sdcc2_apps_clk_src
    clk: qcom: gcc-sm8150: use ARRAY_SIZE instead of specifying num_parents
    clk: qcom: mmcc-msm8998: Fix the SMMU GDSC
    clk: qcom: mmcc-msm8998: Set bimc_smmu_gdsc always on
    clk: qcom: mmcc-msm8998: Don't check halt bit on some branch clks
    clk: qcom: mmcc-msm8998: Add hardware clockgating registers to some clks
    clk: qcom: clk-rcg2: Fix clock rate overflow for high parent frequencies
    regmap: debugfs: Fix a erroneous check after snprintf()
    ipvlan: properly track tx_errors
    net: add DEV_STATS_READ() helper
    ipv6: avoid atomic fragment on GSO packets
    ACPI: sysfs: Fix create_pnp_modalias() and create_of_modalias()
    tcp: fix cookie_init_timestamp() overflows
    chtls: fix tp->rcv_tstamp initialization
    r8169: fix rare issue with broken rx after link-down on RTL8125
    r8169: use tp_to_dev instead of open code
    thermal: core: prevent potential string overflow
    PM / devfreq: rockchip-dfi: Make pmu regmap mandatory
    can: dev: can_restart(): fix race condition between controller restart and netif_carrier_on()
    can: dev: can_restart(): don't crash kernel if carrier is OK
    wifi: rtlwifi: fix EDCA limit set by BT coexistence
    tcp_metrics: do not create an entry from tcp_init_metrics()
    tcp_metrics: properly set tp->snd_ssthresh in tcp_init_metrics()
    tcp_metrics: add missing barriers on delete
    wifi: mt76: mt7603: rework/fix rx pse hang check
    wifi: rtw88: debug: Fix the NULL vs IS_ERR() bug for debugfs_create_file()
    net: spider_net: Use size_add() in call to struct_size()
    tipc: Use size_add() in calls to struct_size()
    mlxsw: Use size_mul() in call to struct_size()
    gve: Use size_add() in call to struct_size()
    overflow: Implement size_t saturating arithmetic helpers
    tcp: call tcp_try_undo_recovery when an RTOd TFO SYNACK is ACKed
    udp: add missing WRITE_ONCE() around up->encap_rcv
    i40e: fix potential memory leaks in i40e_remove()
    genirq/matrix: Exclude managed interrupts in irq_matrix_allocated()
    pstore/platform: Add check for kstrdup
    x86/boot: Fix incorrect startup_gdt_descr.size
    futex: Don't include process MM in futex key on no-MMU
    x86/srso: Fix SBPB enablement for (possible) future fixed HW
    vfs: fix readahead(2) on block devices
    sched/uclamp: Ignore (util == 0) optimization in feec() when p_util_max = 0
    iov_iter, x86: Be consistent about the __user tag on copy_mc_to_user()
    Linux 5.10.200
    ALSA: hda: intel-dsp-config: Fix JSL Chromebook quirk detection
    tty: 8250: Add support for Intashield IS-100
    tty: 8250: Add support for Brainboxes UP cards
    tty: 8250: Add support for additional Brainboxes UC cards
    tty: 8250: Remove UC-257 and UC-431
    usb: raw-gadget: properly handle interrupted requests
    usb: storage: set 1.50 as the lower bcdDevice for older "Super Top" compatibility
    PCI: Prevent xHCI driver from claiming AMD VanGogh USB3 DRD device
    can: isotp: isotp_sendmsg(): fix TX state detection and wait behavior
    can: isotp: isotp_bind(): do not validate unused address information
    can: isotp: add local echo tx processing and tx without FC
    can: isotp: handle wait_event_interruptible() return values
    can: isotp: check CAN address family in isotp_bind()
    can: isotp: isotp_bind(): return -EINVAL on incorrect CAN ID formatting
    can: isotp: set max PDU size to 64 kByte
    can: isotp: Add error message if txqueuelen is too small
    can: isotp: add symbolic error message to isotp_module_init()
    can: isotp: change error format from decimal to symbolic error names
    powerpc/mm: Fix boot crash with FLATMEM
    net: chelsio: cxgb4: add an error code check in t4_load_phy_fw
    platform/mellanox: mlxbf-tmfifo: Fix a warning message
    scsi: mpt3sas: Fix in error path
    fbdev: uvesafb: Call cn_del_callback() at the end of uvesafb_exit()
    ASoC: rt5650: fix the wrong result of key button
    netfilter: nfnetlink_log: silence bogus compiler warning
    spi: npcm-fiu: Fix UMA reads when dummy.nbytes == 0
    fbdev: atyfb: only use ioremap_uc() on i386 and ia64
    Input: synaptics-rmi4 - handle reset delay when using SMBus trsnsport
    dmaengine: ste_dma40: Fix PM disable depth imbalance in d40_probe
    irqchip/stm32-exti: add missing DT IRQ flag translation
    net: sched: cls_u32: Fix allocation size in u32_init()
    x86: Fix .brk attribute in linker script
    rpmsg: Fix possible refcount leak in rpmsg_register_device_override()
    rpmsg: glink: Release driver_override
    rpmsg: Fix calling device_lock() on non-initialized device
    rpmsg: Fix kfree() of static memory on setting driver_override
    rpmsg: Constify local variable in field store macro
    driver: platform: Add helper for safer setting of driver_override
    objtool/x86: add missing embedded_insn check
    ext4: avoid overlapping preallocations due to overflow
    ext4: fix BUG in ext4_mb_new_inode_pa() due to overflow
    ext4: add two helper functions extent_logical_end() and pa_logical_end()
    x86/mm: Fix RESERVE_BRK() for older binutils
    x86/mm: Simplify RESERVE_BRK()
    f2fs: fix to do sanity check on inode type during garbage collection
    smbdirect: missing rc checks while waiting for rdma events
    kobject: Fix slab-out-of-bounds in fill_kobj_path()
    x86/i8259: Skip probing when ACPI/MADT advertises PCAT compatibility
    iio: adc: xilinx-xadc: Don't clobber preset voltage/temperature thresholds
    iio: adc: xilinx: use more devres helpers and remove remove()
    iio: adc: xilinx: use devm_krealloc() instead of kfree() + kcalloc()
    iio: adc: xilinx: use helper variable for &pdev->dev
    clk: Sanitize possible_parent_show to Handle Return Value of of_clk_get_parent_name
    sparc32: fix a braino in fault handling in csum_and_copy_..._user()
    perf/core: Fix potential NULL deref
    nvmem: imx: correct nregs for i.MX6UL
    nvmem: imx: correct nregs for i.MX6SLL
    nvmem: imx: correct nregs for i.MX6ULL
    misc: fastrpc: Clean buffers on remote invocation failures
    tracing/kprobes: Fix the description of variable length arguments
    i2c: aspeed: Fix i2c bus hang in slave read
    i2c: stm32f7: Fix PEC handling in case of SMBUS transfers
    i2c: muxes: i2c-demux-pinctrl: Use of_get_i2c_adapter_by_node()
    i2c: muxes: i2c-mux-gpmux: Use of_get_i2c_adapter_by_node()
    i2c: muxes: i2c-mux-pinctrl: Use of_get_i2c_adapter_by_node()
    iio: exynos-adc: request second interupt only when touchscreen mode is used
    kasan: print the original fault addr when access invalid shadow
    i40e: Fix wrong check for I40E_TXR_FLAGS_WB_ON_ITR
    gtp: fix fragmentation needed check with gso
    gtp: uapi: fix GTPA_MAX
    tcp: fix wrong RTO timeout when received SACK reneging
    r8152: Release firmware if we have an error in probe
    r8152: Cancel hw_phy_work if we have an error in probe
    r8152: Run the unload routine if we have errors during probe
    r8152: Increase USB control msg timeout to 5000ms as per spec
    net: usb: smsc95xx: Fix uninit-value access in smsc95xx_read_reg
    net: ieee802154: adf7242: Fix some potential buffer overflow in adf7242_stats_show()
    igc: Fix ambiguity in the ethtool advertising
    neighbour: fix various data-races
    igb: Fix potential memory leak in igb_add_ethtool_nfc_entry
    treewide: Spelling fix in comment
    r8169: fix the KCSAN reported data race in rtl_rx while reading desc->opts1
    r8169: fix the KCSAN reported data-race in rtl_tx while reading TxDescArray[entry].opts1
    drm/dp_mst: Fix NULL deref in get_mst_branch_device_by_guid_helper()
    mmc: renesas_sdhi: use custom mask for TMIO_MASK_ALL
    mm/page_alloc: correct start page when guard page debug is enabled
    virtio-mmio: fix memory leak of vm_dev
    virtio_balloon: Fix endless deflation and inflation on arm64
    mcb-lpc: Reallocate memory region to avoid memory overlapping
    mcb: Return actual parsed size when reading chameleon table
    selftests/ftrace: Add new test case which checks non unique symbol
    Linux 5.10.199
    xfrm6: fix inet6_dev refcount underflow problem
    Bluetooth: hci_sock: Correctly bounds check and pad HCI_MON_NEW_INDEX name
    Bluetooth: hci_sock: fix slab oob read in create_monitor_event
    phy: mapphone-mdm6600: Fix pinctrl_pm handling for sleep pins
    phy: mapphone-mdm6600: Fix runtime PM for remove
    phy: mapphone-mdm6600: Fix runtime disable on probe
    ASoC: pxa: fix a memory leak in probe()
    gpio: vf610: set value before the direction to avoid a glitch
    platform/x86: asus-wmi: Map 0x2a code, Ignore 0x2b and 0x2c events
    platform/x86: asus-wmi: Change ASUS_WMI_BRN_DOWN code from 0x20 to 0x2e
    s390/pci: fix iommu bitmap allocation
    perf: Disallow mis-matched inherited group reads
    USB: serial: option: add Fibocom to DELL custom modem FM101R-GL
    USB: serial: option: add entry for Sierra EM9191 with new firmware
    USB: serial: option: add Telit LE910C4-WWX 0x1035 composition
    nvme-rdma: do not try to stop unallocated queues
    nvme-pci: add BOGUS_NID for Intel 0a54 device
    ACPI: irq: Fix incorrect return value in acpi_register_gsi()
    pNFS: Fix a hang in nfs4_evict_inode()
    Revert "pinctrl: avoid unsafe code pattern in find_pinctrl()"
    mmc: core: Capture correct oemid-bits for eMMC cards
    mmc: core: sdio: hold retuning if sdio in 1-bit mode
    mtd: physmap-core: Restore map_rom fallback
    mtd: spinand: micron: correct bitmask for ecc status
    mtd: rawnand: arasan: Ensure program page operations are successful
    mtd: rawnand: marvell: Ensure program page operations are successful
    mtd: rawnand: qcom: Unmap the right resource upon probe failure
    Bluetooth: hci_event: Fix using memcmp when comparing keys
    net/mlx5: Handle fw tracer change ownership event based on MTRC
    platform/x86: touchscreen_dmi: Add info for the Positivo C4128B
    HID: multitouch: Add required quirk for Synaptics 0xcd7e device
    btrfs: fix some -Wmaybe-uninitialized warnings in ioctl.c
    drm: panel-orientation-quirks: Add quirk for One Mix 2S
    ipv4/fib: send notify when delete source address routes
    sky2: Make sure there is at least one frag_addr available
    regulator/core: Revert "fix kobject release warning and memory leak in regulator_register()"
    wifi: cfg80211: avoid leaking stack data into trace
    wifi: mac80211: allow transmitting EAPOL frames with tainted key
    wifi: cfg80211: Fix 6GHz scan configuration
    Bluetooth: hci_core: Fix build warnings
    Bluetooth: Avoid redundant authentication
    HID: holtek: fix slab-out-of-bounds Write in holtek_kbd_input_event
    tracing: relax trace_event_eval_update() execution with cond_resched()
    ata: libata-eh: Fix compilation warning in ata_eh_link_report()
    gpio: timberdale: Fix potential deadlock on &tgpio->lock
    overlayfs: set ctime when setting mtime and atime
    i2c: mux: Avoid potential false error message in i2c_mux_add_adapter
    btrfs: initialize start_slot in btrfs_log_prealloc_extents
    btrfs: return -EUCLEAN for delayed tree ref with a ref count not equals to 1
    ARM: dts: ti: omap: Fix noisy serial with overrun-throttle-ms for mapphone
    usb: typec: altmodes/displayport: Signal hpd low when exiting mode
    usb: typec: altmodes/displayport: Notify drm subsys of hotplug events
    drm/connector: Add support for out-of-band hotplug notification (v3)
    drm/connector: Add drm_connector_find_by_fwnode() function (v3)
    drm/connector: Add a fwnode pointer to drm_connector and register with ACPI (v2)
    drm/connector: Give connector sysfs devices there own device_type
    drm/amd/display: Don't set dpms_off for seamless boot
    drm/amd/display: only check available pipe to disable vbios mode.
    serial: 8250_omap: Fix errors with no_console_suspend
    serial: 8250: omap: Fix imprecise external abort for omap_8250_pm()
    xhci: track port suspend state correctly in unsuccessful resume cases
    xhci: decouple usb2 port resume and get_port_status request handling
    xhci: clear usb2 resume related variables in one place.
    xhci: rename resume_done to resume_timestamp
    xhci: move port specific items such as state completions to port structure
    xhci: cleanup xhci_hub_control port references
    usb: core: Track SuperSpeed Plus GenXxY
    selftests/mm: fix awk usage in charge_reserved_hugetlb.sh and hugetlb_reparenting_test.sh that may cause error
    selftests/vm: make charge_reserved_hugetlb.sh work with existing cgroup setting
    ACPI: resource: Skip IRQ override on ASUS ExpertBook B1402CBA
    ACPI: resource: Skip IRQ override on ASUS ExpertBook B1502CBA
    ACPI: resource: Skip IRQ override on Asus Expertbook B2402CBA
    ACPI: resource: Add Asus ExpertBook B2502 to Asus quirks
    ACPI: resource: Skip IRQ override on Asus Vivobook S5602ZA
    ACPI: resource: Add ASUS model S5402ZA to quirks
    ACPI: resource: Skip IRQ override on Asus Vivobook K3402ZA/K3502ZA
    ACPI: resources: Add DMI-based legacy IRQ override quirk
    ACPI: Drop acpi_dev_irqresource_disabled()
    resource: Add irqresource_disabled()
    thunderbolt: Workaround an IOMMU fault on certain systems with Intel Maple Ridge
    net: pktgen: Fix interface flags printing
    netfilter: nft_set_rbtree: .deactivate fails if element has expired
    neighbor: tracing: Move pin6 inside CONFIG_IPV6=y section
    net/sched: sch_hfsc: upgrade 'rt' to 'sc' when it becomes a inner curve
    net: dsa: bcm_sf2: Fix possible memory leak in bcm_sf2_mdio_register()
    i40e: prevent crash on probe if hw registers have invalid values
    net: usb: smsc95xx: Fix an error code in smsc95xx_reset()
    ipv4: fib: annotate races around nh->nh_saddr_genid and nh->nh_saddr
    tun: prevent negative ifindex
    tcp: tsq: relax tcp_small_queue_check() when rtx queue contains a single skb
    tcp: fix excessive TLP and RACK timeouts from HZ rounding
    net: rfkill: gpio: prevent value glitch during probe
    net: ipv6: fix return value check in esp_remove_trailer
    net: ipv4: fix return value check in esp_remove_trailer
    xfrm: interface: use DEV_STATS_INC()
    xfrm: fix a data-race in xfrm_gen_index()
    qed: fix LL2 RX buffer allocation
    drm/i915: Retry gtt fault when out of fence registers
    nvmet-tcp: Fix a possible UAF in queue intialization setup
    netfilter: nft_payload: fix wrong mac header matching
    tcp: check mptcp-level constraints for backlog coalescing
    x86/sev: Check for user-space IOIO pointing to kernel space
    x86/sev: Check IOBM for IOIO exceptions from user-space
    x86/sev: Disable MMIO emulation from user mode
    KVM: x86: Mask LVTPC when handling a PMI
    regmap: fix NULL deref on lookup
    nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
    ice: reset first in crash dump kernels
    ice: fix over-shifted variable
    Bluetooth: avoid memcmp() out of bounds warning
    Bluetooth: hci_event: Fix coding style
    Bluetooth: vhci: Fix race when opening vhci device
    Bluetooth: Fix a refcnt underflow problem for hci_conn
    Bluetooth: Reject connection with the device which has same BD_ADDR
    Bluetooth: hci_event: Ignore NULL link key
    usb: hub: Guard against accesses to uninitialized BOS descriptors
    Documentation: sysctl: align cells in second content column
    mm/memory_hotplug: rate limit page migration warnings
    lib/Kconfig.debug: do not enable DEBUG_PREEMPT by default
    dev_forward_skb: do not scrub skb mark within the same name space
    ravb: Fix use-after-free issue in ravb_tx_timeout_work()
    RDMA/srp: Fix srp_abort()
    RDMA/srp: Set scmnd->result only when scmnd is not NULL
    arm64: armv8_deprecated: fix unused-function error
    arm64: armv8_deprecated: rework deprected instruction handling
    arm64: armv8_deprecated: move aarch32 helper earlier
    arm64: armv8_deprecated move emulation functions
    arm64: armv8_deprecated: fold ops into insn_emulation
    arm64: rework EL0 MRS emulation
    arm64: factor insn read out of call_undef_hook()
    arm64: factor out EL1 SSBS emulation hook
    arm64: split EL0/EL1 UNDEF handlers
    arm64: allow kprobes on EL0 handlers
    arm64: rework BTI exception handling
    arm64: rework FPAC exception handling
    arm64: consistently pass ESR_ELx to die()
    arm64: die(): pass 'err' as long
    arm64: report EL1 UNDEFs better
    x86/alternatives: Disable KASAN in apply_alternatives()
    powerpc/64e: Fix wrong test in __ptep_test_and_clear_young()
    powerpc/8xx: Fix pte_access_permitted() for PAGE_NONE
    dmaengine: mediatek: Fix deadlock caused by synchronize_irq()
    usb: gadget: ncm: Handle decoding of multiple NTB's in unwrap call
    usb: gadget: udc-xilinx: replace memcpy with memcpy_toio
    counter: microchip-tcb-capture: Fix the use of internal GCLK logic
    pinctrl: avoid unsafe code pattern in find_pinctrl()
    cgroup: Remove duplicates in cgroup v1 tasks file
    tee: amdtee: fix use-after-free vulnerability in amdtee_close_session
    Input: goodix - ensure int GPIO is in input for gpio_count == 1 && gpio_int_idx == 0 case
    Input: i8042 - add Fujitsu Lifebook E5411 to i8042 quirk table
    Input: xpad - add PXN V900 support
    Input: psmouse - fix fast_reconnect function for PS/2 mode
    Input: powermate - fix use-after-free in powermate_config_complete
    ceph: fix type promotion bug on 32bit systems
    ceph: fix incorrect revoked caps assert in ceph_fill_file_size()
    libceph: use kernel_connect()
    thunderbolt: Check that lane 1 is in CL0 before enabling lane bonding
    mcb: remove is_added flag from mcb_device struct
    x86/cpu: Fix AMD erratum #1485 on Zen4-based CPUs
    iio: pressure: ms5611: ms5611_prom_is_valid false negative bug
    iio: pressure: dps310: Adjust Timeout Settings
    iio: pressure: bmp280: Fix NULL pointer exception
    usb: musb: Modify the "HWVers" register address
    usb: musb: Get the musb_qh poniter after musb_giveback
    usb: dwc3: Soft reset phy on probe for host
    net: usb: dm9601: fix uninitialized variable use in dm9601_mdio_read
    usb: xhci: xhci-ring: Use sysdev for mapping bounce buffer
    dmaengine: stm32-mdma: abort resume if no ongoing transfer
    media: mtk-jpeg: Fix use after free bug due to uncanceled work
    net: release reference to inet6_dev pointer
    net: change accept_ra_min_rtr_lft to affect all RA lifetimes
    net: add sysctl accept_ra_min_rtr_lft
    Revert "spi: spi-zynqmp-gqspi: Fix runtime PM imbalance in zynqmp_qspi_probe"
    Revert "spi: zynqmp-gqspi: fix clock imbalance on probe failure"
    workqueue: Override implicit ordered attribute in workqueue_apply_unbound_cpumask()
    nfc: nci: assert requested protocol is valid
    pinctrl: renesas: rzn1: Enable missing PINMUX
    net: nfc: fix races in nfc_llcp_sock_get() and nfc_llcp_sock_get_sn()
    ixgbe: fix crash with empty VF macvlan list
    net: phy: mscc: macsec: reject PN update requests
    net: macsec: indicate next pn update when offloading
    drm/vmwgfx: fix typo of sizeof argument
    riscv, bpf: Sign-extend return values
    riscv, bpf: Factor out emit_call for kernel and bpf context
    xen-netback: use default TX queue size for vifs
    mlxsw: fix mlxsw_sp2_nve_vxlan_learning_set() return type
    ieee802154: ca8210: Fix a potential UAF in ca8210_probe
    ravb: Fix up dma_free_coherent() call in ravb_remove()
    drm/msm/dpu: change _dpu_plane_calc_bw() to use u64 to avoid overflow
    drm/msm/dsi: skip the wait for video mode done if not applicable
    drm/msm/dp: do not reinitialize phy unless retry during link training
    net: prevent address rewrite in kernel_bind()
    quota: Fix slow quotaoff
    HID: logitech-hidpp: Fix kernel crash on receiver USB disconnect
    lib/test_meminit: fix off-by-one error in test_pages()
    perf/arm-cmn: Fix the unhandled overflow status of counter 4 to 7
    RDMA/cxgb4: Check skb value for failure to allocate
    RDMA/srp: Do not call scsi_done() from srp_abort()
    RDMA/srp: Make struct scsi_cmnd and struct srp_request adjacent
- Linux 5.10.208. [Greg Kroah-Hartman]
- Revert "nvme: use command_id instead of req->tag in
  trace_nvme_complete_rq()" [Greg Kroah-Hartman]

  This reverts commit 706960d328f5bdb1a9cde0b17a98ab84a59eed8e which is
  commit 679c54f2de672b7d79d02f8c4ad483ff6dd8ce2e upstream.

  It is reported to cause issues.
- PCI: Disable ATS for specific Intel IPU E2000 devices. [Bartosz
  Pawlowski]

  commit a18615b1cfc04f00548c60eb9a77e0ce56e848fd upstream.

  Due to a hardware issue in A and B steppings of Intel IPU E2000, it expects
  wrong endianness in ATS invalidation message body. This problem can lead to
  outdated translations being returned as valid and finally cause system
  instability.

  To prevent such issues, add quirk_intel_e2000_no_ats() to disable ATS for
  vulnerable IPU E2000 devices.
- PCI: Extract ATS disabling to a helper function. [Bartosz Pawlowski]

  commit f18b1137d38c091cc8c16365219f0a1d4a30b3d1 upstream.

  Introduce quirk_no_ats() helper function to provide a standard way to
  disable ATS capability in PCI quirks.
- Netfilter: nf_tables: Reject tables of unsupported family. [Phil
  Sutter]

  commit f1082dd31fe461d482d69da2a8eccfeb7bf07ac2 upstream.

  An nftables family is merely a hollow container, its family just a
  number and such not reliant on compile-time options other than nftables
  support itself. Add an artificial check so attempts at using a family
  the kernel can't support fail as early as possible. This helps user
  space detect kernels which lack e.g. NFPROTO_INET.
- Drm/qxl: fix UAF on handle creation. [Wander Lairson Costa]

  commit c611589b4259ed63b9b77be6872b1ce07ec0ac16 upstream.

  qxl_mode_dumb_create() dereferences the qobj returned by
  qxl_gem_object_create_with_handle(), but the handle is the only one
  holding a reference to it.

  A potential attacker could guess the returned handle value and closes it
  between the return of qxl_gem_object_create_with_handle() and the qobj
  usage, triggering a use-after-free scenario.

  Reproducer:

  int dri_fd =-1;
  struct drm_mode_create_dumb arg = {0};

  void gem_close(int handle);

  void* trigger(void* ptr)
  {
  	int ret;
  	arg.width = arg.height = 0x20;
  	arg.bpp = 32;
  	ret = ioctl(dri_fd, DRM_IOCTL_MODE_CREATE_DUMB, &arg);
  	if(ret)
  	{
  		perror("[*] DRM_IOCTL_MODE_CREATE_DUMB Failed");
  		exit(-1);
  	}
  	gem_close(arg.handle);
  	while(1) {
  		struct drm_mode_create_dumb args = {0};
  		args.width = args.height = 0x20;
  		args.bpp = 32;
  		ret = ioctl(dri_fd, DRM_IOCTL_MODE_CREATE_DUMB, &args);
  		if (ret) {
  			perror("[*] DRM_IOCTL_MODE_CREATE_DUMB Failed");
  			exit(-1);
  		}

  		printf("[*] DRM_IOCTL_MODE_CREATE_DUMB created, %d\n", args.handle);
  		gem_close(args.handle);
  	}
  	return NULL;
  }

  void gem_close(int handle)
  {
  	struct drm_gem_close args;
  	args.handle = handle;
  	int ret = ioctl(dri_fd, DRM_IOCTL_GEM_CLOSE, &args); // gem close handle
  	if (!ret)
  		printf("gem close handle %d\n", args.handle);
  }

  int main(void)
  {
  	dri_fd= open("/dev/dri/card0", O_RDWR);
  	printf("fd:%d\n", dri_fd);

  	if(dri_fd == -1)
  		return -1;

  	pthread_t tid1;

  	if(pthread_create(&tid1,NULL,trigger,NULL)){
  		perror("[*] thread_create tid1\n");
  		return -1;
  	}
  	while (1)
  	{
  		gem_close(arg.handle);
  	}
  	return 0;
  }

  This is a KASAN report:

  ==================================================================
  BUG: KASAN: slab-use-after-free in qxl_mode_dumb_create+0x3c2/0x400 linux/drivers/gpu/drm/qxl/qxl_dumb.c:69
  Write of size 1 at addr ffff88801136c240 by task poc/515

  CPU: 1 PID: 515 Comm: poc Not tainted 6.3.0 #3
  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.0-debian-1.16.0-4 04/01/2014
  Call Trace:
  <TASK>
  __dump_stack linux/lib/dump_stack.c:88
  dump_stack_lvl+0x48/0x70 linux/lib/dump_stack.c:106
  print_address_description linux/mm/kasan/report.c:319
  print_report+0xd2/0x660 linux/mm/kasan/report.c:430
  kasan_report+0xd2/0x110 linux/mm/kasan/report.c:536
  __asan_report_store1_noabort+0x17/0x30 linux/mm/kasan/report_generic.c:383
  qxl_mode_dumb_create+0x3c2/0x400 linux/drivers/gpu/drm/qxl/qxl_dumb.c:69
  drm_mode_create_dumb linux/drivers/gpu/drm/drm_dumb_buffers.c:96
  drm_mode_create_dumb_ioctl+0x1f5/0x2d0 linux/drivers/gpu/drm/drm_dumb_buffers.c:102
  drm_ioctl_kernel+0x21d/0x430 linux/drivers/gpu/drm/drm_ioctl.c:788
  drm_ioctl+0x56f/0xcc0 linux/drivers/gpu/drm/drm_ioctl.c:891
  vfs_ioctl linux/fs/ioctl.c:51
  __do_sys_ioctl linux/fs/ioctl.c:870
  __se_sys_ioctl linux/fs/ioctl.c:856
  __x64_sys_ioctl+0x13d/0x1c0 linux/fs/ioctl.c:856
  do_syscall_x64 linux/arch/x86/entry/common.c:50
  do_syscall_64+0x5b/0x90 linux/arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x72/0xdc linux/arch/x86/entry/entry_64.S:120
  RIP: 0033:0x7ff5004ff5f7
  Code: 00 00 00 48 8b 05 99 c8 0d 00 64 c7 00 26 00 00 00 48 c7 c0 ff ff ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 b8 10 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 69 c8 0d 00 f7 d8 64 89 01 48

  RSP: 002b:00007ff500408ea8 EFLAGS: 00000286 ORIG_RAX: 0000000000000010
  RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007ff5004ff5f7
  RDX: 00007ff500408ec0 RSI: 00000000c02064b2 RDI: 0000000000000003
  RBP: 00007ff500408ef0 R08: 0000000000000000 R09: 000000000000002a
  R10: 0000000000000000 R11: 0000000000000286 R12: 00007fff1c6cdafe
  R13: 00007fff1c6cdaff R14: 00007ff500408fc0 R15: 0000000000802000
  </TASK>

  Allocated by task 515:
  kasan_save_stack+0x38/0x70 linux/mm/kasan/common.c:45
  kasan_set_track+0x25/0x40 linux/mm/kasan/common.c:52
  kasan_save_alloc_info+0x1e/0x40 linux/mm/kasan/generic.c:510
  ____kasan_kmalloc linux/mm/kasan/common.c:374
  __kasan_kmalloc+0xc3/0xd0 linux/mm/kasan/common.c:383
  kasan_kmalloc linux/./include/linux/kasan.h:196
  kmalloc_trace+0x48/0xc0 linux/mm/slab_common.c:1066
  kmalloc linux/./include/linux/slab.h:580
  kzalloc linux/./include/linux/slab.h:720
  qxl_bo_create+0x11a/0x610 linux/drivers/gpu/drm/qxl/qxl_object.c:124
  qxl_gem_object_create+0xd9/0x360 linux/drivers/gpu/drm/qxl/qxl_gem.c:58
  qxl_gem_object_create_with_handle+0xa1/0x180 linux/drivers/gpu/drm/qxl/qxl_gem.c:89
  qxl_mode_dumb_create+0x1cd/0x400 linux/drivers/gpu/drm/qxl/qxl_dumb.c:63
  drm_mode_create_dumb linux/drivers/gpu/drm/drm_dumb_buffers.c:96
  drm_mode_create_dumb_ioctl+0x1f5/0x2d0 linux/drivers/gpu/drm/drm_dumb_buffers.c:102
  drm_ioctl_kernel+0x21d/0x430 linux/drivers/gpu/drm/drm_ioctl.c:788
  drm_ioctl+0x56f/0xcc0 linux/drivers/gpu/drm/drm_ioctl.c:891
  vfs_ioctl linux/fs/ioctl.c:51
  __do_sys_ioctl linux/fs/ioctl.c:870
  __se_sys_ioctl linux/fs/ioctl.c:856
  __x64_sys_ioctl+0x13d/0x1c0 linux/fs/ioctl.c:856
  do_syscall_x64 linux/arch/x86/entry/common.c:50
  do_syscall_64+0x5b/0x90 linux/arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x72/0xdc linux/arch/x86/entry/entry_64.S:120

  Freed by task 515:
  kasan_save_stack+0x38/0x70 linux/mm/kasan/common.c:45
  kasan_set_track+0x25/0x40 linux/mm/kasan/common.c:52
  kasan_save_free_info+0x2e/0x60 linux/mm/kasan/generic.c:521
  ____kasan_slab_free linux/mm/kasan/common.c:236
  ____kasan_slab_free+0x180/0x1f0 linux/mm/kasan/common.c:200
  __kasan_slab_free+0x12/0x30 linux/mm/kasan/common.c:244
  kasan_slab_free linux/./include/linux/kasan.h:162
  slab_free_hook linux/mm/slub.c:1781
  slab_free_freelist_hook+0xd2/0x1a0 linux/mm/slub.c:1807
  slab_free linux/mm/slub.c:3787
  __kmem_cache_free+0x196/0x2d0 linux/mm/slub.c:3800
  kfree+0x78/0x120 linux/mm/slab_common.c:1019
  qxl_ttm_bo_destroy+0x140/0x1a0 linux/drivers/gpu/drm/qxl/qxl_object.c:49
  ttm_bo_release+0x678/0xa30 linux/drivers/gpu/drm/ttm/ttm_bo.c:381
  kref_put linux/./include/linux/kref.h:65
  ttm_bo_put+0x50/0x80 linux/drivers/gpu/drm/ttm/ttm_bo.c:393
  qxl_gem_object_free+0x3e/0x60 linux/drivers/gpu/drm/qxl/qxl_gem.c:42
  drm_gem_object_free+0x5c/0x90 linux/drivers/gpu/drm/drm_gem.c:974
  kref_put linux/./include/linux/kref.h:65
  __drm_gem_object_put linux/./include/drm/drm_gem.h:431
  drm_gem_object_put linux/./include/drm/drm_gem.h:444
  qxl_gem_object_create_with_handle+0x151/0x180 linux/drivers/gpu/drm/qxl/qxl_gem.c:100
  qxl_mode_dumb_create+0x1cd/0x400 linux/drivers/gpu/drm/qxl/qxl_dumb.c:63
  drm_mode_create_dumb linux/drivers/gpu/drm/drm_dumb_buffers.c:96
  drm_mode_create_dumb_ioctl+0x1f5/0x2d0 linux/drivers/gpu/drm/drm_dumb_buffers.c:102
  drm_ioctl_kernel+0x21d/0x430 linux/drivers/gpu/drm/drm_ioctl.c:788
  drm_ioctl+0x56f/0xcc0 linux/drivers/gpu/drm/drm_ioctl.c:891
  vfs_ioctl linux/fs/ioctl.c:51
  __do_sys_ioctl linux/fs/ioctl.c:870
  __se_sys_ioctl linux/fs/ioctl.c:856
  __x64_sys_ioctl+0x13d/0x1c0 linux/fs/ioctl.c:856
  do_syscall_x64 linux/arch/x86/entry/common.c:50
  do_syscall_64+0x5b/0x90 linux/arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x72/0xdc linux/arch/x86/entry/entry_64.S:120

  The buggy address belongs to the object at ffff88801136c000
  which belongs to the cache kmalloc-1k of size 1024
  The buggy address is located 576 bytes inside of
  freed 1024-byte region [ffff88801136c000, ffff88801136c400)

  The buggy address belongs to the physical page:
  page:0000000089fc329b refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x11368
  head:0000000089fc329b order:3 entire_mapcount:0 nr_pages_mapped:0 pincount:0
  flags: 0xfffffc0010200(slab|head|node=0|zone=1|lastcpupid=0x1fffff)
  raw: 000fffffc0010200 ffff888007841dc0 dead000000000122 0000000000000000
  raw: 0000000000000000 0000000080100010 00000001ffffffff 0000000000000000
  page dumped because: kasan: bad access detected

  Memory state around the buggy address:
  ffff88801136c100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
  ffff88801136c180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
  >ffff88801136c200: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
  ^
  ffff88801136c280: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
  ffff88801136c300: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
  ==================================================================
  Disabling lock debugging due to kernel taint

  Instead of returning a weak reference to the qxl_bo object, return the
  created drm_gem_object and let the caller decrement the reference count
  when it no longer needs it. As a convenience, if the caller is not
  interested in the gobj object, it can pass NULL to the parameter and the
  reference counting is descremented internally.

  The bug and the reproducer were originally found by the Zero Day Initiative project (ZDI-CAN-20940).

  Link: https://www.zerodayinitiative.com/
  Signed-off-by: Wander Lairson Costa <wander@redhat.com>
  Cc: stable@vger.kernel.org
  Reviewed-by: Dave Airlie <airlied@redhat.com>
  Signed-off-by: Dave Airlie <airlied@redhat.com>
  Link: https://patchwork.freedesktop.org/patch/msgid/20230814165119.90847-1-wander@redhat.com
  [pchelkin: The problem can be reproduced on 5.10 stable. It lacks commit
   f4a84e165e6d ("drm/qxl: allocate dumb buffers in ram"). Adjust a small
   conflict regarding that commit: it affects only where the buffers are
   placed.]
- Ipv6: remove max_size check inline with ipv4. [Jon Maxwell]

  commit af6d10345ca76670c1b7c37799f0d5576ccef277 upstream.

  In ip6_dst_gc() replace:

    if (entries > gc_thresh)

  With:

    if (entries > ops->gc_thresh)

  Sending Ipv6 packets in a loop via a raw socket triggers an issue where a
  route is cloned by ip6_rt_cache_alloc() for each packet sent. This quickly
  consumes the Ipv6 max_size threshold which defaults to 4096 resulting in
  these warnings:

  [1]   99.187805] dst_alloc: 7728 callbacks suppressed
  [2] Route cache is full: consider increasing sysctl net.ipv6.route.max_size.
  .
  .
  [300] Route cache is full: consider increasing sysctl net.ipv6.route.max_size.

  When this happens the packet is dropped and sendto() gets a network is
  unreachable error:

  remaining pkt 200557 errno 101
  remaining pkt 196462 errno 101
  .
  .
  remaining pkt 126821 errno 101

  Implement David Aherns suggestion to remove max_size check seeing that Ipv6
  has a GC to manage memory usage. Ipv4 already does not check max_size.

  Here are some memory comparisons for Ipv4 vs Ipv6 with the patch:

  Test by running 5 instances of a program that sends UDP packets to a raw
  socket 5000000 times. Compare Ipv4 and Ipv6 performance with a similar
  program.

  Ipv4:

  Before test:

  MemFree:        29427108 kB
  Slab:             237612 kB

  ip6_dst_cache       1912   2528    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache        2881   3990    192   42    2 : tunables    0    0    0

  During test:

  MemFree:        29417608 kB
  Slab:             247712 kB

  ip6_dst_cache       1912   2528    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache       44394  44394    192   42    2 : tunables    0    0    0

  After test:

  MemFree:        29422308 kB
  Slab:             238104 kB

  ip6_dst_cache       1912   2528    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache        3048   4116    192   42    2 : tunables    0    0    0

  Ipv6 with patch:

  Errno 101 errors are not observed anymore with the patch.

  Before test:

  MemFree:        29422308 kB
  Slab:             238104 kB

  ip6_dst_cache       1912   2528    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache        3048   4116    192   42    2 : tunables    0    0    0

  During Test:

  MemFree:        29431516 kB
  Slab:             240940 kB

  ip6_dst_cache      11980  12064    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache        3048   4116    192   42    2 : tunables    0    0    0

  After Test:

  MemFree:        29441816 kB
  Slab:             238132 kB

  ip6_dst_cache       1902   2432    256   32    2 : tunables    0    0    0
  xfrm_dst_cache         0      0    320   25    2 : tunables    0    0    0
  ip_dst_cache        3048   4116    192   42    2 : tunables    0    0    0
- Net: tls, update curr on splice as well. [John Fastabend]

  commit c5a595000e2677e865a39f249c056bc05d6e55fd upstream.

  The curr pointer must also be updated on the splice similar to how
  we do this for other copy types.
- Powerpc: update ppc_save_regs to save current r1 in pt_regs. [Aditya
  Gupta]

  commit b684c09f09e7a6af3794d4233ef785819e72db79 upstream.

  ppc_save_regs() skips one stack frame while saving the CPU register states.
  Instead of saving current R1, it pulls the previous stack frame pointer.

  When vmcores caused by direct panic call (such as `echo c >
  /proc/sysrq-trigger`), are debugged with gdb, gdb fails to show the
  backtrace correctly. On further analysis, it was found that it was because
  of mismatch between r1 and NIP.

  GDB uses NIP to get current function symbol and uses corresponding debug
  info of that function to unwind previous frames, but due to the
  mismatching r1 and NIP, the unwinding does not work, and it fails to
  unwind to the 2nd frame and hence does not show the backtrace.

  GDB backtrace with vmcore of kernel without this patch:

  ---------
  (gdb) bt
   #0  0xc0000000002a53e8 in crash_setup_regs (oldregs=<optimized out>,
      newregs=0xc000000004f8f8d8) at ./arch/powerpc/include/asm/kexec.h:69
   #1  __crash_kexec (regs=<optimized out>) at kernel/kexec_core.c:974
   #2  0x0000000000000063 in ?? ()
   #3  0xc000000003579320 in ?? ()
  ---------

  Further analysis revealed that the mismatch occurred because
  "ppc_save_regs" was saving the previous stack's SP instead of the current
  r1. This patch fixes this by storing current r1 in the saved pt_regs.

  GDB backtrace with vmcore of patched kernel:

  --------
  (gdb) bt
   #0  0xc0000000002a53e8 in crash_setup_regs (oldregs=0x0, newregs=0xc00000000670b8d8)
      at ./arch/powerpc/include/asm/kexec.h:69
   #1  __crash_kexec (regs=regs@entry=0x0) at kernel/kexec_core.c:974
   #2  0xc000000000168918 in panic (fmt=fmt@entry=0xc000000001654a60 "sysrq triggered crash\n")
      at kernel/panic.c:358
   #3  0xc000000000b735f8 in sysrq_handle_crash (key=<optimized out>) at drivers/tty/sysrq.c:155
   #4  0xc000000000b742cc in __handle_sysrq (key=key@entry=99, check_mask=check_mask@entry=false)
      at drivers/tty/sysrq.c:602
   #5  0xc000000000b7506c in write_sysrq_trigger (file=<optimized out>, buf=<optimized out>,
      count=2, ppos=<optimized out>) at drivers/tty/sysrq.c:1163
   #6  0xc00000000069a7bc in pde_write (ppos=<optimized out>, count=<optimized out>,
      buf=<optimized out>, file=<optimized out>, pde=0xc00000000362cb40) at fs/proc/inode.c:340
   #7  proc_reg_write (file=<optimized out>, buf=<optimized out>, count=<optimized out>,
      ppos=<optimized out>) at fs/proc/inode.c:352
   #8  0xc0000000005b3bbc in vfs_write (file=file@entry=0xc000000006aa6b00,
      buf=buf@entry=0x61f498b4f60 <error: Cannot access memory at address 0x61f498b4f60>,
      count=count@entry=2, pos=pos@entry=0xc00000000670bda0) at fs/read_write.c:582
   #9  0xc0000000005b4264 in ksys_write (fd=<optimized out>,
      buf=0x61f498b4f60 <error: Cannot access memory at address 0x61f498b4f60>, count=2)
      at fs/read_write.c:637
   #10 0xc00000000002ea2c in system_call_exception (regs=0xc00000000670be80, r0=<optimized out>)
      at arch/powerpc/kernel/syscall.c:171
   #11 0xc00000000000c270 in system_call_vectored_common ()
      at arch/powerpc/kernel/interrupt_64.S:192
  --------

  Nick adds:
    So this now saves regs as though it was an interrupt taken in the
    caller, at the instruction after the call to ppc_save_regs, whereas
    previously the NIP was there, but R1 came from the caller's caller and
    that mismatch is what causes gdb's dwarf unwinder to go haywire.
- Mmc: sdhci-sprd: Fix eMMC init failure after hw reset. [Wenchao Chen]

  commit 8abf77c88929b6d20fa4f9928b18d6448d64e293 upstream.

  Some eMMC devices that do not close the auto clk gate after hw reset will
  cause eMMC initialization to fail. Let's fix this.
- Mmc: core: Cancel delayed work before releasing host. [Geert
  Uytterhoeven]

  commit 1036f69e251380573e256568cf814506e3fb9988 upstream.

  On RZ/Five SMARC EVK, where probing of SDHI is deferred due to probe
  deferral of the vqmmc-supply regulator:

      ------------[ cut here ]------------
      WARNING: CPU: 0 PID: 0 at kernel/time/timer.c:1738 __run_timers.part.0+0x1d0/0x1e8
      Modules linked in:
      CPU: 0 PID: 0 Comm: swapper Not tainted 6.7.0-rc4 #101
      Hardware name: Renesas SMARC EVK based on r9a07g043f01 (DT)
      epc : __run_timers.part.0+0x1d0/0x1e8
       ra : __run_timers.part.0+0x134/0x1e8
      epc : ffffffff800771a4 ra : ffffffff80077108 sp : ffffffc800003e60
       gp : ffffffff814f5028 tp : ffffffff8140c5c0 t0 : ffffffc800000000
       t1 : 0000000000000001 t2 : ffffffff81201300 s0 : ffffffc800003f20
       s1 : ffffffd8023bc4a0 a0 : 00000000fffee6b0 a1 : 0004010000400000
       a2 : ffffffffc0000016 a3 : ffffffff81488640 a4 : ffffffc800003e60
       a5 : 0000000000000000 a6 : 0000000004000000 a7 : ffffffc800003e68
       s2 : 0000000000000122 s3 : 0000000000200000 s4 : 0000000000000000
       s5 : ffffffffffffffff s6 : ffffffff81488678 s7 : ffffffff814886c0
       s8 : ffffffff814f49c0 s9 : ffffffff81488640 s10: 0000000000000000
       s11: ffffffc800003e60 t3 : 0000000000000240 t4 : 0000000000000a52
       t5 : ffffffd8024ae018 t6 : ffffffd8024ae038
      status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000003
      [<ffffffff800771a4>] __run_timers.part.0+0x1d0/0x1e8
      [<ffffffff800771e0>] run_timer_softirq+0x24/0x4a
      [<ffffffff80809092>] __do_softirq+0xc6/0x1fa
      [<ffffffff80028e4c>] irq_exit_rcu+0x66/0x84
      [<ffffffff80800f7a>] handle_riscv_irq+0x40/0x4e
      [<ffffffff80808f48>] call_on_irq_stack+0x1c/0x28
      ---[ end trace 0000000000000000 ]---

  What happens?

      renesas_sdhi_probe()
      {
      	tmio_mmc_host_alloc()
  	    mmc_alloc_host()
  		INIT_DELAYED_WORK(&host->detect, mmc_rescan);

  	devm_request_irq(tmio_mmc_irq);

  	/*
  	 * After this, the interrupt handler may be invoked at any time
  	 *
  	 *  tmio_mmc_irq()
  	 *  {
  	 *	__tmio_mmc_card_detect_irq()
  	 *	    mmc_detect_change()
  	 *		_mmc_detect_change()
  	 *		    mmc_schedule_delayed_work(&host->detect, delay);
  	 *  }
  	 */

  	tmio_mmc_host_probe()
  	    tmio_mmc_init_ocr()
  		-EPROBE_DEFER

  	tmio_mmc_host_free()
  	    mmc_free_host()
      }

  When expire_timers() runs later, it warns because the MMC host structure
  containing the delayed work was freed, and now contains an invalid work
  function pointer.

  Fix this by cancelling any pending delayed work before releasing the
  MMC host structure.
- Mmc: rpmb: fixes pause retune on all RPMB partitions. [Jorge Ramirez-
  Ortiz]

  commit e7794c14fd73e5eb4a3e0ecaa5334d5a17377c50 upstream.

  When RPMB was converted to a character device, it added support for
  multiple RPMB partitions (Commit 97548575bef3 ("mmc: block: Convert RPMB to
  a character device").

  One of the changes in this commit was transforming the variable target_part
  defined in __mmc_blk_ioctl_cmd into a bitmask. This inadvertently regressed
  the validation check done in mmc_blk_part_switch_pre() and
  mmc_blk_part_switch_post(), so let's fix it.
- Mmc: meson-mx-sdhc: Fix initialization frozen issue. [Ziyang Huang]

  commit 8c124d998ea0c9022e247b11ac51f86ec8afa0e1 upstream.

  Commit 4bc31edebde5 ("mmc: core: Set HS clock speed before sending
  HS CMD13") set HS clock (52MHz) before switching to HS mode. For this
  freq, FCLK_DIV5 will be selected and div value is 10 (reg value is 9).
  Then we set rx_clk_phase to 11 or 15 which is out of range and make
  hardware frozen. After we send command request, no irq will be
  interrupted and the mmc driver will keep to wait for request finished,
  even durning rebooting.

  So let's set it to Phase 90 which should work in most cases. Then let
  meson_mx_sdhc_execute_tuning() to find the accurate value for data
  transfer.

  If this doesn't work, maybe need to define a factor in dts.
- Mm: fix unmap_mapping_range high bits shift bug. [Jiajun Xie]

  commit 9eab0421fa94a3dde0d1f7e36ab3294fc306c99d upstream.

  The bug happens when highest bit of holebegin is 1, suppose holebegin is
  0x8000000111111000, after shift, hba would be 0xfff8000000111111, then
  vma_interval_tree_foreach would look it up fail or leads to the wrong
  result.

  error call seq e.g.:
  - mmap(..., offset=0x8000000111111000)
    |- syscall(mmap, ... unsigned long, off):
       |- ksys_mmap_pgoff( ... , off >> PAGE_SHIFT);

    here pgoff is correctly shifted to 0x8000000111111,
    but pass 0x8000000111111000 as holebegin to unmap
    would then cause terrible result, as shown below:

  - unmap_mapping_range(..., loff_t const holebegin)
    |- pgoff_t hba = holebegin >> PAGE_SHIFT;
            /* hba = 0xfff8000000111111 unexpectedly */

  The issue happens in Heterogeneous computing, where the device(e.g.
  gpu) and host share the same virtual address space.

  A simple workflow pattern which hit the issue is:
          /* host */
      1. userspace first mmap a file backed VA range with specified offset.
                          e.g. (offset=0x800..., mmap return: va_a)
      2. write some data to the corresponding sys page
                           e.g. (va_a = 0xAABB)
          /* device */
      3. gpu workload touches VA, triggers gpu fault and notify the host.
          /* host */
      4. reviced gpu fault notification, then it will:
              4.1 unmap host pages and also takes care of cpu tlb
                    (use unmap_mapping_range with offset=0x800...)
              4.2 migrate sys page to device
              4.3 setup device page table and resolve device fault.
          /* device */
      5. gpu workload continued, it accessed va_a and got 0xAABB.
      6. gpu workload continued, it wrote 0xBBCC to va_a.
          /* host */
      7. userspace access va_a, as expected, it will:
              7.1 trigger cpu vm fault.
              7.2 driver handling fault to migrate gpu local page to host.
      8. userspace then could correctly get 0xBBCC from va_a
      9. done

  But in step 4.1, if we hit the bug this patch mentioned, then userspace
  would never trigger cpu fault, and still get the old value: 0xAABB.

  Making holebegin unsigned first fixes the bug.
- I2c: core: Fix atomic xfer check for non-preempt config. [Benjamin
  Bara]

  commit a3368e1186e3ce8e38f78cbca019622095b1f331 upstream.

  Since commit aa49c90894d0 ("i2c: core: Run atomic i2c xfer when
  !preemptible"), the whole reboot/power off sequence on non-preempt kernels
  is using atomic i2c xfer, as !preemptible() always results to 1.

  During device_shutdown(), the i2c might be used a lot and not all busses
  have implemented an atomic xfer handler. This results in a lot of
  avoidable noise, like:

  [   12.687169] No atomic I2C transfer handler for 'i2c-0'
  [   12.692313] WARNING: CPU: 6 PID: 275 at drivers/i2c/i2c-core.h:40 i2c_smbus_xfer+0x100/0x118
  ...

  Fix this by allowing non-atomic xfer when the interrupts are enabled, as
  it was before.

  Link: https://lore.kernel.org/r/20231222230106.73f030a5@yea
  Link: https://lore.kernel.org/r/20240102150350.3180741-1-mwalle@kernel.org
  Link: https://lore.kernel.org/linux-i2c/13271b9b-4132-46ef-abf8-2c311967bb46@mailbox.org/
  Fixes: aa49c90894d0 ("i2c: core: Run atomic i2c xfer when !preemptible")
  Cc: stable@vger.kernel.org # v5.2+
  Signed-off-by: Benjamin Bara <benjamin.bara@skidata.com>
  Tested-by: Michael Walle <mwalle@kernel.org>
  Tested-by: Tor Vic <torvic9@mailbox.org>
  [wsa: removed a comment which needs more work, code is ok]
- X86/kprobes: fix incorrect return address calculation in
  kprobe_emulate_call_indirect. [Jinghao Jia]

  commit f5d03da48d062966c94f0199d20be0b3a37a7982 upstream.

  kprobe_emulate_call_indirect currently uses int3_emulate_call to emulate
  indirect calls. However, int3_emulate_call always assumes the size of
  the call to be 5 bytes when calculating the return address. This is
  incorrect for register-based indirect calls in x86, which can be either
  2 or 3 bytes depending on whether REX prefix is used. At kprobe runtime,
  the incorrect return address causes control flow to land onto the wrong
  place after return -- possibly not a valid instruction boundary. This
  can lead to a panic like the following:

  [    7.308204][    C1] BUG: unable to handle page fault for address: 000000000002b4d8
  [    7.308883][    C1] #PF: supervisor read access in kernel mode
  [    7.309168][    C1] #PF: error_code(0x0000) - not-present page
  [    7.309461][    C1] PGD 0 P4D 0
  [    7.309652][    C1] Oops: 0000 [#1] SMP
  [    7.309929][    C1] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 6.7.0-rc5-trace-for-next #6
  [    7.310397][    C1] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.0-20220807_005459-localhost 04/01/2014
  [    7.311068][    C1] RIP: 0010:__common_interrupt+0x52/0xc0
  [    7.311349][    C1] Code: 01 00 4d 85 f6 74 39 49 81 fe 00 f0 ff ff 77 30 4c 89 f7 4d 8b 5e 68 41 ba 91 76 d8 42 45 03 53 fc 74 02 0f 0b cc ff d3 65 48 <8b> 05 30 c7 ff 7e 65 4c 89 3d 28 c7 ff 7e 5b 41 5c 41 5e 41 5f c3
  [    7.312512][    C1] RSP: 0018:ffffc900000e0fd0 EFLAGS: 00010046
  [    7.312899][    C1] RAX: 0000000000000001 RBX: 0000000000000023 RCX: 0000000000000001
  [    7.313334][    C1] RDX: 00000000000003cd RSI: 0000000000000001 RDI: ffff888100d302a4
  [    7.313702][    C1] RBP: 0000000000000001 R08: 0ef439818636191f R09: b1621ff338a3b482
  [    7.314146][    C1] R10: ffffffff81e5127b R11: ffffffff81059810 R12: 0000000000000023
  [    7.314509][    C1] R13: 0000000000000000 R14: ffff888100d30200 R15: 0000000000000000
  [    7.314951][    C1] FS:  0000000000000000(0000) GS:ffff88813bc80000(0000) knlGS:0000000000000000
  [    7.315396][    C1] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [    7.315691][    C1] CR2: 000000000002b4d8 CR3: 0000000003028003 CR4: 0000000000370ef0
  [    7.316153][    C1] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  [    7.316508][    C1] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  [    7.316948][    C1] Call Trace:
  [    7.317123][    C1]  <IRQ>
  [    7.317279][    C1]  ? __die_body+0x64/0xb0
  [    7.317482][    C1]  ? page_fault_oops+0x248/0x370
  [    7.317712][    C1]  ? __wake_up+0x96/0xb0
  [    7.317964][    C1]  ? exc_page_fault+0x62/0x130
  [    7.318211][    C1]  ? asm_exc_page_fault+0x22/0x30
  [    7.318444][    C1]  ? __cfi_native_send_call_func_single_ipi+0x10/0x10
  [    7.318860][    C1]  ? default_idle+0xb/0x10
  [    7.319063][    C1]  ? __common_interrupt+0x52/0xc0
  [    7.319330][    C1]  common_interrupt+0x78/0x90
  [    7.319546][    C1]  </IRQ>
  [    7.319679][    C1]  <TASK>
  [    7.319854][    C1]  asm_common_interrupt+0x22/0x40
  [    7.320082][    C1] RIP: 0010:default_idle+0xb/0x10
  [    7.320309][    C1] Code: 4c 01 c7 4c 29 c2 e9 72 ff ff ff cc cc cc cc 90 90 90 90 90 90 90 90 90 90 90 b8 0c 67 40 a5 66 90 0f 00 2d 09 b9 3b 00 fb f4 <fa> c3 0f 1f 00 90 90 90 90 90 90 90 90 90 90 90 b8 0c 67 40 a5 e9
  [    7.321449][    C1] RSP: 0018:ffffc9000009bee8 EFLAGS: 00000256
  [    7.321808][    C1] RAX: ffff88813bca8b68 RBX: 0000000000000001 RCX: 000000000001ef0c
  [    7.322227][    C1] RDX: 0000000000000000 RSI: 0000000000000001 RDI: 000000000001ef0c
  [    7.322656][    C1] RBP: ffffc9000009bef8 R08: 8000000000000000 R09: 00000000000008c2
  [    7.323083][    C1] R10: 0000000000000000 R11: ffffffff81058e70 R12: 0000000000000000
  [    7.323530][    C1] R13: ffff8881002b30c0 R14: 0000000000000000 R15: 0000000000000000
  [    7.323948][    C1]  ? __cfi_lapic_next_deadline+0x10/0x10
  [    7.324239][    C1]  default_idle_call+0x31/0x50
  [    7.324464][    C1]  do_idle+0xd3/0x240
  [    7.324690][    C1]  cpu_startup_entry+0x25/0x30
  [    7.324983][    C1]  start_secondary+0xb4/0xc0
  [    7.325217][    C1]  secondary_startup_64_no_verify+0x179/0x17b
  [    7.325498][    C1]  </TASK>
  [    7.325641][    C1] Modules linked in:
  [    7.325906][    C1] CR2: 000000000002b4d8
  [    7.326104][    C1] ---[ end trace 0000000000000000 ]---
  [    7.326354][    C1] RIP: 0010:__common_interrupt+0x52/0xc0
  [    7.326614][    C1] Code: 01 00 4d 85 f6 74 39 49 81 fe 00 f0 ff ff 77 30 4c 89 f7 4d 8b 5e 68 41 ba 91 76 d8 42 45 03 53 fc 74 02 0f 0b cc ff d3 65 48 <8b> 05 30 c7 ff 7e 65 4c 89 3d 28 c7 ff 7e 5b 41 5c 41 5e 41 5f c3
  [    7.327570][    C1] RSP: 0018:ffffc900000e0fd0 EFLAGS: 00010046
  [    7.327910][    C1] RAX: 0000000000000001 RBX: 0000000000000023 RCX: 0000000000000001
  [    7.328273][    C1] RDX: 00000000000003cd RSI: 0000000000000001 RDI: ffff888100d302a4
  [    7.328632][    C1] RBP: 0000000000000001 R08: 0ef439818636191f R09: b1621ff338a3b482
  [    7.329223][    C1] R10: ffffffff81e5127b R11: ffffffff81059810 R12: 0000000000000023
  [    7.329780][    C1] R13: 0000000000000000 R14: ffff888100d30200 R15: 0000000000000000
  [    7.330193][    C1] FS:  0000000000000000(0000) GS:ffff88813bc80000(0000) knlGS:0000000000000000
  [    7.330632][    C1] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [    7.331050][    C1] CR2: 000000000002b4d8 CR3: 0000000003028003 CR4: 0000000000370ef0
  [    7.331454][    C1] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  [    7.331854][    C1] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  [    7.332236][    C1] Kernel panic - not syncing: Fatal exception in interrupt
  [    7.332730][    C1] Kernel Offset: disabled
  [    7.333044][    C1] ---[ end Kernel panic - not syncing: Fatal exception in interrupt ]---

  The relevant assembly code is (from objdump, faulting address
  highlighted):

  ffffffff8102ed9d:       41 ff d3                  call   *%r11
  ffffffff8102eda0:       65 48 <8b> 05 30 c7 ff    mov    %gs:0x7effc730(%rip),%rax

  The emulation incorrectly sets the return address to be ffffffff8102ed9d
  + 0x5 = ffffffff8102eda2, which is the 8b byte in the middle of the next
  mov. This in turn causes incorrect subsequent instruction decoding and
  eventually triggers the page fault above.

  Instead of invoking int3_emulate_call, perform push and jmp emulation
  directly in kprobe_emulate_call_indirect. At this point we can obtain
  the instruction size from p->ainsn.size so that we can calculate the
  correct return address.
- Firewire: ohci: suppress unexpected system reboot in AMD Ryzen
  machines and ASM108x/VT630x PCIe cards. [Takashi Sakamoto]

  commit ac9184fbb8478dab4a0724b279f94956b69be827 upstream.

  VIA VT6306/6307/6308 provides PCI interface compliant to 1394 OHCI. When
  the hardware is combined with Asmedia ASM1083/1085 PCIe-to-PCI bus bridge,
  it appears that accesses to its 'Isochronous Cycle Timer' register (offset
  0xf0 on PCI memory space) often causes unexpected system reboot in any
  type of AMD Ryzen machine (both 0x17 and 0x19 families). It does not
  appears in the other type of machine (AMD pre-Ryzen machine, Intel
  machine, at least), or in the other OHCI 1394 hardware (e.g. Texas
  Instruments).

  The issue explicitly appears at a commit dcadfd7f7c74 ("firewire: core:
  use union for callback of transaction completion") added to v6.5 kernel.
  It changed 1394 OHCI driver to access to the register every time to
  dispatch local asynchronous transaction. However, the issue exists in
  older version of kernel as long as it runs in AMD Ryzen machine, since
  the access to the register is required to maintain bus time. It is not
  hard to imagine that users experience the unexpected system reboot when
  generating bus reset by plugging any devices in, or reading the register
  by time-aware application programs; e.g. audio sample processing.

  This commit suppresses the unexpected system reboot in the combination of
  hardware. It avoids the access itself. As a result, the software stack can
  not provide the hardware time anymore to unit drivers, userspace
  applications, and nodes in the same IEEE 1394 bus. It brings apparent
  disadvantage since time-aware application programs require it, while
  time-unaware applications are available again; e.g. sbp2.
- Mm/memory-failure: check the mapcount of the precise page. [Matthew
  Wilcox (Oracle)]

  [ Upstream commit c79c5a0a00a9457718056b588f312baadf44e471 ]

  A process may map only some of the pages in a folio, and might be missed
  if it maps the poisoned page but not the head page.  Or it might be
  unnecessarily hit if it maps the head page, but not the poisoned page.
- Net: Implement missing SO_TIMESTAMPING_NEW cmsg support. [Thomas
  Lange]

  [ Upstream commit 382a32018b74f407008615e0e831d05ed28e81cd ]

  Commit 9718475e6908 ("socket: Add SO_TIMESTAMPING_NEW") added the new
  socket option SO_TIMESTAMPING_NEW. However, it was never implemented in
  __sock_cmsg_send thus breaking SO_TIMESTAMPING cmsg for platforms using
  SO_TIMESTAMPING_NEW.
- Bnxt_en: Remove mis-applied code from bnxt_cfg_ntp_filters() [Michael
  Chan]

  [ Upstream commit e009b2efb7a8850498796b360043ac25c8d3d28f ]

  The 2 lines to check for the BNXT_HWRM_PF_UNLOAD_SP_EVENT bit was
  mis-applied to bnxt_cfg_ntp_filters() and should have been applied to
  bnxt_sp_task().
- Asix: Add check for usbnet_get_endpoints. [Chen Ni]

  [ Upstream commit eaac6a2d26b65511e164772bec6918fcbc61938e ]

  Add check for usbnet_get_endpoints() and return the error if it fails
  in order to transfer the error.
- Net/qla3xxx: fix potential memleak in ql_alloc_buffer_queues. [Dinghao
  Liu]

  [ Upstream commit 89f45c30172c80e55c887f32f1af8e184124577b ]

  When dma_alloc_coherent() fails, we should free qdev->lrg_buf
  to prevent potential memleak.
- Net/qla3xxx: switch from 'pci_' to 'dma_' API. [Christophe JAILLET]

  [ Upstream commit 41fb4c1ba7478fe34c7e094e124e4ee4513b9763 ]

  The wrappers in include/linux/pci-dma-compat.h should go away.

  The patch has been generated with the coccinelle script below and has been
  hand modified to replace GFP_ with a correct flag.
  It has been compile tested.

  When memory is allocated in 'ql_alloc_net_req_rsp_queues()' GFP_KERNEL can
  be used because it is only called from 'ql_alloc_mem_resources()' which
  already calls 'ql_alloc_buffer_queues()' which uses GFP_KERNEL. (see below)

  When memory is allocated in 'ql_alloc_buffer_queues()' GFP_KERNEL can be
  used because this flag is already used just a few line above.

  When memory is allocated in 'ql_alloc_small_buffers()' GFP_KERNEL can
  be used because it is only called from 'ql_alloc_mem_resources()' which
  already calls 'ql_alloc_buffer_queues()' which uses GFP_KERNEL. (see above)

  When memory is allocated in 'ql_alloc_mem_resources()' GFP_KERNEL can be
  used because this function already calls 'ql_alloc_buffer_queues()' which
  uses GFP_KERNEL. (see above)

  While at it, use 'dma_set_mask_and_coherent()' instead of 'dma_set_mask()/
  dma_set_coherent_mask()' in order to slightly simplify code.

  @@
  @@
  -    PCI_DMA_BIDIRECTIONAL
  +    DMA_BIDIRECTIONAL

  @@
  @@
  -    PCI_DMA_TODEVICE
  +    DMA_TO_DEVICE

  @@
  @@
  -    PCI_DMA_FROMDEVICE
  +    DMA_FROM_DEVICE

  @@
  @@
  -    PCI_DMA_NONE
  +    DMA_NONE

  @@
  expression e1, e2, e3;
  @@
  -    pci_alloc_consistent(e1, e2, e3)
  +    dma_alloc_coherent(&e1->dev, e2, e3, GFP_)

  @@
  expression e1, e2, e3;
  @@
  -    pci_zalloc_consistent(e1, e2, e3)
  +    dma_alloc_coherent(&e1->dev, e2, e3, GFP_)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_free_consistent(e1, e2, e3, e4)
  +    dma_free_coherent(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_map_single(e1, e2, e3, e4)
  +    dma_map_single(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_unmap_single(e1, e2, e3, e4)
  +    dma_unmap_single(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4, e5;
  @@
  -    pci_map_page(e1, e2, e3, e4, e5)
  +    dma_map_page(&e1->dev, e2, e3, e4, e5)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_unmap_page(e1, e2, e3, e4)
  +    dma_unmap_page(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_map_sg(e1, e2, e3, e4)
  +    dma_map_sg(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_unmap_sg(e1, e2, e3, e4)
  +    dma_unmap_sg(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_dma_sync_single_for_cpu(e1, e2, e3, e4)
  +    dma_sync_single_for_cpu(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_dma_sync_single_for_device(e1, e2, e3, e4)
  +    dma_sync_single_for_device(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_dma_sync_sg_for_cpu(e1, e2, e3, e4)
  +    dma_sync_sg_for_cpu(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2, e3, e4;
  @@
  -    pci_dma_sync_sg_for_device(e1, e2, e3, e4)
  +    dma_sync_sg_for_device(&e1->dev, e2, e3, e4)

  @@
  expression e1, e2;
  @@
  -    pci_dma_mapping_error(e1, e2)
  +    dma_mapping_error(&e1->dev, e2)

  @@
  expression e1, e2;
  @@
  -    pci_set_dma_mask(e1, e2)
  +    dma_set_mask(&e1->dev, e2)

  @@
  expression e1, e2;
  @@
  -    pci_set_consistent_dma_mask(e1, e2)
  +    dma_set_coherent_mask(&e1->dev, e2)
- I40e: Restore VF MSI-X state during PCI reset. [Andrii Staikov]

  [ Upstream commit 371e576ff3e8580d91d49026e5d5faebf5565558 ]

  During a PCI FLR the MSI-X Enable flag in the VF PCI MSI-X capability
  register will be cleared. This can lead to issues when a VF is
  assigned to a VM because in these cases the VF driver receives no
  indication of the PF PCI error/reset and additionally it is incapable
  of restoring the cleared flag in the hypervisor configuration space
  without fully reinitializing the driver interrupt functionality.

  Since the VF driver is unable to easily resolve this condition on its own,
  restore the VF MSI-X flag during the PF PCI reset handling.
- ASoC: meson: g12a-tohdmitx: Fix event generation for S/PDIF mux. [Mark
  Brown]

  [ Upstream commit b036d8ef3120b996751495ce25994eea58032a98 ]

  When a control changes value the return value from _put() should be 1 so
  we get events generated to userspace notifying applications of the change.
  While the I2S mux gets this right the S/PDIF mux does not, fix the return
  value.
- ASoC: meson: g12a-toacodec: Fix event generation. [Mark Brown]

  [ Upstream commit 172c88244b5f2d3375403ebb504d407be0fded59 ]

  When a control changes value the return value from _put() should be 1 so
  we get events generated to userspace notifying applications of the change.
  We are checking if there has been a change and exiting early if not but we
  are not providing the correct return value in the latter case, fix this.
- ASoC: meson: g12a-tohdmitx: Validate written enum values. [Mark Brown]

  [ Upstream commit 1e001206804be3f3d21f4a1cf16e5d059d75643f ]

  When writing to an enum we need to verify that the value written is valid
  for the enumeration, the helper function snd_soc_item_enum_to_val() doesn't
  do it since it needs to return an unsigned (and in any case we'd need to
  check the return value).
- ASoC: meson: g12a-toacodec: Validate written enum values. [Mark Brown]

  [ Upstream commit 3150b70e944ead909260285dfb5707d0bedcf87b ]

  When writing to an enum we need to verify that the value written is valid
  for the enumeration, the helper function snd_soc_item_enum_to_val() doesn't
  do it since it needs to return an unsigned (and in any case we'd need to
  check the return value).
- I40e: fix use-after-free in i40e_aqc_add_filters() [Ke Xiao]

  [ Upstream commit 6a15584e99db8918b60e507539c7446375dcf366 ]

  Commit 3116f59c12bd ("i40e: fix use-after-free in
  i40e_sync_filters_subtask()") avoided use-after-free issues,
  by increasing refcount during update the VSI filter list to
  the HW. However, it missed the unicast situation.

  When deleting an unicast FDB entry, the i40e driver will release
  the mac_filter, and i40e_service_task will concurrently request
  firmware to add the mac_filter, which will lead to the following
  use-after-free issue.

  Fix again for both netdev->uc and netdev->mc.

  BUG: KASAN: use-after-free in i40e_aqc_add_filters+0x55c/0x5b0 [i40e]
  Read of size 2 at addr ffff888eb3452d60 by task kworker/8:7/6379

  CPU: 8 PID: 6379 Comm: kworker/8:7 Kdump: loaded Tainted: G
  Workqueue: i40e i40e_service_task [i40e]
  Call Trace:
   dump_stack+0x71/0xab
   print_address_description+0x6b/0x290
   kasan_report+0x14a/0x2b0
   i40e_aqc_add_filters+0x55c/0x5b0 [i40e]
   i40e_sync_vsi_filters+0x1676/0x39c0 [i40e]
   i40e_service_task+0x1397/0x2bb0 [i40e]
   process_one_work+0x56a/0x11f0
   worker_thread+0x8f/0xf40
   kthread+0x2a0/0x390
   ret_from_fork+0x1f/0x40

  Allocated by task 21948:
   kasan_kmalloc+0xa6/0xd0
   kmem_cache_alloc_trace+0xdb/0x1c0
   i40e_add_filter+0x11e/0x520 [i40e]
   i40e_addr_sync+0x37/0x60 [i40e]
   __hw_addr_sync_dev+0x1f5/0x2f0
   i40e_set_rx_mode+0x61/0x1e0 [i40e]
   dev_uc_add_excl+0x137/0x190
   i40e_ndo_fdb_add+0x161/0x260 [i40e]
   rtnl_fdb_add+0x567/0x950
   rtnetlink_rcv_msg+0x5db/0x880
   netlink_rcv_skb+0x254/0x380
   netlink_unicast+0x454/0x610
   netlink_sendmsg+0x747/0xb00
   sock_sendmsg+0xe2/0x120
   __sys_sendto+0x1ae/0x290
   __x64_sys_sendto+0xdd/0x1b0
   do_syscall_64+0xa0/0x370
   entry_SYSCALL_64_after_hwframe+0x65/0xca

  Freed by task 21948:
   __kasan_slab_free+0x137/0x190
   kfree+0x8b/0x1b0
   __i40e_del_filter+0x116/0x1e0 [i40e]
   i40e_del_mac_filter+0x16c/0x300 [i40e]
   i40e_addr_unsync+0x134/0x1b0 [i40e]
   __hw_addr_sync_dev+0xff/0x2f0
   i40e_set_rx_mode+0x61/0x1e0 [i40e]
   dev_uc_del+0x77/0x90
   rtnl_fdb_del+0x6a5/0x860
   rtnetlink_rcv_msg+0x5db/0x880
   netlink_rcv_skb+0x254/0x380
   netlink_unicast+0x454/0x610
   netlink_sendmsg+0x747/0xb00
   sock_sendmsg+0xe2/0x120
   __sys_sendto+0x1ae/0x290
   __x64_sys_sendto+0xdd/0x1b0
   do_syscall_64+0xa0/0x370
   entry_SYSCALL_64_after_hwframe+0x65/0xca
- Net: Save and restore msg_namelen in sock_sendmsg. [Marc Dionne]

  [ Upstream commit 01b2885d9415152bcb12ff1f7788f500a74ea0ed ]

  Commit 86a7e0b69bd5 ("net: prevent rewrite of msg_name in
  sock_sendmsg()") made sock_sendmsg save the incoming msg_name pointer
  and restore it before returning, to insulate the caller against
  msg_name being changed by the called code.  If the address length
  was also changed however, we may return with an inconsistent structure
  where the length doesn't match the address, and attempts to reuse it may
  lead to lost packets.

  For example, a kernel that doesn't have commit 1c5950fc6fe9 ("udp6: fix
  potential access to stale information") will replace a v4 mapped address
  with its ipv4 equivalent, and shorten namelen accordingly from 28 to 16.
  If the caller attempts to reuse the resulting msg structure, it will have
  the original ipv6 (v4 mapped) address but an incorrect v4 length.
- Netfilter: nft_immediate: drop chain reference counter on error.
  [Pablo Neira Ayuso]

  [ Upstream commit b29be0ca8e816119ccdf95cc7d7c7be9bde005f1 ]

  In the init path, nft_data_init() bumps the chain reference counter,
  decrement it on error by following the error path which calls
  nft_data_release() to restore it.
- Netfilter: nftables: add loop check helper function. [Pablo Neira
  Ayuso]

  [ Upstream commit 6387aa6e59be8d1158c5703f34553c93d7743d8c ]

  This patch adds nft_check_loops() to reuse it in the new catch-all
  element codebase.
- Net: bcmgenet: Fix FCS generation for fragmented skbuffs. [Adrian
  Cinal]

  [ Upstream commit e584f2ff1e6cc9b1d99e8a6b0f3415940d1b3eb3 ]

  The flag DMA_TX_APPEND_CRC was only written to the first DMA descriptor
  in the TX path, where each descriptor corresponds to a single skbuff
  fragment (or the skbuff head). This led to packets with no FCS appearing
  on the wire if the kernel allocated the packet in fragments, which would
  always happen when using PACKET_MMAP/TPACKET (cf. tpacket_fill_skb() in
  net/af_packet.c).
- Sfc: fix a double-free bug in efx_probe_filters. [Zhipeng Lu]

  [ Upstream commit d5a306aedba34e640b11d7026dbbafb78ee3a5f6 ]

  In efx_probe_filters, the channel->rps_flow_id is freed in a
  efx_for_each_channel marco  when success equals to 0.
  However, after the following call chain:

  ef100_net_open
    |-> efx_probe_filters
    |-> ef100_net_stop
          |-> efx_remove_filters

  The channel->rps_flow_id is freed again in the efx_for_each_channel of
  efx_remove_filters, triggering a double-free bug.
- ARM: sun9i: smp: Fix array-index-out-of-bounds read in
  sunxi_mc_smp_init. [Stefan Wahren]

  [ Upstream commit 72ad3b772b6d393701df58ba1359b0bb346a19ed ]

  Running a multi-arch kernel (multi_v7_defconfig) on a Raspberry Pi 3B+
  with enabled CONFIG_UBSAN triggers the following warning:

   UBSAN: array-index-out-of-bounds in arch/arm/mach-sunxi/mc_smp.c:810:29
   index 2 is out of range for type 'sunxi_mc_smp_data [2]'
   CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.7.0-rc6-00248-g5254c0cbc92d
   Hardware name: BCM2835
    unwind_backtrace from show_stack+0x10/0x14
    show_stack from dump_stack_lvl+0x40/0x4c
    dump_stack_lvl from ubsan_epilogue+0x8/0x34
    ubsan_epilogue from __ubsan_handle_out_of_bounds+0x78/0x80
    __ubsan_handle_out_of_bounds from sunxi_mc_smp_init+0xe4/0x4cc
    sunxi_mc_smp_init from do_one_initcall+0xa0/0x2fc
    do_one_initcall from kernel_init_freeable+0xf4/0x2f4
    kernel_init_freeable from kernel_init+0x18/0x158
    kernel_init from ret_from_fork+0x14/0x28

  Since the enabled method couldn't match with any entry from
  sunxi_mc_smp_data, the value of the index shouldn't be used right after
  the loop. So move it after the check of ret in order to have a valid
  index.
- Net: sched: em_text: fix possible memory leak in em_text_destroy()
  [Hangyu Hua]

  [ Upstream commit 8fcb0382af6f1ef50936f1be05b8149eb2f88496 ]

  m->data needs to be freed when em_text_destroy is called.
- I40e: Fix filter input checks to prevent config with invalid values.
  [Sudheer Mogilappagari]

  [ Upstream commit 3e48041d9820c17e0a51599d12e66c6e12a8d08d ]

  Prevent VF from configuring filters with unsupported actions or use
  REDIRECT action with invalid tc number. Current checks could cause
  out of bounds access on PF side.
- Drm/i915/dp: Fix passing the correct DPCD_REV for
  drm_dp_set_phy_test_pattern. [Khaled Almahallawy]

  [ Upstream commit 2bd7a06a1208aaacb4e7a2a5436c23bce8d70801 ]

  Using link_status to get DPCD_REV fails when disabling/defaulting
  phy pattern. Use intel_dp->dpcd to access DPCD_REV correctly.

  Fixes: 8cdf72711928 ("drm/i915/dp: Program vswing, pre-emphasis, test-pattern")
  Cc: Jani Nikula <jani.nikula@intel.com>
  Cc: Imre Deak <imre.deak@intel.com>
  Cc: Lee Shawn C <shawn.c.lee@intel.com>
  Signed-off-by: Khaled Almahallawy <khaled.almahallawy@intel.com>
  Signed-off-by: Jani Nikula <jani.nikula@intel.com>
  Link: https://patchwork.freedesktop.org/patch/msgid/20231213211542.3585105-3-khaled.almahallawy@intel.com
  (cherry picked from commit 3ee302ec22d6e1d7d1e6d381b0d507ee80f2135c)
- Octeontx2-af: Fix marking couple of structure as __packed. [Suman
  Ghosh]

  [ Upstream commit 0ee2384a5a0f3b4eeac8d10bb01a0609d245a4d1 ]

  Couple of structures was not marked as __packed. This patch
  fixes the same and mark them as __packed.
- Nfc: llcp_core: Hold a ref to llcp_local->dev when holding a ref to
  llcp_local. [Siddh Raman Pant]

  [ Upstream commit c95f919567d6f1914f13350af61a1b044ac85014 ]

  llcp_sock_sendmsg() calls nfc_llcp_send_ui_frame() which in turn calls
  nfc_alloc_send_skb(), which accesses the nfc_dev from the llcp_sock for
  getting the headroom and tailroom needed for skb allocation.

  Parallelly the nfc_dev can be freed, as the refcount is decreased via
  nfc_free_device(), leading to a UAF reported by Syzkaller, which can
  be summarized as follows:

  (1) llcp_sock_sendmsg() -> nfc_llcp_send_ui_frame()
  	-> nfc_alloc_send_skb() -> Dereference *nfc_dev
  (2) virtual_ncidev_close() -> nci_free_device() -> nfc_free_device()
  	-> put_device() -> nfc_release() -> Free *nfc_dev

  When a reference to llcp_local is acquired, we do not acquire the same
  for the nfc_dev. This leads to freeing even when the llcp_local is in
  use, and this is the case with the UAF described above too.

  Thus, when we acquire a reference to llcp_local, we should acquire a
  reference to nfc_dev, and release the references appropriately later.

  References for llcp_local is initialized in nfc_llcp_register_device()
  (which is called by nfc_register_device()). Thus, we should acquire a
  reference to nfc_dev there.

  nfc_unregister_device() calls nfc_llcp_unregister_device() which in
  turn calls nfc_llcp_local_put(). Thus, the reference to nfc_dev is
  appropriately released later.
- ALSA: hda/realtek: Fix mute and mic-mute LEDs for HP ProBook 440 G6.
  [Siddhesh Dharme]

  commit b6ce6e6c79e4ec650887f1fe391a70e54972001a upstream.

  LEDs in 'HP ProBook 440 G6' laptop are controlled by ALC236 codec.
  Enable already existing quirk 'ALC236_FIXUP_HP_MUTE_LED_MICMUTE_VREF'
  to fix mute and mic-mute LEDs.
- Block: Don't invalidate pagecache for invalid falloc modes. [Sarthak
  Kukreti]

  commit 1364a3c391aedfeb32aa025303ead3d7c91cdf9d upstream.

  Only call truncate_bdev_range() if the fallocate mode is supported. This
  fixes a bug where data in the pagecache could be invalidated if the
  fallocate() was called on the block device with an invalid mode.
- Keys, dns: Fix missing size check of V1 server-list header. [Edward
  Adam Davis]

  commit 1997b3cb4217b09e49659b634c94da47f0340409 upstream.

  The dns_resolver_preparse() function has a check on the size of the
  payload for the basic header of the binary-style payload, but is missing
  a check for the size of the V1 server-list payload header after
  determining that's what we've been given.

  Fix this by getting rid of the the pointer to the basic header and just
  assuming that we have a V1 server-list payload and moving the V1 server
  list pointer inside the if-statement.  Dealing with other types and
  versions can be left for when such have been defined.

  This can be tested by doing the following with KASAN enabled:

      echo -n -e '\x0\x0\x1\x2' | keyctl padd dns_resolver foo @p

  and produces an oops like the following:

      BUG: KASAN: slab-out-of-bounds in dns_resolver_preparse+0xc9f/0xd60 net/dns_resolver/dns_key.c:127
      Read of size 1 at addr ffff888028894084 by task syz-executor265/5069
      ...
      Call Trace:
        dns_resolver_preparse+0xc9f/0xd60 net/dns_resolver/dns_key.c:127
        __key_create_or_update+0x453/0xdf0 security/keys/key.c:842
        key_create_or_update+0x42/0x50 security/keys/key.c:1007
        __do_sys_add_key+0x29c/0x450 security/keys/keyctl.c:134
        do_syscall_x64 arch/x86/entry/common.c:52 [inline]
        do_syscall_64+0x40/0x110 arch/x86/entry/common.c:83
        entry_SYSCALL_64_after_hwframe+0x62/0x6a

  This patch was originally by Edward Adam Davis, but was modified by
  Linus.
- Linux 5.10.207. [Greg Kroah-Hartman]
- Scsi: core: Always send batch on reset or error handling command.
  [Alexander Atanasov]

  commit 066c5b46b6eaf2f13f80c19500dbb3b84baabb33 upstream.

  In commit 8930a6c20791 ("scsi: core: add support for request batching") the
  block layer bd->last flag was mapped to SCMD_LAST and used as an indicator
  to send the batch for the drivers that implement this feature. However, the
  error handling code was not updated accordingly.

  scsi_send_eh_cmnd() is used to send error handling commands and request
  sense. The problem is that request sense comes as a single command that
  gets into the batch queue and times out. As a result the device goes
  offline after several failed resets. This was observed on virtio_scsi
  during a device resize operation.

  [  496.316946] sd 0:0:4:0: [sdd] tag#117 scsi_eh_0: requesting sense
  [  506.786356] sd 0:0:4:0: [sdd] tag#117 scsi_send_eh_cmnd timeleft: 0
  [  506.787981] sd 0:0:4:0: [sdd] tag#117 abort

  To fix this always set SCMD_LAST flag in scsi_send_eh_cmnd() and
  scsi_reset_ioctl().
- Revert "scsi: core: Add scsi_prot_ref_tag() helper" [Greg Kroah-
  Hartman]

  This reverts commit 294d66c35a4e019a9dfe889fe382adce1cc3773e which is
  commit 7ba46799d34695534666a3f71a2be10ea85ece6c upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Revert "scsi: core: Introduce scsi_get_sector()" [Greg Kroah-Hartman]

  This reverts commit f230e6d4249b9ccdcb571077023cecabf91ecbb1 which is
  commit f0f214fe8cd32224267ebea93817b8c32074623d upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Revert "scsi: core: Make scsi_get_lba() return the LBA" [Greg Kroah-
  Hartman]

  This reverts commit d054858a9c9e4406099e61fe00c93516f9b4c169 which is
  commit d2c945f01d233085fedc9e3cf7ec180eaa2b7a85 upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Revert "scsi: core: Use scsi_cmd_to_rq() instead of scsi_cmnd.request"
  [Greg Kroah-Hartman]

  This reverts commit df83ca8e986d0285974dfa510973191547dcd173 which is
  commit aa8e25e5006aac52c943c84e9056ab488630ee19 upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Revert "scsi: core: Use a structure member to track the SCSI command
  submitter" [Greg Kroah-Hartman]

  This reverts commit f2d30198c0530b8da155697d8723e19ac72c15fe which is
  commit bf23e619039d360d503b7282d030daf2277a5d47 upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Revert "scsi: core: Always send batch on reset or error handling
  command" [Greg Kroah-Hartman]

  This reverts commit 9db5239d7533c841dcd7a36700f829f6ee96a76d which is
  commit 066c5b46b6eaf2f13f80c19500dbb3b84baabb33 upstream.

  As reported, a lot of scsi changes were made just to resolve a 2 line
  patch, so let's revert them all and then manually fix up the 2 line
  fixup so that things are simpler and potential abi changes are not an
  issue.
- Linux 5.10.206. [Greg Kroah-Hartman]
- Spi: atmel: Fix PDC transfer setup bug. [Ville Baillie]

  commit 75e33c55ae8fb4a177fe07c284665e1d61b02560 upstream.

  atmel_spi_dma_map_xfer to never be called in PDC mode. This causes the
  driver to silently fail.

  This patch changes the conditional to match the behaviour of the
  previous commit before the refactor.
- Bluetooth: SMP: Fix crash when receiving new connection when debug is
  enabled. [Luiz Augusto von Dentz]

  commit 995fca15b73ff8f92888cc2d5d95f17ffdac74ba upstream.

  When receiving a new connection pchan->conn won't be initialized so the
  code cannot use bt_dev_dbg as the pointer to hci_dev won't be
  accessible.
- Revert "MIPS: Loongson64: Enable DMA noncoherent support" [Greg Kroah-
  Hartman]

  This reverts commit 3ee7e2faef87594228eb2622f8c25c0495ea50a1 which is
  commit edc0378eee00200a5bedf1bb9f00ad390e0d1bd4 upstream.

  There are reports of this causing build issues, so revert it from the
  5.10.y tree for now.
- Dm-integrity: don't modify bio's immutable bio_vec in
  integrity_metadata() [Mikulas Patocka]

  commit b86f4b790c998afdbc88fe1aa55cfe89c4068726 upstream.

  __bio_for_each_segment assumes that the first struct bio_vec argument
  doesn't change - it calls "bio_advance_iter_single((bio), &(iter),
  (bvl).bv_len)" to advance the iterator. Unfortunately, the dm-integrity
  code changes the bio_vec with "bv.bv_len -= pos". When this code path
  is taken, the iterator would be out of sync and dm-integrity would
  report errors. This happens if the machine is out of memory and
  "kmalloc" fails.

  Fix this bug by making a copy of "bv" and changing the copy instead.
- Netfilter: nf_tables: skip set commit for deleted/destroyed sets.
  [Pablo Neira Ayuso]

  commit 7315dc1e122c85ffdfc8defffbb8f8b616c2eb1a upstream.

  NFT_MSG_DELSET deactivates all elements in the set, skip
  set->ops->commit() to avoid the unnecessary clone (for the pipapo case)
  as well as the sync GC cycle, which could deactivate again expired
  elements in such set.
- Tracing: Fix blocked reader of snapshot buffer. [Steven Rostedt
  (Google)]

  commit 39a7dc23a1ed0fe81141792a09449d124c5953bd upstream.

  If an application blocks on the snapshot or snapshot_raw files, expecting
  to be woken up when a snapshot occurs, it will not happen. Or it may
  happen with an unexpected result.

  That result is that the application will be reading the main buffer
  instead of the snapshot buffer. That is because when the snapshot occurs,
  the main and snapshot buffers are swapped. But the reader has a descriptor
  still pointing to the buffer that it originally connected to.

  This is fine for the main buffer readers, as they may be blocked waiting
  for a watermark to be hit, and when a snapshot occurs, the data that the
  main readers want is now on the snapshot buffer.

  But for waiters of the snapshot buffer, they are waiting for an event to
  occur that will trigger the snapshot and they can then consume it quickly
  to save the snapshot before the next snapshot occurs. But to do this, they
  need to read the new snapshot buffer, not the old one that is now
  receiving new data.

  Also, it does not make sense to have a watermark "buffer_percent" on the
  snapshot buffer, as the snapshot buffer is static and does not receive new
  data except all at once.
- Ring-buffer: Fix wake ups when buffer_percent is set to 100. [Steven
  Rostedt (Google)]

  commit 623b1f896fa8a669a277ee5a258307a16c7377a3 upstream.

  The tracefs file "buffer_percent" is to allow user space to set a
  water-mark on how much of the tracing ring buffer needs to be filled in
  order to wake up a blocked reader.

   0 - is to wait until any data is in the buffer
   1 - is to wait for 1% of the sub buffers to be filled
   50 - would be half of the sub buffers are filled with data
   100 - is not to wake the waiter until the ring buffer is completely full

  Unfortunately the test for being full was:

  	dirty = ring_buffer_nr_dirty_pages(buffer, cpu);
  	return (dirty * 100) > (full * nr_pages);

  Where "full" is the value for "buffer_percent".

  There is two issues with the above when full == 100.

  1. dirty * 100 > 100 * nr_pages will never be true
     That is, the above is basically saying that if the user sets
     buffer_percent to 100, more pages need to be dirty than exist in the
     ring buffer!

  2. The page that the writer is on is never considered dirty, as dirty
     pages are only those that are full. When the writer goes to a new
     sub-buffer, it clears the contents of that sub-buffer.

  That is, even if the check was ">=" it would still not be equal as the
  most pages that can be considered "dirty" is nr_pages - 1.

  To fix this, add one to dirty and use ">=" in the compare.
- Scsi: core: Always send batch on reset or error handling command.
  [Alexander Atanasov]

  [ Upstream commit 066c5b46b6eaf2f13f80c19500dbb3b84baabb33 ]

  In commit 8930a6c20791 ("scsi: core: add support for request batching") the
  block layer bd->last flag was mapped to SCMD_LAST and used as an indicator
  to send the batch for the drivers that implement this feature. However, the
  error handling code was not updated accordingly.

  scsi_send_eh_cmnd() is used to send error handling commands and request
  sense. The problem is that request sense comes as a single command that
  gets into the batch queue and times out. As a result the device goes
  offline after several failed resets. This was observed on virtio_scsi
  during a device resize operation.

  [  496.316946] sd 0:0:4:0: [sdd] tag#117 scsi_eh_0: requesting sense
  [  506.786356] sd 0:0:4:0: [sdd] tag#117 scsi_send_eh_cmnd timeleft: 0
  [  506.787981] sd 0:0:4:0: [sdd] tag#117 abort

  To fix this always set SCMD_LAST flag in scsi_send_eh_cmnd() and
  scsi_reset_ioctl().
- Scsi: core: Use a structure member to track the SCSI command
  submitter. [Bart Van Assche]

  [ Upstream commit bf23e619039d360d503b7282d030daf2277a5d47 ]

  Conditional statements are faster than indirect calls. Use a structure
  member to track the SCSI command submitter such that later patches can call
  scsi_done(scmd) instead of scmd->scsi_done(scmd).

  The asymmetric behavior that scsi_send_eh_cmnd() sets the submission
  context to the SCSI error handler and that it does not restore the
  submission context to the SCSI core is retained.
- Scsi: core: Use scsi_cmd_to_rq() instead of scsi_cmnd.request. [Bart
  Van Assche]

  [ Upstream commit aa8e25e5006aac52c943c84e9056ab488630ee19 ]

  Prepare for removal of the request pointer by using scsi_cmd_to_rq()
  instead. Cast away constness where necessary when passing a SCSI command
  pointer to scsi_cmd_to_rq(). This patch does not change any functionality.
- Scsi: core: Make scsi_get_lba() return the LBA. [Martin K. Petersen]

  [ Upstream commit d2c945f01d233085fedc9e3cf7ec180eaa2b7a85 ]

  scsi_get_lba() confusingly returned the block layer sector number expressed
  in units of 512 bytes. Now that we have a more aptly named
  scsi_get_sector() function, make scsi_get_lba() return the actual LBA.
- Scsi: core: Introduce scsi_get_sector() [Bart Van Assche]

  [ Upstream commit f0f214fe8cd32224267ebea93817b8c32074623d ]

  Since scsi_get_lba() returns a sector_t value instead of the LBA, the name
  of that function is confusing. Introduce an identical function
  scsi_get_sector().
- Scsi: core: Add scsi_prot_ref_tag() helper. [Martin K. Petersen]

  [ Upstream commit 7ba46799d34695534666a3f71a2be10ea85ece6c ]

  We are about to remove the request pointer from struct scsi_cmnd and that
  will complicate getting to the ref_tag via t10_pi_ref_tag() in the various
  drivers. Introduce a helper function to retrieve the reference tag so
  drivers will not have to worry about the details.
- Spi: atmel: Fix CS and initialization bug. [Dan Sneddon]

  [ Upstream commit 69e1818ad27bae167eeaaf6829d4a08900ef5153 ]

  Commit 5fa5e6dec762 ("spi: atmel: Switch to transfer_one transfer
  method") switched to using transfer_one and set_cs.  The
  core doesn't call set_cs when the chip select lines are gpios.  Add the
  SPI_MASTER_GPIO_SS flag to the driver to ensure the calls to set_cs
  happen since the driver programs configuration registers there.
- Spi: atmel: Switch to transfer_one transfer method. [Dan Sneddon]

  [ Upstream commit 5fa5e6dec762305a783e918a90a05369fc10e346 ]

  Switch from using our own transfer_one_message routine to using the one
  provided by the SPI core.
- Bluetooth: af_bluetooth: Fix Use-After-Free in bt_sock_recvmsg.
  [Hyunwoo Kim]

  [ Upstream commit 2e07e8348ea454615e268222ae3fc240421be768 ]

  This can cause a race with bt_sock_ioctl() because
  bt_sock_recvmsg() gets the skb from sk->sk_receive_queue
  and then frees it without holding lock_sock.
  A use-after-free for a skb occurs with the following flow.
  ```
  bt_sock_recvmsg() -> skb_recv_datagram() -> skb_free_datagram()
  bt_sock_ioctl() -> skb_peek()
  ```
  Add lock_sock to bt_sock_recvmsg() to fix this issue.
- Smb: client: fix OOB in smbCalcSize() [Paulo Alcantara]

  [ Upstream commit b35858b3786ddbb56e1c35138ba25d6adf8d0bef ]

  Validate @smb->WordCount to avoid reading off the end of @smb and thus
  causing the following KASAN splat:

    BUG: KASAN: slab-out-of-bounds in smbCalcSize+0x32/0x40 [cifs]
    Read of size 2 at addr ffff88801c024ec5 by task cifsd/1328

    CPU: 1 PID: 1328 Comm: cifsd Not tainted 6.7.0-rc5 #9
    Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
    rel-1.16.2-3-gd478f380-rebuilt.opensuse.org 04/01/2014
    Call Trace:
     <TASK>
     dump_stack_lvl+0x4a/0x80
     print_report+0xcf/0x650
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? __phys_addr+0x46/0x90
     kasan_report+0xd8/0x110
     ? smbCalcSize+0x32/0x40 [cifs]
     ? smbCalcSize+0x32/0x40 [cifs]
     kasan_check_range+0x105/0x1b0
     smbCalcSize+0x32/0x40 [cifs]
     checkSMB+0x162/0x370 [cifs]
     ? __pfx_checkSMB+0x10/0x10 [cifs]
     cifs_handle_standard+0xbc/0x2f0 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     cifs_demultiplex_thread+0xed1/0x1360 [cifs]
     ? __pfx_cifs_demultiplex_thread+0x10/0x10 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? lockdep_hardirqs_on_prepare+0x136/0x210
     ? __pfx_lock_release+0x10/0x10
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? mark_held_locks+0x1a/0x90
     ? lockdep_hardirqs_on_prepare+0x136/0x210
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? __kthread_parkme+0xce/0xf0
     ? __pfx_cifs_demultiplex_thread+0x10/0x10 [cifs]
     kthread+0x18d/0x1d0
     ? kthread+0xdb/0x1d0
     ? __pfx_kthread+0x10/0x10
     ret_from_fork+0x34/0x60
     ? __pfx_kthread+0x10/0x10
     ret_from_fork_asm+0x1b/0x30
     </TASK>

  This fixes CVE-2023-6606.
- Smb: client: fix OOB in SMB2_query_info_init() [Paulo Alcantara]

  [ Upstream commit 33eae65c6f49770fec7a662935d4eb4a6406d24b ]

  A small CIFS buffer (448 bytes) isn't big enough to hold
  SMB2_QUERY_INFO request along with user's input data from
  CIFS_QUERY_INFO ioctl.  That is, if the user passed an input buffer >
  344 bytes, the client will memcpy() off the end of @req->Buffer in
  SMB2_query_info_init() thus causing the following KASAN splat:

    BUG: KASAN: slab-out-of-bounds in SMB2_query_info_init+0x242/0x250 [cifs]
    Write of size 1023 at addr ffff88801308c5a8 by task a.out/1240

    CPU: 1 PID: 1240 Comm: a.out Not tainted 6.7.0-rc4 #5
    Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
    rel-1.16.2-3-gd478f380-rebuilt.opensuse.org 04/01/2014
    Call Trace:
     <TASK>
     dump_stack_lvl+0x4a/0x80
     print_report+0xcf/0x650
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? __phys_addr+0x46/0x90
     kasan_report+0xd8/0x110
     ? SMB2_query_info_init+0x242/0x250 [cifs]
     ? SMB2_query_info_init+0x242/0x250 [cifs]
     kasan_check_range+0x105/0x1b0
     __asan_memcpy+0x3c/0x60
     SMB2_query_info_init+0x242/0x250 [cifs]
     ? __pfx_SMB2_query_info_init+0x10/0x10 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? smb_rqst_len+0xa6/0xc0 [cifs]
     smb2_ioctl_query_info+0x4f4/0x9a0 [cifs]
     ? __pfx_smb2_ioctl_query_info+0x10/0x10 [cifs]
     ? __pfx_cifsConvertToUTF16+0x10/0x10 [cifs]
     ? kasan_set_track+0x25/0x30
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? __kasan_kmalloc+0x8f/0xa0
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? cifs_strndup_to_utf16+0x12d/0x1a0 [cifs]
     ? __build_path_from_dentry_optional_prefix+0x19d/0x2d0 [cifs]
     ? __pfx_smb2_ioctl_query_info+0x10/0x10 [cifs]
     cifs_ioctl+0x11c7/0x1de0 [cifs]
     ? __pfx_cifs_ioctl+0x10/0x10 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? rcu_is_watching+0x23/0x50
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? __rseq_handle_notify_resume+0x6cd/0x850
     ? __pfx___schedule+0x10/0x10
     ? blkcg_iostat_update+0x250/0x290
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? ksys_write+0xe9/0x170
     __x64_sys_ioctl+0xc9/0x100
     do_syscall_64+0x47/0xf0
     entry_SYSCALL_64_after_hwframe+0x6f/0x77
    RIP: 0033:0x7f893dde49cf
    Code: 00 48 89 44 24 18 31 c0 48 8d 44 24 60 c7 04 24 10 00 00 00 48
    89 44 24 08 48 8d 44 24 20 48 89 44 24 10 b8 10 00 00 00 0f 05 <89>
    c2 3d 00 f0 ff ff 77 18 48 8b 44 24 18 64 48 2b 04 25 28 00 00
    RSP: 002b:00007ffc03ff4160 EFLAGS: 00000246 ORIG_RAX: 0000000000000010
    RAX: ffffffffffffffda RBX: 00007ffc03ff4378 RCX: 00007f893dde49cf
    RDX: 00007ffc03ff41d0 RSI: 00000000c018cf07 RDI: 0000000000000003
    RBP: 00007ffc03ff4260 R08: 0000000000000410 R09: 0000000000000001
    R10: 00007f893dce7300 R11: 0000000000000246 R12: 0000000000000000
    R13: 00007ffc03ff4388 R14: 00007f893df15000 R15: 0000000000406de0
     </TASK>

  Fix this by increasing size of SMB2_QUERY_INFO request buffers and
  validating input length to prevent other callers from overflowing @req
  in SMB2_query_info_init() as well.
- Usb: fotg210-hcd: delete an incorrect bounds test. [Dan Carpenter]

  [ Upstream commit 7fbcd195e2b8cc952e4aeaeb50867b798040314c ]

  Here "temp" is the number of characters that we have written and "size"
  is the size of the buffer.  The intent was clearly to say that if we have
  written to the end of the buffer then stop.

  However, for that to work the comparison should have been done on the
  original "size" value instead of the "size -= temp" value.  Not only
  will that not trigger when we want to, but there is a small chance that
  it will trigger incorrectly before we want it to and we break from the
  loop slightly earlier than intended.

  This code was recently changed from using snprintf() to scnprintf().  With
  snprintf() we likely would have continued looping and passed a negative
  size parameter to snprintf().  This would have triggered an annoying
  WARN().  Now that we have converted to scnprintf() "size" will never
  drop below 1 and there is no real need for this test.  We could change
  the condition to "if (temp <= 1) goto done;" but just deleting the test
  is cleanest.
- Bluetooth: MGMT/SMP: Fix address type when using SMP over BREDR/LE.
  [Xiao Yao]

  [ Upstream commit 59b047bc98084f8af2c41483e4d68a5adf2fa7f7 ]

  If two Bluetooth devices both support BR/EDR and BLE, and also
  support Secure Connections, then they only need to pair once.
  The LTK generated during the LE pairing process may be converted
  into a BR/EDR link key for BR/EDR transport, and conversely, a
  link key generated during the BR/EDR SSP pairing process can be
  converted into an LTK for LE transport. Hence, the link type of
  the link key and LTK is not fixed, they can be either an LE LINK
  or an ACL LINK.

  Currently, in the mgmt_new_irk/ltk/crsk/link_key functions, the
  link type is fixed, which could lead to incorrect address types
  being reported to the application layer. Therefore, it is necessary
  to add link_type/addr_type to the smp_irk/ltk/crsk and link_key,
  to ensure the generation of the correct address type.

  SMP over BREDR:
  Before Fix:
  > ACL Data RX: Handle 11 flags 0x02 dlen 12
          BR/EDR SMP: Identity Address Information (0x09) len 7
          Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Identity Resolving Key (0x0018) plen 30
          Random address: 00:00:00:00:00:00 (Non-Resolvable)
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Long Term Key (0x000a) plen 37
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated key from P-256 (0x03)

  After Fix:
  > ACL Data RX: Handle 11 flags 0x02 dlen 12
        BR/EDR SMP: Identity Address Information (0x09) len 7
          Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Identity Resolving Key (0x0018) plen 30
          Random address: 00:00:00:00:00:00 (Non-Resolvable)
          BR/EDR Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Long Term Key (0x000a) plen 37
          BR/EDR Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated key from P-256 (0x03)

  SMP over LE:
  Before Fix:
  @ MGMT Event: New Identity Resolving Key (0x0018) plen 30
          Random address: 5F:5C:07:37:47:D5 (Resolvable)
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Long Term Key (0x000a) plen 37
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated key from P-256 (0x03)
  @ MGMT Event: New Link Key (0x0009) plen 26
          BR/EDR Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated Combination key from P-256 (0x08)

  After Fix:
  @ MGMT Event: New Identity Resolving Key (0x0018) plen 30
          Random address: 5E:03:1C:00:38:21 (Resolvable)
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
  @ MGMT Event: New Long Term Key (0x000a) plen 37
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated key from P-256 (0x03)
  @ MGMT Event: New Link Key (0x0009) plen 26
          Store hint: Yes (0x01)
          LE Address: F8:7D:76:F2:12:F3 (OUI F8-7D-76)
          Key type: Authenticated Combination key from P-256 (0x08)
- Bluetooth: use inclusive language in SMP. [Archie Pusaka]

  [ Upstream commit fad646e16d3cafd67d3cfff8e66f77401190957e ]

  This patch replaces some non-inclusive terms based on the appropriate
  language mapping table compiled by the Bluetooth SIG:
  https://specificationrefs.bluetooth.com/language-mapping/Appropriate_Language_Mapping_Table.pdf

  Specifically, these terms are replaced:
  master -> initiator
  slave  -> responder
- Bluetooth: SMP: Convert BT_ERR/BT_DBG to bt_dev_err/bt_dev_dbg. [Luiz
  Augusto von Dentz]

  [ Upstream commit 2e1614f7d61e407f1a8e7935a2903a6fa3cb0b11 ]

  This converts instances of BT_ERR and BT_DBG to bt_dev_err and
  bt_dev_dbg which can be enabled at runtime when BT_FEATURE_DEBUG is
  enabled.

  Note: Not all instances could be converted as some are exercised by
  selftest.
- ARM: dts: Fix occasional boot hang for am3 usb. [Tony Lindgren]

  [ Upstream commit 9b6a51aab5f5f9f71d2fa16e8b4d530e1643dfcb ]

  With subtle timings changes, we can now sometimes get an external abort on
  non-linefetch error booting am3 devices at sysc_reset(). This is because
  of a missing reset delay needed for the usb target module.

  Looks like we never enabled the delay earlier for am3, although a similar
  issue was seen earlier with a similar usb setup for dm814x as described in
  commit ebf244148092 ("ARM: OMAP2+: Use srst_udelay for USB on dm814x").
- 9p/net: fix possible memory leak in p9_check_errors() [Hangyu Hua]

  commit ce07087964208eee2ca2f9ee4a98f8b5d9027fe6 upstream.

  When p9pdu_readf() is called with "s?d" attribute, it allocates a pointer
  that will store a string. But when p9pdu_readf() fails while handling "d"
  then this pointer will not be freed in p9_check_errors().
- X86/alternatives: Sync core before enabling interrupts. [Thomas
  Gleixner]

  commit 3ea1704a92967834bf0e64ca1205db4680d04048 upstream.

  text_poke_early() does:

     local_irq_save(flags);
     memcpy(addr, opcode, len);
     local_irq_restore(flags);
     sync_core();

  That's not really correct because the synchronization should happen before
  interrupts are re-enabled to ensure that a pending interrupt observes the
  complete update of the opcodes.

  It's not entirely clear whether the interrupt entry provides enough
  serialization already, but moving the sync_core() invocation into interrupt
  disabled region does no harm and is obviously correct.
- Lib/vsprintf: Fix %pfwf when current node refcount == 0. [Herve
  Codina]

  commit 5c47251e8c4903111608ddcba2a77c0c425c247c upstream.

  A refcount issue can appeared in __fwnode_link_del() due to the
  pr_debug() call:
    WARNING: CPU: 0 PID: 901 at lib/refcount.c:25 refcount_warn_saturate+0xe5/0x110
    Call Trace:
    <TASK>
    ...
    of_node_get+0x1e/0x30
    of_fwnode_get+0x28/0x40
    fwnode_full_name_string+0x34/0x90
    fwnode_string+0xdb/0x140
    ...
    vsnprintf+0x17b/0x630
    ...
    __fwnode_link_del+0x25/0xa0
    fwnode_links_purge+0x39/0xb0
    of_node_release+0xd9/0x180
    ...

  Indeed, an fwnode (of_node) is being destroyed and so, of_node_release()
  is called because the of_node refcount reached 0.
  From of_node_release() several function calls are done and lead to
  a pr_debug() calls with %pfwf to print the fwnode full name.
  The issue is not present if we change %pfwf to %pfwP.

  To print the full name, %pfwf iterates over the current node and its
  parents and obtain/drop a reference to all nodes involved.

  In order to allow to print the full name (%pfwf) of a node while it is
  being destroyed, do not obtain/drop a reference to this current node.
- Bus: ti-sysc: Flush posted write only after srst_udelay. [Tony
  Lindgren]

  commit f71f6ff8c1f682a1cae4e8d7bdeed9d7f76b8f75 upstream.

  Commit 34539b442b3b ("bus: ti-sysc: Flush posted write on enable before
  reset") caused a regression reproducable on omap4 duovero where the ISS
  target module can produce interconnect errors on boot. Turns out the
  registers are not accessible until after a delay for devices needing
  a ti,sysc-delay-us value.

  Let's fix this by flushing the posted write only after the reset delay.
  We do flushing also for ti,sysc-delay-us using devices as that should
  trigger an interconnect error if the delay is not properly configured.

  Let's also add some comments while at it.
- Tracing / synthetic: Disable events after testing in
  synth_event_gen_test_init() [Steven Rostedt (Google)]

  commit 88b30c7f5d27e1594d70dc2bd7199b18f2b57fa9 upstream.

  The synth_event_gen_test module can be built in, if someone wants to run
  the tests at boot up and not have to load them.

  The synth_event_gen_test_init() function creates and enables the synthetic
  events and runs its tests.

  The synth_event_gen_test_exit() disables the events it created and
  destroys the events.

  If the module is builtin, the events are never disabled. The issue is, the
  events should be disable after the tests are run. This could be an issue
  if the rest of the boot up tests are enabled, as they expect the events to
  be in a known state before testing. That known state happens to be
  disabled.

  When CONFIG_SYNTH_EVENT_GEN_TEST=y and CONFIG_EVENT_TRACE_STARTUP_TEST=y
  a warning will trigger:

   Running tests on trace events:
   Testing event create_synth_test:
   Enabled event during self test!
   ------------[ cut here ]------------
   WARNING: CPU: 2 PID: 1 at kernel/trace/trace_events.c:4150 event_trace_self_tests+0x1c2/0x480
   Modules linked in:
   CPU: 2 PID: 1 Comm: swapper/0 Not tainted 6.7.0-rc2-test-00031-gb803d7c664d5-dirty #276
   Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
   RIP: 0010:event_trace_self_tests+0x1c2/0x480
   Code: bb e8 a2 ab 5d fc 48 8d 7b 48 e8 f9 3d 99 fc 48 8b 73 48 40 f6 c6 01 0f 84 d6 fe ff ff 48 c7 c7 20 b6 ad bb e8 7f ab 5d fc 90 <0f> 0b 90 48 89 df e8 d3 3d 99 fc 48 8b 1b 4c 39 f3 0f 85 2c ff ff
   RSP: 0000:ffffc9000001fdc0 EFLAGS: 00010246
   RAX: 0000000000000029 RBX: ffff88810399ca80 RCX: 0000000000000000
   RDX: 0000000000000000 RSI: ffffffffb9f19478 RDI: ffff88823c734e64
   RBP: ffff88810399f300 R08: 0000000000000000 R09: fffffbfff79eb32a
   R10: ffffffffbcf59957 R11: 0000000000000001 R12: ffff888104068090
   R13: ffffffffbc89f0a0 R14: ffffffffbc8a0f08 R15: 0000000000000078
   FS:  0000000000000000(0000) GS:ffff88823c700000(0000) knlGS:0000000000000000
   CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
   CR2: 0000000000000000 CR3: 00000001f6282001 CR4: 0000000000170ef0
   Call Trace:
    <TASK>
    ? __warn+0xa5/0x200
    ? event_trace_self_tests+0x1c2/0x480
    ? report_bug+0x1f6/0x220
    ? handle_bug+0x6f/0x90
    ? exc_invalid_op+0x17/0x50
    ? asm_exc_invalid_op+0x1a/0x20
    ? tracer_preempt_on+0x78/0x1c0
    ? event_trace_self_tests+0x1c2/0x480
    ? __pfx_event_trace_self_tests_init+0x10/0x10
    event_trace_self_tests_init+0x27/0xe0
    do_one_initcall+0xd6/0x3c0
    ? __pfx_do_one_initcall+0x10/0x10
    ? kasan_set_track+0x25/0x30
    ? rcu_is_watching+0x38/0x60
    kernel_init_freeable+0x324/0x450
    ? __pfx_kernel_init+0x10/0x10
    kernel_init+0x1f/0x1e0
    ? _raw_spin_unlock_irq+0x33/0x50
    ret_from_fork+0x34/0x60
    ? __pfx_kernel_init+0x10/0x10
    ret_from_fork_asm+0x1b/0x30
    </TASK>

  This is because the synth_event_gen_test_init() left the synthetic events
  that it created enabled. By having it disable them after testing, the
  other selftests will run fine.
- Dt-bindings: nvmem: mxs-ocotp: Document fsl,ocotp. [Fabio Estevam]

  commit a2a8aefecbd0f87d6127951cef33b3def8439057 upstream.

  Both imx23.dtsi and imx28.dtsi describe the OCOTP nodes in
  the format:

  compatible = "fsl,imx28-ocotp", "fsl,ocotp";

  Document the "fsl,ocotp" entry to fix the following schema
  warning:

  efuse@8002c000: compatible: ['fsl,imx23-ocotp', 'fsl,ocotp'] is too long
  from schema $id: http://devicetree.org/schemas/nvmem/mxs-ocotp.yaml#
- Net: ks8851: Fix TX stall caused by TX buffer overrun. [Ronald Wahl]

  commit 3dc5d44545453de1de9c53cc529cc960a85933da upstream.

  There is a bug in the ks8851 Ethernet driver that more data is written
  to the hardware TX buffer than actually available. This is caused by
  wrong accounting of the free TX buffer space.

  The driver maintains a tx_space variable that represents the TX buffer
  space that is deemed to be free. The ks8851_start_xmit_spi() function
  adds an SKB to a queue if tx_space is large enough and reduces tx_space
  by the amount of buffer space it will later need in the TX buffer and
  then schedules a work item. If there is not enough space then the TX
  queue is stopped.

  The worker function ks8851_tx_work() dequeues all the SKBs and writes
  the data into the hardware TX buffer. The last packet will trigger an
  interrupt after it was send. Here it is assumed that all data fits into
  the TX buffer.

  In the interrupt routine (which runs asynchronously because it is a
  threaded interrupt) tx_space is updated with the current value from the
  hardware. Also the TX queue is woken up again.

  Now it could happen that after data was sent to the hardware and before
  handling the TX interrupt new data is queued in ks8851_start_xmit_spi()
  when the TX buffer space had still some space left. When the interrupt
  is actually handled tx_space is updated from the hardware but now we
  already have new SKBs queued that have not been written to the hardware
  TX buffer yet. Since tx_space has been overwritten by the value from the
  hardware the space is not accounted for.

  Now we have more data queued then buffer space available in the hardware
  and ks8851_tx_work() will potentially overrun the hardware TX buffer. In
  many cases it will still work because often the buffer is written out
  fast enough so that no overrun occurs but for example if the peer
  throttles us via flow control then an overrun may happen.

  This can be fixed in different ways. The most simple way would be to set
  tx_space to 0 before writing data to the hardware TX buffer preventing
  the queuing of more SKBs until the TX interrupt has been handled. I have
  chosen a slightly more efficient (and still rather simple) way and
  track the amount of data that is already queued and not yet written to
  the hardware. When new SKBs are to be queued the already queued amount
  of data is honoured when checking free TX buffer space.

  I tested this with a setup of two linked KS8851 running iperf3 between
  the two in bidirectional mode. Before the fix I got a stall after some
  minutes. With the fix I saw now issues anymore after hours.
- Net: rfkill: gpio: set GPIO direction. [Rouven Czerwinski]

  commit 23484d817082c3005252d8edfc8292c8a1006b5b upstream.

  Fix the undefined usage of the GPIO consumer API after retrieving the
  GPIO description with GPIO_ASIS. The API documentation mentions that
  GPIO_ASIS won't set a GPIO direction and requires the user to set a
  direction before using the GPIO.

  This can be confirmed on i.MX6 hardware, where rfkill-gpio is no longer
  able to enabled/disable a device, presumably because the GPIO controller
  was never configured for the output direction.
- Net: 9p: avoid freeing uninit memory in p9pdu_vreadf. [Fedor Pchelkin]

  commit ff49bf1867578f23a5ffdd38f927f6e1e16796c4 upstream.

  If some of p9pdu_readf() calls inside case 'T' in p9pdu_vreadf() fails,
  the error path is not handled properly. *wnames or members of *wnames
  array may be left uninitialized and invalidly freed.

  Initialize *wnames to NULL in beginning of case 'T'. Initialize the first
  *wnames array element to NULL and nullify the failing *wnames element so
  that the error path freeing loop stops on the first NULL element and
  doesn't proceed further.

  Found by Linux Verification Center (linuxtesting.org).
- Input: soc_button_array - add mapping for airplane mode button.
  [Christoffer Sandberg]

  commit ea3715941a9b7d816a1e9096ac0577900af2a69e upstream.

  This add a mapping for the airplane mode button on the TUXEDO Pulse Gen3.

  While it is physically a key it behaves more like a switch, sending a key
  down on first press and a key up on 2nd press. Therefor the switch event
  is used here. Besides this behaviour it uses the HID usage-id 0xc6
  (Wireless Radio Button) and not 0xc8 (Wireless Radio Slider Switch), but
  since neither 0xc6 nor 0xc8 are currently implemented at all in
  soc_button_array this not to standard behaviour is not put behind a quirk
  for the moment.
- Bluetooth: L2CAP: Send reject on command corrupted request. [Frédéric
  Danis]

  commit 78b99eb1faa7371bf9c534690f26a71b6996622d upstream.

  L2CAP/COS/CED/BI-02-C PTS test send a malformed L2CAP signaling packet
  with 2 commands in it (a connection request and an unknown command) and
  expect to get a connection response packet and a command reject packet.
  The second is currently not sent.
- Bluetooth: hci_event: Fix not checking if HCI_OP_INQUIRY has been
  sent. [Luiz Augusto von Dentz]

  commit 99e67d46e5ff3c7c901af6009edec72d3d363be8 upstream.

  Before setting HCI_INQUIRY bit check if HCI_OP_INQUIRY was really sent
  otherwise the controller maybe be generating invalid events or, more
  likely, it is a result of fuzzing tools attempting to test the right
  behavior of the stack when unexpected events are generated.
- USB: serial: option: add Quectel RM500Q R13 firmware support.
  [Reinhard Speyerer]

  commit 06f22cd6635bdae7d73566fca9879b2026a08e00 upstream.

  Add support for Quectel RM500Q R13 firmware which uses Prot=40 for the
  NMEA port:

  T:  Bus=02 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  8 Spd=5000 MxCh= 0
  D:  Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs=  1
  P:  Vendor=2c7c ProdID=0800 Rev= 4.14
  S:  Manufacturer=Quectel
  S:  Product=RM500Q-AE
  S:  SerialNumber=xxxxxxxx
  C:* #Ifs= 5 Cfg#= 1 Atr=a0 MxPwr=896mA
  I:* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=30 Driver=option
  E:  Ad=81(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=40 Driver=option
  E:  Ad=83(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E:  Ad=85(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
  E:  Ad=84(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=03(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E:  Ad=87(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
  E:  Ad=86(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=04(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi_wwan
  E:  Ad=88(I) Atr=03(Int.) MxPS=   8 Ivl=32ms
  E:  Ad=8e(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=0f(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
- USB: serial: option: add Foxconn T99W265 with new baseline. [Slark
  Xiao]

  commit 13fde9ac23ca8c6d1ac13cc9eefe1f1ac3ee30a4 upstream.

  This ID was added based on latest SDX12 code base line, and we
  made some changes with previous 0489:e0db.

  Test evidence as below:
  T:  Bus=02 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  3 Spd=5000 MxCh= 0
  D:  Ver= 3.20 Cls=ef(misc ) Sub=02 Prot=01 MxPS= 9 #Cfgs=  2
  P:  Vendor=0489 ProdID=e0da Rev=05.04
  S:  Manufacturer=Qualcomm
  S:  Product=Qualcomm Snapdragon X12
  S:  SerialNumber=2bda65fb
  C:  #Ifs= 6 Cfg#= 2 Atr=a0 MxPwr=896mA
  I:  If#=0x0 Alt= 0 #EPs= 1 Cls=02(commc) Sub=0e Prot=00 Driver=cdc_mbim
  I:  If#=0x1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  I:  If#=0x2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=40 Driver=option
  I:  If#=0x3 Alt= 0 #EPs= 1 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
  I:  If#=0x4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=30 Driver=option
  I:  If#=0x5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=42 Prot=01 Driver=(none)

  0&1: MBIM, 2: Modem, 3:GNSS, 4:Diag, 5:ADB
- USB: serial: option: add Quectel EG912Y module support. [Alper Ak]

  commit 6d79d9434c69bb8ffa8a631050eb0ad6b83d3e90 upstream.

  Add Quectel EG912Y "DIAG, AT, MODEM"

  0x6001: ECM / RNDIS + DIAG + AT + MODEM

  T:  Bus=01 Lev=02 Prnt=02 Port=00 Cnt=01 Dev#=  3 Spd=480  MxCh= 0
  D:  Ver= 2.00 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=2c7c ProdID=6001 Rev= 3.18
  S:  Manufacturer=Android
  S:  Product=Android
  S:  SerialNumber=0000
  C:* #Ifs= 5 Cfg#= 1 Atr=e0 MxPwr=500mA
  A:  FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=06 Prot=00
  I:* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=06 Prot=00 Driver=cdc_ether
  E:  Ad=87(I) Atr=03(Int.) MxPS=  64 Ivl=4096ms
  I:  If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc_ether
  I:* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc_ether
  E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=0c(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=0b(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E:  Ad=89(I) Atr=03(Int.) MxPS=  64 Ivl=4096ms
  E:  Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=0f(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E:  Ad=88(I) Atr=03(Int.) MxPS=  64 Ivl=4096ms
  E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=0a(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
- USB: serial: ftdi_sio: update Actisense PIDs constant names. [Mark
  Glover]

  commit 513d88a88e0203188a38f4647dd08170aebd85df upstream.

  Update the constant names for unused USB PIDs (product identifiers) to
  reflect the new products now using the PIDs.
- Wifi: cfg80211: fix certs build to not depend on file order. [Johannes
  Berg]

  commit 3c2a8ebe3fe66a5f77d4c164a0bea8e2ff37b455 upstream.

  The file for the new certificate (Chen-Yu Tsai's) didn't
  end with a comma, so depending on the file order in the
  build rule, we'd end up with invalid C when concatenating
  the (now two) certificates. Fix that.
- Wifi: cfg80211: Add my certificate. [Chen-Yu Tsai]

  commit fb768d3b13ffa325b7e84480d488ac799c9d2cd7 upstream.

  As announced [1][2], I have taken over maintainership of the
  wireless-regdb project.

  Add my certificate so that newer releases are valid to the kernel.
  Seth's certificate should be kept around for awhile, at least until
  a few new releases by me happen.

  This should also be applied to stable trees so that stable kernels
  can utilize newly released database binaries.

  [1] https://lore.kernel.org/linux-wireless/CAGb2v657baNMPKU3QADijx7hZa=GUcSv2LEDdn6N=QQaFX8r-g@mail.gmail.com/
  [2] https://lore.kernel.org/linux-wireless/ZWmRR5ul7EDfxCan@wens.tw/
- Iio: adc: ti_am335x_adc: Fix return value check of tiadc_request_dma()
  [Wadim Egorov]

  commit 60576e84c187043cef11f11d015249e71151d35a upstream.

  Fix wrong handling of a DMA request where the probing only failed
  if -EPROPE_DEFER was returned. Instead, let us fail if a non -ENODEV
  value is returned. This makes DMAs explicitly optional. Even if the
  DMA request is unsuccessfully, the ADC can still work properly.
  We do also handle the defer probe case by making use of dev_err_probe().
- Iio: common: ms_sensors: ms_sensors_i2c: fix humidity conversion time
  table. [Javier Carrasco]

  commit 54cf39ec16335dadbe1ba008d8e5e98dae3e26f8 upstream.

  The HTU21 offers 4 sampling frequencies: 20, 40, 70 and 120, which are
  associated to an index that is used to select the right measurement
  resolution and its corresponding measurement time. The current
  implementation selects the measurement resolution and the temperature
  measurement time properly, but it does not select the right humidity
  measurement time in all cases.

  In summary, the 40 and 70 humidity measurement times are swapped.

  The reason for that is probably the unusual coding for the measurement
  resolution. According to the datasheet, the bits [7,0] of the "user
  register" are used as follows to select the bit resolution:

  --------------------------------------------------
  | Bit 7 | Bit 0 | RH | Temp | Trh (us) | Tt (us) |
  --------------------------------------------------
  |   0   |   0   | 12 |  14  |  16000   |  50000  |
  --------------------------------------------------
  |   0   |   1   | 8  |  12  |  3000    |  13000  |
  --------------------------------------------------
  |   1   |   0   | 10 |  13  |  5000    |  25000  |
  --------------------------------------------------
  |   1   |   1   | 11 |  11  |  8000    |  7000   |
  --------------------------------------------------
  *This table is available in the official datasheet, page 13/21. I have
  just appended the times provided in the humidity/temperature tables,
  pages 3/21, 5/21. Note that always a pair of resolutions is selected.

  The sampling frequencies [20, 40, 70, 120] are assigned to a linear
  index [0..3] which is then coded as follows [1]:

  Index    [7,0]
  --------------
  idx 0     0,0
  idx 1     1,0
  idx 2     0,1
  idx 3     1,1

  That is done that way because the temperature measurements are being
  used as the reference for the sampling frequency (the frequencies and
  the temperature measurement times are correlated), so increasing the
  index always reduces the temperature measurement time and its
  resolution. Therefore, the temperature measurement time array is as
  simple as [50000, 25000, 13000, 7000]

  On the other hand, the humidity resolution cannot follow the same
  pattern because of the way it is coded in the "user register", where
  both resolutions are selected at the same time. The humidity measurement
  time array is the following: [16000, 3000, 5000, 8000], which defines
  the following assignments:

  Index    [7,0]    Trh
  -----------------------
  idx 0     0,0     16000  -> right, [0,0] selects 12 bits (Trh = 16000)
  idx 1     1,0     3000   -> wrong! [1,0] selects 10 bits (Trh = 5000)
  idx 2     0,1     5000   -> wrong! [0,1] selects 8 bits (Trh = 3000)
  idx 3     1,1     8000   -> right, [1,1] selects 11 bits (Trh = 8000)

  The times have been ordered as if idx = 1 -> [0,1] and idx = 2 -> [1,0],
  which is not the case for the reason explained above.

  So a simple modification is required to obtain the right humidity
  measurement time array, swapping the values in the positions 1 and 2.

  The right table should be the following: [16000, 5000, 3000, 8000]

  Fix the humidity measurement time array with the right idex/value
  coding.

  [1] The actual code that makes this coding and assigns it to the current
  value of the "user register" is the following:
  config_reg &= 0x7E;
  config_reg |= ((i & 1) << 7) + ((i & 2) >> 1);
- Scsi: bnx2fc: Fix skb double free in bnx2fc_rcv() [Wei Yongjun]

  [ Upstream commit 08c94d80b2da481652fb633e79cbc41e9e326a91 ]

  skb_share_check() already drops the reference to the skb when returning
  NULL. Using kfree_skb() in the error handling path leads to an skb double
  free.

  Fix this by removing the variable tmp_skb, and return directly when
  skb_share_check() returns NULL.
- Input: ipaq-micro-keys - add error handling for devm_kmemdup. [Haoran
  Liu]

  [ Upstream commit 59b6a747e2d39227ac2325c5e29d6ab3bb070c2a ]

  Check the return value of i2c_add_adapter. Static analysis revealed that
  the function did not properly handle potential failures of
  i2c_add_adapter, which could lead to partial initialization of the I2C
  adapter and unstable operation.
- Iio: imu: inv_mpu6050: fix an error code problem in
  inv_mpu6050_read_raw. [Su Hui]

  [ Upstream commit c3df0e29fb7788c4b3ddf37d5ed87dda2b822943 ]

  inv_mpu6050_sensor_show() can return -EINVAL or IIO_VAL_INT. Return the
  true value rather than only return IIO_VAL_INT.
- Interconnect: Treat xlate() returning NULL node as an error. [Mike
  Tipton]

  [ Upstream commit ad2ab1297d0c80899125a842bb7a078abfe1e6ce ]

  Currently, if provider->xlate() or provider->xlate_extended()
  "successfully" return a NULL node, then of_icc_get_from_provider() won't
  consider that an error and will successfully return the NULL node. This
  bypasses error handling in of_icc_get_by_index() and leads to NULL
  dereferences in path_find().

  This could be avoided by ensuring provider callbacks always return an
  error for NULL nodes, but it's better to explicitly protect against this
  in the common framework.
- Btrfs: do not allow non subvolume root targets for snapshot. [Josef
  Bacik]

  [ Upstream commit a8892fd71933126ebae3d60aec5918d4dceaae76 ]

  Our btrfs subvolume snapshot <source> <destination> utility enforces
  that <source> is the root of the subvolume, however this isn't enforced
  in the kernel.  Update the kernel to also enforce this limitation to
  avoid problems with other users of this ioctl that don't have the
  appropriate checks in place.
- Smb: client: fix NULL deref in asn1_ber_decoder() [Paulo Alcantara]

  [ Upstream commit 90d025c2e953c11974e76637977c473200593a46 ]

  If server replied SMB2_NEGOTIATE with a zero SecurityBufferOffset,
  smb2_get_data_area() sets @len to non-zero but return NULL, so
  decode_negTokeninit() ends up being called with a NULL @security_blob:

    BUG: kernel NULL pointer dereference, address: 0000000000000000
    #PF: supervisor read access in kernel mode
    #PF: error_code(0x0000) - not-present page
    PGD 0 P4D 0
    Oops: 0000 [#1] PREEMPT SMP NOPTI
    CPU: 2 PID: 871 Comm: mount.cifs Not tainted 6.7.0-rc4 #2
    Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.2-3-gd478f380-rebuilt.opensuse.org 04/01/2014
    RIP: 0010:asn1_ber_decoder+0x173/0xc80
    Code: 01 4c 39 2c 24 75 09 45 84 c9 0f 85 2f 03 00 00 48 8b 14 24 4c 29 ea 48 83 fa 01 0f 86 1e 07 00 00 48 8b 74 24 28 4d 8d 5d 01 <42> 0f b6 3c 2e 89 fa 40 88 7c 24 5c f7 d2 83 e2 1f 0f 84 3d 07 00
    RSP: 0018:ffffc9000063f950 EFLAGS: 00010202
    RAX: 0000000000000002 RBX: 0000000000000000 RCX: 000000000000004a
    RDX: 000000000000004a RSI: 0000000000000000 RDI: 0000000000000000
    RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
    R10: 0000000000000002 R11: 0000000000000001 R12: 0000000000000000
    R13: 0000000000000000 R14: 000000000000004d R15: 0000000000000000
    FS:  00007fce52b0fbc0(0000) GS:ffff88806ba00000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 0000000000000000 CR3: 000000001ae64000 CR4: 0000000000750ef0
    PKRU: 55555554
    Call Trace:
     <TASK>
     ? __die+0x23/0x70
     ? page_fault_oops+0x181/0x480
     ? __stack_depot_save+0x1e6/0x480
     ? exc_page_fault+0x6f/0x1c0
     ? asm_exc_page_fault+0x26/0x30
     ? asn1_ber_decoder+0x173/0xc80
     ? check_object+0x40/0x340
     decode_negTokenInit+0x1e/0x30 [cifs]
     SMB2_negotiate+0xc99/0x17c0 [cifs]
     ? smb2_negotiate+0x46/0x60 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     smb2_negotiate+0x46/0x60 [cifs]
     cifs_negotiate_protocol+0xae/0x130 [cifs]
     cifs_get_smb_ses+0x517/0x1040 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? queue_delayed_work_on+0x5d/0x90
     cifs_mount_get_session+0x78/0x200 [cifs]
     dfs_mount_share+0x13a/0x9f0 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? lock_acquire+0xbf/0x2b0
     ? find_nls+0x16/0x80
     ? srso_alias_return_thunk+0x5/0xfbef5
     cifs_mount+0x7e/0x350 [cifs]
     cifs_smb3_do_mount+0x128/0x780 [cifs]
     smb3_get_tree+0xd9/0x290 [cifs]
     vfs_get_tree+0x2c/0x100
     ? capable+0x37/0x70
     path_mount+0x2d7/0xb80
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? _raw_spin_unlock_irqrestore+0x44/0x60
     __x64_sys_mount+0x11a/0x150
     do_syscall_64+0x47/0xf0
     entry_SYSCALL_64_after_hwframe+0x6f/0x77
    RIP: 0033:0x7fce52c2ab1e

  Fix this by setting @len to zero when @off == 0 so callers won't
  attempt to dereference non-existing data areas.
- ALSA: hda/hdmi: add force-connect quirk for NUC5CPYB. [Kai Vehmanen]

  [ Upstream commit 3b1ff57e24a7bcd2e2a8426dd2013a80d1fa96eb ]

  Add one more older NUC model that requires quirk to force all pins to be
  connected. The display codec pins are not registered properly without
  the force-connect quirk. The codec will report only one pin as having
  external connectivity, but i915 finds all three connectors on the
  system, so the two drivers are not in sync.

  Issue found with DRM igt-gpu-tools test kms_hdmi_inject@inject-audio.
- ALSA: hda/hdmi: Add quirk to force pin connectivity on NUC10. [Kai
  Vehmanen]

  [ Upstream commit e81d71e343c6c62cf323042caed4b7ca049deda5 ]

  On some Intel NUC10 variants, codec reports AC_JACK_PORT_NONE as
  pin default config for all pins. This results in broken audio.
  Add a quirk to force connectivity.
- Pinctrl: at91-pio4: use dedicated lock class for IRQ. [Alexis Lothoré]

  [ Upstream commit 14694179e561b5f2f7e56a0f590e2cb49a9cc7ab ]

  Trying to suspend to RAM on SAMA5D27 EVK leads to the following lockdep
  warning:

   ============================================
   WARNING: possible recursive locking detected
   6.7.0-rc5-wt+ #532 Not tainted
   --------------------------------------------
   sh/92 is trying to acquire lock:
   c3cf306c (&irq_desc_lock_class){-.-.}-{2:2}, at: __irq_get_desc_lock+0xe8/0x100

   but task is already holding lock:
   c3d7c46c (&irq_desc_lock_class){-.-.}-{2:2}, at: __irq_get_desc_lock+0xe8/0x100

   other info that might help us debug this:
    Possible unsafe locking scenario:

          CPU0
          ----
     lock(&irq_desc_lock_class);
     lock(&irq_desc_lock_class);

    *** DEADLOCK ***

    May be due to missing lock nesting notation

   6 locks held by sh/92:
    #0: c3aa0258 (sb_writers#6){.+.+}-{0:0}, at: ksys_write+0xd8/0x178
    #1: c4c2df44 (&of->mutex){+.+.}-{3:3}, at: kernfs_fop_write_iter+0x138/0x284
    #2: c32684a0 (kn->active){.+.+}-{0:0}, at: kernfs_fop_write_iter+0x148/0x284
    #3: c232b6d4 (system_transition_mutex){+.+.}-{3:3}, at: pm_suspend+0x13c/0x4e8
    #4: c387b088 (&dev->mutex){....}-{3:3}, at: __device_suspend+0x1e8/0x91c
    #5: c3d7c46c (&irq_desc_lock_class){-.-.}-{2:2}, at: __irq_get_desc_lock+0xe8/0x100

   stack backtrace:
   CPU: 0 PID: 92 Comm: sh Not tainted 6.7.0-rc5-wt+ #532
   Hardware name: Atmel SAMA5
    unwind_backtrace from show_stack+0x18/0x1c
    show_stack from dump_stack_lvl+0x34/0x48
    dump_stack_lvl from __lock_acquire+0x19ec/0x3a0c
    __lock_acquire from lock_acquire.part.0+0x124/0x2d0
    lock_acquire.part.0 from _raw_spin_lock_irqsave+0x5c/0x78
    _raw_spin_lock_irqsave from __irq_get_desc_lock+0xe8/0x100
    __irq_get_desc_lock from irq_set_irq_wake+0xa8/0x204
    irq_set_irq_wake from atmel_gpio_irq_set_wake+0x58/0xb4
    atmel_gpio_irq_set_wake from irq_set_irq_wake+0x100/0x204
    irq_set_irq_wake from gpio_keys_suspend+0xec/0x2b8
    gpio_keys_suspend from dpm_run_callback+0xe4/0x248
    dpm_run_callback from __device_suspend+0x234/0x91c
    __device_suspend from dpm_suspend+0x224/0x43c
    dpm_suspend from dpm_suspend_start+0x9c/0xa8
    dpm_suspend_start from suspend_devices_and_enter+0x1e0/0xa84
    suspend_devices_and_enter from pm_suspend+0x460/0x4e8
    pm_suspend from state_store+0x78/0xe4
    state_store from kernfs_fop_write_iter+0x1a0/0x284
    kernfs_fop_write_iter from vfs_write+0x38c/0x6f4
    vfs_write from ksys_write+0xd8/0x178
    ksys_write from ret_fast_syscall+0x0/0x1c
   Exception stack(0xc52b3fa8 to 0xc52b3ff0)
   3fa0:                   00000004 005a0ae8 00000001 005a0ae8 00000004 00000001
   3fc0: 00000004 005a0ae8 00000001 00000004 00000004 b6c616c0 00000020 0059d190
   3fe0: 00000004 b6c61678 aec5a041 aebf1a26

  This warning is raised because pinctrl-at91-pio4 uses chained IRQ. Whenever
  a wake up source configures an IRQ through irq_set_irq_wake, it will
  lock the corresponding IRQ desc, and then call irq_set_irq_wake on "parent"
  IRQ which will do the same on its own IRQ desc, but since those two locks
  share the same class, lockdep reports this as an issue.

  Fix lockdep false positive by setting a different class for parent and
  children IRQ
- I2c: aspeed: Handle the coalesced stop conditions with the start
  conditions. [Quan Nguyen]

  [ Upstream commit b4cc1cbba5195a4dd497cf2f8f09e7807977d543 ]

  Some masters may drive the transfers with low enough latency between
  the nak/stop phase of the current command and the start/address phase
  of the following command that the interrupts are coalesced by the
  time we process them.
  Handle the stop conditions before processing SLAVE_MATCH to fix the
  complaints that sometimes occur below.

  "aspeed-i2c-bus 1e78a040.i2c-bus: irq handled != irq. Expected
  0x00000086, but was 0x00000084"
- Afs: Fix overwriting of result of DNS query. [David Howells]

  [ Upstream commit a9e01ac8c5ff32669119c40dfdc9e80eb0b7d7aa ]

  In afs_update_cell(), ret is the result of the DNS lookup and the errors
  are to be handled by a switch - however, the value gets clobbered in
  between by setting it to -ENOMEM in case afs_alloc_vlserver_list()
  fails.

  Fix this by moving the setting of -ENOMEM into the error handling for
  OOM failure.  Further, only do it if we don't have an alternative error
  to return.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.  Based
  on a patch from Anastasia Belova [1].

  Fixes: d5c32c89b208 ("afs: Fix cell DNS lookup")
  Signed-off-by: David Howells <dhowells@redhat.com>
  Reviewed-by: Jeffrey Altman <jaltman@auristor.com>
  cc: Anastasia Belova <abelova@astralinux.ru>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
  cc: lvc-project@linuxtesting.org
- Keys, dns: Allow key types (eg. DNS) to be reclaimed immediately on
  expiry. [David Howells]

  [ Upstream commit 39299bdd2546688d92ed9db4948f6219ca1b9542 ]

  If a key has an expiration time, then when that time passes, the key is
  left around for a certain amount of time before being collected (5 mins by
  default) so that EKEYEXPIRED can be returned instead of ENOKEY.  This is a
  problem for DNS keys because we want to redo the DNS lookup immediately at
  that point.

  Fix this by allowing key types to be marked such that keys of that type
  don't have this extra period, but are reclaimed as soon as they expire and
  turn this on for dns_resolver-type keys.  To make this easier to handle,
  key->expiry is changed to be permanent if TIME64_MAX rather than 0.

  Furthermore, give such new-style negative DNS results a 1s default expiry
  if no other expiry time is set rather than allowing it to stick around
  indefinitely.  This shouldn't be zero as ls will follow a failing stat call
  immediately with a second with AT_SYMLINK_NOFOLLOW added.

  Fixes: 1a4240f4764a ("DNS: Separate out CIFS DNS Resolver code")
  Signed-off-by: David Howells <dhowells@redhat.com>
  Tested-by: Markus Suvanto <markus.suvanto@gmail.com>
  cc: Wang Lei <wang840925@gmail.com>
  cc: Jeff Layton <jlayton@redhat.com>
  cc: Steve French <smfrench@gmail.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: Jarkko Sakkinen <jarkko@kernel.org>
  cc: "David S. Miller" <davem@davemloft.net>
  cc: Eric Dumazet <edumazet@google.com>
  cc: Jakub Kicinski <kuba@kernel.org>
  cc: Paolo Abeni <pabeni@redhat.com>
  cc: linux-afs@lists.infradead.org
  cc: linux-cifs@vger.kernel.org
  cc: linux-nfs@vger.kernel.org
  cc: ceph-devel@vger.kernel.org
  cc: keyrings@vger.kernel.org
  cc: netdev@vger.kernel.org
- Net: check dev->gso_max_size in gso_features_check() [Eric Dumazet]

  [ Upstream commit 24ab059d2ebd62fdccc43794796f6ffbabe49ebc ]

  Some drivers might misbehave if TSO packets get too big.

  GVE for instance uses a 16bit field in its TX descriptor,
  and will do bad things if a packet is bigger than 2^16 bytes.

  Linux TCP stack honors dev->gso_max_size, but there are
  other ways for too big packets to reach an ndo_start_xmit()
  handler : virtio_net, af_packet, GRO...

  Add a generic check in gso_features_check() and fallback
  to GSO when needed.

  gso_max_size was added in the blamed commit.
- Net: warn if gso_type isn't set for a GSO SKB. [Heiner Kallweit]

  [ Upstream commit 1d155dfdf50efc2b0793bce93c06d1a5b23d0877 ]

  In bug report [0] a warning in r8169 driver was reported that was
  caused by an invalid GSO SKB (gso_type was 0). See [1] for a discussion
  about this issue. Still the origin of the invalid GSO SKB isn't clear.

  It shouldn't be a network drivers task to check for invalid GSO SKB's.
  Also, even if issue [0] can be fixed, we can't be sure that a
  similar issue doesn't pop up again at another place.
  Therefore let gso_features_check() check for such invalid GSO SKB's.

  [0] https://bugzilla.kernel.org/show_bug.cgi?id=209423
  [1] https://www.spinics.net/lists/netdev/msg690794.html
- Afs: Fix dynamic root lookup DNS check. [David Howells]

  [ Upstream commit 74cef6872ceaefb5b6c5c60641371ea28702d358 ]

  In the afs dynamic root directory, the ->lookup() function does a DNS check
  on the cell being asked for and if the DNS upcall reports an error it will
  report an error back to userspace (typically ENOENT).

  However, if a failed DNS upcall returns a new-style result, it will return
  a valid result, with the status field set appropriately to indicate the
  type of failure - and in that case, dns_query() doesn't return an error and
  we let stat() complete with no error - which can cause confusion in
  userspace as subsequent calls that trigger d_automount then fail with
  ENOENT.

  Fix this by checking the status result from a valid dns_query() and
  returning an error if it indicates a failure.

  Fixes: bbb4c4323a4d ("dns: Allow the dns resolver to retrieve a server set")
  Reported-by: Markus Suvanto <markus.suvanto@gmail.com>
  Closes: https://bugzilla.kernel.org/show_bug.cgi?id=216637
  Signed-off-by: David Howells <dhowells@redhat.com>
  Tested-by: Markus Suvanto <markus.suvanto@gmail.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Afs: Fix the dynamic root's d_delete to always delete unused dentries.
  [David Howells]

  [ Upstream commit 71f8b55bc30e82d6355e07811213d847981a32e2 ]

  Fix the afs dynamic root's d_delete function to always delete unused
  dentries rather than only deleting them if they're positive.  With things
  as they stand upstream, negative dentries stemming from failed DNS lookups
  stick around preventing retries.

  Fixes: 66c7e1d319a5 ("afs: Split the dynroot stuff out and give it its own ops tables")
  Signed-off-by: David Howells <dhowells@redhat.com>
  Tested-by: Markus Suvanto <markus.suvanto@gmail.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Net: check vlan filter feature in vlan_vids_add_by_dev() and
  vlan_vids_del_by_dev() [Liu Jian]

  [ Upstream commit 01a564bab4876007ce35f312e16797dfe40e4823 ]

  I got the below warning trace:

  WARNING: CPU: 4 PID: 4056 at net/core/dev.c:11066 unregister_netdevice_many_notify
  CPU: 4 PID: 4056 Comm: ip Not tainted 6.7.0-rc4+ #15
  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
  RIP: 0010:unregister_netdevice_many_notify+0x9a4/0x9b0
  Call Trace:
   rtnl_dellink
   rtnetlink_rcv_msg
   netlink_rcv_skb
   netlink_unicast
   netlink_sendmsg
   __sock_sendmsg
   ____sys_sendmsg
   ___sys_sendmsg
   __sys_sendmsg
   do_syscall_64
   entry_SYSCALL_64_after_hwframe

  It can be repoduced via:

      ip netns add ns1
      ip netns exec ns1 ip link add bond0 type bond mode 0
      ip netns exec ns1 ip link add bond_slave_1 type veth peer veth2
      ip netns exec ns1 ip link set bond_slave_1 master bond0
  [1] ip netns exec ns1 ethtool -K bond0 rx-vlan-filter off
  [2] ip netns exec ns1 ip link add link bond_slave_1 name bond_slave_1.0 type vlan id 0
  [3] ip netns exec ns1 ip link add link bond0 name bond0.0 type vlan id 0
  [4] ip netns exec ns1 ip link set bond_slave_1 nomaster
  [5] ip netns exec ns1 ip link del veth2
      ip netns del ns1

  This is all caused by command [1] turning off the rx-vlan-filter function
  of bond0. The reason is the same as commit 01f4fd270870 ("bonding: Fix
  incorrect deletion of ETH_P_8021AD protocol vid from slaves"). Commands
  [2] [3] add the same vid to slave and master respectively, causing
  command [4] to empty slave->vlan_info. The following command [5] triggers
  this problem.

  To fix this problem, we should add VLAN_FILTER feature checks in
  vlan_vids_add_by_dev() and vlan_vids_del_by_dev() to prevent incorrect
  addition or deletion of vlan_vid information.
- Net/rose: fix races in rose_kill_by_device() [Eric Dumazet]

  [ Upstream commit 64b8bc7d5f1434c636a40bdcfcd42b278d1714be ]

  syzbot found an interesting netdev refcounting issue in
  net/rose/af_rose.c, thanks to CONFIG_NET_DEV_REFCNT_TRACKER=y [1]

  Problem is that rose_kill_by_device() can change rose->device
  while other threads do not expect the pointer to be changed.

  We have to first collect sockets in a temporary array,
  then perform the changes while holding the socket
  lock and rose_list_lock spinlock (in this order)

  Change rose_release() to also acquire rose_list_lock
  before releasing the netdev refcount.

  [1]

  [ 1185.055088][ T7889] ref_tracker: reference already released.
  [ 1185.061476][ T7889] ref_tracker: allocated in:
  [ 1185.066081][ T7889]  rose_bind+0x4ab/0xd10
  [ 1185.070446][ T7889]  __sys_bind+0x1ec/0x220
  [ 1185.074818][ T7889]  __x64_sys_bind+0x72/0xb0
  [ 1185.079356][ T7889]  do_syscall_64+0x40/0x110
  [ 1185.083897][ T7889]  entry_SYSCALL_64_after_hwframe+0x63/0x6b
  [ 1185.089835][ T7889] ref_tracker: freed in:
  [ 1185.094088][ T7889]  rose_release+0x2f5/0x570
  [ 1185.098629][ T7889]  __sock_release+0xae/0x260
  [ 1185.103262][ T7889]  sock_close+0x1c/0x20
  [ 1185.107453][ T7889]  __fput+0x270/0xbb0
  [ 1185.111467][ T7889]  task_work_run+0x14d/0x240
  [ 1185.116085][ T7889]  get_signal+0x106f/0x2790
  [ 1185.120622][ T7889]  arch_do_signal_or_restart+0x90/0x7f0
  [ 1185.126205][ T7889]  exit_to_user_mode_prepare+0x121/0x240
  [ 1185.131846][ T7889]  syscall_exit_to_user_mode+0x1e/0x60
  [ 1185.137293][ T7889]  do_syscall_64+0x4d/0x110
  [ 1185.141783][ T7889]  entry_SYSCALL_64_after_hwframe+0x63/0x6b
  [ 1185.148085][ T7889] ------------[ cut here ]------------

  WARNING: CPU: 1 PID: 7889 at lib/ref_tracker.c:255 ref_tracker_free+0x61a/0x810 lib/ref_tracker.c:255
  Modules linked in:
  CPU: 1 PID: 7889 Comm: syz-executor.2 Not tainted 6.7.0-rc4-syzkaller-00162-g65c95f78917e #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 11/10/2023
  RIP: 0010:ref_tracker_free+0x61a/0x810 lib/ref_tracker.c:255
  Code: 00 44 8b 6b 18 31 ff 44 89 ee e8 21 62 f5 fc 45 85 ed 0f 85 a6 00 00 00 e8 a3 66 f5 fc 48 8b 34 24 48 89 ef e8 27 5f f1 05 90 <0f> 0b 90 bb ea ff ff ff e9 52 fd ff ff e8 84 66 f5 fc 4c 8d 6d 44
  RSP: 0018:ffffc90004917850 EFLAGS: 00010202
  RAX: 0000000000000201 RBX: ffff88802618f4c0 RCX: 0000000000000000
  RDX: 0000000000000202 RSI: ffffffff8accb920 RDI: 0000000000000001
  RBP: ffff8880269ea5b8 R08: 0000000000000001 R09: fffffbfff23e35f6
  R10: ffffffff91f1afb7 R11: 0000000000000001 R12: 1ffff92000922f0c
  R13: 0000000005a2039b R14: ffff88802618f4d8 R15: 00000000ffffffff
  FS: 00007f0a720ef6c0(0000) GS:ffff8880b9900000(0000) knlGS:0000000000000000
  CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 00007f43a819d988 CR3: 0000000076c64000 CR4: 00000000003506f0
  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  Call Trace:
  <TASK>
  netdev_tracker_free include/linux/netdevice.h:4127 [inline]
  netdev_put include/linux/netdevice.h:4144 [inline]
  netdev_put include/linux/netdevice.h:4140 [inline]
  rose_kill_by_device net/rose/af_rose.c:195 [inline]
  rose_device_event+0x25d/0x330 net/rose/af_rose.c:218
  notifier_call_chain+0xb6/0x3b0 kernel/notifier.c:93
  call_netdevice_notifiers_info+0xbe/0x130 net/core/dev.c:1967
  call_netdevice_notifiers_extack net/core/dev.c:2005 [inline]
  call_netdevice_notifiers net/core/dev.c:2019 [inline]
  __dev_notify_flags+0x1f5/0x2e0 net/core/dev.c:8646
  dev_change_flags+0x122/0x170 net/core/dev.c:8682
  dev_ifsioc+0x9ad/0x1090 net/core/dev_ioctl.c:529
  dev_ioctl+0x224/0x1090 net/core/dev_ioctl.c:786
  sock_do_ioctl+0x198/0x270 net/socket.c:1234
  sock_ioctl+0x22e/0x6b0 net/socket.c:1339
  vfs_ioctl fs/ioctl.c:51 [inline]
  __do_sys_ioctl fs/ioctl.c:871 [inline]
  __se_sys_ioctl fs/ioctl.c:857 [inline]
  __x64_sys_ioctl+0x18f/0x210 fs/ioctl.c:857
  do_syscall_x64 arch/x86/entry/common.c:52 [inline]
  do_syscall_64+0x40/0x110 arch/x86/entry/common.c:83
  entry_SYSCALL_64_after_hwframe+0x63/0x6b
  RIP: 0033:0x7f0a7147cba9
  Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 e1 20 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
  RSP: 002b:00007f0a720ef0c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010
  RAX: ffffffffffffffda RBX: 00007f0a7159bf80 RCX: 00007f0a7147cba9
  RDX: 0000000020000040 RSI: 0000000000008914 RDI: 0000000000000004
  RBP: 00007f0a714c847a R08: 0000000000000000 R09: 0000000000000000
  R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
  R13: 000000000000000b R14: 00007f0a7159bf80 R15: 00007ffc8bb3a5f8
  </TASK>
- Ethernet: atheros: fix a memleak in atl1e_setup_ring_resources.
  [Zhipeng Lu]

  [ Upstream commit 309fdb1c33fe726d92d0030481346f24e1b01f07 ]

  In the error handling of 'offset > adapter->ring_size', the
  tx_ring->tx_buffer allocated by kzalloc should be freed,
  instead of 'goto failed' instantly.
- Net: sched: ife: fix potential use-after-free. [Eric Dumazet]

  [ Upstream commit 19391a2ca98baa7b80279306cdf7dd43f81fa595 ]

  ife_decode() calls pskb_may_pull() two times, we need to reload
  ifehdr after the second one, or risk use-after-free as reported
  by syzbot:

  BUG: KASAN: slab-use-after-free in __ife_tlv_meta_valid net/ife/ife.c:108 [inline]
  BUG: KASAN: slab-use-after-free in ife_tlv_meta_decode+0x1d1/0x210 net/ife/ife.c:131
  Read of size 2 at addr ffff88802d7300a4 by task syz-executor.5/22323

  CPU: 0 PID: 22323 Comm: syz-executor.5 Not tainted 6.7.0-rc3-syzkaller-00804-g074ac38d5b95 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 11/10/2023
  Call Trace:
  <TASK>
  __dump_stack lib/dump_stack.c:88 [inline]
  dump_stack_lvl+0xd9/0x1b0 lib/dump_stack.c:106
  print_address_description mm/kasan/report.c:364 [inline]
  print_report+0xc4/0x620 mm/kasan/report.c:475
  kasan_report+0xda/0x110 mm/kasan/report.c:588
  __ife_tlv_meta_valid net/ife/ife.c:108 [inline]
  ife_tlv_meta_decode+0x1d1/0x210 net/ife/ife.c:131
  tcf_ife_decode net/sched/act_ife.c:739 [inline]
  tcf_ife_act+0x4e3/0x1cd0 net/sched/act_ife.c:879
  tc_act include/net/tc_wrapper.h:221 [inline]
  tcf_action_exec+0x1ac/0x620 net/sched/act_api.c:1079
  tcf_exts_exec include/net/pkt_cls.h:344 [inline]
  mall_classify+0x201/0x310 net/sched/cls_matchall.c:42
  tc_classify include/net/tc_wrapper.h:227 [inline]
  __tcf_classify net/sched/cls_api.c:1703 [inline]
  tcf_classify+0x82f/0x1260 net/sched/cls_api.c:1800
  hfsc_classify net/sched/sch_hfsc.c:1147 [inline]
  hfsc_enqueue+0x315/0x1060 net/sched/sch_hfsc.c:1546
  dev_qdisc_enqueue+0x3f/0x230 net/core/dev.c:3739
  __dev_xmit_skb net/core/dev.c:3828 [inline]
  __dev_queue_xmit+0x1de1/0x3d30 net/core/dev.c:4311
  dev_queue_xmit include/linux/netdevice.h:3165 [inline]
  packet_xmit+0x237/0x350 net/packet/af_packet.c:276
  packet_snd net/packet/af_packet.c:3081 [inline]
  packet_sendmsg+0x24aa/0x5200 net/packet/af_packet.c:3113
  sock_sendmsg_nosec net/socket.c:730 [inline]
  __sock_sendmsg+0xd5/0x180 net/socket.c:745
  __sys_sendto+0x255/0x340 net/socket.c:2190
  __do_sys_sendto net/socket.c:2202 [inline]
  __se_sys_sendto net/socket.c:2198 [inline]
  __x64_sys_sendto+0xe0/0x1b0 net/socket.c:2198
  do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  do_syscall_64+0x40/0x110 arch/x86/entry/common.c:82
  entry_SYSCALL_64_after_hwframe+0x63/0x6b
  RIP: 0033:0x7fe9acc7cae9
  Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 e1 20 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
  RSP: 002b:00007fe9ada450c8 EFLAGS: 00000246 ORIG_RAX: 000000000000002c
  RAX: ffffffffffffffda RBX: 00007fe9acd9bf80 RCX: 00007fe9acc7cae9
  RDX: 000000000000fce0 RSI: 00000000200002c0 RDI: 0000000000000003
  RBP: 00007fe9accc847a R08: 0000000020000140 R09: 0000000000000014
  R10: 0000000000000004 R11: 0000000000000246 R12: 0000000000000000
  R13: 000000000000000b R14: 00007fe9acd9bf80 R15: 00007ffd5427ae78
  </TASK>

  Allocated by task 22323:
  kasan_save_stack+0x33/0x50 mm/kasan/common.c:45
  kasan_set_track+0x25/0x30 mm/kasan/common.c:52
  ____kasan_kmalloc mm/kasan/common.c:374 [inline]
  __kasan_kmalloc+0xa2/0xb0 mm/kasan/common.c:383
  kasan_kmalloc include/linux/kasan.h:198 [inline]
  __do_kmalloc_node mm/slab_common.c:1007 [inline]
  __kmalloc_node_track_caller+0x5a/0x90 mm/slab_common.c:1027
  kmalloc_reserve+0xef/0x260 net/core/skbuff.c:582
  __alloc_skb+0x12b/0x330 net/core/skbuff.c:651
  alloc_skb include/linux/skbuff.h:1298 [inline]
  alloc_skb_with_frags+0xe4/0x710 net/core/skbuff.c:6331
  sock_alloc_send_pskb+0x7e4/0x970 net/core/sock.c:2780
  packet_alloc_skb net/packet/af_packet.c:2930 [inline]
  packet_snd net/packet/af_packet.c:3024 [inline]
  packet_sendmsg+0x1e2a/0x5200 net/packet/af_packet.c:3113
  sock_sendmsg_nosec net/socket.c:730 [inline]
  __sock_sendmsg+0xd5/0x180 net/socket.c:745
  __sys_sendto+0x255/0x340 net/socket.c:2190
  __do_sys_sendto net/socket.c:2202 [inline]
  __se_sys_sendto net/socket.c:2198 [inline]
  __x64_sys_sendto+0xe0/0x1b0 net/socket.c:2198
  do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  do_syscall_64+0x40/0x110 arch/x86/entry/common.c:82
  entry_SYSCALL_64_after_hwframe+0x63/0x6b

  Freed by task 22323:
  kasan_save_stack+0x33/0x50 mm/kasan/common.c:45
  kasan_set_track+0x25/0x30 mm/kasan/common.c:52
  kasan_save_free_info+0x2b/0x40 mm/kasan/generic.c:522
  ____kasan_slab_free mm/kasan/common.c:236 [inline]
  ____kasan_slab_free+0x15b/0x1b0 mm/kasan/common.c:200
  kasan_slab_free include/linux/kasan.h:164 [inline]
  slab_free_hook mm/slub.c:1800 [inline]
  slab_free_freelist_hook+0x114/0x1e0 mm/slub.c:1826
  slab_free mm/slub.c:3809 [inline]
  __kmem_cache_free+0xc0/0x180 mm/slub.c:3822
  skb_kfree_head net/core/skbuff.c:950 [inline]
  skb_free_head+0x110/0x1b0 net/core/skbuff.c:962
  pskb_expand_head+0x3c5/0x1170 net/core/skbuff.c:2130
  __pskb_pull_tail+0xe1/0x1830 net/core/skbuff.c:2655
  pskb_may_pull_reason include/linux/skbuff.h:2685 [inline]
  pskb_may_pull include/linux/skbuff.h:2693 [inline]
  ife_decode+0x394/0x4f0 net/ife/ife.c:82
  tcf_ife_decode net/sched/act_ife.c:727 [inline]
  tcf_ife_act+0x43b/0x1cd0 net/sched/act_ife.c:879
  tc_act include/net/tc_wrapper.h:221 [inline]
  tcf_action_exec+0x1ac/0x620 net/sched/act_api.c:1079
  tcf_exts_exec include/net/pkt_cls.h:344 [inline]
  mall_classify+0x201/0x310 net/sched/cls_matchall.c:42
  tc_classify include/net/tc_wrapper.h:227 [inline]
  __tcf_classify net/sched/cls_api.c:1703 [inline]
  tcf_classify+0x82f/0x1260 net/sched/cls_api.c:1800
  hfsc_classify net/sched/sch_hfsc.c:1147 [inline]
  hfsc_enqueue+0x315/0x1060 net/sched/sch_hfsc.c:1546
  dev_qdisc_enqueue+0x3f/0x230 net/core/dev.c:3739
  __dev_xmit_skb net/core/dev.c:3828 [inline]
  __dev_queue_xmit+0x1de1/0x3d30 net/core/dev.c:4311
  dev_queue_xmit include/linux/netdevice.h:3165 [inline]
  packet_xmit+0x237/0x350 net/packet/af_packet.c:276
  packet_snd net/packet/af_packet.c:3081 [inline]
  packet_sendmsg+0x24aa/0x5200 net/packet/af_packet.c:3113
  sock_sendmsg_nosec net/socket.c:730 [inline]
  __sock_sendmsg+0xd5/0x180 net/socket.c:745
  __sys_sendto+0x255/0x340 net/socket.c:2190
  __do_sys_sendto net/socket.c:2202 [inline]
  __se_sys_sendto net/socket.c:2198 [inline]
  __x64_sys_sendto+0xe0/0x1b0 net/socket.c:2198
  do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  do_syscall_64+0x40/0x110 arch/x86/entry/common.c:82
  entry_SYSCALL_64_after_hwframe+0x63/0x6b

  The buggy address belongs to the object at ffff88802d730000
  which belongs to the cache kmalloc-8k of size 8192
  The buggy address is located 164 bytes inside of
  freed 8192-byte region [ffff88802d730000, ffff88802d732000)

  The buggy address belongs to the physical page:
  page:ffffea0000b5cc00 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x2d730
  head:ffffea0000b5cc00 order:3 entire_mapcount:0 nr_pages_mapped:0 pincount:0
  flags: 0xfff00000000840(slab|head|node=0|zone=1|lastcpupid=0x7ff)
  page_type: 0xffffffff()
  raw: 00fff00000000840 ffff888013042280 dead000000000122 0000000000000000
  raw: 0000000000000000 0000000080020002 00000001ffffffff 0000000000000000
  page dumped because: kasan: bad access detected
  page_owner tracks the page as allocated
  page last allocated via order 3, migratetype Unmovable, gfp_mask 0x1d20c0(__GFP_IO|__GFP_FS|__GFP_NOWARN|__GFP_NORETRY|__GFP_COMP|__GFP_NOMEMALLOC|__GFP_HARDWALL), pid 22323, tgid 22320 (syz-executor.5), ts 950317230369, free_ts 950233467461
  set_page_owner include/linux/page_owner.h:31 [inline]
  post_alloc_hook+0x2d0/0x350 mm/page_alloc.c:1544
  prep_new_page mm/page_alloc.c:1551 [inline]
  get_page_from_freelist+0xa28/0x3730 mm/page_alloc.c:3319
  __alloc_pages+0x22e/0x2420 mm/page_alloc.c:4575
  alloc_pages_mpol+0x258/0x5f0 mm/mempolicy.c:2133
  alloc_slab_page mm/slub.c:1870 [inline]
  allocate_slab mm/slub.c:2017 [inline]
  new_slab+0x283/0x3c0 mm/slub.c:2070
  ___slab_alloc+0x979/0x1500 mm/slub.c:3223
  __slab_alloc.constprop.0+0x56/0xa0 mm/slub.c:3322
  __slab_alloc_node mm/slub.c:3375 [inline]
  slab_alloc_node mm/slub.c:3468 [inline]
  __kmem_cache_alloc_node+0x131/0x310 mm/slub.c:3517
  __do_kmalloc_node mm/slab_common.c:1006 [inline]
  __kmalloc_node_track_caller+0x4a/0x90 mm/slab_common.c:1027
  kmalloc_reserve+0xef/0x260 net/core/skbuff.c:582
  __alloc_skb+0x12b/0x330 net/core/skbuff.c:651
  alloc_skb include/linux/skbuff.h:1298 [inline]
  alloc_skb_with_frags+0xe4/0x710 net/core/skbuff.c:6331
  sock_alloc_send_pskb+0x7e4/0x970 net/core/sock.c:2780
  packet_alloc_skb net/packet/af_packet.c:2930 [inline]
  packet_snd net/packet/af_packet.c:3024 [inline]
  packet_sendmsg+0x1e2a/0x5200 net/packet/af_packet.c:3113
  sock_sendmsg_nosec net/socket.c:730 [inline]
  __sock_sendmsg+0xd5/0x180 net/socket.c:745
  __sys_sendto+0x255/0x340 net/socket.c:2190
  page last free stack trace:
  reset_page_owner include/linux/page_owner.h:24 [inline]
  free_pages_prepare mm/page_alloc.c:1144 [inline]
  free_unref_page_prepare+0x53c/0xb80 mm/page_alloc.c:2354
  free_unref_page+0x33/0x3b0 mm/page_alloc.c:2494
  __unfreeze_partials+0x226/0x240 mm/slub.c:2655
  qlink_free mm/kasan/quarantine.c:168 [inline]
  qlist_free_all+0x6a/0x170 mm/kasan/quarantine.c:187
  kasan_quarantine_reduce+0x18e/0x1d0 mm/kasan/quarantine.c:294
  __kasan_slab_alloc+0x65/0x90 mm/kasan/common.c:305
  kasan_slab_alloc include/linux/kasan.h:188 [inline]
  slab_post_alloc_hook mm/slab.h:763 [inline]
  slab_alloc_node mm/slub.c:3478 [inline]
  slab_alloc mm/slub.c:3486 [inline]
  __kmem_cache_alloc_lru mm/slub.c:3493 [inline]
  kmem_cache_alloc_lru+0x219/0x6f0 mm/slub.c:3509
  alloc_inode_sb include/linux/fs.h:2937 [inline]
  ext4_alloc_inode+0x28/0x650 fs/ext4/super.c:1408
  alloc_inode+0x5d/0x220 fs/inode.c:261
  new_inode_pseudo fs/inode.c:1006 [inline]
  new_inode+0x22/0x260 fs/inode.c:1032
  __ext4_new_inode+0x333/0x5200 fs/ext4/ialloc.c:958
  ext4_symlink+0x5d7/0xa20 fs/ext4/namei.c:3398
  vfs_symlink fs/namei.c:4464 [inline]
  vfs_symlink+0x3e5/0x620 fs/namei.c:4448
  do_symlinkat+0x25f/0x310 fs/namei.c:4490
  __do_sys_symlinkat fs/namei.c:4506 [inline]
  __se_sys_symlinkat fs/namei.c:4503 [inline]
  __x64_sys_symlinkat+0x97/0xc0 fs/namei.c:4503
  do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  do_syscall_64+0x40/0x110 arch/x86/entry/common.c:82
- Net/mlx5e: Correct snprintf truncation handling for fw_version buffer
  used by representors. [Rahul Rameshbabu]

  [ Upstream commit b13559b76157de9d74f04d3ca0e49d69de3b5675 ]

  snprintf returns the length of the formatted string, excluding the trailing
  null, without accounting for truncation. This means that is the return
  value is greater than or equal to the size parameter, the fw_version string
  was truncated.
- Net/mlx5: Fix fw tracer first block check. [Moshe Shemesh]

  [ Upstream commit 4261edf11cb7c9224af713a102e5616329306932 ]

  While handling new traces, to verify it is not the first block being
  written, last_timestamp is checked. But instead of checking it is non
  zero it is verified to be zero. Fix to verify last_timestamp is not
  zero.
- Net/mlx5e: Fix slab-out-of-bounds in mlx5_query_nic_vport_mac_list()
  [Shifeng Li]

  [ Upstream commit ddb38ddff9c71026bad481b791a94d446ee37603 ]

  Out_sz that the size of out buffer is calculated using query_nic_vport
  _context_in structure when driver query the MAC list. However query_nic
  _vport_context_in structure is smaller than query_nic_vport_context_out.
  When allowed_list_size is greater than 96, calling ether_addr_copy() will
  trigger an slab-out-of-bounds.

  [ 1170.055866] BUG: KASAN: slab-out-of-bounds in mlx5_query_nic_vport_mac_list+0x481/0x4d0 [mlx5_core]
  [ 1170.055869] Read of size 4 at addr ffff88bdbc57d912 by task kworker/u128:1/461
  [ 1170.055870]
  [ 1170.055932] Workqueue: mlx5_esw_wq esw_vport_change_handler [mlx5_core]
  [ 1170.055936] Call Trace:
  [ 1170.055949]  dump_stack+0x8b/0xbb
  [ 1170.055958]  print_address_description+0x6a/0x270
  [ 1170.055961]  kasan_report+0x179/0x2c0
  [ 1170.056061]  mlx5_query_nic_vport_mac_list+0x481/0x4d0 [mlx5_core]
  [ 1170.056162]  esw_update_vport_addr_list+0x2c5/0xcd0 [mlx5_core]
  [ 1170.056257]  esw_vport_change_handle_locked+0xd08/0x1a20 [mlx5_core]
  [ 1170.056377]  esw_vport_change_handler+0x6b/0x90 [mlx5_core]
  [ 1170.056381]  process_one_work+0x65f/0x12d0
  [ 1170.056383]  worker_thread+0x87/0xb50
  [ 1170.056390]  kthread+0x2e9/0x3a0
  [ 1170.056394]  ret_from_fork+0x1f/0x40
- Revert "net/mlx5e: fix double free of encap_header" [Vlad Buslov]

  [ Upstream commit 5d089684dc434a31e08d32f0530066d0025c52e4 ]

  This reverts commit 6f9b1a0731662648949a1c0587f6acb3b7f8acf1.

  This patch is causing a null ptr issue, the proper fix is in the next
  patch.
- Wifi: mac80211: mesh_plink: fix matches_local logic. [Johannes Berg]

  [ Upstream commit 8c386b166e2517cf3a123018e77941ec22625d0f ]

  During refactoring the "else" here got lost, add it back.
- S390/vx: fix save/restore of fpu kernel context. [Heiko Carstens]

  [ Upstream commit e6b2dab41888332bf83f592131e7ea07756770a4 ]

  The KERNEL_FPR mask only contains a flag for the first eight vector
  registers. However floating point registers overlay parts of the first
  sixteen vector registers.

  This could lead to vector register corruption if a kernel fpu context uses
  any of the vector registers 8 to 15 and is interrupted or calls a
  KERNEL_FPR context. If that context uses also vector registers 8 to 15,
  their contents will be corrupted on return.

  Luckily this is currently not a real bug, since the kernel has only one
  KERNEL_FPR user with s390_adjust_jiffies() and it is only using floating
  point registers 0 to 2.

  Fix this by using the correct bits for KERNEL_FPR.
- Reset: Fix crash when freeing non-existent optional resets. [Geert
  Uytterhoeven]

  [ Upstream commit 4a6756f56bcf8e64c87144a626ce53aea4899c0e ]

  When obtaining one or more optional resets, non-existent resets are
  stored as NULL pointers, and all related error and cleanup paths need to
  take this into account.

  Currently only reset_control_put() and reset_control_bulk_put()
  get this right.  All of __reset_control_bulk_get(),
  of_reset_control_array_get(), and reset_control_array_put() lack the
  proper checking, causing NULL pointer dereferences on failure or
  release.

  Fix this by moving the existing check from reset_control_bulk_put() to
  __reset_control_put_internal(), so it applies to all callers.
  The double check in reset_control_put() doesn't hurt.
- ARM: OMAP2+: Fix null pointer dereference and memory leak in
  omap_soc_device_init. [Kunwu Chan]

  [ Upstream commit c72b9c33ef9695ad7ce7a6eb39a9df8a01b70796 ]

  kasprintf() returns a pointer to dynamically allocated memory which can
  be NULL upon failure. When 'soc_dev_attr->family' is NULL,it'll trigger
  the null pointer dereference issue, such as in 'soc_info_show'.

  And when 'soc_device_register' fails, it's necessary to release
  'soc_dev_attr->family' to avoid memory leaks.
- Smb: client: fix OOB in smb2_query_reparse_point() [Paulo Alcantara]

  [ Upstream commit 3a42709fa909e22b0be4bb1e2795aa04ada732a3 ]

  Validate @ioctl_rsp->OutputOffset and @ioctl_rsp->OutputCount so that
  their sum does not wrap to a number that is smaller than @reparse_buf
  and we end up with a wild pointer as follows:

    BUG: unable to handle page fault for address: ffff88809c5cd45f
    #PF: supervisor read access in kernel mode
    #PF: error_code(0x0000) - not-present page
    PGD 4a01067 P4D 4a01067 PUD 0
    Oops: 0000 [#1] PREEMPT SMP NOPTI
    CPU: 2 PID: 1260 Comm: mount.cifs Not tainted 6.7.0-rc4 #2
    Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
    rel-1.16.2-3-gd478f380-rebuilt.opensuse.org 04/01/2014
    RIP: 0010:smb2_query_reparse_point+0x3e0/0x4c0 [cifs]
    Code: ff ff e8 f3 51 fe ff 41 89 c6 58 5a 45 85 f6 0f 85 14 fe ff ff
    49 8b 57 48 8b 42 60 44 8b 42 64 42 8d 0c 00 49 39 4f 50 72 40 <8b>
    04 02 48 8b 9d f0 fe ff ff 49 8b 57 50 89 03 48 8b 9d e8 fe ff
    RSP: 0018:ffffc90000347a90 EFLAGS: 00010212
    RAX: 000000008000001f RBX: ffff88800ae11000 RCX: 00000000000000ec
    RDX: ffff88801c5cd440 RSI: 0000000000000000 RDI: ffffffff82004aa4
    RBP: ffffc90000347bb0 R08: 00000000800000cd R09: 0000000000000001
    R10: 0000000000000000 R11: 0000000000000024 R12: ffff8880114d4100
    R13: ffff8880114d4198 R14: 0000000000000000 R15: ffff8880114d4000
    FS: 00007f02c07babc0(0000) GS:ffff88806ba00000(0000)
    knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: ffff88809c5cd45f CR3: 0000000011750000 CR4: 0000000000750ef0
    PKRU: 55555554
    Call Trace:
     <TASK>
     ? __die+0x23/0x70
     ? page_fault_oops+0x181/0x480
     ? search_module_extables+0x19/0x60
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? exc_page_fault+0x1b6/0x1c0
     ? asm_exc_page_fault+0x26/0x30
     ? _raw_spin_unlock_irqrestore+0x44/0x60
     ? smb2_query_reparse_point+0x3e0/0x4c0 [cifs]
     cifs_get_fattr+0x16e/0xa50 [cifs]
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? lock_acquire+0xbf/0x2b0
     cifs_root_iget+0x163/0x5f0 [cifs]
     cifs_smb3_do_mount+0x5bd/0x780 [cifs]
     smb3_get_tree+0xd9/0x290 [cifs]
     vfs_get_tree+0x2c/0x100
     ? capable+0x37/0x70
     path_mount+0x2d7/0xb80
     ? srso_alias_return_thunk+0x5/0xfbef5
     ? _raw_spin_unlock_irqrestore+0x44/0x60
     __x64_sys_mount+0x11a/0x150
     do_syscall_64+0x47/0xf0
     entry_SYSCALL_64_after_hwframe+0x6f/0x77
    RIP: 0033:0x7f02c08d5b1e
- Ksmbd: fix wrong name of SMB2_CREATE_ALLOCATION_SIZE. [Namjae Jeon]

  [ Upstream commit 13736654481198e519059d4a2e2e3b20fa9fdb3e ]

  MS confirm that "AISi" name of SMB2_CREATE_ALLOCATION_SIZE in MS-SMB2
  specification is a typo. cifs/ksmbd have been using this wrong name from
  MS-SMB2. It should be "AlSi". Also It will cause problem when running
  smb2.create.open test in smbtorture against ksmbd.
- Linux 5.10.205. [Greg Kroah-Hartman]
- Powerpc/ftrace: Fix stack teardown in ftrace_no_trace. [Naveen N Rao]

  commit 4b3338aaa74d7d4ec5b6734dc298f0db94ec83d2 upstream.

  Commit 41a506ef71eb ("powerpc/ftrace: Create a dummy stackframe to fix
  stack unwind") added use of a new stack frame on ftrace entry to fix
  stack unwind. However, the commit missed updating the offset used while
  tearing down the ftrace stack when ftrace is disabled. Fix the same.

  In addition, the commit missed saving the correct stack pointer in
  pt_regs. Update the same.
- Powerpc/ftrace: Create a dummy stackframe to fix stack unwind. [Naveen
  N Rao]

  commit 41a506ef71eb38d94fe133f565c87c3e06ccc072 upstream.

  With ppc64 -mprofile-kernel and ppc32 -pg, profiling instructions to
  call into ftrace are emitted right at function entry. The instruction
  sequence used is minimal to reduce overhead. Crucially, a stackframe is
  not created for the function being traced. This breaks stack unwinding
  since the function being traced does not have a stackframe for itself.
  As such, it never shows up in the backtrace:

  /sys/kernel/debug/tracing # echo 1 > /proc/sys/kernel/stack_tracer_enabled
  /sys/kernel/debug/tracing # cat stack_trace
          Depth    Size   Location    (17 entries)
          -----    ----   --------
    0)     4144      32   ftrace_call+0x4/0x44
    1)     4112     432   get_page_from_freelist+0x26c/0x1ad0
    2)     3680     496   __alloc_pages+0x290/0x1280
    3)     3184     336   __folio_alloc+0x34/0x90
    4)     2848     176   vma_alloc_folio+0xd8/0x540
    5)     2672     272   __handle_mm_fault+0x700/0x1cc0
    6)     2400     208   handle_mm_fault+0xf0/0x3f0
    7)     2192      80   ___do_page_fault+0x3e4/0xbe0
    8)     2112     160   do_page_fault+0x30/0xc0
    9)     1952     256   data_access_common_virt+0x210/0x220
   10)     1696     400   0xc00000000f16b100
   11)     1296     384   load_elf_binary+0x804/0x1b80
   12)      912     208   bprm_execve+0x2d8/0x7e0
   13)      704      64   do_execveat_common+0x1d0/0x2f0
   14)      640     160   sys_execve+0x54/0x70
   15)      480      64   system_call_exception+0x138/0x350
   16)      416     416   system_call_common+0x160/0x2c4

  Fix this by having ftrace create a dummy stackframe for the function
  being traced. With this, backtraces now capture the function being
  traced:

  /sys/kernel/debug/tracing # cat stack_trace
          Depth    Size   Location    (17 entries)
          -----    ----   --------
    0)     3888      32   _raw_spin_trylock+0x8/0x70
    1)     3856     576   get_page_from_freelist+0x26c/0x1ad0
    2)     3280      64   __alloc_pages+0x290/0x1280
    3)     3216     336   __folio_alloc+0x34/0x90
    4)     2880     176   vma_alloc_folio+0xd8/0x540
    5)     2704     416   __handle_mm_fault+0x700/0x1cc0
    6)     2288      96   handle_mm_fault+0xf0/0x3f0
    7)     2192      48   ___do_page_fault+0x3e4/0xbe0
    8)     2144     192   do_page_fault+0x30/0xc0
    9)     1952     608   data_access_common_virt+0x210/0x220
   10)     1344      16   0xc0000000334bbb50
   11)     1328     416   load_elf_binary+0x804/0x1b80
   12)      912      64   bprm_execve+0x2d8/0x7e0
   13)      848     176   do_execveat_common+0x1d0/0x2f0
   14)      672     192   sys_execve+0x54/0x70
   15)      480      64   system_call_exception+0x138/0x350
   16)      416     416   system_call_common+0x160/0x2c4

  This results in two additional stores in the ftrace entry code, but
  produces reliable backtraces.
- Tty: n_gsm: add sanity check for gsm->receive in gsm_receive_buf()
  [Mazin Al Haddad]

  commit f16c6d2e58a4c2b972efcf9eb12390ee0ba3befb upstream

  A null pointer dereference can happen when attempting to access the
  "gsm->receive()" function in gsmld_receive_buf(). Currently, the code
  assumes that gsm->receive is only called after MUX activation.
  Since the gsmld_receive_buf() function can be accessed without the need to
  initialize the MUX, the gsm->receive() function will not be set and a
  NULL pointer dereference will occur.

  Fix this by avoiding the call to "gsm->receive()" in case the function is
  not initialized by adding a sanity check.

  Call Trace:
   <TASK>
   gsmld_receive_buf+0x1c2/0x2f0 drivers/tty/n_gsm.c:2861
   tiocsti drivers/tty/tty_io.c:2293 [inline]
   tty_ioctl+0xa75/0x15d0 drivers/tty/tty_io.c:2692
   vfs_ioctl fs/ioctl.c:51 [inline]
   __do_sys_ioctl fs/ioctl.c:870 [inline]
   __se_sys_ioctl fs/ioctl.c:856 [inline]
   __x64_sys_ioctl+0x193/0x200 fs/ioctl.c:856
   do_syscall_x64 arch/x86/entry/common.c:50 [inline]
   do_syscall_64+0x35/0xb0 arch/x86/entry/common.c:80
   entry_SYSCALL_64_after_hwframe+0x63/0xcd
- Tty: n_gsm, remove duplicates of parameters. [Jiri Slaby]

  commit b93db97e1ca08e500305bc46b08c72e2232c4be1 upstream.

  dp, f, and i are only duplicates of gsmld_receive_buf's parameters. Use
  the parameters directly (cp, fp, and count) and delete these local
  variables.
- Tty: n_gsm: fix tty registration before control channel open. [Daniel
  Starke]

  commit 01aecd917114577c423f07cec0d186ad007d76fc upstream.

  The current implementation registers/deregisters the user ttys at mux
  attach/detach. That means that the user devices are available before any
  control channel is open. However, user channel initialization requires an
  open control channel. Furthermore, the user is not informed if the mux
  restarts due to configuration changes.
  Put the registration/deregistration procedure into separate function to
  improve readability.
  Move registration to mux activation and deregistration to mux cleanup to
  keep the user devices only open as long as a control channel exists. The
  user will be informed via the device driver if the mux was reconfigured in
  a way that required a mux re-activation.
  This makes it necessary to add T2 initialization to gsmld_open() for the
  ldisc open code path (not the reconfiguration code path) to avoid deletion
  of an uninitialized T2 at mux cleanup.
- USB: gadget: core: adjust uevent timing on gadget unbind. [Roy Luo]

  commit 73ea73affe8622bdf292de898da869d441da6a9d upstream.

  The KOBJ_CHANGE uevent is sent before gadget unbind is actually
  executed, resulting in inaccurate uevent emitted at incorrect timing
  (the uevent would have USB_UDC_DRIVER variable set while it would
  soon be removed).
  Move the KOBJ_CHANGE uevent to the end of the unbind function so that
  uevent is sent only after the change has been made.
- Ring-buffer: Fix a race in rb_time_cmpxchg() for 32 bit archs. [Steven
  Rostedt (Google)]

  commit fff88fa0fbc7067ba46dde570912d63da42c59a9 upstream.

  Mathieu Desnoyers pointed out an issue in the rb_time_cmpxchg() for 32 bit
  architectures. That is:

   static bool rb_time_cmpxchg(rb_time_t *t, u64 expect, u64 set)
   {
  	unsigned long cnt, top, bottom, msb;
  	unsigned long cnt2, top2, bottom2, msb2;
  	u64 val;

  	/* The cmpxchg always fails if it interrupted an update */
  	 if (!__rb_time_read(t, &val, &cnt2))
  		 return false;

  	 if (val != expect)
  		 return false;

  <<<< interrupted here!

  	 cnt = local_read(&t->cnt);

  The problem is that the synchronization counter in the rb_time_t is read
  *after* the value of the timestamp is read. That means if an interrupt
  were to come in between the value being read and the counter being read,
  it can change the value and the counter and the interrupted process would
  be clueless about it!

  The counter needs to be read first and then the value. That way it is easy
  to tell if the value is stale or not. If the counter hasn't been updated,
  then the value is still good.
- Ring-buffer: Fix writing to the buffer with max_data_size. [Steven
  Rostedt (Google)]

  commit b3ae7b67b87fed771fa5bf95389df06b0433603e upstream.

  The maximum ring buffer data size is the maximum size of data that can be
  recorded on the ring buffer. Events must be smaller than the sub buffer
  data size minus any meta data. This size is checked before trying to
  allocate from the ring buffer because the allocation assumes that the size
  will fit on the sub buffer.

  The maximum size was calculated as the size of a sub buffer page (which is
  currently PAGE_SIZE minus the sub buffer header) minus the size of the
  meta data of an individual event. But it missed the possible adding of a
  time stamp for events that are added long enough apart that the event meta
  data can't hold the time delta.

  When an event is added that is greater than the current BUF_MAX_DATA_SIZE
  minus the size of a time stamp, but still less than or equal to
  BUF_MAX_DATA_SIZE, the ring buffer would go into an infinite loop, looking
  for a page that can hold the event. Luckily, there's a check for this loop
  and after 1000 iterations and a warning is emitted and the ring buffer is
  disabled. But this should never happen.

  This can happen when a large event is added first, or after a long period
  where an absolute timestamp is prefixed to the event, increasing its size
  by 8 bytes. This passes the check and then goes into the algorithm that
  causes the infinite loop.

  For events that are the first event on the sub-buffer, it does not need to
  add a timestamp, because the sub-buffer itself contains an absolute
  timestamp, and adding one is redundant.

  The fix is to check if the event is to be the first event on the
  sub-buffer, and if it is, then do not add a timestamp.

  This also fixes 32 bit adding a timestamp when a read of before_stamp or
  write_stamp is interrupted. There's still no need to add that timestamp if
  the event is going to be the first event on the sub buffer.

  Also, if the buffer has "time_stamp_abs" set, then also check if the
  length plus the timestamp is greater than the BUF_MAX_DATA_SIZE.
- Ring-buffer: Have saved event hold the entire event. [Steven Rostedt
  (Google)]

  commit b049525855fdd0024881c9b14b8fbec61c3f53d3 upstream.

  For the ring buffer iterator (non-consuming read), the event needs to be
  copied into the iterator buffer to make sure that a writer does not
  overwrite it while the user is reading it. If a write happens during the
  copy, the buffer is simply discarded.

  But the temp buffer itself was not big enough. The allocation of the
  buffer was only BUF_MAX_DATA_SIZE, which is the maximum data size that can
  be passed into the ring buffer and saved. But the temp buffer needs to
  hold the meta data as well. That would be BUF_PAGE_SIZE and not
  BUF_MAX_DATA_SIZE.
- Tracing: Update snapshot buffer on resize if it is allocated. [Steven
  Rostedt (Google)]

  commit d06aff1cb13d2a0d52b48e605462518149c98c81 upstream.

  The snapshot buffer is to mimic the main buffer so that when a snapshot is
  needed, the snapshot and main buffer are swapped. When the snapshot buffer
  is allocated, it is set to the minimal size that the ring buffer may be at
  and still functional. When it is allocated it becomes the same size as the
  main ring buffer, and when the main ring buffer changes in size, it should
  do.

  Currently, the resize only updates the snapshot buffer if it's used by the
  current tracer (ie. the preemptirqsoff tracer). But it needs to be updated
  anytime it is allocated.

  When changing the size of the main buffer, instead of looking to see if
  the current tracer is utilizing the snapshot buffer, just check if it is
  allocated to know if it should be updated or not.

  Also fix typo in comment just above the code change.
- Ring-buffer: Fix memory leak of free page. [Steven Rostedt (Google)]

  commit 17d801758157bec93f26faaf5ff1a8b9a552d67a upstream.

  Reading the ring buffer does a swap of a sub-buffer within the ring buffer
  with a empty sub-buffer. This allows the reader to have full access to the
  content of the sub-buffer that was swapped out without having to worry
  about contention with the writer.

  The readers call ring_buffer_alloc_read_page() to allocate a page that
  will be used to swap with the ring buffer. When the code is finished with
  the reader page, it calls ring_buffer_free_read_page(). Instead of freeing
  the page, it stores it as a spare. Then next call to
  ring_buffer_alloc_read_page() will return this spare instead of calling
  into the memory management system to allocate a new page.

  Unfortunately, on freeing of the ring buffer, this spare page is not
  freed, and causes a memory leak.
- Team: Fix use-after-free when an option instance allocation fails.
  [Florent Revest]

  commit c12296bbecc488623b7d1932080e394d08f3226b upstream.

  In __team_options_register, team_options are allocated and appended to
  the team's option_list.
  If one option instance allocation fails, the "inst_rollback" cleanup
  path frees the previously allocated options but doesn't remove them from
  the team's option_list.
  This leaves dangling pointers that can be dereferenced later by other
  parts of the team driver that iterate over options.

  This patch fixes the cleanup path to remove the dangling pointers from
  the list.

  As far as I can tell, this uaf doesn't have much security implications
  since it would be fairly hard to exploit (an attacker would need to make
  the allocation of that specific small object fail) but it's still nice
  to fix.
- Arm64: mm: Always make sw-dirty PTEs hw-dirty in pte_modify. [James
  Houghton]

  commit 3c0696076aad60a2f04c019761921954579e1b0e upstream.

  It is currently possible for a userspace application to enter an
  infinite page fault loop when using HugeTLB pages implemented with
  contiguous PTEs when HAFDBS is not available. This happens because:

  1. The kernel may sometimes write PTEs that are sw-dirty but hw-clean
     (PTE_DIRTY | PTE_RDONLY | PTE_WRITE).

  2. If, during a write, the CPU uses a sw-dirty, hw-clean PTE in handling
     the memory access on a system without HAFDBS, we will get a page
     fault.

  3. HugeTLB will check if it needs to update the dirty bits on the PTE.
     For contiguous PTEs, it will check to see if the pgprot bits need
     updating. In this case, HugeTLB wants to write a sequence of
     sw-dirty, hw-dirty PTEs, but it finds that all the PTEs it is about
     to overwrite are all pte_dirty() (pte_sw_dirty() => pte_dirty()),
     so it thinks no update is necessary.

  We can get the kernel to write a sw-dirty, hw-clean PTE with the
  following steps (showing the relevant VMA flags and pgprot bits):

  i.   Create a valid, writable contiguous PTE.
         VMA vmflags:     VM_SHARED | VM_READ | VM_WRITE
         VMA pgprot bits: PTE_RDONLY | PTE_WRITE
         PTE pgprot bits: PTE_DIRTY | PTE_WRITE

  ii.  mprotect the VMA to PROT_NONE.
         VMA vmflags:     VM_SHARED
         VMA pgprot bits: PTE_RDONLY
         PTE pgprot bits: PTE_DIRTY | PTE_RDONLY

  iii. mprotect the VMA back to PROT_READ | PROT_WRITE.
         VMA vmflags:     VM_SHARED | VM_READ | VM_WRITE
         VMA pgprot bits: PTE_RDONLY | PTE_WRITE
         PTE pgprot bits: PTE_DIRTY | PTE_WRITE | PTE_RDONLY

  Make it impossible to create a writeable sw-dirty, hw-clean PTE with
  pte_modify(). Such a PTE should be impossible to create, and there may
  be places that assume that pte_dirty() implies pte_hw_dirty().
- Ext4: prevent the normalized size from exceeding EXT_MAX_BLOCKS.
  [Baokun Li]

  commit 2dcf5fde6dffb312a4bfb8ef940cea2d1f402e32 upstream.

  For files with logical blocks close to EXT_MAX_BLOCKS, the file size
  predicted in ext4_mb_normalize_request() may exceed EXT_MAX_BLOCKS.
  This can cause some blocks to be preallocated that will not be used.
  And after [Fixes], the following issue may be triggered:

  =========================================================
   kernel BUG at fs/ext4/mballoc.c:4653!
   Internal error: Oops - BUG: 00000000f2000800 [#1] SMP
   CPU: 1 PID: 2357 Comm: xfs_io 6.7.0-rc2-00195-g0f5cc96c367f
   Hardware name: linux,dummy-virt (DT)
   pc : ext4_mb_use_inode_pa+0x148/0x208
   lr : ext4_mb_use_inode_pa+0x98/0x208
   Call trace:
    ext4_mb_use_inode_pa+0x148/0x208
    ext4_mb_new_inode_pa+0x240/0x4a8
    ext4_mb_use_best_found+0x1d4/0x208
    ext4_mb_try_best_found+0xc8/0x110
    ext4_mb_regular_allocator+0x11c/0xf48
    ext4_mb_new_blocks+0x790/0xaa8
    ext4_ext_map_blocks+0x7cc/0xd20
    ext4_map_blocks+0x170/0x600
    ext4_iomap_begin+0x1c0/0x348
  =========================================================

  Here is a calculation when adjusting ac_b_ex in ext4_mb_new_inode_pa():

  	ex.fe_logical = orig_goal_end - EXT4_C2B(sbi, ex.fe_len);
  	if (ac->ac_o_ex.fe_logical >= ex.fe_logical)
  		goto adjust_bex;

  The problem is that when orig_goal_end is subtracted from ac_b_ex.fe_len
  it is still greater than EXT_MAX_BLOCKS, which causes ex.fe_logical to
  overflow to a very small value, which ultimately triggers a BUG_ON in
  ext4_mb_new_inode_pa() because pa->pa_free < len.

  The last logical block of an actual write request does not exceed
  EXT_MAX_BLOCKS, so in ext4_mb_normalize_request() also avoids normalizing
  the last logical block to exceed EXT_MAX_BLOCKS to avoid the above issue.

  The test case in [Link] can reproduce the above issue with 64k block size.
- Soundwire: stream: fix NULL pointer dereference for multi_link.
  [Krzysztof Kozlowski]

  commit e199bf52ffda8f98f129728d57244a9cd9ad5623 upstream.

  If bus is marked as multi_link, but number of masters in the stream is
  not higher than bus->hw_sync_min_links (bus->multi_link && m_rt_count >=
  bus->hw_sync_min_links), bank switching should not happen.  The first
  part of do_bank_switch() code properly takes these conditions into
  account, but second part (sdw_ml_sync_bank_switch()) relies purely on
  bus->multi_link property.  This is not balanced and leads to NULL
  pointer dereference:

    Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
    ...
    Call trace:
     wait_for_completion_timeout+0x124/0x1f0
     do_bank_switch+0x370/0x6f8
     sdw_prepare_stream+0x2d0/0x438
     qcom_snd_sdw_prepare+0xa0/0x118
     sm8450_snd_prepare+0x128/0x148
     snd_soc_link_prepare+0x5c/0xe8
     __soc_pcm_prepare+0x28/0x1ec
     dpcm_be_dai_prepare+0x1e0/0x2c0
     dpcm_fe_dai_prepare+0x108/0x28c
     snd_pcm_do_prepare+0x44/0x68
     snd_pcm_action_single+0x54/0xc0
     snd_pcm_action_nonatomic+0xe4/0xec
     snd_pcm_prepare+0xc4/0x114
     snd_pcm_common_ioctl+0x1154/0x1cc0
     snd_pcm_ioctl+0x54/0x74
- Perf: Fix perf_event_validate_size() lockdep splat. [Mark Rutland]

  commit 7e2c1e4b34f07d9aa8937fab88359d4a0fce468e upstream.

  When lockdep is enabled, the for_each_sibling_event(sibling, event)
  macro checks that event->ctx->mutex is held. When creating a new group
  leader event, we call perf_event_validate_size() on a partially
  initialized event where event->ctx is NULL, and so when
  for_each_sibling_event() attempts to check event->ctx->mutex, we get a
  splat, as reported by Lucas De Marchi:

    WARNING: CPU: 8 PID: 1471 at kernel/events/core.c:1950 __do_sys_perf_event_open+0xf37/0x1080

  This only happens for a new event which is its own group_leader, and in
  this case there cannot be any sibling events. Thus it's safe to skip the
  check for siblings, which avoids having to make invasive and ugly
  changes to for_each_sibling_event().

  Avoid the splat by bailing out early when the new event is its own
  group_leader.
- HID: hid-asus: add const to read-only outgoing usb buffer. [Denis
  Benato]

  [ Upstream commit 06ae5afce8cc1f7621cc5c7751e449ce20d68af7 ]

  In the function asus_kbd_set_report the parameter buf is read-only
  as it gets copied in a memory portion suitable for USB transfer,
  but the parameter is not marked as const: add the missing const and mark
  const immutable buffers passed to that function.
- Net: usb: qmi_wwan: claim interface 4 for ZTE MF290. [Lech Perczak]

  [ Upstream commit 99360d9620f09fb8bc15548d855011bbb198c680 ]

  Interface 4 is used by for QMI interface in stock firmware of MF28D, the
  router which uses MF290 modem. Rebind it to qmi_wwan after freeing it up
  from option driver.
  The proper configuration is:

  Interface mapping is:
  0: QCDM, 1: (unknown), 2: AT (PCUI), 2: AT (Modem), 4: QMI

  T:  Bus=01 Lev=02 Prnt=02 Port=00 Cnt=01 Dev#=  4 Spd=480  MxCh= 0
  D:  Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
  P:  Vendor=19d2 ProdID=0189 Rev= 0.00
  S:  Manufacturer=ZTE, Incorporated
  S:  Product=ZTE LTE Technologies MSM
  C:* #Ifs= 5 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=84(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi_wwan
  E:  Ad=86(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=87(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
- Asm-generic: qspinlock: fix queued_spin_value_unlocked()
  implementation. [Linus Torvalds]

  [ Upstream commit 125b0bb95dd6bec81b806b997a4ccb026eeecf8f ]

  We really don't want to do atomic_read() or anything like that, since we
  already have the value, not the lock.  The whole point of this is that
  we've loaded the lock from memory, and we want to check whether the
  value we loaded was a locked one or not.

  The main use of this is the lockref code, which loads both the lock and
  the reference count in one atomic operation, and then works on that
  combined value.  With the atomic_read(), the compiler would pointlessly
  spill the value to the stack, in order to then be able to read it back
  "atomically".

  This is the qspinlock version of commit c6f4a9002252 ("asm-generic:
  ticket-lock: Optimize arch_spin_value_unlocked()") which fixed this same
  bug for ticket locks.
- HID: multitouch: Add quirk for HONOR GLO-GXXX touchpad. [Aoba K]

  [ Upstream commit 9ffccb691adb854e7b7f3ee57fbbda12ff70533f ]

  Honor MagicBook 13 2023 has a touchpad which do not switch to the multitouch
  mode until the input mode feature is written by the host.  The touchpad do
  report the input mode at touchpad(3), while itself working under mouse mode. As
  a workaround, it is possible to call MT_QUIRE_FORCE_GET_FEATURE to force set
  feature in mt_set_input_mode for such device.

  The touchpad reports as BLTP7853, which cannot retrive any useful manufacture
  information on the internel by this string at present.  As the serial number of
  the laptop is GLO-G52, while DMI info reports the laptop serial number as
  GLO-GXXX, this workaround should applied to all models which has the GLO-GXXX.
- HID: hid-asus: reset the backlight brightness level on resume. [Denis
  Benato]

  [ Upstream commit 546edbd26cff7ae990e480a59150e801a06f77b1 ]

  Some devices managed by this driver automatically set brightness to 0
  before entering a suspended state and reset it back to a default
  brightness level after the resume:
  this has the effect of having the kernel report wrong brightness
  status after a sleep, and on some devices (like the Asus RC71L) that
  brightness is the intensity of LEDs directly facing the user.

  Fix the above issue by setting back brightness to the level it had
  before entering a sleep state.
- HID: add ALWAYS_POLL quirk for Apple kb. [Oliver Neukum]

  [ Upstream commit c55092187d9ad7b2f8f5a8645286fa03997d442f ]

  These devices disconnect if suspended without remote wakeup. They can operate
  with the standard driver.
- HID: glorious: fix Glorious Model I HID report. [Brett Raye]

  [ Upstream commit a5e913c25b6b2b6ae02acef6d9400645ac03dfdf ]

  The Glorious Model I mouse has a buggy HID report descriptor for its
  keyboard endpoint (used for programmable buttons). For report ID 2, there
  is a mismatch between Logical Minimum and Usage Minimum in the array that
  reports keycodes.

  The offending portion of the descriptor: (from hid-decode)

  0x95, 0x05,                    //  Report Count (5)                   30
  0x75, 0x08,                    //  Report Size (8)                    32
  0x15, 0x00,                    //  Logical Minimum (0)                34
  0x25, 0x65,                    //  Logical Maximum (101)              36
  0x05, 0x07,                    //  Usage Page (Keyboard)              38
  0x19, 0x01,                    //  Usage Minimum (1)                  40
  0x29, 0x65,                    //  Usage Maximum (101)                42
  0x81, 0x00,                    //  Input (Data,Arr,Abs)               44

  This bug shifts all programmed keycodes up by 1. Importantly, this causes
  "empty" array indexes of 0x00 to be interpreted as 0x01, ErrorRollOver.
  The presence of ErrorRollOver causes the system to ignore all keypresses
  from the endpoint and breaks the ability to use the programmable buttons.

  Setting byte 41 to 0x00 fixes this, and causes keycodes to be interpreted
  correctly.

  Also, USB_VENDOR_ID_GLORIOUS is changed to USB_VENDOR_ID_SINOWEALTH,
  and a new ID for Laview Technology is added. Glorious seems to be
  white-labeling controller boards or mice from these vendors. There isn't a
  single canonical vendor ID for Glorious products.
- Platform/x86: intel_telemetry: Fix kernel doc descriptions. [Andy
  Shevchenko]

  [ Upstream commit a6584711e64d9d12ab79a450ec3628fd35e4f476 ]

  LKP found issues with a kernel doc in the driver:

  core.c:116: warning: Function parameter or member 'ioss_evtconfig' not described in 'telemetry_update_events'
  core.c:188: warning: Function parameter or member 'ioss_evtconfig' not described in 'telemetry_get_eventconfig'

  It looks like it were copy'n'paste typos when these descriptions
  had been introduced. Fix the typos.
- Bcache: avoid NULL checking to c->root in run_cache_set() [Coly Li]

  [ Upstream commit 3eba5e0b2422aec3c9e79822029599961fdcab97 ]

  In run_cache_set() after c->root returned from bch_btree_node_get(), it
  is checked by IS_ERR_OR_NULL(). Indeed it is unncessary to check NULL
  because bch_btree_node_get() will not return NULL pointer to caller.

  This patch replaces IS_ERR_OR_NULL() by IS_ERR() for the above reason.
- Bcache: add code comments for bch_btree_node_get() and
  __bch_btree_node_alloc() [Coly Li]

  [ Upstream commit 31f5b956a197d4ec25c8a07cb3a2ab69d0c0b82f ]

  This patch adds code comments to bch_btree_node_get() and
  __bch_btree_node_alloc() that NULL pointer will not be returned and it
  is unnecessary to check NULL pointer by the callers of these routines.
- Bcache: remove redundant assignment to variable cur_idx. [Colin Ian
  King]

  [ Upstream commit be93825f0e6428c2d3f03a6e4d447dc48d33d7ff ]

  Variable cur_idx is being initialized with a value that is never read,
  it is being re-assigned later in a while-loop. Remove the redundant
  assignment. Cleans up clang scan build warning:

  drivers/md/bcache/writeback.c:916:2: warning: Value stored to 'cur_idx'
  is never read [deadcode.DeadStores]
- Bcache: avoid oversize memory allocation by small stripe_size. [Coly
  Li]

  [ Upstream commit baf8fb7e0e5ec54ea0839f0c534f2cdcd79bea9c ]

  Arraies bcache->stripe_sectors_dirty and bcache->full_dirty_stripes are
  used for dirty data writeback, their sizes are decided by backing device
  capacity and stripe size. Larger backing device capacity or smaller
  stripe size make these two arraies occupies more dynamic memory space.

  Currently bcache->stripe_size is directly inherited from
  queue->limits.io_opt of underlying storage device. For normal hard
  drives, its limits.io_opt is 0, and bcache sets the corresponding
  stripe_size to 1TB (1<<31 sectors), it works fine 10+ years. But for
  devices do declare value for queue->limits.io_opt, small stripe_size
  (comparing to 1TB) becomes an issue for oversize memory allocations of
  bcache->stripe_sectors_dirty and bcache->full_dirty_stripes, while the
  capacity of hard drives gets much larger in recent decade.

  For example a raid5 array assembled by three 20TB hardrives, the raid
  device capacity is 40TB with typical 512KB limits.io_opt. After the math
  calculation in bcache code, these two arraies will occupy 400MB dynamic
  memory. Even worse Andrea Tomassetti reports that a 4KB limits.io_opt is
  declared on a new 2TB hard drive, then these two arraies request 2GB and
  512MB dynamic memory from kzalloc(). The result is that bcache device
  always fails to initialize on his system.

  To avoid the oversize memory allocation, bcache->stripe_size should not
  directly inherited by queue->limits.io_opt from the underlying device.
  This patch defines BCH_MIN_STRIPE_SZ (4MB) as minimal bcache stripe size
  and set bcache device's stripe size against the declared limits.io_opt
  value from the underlying storage device,
  - If the declared limits.io_opt > BCH_MIN_STRIPE_SZ, bcache device will
    set its stripe size directly by this limits.io_opt value.
  - If the declared limits.io_opt < BCH_MIN_STRIPE_SZ, bcache device will
    set its stripe size by a value multiplying limits.io_opt and euqal or
    large than BCH_MIN_STRIPE_SZ.

  Then the minimal stripe size of a bcache device will always be >= 4MB.
  For a 40TB raid5 device with 512KB limits.io_opt, memory occupied by
  bcache->stripe_sectors_dirty and bcache->full_dirty_stripes will be 50MB
  in total. For a 2TB hard drive with 4KB limits.io_opt, memory occupied
  by these two arraies will be 2.5MB in total.

  Such mount of memory allocated for bcache->stripe_sectors_dirty and
  bcache->full_dirty_stripes is reasonable for most of storage devices.
- Blk-throttle: fix lockdep warning of "cgroup_mutex or RCU read lock
  required!" [Ming Lei]

  [ Upstream commit 27b13e209ddca5979847a1b57890e0372c1edcee ]

  Inside blkg_for_each_descendant_pre(), both
  css_for_each_descendant_pre() and blkg_lookup() requires RCU read lock,
  and either cgroup_assert_mutex_or_rcu_locked() or rcu_read_lock_held()
  is called.

  Fix the warning by adding rcu read lock.
- Usb: aqc111: check packet for fixup for true limit. [Oliver Neukum]

  [ Upstream commit ccab434e674ca95d483788b1895a70c21b7f016a ]

  If a device sends a packet that is inbetween 0
  and sizeof(u64) the value passed to skb_trim()
  as length will wrap around ending up as some very
  large value.

  The driver will then proceed to parse the header
  located at that position, which will either oops or
  process some random value.

  The fix is to check against sizeof(u64) rather than
  0, which the driver currently does. The issue exists
  since the introduction of the driver.
- Drm/mediatek: Add spinlock for setting vblank event in atomic_begin.
  [Jason-JH.Lin]

  [ Upstream commit fe4c5f662097978b6c91c23a13c24ed92339a180 ]

  Add spinlock protection to avoid race condition on vblank event
  between mtk_drm_crtc_atomic_begin() and mtk_drm_finish_page_flip().
- PCI: loongson: Limit MRRS to 256. [Jiaxun Yang]

  commit ef61a0405742a9f7f6051bc6fd2f017d87d07911 upstream.

  This is a partial revert of 8b3517f88ff2 ("PCI: loongson: Prevent LS7A MRRS
  increases") for MIPS-based Loongson.

  Some MIPS Loongson systems don't support arbitrary Max_Read_Request_Size
  (MRRS) settings.  8b3517f88ff2 ("PCI: loongson: Prevent LS7A MRRS
  increases") worked around that by (1) assuming that firmware configured
  MRRS to the maximum supported value and (2) preventing the PCI core from
  increasing MRRS.

  Unfortunately, some firmware doesn't set that maximum MRRS correctly, which
  results in devices not being initialized correctly.  One symptom, from the
  Debian report below, is this:

    ata4.00: exception Emask 0x0 SAct 0x20000000 SErr 0x0 action 0x6 frozen
    ata4.00: failed command: WRITE FPDMA QUEUED
    ata4.00: cmd 61/20:e8:00:f0:e1/00:00:00:00:00/40 tag 29 ncq dma 16384 out
             res 40/00:00:00:00:00/00:00:00:00:00/00 Emask 0x4 (timeout)
    ata4.00: status: { DRDY }
    ata4: hard resetting link

  Limit MRRS to 256 because MIPS Loongson with higher MRRS support is
  considered rare.

  This must be done at device enablement stage because the MRRS setting may
  get lost if PCI_COMMAND_MASTER on the parent bridge is cleared, and we are
  only sure parent bridge is enabled at this point.
- Revert "PCI: acpiphp: Reassign resources on bridge if necessary"
  [Bjorn Helgaas]

  commit 5df12742b7e3aae2594a30a9d14d5d6e9e7699f4 upstream.

  This reverts commit 40613da52b13fb21c5566f10b287e0ca8c12c4e9 and the
  subsequent fix to it:

    cc22522fd55e ("PCI: acpiphp: Use pci_assign_unassigned_bridge_resources() only for non-root bus")

  40613da52b13 fixed a problem where hot-adding a device with large BARs
  failed if the bridge windows programmed by firmware were not large enough.

  cc22522fd55e ("PCI: acpiphp: Use pci_assign_unassigned_bridge_resources()
  only for non-root bus") fixed a problem with 40613da52b13: an ACPI hot-add
  of a device on a PCI root bus (common in the virt world) or firmware
  sending ACPI Bus Check to non-existent Root Ports (e.g., on Dell Inspiron
  7352/0W6WV0) caused a NULL pointer dereference and suspend/resume hangs.

  Unfortunately the combination of 40613da52b13 and cc22522fd55e caused other
  problems:

    - Fiona reported that hot-add of SCSI disks in QEMU virtual machine fails
      sometimes.

    - Dongli reported a similar problem with hot-add of SCSI disks.

    - Jonathan reported a console freeze during boot on bare metal due to an
      error in radeon GPU initialization.

  Revert both patches to avoid adding these problems.  This means we will
  again see the problems with hot-adding devices with large BARs and the NULL
  pointer dereferences and suspend/resume issues that 40613da52b13 and
  cc22522fd55e were intended to fix.
- ALSA: hda/realtek: Apply mute LED quirk for HP15-db. [Hartmut Knaack]

  commit 9b726bf6ae11add6a7a52883a21f90ff9cbca916 upstream.

  The HP laptop 15-db0403ng uses the ALC236 codec and controls the mute
  LED using COEF 0x07 index 1.
  Sound card subsystem: Hewlett-Packard Company Device [103c:84ae]

  Use the existing quirk for this model.
- ALSA: hda/hdmi: add force-connect quirks for ASUSTeK Z170 variants.
  [Kai Vehmanen]

  commit 924f5ca2975b2993ee81a7ecc3c809943a70f334 upstream.

  On ASUSTeK Z170M PLUS and Z170 PRO GAMING systems, the display codec
  pins are not registered properly without the force-connect quirk. The
  codec will report only one pin as having external connectivity, but i915
  finds all three connectors on the system, so the two drivers are not
  in sync.

  Issue found with DRM igt-gpu-tools test kms_hdmi_inject@inject-audio.
- Fuse: dax: set fc->dax to NULL in fuse_dax_conn_free() [Hangyu Hua]

  commit 7f8ed28d1401320bcb02dda81b3c23ab2dc5a6d8 upstream.

  fuse_dax_conn_free() will be called when fuse_fill_super_common() fails
  after fuse_dax_conn_alloc(). Then deactivate_locked_super() in
  virtio_fs_get_tree() will call virtio_kill_sb() to release the discarded
  superblock. This will call fuse_dax_conn_free() again in fuse_conn_put(),
  resulting in a possible double free.
- Cred: switch to using atomic_long_t. [Jens Axboe]

  commit f8fa5d76925991976b3e7076f9d1052515ec1fca upstream.

  There are multiple ways to grab references to credentials, and the only
  protection we have against overflowing it is the memory required to do
  so.

  With memory sizes only moving in one direction, let's bump the reference
  count to 64-bit and move it outside the realm of feasibly overflowing.
- Net: atlantic: fix double free in ring reinit logic. [Igor Russkikh]

  [ Upstream commit 7bb26ea74aa86fdf894b7dbd8c5712c5b4187da7 ]

  Driver has a logic leak in ring data allocation/free,
  where double free may happen in aq_ring_free if system is under
  stress and driver init/deinit is happening.

  The probability is higher to get this during suspend/resume cycle.

  Verification was done simulating same conditions with

      stress -m 2000 --vm-bytes 20M --vm-hang 10 --backoff 1000
      while true; do sudo ifconfig enp1s0 down; sudo ifconfig enp1s0 up; done

  Fixed by explicitly clearing pointers to NULL on deallocation
- Appletalk: Fix Use-After-Free in atalk_ioctl. [Hyunwoo Kim]

  [ Upstream commit 189ff16722ee36ced4d2a2469d4ab65a8fee4198 ]

  Because atalk_ioctl() accesses sk->sk_receive_queue
  without holding a sk->sk_receive_queue.lock, it can
  cause a race with atalk_recvmsg().
  A use-after-free for skb occurs with the following flow.
  ```
  atalk_ioctl() -> skb_peek()
  atalk_recvmsg() -> skb_recv_datagram() -> skb_free_datagram()
  ```
  Add sk->sk_receive_queue.lock to atalk_ioctl() to fix this issue.
- Net: stmmac: Handle disabled MDIO busses from devicetree. [Andrew
  Halaney]

  [ Upstream commit e23c0d21ce9234fbc31ece35663ababbb83f9347 ]

  Many hardware configurations have the MDIO bus disabled, and are instead
  using some other MDIO bus to talk to the MAC's phy.

  of_mdiobus_register() returns -ENODEV in this case. Let's handle it
  gracefully instead of failing to probe the MAC.
- Net: stmmac: use dev_err_probe() for reporting mdio bus registration
  failure. [Rasmus Villemoes]

  [ Upstream commit 839612d23ffd933174db911ce56dc3f3ca883ec5 ]

  I have a board where these two lines are always printed during boot:

     imx-dwmac 30bf0000.ethernet: Cannot register the MDIO bus
     imx-dwmac 30bf0000.ethernet: stmmac_dvr_probe: MDIO bus (id: 1) registration failed

  It's perfectly fine, and the device is successfully (and silently, as
  far as the console goes) probed later.

  Use dev_err_probe() instead, which will demote these messages to debug
  level (thus removing the alarming messages from the console) when the
  error is -EPROBE_DEFER, and also has the advantage of including the
  error code if/when it happens to be something other than -EPROBE_DEFER.

  While here, add the missing \n to one of the format strings.
- Vsock/virtio: Fix unsigned integer wrap around in
  virtio_transport_has_space() [Nikolay Kuratov]

  [ Upstream commit 60316d7f10b17a7ebb1ead0642fee8710e1560e0 ]

  We need to do signed arithmetic if we expect condition
  `if (bytes < 0)` to be possible

  Found by Linux Verification Center (linuxtesting.org) with SVACE
- Sign-file: Fix incorrect return values check. [Yusong Gao]

  [ Upstream commit 829649443e78d85db0cff0c37cadb28fbb1a5f6f ]

  There are some wrong return values check in sign-file when call OpenSSL
  API. The ERR() check cond is wrong because of the program only check the
  return value is < 0 which ignored the return val is 0. For example:
  1. CMS_final() return 1 for success or 0 for failure.
  2. i2d_CMS_bio_stream() returns 1 for success or 0 for failure.
  3. i2d_TYPEbio() return 1 for success and 0 for failure.
  4. BIO_free() return 1 for success and 0 for failure.
- Net: ena: Fix XDP redirection error. [David Arinzon]

  [ Upstream commit 4ab138ca0a340e6d6e7a6a9bd5004bd8f83127ca ]

  When sending TX packets, the meta descriptor can be all zeroes
  as no meta information is required (as in XDP).

  This patch removes the validity check, as when
  `disable_meta_caching` is enabled, such TX packets will be
  dropped otherwise.
- Net: ena: Destroy correct number of xdp queues upon failure. [David
  Arinzon]

  [ Upstream commit 41db6f99b5489a0d2ef26afe816ef0c6118d1d47 ]

  The ena_setup_and_create_all_xdp_queues() function freed all the
  resources upon failure, after creating only xdp_num_queues queues,
  instead of freeing just the created ones.

  In this patch, the only resources that are freed, are the ones
  allocated right before the failure occurs.
- Net: Remove acked SYN flag from packet in the transmit queue
  correctly. [Dong Chenchen]

  [ Upstream commit f99cd56230f56c8b6b33713c5be4da5d6766be1f ]

  syzkaller report:

   kernel BUG at net/core/skbuff.c:3452!
   invalid opcode: 0000 [#1] PREEMPT SMP KASAN PTI
   CPU: 0 PID: 0 Comm: swapper/0 Not tainted 6.7.0-rc4-00009-gbee0e7762ad2-dirty #135
   RIP: 0010:skb_copy_and_csum_bits (net/core/skbuff.c:3452)
   Call Trace:
   icmp_glue_bits (net/ipv4/icmp.c:357)
   __ip_append_data.isra.0 (net/ipv4/ip_output.c:1165)
   ip_append_data (net/ipv4/ip_output.c:1362 net/ipv4/ip_output.c:1341)
   icmp_push_reply (net/ipv4/icmp.c:370)
   __icmp_send (./include/net/route.h:252 net/ipv4/icmp.c:772)
   ip_fragment.constprop.0 (./include/linux/skbuff.h:1234 net/ipv4/ip_output.c:592 net/ipv4/ip_output.c:577)
   __ip_finish_output (net/ipv4/ip_output.c:311 net/ipv4/ip_output.c:295)
   ip_output (net/ipv4/ip_output.c:427)
   __ip_queue_xmit (net/ipv4/ip_output.c:535)
   __tcp_transmit_skb (net/ipv4/tcp_output.c:1462)
   __tcp_retransmit_skb (net/ipv4/tcp_output.c:3387)
   tcp_retransmit_skb (net/ipv4/tcp_output.c:3404)
   tcp_retransmit_timer (net/ipv4/tcp_timer.c:604)
   tcp_write_timer (./include/linux/spinlock.h:391 net/ipv4/tcp_timer.c:716)

  The panic issue was trigered by tcp simultaneous initiation.
  The initiation process is as follows:

        TCP A                                            TCP B

    1.  CLOSED                                           CLOSED

    2.  SYN-SENT     --> <SEQ=100><CTL=SYN>              ...

    3.  SYN-RECEIVED <-- <SEQ=300><CTL=SYN>              <-- SYN-SENT

    4.               ... <SEQ=100><CTL=SYN>              --> SYN-RECEIVED

    5.  SYN-RECEIVED --> <SEQ=100><ACK=301><CTL=SYN,ACK> ...

    // TCP B: not send challenge ack for ack limit or packet loss
    // TCP A: close
  	tcp_close
  	   tcp_send_fin
                if (!tskb && tcp_under_memory_pressure(sk))
                    tskb = skb_rb_last(&sk->tcp_rtx_queue); //pick SYN_ACK packet
             TCP_SKB_CB(tskb)->tcp_flags |= TCPHDR_FIN;  // set FIN flag

    6.  FIN_WAIT_1  --> <SEQ=100><ACK=301><END_SEQ=102><CTL=SYN,FIN,ACK> ...

    // TCP B: send challenge ack to SYN_FIN_ACK

    7.               ... <SEQ=301><ACK=101><CTL=ACK>   <-- SYN-RECEIVED //challenge ack

    // TCP A:  <SND.UNA=101>

    8.  FIN_WAIT_1 --> <SEQ=101><ACK=301><END_SEQ=102><CTL=SYN,FIN,ACK> ... // retransmit panic

  	__tcp_retransmit_skb  //skb->len=0
  	    tcp_trim_head
  		len = tp->snd_una - TCP_SKB_CB(skb)->seq // len=101-100
  		    __pskb_trim_head
  			skb->data_len -= len // skb->len=-1, wrap around
  	    ... ...
  	    ip_fragment
  		icmp_glue_bits //BUG_ON

  If we use tcp_trim_head() to remove acked SYN from packet that contains data
  or other flags, skb->len will be incorrectly decremented. We can remove SYN
  flag that has been acked from rtx_queue earlier than tcp_trim_head(), which
  can fix the problem mentioned above.
- Qed: Fix a potential use-after-free in qed_cxt_tables_alloc. [Dinghao
  Liu]

  [ Upstream commit b65d52ac9c085c0c52dee012a210d4e2f352611b ]

  qed_ilt_shadow_alloc() will call qed_ilt_shadow_free() to
  free p_hwfn->p_cxt_mngr->ilt_shadow on error. However,
  qed_cxt_tables_alloc() accesses the freed pointer on failure
  of qed_ilt_shadow_alloc() through calling qed_cxt_mngr_free(),
  which may lead to use-after-free. Fix this issue by setting
  p_mngr->ilt_shadow to NULL in qed_ilt_shadow_free().
- Net/rose: Fix Use-After-Free in rose_ioctl. [Hyunwoo Kim]

  [ Upstream commit 810c38a369a0a0ce625b5c12169abce1dd9ccd53 ]

  Because rose_ioctl() accesses sk->sk_receive_queue
  without holding a sk->sk_receive_queue.lock, it can
  cause a race with rose_accept().
  A use-after-free for skb occurs with the following flow.
  ```
  rose_ioctl() -> skb_peek()
  rose_accept() -> skb_dequeue() -> kfree_skb()
  ```
  Add sk->sk_receive_queue.lock to rose_ioctl() to fix this issue.
- Atm: Fix Use-After-Free in do_vcc_ioctl. [Hyunwoo Kim]

  [ Upstream commit 24e90b9e34f9e039f56b5f25f6e6eb92cdd8f4b3 ]

  Because do_vcc_ioctl() accesses sk->sk_receive_queue
  without holding a sk->sk_receive_queue.lock, it can
  cause a race with vcc_recvmsg().
  A use-after-free for skb occurs with the following flow.
  ```
  do_vcc_ioctl() -> skb_peek()
  vcc_recvmsg() -> skb_recv_datagram() -> skb_free_datagram()
  ```
  Add sk->sk_receive_queue.lock to do_vcc_ioctl() to fix this issue.
- Net: fec: correct queue selection. [Radu Bulie]

  [ Upstream commit 9fc95fe95c3e2a63ced8eeca4b256518ab204b63 ]

  The old implementation extracted VLAN TCI info from the payload
  before the VLAN tag has been pushed in the payload.

  Another problem was that the VLAN TCI was extracted even if the
  packet did not have VLAN protocol header.

  This resulted in invalid VLAN TCI and as a consequence a random
  queue was computed.

  This patch fixes the above issues and use the VLAN TCI from the
  skb if it is present or VLAN TCI from payload if present. If no
  VLAN header is present queue 0 is selected.
- Net: vlan: introduce skb_vlan_eth_hdr() [Vladimir Oltean]

  [ Upstream commit 1f5020acb33f926030f62563c86dffca35c7b701 ]

  Similar to skb_eth_hdr() introduced in commit 96cc4b69581d ("macvlan: do
  not assume mac_header is set in macvlan_broadcast()"), let's introduce a
  skb_vlan_eth_hdr() helper which can be used in TX-only code paths to get
  to the VLAN header based on skb->data rather than based on the
  skb_mac_header(skb).

  We also consolidate the drivers that dereference skb->data to go through
  this helper.
- Atm: solos-pci: Fix potential deadlock on &tx_queue_lock. [Chengfeng
  Ye]

  [ Upstream commit 15319a4e8ee4b098118591c6ccbd17237f841613 ]

  As &card->tx_queue_lock is acquired under softirq context along the
  following call chain from solos_bh(), other acquisition of the same
  lock inside process context should disable at least bh to avoid double
  lock.

  <deadlock #2>
  pclose()
  --> spin_lock(&card->tx_queue_lock)
  <interrupt>
     --> solos_bh()
     --> fpga_tx()
     --> spin_lock(&card->tx_queue_lock)

  This flaw was found by an experimental static analysis tool I am
  developing for irq-related deadlock.

  To prevent the potential deadlock, the patch uses spin_lock_bh()
  on &card->tx_queue_lock under process context code consistently to
  prevent the possible deadlock scenario.
- Atm: solos-pci: Fix potential deadlock on &cli_queue_lock. [Chengfeng
  Ye]

  [ Upstream commit d5dba32b8f6cb39be708b726044ba30dbc088b30 ]

  As &card->cli_queue_lock is acquired under softirq context along the
  following call chain from solos_bh(), other acquisition of the same
  lock inside process context should disable at least bh to avoid double
  lock.

  <deadlock #1>
  console_show()
  --> spin_lock(&card->cli_queue_lock)
  <interrupt>
     --> solos_bh()
     --> spin_lock(&card->cli_queue_lock)

  This flaw was found by an experimental static analysis tool I am
  developing for irq-related deadlock.

  To prevent the potential deadlock, the patch uses spin_lock_bh()
  on the card->cli_queue_lock under process context code consistently
  to prevent the possible deadlock scenario.
- Qca_spi: Fix reset behavior. [Stefan Wahren]

  [ Upstream commit 1057812d146dd658c9a9a96d869c2551150207b5 ]

  In case of a reset triggered by the QCA7000 itself, the behavior of the
  qca_spi driver was not quite correct:
  - in case of a pending RX frame decoding the drop counter must be
    incremented and decoding state machine reseted
  - also the reset counter must always be incremented regardless of sync
    state
- Qca_debug: Fix ethtool -G iface tx behavior. [Stefan Wahren]

  [ Upstream commit 96a7e861d9e04d07febd3011c30cd84cd141d81f ]

  After calling ethtool -g it was not possible to adjust the TX ring
  size again:

    # ethtool -g eth1
    Ring parameters for eth1:
    Pre-set maximums:
    RX:		4
    RX Mini:	n/a
    RX Jumbo:	n/a
    TX:		10
    Current hardware settings:
    RX:		4
    RX Mini:	n/a
    RX Jumbo:	n/a
    TX:		10
    # ethtool -G eth1 tx 8
    netlink error: Invalid argument

  The reason for this is that the readonly setting rx_pending get
  initialized and after that the range check in qcaspi_set_ringparam()
  fails regardless of the provided parameter. So fix this by accepting
  the exposed RX defaults. Instead of adding another magic number
  better use a new define here.
- Qca_debug: Prevent crash on TX ring changes. [Stefan Wahren]

  [ Upstream commit f4e6064c97c050bd9904925ff7d53d0c9954fc7b ]

  The qca_spi driver stop and restart the SPI kernel thread
  (via ndo_stop & ndo_open) in case of TX ring changes. This is
  a big issue because it allows userspace to prevent restart of
  the SPI kernel thread (via signals). A subsequent change of
  TX ring wrongly assume a valid spi_thread pointer which result
  in a crash.

  So prevent this by stopping the network traffic handling and
  temporary park the SPI thread.
- Net: ipv6: support reporting otherwise unknown prefix flags in
  RTM_NEWPREFIX. [Maciej Żenczykowski]

  [ Upstream commit bd4a816752bab609dd6d65ae021387beb9e2ddbd ]

  Lorenzo points out that we effectively clear all unknown
  flags from PIO when copying them to userspace in the netlink
  RTM_NEWPREFIX notification.

  We could fix this one at a time as new flags are defined,
  or in one fell swoop - I choose the latter.

  We could either define 6 new reserved flags (reserved1..6) and handle
  them individually (and rename them as new flags are defined), or we
  could simply copy the entire unmodified byte over - I choose the latter.

  This unfortunately requires some anonymous union/struct magic,
  so we add a static assert on the struct size for a little extra safety.
- HID: lenovo: Restrict detection of patched firmware only to USB
  cptkbd. [Mikhail Khvainitski]

  [ Upstream commit 43527a0094c10dfbf0d5a2e7979395a38de3ff65 ]

  Commit 46a0a2c96f0f ("HID: lenovo: Detect quirk-free fw on cptkbd and
  stop applying workaround") introduced a regression for ThinkPad
  TrackPoint Keyboard II which has similar quirks to cptkbd (so it uses
  the same workarounds) but slightly different so that there are
  false-positives during detecting well-behaving firmware. This commit
  restricts detecting well-behaving firmware to the only model which
  known to have one and have stable enough quirks to not cause
  false-positives.
- Afs: Fix refcount underflow from error handling race. [David Howells]

  [ Upstream commit 52bf9f6c09fca8c74388cd41cc24e5d1bff812a9 ]

  If an AFS cell that has an unreachable (eg. ENETUNREACH) server listed (VL
  server or fileserver), an asynchronous probe to one of its addresses may
  fail immediately because sendmsg() returns an error.  When this happens, a
  refcount underflow can happen if certain events hit a very small window.

  The way this occurs is:

   (1) There are two levels of "call" object, the afs_call and the
       rxrpc_call.  Each of them can be transitioned to a "completed" state
       in the event of success or failure.

   (2) Asynchronous afs_calls are self-referential whilst they are active to
       prevent them from evaporating when they're not being processed.  This
       reference is disposed of when the afs_call is completed.

       Note that an afs_call may only be completed once; once completed
       completing it again will do nothing.

   (3) When a call transmission is made, the app-side rxrpc code queues a Tx
       buffer for the rxrpc I/O thread to transmit.  The I/O thread invokes
       sendmsg() to transmit it - and in the case of failure, it transitions
       the rxrpc_call to the completed state.

   (4) When an rxrpc_call is completed, the app layer is notified.  In this
       case, the app is kafs and it schedules a work item to process events
       pertaining to an afs_call.

   (5) When the afs_call event processor is run, it goes down through the
       RPC-specific handler to afs_extract_data() to retrieve data from rxrpc
       - and, in this case, it picks up the error from the rxrpc_call and
       returns it.

       The error is then propagated to the afs_call and that is completed
       too.  At this point the self-reference is released.

   (6) If the rxrpc I/O thread manages to complete the rxrpc_call within the
       window between rxrpc_send_data() queuing the request packet and
       checking for call completion on the way out, then
       rxrpc_kernel_send_data() will return the error from sendmsg() to the
       app.

   (7) Then afs_make_call() will see an error and will jump to the error
       handling path which will attempt to clean up the afs_call.

   (8) The problem comes when the error handling path in afs_make_call()
       tries to unconditionally drop an async afs_call's self-reference.
       This self-reference, however, may already have been dropped by
       afs_extract_data() completing the afs_call

   (9) The refcount underflows when we return to afs_do_probe_vlserver() and
       that tries to drop its reference on the afs_call.

  Fix this by making afs_make_call() attempt to complete the afs_call rather
  than unconditionally putting it.  That way, if afs_extract_data() manages
  to complete the call first, afs_make_call() won't do anything.

  The bug can be forced by making do_udp_sendmsg() return -ENETUNREACH and
  sticking an msleep() in rxrpc_send_data() after the 'success:' label to
  widen the race window.

  The error message looks something like:

      refcount_t: underflow; use-after-free.
      WARNING: CPU: 3 PID: 720 at lib/refcount.c:28 refcount_warn_saturate+0xba/0x110
      ...
      RIP: 0010:refcount_warn_saturate+0xba/0x110
      ...
      afs_put_call+0x1dc/0x1f0 [kafs]
      afs_fs_get_capabilities+0x8b/0xe0 [kafs]
      afs_fs_probe_fileserver+0x188/0x1e0 [kafs]
      afs_lookup_server+0x3bf/0x3f0 [kafs]
      afs_alloc_server_list+0x130/0x2e0 [kafs]
      afs_create_volume+0x162/0x400 [kafs]
      afs_get_tree+0x266/0x410 [kafs]
      vfs_get_tree+0x25/0xc0
      fc_mount+0xe/0x40
      afs_d_automount+0x1b3/0x390 [kafs]
      __traverse_mounts+0x8f/0x210
      step_into+0x340/0x760
      path_openat+0x13a/0x1260
      do_filp_open+0xaf/0x160
      do_sys_openat2+0xaf/0x170

  or something like:

      refcount_t: underflow; use-after-free.
      ...
      RIP: 0010:refcount_warn_saturate+0x99/0xda
      ...
      afs_put_call+0x4a/0x175
      afs_send_vl_probes+0x108/0x172
      afs_select_vlserver+0xd6/0x311
      afs_do_cell_detect_alias+0x5e/0x1e9
      afs_cell_detect_alias+0x44/0x92
      afs_validate_fc+0x9d/0x134
      afs_get_tree+0x20/0x2e6
      vfs_get_tree+0x1d/0xc9
      fc_mount+0xe/0x33
      afs_d_automount+0x48/0x9d
      __traverse_mounts+0xe0/0x166
      step_into+0x140/0x274
      open_last_lookups+0x1c1/0x1df
      path_openat+0x138/0x1c3
      do_filp_open+0x55/0xb4
      do_sys_openat2+0x6c/0xb6

  Fixes: 34fa47612bfe ("afs: Fix race in async call refcounting")
  Reported-by: Bill MacAllister <bill@ca-zephyr.org>
  Closes: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1052304
  Suggested-by: Jeffrey E Altman <jaltman@auristor.com>
  Signed-off-by: David Howells <dhowells@redhat.com>
  Reviewed-by: Jeffrey Altman <jaltman@auristor.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Netfilter: nf_tables: fix 'exist' matching on bigendian arches.
  [Florian Westphal]

  [ Upstream commit 63331e37fb227e796894b31d713697612c8dee7f ]

  Maze reports "tcp option fastopen exists" fails to match on
  OpenWrt 22.03.5, r20134-5f15225c1e (5.10.176) router.

  "tcp option fastopen exists" translates to:
  inet
    [ exthdr load tcpopt 1b @ 34 + 0 present => reg 1 ]
    [ cmp eq reg 1 0x00000001 ]

  .. but existing nft userspace generates a 1-byte compare.

  On LSB (x86), "*reg32 = 1" is identical to nft_reg_store8(reg32, 1), but
  not on MSB, which will place the 1 last. IOW, on bigendian aches the cmp8
  is awalys false.

  Make sure we store this in a consistent fashion, so existing userspace
  will also work on MSB (bigendian).

  Regardless of this patch we can also change nft userspace to generate
  'reg32 == 0' and 'reg32 != 0' instead of u8 == 0 // u8 == 1 when
  adding 'option x missing/exists' expressions as well.
- Linux 5.10.204. [Greg Kroah-Hartman]
- R8169: fix rtl8125b PAUSE frames blasting when suspended. [ChunHao
  Lin]

  [ Upstream commit 4b0768b6556af56ee9b7cf4e68452a2b6289ae45 ]

  When FIFO reaches near full state, device will issue pause frame.
  If pause slot is enabled(set to 1), in this time, device will issue
  pause frame only once. But if pause slot is disabled(set to 0), device
  will keep sending pause frames until FIFO reaches near empty state.

  When pause slot is disabled, if there is no one to handle receive
  packets, device FIFO will reach near full state and keep sending
  pause frames. That will impact entire local area network.

  This issue can be reproduced in Chromebox (not Chromebook) in
  developer mode running a test image (and v5.10 kernel):
  1) ping -f $CHROMEBOX (from workstation on same local network)
  2) run "powerd_dbus_suspend" from command line on the $CHROMEBOX
  3) ping $ROUTER (wait until ping fails from workstation)

  Takes about ~20-30 seconds after step 2 for the local network to
  stop working.

  Fix this issue by enabling pause slot to only send pause frame once
  when FIFO reaches near full state.
- Devcoredump: Send uevent once devcd is ready. [Mukesh Ojha]

  [ Upstream commit af54d778a03853801d681c98c0c2a6c316ef9ca7 ]

  dev_coredumpm() creates a devcoredump device and adds it
  to the core kernel framework which eventually end up
  sending uevent to the user space and later creates a
  symbolic link to the failed device. An application
  running in userspace may be interested in this symbolic
  link to get the name of the failed device.

  In a issue scenario, once uevent sent to the user space
  it start reading '/sys/class/devcoredump/devcdX/failing_device'
  to get the actual name of the device which might not been
  created and it is in its path of creation.

  To fix this, suppress sending uevent till the failing device
  symbolic link gets created and send uevent once symbolic
  link is created successfully.
- Devcoredump : Serialize devcd_del work. [Mukesh Ojha]

  [ Upstream commit 01daccf748323dfc61112f474cf2ba81015446b0 ]

  In following scenario(diagram), when one thread X running dev_coredumpm()
  adds devcd device to the framework which sends uevent notification to
  userspace and another thread Y reads this uevent and call to
  devcd_data_write() which eventually try to delete the queued timer that
  is not initialized/queued yet.

  So, debug object reports some warning and in the meantime, timer is
  initialized and queued from X path. and from Y path, it gets reinitialized
  again and timer->entry.pprev=NULL and try_to_grab_pending() stucks.

  To fix this, introduce mutex and a boolean flag to serialize the behaviour.

   	cpu0(X)			                cpu1(Y)

      dev_coredump() uevent sent to user space
      device_add()  ======================> user space process Y reads the
                                            uevents writes to devcd fd
                                            which results into writes to

                                           devcd_data_write()
                                             mod_delayed_work()
                                               try_to_grab_pending()
                                                 del_timer()
                                                   debug_assert_init()
     INIT_DELAYED_WORK()
     schedule_delayed_work()
                                                     debug_object_fixup()
                                                       timer_fixup_assert_init()
                                                         timer_setup()
                                                           do_init_timer()
                                                         /*
                                                          Above call reinitializes
                                                          the timer to
                                                          timer->entry.pprev=NULL
                                                          and this will be checked
                                                          later in timer_pending() call.
                                                         */
                                                   timer_pending()
                                                    !hlist_unhashed_lockless(&timer->entry)
                                                      !h->pprev
                                                  /*
                                                    del_timer() checks h->pprev and finds
                                                    it to be NULL due to which
                                                    try_to_grab_pending() stucks.
                                                  */
- Smb: client: fix potential NULL deref in parse_dfs_referrals() [Paulo
  Alcantara]

  [ Upstream commit 92414333eb375ed64f4ae92d34d579e826936480 ]

  If server returned no data for FSCTL_DFS_GET_REFERRALS, @dfs_rsp will
  remain NULL and then parse_dfs_referrals() will dereference it.

  Fix this by returning -EIO when no output data is returned.

  Besides, we can't fix it in SMB2_ioctl() as some FSCTLs are allowed to
  return no data as per MS-SMB2 2.2.32.
- Cifs: Fix non-availability of dedup breaking generic/304. [David
  Howells]

  [ Upstream commit 691a41d8da4b34fe72f09393505f55f28a8f34ec ]

  Deduplication isn't supported on cifs, but cifs doesn't reject it, instead
  treating it as extent duplication/cloning.  This can cause generic/304 to go
  silly and run for hours on end.

  Fix cifs to indicate EOPNOTSUPP if REMAP_FILE_DEDUP is set in
  ->remap_file_range().

  Note that it's unclear whether or not commit b073a08016a1 is meant to cause
  cifs to return an error if REMAP_FILE_DEDUP.

  Fixes: b073a08016a1 ("cifs: fix that return -EINVAL when do dedupe operation")
  Cc: stable@vger.kernel.org
  Suggested-by: Dave Chinner <david@fromorbit.com>
  cc: Xiaoli Feng <fengxiaoli0714@gmail.com>
  cc: Shyam Prasad N <nspmangalore@gmail.com>
  cc: Rohith Surabattula <rohiths.msft@gmail.com>
  cc: Jeff Layton <jlayton@kernel.org>
  cc: Darrick Wong <darrick.wong@oracle.com>
  cc: fstests@vger.kernel.org
  cc: linux-cifs@vger.kernel.org
  cc: linux-fsdevel@vger.kernel.org
- Revert "btrfs: add dmesg output for first mount and last unmount of a
  filesystem" [Greg Kroah-Hartman]

  This reverts commit 2d6c2238acf8043ec71cdede3542efd54e02798a which is
  commit 2db313205f8b96eea467691917138d646bb50aef upstream.

  As pointed out by many, the disk_super structure is NOT initialized
  before it is dereferenced in the function
  fs/btrfs/disk-io.c:open_ctree() that this commit adds, so something went
  wrong here.

  Revert it for now until it gets straightened out.
- Mmc: block: Be sure to wait while busy in CQE error recovery. [Adrian
  Hunter]

  commit c616696a902987352426fdaeec1b0b3240949e6b upstream.

  STOP command does not guarantee to wait while busy, but subsequent command
  MMC_CMDQ_TASK_MGMT to discard the queue will fail if the card is busy, so
  be sure to wait by employing mmc_poll_for_busy().
- Platform/x86: asus-wmi: Document the dgpu_disable sysfs attribute.
  [Luke D. Jones]

  commit 7e64c486e807c8edfbd3a0c8e44ad7a1896dbec8 upstream.

  The dgpu_disable attribute was not documented, this adds the
  required documentation.
- Tools headers UAPI: Sync linux/perf_event.h with the kernel sources.
  [Namhyung Kim]

  commit 65ba872a6971c11ceb342c3330f059289c0e6bdb upstream.

  To pick the trivial change in:

    119a784c81270eb8 ("perf/core: Add a new read format to get a number of lost samples")
- Platform/x86: asus-wmi: Fix kbd_dock_devid tablet-switch reporting.
  [Hans de Goede]

  commit fdcc0602d64f22185f61c70747214b630049cc33 upstream.

  Commit 1ea0d3b46798 ("platform/x86: asus-wmi: Simplify tablet-mode-switch
  handling") unified the asus-wmi tablet-switch handling, but it did not take
  into account that the value returned for the kbd_dock_devid WMI method is
  inverted where as the other ones are not inverted.

  This causes asus-wmi to report an inverted tablet-switch state for devices
  which use the kbd_dock_devid, which causes libinput to ignore touchpad
  events while the affected T10x model 2-in-1s are docked.

  Add inverting of the return value in the kbd_dock_devid case to fix this.
- Netfilter: nft_set_pipapo: skip inactive elements during set walk.
  [Florian Westphal]

  commit 317eb9685095678f2c9f5a8189de698c5354316a upstream.

  Otherwise set elements can be deactivated twice which will cause a crash.
- Drop_monitor: Require 'CAP_SYS_ADMIN' when joining "events" group.
  [Ido Schimmel]

  commit e03781879a0d524ce3126678d50a80484a513c4b upstream.

  The "NET_DM" generic netlink family notifies drop locations over the
  "events" multicast group. This is problematic since by default generic
  netlink allows non-root users to listen to these notifications.

  Fix by adding a new field to the generic netlink multicast group
  structure that when set prevents non-root users or root without the
  'CAP_SYS_ADMIN' capability (in the user namespace owning the network
  namespace) from joining the group. Set this field for the "events"
  group. Use 'CAP_SYS_ADMIN' rather than 'CAP_NET_ADMIN' because of the
  nature of the information that is shared over this group.

  Note that the capability check in this case will always be performed
  against the initial user namespace since the family is not netns aware
  and only operates in the initial network namespace.

  A new field is added to the structure rather than using the "flags"
  field because the existing field uses uAPI flags and it is inappropriate
  to add a new uAPI flag for an internal kernel check. In net-next we can
  rework the "flags" field to use internal flags and fold the new field
  into it. But for now, in order to reduce the amount of changes, add a
  new field.

  Since the information can only be consumed by root, mark the control
  plane operations that start and stop the tracing as root-only using the
  'GENL_ADMIN_PERM' flag.

  Tested using [1].

  Before:

   # capsh -- -c ./dm_repo
   # capsh --drop=cap_sys_admin -- -c ./dm_repo

  After:

   # capsh -- -c ./dm_repo
   # capsh --drop=cap_sys_admin -- -c ./dm_repo
   Failed to join "events" multicast group

  [1]
   $ cat dm.c
   #include <stdio.h>
   #include <netlink/genl/ctrl.h>
   #include <netlink/genl/genl.h>
   #include <netlink/socket.h>

   int main(int argc, char **argv)
   {
   	struct nl_sock *sk;
   	int grp, err;

   	sk = nl_socket_alloc();
   	if (!sk) {
   		fprintf(stderr, "Failed to allocate socket\n");
   		return -1;
   	}

   	err = genl_connect(sk);
   	if (err) {
   		fprintf(stderr, "Failed to connect socket\n");
   		return err;
   	}

   	grp = genl_ctrl_resolve_grp(sk, "NET_DM", "events");
   	if (grp < 0) {
   		fprintf(stderr,
   			"Failed to resolve \"events\" multicast group\n");
   		return grp;
   	}

   	err = nl_socket_add_memberships(sk, grp, NFNLGRP_NONE);
   	if (err) {
   		fprintf(stderr, "Failed to join \"events\" multicast group\n");
   		return err;
   	}

   	return 0;
   }
   $ gcc -I/usr/include/libnl3 -lnl-3 -lnl-genl-3 -o dm_repo dm.c
- Psample: Require 'CAP_NET_ADMIN' when joining "packets" group. [Ido
  Schimmel]

  commit 44ec98ea5ea9cfecd31a5c4cc124703cb5442832 upstream.

  The "psample" generic netlink family notifies sampled packets over the
  "packets" multicast group. This is problematic since by default generic
  netlink allows non-root users to listen to these notifications.

  Fix by marking the group with the 'GENL_UNS_ADMIN_PERM' flag. This will
  prevent non-root users or root without the 'CAP_NET_ADMIN' capability
  (in the user namespace owning the network namespace) from joining the
  group.

  Tested using [1].

  Before:

   # capsh -- -c ./psample_repo
   # capsh --drop=cap_net_admin -- -c ./psample_repo

  After:

   # capsh -- -c ./psample_repo
   # capsh --drop=cap_net_admin -- -c ./psample_repo
   Failed to join "packets" multicast group

  [1]
   $ cat psample.c
   #include <stdio.h>
   #include <netlink/genl/ctrl.h>
   #include <netlink/genl/genl.h>
   #include <netlink/socket.h>

   int join_grp(struct nl_sock *sk, const char *grp_name)
   {
   	int grp, err;

   	grp = genl_ctrl_resolve_grp(sk, "psample", grp_name);
   	if (grp < 0) {
   		fprintf(stderr, "Failed to resolve \"%s\" multicast group\n",
   			grp_name);
   		return grp;
   	}

   	err = nl_socket_add_memberships(sk, grp, NFNLGRP_NONE);
   	if (err) {
   		fprintf(stderr, "Failed to join \"%s\" multicast group\n",
   			grp_name);
   		return err;
   	}

   	return 0;
   }

   int main(int argc, char **argv)
   {
   	struct nl_sock *sk;
   	int err;

   	sk = nl_socket_alloc();
   	if (!sk) {
   		fprintf(stderr, "Failed to allocate socket\n");
   		return -1;
   	}

   	err = genl_connect(sk);
   	if (err) {
   		fprintf(stderr, "Failed to connect socket\n");
   		return err;
   	}

   	err = join_grp(sk, "config");
   	if (err)
   		return err;

   	err = join_grp(sk, "packets");
   	if (err)
   		return err;

   	return 0;
   }
   $ gcc -I/usr/include/libnl3 -lnl-3 -lnl-genl-3 -o psample_repo psample.c
- Genetlink: add CAP_NET_ADMIN test for multicast bind. [Ido Schimmel]

  This is a partial backport of upstream commit 4d54cc32112d ("mptcp:
  avoid lock_fast usage in accept path"). It is only a partial backport
  because the patch in the link below was erroneously squash-merged into
  upstream commit 4d54cc32112d ("mptcp: avoid lock_fast usage in accept
  path"). Below is the original patch description from Florian Westphal:

  "
  genetlink sets NL_CFG_F_NONROOT_RECV for its netlink socket so anyone can
  subscribe to multicast messages.

  rtnetlink doesn't allow this unconditionally,  rtnetlink_bind() restricts
  bind requests to CAP_NET_ADMIN for a few groups.

  This allows to set GENL_UNS_ADMIN_PERM flag on genl mcast groups to
  mandate CAP_NET_ADMIN.

  This will be used by the upcoming mptcp netlink event facility which
  exposes the token (mptcp connection identifier) to userspace.
  "
- Netlink: don't call ->netlink_bind with table lock held. [Ido
  Schimmel]

  From: Florian Westphal <fw@strlen.de>

  commit f2764bd4f6a8dffaec3e220728385d9756b3c2cb upstream.

  When I added support to allow generic netlink multicast groups to be
  restricted to subscribers with CAP_NET_ADMIN I was unaware that a
  genl_bind implementation already existed in the past.

  It was reverted due to ABBA deadlock:

  1. ->netlink_bind gets called with the table lock held.
  2. genetlink bind callback is invoked, it grabs the genl lock.

  But when a new genl subsystem is (un)registered, these two locks are
  taken in reverse order.

  One solution would be to revert again and add a comment in genl
  referring 1e82a62fec613, "genetlink: remove genl_bind").

  This would need a second change in mptcp to not expose the raw token
  value anymore, e.g.  by hashing the token with a secret key so userspace
  can still associate subflow events with the correct mptcp connection.

  However, Paolo Abeni reminded me to double-check why the netlink table is
  locked in the first place.

  I can't find one.  netlink_bind() is already called without this lock
  when userspace joins a group via NETLINK_ADD_MEMBERSHIP setsockopt.
  Same holds for the netlink_unbind operation.

  Digging through the history, commit f773608026ee1
  ("netlink: access nlk groups safely in netlink bind and getname")
  expanded the lock scope.

  commit 3a20773beeeeade ("net: netlink: cap max groups which will be considered in netlink_bind()")
  ... removed the nlk->ngroups access that the lock scope
  extension was all about.

  Reduce the lock scope again and always call ->netlink_bind without
  the table lock.

  The Fixes tag should be vs. the patch mentioned in the link below,
  but that one got squash-merged into the patch that came earlier in the
  series.
- Io_uring/af_unix: disable sending io_uring over sockets. [Pavel
  Begunkov]

  commit 705318a99a138c29a512a72c3e0043b3cd7f55f4 upstream.

  File reference cycles have caused lots of problems for io_uring
  in the past, and it still doesn't work exactly right and races with
  unix_stream_read_generic(). The safest fix would be to completely
  disallow sending io_uring files via sockets via SCM_RIGHT, so there
  are no possible cycles invloving registered files and thus rendering
  SCM accounting on the io_uring side unnecessary.
- MIPS: Loongson64: Enable DMA noncoherent support. [Jiaxun Yang]

  commit edc0378eee00200a5bedf1bb9f00ad390e0d1bd4 upstream.

  There are some Loongson64 systems come with broken coherent DMA
  support, firmware will set a bit in boot_param and pass nocoherentio
  in cmdline.

  However nonconherent support was missed out when spin off Loongson-2EF
  form Loongson64, and that boot_param change never made itself into
  upstream.

  Support DMA noncoherent properly to get those systems working.
- MIPS: Loongson64: Reserve vgabios memory on boot. [Jiaxun Yang]

  commit 8f7aa77a463f47c9e00592d02747a9fcf2271543 upstream.

  vgabios is passed from firmware to kernel on Loongson64 systems.
  Sane firmware will keep this pointer in reserved memory space
  passed from the firmware but insane firmware keeps it in low
  memory before kernel entry that is not reserved.

  Previously kernel won't try to allocate memory from low memory
  before kernel entry on boot, but after converting to memblock
  it will do that.

  Fix by resversing those memory on early boot.
- KVM: s390/mm: Properly reset no-dat. [Claudio Imbrenda]

  commit 27072b8e18a73ffeffb1c140939023915a35134b upstream.

  When the CMMA state needs to be reset, the no-dat bit also needs to be
  reset. Failure to do so could cause issues in the guest, since the
  guest expects the bit to be cleared after a reset.
- X86/CPU/AMD: Check vendor in the AMD microcode callback. [Borislav
  Petkov (AMD)]

  commit 9b8493dc43044376716d789d07699f17d538a7c4 upstream.

  Commit in Fixes added an AMD-specific microcode callback. However, it
  didn't check the CPU vendor the kernel runs on explicitly.

  The only reason the Zenbleed check in it didn't run on other x86 vendors
  hardware was pure coincidental luck:

    if (!cpu_has_amd_erratum(c, amd_zenbleed))
  	  return;

  gives true on other vendors because they don't have those families and
  models.

  However, with the removal of the cpu_has_amd_erratum() in

    05f5f73936fa ("x86/CPU/AMD: Drop now unused CPU erratum checking function")

  that coincidental condition is gone, leading to the zenbleed check
  getting executed on other vendors too.

  Add the explicit vendor check for the whole callback as it should've
  been done in the first place.
- Serial: 8250_omap: Add earlycon support for the AM654 UART controller.
  [Ronald Wahl]

  commit 8e42c301ce64e0dcca547626eb486877d502d336 upstream.

  Currently there is no support for earlycon on the AM654 UART
  controller. This commit adds it.
- Serial: 8250: 8250_omap: Do not start RX DMA on THRI interrupt.
  [Ronald Wahl]

  commit c6bb057418876cdfdd29a6f7b8cef54539ee8811 upstream.

  Starting RX DMA on THRI interrupt is too early because TX may not have
  finished yet.

  This change is inspired by commit 90b8596ac460 ("serial: 8250: Prevent
  starting up DMA Rx on THRI interrupt") and fixes DMA issues I had with
  an AM62 SoC that is using the 8250 OMAP variant.
- Serial: 8250: 8250_omap: Clear UART_HAS_RHR_IT_DIS bit. [Ronald Wahl]

  commit 8973ab7a2441b286218f4a5c4c33680e2f139996 upstream.

  This fixes commit 439c7183e5b9 ("serial: 8250: 8250_omap: Disable RX
  interrupt after DMA enable") which unfortunately set the
  UART_HAS_RHR_IT_DIS bit in the UART_OMAP_IER2 register and never
  cleared it.
- Serial: sc16is7xx: address RX timeout interrupt errata. [Daniel Mack]

  commit 08ce9a1b72e38cf44c300a44ac5858533eb3c860 upstream.

  This device has a silicon bug that makes it report a timeout interrupt
  but no data in the FIFO.

  The datasheet states the following in the errata section 18.1.4:

    "If the host reads the receive FIFO at the same time as a
    time-out interrupt condition happens, the host might read 0xCC
    (time-out) in the Interrupt Indication Register (IIR), but bit 0
    of the Line Status Register (LSR) is not set (means there is no
    data in the receive FIFO)."

  The errata description seems to indicate it concerns only polled mode of
  operation when reading bit 0 of the LSR register. However, tests have
  shown and NXP has confirmed that the RXLVL register also yields 0 when
  the bug is triggered, and hence the IRQ driven implementation in this
  driver is equally affected.

  This bug has hit us on production units and when it does, sc16is7xx_irq()
  would spin forever because sc16is7xx_port_irq() keeps seeing an
  interrupt in the IIR register that is not cleared because the driver
  does not call into sc16is7xx_handle_rx() unless the RXLVL register
  reports at least one byte in the FIFO.

  Fix this by always reading one byte from the FIFO when this condition
  is detected in order to clear the interrupt. This approach was
  confirmed to be correct by NXP through their support channels.

  Tested by: Hugo Villeneuve <hvilleneuve@dimonoff.com>
- ARM: PL011: Fix DMA support. [Arnd Bergmann]

  commit 58ac1b3799799069d53f5bf95c093f2fe8dd3cc5 upstream.

  Since there is no guarantee that the memory returned by
  dma_alloc_coherent() is associated with a 'struct page', using the
  architecture specific phys_to_page() is wrong, but using
  virt_to_page() would be as well.

  Stop using sg lists altogether and just use the *_single() functions
  instead. This also simplifies the code a bit since the scatterlists in
  this driver always have only one entry anyway.

  https://lore.kernel.org/lkml/86db0fe5-930d-4cbb-bd7d-03367da38951@app.fastmail.com/
      Use consistent names for dma buffers

  gc: Add a commit log from the initial thread:
  https://lore.kernel.org/lkml/86db0fe5-930d-4cbb-bd7d-03367da38951@app.fastmail.com/
      Use consistent names for dma buffers
- Usb: typec: class: fix typec_altmode_put_partner to put plugs. [RD
  Babiera]

  commit b17b7fe6dd5c6ff74b38b0758ca799cdbb79e26e upstream.

  When typec_altmode_put_partner is called by a plug altmode upon release,
  the port altmode the plug belongs to will not remove its reference to the
  plug. The check to see if the altmode being released evaluates against the
  released altmode's partner instead of the calling altmode itself, so change
  adev in typec_altmode_put_partner to properly refer to the altmode being
  released.

  typec_altmode_set_partner is not run for port altmodes, so also add a check
  in typec_altmode_release to prevent typec_altmode_put_partner() calls on
  port altmode release.
- Revert "xhci: Loosen RPM as default policy to cover for AMD xHC 1.1"
  [Mathias Nyman]

  commit 24be0b3c40594a14b65141ced486ae327398faf8 upstream.

  This reverts commit 4baf1218150985ee3ab0a27220456a1f027ea0ac.

  Enabling runtime pm as default for all AMD xHC 1.1 controllers caused
  regression. An initial attempt to fix those was done in commit a5d6264b638e
  ("xhci: Enable RPM on controllers that support low-power states") but new
  issues are still seen.

  Revert this to get those AMD xHC 1.1 systems working

  This patch went to stable an needs to be reverted from there as well.
- Parport: Add support for Brainboxes IX/UC/PX parallel cards. [Cameron
  Williams]

  commit 1a031f6edc460e9562098bdedc3918da07c30a6e upstream.

  Adds support for Intashield IX-500/IX-550, UC-146/UC-157, PX-146/PX-157,
  PX-203 and PX-475 (LPT port)
- Usb: gadget: f_hid: fix report descriptor allocation. [Konstantin
  Aladyshev]

  commit 61890dc28f7d9e9aac8a9471302613824c22fae4 upstream.

  The commit 89ff3dfac604 ("usb: gadget: f_hid: fix f_hidg lifetime vs
  cdev") has introduced a bug that leads to hid device corruption after
  the replug operation.
  Reverse device managed memory allocation for the report descriptor
  to fix the issue.

  Tested:
  This change was tested on the AMD EthanolX CRB server with the BMC
  based on the OpenBMC distribution. The BMC provides KVM functionality
  via the USB gadget device:
  - before: KVM page refresh results in a broken USB device,
  - after: KVM page refresh works without any issues.
- Drm/amdgpu: correct the amdgpu runtime dereference usage count. [Prike
  Liang]

  [ Upstream commit c6df7f313794c3ad41a49b9a7c95da369db607f3 ]

  Fix the amdgpu runpm dereference usage count.
- Gpiolib: sysfs: Fix error handling on failed export. [Boerge
  Struempfel]

  [ Upstream commit 95dd1e34ff5bbee93a28ff3947eceaf6de811b1a ]

  If gpio_set_transitory() fails, we should free the GPIO again. Most
  notably, the flag FLAG_REQUESTED has previously been set in
  gpiod_request_commit(), and should be reset on failure.

  To my knowledge, this does not affect any current users, since the
  gpio_set_transitory() mainly returns 0 and -ENOTSUPP, which is converted
  to 0. However the gpio_set_transitory() function calles the .set_config()
  function of the corresponding GPIO chip and there are some GPIO drivers in
  which some (unlikely) branches return other values like -EPROBE_DEFER,
  and -EINVAL. In these cases, the above mentioned FLAG_REQUESTED would not
  be reset, which results in the pin being blocked until the next reboot.
- Perf: Fix perf_event_validate_size() [Peter Zijlstra]

  [ Upstream commit 382c27f4ed28f803b1f1473ac2d8db0afc795a1b ]

  Budimir noted that perf_event_validate_size() only checks the size of
  the newly added event, even though the sizes of all existing events
  can also change due to not all events having the same read_format.

  When we attach the new event, perf_group_attach(), we do re-compute
  the size for all events.
- Perf/core: Add a new read format to get a number of lost samples.
  [Namhyung Kim]

  [ Upstream commit 119a784c81270eb88e573174ed2209225d646656 ]

  Sometimes we want to know an accurate number of samples even if it's
  lost.  Currenlty PERF_RECORD_LOST is generated for a ring-buffer which
  might be shared with other events.  So it's hard to know per-event
  lost count.

  Add event->lost_samples field and PERF_FORMAT_LOST to retrieve it from
  userspace.
- Tracing: Stop current tracer when resizing buffer. [Steven Rostedt
  (Google)]

  [ Upstream commit d78ab792705c7be1b91243b2544d1a79406a2ad7 ]

  When the ring buffer is being resized, it can cause side effects to the
  running tracer. For instance, there's a race with irqsoff tracer that
  swaps individual per cpu buffers between the main buffer and the snapshot
  buffer. The resize operation modifies the main buffer and then the
  snapshot buffer. If a swap happens in between those two operations it will
  break the tracer.

  Simply stop the running tracer before resizing the buffers and enable it
  again when finished.
- Tracing: Set actual size after ring buffer resize. [Zheng Yejian]

  [ Upstream commit 6d98a0f2ac3c021d21be66fa34e992137cd25bcb ]

  Currently we can resize trace ringbuffer by writing a value into file
  'buffer_size_kb', then by reading the file, we get the value that is
  usually what we wrote. However, this value may be not actual size of
  trace ring buffer because of the round up when doing resize in kernel,
  and the actual size would be more useful.
- Ring-buffer: Force absolute timestamp on discard of event. [Steven
  Rostedt (Google)]

  [ Upstream commit b2dd797543cfa6580eac8408dd67fa02164d9e56 ]

  There's a race where if an event is discarded from the ring buffer and an
  interrupt were to happen at that time and insert an event, the time stamp
  is still used from the discarded event as an offset. This can screw up the
  timings.

  If the event is going to be discarded, set the "before_stamp" to zero.
  When a new event comes in, it compares the "before_stamp" with the
  "write_stamp" and if they are not equal, it will insert an absolute
  timestamp. This will prevent the timings from getting out of sync due to
  the discarded event.
- Misc: mei: client.c: fix problem of return '-EOVERFLOW' in
  mei_cl_write. [Su Hui]

  [ Upstream commit ee6236027218f8531916f1c5caa5dc330379f287 ]

  Clang static analyzer complains that value stored to 'rets' is never
  read.Let 'buf_len = -EOVERFLOW' to make sure we can return '-EOVERFLOW'.
- Misc: mei: client.c: return negative error code in mei_cl_write. [Su
  Hui]

  [ Upstream commit 8f06aee8089cf42fd99a20184501bd1347ce61b9 ]

  mei_msg_hdr_init() return negative error code, rets should be
  'PTR_ERR(mei_hdr)' rather than '-PTR_ERR(mei_hdr)'.
- Arm64: dts: mediatek: mt8183: Fix unit address for scp reserved
  memory. [AngeloGioacchino Del Regno]

  commit 19cba9a6c071db57888dc6b2ec1d9bf8996ea681 upstream.

  The reserved memory for scp had node name "scp_mem_region" and also
  without unit-address: change the name to "memory@(address)".
  This fixes a unit_address_vs_reg warning.
- Arm64: dts: mediatek: mt8173-evb: Fix regulator-fixed node names.
  [AngeloGioacchino Del Regno]

  commit 24165c5dad7ba7c7624d05575a5e0cc851396c71 upstream.

  Fix a unit_address_vs_reg warning for the USB VBUS fixed regulators
  by renaming the regulator nodes from regulator@{0,1} to regulator-usb-p0
  and regulator-usb-p1.
- Arm64: dts: mediatek: mt7622: fix memory node warning check. [Eugen
  Hristev]

  commit 8e6ecbfd44b5542a7598c1c5fc9c6dcb5d367f2a upstream.

  dtbs_check throws a warning at the memory node:
  Warning (unit_address_vs_reg): /memory: node has a reg or ranges property, but no unit name

  fix by adding the address into the node name.
- Packet: Move reference count in packet_sock to atomic_long_t. [Daniel
  Borkmann]

  commit db3fadacaf0c817b222090290d06ca2a338422d0 upstream.

  In some potential instances the reference count on struct packet_sock
  could be saturated and cause overflows which gets the kernel a bit
  confused. To prevent this, move to a 64-bit atomic reference count on
  64-bit architectures to prevent the possibility of this type to overflow.

  Because we can not handle saturation, using refcount_t is not possible
  in this place. Maybe someday in the future if it changes it could be
  used. Also, instead of using plain atomic64_t, use atomic_long_t instead.
  32-bit machines tend to be memory-limited (i.e. anything that increases
  a reference uses so much memory that you can't actually get to 2**32
  references). 32-bit architectures also tend to have serious problems
  with 64-bit atomics. Hence, atomic_long_t is the more natural solution.
- Tracing: Fix a possible race when disabling buffered events. [Petr
  Pavlu]

  commit c0591b1cccf708a47bc465c62436d669a4213323 upstream.

  Function trace_buffered_event_disable() is responsible for freeing pages
  backing buffered events and this process can run concurrently with
  trace_event_buffer_lock_reserve().

  The following race is currently possible:

  * Function trace_buffered_event_disable() is called on CPU 0. It
    increments trace_buffered_event_cnt on each CPU and waits via
    synchronize_rcu() for each user of trace_buffered_event to complete.

  * After synchronize_rcu() is finished, function
    trace_buffered_event_disable() has the exclusive access to
    trace_buffered_event. All counters trace_buffered_event_cnt are at 1
    and all pointers trace_buffered_event are still valid.

  * At this point, on a different CPU 1, the execution reaches
    trace_event_buffer_lock_reserve(). The function calls
    preempt_disable_notrace() and only now enters an RCU read-side
    critical section. The function proceeds and reads a still valid
    pointer from trace_buffered_event[CPU1] into the local variable
    "entry". However, it doesn't yet read trace_buffered_event_cnt[CPU1]
    which happens later.

  * Function trace_buffered_event_disable() continues. It frees
    trace_buffered_event[CPU1] and decrements
    trace_buffered_event_cnt[CPU1] back to 0.

  * Function trace_event_buffer_lock_reserve() continues. It reads and
    increments trace_buffered_event_cnt[CPU1] from 0 to 1. This makes it
    believe that it can use the "entry" that it already obtained but the
    pointer is now invalid and any access results in a use-after-free.

  Fix the problem by making a second synchronize_rcu() call after all
  trace_buffered_event values are set to NULL. This waits on all potential
  users in trace_event_buffer_lock_reserve() that still read a previous
  pointer from trace_buffered_event.
- Tracing: Fix incomplete locking when disabling buffered events. [Petr
  Pavlu]

  commit 7fed14f7ac9cf5e38c693836fe4a874720141845 upstream.

  The following warning appears when using buffered events:

  [  203.556451] WARNING: CPU: 53 PID: 10220 at kernel/trace/ring_buffer.c:3912 ring_buffer_discard_commit+0x2eb/0x420
  [...]
  [  203.670690] CPU: 53 PID: 10220 Comm: stress-ng-sysin Tainted: G            E      6.7.0-rc2-default #4 56e6d0fcf5581e6e51eaaecbdaec2a2338c80f3a
  [  203.670704] Hardware name: Intel Corp. GROVEPORT/GROVEPORT, BIOS GVPRCRB1.86B.0016.D04.1705030402 05/03/2017
  [  203.670709] RIP: 0010:ring_buffer_discard_commit+0x2eb/0x420
  [  203.735721] Code: 4c 8b 4a 50 48 8b 42 48 49 39 c1 0f 84 b3 00 00 00 49 83 e8 01 75 b1 48 8b 42 10 f0 ff 40 08 0f 0b e9 fc fe ff ff f0 ff 47 08 <0f> 0b e9 77 fd ff ff 48 8b 42 10 f0 ff 40 08 0f 0b e9 f5 fe ff ff
  [  203.735734] RSP: 0018:ffffb4ae4f7b7d80 EFLAGS: 00010202
  [  203.735745] RAX: 0000000000000000 RBX: ffffb4ae4f7b7de0 RCX: ffff8ac10662c000
  [  203.735754] RDX: ffff8ac0c750be00 RSI: ffff8ac10662c000 RDI: ffff8ac0c004d400
  [  203.781832] RBP: ffff8ac0c039cea0 R08: 0000000000000000 R09: 0000000000000000
  [  203.781839] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
  [  203.781842] R13: ffff8ac10662c000 R14: ffff8ac0c004d400 R15: ffff8ac10662c008
  [  203.781846] FS:  00007f4cd8a67740(0000) GS:ffff8ad798880000(0000) knlGS:0000000000000000
  [  203.781851] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [  203.781855] CR2: 0000559766a74028 CR3: 00000001804c4000 CR4: 00000000001506f0
  [  203.781862] Call Trace:
  [  203.781870]  <TASK>
  [  203.851949]  trace_event_buffer_commit+0x1ea/0x250
  [  203.851967]  trace_event_raw_event_sys_enter+0x83/0xe0
  [  203.851983]  syscall_trace_enter.isra.0+0x182/0x1a0
  [  203.851990]  do_syscall_64+0x3a/0xe0
  [  203.852075]  entry_SYSCALL_64_after_hwframe+0x6e/0x76
  [  203.852090] RIP: 0033:0x7f4cd870fa77
  [  203.982920] Code: 00 b8 ff ff ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 66 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 90 b8 89 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d e9 43 0e 00 f7 d8 64 89 01 48
  [  203.982932] RSP: 002b:00007fff99717dd8 EFLAGS: 00000246 ORIG_RAX: 0000000000000089
  [  203.982942] RAX: ffffffffffffffda RBX: 0000558ea1d7b6f0 RCX: 00007f4cd870fa77
  [  203.982948] RDX: 0000000000000000 RSI: 00007fff99717de0 RDI: 0000558ea1d7b6f0
  [  203.982957] RBP: 00007fff99717de0 R08: 00007fff997180e0 R09: 00007fff997180e0
  [  203.982962] R10: 00007fff997180e0 R11: 0000000000000246 R12: 00007fff99717f40
  [  204.049239] R13: 00007fff99718590 R14: 0000558e9f2127a8 R15: 00007fff997180b0
  [  204.049256]  </TASK>

  For instance, it can be triggered by running these two commands in
  parallel:

   $ while true; do
      echo hist:key=id.syscall:val=hitcount > \
        /sys/kernel/debug/tracing/events/raw_syscalls/sys_enter/trigger;
    done
   $ stress-ng --sysinfo $(nproc)

  The warning indicates that the current ring_buffer_per_cpu is not in the
  committing state. It happens because the active ring_buffer_event
  doesn't actually come from the ring_buffer_per_cpu but is allocated from
  trace_buffered_event.

  The bug is in function trace_buffered_event_disable() where the
  following normally happens:

  * The code invokes disable_trace_buffered_event() via
    smp_call_function_many() and follows it by synchronize_rcu(). This
    increments the per-CPU variable trace_buffered_event_cnt on each
    target CPU and grants trace_buffered_event_disable() the exclusive
    access to the per-CPU variable trace_buffered_event.

  * Maintenance is performed on trace_buffered_event, all per-CPU event
    buffers get freed.

  * The code invokes enable_trace_buffered_event() via
    smp_call_function_many(). This decrements trace_buffered_event_cnt and
    releases the access to trace_buffered_event.

  A problem is that smp_call_function_many() runs a given function on all
  target CPUs except on the current one. The following can then occur:

  * Task X executing trace_buffered_event_disable() runs on CPU 0.

  * The control reaches synchronize_rcu() and the task gets rescheduled on
    another CPU 1.

  * The RCU synchronization finishes. At this point,
    trace_buffered_event_disable() has the exclusive access to all
    trace_buffered_event variables except trace_buffered_event[CPU0]
    because trace_buffered_event_cnt[CPU0] is never incremented and if the
    buffer is currently unused, remains set to 0.

  * A different task Y is scheduled on CPU 0 and hits a trace event. The
    code in trace_event_buffer_lock_reserve() sees that
    trace_buffered_event_cnt[CPU0] is set to 0 and decides the use the
    buffer provided by trace_buffered_event[CPU0].

  * Task X continues its execution in trace_buffered_event_disable(). The
    code incorrectly frees the event buffer pointed by
    trace_buffered_event[CPU0] and resets the variable to NULL.

  * Task Y writes event data to the now freed buffer and later detects the
    created inconsistency.

  The issue is observable since commit dea499781a11 ("tracing: Fix warning
  in trace_buffered_event_disable()") which moved the call of
  trace_buffered_event_disable() in __ftrace_event_enable_disable()
  earlier, prior to invoking call->class->reg(.. TRACE_REG_UNREGISTER ..).
  The underlying problem in trace_buffered_event_disable() is however
  present since the original implementation in commit 0fc1b09ff1ff
  ("tracing: Use temp buffer when filtering events").

  Fix the problem by replacing the two smp_call_function_many() calls with
  on_each_cpu_mask() which invokes a given callback on all CPUs.
- Tracing: Disable snapshot buffer when stopping instance tracers.
  [Steven Rostedt (Google)]

  commit b538bf7d0ec11ca49f536dfda742a5f6db90a798 upstream.

  It use to be that only the top level instance had a snapshot buffer (for
  latency tracers like wakeup and irqsoff). When stopping a tracer in an
  instance would not disable the snapshot buffer. This could have some
  unintended consequences if the irqsoff tracer is enabled.

  Consolidate the tracing_start/stop() with tracing_start/stop_tr() so that
  all instances behave the same. The tracing_start/stop() functions will
  just call their respective tracing_start/stop_tr() with the global_array
  passed in.
- Tracing: Always update snapshot buffer size. [Steven Rostedt (Google)]

  commit 7be76461f302ec05cbd62b90b2a05c64299ca01f upstream.

  It use to be that only the top level instance had a snapshot buffer (for
  latency tracers like wakeup and irqsoff). The update of the ring buffer
  size would check if the instance was the top level and if so, it would
  also update the snapshot buffer as it needs to be the same as the main
  buffer.

  Now that lower level instances also has a snapshot buffer, they too need
  to update their snapshot buffer sizes when the main buffer is changed,
  otherwise the following can be triggered:

   # cd /sys/kernel/tracing
   # echo 1500 > buffer_size_kb
   # mkdir instances/foo
   # echo irqsoff > instances/foo/current_tracer
   # echo 1000 > instances/foo/buffer_size_kb

  Produces:

   WARNING: CPU: 2 PID: 856 at kernel/trace/trace.c:1938 update_max_tr_single.part.0+0x27d/0x320

  Which is:

  	ret = ring_buffer_swap_cpu(tr->max_buffer.buffer, tr->array_buffer.buffer, cpu);

  	if (ret == -EBUSY) {
  		[..]
  	}

  	WARN_ON_ONCE(ret && ret != -EAGAIN && ret != -EBUSY);  <== here

  That's because ring_buffer_swap_cpu() has:

  	int ret = -EINVAL;

  	[..]

  	/* At least make sure the two buffers are somewhat the same */
  	if (cpu_buffer_a->nr_pages != cpu_buffer_b->nr_pages)
  		goto out;

  	[..]
   out:
  	return ret;
   }

  Instead, update all instances' snapshot buffer sizes when their main
  buffer size is updated.
- Checkstack: fix printed address. [Heiko Carstens]

  commit ee34db3f271cea4d4252048617919c2caafe698b upstream.

  All addresses printed by checkstack have an extra incorrect 0 appended at
  the end.

  This was introduced with commit 677f1410e058 ("scripts/checkstack.pl: don't
  display $dre as different entity"): since then the address is taken from
  the line which contains the function name, instead of the line which
  contains stack consumption. E.g. on s390:

  0000000000100a30 <do_one_initcall>:
  ...
    100a44:       e3 f0 ff 70 ff 71       lay     %r15,-144(%r15)

  So the used regex which matches spaces and hexadecimal numbers to extract
  an address now matches a different substring. Subsequently replacing spaces
  with 0 appends a zero at the and, instead of replacing leading spaces.

  Fix this by using the proper regex, and simplify the code a bit.
- Nilfs2: prevent WARNING in nilfs_sufile_set_segment_usage() [Ryusuke
  Konishi]

  commit 675abf8df1353e0e3bde314993e0796c524cfbf0 upstream.

  If nilfs2 reads a disk image with corrupted segment usage metadata, and
  its segment usage information is marked as an error for the segment at the
  write location, nilfs_sufile_set_segment_usage() can trigger WARN_ONs
  during log writing.

  Segments newly allocated for writing with nilfs_sufile_alloc() will not
  have this error flag set, but this unexpected situation will occur if the
  segment indexed by either nilfs->ns_segnum or nilfs->ns_nextnum (active
  segment) was marked in error.

  Fix this issue by inserting a sanity check to treat it as a file system
  corruption.

  Since error returns are not allowed during the execution phase where
  nilfs_sufile_set_segment_usage() is used, this inserts the sanity check
  into nilfs_sufile_mark_dirty() which pre-reads the buffer containing the
  segment usage record to be updated and sets it up in a dirty state for
  writing.

  In addition, nilfs_sufile_set_segment_usage() is also called when
  canceling log writing and undoing segment usage update, so in order to
  avoid issuing the same kernel warning in that case, in case of
  cancellation, avoid checking the error flag in
  nilfs_sufile_set_segment_usage().
- Nilfs2: fix missing error check for sb_set_blocksize call. [Ryusuke
  Konishi]

  commit d61d0ab573649789bf9eb909c89a1a193b2e3d10 upstream.

  When mounting a filesystem image with a block size larger than the page
  size, nilfs2 repeatedly outputs long error messages with stack traces to
  the kernel log, such as the following:

   getblk(): invalid block size 8192 requested
   logical block size: 512
   ...
   Call Trace:
    dump_stack_lvl+0x92/0xd4
    dump_stack+0xd/0x10
    bdev_getblk+0x33a/0x354
    __breadahead+0x11/0x80
    nilfs_search_super_root+0xe2/0x704 [nilfs2]
    load_nilfs+0x72/0x504 [nilfs2]
    nilfs_mount+0x30f/0x518 [nilfs2]
    legacy_get_tree+0x1b/0x40
    vfs_get_tree+0x18/0xc4
    path_mount+0x786/0xa88
    __ia32_sys_mount+0x147/0x1a8
    __do_fast_syscall_32+0x56/0xc8
    do_fast_syscall_32+0x29/0x58
    do_SYSENTER_32+0x15/0x18
    entry_SYSENTER_32+0x98/0xf1
   ...

  This overloads the system logger.  And to make matters worse, it sometimes
  crashes the kernel with a memory access violation.

  This is because the return value of the sb_set_blocksize() call, which
  should be checked for errors, is not checked.

  The latter issue is due to out-of-buffer memory being accessed based on a
  large block size that caused sb_set_blocksize() to fail for buffers read
  with the initial minimum block size that remained unupdated in the
  super_block structure.

  Since nilfs2 mkfs tool does not accept block sizes larger than the system
  page size, this has been overlooked.  However, it is possible to create
  this situation by intentionally modifying the tool or by passing a
  filesystem image created on a system with a large page size to a system
  with a smaller page size and mounting it.

  Fix this issue by inserting the expected error handling for the call to
  sb_set_blocksize().
- ALSA: hda/realtek: Enable headset on Lenovo M90 Gen5. [Bin Li]

  commit 6f7e4664e597440dfbdb8b2931c561b717030d07 upstream.

  Lenovo M90 Gen5 is equipped with ALC897, and it needs
  ALC897_FIXUP_HEADSET_MIC_PIN quirk to make its headset mic work.
- ALSA: pcm: fix out-of-bounds in snd_pcm_state_names. [Jason Zhang]

  commit 2b3a7a302c9804e463f2ea5b54dc3a6ad106a344 upstream.

  The pcm state can be SNDRV_PCM_STATE_DISCONNECTED at disconnect
  callback, and there is not an entry of SNDRV_PCM_STATE_DISCONNECTED
  in snd_pcm_state_names.

  This patch adds the missing entry to resolve this issue.

  cat /proc/asound/card2/pcm0p/sub0/status
  That results in stack traces like the following:

  [   99.702732][ T5171] Unexpected kernel BRK exception at EL1
  [   99.702774][ T5171] Internal error: BRK handler: f2005512 [#1] PREEMPT SMP
  [   99.703858][ T5171] Modules linked in: bcmdhd(E) (...)
  [   99.747425][ T5171] CPU: 3 PID: 5171 Comm: cat Tainted: G         C OE     5.10.189-android13-4-00003-g4a17384380d8-ab11086999 #1
  [   99.748447][ T5171] Hardware name: Rockchip RK3588 CVTE V10 Board (DT)
  [   99.749024][ T5171] pstate: 60400005 (nZCv daif +PAN -UAO -TCO BTYPE=--)
  [   99.749616][ T5171] pc : snd_pcm_substream_proc_status_read+0x264/0x2bc
  [   99.750204][ T5171] lr : snd_pcm_substream_proc_status_read+0xa4/0x2bc
  [   99.750778][ T5171] sp : ffffffc0175abae0
  [   99.751132][ T5171] x29: ffffffc0175abb80 x28: ffffffc009a2c498
  [   99.751665][ T5171] x27: 0000000000000001 x26: ffffff810cbae6e8
  [   99.752199][ T5171] x25: 0000000000400cc0 x24: ffffffc0175abc60
  [   99.752729][ T5171] x23: 0000000000000000 x22: ffffff802f558400
  [   99.753263][ T5171] x21: ffffff81d8d8ff00 x20: ffffff81020cdc00
  [   99.753795][ T5171] x19: ffffff802d110000 x18: ffffffc014fbd058
  [   99.754326][ T5171] x17: 0000000000000000 x16: 0000000000000000
  [   99.754861][ T5171] x15: 000000000000c276 x14: ffffffff9a976fda
  [   99.755392][ T5171] x13: 0000000065689089 x12: 000000000000d72e
  [   99.755923][ T5171] x11: ffffff802d110000 x10: 00000000000000e0
  [   99.756457][ T5171] x9 : 9c431600c8385d00 x8 : 0000000000000008
  [   99.756990][ T5171] x7 : 0000000000000000 x6 : 000000000000003f
  [   99.757522][ T5171] x5 : 0000000000000040 x4 : ffffffc0175abb70
  [   99.758056][ T5171] x3 : 0000000000000001 x2 : 0000000000000001
  [   99.758588][ T5171] x1 : 0000000000000000 x0 : 0000000000000000
  [   99.759123][ T5171] Call trace:
  [   99.759404][ T5171]  snd_pcm_substream_proc_status_read+0x264/0x2bc
  [   99.759958][ T5171]  snd_info_seq_show+0x54/0xa4
  [   99.760370][ T5171]  seq_read_iter+0x19c/0x7d4
  [   99.760770][ T5171]  seq_read+0xf0/0x128
  [   99.761117][ T5171]  proc_reg_read+0x100/0x1f8
  [   99.761515][ T5171]  vfs_read+0xf4/0x354
  [   99.761869][ T5171]  ksys_read+0x7c/0x148
  [   99.762226][ T5171]  __arm64_sys_read+0x20/0x30
  [   99.762625][ T5171]  el0_svc_common+0xd0/0x1e4
  [   99.763023][ T5171]  el0_svc+0x28/0x98
  [   99.763358][ T5171]  el0_sync_handler+0x8c/0xf0
  [   99.763759][ T5171]  el0_sync+0x1b8/0x1c0
  [   99.764118][ T5171] Code: d65f03c0 b9406102 17ffffae 94191565 (d42aa240)
  [   99.764715][ T5171] ---[ end trace 1eeffa3e17c58e10 ]---
  [   99.780720][ T5171] Kernel panic - not syncing: BRK handler: Fatal exception
- Riscv: fix misaligned access handling of C.SWSP and C.SDSP. [Clément
  Léger]

  [ Upstream commit 22e0eb04837a63af111fae35a92f7577676b9bc8 ]

  This is a backport of a fix that was done in OpenSBI: ec0559eb315b
  ("lib: sbi_misaligned_ldst: Fix handling of C.SWSP and C.SDSP").

  Unlike C.LWSP/C.LDSP, these encodings can be used with the zero
  register, so checking that the rs2 field is non-zero is unnecessary.

  Additionally, the previous check was incorrect since it was checking
  the immediate field of the instruction instead of the rs2 field.
- ARM: dts: imx7: Declare timers compatible with fsl,imx6dl-gpt.
  [Philipp Zabel]

  [ Upstream commit 397caf68e2d36532054cb14ae8995537f27f8b61 ]

  The timer nodes declare compatibility with "fsl,imx6sx-gpt", which
  itself is compatible with "fsl,imx6dl-gpt". Switch the fallback
  compatible from "fsl,imx6sx-gpt" to "fsl,imx6dl-gpt".
- ARM: imx: Check return value of devm_kasprintf in imx_mmdc_perf_init.
  [Kunwu Chan]

  [ Upstream commit 1c2b1049af3f86545fcc5fae0fc725fb64b3a09e ]

  devm_kasprintf() returns a pointer to dynamically allocated memory
  which can be NULL upon failure. Ensure the allocation was successful
  by checking the pointer validity.

  Release the id allocated in 'mmdc_pmu_init' when 'devm_kasprintf'
  return NULL
- Scsi: be2iscsi: Fix a memleak in beiscsi_init_wrb_handle() [Dinghao
  Liu]

  [ Upstream commit 235f2b548d7f4ac5931d834f05d3f7f5166a2e72 ]

  When an error occurs in the for loop of beiscsi_init_wrb_handle(), we
  should free phwi_ctxt->be_wrbq before returning an error code to prevent
  potential memleak.
- Tracing: Fix a warning when allocating buffered events fails. [Petr
  Pavlu]

  [ Upstream commit 34209fe83ef8404353f91ab4ea4035dbc9922d04 ]

  Function trace_buffered_event_disable() produces an unexpected warning
  when the previous call to trace_buffered_event_enable() fails to
  allocate pages for buffered events.

  The situation can occur as follows:

  * The counter trace_buffered_event_ref is at 0.

  * The soft mode gets enabled for some event and
    trace_buffered_event_enable() is called. The function increments
    trace_buffered_event_ref to 1 and starts allocating event pages.

  * The allocation fails for some page and trace_buffered_event_disable()
    is called for cleanup.

  * Function trace_buffered_event_disable() decrements
    trace_buffered_event_ref back to 0, recognizes that it was the last
    use of buffered events and frees all allocated pages.

  * The control goes back to trace_buffered_event_enable() which returns.
    The caller of trace_buffered_event_enable() has no information that
    the function actually failed.

  * Some time later, the soft mode is disabled for the same event.
    Function trace_buffered_event_disable() is called. It warns on
    "WARN_ON_ONCE(!trace_buffered_event_ref)" and returns.

  Buffered events are just an optimization and can handle failures. Make
  trace_buffered_event_enable() exit on the first failure and left any
  cleanup later to when trace_buffered_event_disable() is called.
- ASoC: wm_adsp: fix memleak in wm_adsp_buffer_populate. [Dinghao Liu]

  [ Upstream commit 29046a78a3c0a1f8fa0427f164caa222f003cf5b ]

  When wm_adsp_buffer_read() fails, we should free buf->regions.
  Otherwise, the callers of wm_adsp_buffer_populate() will
  directly free buf on failure, which makes buf->regions a leaked
  memory.
- Hwmon: (acpi_power_meter) Fix 4.29 MW bug. [Armin Wolf]

  [ Upstream commit 1fefca6c57fb928d2131ff365270cbf863d89c88 ]

  The ACPI specification says:

  "If an error occurs while obtaining the meter reading or if the value
  is not available then an Integer with all bits set is returned"

  Since the "integer" is 32 bits in case of the ACPI power meter,
  userspace will get a power reading of 2^32 * 1000 miliwatts (~4.29 MW)
  in case of such an error. This was discovered due to a lm_sensors
  bugreport (https://github.com/lm-sensors/lm-sensors/issues/460).
  Fix this by returning -ENODATA instead.
- RDMA/bnxt_re: Correct module description string. [Kalesh AP]

  [ Upstream commit 422b19f7f006e813ee0865aadce6a62b3c263c42 ]

  The word "Driver" is repeated twice in the "modinfo bnxt_re"
  output description. Fix it.
- RDMA/rtrs-clt: Remove the warnings for req in_use check. [Jack Wang]

  [ Upstream commit 0c8bb6eb70ca41031f663b4481aac9ac78b53bc6 ]

  As we chain the WR during write request: memory registration,
  rdma write, local invalidate, if only the last WR fail to send due
  to send queue overrun, the server can send back the reply, while
  client mark the req->in_use to false in case of error in rtrs_clt_req
  when error out from rtrs_post_rdma_write_sg.
- Arm64: dts: rockchip: Expand reg size of vdec node for RK3399. [Alex
  Bee]

  [ Upstream commit 35938c18291b5da7422b2fac6dac0af11aa8d0d7 ]

  Expand the reg size for the vdec node to include cache/performance
  registers the rkvdec driver writes to. Also add missing clocks to the
  related power-domain.
- Tee: optee: Fix supplicant based device enumeration. [Sumit Garg]

  [ Upstream commit 7269cba53d906cf257c139d3b3a53ad272176bca ]

  Currently supplicant dependent optee device enumeration only registers
  devices whenever tee-supplicant is invoked for the first time. But it
  forgets to remove devices when tee-supplicant daemon stops running and
  closes its context gracefully. This leads to following error for fTPM
  driver during reboot/shutdown:

  [   73.466791] tpm tpm0: ftpm_tee_tpm_op_send: SUBMIT_COMMAND invoke error: 0xffff3024

  Fix this by adding an attribute for supplicant dependent devices so that
  the user-space service can detect and detach supplicant devices before
  closing the supplicant:

  $ for dev in /sys/bus/tee/devices/*; do if [[ -f "$dev/need_supplicant" && -f "$dev/driver/unbind" ]]; \
        then echo $(basename "$dev") > $dev/driver/unbind; fi done

  Reported-by: Jan Kiszka <jan.kiszka@siemens.com>
  Closes: https://github.com/OP-TEE/optee_os/issues/6094
  Fixes: 5f178bb71e3a ("optee: enable support for multi-stage bus enumeration")
  Signed-off-by: Sumit Garg <sumit.garg@linaro.org>
  Reviewed-by: Ilias Apalodimas <ilias.apalodimas@linaro.org>
  Acked-by: Jerome Forissier <jerome.forissier@linaro.org>
  [jw: fixed up Date documentation]
- Bpf: sockmap, updating the sg structure should also update curr. [John
  Fastabend]

  [ Upstream commit bb9aefde5bbaf6c168c77ba635c155b4980c2287 ]

  Curr pointer should be updated when the sg structure is shifted.
- Tcp: do not accept ACK of bytes we never sent. [Eric Dumazet]

  [ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]

  This patch is based on a detailed report and ideas from Yepeng Pan
  and Christian Rossow.

  ACK seq validation is currently following RFC 5961 5.2 guidelines:

     The ACK value is considered acceptable only if
     it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
     SND.NXT).  All incoming segments whose ACK value doesn't satisfy the
     above condition MUST be discarded and an ACK sent back.  It needs to
     be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
     duplicate (SEG.ACK < SND.UNA), it can be ignored.  If the ACK
     acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
     ACK, drop the segment, and return".  The "ignored" above implies that
     the processing of the incoming data segment continues, which means
     the ACK value is treated as acceptable.  This mitigation makes the
     ACK check more stringent since any ACK < SND.UNA wouldn't be
     accepted, instead only ACKs that are in the range ((SND.UNA -
     MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.

  This can be refined for new (and possibly spoofed) flows,
  by not accepting ACK for bytes that were never sent.

  This greatly improves TCP security at a little cost.

  I added a Fixes: tag to make sure this patch will reach stable trees,
  even if the 'blamed' patch was adhering to the RFC.

  tp->bytes_acked was added in linux-4.2

  Following packetdrill test (courtesy of Yepeng Pan) shows
  the issue at hand:

  0 socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
  +0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
  +0 bind(3, ..., ...) = 0
  +0 listen(3, 1024) = 0

  // ---------------- Handshake ------------------- //

  // when window scale is set to 14 the window size can be extended to
  // 65535 * (2^14) = 1073725440. Linux would accept an ACK packet
  // with ack number in (Server_ISN+1-1073725440. Server_ISN+1)
  // ,though this ack number acknowledges some data never
  // sent by the server.

  +0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
  +0 > S. 0:0(0) ack 1 <...>
  +0 < . 1:1(0) ack 1 win 65535
  +0 accept(3, ..., ...) = 4

  // For the established connection, we send an ACK packet,
  // the ack packet uses ack number 1 - 1073725300 + 2^32,
  // where 2^32 is used to wrap around.
  // Note: we used 1073725300 instead of 1073725440 to avoid possible
  // edge cases.
  // 1 - 1073725300 + 2^32 = 3221241997

  // Oops, old kernels happily accept this packet.
  +0 < . 1:1001(1000) ack 3221241997 win 65535

  // After the kernel fix the following will be replaced by a challenge ACK,
  // and prior malicious frame would be dropped.
  +0 > . 1:1(0) ack 1001
- Netfilter: xt_owner: Fix for unsafe access of sk->sk_socket. [Phil
  Sutter]

  [ Upstream commit 7ae836a3d630e146b732fe8ef7d86b243748751f ]

  A concurrently running sock_orphan() may NULL the sk_socket pointer in
  between check and deref. Follow other users (like nft_meta.c for
  instance) and acquire sk_callback_lock before dereferencing sk_socket.
- Net: hns: fix fake link up on xge port. [Yonglong Liu]

  [ Upstream commit f708aba40f9c1eeb9c7e93ed4863b5f85b09b288 ]

  If a xge port just connect with an optical module and no fiber,
  it may have a fake link up because there may be interference on
  the hardware. This patch adds an anti-shake to avoid the problem.
  And the time of anti-shake is base on tests.
- Ipv4: ip_gre: Avoid skb_pull() failure in ipgre_xmit() [Shigeru
  Yoshida]

  [ Upstream commit 80d875cfc9d3711a029f234ef7d680db79e8fa4b ]

  In ipgre_xmit(), skb_pull() may fail even if pskb_inet_may_pull() returns
  true. For example, applications can use PF_PACKET to create a malformed
  packet with no IP header. This type of packet causes a problem such as
  uninit-value access.

  This patch ensures that skb_pull() can pull the required size by checking
  the skb with pskb_network_may_pull() before skb_pull().
- Ionic: Fix dim work handling in split interrupt mode. [Brett Creeley]

  [ Upstream commit 4115ba677c35f694b62298e55f0e04ce84eed469 ]

  Currently ionic_dim_work() is incorrect when in
  split interrupt mode. This is because the interrupt
  rate is only being changed for the Rx side even for
  dim running on Tx. Fix this by using the qcq from
  the container_of macro. Also, introduce some local
  variables for a bit of cleanup.
- Ionic: fix snprintf format length warning. [Shannon Nelson]

  [ Upstream commit 0ceb3860a67652f9d36dfdecfcd2cb3eb2f4537d ]

  Our friendly kernel test robot has reminded us that with a new
  check we have a warning about a potential string truncation.
  In this case it really doesn't hurt anything, but it is worth
  addressing especially since there really is no reason to reserve
  so many bytes for our queue names.  It seems that cutting the
  queue name buffer length in half stops the complaint.
- Net: bnxt: fix a potential use-after-free in bnxt_init_tc. [Dinghao
  Liu]

  [ Upstream commit d007caaaf052f82ca2340d4c7b32d04a3f5dbf3f ]

  When flow_indr_dev_register() fails, bnxt_init_tc will free
  bp->tc_info through kfree(). However, the caller function
  bnxt_init_one() will ignore this failure and call
  bnxt_shutdown_tc() on failure of bnxt_dl_register(), where
  a use-after-free happens. Fix this issue by setting
  bp->tc_info to NULL after kfree().
- I40e: Fix unexpected MFS warning message. [Ivan Vecera]

  [ Upstream commit 7d9f22b3d3ef379ed05bd3f3e2de83dfa8da8258 ]

  Commit 3a2c6ced90e1 ("i40e: Add a check to see if MFS is set") added
  a warning message that reports unexpected size of port's MFS (max
  frame size) value. This message use for the port number local
  variable 'i' that is wrong.
  In i40e_probe() this 'i' variable is used only to iterate VSIs
  to find FDIR VSI:

  <code>
  ...
  /* if FDIR VSI was set up, start it now */
          for (i = 0; i < pf->num_alloc_vsi; i++) {
                  if (pf->vsi[i] && pf->vsi[i]->type == I40E_VSI_FDIR) {
                          i40e_vsi_open(pf->vsi[i]);
                          break;
                  }
          }
  ...
  </code>

  So the warning message use for the port number index of FDIR VSI
  if this exists or pf->num_alloc_vsi if not.

  Fix the message by using 'pf->hw.port' for the port number.
- Arcnet: restoring support for multiple Sohard Arcnet cards. [Thomas
  Reichinger]

  [ Upstream commit 6b17a597fc2f13aaaa0a2780eb7edb9ae7ac9aea ]

  Probe of Sohard Arcnet cards fails,
  if 2 or more cards are installed in a system.
  See kernel log:
  [    2.759203] arcnet: arcnet loaded
  [    2.763648] arcnet:com20020: COM20020 chipset support (by David Woodhouse et al.)
  [    2.770585] arcnet:com20020_pci: COM20020 PCI support
  [    2.772295] com20020 0000:02:00.0: enabling device (0000 -> 0003)
  [    2.772354] (unnamed net_device) (uninitialized): PLX-PCI Controls
  ...
  [    3.071301] com20020 0000:02:00.0 arc0-0 (uninitialized): PCI COM20020: station FFh found at F080h, IRQ 101.
  [    3.071305] com20020 0000:02:00.0 arc0-0 (uninitialized): Using CKP 64 - data rate 2.5 Mb/s
  [    3.071534] com20020 0000:07:00.0: enabling device (0000 -> 0003)
  [    3.071581] (unnamed net_device) (uninitialized): PLX-PCI Controls
  ...
  [    3.369501] com20020 0000:07:00.0: Led pci:green:tx:0-0 renamed to pci:green:tx:0-0_1 due to name collision
  [    3.369535] com20020 0000:07:00.0: Led pci:red:recon:0-0 renamed to pci:red:recon:0-0_1 due to name collision
  [    3.370586] com20020 0000:07:00.0 arc0-0 (uninitialized): PCI COM20020: station E1h found at C000h, IRQ 35.
  [    3.370589] com20020 0000:07:00.0 arc0-0 (uninitialized): Using CKP 64 - data rate 2.5 Mb/s
  [    3.370608] com20020: probe of 0000:07:00.0 failed with error -5

  commit 5ef216c1f848 ("arcnet: com20020-pci: add rotary index support")
  changes the device name of all COM20020 based PCI cards,
  even if only some cards support this:
  	snprintf(dev->name, sizeof(dev->name), "arc%d-%d", dev->dev_id, i);

  The error happens because all Sohard Arcnet cards would be called arc0-0,
  since the Sohard Arcnet cards don't have a PLX rotary coder.
  I.e. EAE Arcnet cards have a PLX rotary coder,
  which sets the first decimal, ensuring unique devices names.

  This patch adds two new card feature flags to indicate
  which cards support LEDs and the PLX rotary coder.
  For EAE based cards the names still depend on the PLX rotary coder
  (untested, since missing EAE hardware).
  For Sohard based cards, this patch will result in devices
  being called arc0, arc1, ... (tested).
- Net: arcnet: com20020 fix error handling. [Tong Zhang]

  [ Upstream commit 6577b9a551aedb86bca6d4438c28386361845108 ]

  There are two issues when handling error case in com20020pci_probe()

  1. priv might be not initialized yet when calling com20020pci_remove()
  from com20020pci_probe(), since the priv is set at the very last but it
  can jump to error handling in the middle and priv remains NULL.
  2. memory leak - the net device is allocated in alloc_arcdev but not
  properly released if error happens in the middle of the big for loop

  [    1.529110] BUG: kernel NULL pointer dereference, address: 0000000000000008
  [    1.531447] RIP: 0010:com20020pci_remove+0x15/0x60 [com20020_pci]
  [    1.536805] Call Trace:
  [    1.536939]  com20020pci_probe+0x3f2/0x48c [com20020_pci]
  [    1.537226]  local_pci_probe+0x48/0x80
  [    1.539918]  com20020pci_init+0x3f/0x1000 [com20020_pci]
- Mlxbf-bootctl: correctly identify secure boot with development keys.
  [David Thompson]

  [ Upstream commit d4eef75279f5e9d594f5785502038c763ce42268 ]

  The secure boot state of the BlueField SoC is represented by two bits:
                  0 = production state
                  1 = secure boot enabled
                  2 = non-secure (secure boot disabled)
                  3 = RMA state
  There is also a single bit to indicate whether production keys or
  development keys are being used when secure boot is enabled.
  This single bit (specified by MLXBF_BOOTCTL_SB_DEV_MASK) only has
  meaning if secure boot state equals 1 (secure boot enabled).

  The secure boot states are as follows:
  - “GA secured” is when secure boot is enabled with official production keys.
  - “Secured (development)” is when secure boot is enabled with development keys.

  Without this fix “GA Secured” is displayed on development cards which is
  misleading. This patch updates the logic in "lifecycle_state_show()" to
  handle the case where the SoC is configured for secure boot and is using
  development keys.
- Hv_netvsc: rndis_filter needs to select NLS. [Randy Dunlap]

  [ Upstream commit 6c89f49964375c904cea33c0247467873f4daf2c ]

  rndis_filter uses utf8s_to_utf16s() which is provided by setting
  NLS, so select NLS to fix the build error:
- Octeontx2-pf: Add missing mutex lock in otx2_get_pauseparam.
  [Subbaraya Sundeep]

  [ Upstream commit 9572c949385aa2ef10368287c439bcb7935137c8 ]

  All the mailbox messages sent to AF needs to be guarded
  by mutex lock. Add the missing lock in otx2_get_pauseparam
  function.
- Ipv6: fix potential NULL deref in fib6_add() [Eric Dumazet]

  [ Upstream commit 75475bb51e78a3f54ad2f69380f2a1c985e85f2d ]

  If fib6_find_prefix() returns NULL, we should silently fallback
  using fib6_null_entry regardless of RT6_DEBUG value.

  syzbot reported:

  WARNING: CPU: 0 PID: 5477 at net/ipv6/ip6_fib.c:1516 fib6_add+0x310d/0x3fa0 net/ipv6/ip6_fib.c:1516
  Modules linked in:
  CPU: 0 PID: 5477 Comm: syz-executor.0 Not tainted 6.7.0-rc2-syzkaller-00029-g9b6de136b5f0 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 11/10/2023
  RIP: 0010:fib6_add+0x310d/0x3fa0 net/ipv6/ip6_fib.c:1516
  Code: 00 48 8b 54 24 68 e8 42 22 00 00 48 85 c0 74 14 49 89 c6 e8 d5 d3 c2 f7 eb 5d e8 ce d3 c2 f7 e9 ca 00 00 00 e8 c4 d3 c2 f7 90 <0f> 0b 90 48 b8 00 00 00 00 00 fc ff df 48 8b 4c 24 38 80 3c 01 00
  RSP: 0018:ffffc90005067740 EFLAGS: 00010293
  RAX: ffffffff89cba5bc RBX: ffffc90005067ab0 RCX: ffff88801a2e9dc0
  RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000000
  RBP: ffffc90005067980 R08: ffffffff89cbca85 R09: 1ffff110040d4b85
  R10: dffffc0000000000 R11: ffffed10040d4b86 R12: 00000000ffffffff
  R13: 1ffff110051c3904 R14: ffff8880206a5c00 R15: ffff888028e1c820
  FS: 00007f763783c6c0(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
  CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 00007f763783bff8 CR3: 000000007f74d000 CR4: 00000000003506f0
  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  Call Trace:
  <TASK>
  __ip6_ins_rt net/ipv6/route.c:1303 [inline]
  ip6_route_add+0x88/0x120 net/ipv6/route.c:3847
  ipv6_route_ioctl+0x525/0x7b0 net/ipv6/route.c:4467
  inet6_ioctl+0x21a/0x270 net/ipv6/af_inet6.c:575
  sock_do_ioctl+0x152/0x460 net/socket.c:1220
  sock_ioctl+0x615/0x8c0 net/socket.c:1339
  vfs_ioctl fs/ioctl.c:51 [inline]
  __do_sys_ioctl fs/ioctl.c:871 [inline]
  __se_sys_ioctl+0xf8/0x170 fs/ioctl.c:857
  do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  do_syscall_64+0x45/0x110 arch/x86/entry/common.c:82
- Of: dynamic: Fix of_reconfig_get_state_change() return value
  documentation. [Luca Ceresoli]

  [ Upstream commit d79972789d17499b6091ded2fc0c6763c501a5ba ]

  The documented numeric return values do not match the actual returned
  values. Fix them by using the enum names instead of raw numbers.
- Of: Add missing 'Return' section in kerneldoc comments. [Rob Herring]

  [ Upstream commit 8c8239c2c1fb82f171cb22a707f3bb88a2f22109 ]

  Many of the DT kerneldoc comments are lacking a 'Return' section. Let's
  add the section in cases we have a description of return values. There's
  still some cases where the return values are not documented.
- Of: Fix kerneldoc output formatting. [Rob Herring]

  [ Upstream commit 62f026f082e4d762a47b43ea693b38f025122332 ]

  The indentation of the kerneldoc comments affects the output formatting.
  Leading tabs in particular don't work, sections need to be indented
  under the section header, and several code blocks are reformatted.
- Of: base: Fix some formatting issues and provide missing descriptions.
  [Lee Jones]

  [ Upstream commit 3637d49e11219512920aca8b8ccd0994be33fa8b ]

  Fixes the following W=1 kernel build warning(s):

   drivers/of/base.c:315: warning: Function parameter or member 'cpun' not described in '__of_find_n_match_cpu_property'
   drivers/of/base.c:315: warning: Function parameter or member 'prop_name' not described in '__of_find_n_match_cpu_property'
   drivers/of/base.c:315: warning: Function parameter or member 'cpu' not described in '__of_find_n_match_cpu_property'
   drivers/of/base.c:315: warning: Function parameter or member 'thread' not described in '__of_find_n_match_cpu_property'
   drivers/of/base.c:315: warning: expecting prototype for property holds the physical id of the(). Prototype was for __of_find_n_match_cpu_property() instead
   drivers/of/base.c:1139: warning: Function parameter or member 'match' not described in 'of_find_matching_node_and_match'
   drivers/of/base.c:1779: warning: Function parameter or member 'np' not described in '__of_add_property'
   drivers/of/base.c:1779: warning: Function parameter or member 'prop' not described in '__of_add_property'
   drivers/of/base.c:1800: warning: Function parameter or member 'np' not described in 'of_add_property'
   drivers/of/base.c:1800: warning: Function parameter or member 'prop' not described in 'of_add_property'
   drivers/of/base.c:1849: warning: Function parameter or member 'np' not described in 'of_remove_property'
   drivers/of/base.c:1849: warning: Function parameter or member 'prop' not described in 'of_remove_property'
   drivers/of/base.c:2137: warning: Function parameter or member 'dn' not described in 'of_console_check'
   drivers/of/base.c:2137: warning: Function parameter or member 'name' not described in 'of_console_check'
   drivers/of/base.c:2137: warning: Function parameter or member 'index' not described in 'of_console_check'
- Platform/x86: asus-wmi: Move i8042 filter install to shared asus-wmi
  code. [Hans de Goede]

  [ Upstream commit b52cbca22cbf6c9d2700c1e576d0ddcc670e49d5 ]

  asus-nb-wmi calls i8042_install_filter() in some cases, but it never
  calls i8042_remove_filter(). This means that a dangling pointer to
  the filter function is left after rmmod leading to crashes.

  Fix this by moving the i8042-filter installation to the shared
  asus-wmi code and also remove it from the shared code on driver unbind.
- Platform/x86: asus-wmi: Simplify tablet-mode-switch handling. [Hans de
  Goede]

  [ Upstream commit 1ea0d3b46798afc35c3185f6058b8bc08525d56c ]

  Simplify tablet-mode-switch handling:
  1. The code is the same for all variants, the only difference is the
     dev_id and notify event code. Store the dev_id + code in struct asus_wmi
     and unify the handling
  2. Make the new unified asus_wmi_tablet_mode_get_state() check dev_id has
     been set and make it a no-op when not set. This allows calling it
     unconditionally at resume/restore time
  3. Simplify the tablet_mode_sw module-param handling, this also allows
     selecting the new lid-flip-rog type through the module-param.
- Platform/x86: asus-wmi: Simplify tablet-mode-switch probing. [Hans de
  Goede]

  [ Upstream commit c98dc61ee08f833e68337700546e120e2edac7c9 ]

  The 3 different tablet-mode-switch initialization paths repeat a lot
  of the same code. Add a helper function for this.

  This also makes the error-handling for the kbd_dock_devid case consistent
  with the other 2 cases.
- Platform/x86: asus-wmi: Add support for ROG X13 tablet mode. [Luke D.
  Jones]

  [ Upstream commit e397c3c460bf3849384f2f55516d1887617cfca9 ]

  Add quirk for ASUS ROG X13 Flow 2-in-1 to enable tablet mode with
  lid flip (all screen rotations).
- Platform/x86: asus-wmi: Adjust tablet/lidflip handling to use enum.
  [Luke D. Jones]

  [ Upstream commit 00aa846955fbfb04f7bc0c26c49febfe5395eca1 ]

  Due to multiple types of tablet/lidflip, the existing code for
  handling these events is refactored to use an enum for each type.
- Asus-wmi: Add dgpu disable method. [Luke D. Jones]

  [ Upstream commit 98829e84dc67630efb7de675f0a70066620468a3 ]

  In Windows the ASUS Armory Crate program can enable or disable the
  dGPU via a WMI call. This functions much the same as various Linux
  methods in software where the dGPU is removed from the device tree.

  However the WMI call saves the state of dGPU (enabled or not) and
  this then changes the dGPU visibility in Linux with no way for
  Linux users to re-enable it. We expose the WMI method so users can
  see and change the dGPU ACPI state.
- Platform/x86: asus-nb-wmi: Add tablet_mode_sw=lid-flip quirk for the
  TP200s. [Hans de Goede]

  [ Upstream commit 411f48bb58f49c40a627b052402a90e8301cd07e ]

  The Asus TP200s / E205SA 360 degree hinges 2-in-1 supports reporting
  SW_TABLET_MODE info through the ASUS_WMI_DEVID_LID_FLIP WMI device-id.
  Add a quirk to enable this.
- Platform/x86: asus-nb-wmi: Allow configuring SW_TABLET_MODE method
  with a module option. [Hans de Goede]

  [ Upstream commit 6be70ccdd989e40af151ce52db5b2d93e97fc9fb ]

  Unfortunately we have been unable to find a reliable way to detect if
  and how SW_TABLET_MODE reporting is supported, so we are relying on
  DMI quirks for this.

  Add a module-option to specify the SW_TABLET_MODE method so that this can
  be easily tested without needing to rebuild the kernel.
- Platform/x86: asus-wmi: Add support for SW_TABLET_MODE on UX360.
  [Samuel Čavoj]

  [ Upstream commit ea856ec266c1e6aecd2b107032d5b5d661f0686d ]

  The UX360CA has a WMI device id 0x00060062, which reports whether the
  lid is flipped in tablet mode (1) or in normal laptop mode (0).

  Add a quirk (quirk_asus_use_lid_flip_devid) for devices on which this
  WMI device should be used to figure out the SW_TABLET_MODE state, as
  opposed to the quirk_asus_use_kbd_dock_devid.

  Additionally, the device needs to be queried on resume and restore
  because the firmware does not generate an event if the laptop is put to
  sleep while in tablet mode, flipped to normal mode, and later awoken.

  It is assumed other UX360* models have the same WMI device. As such, the
  quirk is applied to devices with DMI_MATCH(DMI_PRODUCT_NAME, "UX360").
  More devices with this feature need to be tested and added accordingly.

  The reason for using an allowlist via the quirk mechanism is that the new
  WMI device (0x00060062) is also present on some models which do not have
  a 360 degree hinge (at least FX503VD and GL503VD from Hans' DSTS
  collection) and therefore its presence cannot be relied on.
- Drm/amdgpu: correct chunk_ptr to a pointer to chunk. [YuanShang]

  [ Upstream commit 50d51374b498457c4dea26779d32ccfed12ddaff ]

  The variable "chunk_ptr" should be a pointer pointing
  to a struct drm_amdgpu_cs_chunk instead of to a pointer
  of that.
- Kconfig: fix memory leak from range properties. [Masahiro Yamada]

  [ Upstream commit ae1eff0349f2e908fc083630e8441ea6dc434dc0 ]

  Currently, sym_validate_range() duplicates the range string using
  xstrdup(), which is overwritten by a subsequent sym_calc_value() call.
  It results in a memory leak.

  Instead, only the pointer should be copied.

  Below is a test case, with a summary from Valgrind.

  [Test Kconfig]

    config FOO
            int "foo"
            range 10 20

  [Test .config]

    CONFIG_FOO=0

  [Before]

    LEAK SUMMARY:
       definitely lost: 3 bytes in 1 blocks
       indirectly lost: 0 bytes in 0 blocks
         possibly lost: 0 bytes in 0 blocks
       still reachable: 17,465 bytes in 21 blocks
            suppressed: 0 bytes in 0 blocks

  [After]

    LEAK SUMMARY:
       definitely lost: 0 bytes in 0 blocks
       indirectly lost: 0 bytes in 0 blocks
         possibly lost: 0 bytes in 0 blocks
       still reachable: 17,462 bytes in 20 blocks
            suppressed: 0 bytes in 0 blocks
- Tg3: Increment tx_dropped in tg3_tso_bug() [Alex Pakhunov]

  [ Upstream commit 17dd5efe5f36a96bd78012594fabe21efb01186b ]

  tg3_tso_bug() drops a packet if it cannot be segmented for any reason.
  The number of discarded frames should be incremented accordingly.
- Tg3: Move the [rt]x_dropped counters to tg3_napi. [Alex Pakhunov]

  [ Upstream commit 907d1bdb8b2cc0357d03a1c34d2a08d9943760b1 ]

  This change moves [rt]x_dropped counters to tg3_napi so that they can be
  updated by a single writer, race-free.
- Netfilter: ipset: fix race condition between swap/destroy and kernel
  side add/del/test. [Jozsef Kadlecsik]

  [ Upstream commit 28628fa952fefc7f2072ce6e8016968cc452b1ba ]

  Linkui Xiao reported that there's a race condition when ipset swap and destroy is
  called, which can lead to crash in add/del/test element operations. Swap then
  destroy are usual operations to replace a set with another one in a production
  system. The issue can in some cases be reproduced with the script:

  ipset create hash_ip1 hash:net family inet hashsize 1024 maxelem 1048576
  ipset add hash_ip1 172.20.0.0/16
  ipset add hash_ip1 192.168.0.0/16
  iptables -A INPUT -m set --match-set hash_ip1 src -j ACCEPT
  while [ 1 ]
  do
  	# ... Ongoing traffic...
          ipset create hash_ip2 hash:net family inet hashsize 1024 maxelem 1048576
          ipset add hash_ip2 172.20.0.0/16
          ipset swap hash_ip1 hash_ip2
          ipset destroy hash_ip2
          sleep 0.05
  done

  In the race case the possible order of the operations are

  	CPU0			CPU1
  	ip_set_test
  				ipset swap hash_ip1 hash_ip2
  				ipset destroy hash_ip2
  	hash_net_kadt

  Swap replaces hash_ip1 with hash_ip2 and then destroy removes hash_ip2 which
  is the original hash_ip1. ip_set_test was called on hash_ip1 and because destroy
  removed it, hash_net_kadt crashes.

  The fix is to force ip_set_swap() to wait for all readers to finish accessing the
  old set pointers by calling synchronize_rcu().

  The first version of the patch was written by Linkui Xiao <xiaolinkui@kylinos.cn>.

  v2: synchronize_rcu() is moved into ip_set_swap() in order not to burden
      ip_set_destroy() unnecessarily when all sets are destroyed.
  v3: Florian Westphal pointed out that all netfilter hooks run with rcu_read_lock() held
      and em_ipset.c wraps the entire ip_set_test() in rcu read lock/unlock pair.
      So there's no need to extend the rcu read locked area in ipset itself.

  Closes: https://lore.kernel.org/all/69e7963b-e7f8-3ad0-210-7b86eebf7f78@netfilter.org/
  Reported by: Linkui Xiao <xiaolinkui@kylinos.cn>
- I2c: designware: Fix corrupted memory seen in the ISR. [Jan Bottorff]

  [ Upstream commit f726eaa787e9f9bc858c902d18a09af6bcbfcdaf ]

  When running on a many core ARM64 server, errors were
  happening in the ISR that looked like corrupted memory. These
  corruptions would fix themselves if small delays were inserted
  in the ISR. Errors reported by the driver included "i2c_designware
  APMC0D0F:00: i2c_dw_xfer_msg: invalid target address" and
  "i2c_designware APMC0D0F:00:controller timed out" during
  in-band IPMI SSIF stress tests.

  The problem was determined to be memory writes in the driver were not
  becoming visible to all cores when execution rapidly shifted between
  cores, like when a register write immediately triggers an ISR.
  Processors with weak memory ordering, like ARM64, make no
  guarantees about the order normal memory writes become globally
  visible, unless barrier instructions are used to control ordering.

  To solve this, regmap accessor functions configured by this driver
  were changed to use non-relaxed forms of the low-level register
  access functions, which include a barrier on platforms that require
  it. This assures memory writes before a controller register access are
  visible to all cores. The community concluded defaulting to correct
  operation outweighed defaulting to the small performance gains from
  using relaxed access functions. Being a low speed device added weight to
  this choice of default register access behavior.
- Hrtimers: Push pending hrtimers away from outgoing CPU earlier.
  [Thomas Gleixner]

  [ Upstream commit 5c0930ccaad5a74d74e8b18b648c5eb21ed2fe94 ]

  2b8272ff4a70 ("cpu/hotplug: Prevent self deadlock on CPU hot-unplug")
  solved the straight forward CPU hotplug deadlock vs. the scheduler
  bandwidth timer. Yu discovered a more involved variant where a task which
  has a bandwidth timer started on the outgoing CPU holds a lock and then
  gets throttled. If the lock required by one of the CPU hotplug callbacks
  the hotplug operation deadlocks because the unthrottling timer event is not
  handled on the dying CPU and can only be recovered once the control CPU
  reaches the hotplug state which pulls the pending hrtimers from the dead
  CPU.

  Solve this by pushing the hrtimers away from the dying CPU in the dying
  callbacks. Nothing can queue a hrtimer on the dying CPU at that point because
  all other CPUs spin in stop_machine() with interrupts disabled and once the
  operation is finished the CPU is marked offline.
- Linux 5.10.203. [Greg Kroah-Hartman]
- Driver core: Release all resources during unbind before updating
  device links. [Saravana Kannan]

  commit 2e84dc37920012b458e9458b19fc4ed33f81bc74 upstream.

  This commit fixes a bug in commit 9ed9895370ae ("driver core: Functional
  dependencies tracking support") where the device link status was
  incorrectly updated in the driver unbind path before all the device's
  resources were released.
- R8169: fix deadlock on RTL8125 in jumbo mtu mode. [Heiner Kallweit]

  [ Upstream commit 59d395ed606d8df14615712b0cdcdadb2d962175 ]

  The original change results in a deadlock if jumbo mtu mode is used.
  Reason is that the phydev lock is held when rtl_reset_work() is called
  here, and rtl_jumbo_config() calls phy_start_aneg() which also tries
  to acquire the phydev lock. Fix this by calling rtl_reset_work()
  asynchronously.
- R8169: disable ASPM in case of tx timeout. [Heiner Kallweit]

  [ Upstream commit 80c0576ef179311f624bc450fede30a89afe9792 ]

  There are still single reports of systems where ASPM incompatibilities
  cause tx timeouts. It's not clear whom to blame, so let's disable
  ASPM in case of a tx timeout.

  v2:
  - add one-time warning for informing the user
- Mmc: sdhci-sprd: Fix vqmmc not shutting down after the card was
  pulled. [Wenchao Chen]

  [ Upstream commit 477865af60b2117ceaa1d558e03559108c15c78c ]

  With cat regulator_summary, we found that vqmmc was not shutting
  down after the card was pulled.

  cat /sys/kernel/debug/regulator/regulator_summary
  1.before fix
  1)Insert SD card
   vddsdio		1    1  0 unknown  3500mV 0mA  1200mV  3750mV
      71100000.mmc-vqmmc  1                         0mA  3500mV  3600mV

  2)Pull out the SD card
   vddsdio                1    1  0 unknown  3500mV 0mA  1200mV  3750mV
      71100000.mmc-vqmmc  1                         0mA  3500mV  3600mV

  2.after fix
  1)Insert SD cardt
   vddsdio                1    1  0 unknown  3500mV 0mA  1200mV  3750mV
      71100000.mmc-vqmmc  1                         0mA  3500mV  3600mV

  2)Pull out the SD card
   vddsdio		0    1  0 unknown  3500mV 0mA  1200mV  3750mV
      71100000.mmc-vqmmc  0                         0mA  3500mV  3600mV
- Mmc: core: add helpers mmc_regulator_enable/disable_vqmmc. [Heiner
  Kallweit]

  [ Upstream commit 8d91f3f8ae57e6292142ca89f322e90fa0d6ac02 ]

  There's a number of drivers (e.g. dw_mmc, meson-gx, mmci, sunxi) using
  the same mechanism and a private flag vqmmc_enabled to deal with
  enabling/disabling the vqmmc regulator.

  Move this to the core and create new helpers mmc_regulator_enable_vqmmc
  and mmc_regulator_disable_vqmmc.
- Mmc: block: Retry commands in CQE error recovery. [Adrian Hunter]

  [ Upstream commit 8155d1fa3a747baad5caff5f8303321d68ddd48c ]

  It is important that MMC_CMDQ_TASK_MGMT command to discard the queue is
  successful because otherwise a subsequent reset might fail to flush the
  cache first.  Retry it and the previous STOP command.
- Mmc: core: convert comma to semicolon. [Zheng Yongjun]

  [ Upstream commit 6b1dc6229aecbcb45e8901576684a8c09e25ad7b ]

  Replace a comma between expression statements by a semicolon.
- Mmc: cqhci: Fix task clearing in CQE error recovery. [Adrian Hunter]

  [ Upstream commit 1de1b77982e1a1df9707cb11f9b1789e6b8919d4 ]

  If a task completion notification (TCN) is received when there is no
  outstanding task, the cqhci driver issues a "spurious TCN" warning. This
  was observed to happen right after CQE error recovery.

  When an error interrupt is received the driver runs recovery logic.
  It halts the controller, clears all pending tasks, and then re-enables
  it. On some platforms, like Intel Jasper Lake, a stale task completion
  event was observed, regardless of the CQHCI_CLEAR_ALL_TASKS bit being set.

  This results in either:
  a) Spurious TC completion event for an empty slot.
  b) Corrupted data being passed up the stack, as a result of premature
     completion for a newly added task.

  Rather than add a quirk for affected controllers, ensure tasks are cleared
  by toggling CQHCI_ENABLE, which would happen anyway if
  cqhci_clear_all_tasks() timed out. This is simpler and should be safe and
  effective for all controllers.
- Mmc: cqhci: Warn of halt or task clear failure. [Adrian Hunter]

  [ Upstream commit 35597bdb04ec27ef3b1cea007dc69f8ff5df75a5 ]

  A correctly operating controller should successfully halt and clear tasks.
  Failure may result in errors elsewhere, so promote messages from debug to
  warnings.
- Mmc: cqhci: Increase recovery halt timeout. [Adrian Hunter]

  [ Upstream commit b578d5d18e929aa7c007a98cce32657145dde219 ]

  Failing to halt complicates the recovery. Additionally, unless the card or
  controller are stuck, which is expected to be very rare, then the halt
  should succeed, so it is better to wait. Set a large timeout.
- Cpufreq: imx6q: Don't disable 792 Mhz OPP unnecessarily. [Christoph
  Niedermaier]

  [ Upstream commit 2e4e0984c7d696cc74cf2fd7e7f62997f0e9ebe6 ]

  For a 900MHz i.MX6ULL CPU the 792MHz OPP is disabled. There is no
  convincing reason to disable this OPP. If a CPU can run at 900MHz,
  it should also be able to cope with 792MHz. Looking at the voltage
  level of 792MHz in [1] (page 24, table 10. "Operating Ranges") the
  current defined OPP is above the minimum. So the voltage level
  shouldn't be a problem. However in [2] (page 24, table 10.
  "Operating Ranges"), it is not mentioned that 792MHz OPP isn't
  allowed. Change it to only disable 792MHz OPP for i.MX6ULL types
  below 792 MHz.

  [1] https://www.nxp.com/docs/en/data-sheet/IMX6ULLIEC.pdf
  [2] https://www.nxp.com/docs/en/data-sheet/IMX6ULLCEC.pdf

  Fixes: 0aa9abd4c212 ("cpufreq: imx6q: check speed grades for i.MX6ULL")
  Signed-off-by: Christoph Niedermaier <cniedermaier@dh-electronics.com>
  Reviewed-by: Marek Vasut <marex@denx.de>
  Reviewed-by: Fabio Estevam <festevam@denx.de>
  [ Viresh: Edited subject ]
- Cpufreq: imx6q: don't warn for disabling a non-existing frequency.
  [Christoph Niedermaier]

  [ Upstream commit 11a3b0ac33d95aa84be426e801f800997262a225 ]

  It is confusing if a warning is given for disabling a non-existent
  frequency of the operating performance points (OPP). In this case
  the function dev_pm_opp_disable() returns -ENODEV. Check the return
  value and avoid the output of a warning in this case. Avoid code
  duplication by using a separate function.

  Signed-off-by: Christoph Niedermaier <cniedermaier@dh-electronics.com>
  [ Viresh : Updated commit subject ]
- Scsi: qla2xxx: Fix system crash due to bad pointer access. [Quinn
  Tran]

  [ Upstream commit 19597cad64d608aa8ac2f8aef50a50187a565223 ]

  User experiences system crash when running AER error injection.  The
  perturbation causes the abort-all-I/O path to trigger. The driver assumes
  all I/O on this path is FCP only. If there is both NVMe & FCP traffic, a
  system crash happens. Add additional check to see if I/O is FCP or not
  before access.

  PID: 999019  TASK: ff35d769f24722c0  CPU: 53  COMMAND: "kworker/53:1"
   0 [ff3f78b964847b58] machine_kexec at ffffffffae86973d
   1 [ff3f78b964847ba8] __crash_kexec at ffffffffae9be29d
   2 [ff3f78b964847c70] crash_kexec at ffffffffae9bf528
   3 [ff3f78b964847c78] oops_end at ffffffffae8282ab
   4 [ff3f78b964847c98] exc_page_fault at ffffffffaf2da502
   5 [ff3f78b964847cc0] asm_exc_page_fault at ffffffffaf400b62
     [exception RIP: qla2x00_abort_srb+444]
     RIP: ffffffffc07b5f8c  RSP: ff3f78b964847d78  RFLAGS: 00010046
     RAX: 0000000000000282  RBX: ff35d74a0195a200  RCX: ff35d76886fd03a0
     RDX: 0000000000000001  RSI: ffffffffc07c5ec8  RDI: ff35d74a0195a200
     RBP: ff35d76913d22080   R8: ff35d7694d103200   R9: ff35d7694d103200
     R10: 0000000100000000  R11: ffffffffb05d6630  R12: 0000000000010000
     R13: ff3f78b964847df8  R14: ff35d768d8754000  R15: ff35d768877248e0
     ORIG_RAX: ffffffffffffffff  CS: 0010  SS: 0018
   6 [ff3f78b964847d70] qla2x00_abort_srb at ffffffffc07b5f84 [qla2xxx]
   7 [ff3f78b964847de0] __qla2x00_abort_all_cmds at ffffffffc07b6238 [qla2xxx]
   8 [ff3f78b964847e38] qla2x00_abort_all_cmds at ffffffffc07ba635 [qla2xxx]
   9 [ff3f78b964847e58] qla2x00_terminate_rport_io at ffffffffc08145eb [qla2xxx]
  10 [ff3f78b964847e70] fc_terminate_rport_io at ffffffffc045987e [scsi_transport_fc]
  11 [ff3f78b964847e88] process_one_work at ffffffffae914f15
  12 [ff3f78b964847ed0] worker_thread at ffffffffae9154c0
  13 [ff3f78b964847f10] kthread at ffffffffae91c456
  14 [ff3f78b964847f50] ret_from_fork at ffffffffae8036ef
- Scsi: qla2xxx: Use scsi_cmd_to_rq() instead of scsi_cmnd.request.
  [Bart Van Assche]

  [ Upstream commit c7d6b2c2cd5656b05849afb0de3f422da1742d0f ]

  Prepare for removal of the request pointer by using scsi_cmd_to_rq()
  instead. This patch does not change any functionality.
- Scsi: core: Introduce the scsi_cmd_to_rq() function. [Bart Van Assche]

  [ Upstream commit 51f3a478892873337c54068d1185bcd797000a52 ]

  The 'request' member of struct scsi_cmnd is superfluous. The struct request
  and struct scsi_cmnd data structures are adjacent and hence the request
  pointer can be derived easily from a scsi_cmnd pointer. Introduce a helper
  function that performs that conversion in a type-safe way. This patch is
  the first step towards removing the request member from struct
  scsi_cmnd. Making that change has the following advantages:

   - This is a performance optimization since adding an offset to a pointer
     takes less time than dereferencing a pointer.

   - struct scsi_cmnd becomes smaller.
- Smb3: fix caching of ctime on setxattr. [Steve French]

  [ Upstream commit 5923d6686a100c2b4cabd4c2ca9d5a12579c7614 ]

  Fixes xfstest generic/728 which had been failing due to incorrect
  ctime after setxattr and removexattr

  Update ctime on successful set of xattr
- Fs: add ctime accessors infrastructure. [Jeff Layton]

  [ Upstream commit 9b6304c1d53745c300b86f202d0dcff395e2d2db ]

  struct timespec64 has unused bits in the tv_nsec field that can be used
  for other purposes. In future patches, we're going to change how the
  inode->i_ctime is accessed in certain inodes in order to make use of
  them. In order to do that safely though, we'll need to eradicate raw
  accesses of the inode->i_ctime field from the kernel.

  Add new accessor functions for the ctime that we use to replace them.
- Drm/amdgpu: don't use ATRM for external devices. [Alex Deucher]

  [ Upstream commit 432e664e7c98c243fab4c3c95bd463bea3aeed28 ]

  The ATRM ACPI method is for fetching the dGPU vbios rom
  image on laptops and all-in-one systems.  It should not be
  used for external add in cards.  If the dGPU is thunderbolt
  connected, don't try ATRM.

  v2: pci_is_thunderbolt_attached only works for Intel.  Use
      pdev->external_facing instead.
  v3: dev_is_removable() seems to be what we want
- Driver core: Move the "removable" attribute from USB to core. [Rajat
  Jain]

  [ Upstream commit 70f400d4d957c2453c8689552ff212bc59f88938 ]

  Move the "removable" attribute from USB to core in order to allow it to be
  supported by other subsystem / buses. Individual buses that want to support
  this attribute can populate the removable property of the device while
  enumerating it with the 3 possible values -
   - "unknown"
   - "fixed"
   - "removable"
  Leaving the field unchanged (i.e. "not supported") would mean that the
  attribute would not show up in sysfs for that device. The UAPI (location,
  symantics etc) for the attribute remains unchanged.

  Move the "removable" attribute from USB to the device core so it can be
  used by other subsystems / buses.

  By default, devices do not have a "removable" attribute in sysfs.

  If a subsystem or bus driver wants to support a "removable" attribute, it
  should call device_set_removable() before calling device_register() or
  device_add(), e.g.:

      device_set_removable(dev, DEVICE_REMOVABLE);
      device_register(dev);

  The possible values and the resulting sysfs attribute contents are:

      DEVICE_REMOVABLE_UNKNOWN  ->  "unknown"
      DEVICE_REMOVABLE          ->  "removable"
      DEVICE_FIXED              ->  "fixed"

  Convert the USB "removable" attribute to use this new device core
  functionality.  There should be no user-visible change in the location or
  semantics of attribute for USB devices.
- Ima: annotate iint mutex to avoid lockdep false positive warnings.
  [Amir Goldstein]

  [ Upstream commit e044374a8a0a99e46f4e6d6751d3042b6d9cc12e ]

  It is not clear that IMA should be nested at all, but as long is it
  measures files both on overlayfs and on underlying fs, we need to
  annotate the iint mutex to avoid lockdep false positives related to
  IMA + overlayfs, same as overlayfs annotates the inode mutex.
- Fbdev: stifb: Make the STI next font pointer a 32-bit signed offset.
  [Helge Deller]

  [ Upstream commit 8a32aa17c1cd48df1ddaa78e45abcb8c7a2220d6 ]

  The pointer to the next STI font is actually a signed 32-bit
  offset. With this change the 64-bit kernel will correctly subract
  the (signed 32-bit) offset instead of adding a (unsigned 32-bit)
  offset. It has no effect on 32-bit kernels.

  This fixes the stifb driver with a 64-bit kernel on qemu.
- Misc: pci_endpoint_test: Add deviceID for J721S2 PCIe EP device
  support. [Siddharth Vadapalli]

  [ Upstream commit 8293703a492ae97c86af27c75b76e6239ec86483 ]

  Add DEVICE_ID for J721S2 and enable support for endpoints configured
  with this DEVICE_ID in the pci_endpoint_test driver.
- Misc: pci_endpoint_test: Add deviceID for AM64 and J7200. [Kishon
  Vijay Abraham I]

  [ Upstream commit 7c52009d94ab561e70cb72e007a6076f20451f85 ]

  Add device ID specific to AM64 and J7200 in pci_endpoint_test so that
  endpoints configured with those deviceIDs can use pci_endpoint_test
  driver.
- S390/cmma: fix detection of DAT pages. [Heiko Carstens]

  [ Upstream commit 44d93045247661acbd50b1629e62f415f2747577 ]

  If the cmma no-dat feature is available the kernel page tables are walked
  to identify and mark all pages which are used for address translation (all
  region, segment, and page tables). In a subsequent loop all other pages are
  marked as "no-dat" pages with the ESSA instruction.

  This information is visible to the hypervisor, so that the hypervisor can
  optimize purging of guest TLB entries. The initial loop however is
  incorrect: only the first three of the four pages which belong to segment
  and region tables will be marked as being used for DAT. The last page is
  incorrectly marked as no-dat.

  This can result in incorrect guest TLB flushes.

  Fix this by simply marking all four pages.
- S390/mm: fix phys vs virt confusion in mark_kernel_pXd() functions
  family. [Alexander Gordeev]

  [ Upstream commit 3784231b1e091857bd129fd9658a8b3cedbdcd58 ]

  Due to historical reasons mark_kernel_pXd() functions
  misuse the notion of physical vs virtual addresses
  difference.
- ASoC: SOF: sof-pci-dev: Fix community key quirk detection. [Mark
  Hasemeyer]

  [ Upstream commit 7dd692217b861a8292ff8ac2c9d4458538fd6b96 ]

  Some Chromebooks do not populate the product family DMI value resulting
  in firmware load failures.

  Add another quirk detection entry that looks for "Google" in the BIOS
  version. Theoretically, PRODUCT_FAMILY could be replaced with
  BIOS_VERSION, but it is left as a quirk to be conservative.
- ASoC: SOF: sof-pci-dev: don't use the community key on APL
  Chromebooks. [Pierre-Louis Bossart]

  [ Upstream commit d81e4ba5ef1c1033b6c720b22fc99feeb71e71a0 ]

  As suggested by MrChromebox, the SOF driver can be used with the SOF
  firmware binary signed with the production key. This patch adds an
  additional check for the ApolloLake SoC before modifying the default
  firmware path.

  Note that ApolloLake Chromebooks officially ship with the Skylake
  driver, so to use SOF the users have to explicitly opt-in with
  'options intel-dspcfg dsp_driver=3'. There is no plan to change the
  default selection.
- ASoC: SOF: sof-pci-dev: add parameter to override topology filename.
  [Pierre-Louis Bossart]

  [ Upstream commit 772627acfeb0e670ede534b7d5502dae9668d3ee ]

  The existing 'tplg_path' module parameter can be used to load
  alternate firmware files, be it for development or to handle
  OEM-specific or board-specific releases. However the topology filename
  is either hard-coded in machine descriptors or modified by specific
  DMI-quirks.

  For additional flexibility, this patch adds the 'tplg_filename' module
  parameter to override topology names.

  To avoid any confusion between DMI- and parameter-override, a variable
  rename is added.
- ASoC: SOF: sof-pci-dev: use community key on all Up boards. [Pierre-
  Louis Bossart]

  [ Upstream commit 405e52f412b85b581899f5e1b82d25a7c8959d89 ]

  There are already 3 versions of the Up boards with support for the SOF
  community key (ApolloLake, WhiskyLake, TigerLake). Rather than
  continue to add quirks for each version, let's add a wildcard.

  For WHL and TGL, the authentication supports both the SOF community
  key and the firmware signed with the Intel production key. Given two
  choices, the community key is the preferred option to allow developers
  to sign their own firmware. The firmware signed with production key
  can still be selected if needed with a kernel module
  option (snd-sof-pci.fw_path="intel/sof")
- ASoC: Intel: Move soc_intel_is_foo() helpers to a generic header.
  [Hans de Goede]

  [ Upstream commit cd45c9bf8b43cd387e167cf166ae5c517f56d658 ]

  The soc_intel_is_foo() helpers from
  sound/soc/intel/common/soc-intel-quirks.h are useful outside of the
  sound subsystem too.

  Move these to include/linux/platform_data/x86/soc.h, so that
  other code can use them too.
- Smb3: fix touch -h of symlink. [Steve French]

  [ Upstream commit 475efd9808a3094944a56240b2711349e433fb66 ]

  For example:
        touch -h -t 02011200 testfile
  where testfile is a symlink would not change the timestamp, but
        touch -t 02011200 testfile
  does work to change the timestamp of the target
- Net: ravb: Start TX queues after HW initialization succeeded. [Claudiu
  Beznea]

  [ Upstream commit 6f32c086602050fc11157adeafaa1c1eb393f0af ]

  ravb_phy_start() may fail. If that happens, the TX queues will remain
  started. Thus, move the netif_tx_start_all_queues() after PHY is
  successfully initialized.
- Net: ravb: Use pm_runtime_resume_and_get() [Claudiu Beznea]

  [ Upstream commit 88b74831faaee455c2af380382d979fc38e79270 ]

  pm_runtime_get_sync() may return an error. In case it returns with an error
  dev->power.usage_count needs to be decremented. pm_runtime_resume_and_get()
  takes care of this. Thus use it.
- Ravb: Fix races between ravb_tx_timeout_work() and net related ops.
  [Yoshihiro Shimoda]

  [ Upstream commit 9870257a0a338cd8d6c1cddab74e703f490f6779 ]

  Fix races between ravb_tx_timeout_work() and functions of net_device_ops
  and ethtool_ops by using rtnl_trylock() and rtnl_unlock(). Note that
  since ravb_close() is under the rtnl lock and calls cancel_work_sync(),
  ravb_tx_timeout_work() should calls rtnl_trylock(). Otherwise, a deadlock
  may happen in ravb_tx_timeout_work() like below:

  CPU0			CPU1
  			ravb_tx_timeout()
  			schedule_work()
  ...
  __dev_close_many()
  // Under rtnl lock
  ravb_close()
  cancel_work_sync()
  // Waiting
  			ravb_tx_timeout_work()
  			rtnl_lock()
  			// This is possible to cause a deadlock

  If rtnl_trylock() fails, rescheduling the work with sleep for 1 msec.
- R8169: prevent potential deadlock in rtl8169_close. [Heiner Kallweit]

  [ Upstream commit 91d3d149978ba7b238198dd80e4b823756aa7cfa ]

  ndo_stop() is RTNL-protected by net core, and the worker function takes
  RTNL as well. Therefore we will deadlock when trying to execute a
  pending work synchronously. To fix this execute any pending work
  asynchronously. This will do no harm because netif_running() is false
  in ndo_stop(), and therefore the work function is effectively a no-op.
  However we have to ensure that no task is running or pending after
  rtl_remove_one(), therefore add a call to cancel_work_sync().
- Revert "workqueue: remove unused cancel_work()" [Andrey Grodzovsky]

  [ Upstream commit 73b4b53276a1d6290cd4f47dbbc885b6e6e59ac6 ]

  This reverts commit 6417250d3f894e66a68ba1cd93676143f2376a6f.

  amdpgu need this function in order to prematurly stop pending
  reset works when another reset work already in progress.
- Octeontx2-pf: Fix adding mbox work queue entry when num_vfs > 64.
  [Geetha sowjanya]

  [ Upstream commit 51597219e0cd5157401d4d0ccb5daa4d9961676f ]

  When more than 64 VFs are enabled for a PF then mbox communication
  between VF and PF is not working as mbox work queueing for few VFs
  are skipped due to wrong calculation of VF numbers.
- Net: stmmac: xgmac: Disable FPE MMC interrupts. [Furong Xu]

  [ Upstream commit e54d628a2721bfbb002c19f6e8ca6746cec7640f ]

  Commit aeb18dd07692 ("net: stmmac: xgmac: Disable MMC interrupts
  by default") tries to disable MMC interrupts to avoid a storm of
  unhandled interrupts, but leaves the FPE(Frame Preemption) MMC
  interrupts enabled, FPE MMC interrupts can cause the same problem.
  Now we mask FPE TX and RX interrupts to disable all MMC interrupts.
- Selftests/net: mptcp: fix uninitialized variable warnings. [Willem de
  Bruijn]

  [ Upstream commit 00a4f8fd9c750f20d8fd4535c71c9caa7ef5ff2f ]

  Same init_rng() in both tests. The function reads /dev/urandom to
  initialize srand(). In case of failure, it falls back onto the
  entropy in the uninitialized variable. Not sure if this is on purpose.
  But failure reading urandom should be rare, so just fail hard. While
  at it, convert to getrandom(). Which man 4 random suggests is simpler
  and more robust.

      mptcp_inq.c:525:6:
      mptcp_connect.c:1131:6:

      error: variable 'foo' is used uninitialized
      whenever 'if' condition is false
      [-Werror,-Wsometimes-uninitialized]

  Fixes: 048d19d444be ("mptcp: add basic kselftest for mptcp")
  Fixes: b51880568f20 ("selftests: mptcp: add inq test case")
  Cc: Florian Westphal <fw@strlen.de>
  Signed-off-by: Willem de Bruijn <willemb@google.com>

  ----

  When input is randomized because this is expected to meaningfully
  explore edge cases, should we also add
  1. logging the random seed to stdout and
  2. adding a command line argument to replay from a specific seed
  I can do this in net-next, if authors find it useful in this case.
- Selftests/net: ipsec: fix constant out of range. [Willem de Bruijn]

  [ Upstream commit 088559815477c6f623a5db5993491ddd7facbec7 ]

  Fix a small compiler warning.

  nr_process must be a signed long: it is assigned a signed long by
  strtol() and is compared against LONG_MIN and LONG_MAX.

  ipsec.c:2280:65:
      error: result of comparison of constant -9223372036854775808
      with expression of type 'unsigned int' is always false
      [-Werror,-Wtautological-constant-out-of-range-compare]

    if ((errno == ERANGE && (nr_process == LONG_MAX || nr_process == LONG_MIN))
- Dpaa2-eth: increase the needed headroom to account for alignment.
  [Ioana Ciornei]

  [ Upstream commit f422abe3f23d483cf01f386819f26fb3fe0dbb2b ]

  Increase the needed headroom to account for a 64 byte alignment
  restriction which, with this patch, we make mandatory on the Tx path.
  The case in which the amount of headroom needed is not available is
  already handled by the driver which instead sends a S/G frame with the
  first buffer only holding the SW and HW annotation areas.

  Without this patch, we can empirically see data corruption happening
  between Tx and Tx confirmation which sometimes leads to the SW
  annotation area being overwritten.

  Since this is an old IP where the hardware team cannot help to
  understand the underlying behavior, we make the Tx alignment mandatory
  for all frames to avoid the crash on Tx conf. Also, remove the comment
  that suggested that this is just an optimization.

  This patch also sets the needed_headroom net device field to the usual
  value that the driver would need on the Tx path:
  	- 64 bytes for the software annotation area
  	- 64 bytes to account for a 64 byte aligned buffer address
- Ipv4: igmp: fix refcnt uaf issue when receiving igmp query packet.
  [Zhengchao Shao]

  [ Upstream commit e2b706c691905fe78468c361aaabc719d0a496f1 ]

  When I perform the following test operations:
  1.ip link add br0 type bridge
  2.brctl addif br0 eth0
  3.ip addr add 239.0.0.1/32 dev eth0
  4.ip addr add 239.0.0.1/32 dev br0
  5.ip addr add 224.0.0.1/32 dev br0
  6.while ((1))
      do
          ifconfig br0 up
          ifconfig br0 down
      done
  7.send IGMPv2 query packets to port eth0 continuously. For example,
  ./mausezahn ethX -c 0 "01 00 5e 00 00 01 00 72 19 88 aa 02 08 00 45 00 00
  1c 00 01 00 00 01 02 0e 7f c0 a8 0a b7 e0 00 00 01 11 64 ee 9b 00 00 00 00"

  The preceding tests may trigger the refcnt uaf issue of the mc list. The
  stack is as follows:
  	refcount_t: addition on 0; use-after-free.
  	WARNING: CPU: 21 PID: 144 at lib/refcount.c:25 refcount_warn_saturate (lib/refcount.c:25)
  	CPU: 21 PID: 144 Comm: ksoftirqd/21 Kdump: loaded Not tainted 6.7.0-rc1-next-20231117-dirty #80
  	Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011
  	RIP: 0010:refcount_warn_saturate (lib/refcount.c:25)
  	RSP: 0018:ffffb68f00657910 EFLAGS: 00010286
  	RAX: 0000000000000000 RBX: ffff8a00c3bf96c0 RCX: ffff8a07b6160908
  	RDX: 00000000ffffffd8 RSI: 0000000000000027 RDI: ffff8a07b6160900
  	RBP: ffff8a00cba36862 R08: 0000000000000000 R09: 00000000ffff7fff
  	R10: ffffb68f006577c0 R11: ffffffffb0fdcdc8 R12: ffff8a00c3bf9680
  	R13: ffff8a00c3bf96f0 R14: 0000000000000000 R15: ffff8a00d8766e00
  	FS:  0000000000000000(0000) GS:ffff8a07b6140000(0000) knlGS:0000000000000000
  	CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  	CR2: 000055f10b520b28 CR3: 000000039741a000 CR4: 00000000000006f0
  	Call Trace:
  	<TASK>
  	igmp_heard_query (net/ipv4/igmp.c:1068)
  	igmp_rcv (net/ipv4/igmp.c:1132)
  	ip_protocol_deliver_rcu (net/ipv4/ip_input.c:205)
  	ip_local_deliver_finish (net/ipv4/ip_input.c:234)
  	__netif_receive_skb_one_core (net/core/dev.c:5529)
  	netif_receive_skb_internal (net/core/dev.c:5729)
  	netif_receive_skb (net/core/dev.c:5788)
  	br_handle_frame_finish (net/bridge/br_input.c:216)
  	nf_hook_bridge_pre (net/bridge/br_input.c:294)
  	__netif_receive_skb_core (net/core/dev.c:5423)
  	__netif_receive_skb_list_core (net/core/dev.c:5606)
  	__netif_receive_skb_list (net/core/dev.c:5674)
  	netif_receive_skb_list_internal (net/core/dev.c:5764)
  	napi_gro_receive (net/core/gro.c:609)
  	e1000_clean_rx_irq (drivers/net/ethernet/intel/e1000/e1000_main.c:4467)
  	e1000_clean (drivers/net/ethernet/intel/e1000/e1000_main.c:3805)
  	__napi_poll (net/core/dev.c:6533)
  	net_rx_action (net/core/dev.c:6735)
  	__do_softirq (kernel/softirq.c:554)
  	run_ksoftirqd (kernel/softirq.c:913)
  	smpboot_thread_fn (kernel/smpboot.c:164)
  	kthread (kernel/kthread.c:388)
  	ret_from_fork (arch/x86/kernel/process.c:153)
  	ret_from_fork_asm (arch/x86/entry/entry_64.S:250)
  	</TASK>

  The root causes are as follows:
  Thread A					Thread B
  ...						netif_receive_skb
  br_dev_stop					...
      br_multicast_leave_snoopers			...
          __ip_mc_dec_group			...
              __igmp_group_dropped		igmp_rcv
                  igmp_stop_timer			    igmp_heard_query         //ref = 1
                  ip_ma_put			        igmp_mod_timer
                      refcount_dec_and_test	            igmp_start_timer //ref = 0
  			...                                     refcount_inc //ref increases from 0
  When the device receives an IGMPv2 Query message, it starts the timer
  immediately, regardless of whether the device is running. If the device is
  down and has left the multicast group, it will cause the mc list refcount
  uaf issue.
- Usb: config: fix iteration issue in 'usb_get_bos_descriptor()' [Niklas
  Neronin]

  [ Upstream commit 974bba5c118f4c2baf00de0356e3e4f7928b4cbc ]

  The BOS descriptor defines a root descriptor and is the base descriptor for
  accessing a family of related descriptors.

  Function 'usb_get_bos_descriptor()' encounters an iteration issue when
  skipping the 'USB_DT_DEVICE_CAPABILITY' descriptor type. This results in
  the same descriptor being read repeatedly.

  To address this issue, a 'goto' statement is introduced to ensure that the
  pointer and the amount read is updated correctly. This ensures that the
  function iterates to the next descriptor instead of reading the same
  descriptor repeatedly.
- USB: core: Change configuration warnings to notices. [Alan Stern]

  [ Upstream commit 7a09c1269702db8eccb6f718da2b00173e1e0034 ]

  It has been pointed out that the kernel log messages warning about
  problems in USB configuration and related descriptors are vexing for
  users.  The warning log level has a fairly high priority, but the user
  can do nothing to fix the underlying errors in the device's firmware.

  To reduce the amount of useless information produced by tools that
  filter high-priority log messages, we can change these warnings to
  notices, i.e., change dev_warn() to dev_notice().  The same holds for
  a few messages that currently use dev_err(): Unless they indicate a
  failure that might make a device unusable (such as inability to
  transfer a config descriptor), change them to dev_notice() also.
- Hv_netvsc: fix race of netvsc and VF register_netdevice. [Haiyang
  Zhang]

  [ Upstream commit d30fb712e52964f2cf9a9c14cf67078394044837 ]

  The rtnl lock also needs to be held before rndis_filter_device_add()
  which advertises nvsp_2_vsc_capability / sriov bit, and triggers
  VF NIC offering and registering. If VF NIC finished register_netdev()
  earlier it may cause name based config failure.

  To fix this issue, move the call to rtnl_lock() before
  rndis_filter_device_add(), so VF will be registered later than netvsc
  / synthetic NIC, and gets a name numbered (ethX) after netvsc.
- Input: xpad - add HyperX Clutch Gladiate Support. [Max Nguyen]

  commit e28a0974d749e5105d77233c0a84d35c37da047e upstream.

  Add HyperX controller support to xpad_device and xpad_table.
- Btrfs: make error messages more clear when getting a chunk map.
  [Filipe Manana]

  commit 7d410d5efe04e42a6cd959bfe6d59d559fdf8b25 upstream.

  When getting a chunk map, at btrfs_get_chunk_map(), we do some sanity
  checks to verify we found a chunk map and that map found covers the
  logical address the caller passed in. However the messages aren't very
  clear in the sense that don't mention the issue is with a chunk map and
  one of them prints the 'length' argument as if it were the end offset of
  the requested range (while the in the string format we use %llu-%llu
  which suggests a range, and the second %llu-%llu is actually a range for
  the chunk map). So improve these two details in the error messages.
- Btrfs: send: ensure send_fd is writable. [Jann Horn]

  commit 0ac1d13a55eb37d398b63e6ff6db4a09a2c9128c upstream.

  kernel_write() requires the caller to ensure that the file is writable.
  Let's do that directly after looking up the ->send_fd.

  We don't need a separate bailout path because the "out" path already
  does fput() if ->send_filp is non-NULL.

  This has no security impact for two reasons:

   - the ioctl requires CAP_SYS_ADMIN
   - __kernel_write() bails out on read-only files - but only since 5.8,
     see commit a01ac27be472 ("fs: check FMODE_WRITE in __kernel_write")
- Btrfs: fix off-by-one when checking chunk map includes logical
  address. [Filipe Manana]

  commit 5fba5a571858ce2d787fdaf55814e42725bfa895 upstream.

  At btrfs_get_chunk_map() we get the extent map for the chunk that contains
  the given logical address stored in the 'logical' argument. Then we do
  sanity checks to verify the extent map contains the logical address. One
  of these checks verifies if the extent map covers a range with an end
  offset behind the target logical address - however this check has an
  off-by-one error since it will consider an extent map whose start offset
  plus its length matches the target logical address as inclusive, while
  the fact is that the last byte it covers is behind the target logical
  address (by 1).

  So fix this condition by using '<=' rather than '<' when comparing the
  extent map's "start + length" against the target logical address.
- Btrfs: ref-verify: fix memory leaks in btrfs_ref_tree_mod()
  [Bragatheswaran Manickavel]

  commit f91192cd68591c6b037da345bc9fcd5e50540358 upstream.

  In btrfs_ref_tree_mod(), when !parent 're' was allocated through
  kmalloc(). In the following code, if an error occurs, the execution will
  be redirected to 'out' or 'out_unlock' and the function will be exited.
  However, on some of the paths, 're' are not deallocated and may lead to
  memory leaks.

  For example: lookup_block_entry() for 'be' returns NULL, the out label
  will be invoked. During that flow ref and 'ra' are freed but not 're',
  which can potentially lead to a memory leak.
- Btrfs: add dmesg output for first mount and last unmount of a
  filesystem. [Qu Wenruo]

  commit 2db313205f8b96eea467691917138d646bb50aef upstream.

  There is a feature request to add dmesg output when unmounting a btrfs.
  There are several alternative methods to do the same thing, but with
  their own problems:

  - Use eBPF to watch btrfs_put_super()/open_ctree()
    Not end user friendly, they have to dip their head into the source
    code.

  - Watch for directory /sys/fs/<uuid>/
    This is way more simple, but still requires some simple device -> uuid
    lookups.  And a script needs to use inotify to watch /sys/fs/.

  Compared to all these, directly outputting the information into dmesg
  would be the most simple one, with both device and UUID included.

  And since we're here, also add the output when mounting a filesystem for
  the first time for parity. A more fine grained monitoring of subvolume
  mounts should be done by another layer, like audit.

  Now mounting a btrfs with all default mkfs options would look like this:

    [81.906566] BTRFS info (device dm-8): first mount of filesystem 633b5c16-afe3-4b79-b195-138fe145e4f2
    [81.907494] BTRFS info (device dm-8): using crc32c (crc32c-intel) checksum algorithm
    [81.908258] BTRFS info (device dm-8): using free space tree
    [81.912644] BTRFS info (device dm-8): auto enabling async discard
    [81.913277] BTRFS info (device dm-8): checking UUID tree
    [91.668256] BTRFS info (device dm-8): last unmount of filesystem 633b5c16-afe3-4b79-b195-138fe145e4f2

  CC: stable@vger.kernel.org # 5.4+
  Link: https://github.com/kdave/btrfs-progs/issues/689
  Reviewed-by: Anand Jain <anand.jain@oracle.com>
  Signed-off-by: Qu Wenruo <wqu@suse.com>
  Reviewed-by: David Sterba <dsterba@suse.com>
  [ update changelog ]
- Parisc: Drop the HP-UX ENOSYM and EREMOTERELEASE error codes. [Helge
  Deller]

  commit e5f3e299a2b1e9c3ece24a38adfc089aef307e8a upstream.

  Those return codes are only defined for the parisc architecture and
  are leftovers from when we wanted to be HP-UX compatible.

  They are not returned by any Linux kernel syscall but do trigger
  problems with the glibc strerrorname_np() and strerror() functions as
  reported in glibc issue #31080.

  There is no need to keep them, so simply remove them.
- Powerpc: Don't clobber f0/vs0 during fp|altivec register save.
  [Timothy Pearson]

  commit 5e1d824f9a283cbf90f25241b66d1f69adb3835b upstream.

  During floating point and vector save to thread data f0/vs0 are
  clobbered by the FPSCR/VSCR store routine. This has been obvserved to
  lead to userspace register corruption and application data corruption
  with io-uring.

  Fix it by restoring f0/vs0 after FPSCR/VSCR store has completed for
  all the FP, altivec, VMX register save paths.

  Tested under QEMU in kvm mode, running on a Talos II workstation with
  dual POWER9 DD2.2 CPUs.

  Additional detail (mpe):

  Typically save_fpu() is called from __giveup_fpu() which saves the FP
  regs and also *turns off FP* in the tasks MSR, meaning the kernel will
  reload the FP regs from the thread struct before letting the task use FP
  again. So in that case save_fpu() is free to clobber f0 because the FP
  regs no longer hold live values for the task.

  There is another case though, which is the path via:
    sys_clone()
      ...
      copy_process()
        dup_task_struct()
          arch_dup_task_struct()
            flush_all_to_thread()
              save_all()

  That path saves the FP regs but leaves them live. That's meant as an
  optimisation for a process that's using FP/VSX and then calls fork(),
  leaving the regs live means the parent process doesn't have to take a
  fault after the fork to get its FP regs back. The optimisation was added
  in commit 8792468da5e1 ("powerpc: Add the ability to save FPU without
  giving it up").

  That path does clobber f0, but f0 is volatile across function calls,
  and typically programs reach copy_process() from userspace via a syscall
  wrapper function. So in normal usage f0 being clobbered across a
  syscall doesn't cause visible data corruption.

  But there is now a new path, because io-uring can call copy_process()
  via create_io_thread() from the signal handling path. That's OK if the
  signal is handled as part of syscall return, but it's not OK if the
  signal is handled due to some other interrupt.

  That path is:

  interrupt_return_srr_user()
    interrupt_exit_user_prepare()
      interrupt_exit_user_prepare_main()
        do_notify_resume()
          get_signal()
            task_work_run()
              create_worker_cb()
                create_io_worker()
                  copy_process()
                    dup_task_struct()
                      arch_dup_task_struct()
                        flush_all_to_thread()
                          save_all()
                            if (tsk->thread.regs->msr & MSR_FP)
                              save_fpu()
                              # f0 is clobbered and potentially live in userspace

  Note the above discussion applies equally to save_altivec().

  Fixes: 8792468da5e1 ("powerpc: Add the ability to save FPU without giving it up")
  Cc: stable@vger.kernel.org # v4.6+
  Closes: https://lore.kernel.org/all/480932026.45576726.1699374859845.JavaMail.zimbra@raptorengineeringinc.com/
  Closes: https://lore.kernel.org/linuxppc-dev/480221078.47953493.1700206777956.JavaMail.zimbra@raptorengineeringinc.com/
  Tested-by: Timothy Pearson <tpearson@raptorengineering.com>
  Tested-by: Jens Axboe <axboe@kernel.dk>
  Signed-off-by: Timothy Pearson <tpearson@raptorengineering.com>
  [mpe: Reword change log to describe exact path of corruption & other minor tweaks]
- Iommu/vt-d: Add MTL to quirk list to skip TE disabling. [Abdul Halim,
  Mohd Syazwan]

  commit 85b80fdffa867d75dfb9084a839e7949e29064e8 upstream.

  The VT-d spec requires (10.4.4 Global Command Register, TE field) that:

  Hardware implementations supporting DMA draining must drain any in-flight
  DMA read/write requests queued within the Root-Complex before switching
  address translation on or off and reflecting the status of the command
  through the TES field in the Global Status register.

  Unfortunately, some integrated graphic devices fail to do so after some
  kind of power state transition. As the result, the system might stuck in
  iommu_disable_translation(), waiting for the completion of TE transition.

  Add MTL to the quirk list for those devices and skips TE disabling if the
  qurik hits.
- Bcache: revert replacing IS_ERR_OR_NULL with IS_ERR. [Markus Weippert]

  commit bb6cc253861bd5a7cf8439e2118659696df9619f upstream.

  Commit 028ddcac477b ("bcache: Remove unnecessary NULL point check in
  node allocations") replaced IS_ERR_OR_NULL by IS_ERR. This leads to a
  NULL pointer dereference.

  BUG: kernel NULL pointer dereference, address: 0000000000000080
  Call Trace:
   ? __die_body.cold+0x1a/0x1f
   ? page_fault_oops+0xd2/0x2b0
   ? exc_page_fault+0x70/0x170
   ? asm_exc_page_fault+0x22/0x30
   ? btree_node_free+0xf/0x160 [bcache]
   ? up_write+0x32/0x60
   btree_gc_coalesce+0x2aa/0x890 [bcache]
   ? bch_extent_bad+0x70/0x170 [bcache]
   btree_gc_recurse+0x130/0x390 [bcache]
   ? btree_gc_mark_node+0x72/0x230 [bcache]
   bch_btree_gc+0x5da/0x600 [bcache]
   ? cpuusage_read+0x10/0x10
   ? bch_btree_gc+0x600/0x600 [bcache]
   bch_gc_thread+0x135/0x180 [bcache]

  The relevant code starts with:

      new_nodes[0] = NULL;

      for (i = 0; i < nodes; i++) {
          if (__bch_keylist_realloc(&keylist, bkey_u64s(&r[i].b->key)))
              goto out_nocoalesce;
      // ...
  out_nocoalesce:
      // ...
      for (i = 0; i < nodes; i++)
          if (!IS_ERR(new_nodes[i])) {  // IS_ERR_OR_NULL before
  028ddcac477b
              btree_node_free(new_nodes[i]);  // new_nodes[0] is NULL
              rw_unlock(true, new_nodes[i]);
          }

  This patch replaces IS_ERR() by IS_ERR_OR_NULL() to fix this.
- Dm verity: don't perform FEC for failed readahead IO. [Wu Bo]

  commit 0193e3966ceeeef69e235975918b287ab093082b upstream.

  We found an issue under Android OTA scenario that many BIOs have to do
  FEC where the data under dm-verity is 100% complete and no corruption.

  Android OTA has many dm-block layers, from upper to lower:
  dm-verity
  dm-snapshot
  dm-origin & dm-cow
  dm-linear
  ufs

  DM tables have to change 2 times during Android OTA merging process.
  When doing table change, the dm-snapshot will be suspended for a while.
  During this interval, many readahead IOs are submitted to dm_verity
  from filesystem. Then the kverity works are busy doing FEC process
  which cost too much time to finish dm-verity IO. This causes needless
  delay which feels like system is hung.

  After adding debugging it was found that each readahead IO needed
  around 10s to finish when this situation occurred. This is due to IO
  amplification:

  dm-snapshot suspend
  erofs_readahead     // 300+ io is submitted
  	dm_submit_bio (dm_verity)
  		dm_submit_bio (dm_snapshot)
  		bio return EIO
  		bio got nothing, it's empty
  	verity_end_io
  	verity_verify_io
  	forloop range(0, io->n_blocks)    // each io->nblocks ~= 20
  		verity_fec_decode
  		fec_decode_rsb
  		fec_read_bufs
  		forloop range(0, v->fec->rsn) // v->fec->rsn = 253
  			new_read
  			submit_bio (dm_snapshot)
  		end loop
  	end loop
  dm-snapshot resume

  Readahead BIOs get nothing while dm-snapshot is suspended, so all of
  them will cause verity's FEC.
  Each readahead BIO needs to verify ~20 (io->nblocks) blocks.
  Each block needs to do FEC, and every block needs to do 253
  (v->fec->rsn) reads.
  So during the suspend interval(~200ms), 300 readahead BIOs trigger
  ~1518000 (300*20*253) IOs to dm-snapshot.

  As readahead IO is not required by userspace, and to fix this issue,
  it is best to pass readahead errors to upper layer to handle it.
- Dm-verity: align struct dm_verity_fec_io properly. [Mikulas Patocka]

  commit 38bc1ab135db87577695816b190e7d6d8ec75879 upstream.

  dm_verity_fec_io is placed after the end of two hash digests. If the hash
  digest has unaligned length, struct dm_verity_fec_io could be unaligned.

  This commit fixes the placement of struct dm_verity_fec_io, so that it's
  aligned.
- ALSA: hda/realtek: Add supported ALC257 for ChromeOS. [Kailang Yang]

  commit cae2bdb579ecc9d4219c58a7d3fde1958118dc1d upstream.

  ChromeOS want to support ALC257.
  Add codec ID to some relation function.
- ALSA: hda/realtek: Headset Mic VREF to 100% [Kailang Yang]

  commit baaacbff64d9f34b64f294431966d035aeadb81c upstream.

  This platform need to set Mic VREF to 100%.
- ALSA: hda: Disable power-save on KONTRON SinglePC. [Takashi Iwai]

  commit a337c355719c42a6c5b67e985ad753590ed844fb upstream.

  It's been reported that the runtime PM on KONTRON SinglePC (PCI SSID
  1734:1232) caused a stall of playback after a bunch of invocations.
  (FWIW, this looks like an timing issue, and the stall happens rather
  on the controller side.)

  As a workaround, disable the default power-save on this platform.
- Mmc: block: Do not lose cache flush during CQE error recovery. [Adrian
  Hunter]

  commit 174925d340aac55296318e43fd96c0e1d196e105 upstream.

  During CQE error recovery, error-free data commands get requeued if there
  is any data left to transfer, but non-data commands are completed even
  though they have not been processed.  Requeue them instead.

  Note the only non-data command is cache flush, which would have resulted in
  a cache flush being lost if it was queued at the time of CQE recovery.
- Firewire: core: fix possible memory leak in create_units() [Yang
  Yingliang]

  commit 891e0eab32a57fca4d36c5162628eb0bcb1f0edf upstream.

  If device_register() fails, the refcount of device is not 0, the name
  allocated in dev_set_name() is leaked. To fix this by calling put_device(),
  so that it will be freed in callback function kobject_cleanup().

  unreferenced object 0xffff9d99035c7a90 (size 8):
    comm "systemd-udevd", pid 168, jiffies 4294672386 (age 152.089s)
    hex dump (first 8 bytes):
      66 77 30 2e 30 00 ff ff                          fw0.0...
    backtrace:
      [<00000000e1d62bac>] __kmem_cache_alloc_node+0x1e9/0x360
      [<00000000bbeaff31>] __kmalloc_node_track_caller+0x44/0x1a0
      [<00000000491f2fb4>] kvasprintf+0x67/0xd0
      [<000000005b960ddc>] kobject_set_name_vargs+0x1e/0x90
      [<00000000427ac591>] dev_set_name+0x4e/0x70
      [<000000003b4e447d>] create_units+0xc5/0x110

  fw_unit_release() will be called in the error path, move fw_device_get()
  before calling device_register() to keep balanced with fw_device_put() in
  fw_unit_release().
- Pinctrl: avoid reload of p state in list iteration. [Maria Yu]

  commit 4198a9b571065978632276264e01d71d68000ac5 upstream.

  When in the list_for_each_entry iteration, reload of p->state->settings
  with a local setting from old_state will turn the list iteration into an
  infinite loop.

  The typical symptom when the issue happens, will be a printk message like:

    "not freeing pin xx (xxx) as part of deactivating group xxx - it is
  already used for some other setting".

  This is a compiler-dependent problem, one instance occurred using Clang
  version 10.0 on the arm64 architecture with linux version 4.19.
- Io_uring: fix off-by one bvec index. [Keith Busch]

  commit d6fef34ee4d102be448146f24caf96d7b4a05401 upstream.

  If the offset equals the bv_len of the first registered bvec, then the
  request does not include any of that first bvec. Skip it so that drivers
  don't have to deal with a zero length bvec, which was observed to break
  NVMe's PRP list creation.
- USB: dwc3: qcom: fix wakeup after probe deferral. [Johan Hovold]

  commit 41f5a0973259db9e4e3c9963d36505f80107d1a0 upstream.

  The Qualcomm glue driver is overriding the interrupt trigger types
  defined by firmware when requesting the wakeup interrupts during probe.

  This can lead to a failure to map the DP/DM wakeup interrupts after a
  probe deferral as the firmware defined trigger types do not match the
  type used for the initial mapping:

  	irq: type mismatch, failed to map hwirq-14 for interrupt-controller@b220000!
  	irq: type mismatch, failed to map hwirq-15 for interrupt-controller@b220000!

  Fix this by not overriding the firmware provided trigger types when
  requesting the wakeup interrupts.
- Usb: dwc3: set the dma max_seg_size. [Ricardo Ribalda]

  commit 8bbae288a85abed6a1cf7d185d8b9dc2f5dcb12c upstream.

  Allow devices to have dma operations beyond 4K, and avoid warnings such
  as:
- Usb: dwc3: Fix default mode initialization. [Alexander Stein]

  commit 10d510abd096d620b9fda2dd3e0047c5efc4ad2b upstream.

  The default mode, configurable by DT, shall be set before usb role switch
  driver is registered. Otherwise there is a race between default mode
  and mode set by usb role switch driver.
- USB: dwc2: write HCINT with INTMASK applied. [Oliver Neukum]

  commit 0583bc776ca5b5a3f5752869fc31cf7322df2b35 upstream.

  dwc2_hc_n_intr() writes back INTMASK as read but evaluates it
  with intmask applied. In stress testing this causes spurious
  interrupts like this:

  [Mon Aug 14 10:51:07 2023] dwc2 3f980000.usb: dwc2_hc_chhltd_intr_dma: Channel 7 - ChHltd set, but reason is unknown
  [Mon Aug 14 10:51:07 2023] dwc2 3f980000.usb: hcint 0x00000002, intsts 0x04600001
  [Mon Aug 14 10:51:08 2023] dwc2 3f980000.usb: dwc2_hc_chhltd_intr_dma: Channel 0 - ChHltd set, but reason is unknown
  [Mon Aug 14 10:51:08 2023] dwc2 3f980000.usb: hcint 0x00000002, intsts 0x04600001
  [Mon Aug 14 10:51:08 2023] dwc2 3f980000.usb: dwc2_hc_chhltd_intr_dma: Channel 4 - ChHltd set, but reason is unknown
  [Mon Aug 14 10:51:08 2023] dwc2 3f980000.usb: hcint 0x00000002, intsts 0x04600001
  [Mon Aug 14 10:51:08 2023] dwc2 3f980000.usb: dwc2_update_urb_state_abn(): trimming xfer length

  Applying INTMASK prevents this. The issue exists in all versions of the
  driver.
- USB: serial: option: don't claim interface 4 for ZTE MF290. [Lech
  Perczak]

  commit 8771127e25d6c20d458ad27cf32f7fcfc1755e05 upstream.

  Interface 4 is used by for QMI interface in stock firmware of MF28D, the
  router which uses MF290 modem. Free the interface up, to rebind it to
  qmi_wwan driver.
  The proper configuration is:

  Interface mapping is:
  0: QCDM, 1: (unknown), 2: AT (PCUI), 2: AT (Modem), 4: QMI

  T:  Bus=01 Lev=02 Prnt=02 Port=00 Cnt=01 Dev#=  4 Spd=480  MxCh= 0
  D:  Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
  P:  Vendor=19d2 ProdID=0189 Rev= 0.00
  S:  Manufacturer=ZTE, Incorporated
  S:  Product=ZTE LTE Technologies MSM
  C:* #Ifs= 5 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=84(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
  I:* If#= 4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi_wwan
  E:  Ad=86(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=87(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
- USB: serial: option: fix FM101R-GL defines. [Puliang Lu]

  commit a1092619dd28ac0fcf23016160a2fdccd98ef935 upstream.

  Modify the definition of the two Fibocom FM101R-GL PID macros, which had
  their PIDs switched.

  The correct PIDs are:

  - VID:PID 413C:8213, FM101R-GL ESIM are laptop M.2 cards (with
    MBIM interfaces for Linux)

  - VID:PID 413C:8215, FM101R-GL are laptop M.2 cards (with
    MBIM interface for Linux)

  0x8213: mbim, tty
  0x8215: mbim, tty
- USB: serial: option: add Fibocom L7xx modules. [Victor Fragoso]

  commit e389fe8b68137344562fb6e4d53d8a89ef6212dd upstream.

  Add support for Fibocom L716-EU module series.

  L716-EU is a Fibocom module based on ZTE's V3E/V3T chipset.

  Device creates multiple interfaces when connected to PC as follows:
   - Network Interface: ECM or RNDIS (set by FW or AT Command)
   - ttyUSB0: AT port
   - ttyUSB1: Modem port
   - ttyUSB2: AT2 port
   - ttyUSB3: Trace port for log information
   - ADB: ADB port for debugging. ("Driver=usbfs" when ADB server enabled)

  Here are the outputs of lsusb and usb-devices:
  $ ls /dev/ttyUSB*
  /dev/ttyUSB0  /dev/ttyUSB1  /dev/ttyUSB2  /dev/ttyUSB3

  usb-devices:
  L716-EU (ECM mode):
  T:  Bus=03 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 51 Spd=480  MxCh= 0
  D:  Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
  P:  Vendor=2cb7 ProdID=0001 Rev= 1.00
  S:  Manufacturer=Fibocom,Incorporated
  S:  Product=Fibocom Mobile Boardband
  S:  SerialNumber=1234567890ABCDEF
  C:* #Ifs= 7 Cfg#= 1 Atr=e0 MxPwr=500mA
  A:  FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=06 Prot=00
  I:* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=06 Prot=00 Driver=cdc_ether
  E:  Ad=87(I) Atr=03(Int.) MxPS=  16 Ivl=32ms
  I:  If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc_ether
  I:* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc_ether
  E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 3 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 6 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=42 Prot=01 Driver=usbfs
  E:  Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=06(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms

  L716-EU (RNDIS mode):
  T:  Bus=03 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 49 Spd=480  MxCh= 0
  D:  Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
  P:  Vendor=2cb7 ProdID=0001 Rev= 1.00
  S:  Manufacturer=Fibocom,Incorporated
  S:  Product=Fibocom Mobile Boardband
  S:  SerialNumber=1234567890ABCDEF
  C:* #Ifs= 7 Cfg#= 1 Atr=e0 MxPwr=500mA
  A:  FirstIf#= 0 IfCount= 2 Cls=e0(wlcon) Sub=01 Prot=03
  I:* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=02 Prot=ff Driver=rndis_host
  E:  Ad=87(I) Atr=03(Int.) MxPS=   8 Ivl=32ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=rndis_host
  E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 3 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:* If#= 6 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=42 Prot=01 Driver=usbfs
  E:  Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=06(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
- Bcache: fixup lock c->root error. [Mingzhe Zou]

  commit e34820f984512b433ee1fc291417e60c47d56727 upstream.

  We had a problem with io hung because it was waiting for c->root to
  release the lock.

  crash> cache_set.root -l cache_set.list ffffa03fde4c0050
    root = 0xffff802ef454c800
  crash> btree -o 0xffff802ef454c800 | grep rw_semaphore
    [ffff802ef454c858] struct rw_semaphore lock;
  crash> struct rw_semaphore ffff802ef454c858
  struct rw_semaphore {
    count = {
      counter = -4294967297
    },
    wait_list = {
      next = 0xffff00006786fc28,
      prev = 0xffff00005d0efac8
    },
    wait_lock = {
      raw_lock = {
        {
          val = {
            counter = 0
          },
          {
            locked = 0 '\000',
            pending = 0 '\000'
          },
          {
            locked_pending = 0,
            tail = 0
          }
        }
      }
    },
    osq = {
      tail = {
        counter = 0
      }
    },
    owner = 0xffffa03fdc586603
  }

  The "counter = -4294967297" means that lock count is -1 and a write lock
  is being attempted. Then, we found that there is a btree with a counter
  of 1 in btree_cache_freeable.

  crash> cache_set -l cache_set.list ffffa03fde4c0050 -o|grep btree_cache
    [ffffa03fde4c1140] struct list_head btree_cache;
    [ffffa03fde4c1150] struct list_head btree_cache_freeable;
    [ffffa03fde4c1160] struct list_head btree_cache_freed;
    [ffffa03fde4c1170] unsigned int btree_cache_used;
    [ffffa03fde4c1178] wait_queue_head_t btree_cache_wait;
    [ffffa03fde4c1190] struct task_struct *btree_cache_alloc_lock;
  crash> list -H ffffa03fde4c1140|wc -l
  973
  crash> list -H ffffa03fde4c1150|wc -l
  1123
  crash> cache_set.btree_cache_used -l cache_set.list ffffa03fde4c0050
    btree_cache_used = 2097
  crash> list -s btree -l btree.list -H ffffa03fde4c1140|grep -E -A2 "^  lock = {" > btree_cache.txt
  crash> list -s btree -l btree.list -H ffffa03fde4c1150|grep -E -A2 "^  lock = {" > btree_cache_freeable.txt
  [root@node-3 127.0.0.1-2023-08-04-16:40:28]# pwd
  /var/crash/127.0.0.1-2023-08-04-16:40:28
  [root@node-3 127.0.0.1-2023-08-04-16:40:28]# cat btree_cache.txt|grep counter|grep -v "counter = 0"
  [root@node-3 127.0.0.1-2023-08-04-16:40:28]# cat btree_cache_freeable.txt|grep counter|grep -v "counter = 0"
        counter = 1

  We found that this is a bug in bch_sectors_dirty_init() when locking c->root:
      (1). Thread X has locked c->root(A) write.
      (2). Thread Y failed to lock c->root(A), waiting for the lock(c->root A).
      (3). Thread X bch_btree_set_root() changes c->root from A to B.
      (4). Thread X releases the lock(c->root A).
      (5). Thread Y successfully locks c->root(A).
      (6). Thread Y releases the lock(c->root B).

          down_write locked ---(1)----------------------┐
                  |                                     |
                  |   down_read waiting ---(2)----┐     |
                  |           |               ┌-------------┐ ┌-------------┐
          bch_btree_set_root ===(3)========>> | c->root   A | | c->root   B |
                  |           |               └-------------┘ └-------------┘
              up_write ---(4)---------------------┘     |            |
                              |                         |            |
                      down_read locked ---(5)-----------┘            |
                              |                                      |
                          up_read ---(6)-----------------------------┘

  Since c->root may change, the correct steps to lock c->root should be
  the same as bch_root_usage(), compare after locking.

  static unsigned int bch_root_usage(struct cache_set *c)
  {
          unsigned int bytes = 0;
          struct bkey *k;
          struct btree *b;
          struct btree_iter iter;

          goto lock_root;

          do {
                  rw_unlock(false, b);
  lock_root:
                  b = c->root;
                  rw_lock(false, b, b->level);
          } while (b != c->root);

          for_each_key_filter(&b->keys, k, &iter, bch_ptr_bad)
                  bytes += bkey_bytes(k);

          rw_unlock(false, b);

          return (bytes * 100) / btree_bytes(c);
  }
- Bcache: fixup init dirty data errors. [Mingzhe Zou]

  commit 7cc47e64d3d69786a2711a4767e26b26ba63d7ed upstream.

  We found that after long run, the dirty_data of the bcache device
  will have errors. This error cannot be eliminated unless re-register.

  We also found that reattach after detach, this error can accumulate.

  In bch_sectors_dirty_init(), all inode <= d->id keys will be recounted
  again. This is wrong, we only need to count the keys of the current
  device.
- Bcache: prevent potential division by zero error. [Rand Deeb]

  commit 2c7f497ac274a14330208b18f6f734000868ebf9 upstream.

  In SHOW(), the variable 'n' is of type 'size_t.' While there is a
  conditional check to verify that 'n' is not equal to zero before
  executing the 'do_div' macro, concerns arise regarding potential
  division by zero error in 64-bit environments.

  The concern arises when 'n' is 64 bits in size, greater than zero, and
  the lower 32 bits of it are zeros. In such cases, the conditional check
  passes because 'n' is non-zero, but the 'do_div' macro casts 'n' to
  'uint32_t,' effectively truncating it to its lower 32 bits.
  Consequently, the 'n' value becomes zero.

  To fix this potential division by zero error and ensure precise
  division handling, this commit replaces the 'do_div' macro with
  div64_u64(). div64_u64() is designed to work with 64-bit operands,
  guaranteeing that division is performed correctly.

  This change enhances the robustness of the code, ensuring that division
  operations yield accurate results in all scenarios, eliminating the
  possibility of division by zero, and improving compatibility across
  different 64-bit environments.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.
- Bcache: check return value from btree_node_alloc_replacement() [Coly
  Li]

  commit 777967e7e9f6f5f3e153abffb562bffaf4430d26 upstream.

  In btree_gc_rewrite_node(), pointer 'n' is not checked after it returns
  from btree_gc_rewrite_node(). There is potential possibility that 'n' is
  a non NULL ERR_PTR(), referencing such error code is not permitted in
  following code. Therefore a return value checking is necessary after 'n'
  is back from btree_node_alloc_replacement().
- Dm-delay: fix a race between delay_presuspend and delay_bio. [Mikulas
  Patocka]

  [ Upstream commit 6fc45b6ed921dc00dfb264dc08c7d67ee63d2656 ]

  In delay_presuspend, we set the atomic variable may_delay and then stop
  the timer and flush pending bios. The intention here is to prevent the
  delay target from re-arming the timer again.

  However, this test is racy. Suppose that one thread goes to delay_bio,
  sees that dc->may_delay is one and proceeds; now, another thread executes
  delay_presuspend, it sets dc->may_delay to zero, deletes the timer and
  flushes pending bios. Then, the first thread continues and adds the bio to
  delayed->list despite the fact that dc->may_delay is false.

  Fix this bug by changing may_delay's type from atomic_t to bool and
  only access it while holding the delayed_bios_lock mutex. Note that we
  don't have to grab the mutex in delay_resume because there are no bios
  in flight at this point.
- Hv_netvsc: Mark VF as slave before exposing it to user-mode. [Long Li]

  commit c807d6cd089d2f4951baa838081ec5ae3e2360f8 upstream.

  When a VF is being exposed form the kernel, it should be marked as "slave"
  before exposing to the user-mode. The VF is not usable without netvsc
  running as master. The user-mode should never see a VF without the "slave"
  flag.

  This commit moves the code of setting the slave flag to the time before
  VF is exposed to user-mode.
- Hv_netvsc: Fix race of register_netdevice_notifier and VF register.
  [Haiyang Zhang]

  commit 85520856466ed6bc3b1ccb013cddac70ceb437db upstream.

  If VF NIC is registered earlier, NETDEV_REGISTER event is replayed,
  but NETDEV_POST_INIT is not.

  Move register_netdevice_notifier() earlier, so the call back
  function is set before probing.
- USB: serial: option: add Luat Air72*U series products. [Asuna Yang]

  commit da90e45d5afc4da2de7cd3ea7943d0f1baa47cc2 upstream.

  Update the USB serial option driver support for Luat Air72*U series
  products.

  ID 1782:4e00 Spreadtrum Communications Inc. UNISOC-8910

  T: Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 13 Spd=480 MxCh= 0
  D: Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs= 1
  P: Vendor=1782 ProdID=4e00 Rev=00.00
  S: Manufacturer=UNISOC
  S: Product=UNISOC-8910
  C: #Ifs= 5 Cfg#= 1 Atr=e0 MxPwr=400mA
  I: If#= 0 Alt= 0 #EPs= 1 Cls=e0(wlcon) Sub=01 Prot=03 Driver=rndis_host
  E: Ad=82(I) Atr=03(Int.) MxPS= 8 Ivl=4096ms
  I: If#= 1 Alt= 0 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=rndis_host
  E: Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E: Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E: Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I: If#= 3 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E: Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I: If#= 4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
  E: Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E: Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms

  If#= 2: AT
  If#= 3: PPP + AT
  If#= 4: Debug
- S390/dasd: protect device queue against concurrent access. [Jan
  Höppner]

  commit db46cd1e0426f52999d50fa72cfa97fa39952885 upstream.

  In dasd_profile_start() the amount of requests on the device queue are
  counted. The access to the device queue is unprotected against
  concurrent access. With a lot of parallel I/O, especially with alias
  devices enabled, the device queue can change while dasd_profile_start()
  is accessing the queue. In the worst case this leads to a kernel panic
  due to incorrect pointer accesses.

  Fix this by taking the device lock before accessing the queue and
  counting the requests. Additionally the check for a valid profile data
  pointer can be done earlier to avoid unnecessary locking in a hot path.
- Bcache: fixup multi-threaded bch_sectors_dirty_init() wake-up race.
  [Mingzhe Zou]

  commit 2faac25d7958c4761bb8cec54adb79f806783ad6 upstream.

  We get a kernel crash about "unable to handle kernel paging request":

  ```dmesg
  [368033.032005] BUG: unable to handle kernel paging request at ffffffffad9ae4b5
  [368033.032007] PGD fc3a0d067 P4D fc3a0d067 PUD fc3a0e063 PMD 8000000fc38000e1
  [368033.032012] Oops: 0003 [#1] SMP PTI
  [368033.032015] CPU: 23 PID: 55090 Comm: bch_dirtcnt[0] Kdump: loaded Tainted: G           OE    --------- -  - 4.18.0-147.5.1.es8_24.x86_64 #1
  [368033.032017] Hardware name: Tsinghua Tongfang THTF Chaoqiang Server/072T6D, BIOS 2.4.3 01/17/2017
  [368033.032027] RIP: 0010:native_queued_spin_lock_slowpath+0x183/0x1d0
  [368033.032029] Code: 8b 02 48 85 c0 74 f6 48 89 c1 eb d0 c1 e9 12 83 e0
  03 83 e9 01 48 c1 e0 05 48 63 c9 48 05 c0 3d 02 00 48 03 04 cd 60 68 93
  ad <48> 89 10 8b 42 08 85 c0 75 09 f3 90 8b 42 08 85 c0 74 f7 48 8b 02
  [368033.032031] RSP: 0018:ffffbb48852abe00 EFLAGS: 00010082
  [368033.032032] RAX: ffffffffad9ae4b5 RBX: 0000000000000246 RCX: 0000000000003bf3
  [368033.032033] RDX: ffff97b0ff8e3dc0 RSI: 0000000000600000 RDI: ffffbb4884743c68
  [368033.032034] RBP: 0000000000000001 R08: 0000000000000000 R09: 000007ffffffffff
  [368033.032035] R10: ffffbb486bb01000 R11: 0000000000000001 R12: ffffffffc068da70
  [368033.032036] R13: 0000000000000003 R14: 0000000000000000 R15: 0000000000000000
  [368033.032038] FS:  0000000000000000(0000) GS:ffff97b0ff8c0000(0000) knlGS:0000000000000000
  [368033.032039] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [368033.032040] CR2: ffffffffad9ae4b5 CR3: 0000000fc3a0a002 CR4: 00000000003626e0
  [368033.032042] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  [368033.032043] bcache: bch_cached_dev_attach() Caching rbd479 as bcache462 on set 8cff3c36-4a76-4242-afaa-7630206bc70b
  [368033.032045] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  [368033.032046] Call Trace:
  [368033.032054]  _raw_spin_lock_irqsave+0x32/0x40
  [368033.032061]  __wake_up_common_lock+0x63/0xc0
  [368033.032073]  ? bch_ptr_invalid+0x10/0x10 [bcache]
  [368033.033502]  bch_dirty_init_thread+0x14c/0x160 [bcache]
  [368033.033511]  ? read_dirty_submit+0x60/0x60 [bcache]
  [368033.033516]  kthread+0x112/0x130
  [368033.033520]  ? kthread_flush_work_fn+0x10/0x10
  [368033.034505]  ret_from_fork+0x35/0x40
  ```

  The crash occurred when call wake_up(&state->wait), and then we want
  to look at the value in the state. However, bch_sectors_dirty_init()
  is not found in the stack of any task. Since state is allocated on
  the stack, we guess that bch_sectors_dirty_init() has exited, causing
  bch_dirty_init_thread() to be unable to handle kernel paging request.

  In order to verify this idea, we added some printing information during
  wake_up(&state->wait). We find that "wake up" is printed twice, however
  we only expect the last thread to wake up once.

  ```dmesg
  [  994.641004] alcache: bch_dirty_init_thread() wake up
  [  994.641018] alcache: bch_dirty_init_thread() wake up
  [  994.641523] alcache: bch_sectors_dirty_init() init exit
  ```

  There is a race. If bch_sectors_dirty_init() exits after the first wake
  up, the second wake up will trigger this bug("unable to handle kernel
  paging request").

  Proceed as follows:

  bch_sectors_dirty_init
      kthread_run ==============> bch_dirty_init_thread(bch_dirtcnt[0])
              ...                         ...
      atomic_inc(&state.started)          ...
              ...                         ...
      atomic_read(&state.enough)          ...
              ...                 atomic_set(&state->enough, 1)
      kthread_run ======================================================> bch_dirty_init_thread(bch_dirtcnt[1])
              ...                 atomic_dec_and_test(&state->started)            ...
      atomic_inc(&state.started)          ...                                     ...
              ...                 wake_up(&state->wait)                           ...
      atomic_read(&state.enough)                                          atomic_dec_and_test(&state->started)
              ...                                                                 ...
      wait_event(state.wait, atomic_read(&state.started) == 0)                    ...
      return                                                                      ...
                                                                          wake_up(&state->wait)

  We believe it is very common to wake up twice if there is no dirty, but
  crash is an extremely low probability event. It's hard for us to reproduce
  this issue. We attached and detached continuously for a week, with a total
  of more than one million attaches and only one crash.

  Putting atomic_inc(&state.started) before kthread_run() can avoid waking
  up twice.
- Bcache: replace a mistaken IS_ERR() by IS_ERR_OR_NULL() in
  btree_gc_coalesce() [Coly Li]

  commit f72f4312d4388376fc8a1f6cf37cb21a0d41758b upstream.

  Commit 028ddcac477b ("bcache: Remove unnecessary NULL point check in
  node allocations") do the following change inside btree_gc_coalesce(),

  31 @@ -1340,7 +1340,7 @@ static int btree_gc_coalesce(
  32         memset(new_nodes, 0, sizeof(new_nodes));
  33         closure_init_stack(&cl);
  34
  35 -       while (nodes < GC_MERGE_NODES && !IS_ERR_OR_NULL(r[nodes].b))
  36 +       while (nodes < GC_MERGE_NODES && !IS_ERR(r[nodes].b))
  37                 keys += r[nodes++].keys;
  38
  39         blocks = btree_default_blocks(b->c) * 2 / 3;

  At line 35 the original r[nodes].b is not always allocatored from
  __bch_btree_node_alloc(), and possibly initialized as NULL pointer by
  caller of btree_gc_coalesce(). Therefore the change at line 36 is not
  correct.

  This patch replaces the mistaken IS_ERR() by IS_ERR_OR_NULL() to avoid
  potential issue.
- Swiotlb-xen: provide the "max_mapping_size" method. [Keith Busch]

  commit bff2a2d453a1b683378b4508b86b84389f551a00 upstream.

  There's a bug that when using the XEN hypervisor with bios with large
  multi-page bio vectors on NVMe, the kernel deadlocks [1].

  The deadlocks are caused by inability to map a large bio vector -
  dma_map_sgtable always returns an error, this gets propagated to the block
  layer as BLK_STS_RESOURCE and the block layer retries the request
  indefinitely.

  XEN uses the swiotlb framework to map discontiguous pages into contiguous
  runs that are submitted to the PCIe device. The swiotlb framework has a
  limitation on the length of a mapping - this needs to be announced with
  the max_mapping_size method to make sure that the hardware drivers do not
  create larger mappings.

  Without max_mapping_size, the NVMe block driver would create large
  mappings that overrun the maximum mapping size.
- ACPI: resource: Skip IRQ override on ASUS ExpertBook B1402CVA. [Hans
  de Goede]

  commit bd911485294a6f0596e4592ed442438015cffc8a upstream.

  Like various other ASUS ExpertBook-s, the ASUS ExpertBook B1402CVA
  has an ACPI DSDT table that describes IRQ 1 as ActiveLow while
  the kernel overrides it to EdgeHigh.

  This prevents the keyboard from working. To fix this issue, add this laptop
  to the skip_override_table so that the kernel does not override IRQ 1.
- ASoC: simple-card: fixup asoc_simple_probe() error handling. [Kuninori
  Morimoto]

  commit 41bae58df411f9accf01ea660730649b2fab1dab upstream.

  asoc_simple_probe() is used for both "DT probe" (A) and "platform probe"
  (B). It uses "goto err" when error case, but it is not needed for
  "platform probe" case (B). Thus it is using "return" directly there.

  	static int asoc_simple_probe(...)
  	{
   ^		if (...) {
   |			...
  (A)			if (ret < 0)
   |				goto err;
   v		} else {
   ^			...
   |			if (ret < 0)
  (B)				return -Exxx;
   v		}

  		...
   ^		if (ret < 0)
  (C)			goto err;
   v		...

  	err:
  (D)		simple_util_clean_reference(card);

  		return ret;
  	}

  Both case are using (C) part, and it calls (D) when err case.
  But (D) will do nothing for (B) case.
  Because of these behavior, current code itself is not wrong,
  but is confusable, and more, static analyzing tool will warning on
  (B) part (should use goto err).

  To avoid static analyzing tool warning, this patch uses "goto err"
  on (B) part.
- Nfsd: lock_rename() needs both directories to live on the same fs. [Al
  Viro]

  commit 1aee9158bc978f91701c5992e395efbc6da2de3c upstream.

  ... checking that after lock_rename() is too late.  Incidentally,
  NFSv2 had no nfserr_xdev...
- Ext4: make sure allocate pending entry not fail. [Zhang Yi]

  [ Upstream commit 8e387c89e96b9543a339f84043cf9df15fed2632 ]

  __insert_pending() allocate memory in atomic context, so the allocation
  could fail, but we are not handling that failure now. It could lead
  ext4_es_remove_extent() to get wrong reserved clusters, and the global
  data blocks reservation count will be incorrect. The same to
  extents_status entry preallocation, preallocate pending entry out of the
  i_es_lock with __GFP_NOFAIL, make sure __insert_pending() and
  __revise_pending() always succeeds.
- Ext4: fix slab-use-after-free in ext4_es_insert_extent() [Baokun Li]

  [ Upstream commit 768d612f79822d30a1e7d132a4d4b05337ce42ec ]

  Yikebaer reported an issue:
  ==================================================================
  BUG: KASAN: slab-use-after-free in ext4_es_insert_extent+0xc68/0xcb0
  fs/ext4/extents_status.c:894
  Read of size 4 at addr ffff888112ecc1a4 by task syz-executor/8438

  CPU: 1 PID: 8438 Comm: syz-executor Not tainted 6.5.0-rc5 #1
  Call Trace:
   [...]
   kasan_report+0xba/0xf0 mm/kasan/report.c:588
   ext4_es_insert_extent+0xc68/0xcb0 fs/ext4/extents_status.c:894
   ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
   ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
   ext4_zero_range fs/ext4/extents.c:4622 [inline]
   ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
   [...]

  Allocated by task 8438:
   [...]
   kmem_cache_zalloc include/linux/slab.h:693 [inline]
   __es_alloc_extent fs/ext4/extents_status.c:469 [inline]
   ext4_es_insert_extent+0x672/0xcb0 fs/ext4/extents_status.c:873
   ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
   ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
   ext4_zero_range fs/ext4/extents.c:4622 [inline]
   ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
   [...]

  Freed by task 8438:
   [...]
   kmem_cache_free+0xec/0x490 mm/slub.c:3823
   ext4_es_try_to_merge_right fs/ext4/extents_status.c:593 [inline]
   __es_insert_extent+0x9f4/0x1440 fs/ext4/extents_status.c:802
   ext4_es_insert_extent+0x2ca/0xcb0 fs/ext4/extents_status.c:882
   ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
   ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
   ext4_zero_range fs/ext4/extents.c:4622 [inline]
   ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
   [...]
  ==================================================================

  The flow of issue triggering is as follows:
  1. remove es
        raw es               es  removed  es1
  |-------------------| -> |----|.......|------|

  2. insert es
    es   insert   es1      merge with es  es1     merge with es and free es1
  |----|.......|------| -> |------------|------| -> |-------------------|

  es merges with newes, then merges with es1, frees es1, then determines
  if es1->es_len is 0 and triggers a UAF.

  The code flow is as follows:
  ext4_es_insert_extent
    es1 = __es_alloc_extent(true);
    es2 = __es_alloc_extent(true);
    __es_remove_extent(inode, lblk, end, NULL, es1)
      __es_insert_extent(inode, &newes, es1) ---> insert es1 to es tree
    __es_insert_extent(inode, &newes, es2)
      ext4_es_try_to_merge_right
        ext4_es_free_extent(inode, es1) --->  es1 is freed
    if (es1 && !es1->es_len)
      // Trigger UAF by determining if es1 is used.

  We determine whether es1 or es2 is used immediately after calling
  __es_remove_extent() or __es_insert_extent() to avoid triggering a
  UAF if es1 or es2 is freed.
- Ext4: using nofail preallocation in ext4_es_insert_extent() [Baokun
  Li]

  [ Upstream commit 2a69c450083db164596c75c0f5b4d9c4c0e18eba ]

  Similar to in ext4_es_insert_delayed_block(), we use preallocations that
  do not fail to avoid inconsistencies, but we do not care about es that are
  not must be kept, and we return 0 even if such es memory allocation fails.
- Ext4: using nofail preallocation in ext4_es_insert_delayed_block()
  [Baokun Li]

  [ Upstream commit 4a2d98447b37bcb68a7f06a1078edcb4f7e6ce7e ]

  Similar to in ext4_es_remove_extent(), we use a no-fail preallocation
  to avoid inconsistencies, except that here we may have to preallocate
  two extent_status.
- Ext4: using nofail preallocation in ext4_es_remove_extent() [Baokun
  Li]

  [ Upstream commit e9fe2b882bd5b26b987c9ba110c2222796f72af5 ]

  If __es_remove_extent() returns an error it means that when splitting
  extent, allocating an extent that must be kept failed, where returning
  an error directly would cause the extent tree to be inconsistent. So we
  use GFP_NOFAIL to pre-allocate an extent_status and pass it to
  __es_remove_extent() to avoid this problem.

  In addition, since the allocated memory is outside the i_es_lock, the
  extent_status tree may change and the pre-allocated extent_status is
  no longer needed, so we release the pre-allocated extent_status when
  es->es_len is not initialized.
- Ext4: use pre-allocated es in __es_remove_extent() [Baokun Li]

  [ Upstream commit bda3efaf774fb687c2b7a555aaec3006b14a8857 ]

  When splitting extent, if the second extent can not be dropped, we return
  -ENOMEM and use GFP_NOFAIL to preallocate an extent_status outside of
  i_es_lock and pass it to __es_remove_extent() to be used as the second
  extent. This ensures that __es_remove_extent() is executed successfully,
  thus ensuring consistency in the extent status tree. If the second extent
  is not undroppable, we simply drop it and return 0. Then retry is no longer
  necessary, remove it.

  Now, __es_remove_extent() will always remove what it should, maybe more.
- Ext4: use pre-allocated es in __es_insert_extent() [Baokun Li]

  [ Upstream commit 95f0b320339a977cf69872eac107122bf536775d ]

  Pass a extent_status pointer prealloc to __es_insert_extent(). If the
  pointer is non-null, it is used directly when a new extent_status is
  needed to avoid memory allocation failures.
- Ext4: factor out __es_alloc_extent() and __es_free_extent() [Baokun
  Li]

  [ Upstream commit 73a2f033656be11298912201ad50615307b4477a ]

  Factor out __es_alloc_extent() and __es_free_extent(), which only allocate
  and free extent_status in these two helpers.

  The ext4_es_alloc_extent() function is split into __es_alloc_extent()
  and ext4_es_init_extent(). In __es_alloc_extent() we allocate memory using
  GFP_KERNEL | __GFP_NOFAIL | __GFP_ZERO if the memory allocation cannot
  fail, otherwise we use GFP_ATOMIC. and the ext4_es_init_extent() is used to
  initialize extent_status and update related variables after a successful
  allocation.

  This is to prepare for the use of pre-allocated extent_status later.
- Ext4: add a new helper to check if es must be kept. [Baokun Li]

  [ Upstream commit 9649eb18c6288f514cacffdd699d5cd999c2f8f6 ]

  In the extent status tree, we have extents which we can just drop without
  issues and extents we must not drop - this depends on the extent's status
  - currently ext4_es_is_delayed() extents must stay, others may be dropped.

  A helper function is added to help determine if the current extent can
  be dropped, although only ext4_es_is_delayed() extents cannot be dropped
  currently.
- MIPS: KVM: Fix a build warning about variable set but not used.
  [Huacai Chen]

  [ Upstream commit 83767a67e7b6a0291cde5681ec7e3708f3f8f877 ]

  After commit 411740f5422a ("KVM: MIPS/MMU: Implement KVM_CAP_SYNC_MMU")
  old_pte is no longer used in kvm_mips_map_page(). So remove it to fix a
  build warning about variable set but not used:

     arch/mips/kvm/mmu.c: In function 'kvm_mips_map_page':
  >> arch/mips/kvm/mmu.c:701:29: warning: variable 'old_pte' set but not used [-Wunused-but-set-variable]
       701 |         pte_t *ptep, entry, old_pte;
           |                             ^~~~~~~
- Media: ccs: Correctly initialise try compose rectangle. [Sakari Ailus]

  [ Upstream commit 724ff68e968b19d786870d333f9952bdd6b119cb ]

  Initialise the try sink compose rectangle size to the sink compose
  rectangle for binner and scaler sub-devices. This was missed due to the
  faulty condition that lead to the compose rectangles to be initialised for
  the pixel array sub-device where it is not relevant.
- Lockdep: Fix block chain corruption. [Peter Zijlstra]

  [ Upstream commit bca4104b00fec60be330cd32818dd5c70db3d469 ]

  Kent reported an occasional KASAN splat in lockdep. Mark then noted:

  > I suspect the dodgy access is to chain_block_buckets[-1], which hits the last 4
  > bytes of the redzone and gets (incorrectly/misleadingly) attributed to
  > nr_large_chain_blocks.

  That would mean @size == 0, at which point size_to_bucket() returns -1
  and the above happens.

  alloc_chain_hlocks() has 'size - req', for the first with the
  precondition 'size >= rq', which allows the 0.

  This code is trying to split a block, del_chain_block() takes what we
  need, and add_chain_block() puts back the remainder, except in the
  above case the remainder is 0 sized and things go sideways.
- USB: dwc3: qcom: fix ACPI platform device leak. [Johan Hovold]

  [ Upstream commit 9cf87666fc6e08572341fe08ecd909935998fbbd ]

  Make sure to free the "urs" platform device, which is created for some
  ACPI platforms, on probe errors and on driver unbind.

  Compile-tested only.
- USB: dwc3: qcom: fix resource leaks on probe deferral. [Johan Hovold]

  [ Upstream commit 51392a1879ff06dc21b68aef4825f6ef68a7be42 ]

  The driver needs to deregister and free the newly allocated dwc3 core
  platform device on ACPI probe errors (e.g. probe deferral) and on driver
  unbind but instead it leaked those resources while erroneously dropping
  a reference to the parent platform device which is still in use.

  For OF probing the driver takes a reference to the dwc3 core platform
  device which has also always been leaked.

  Fix the broken ACPI tear down and make sure to drop the dwc3 core
  reference for both OF and ACPI.
- Nvmet: nul-terminate the NQNs passed in the connect command.
  [Christoph Hellwig]

  [ Upstream commit 1c22e0295a5eb571c27b53c7371f95699ef705ff ]

  The host and subsystem NQNs are passed in the connect command payload and
  interpreted as nul-terminated strings.  Ensure they actually are
  nul-terminated before using them.
- Nvmet: remove unnecessary ctrl parameter. [Chaitanya Kulkarni]

  [ Upstream commit de5878048e11f1ec44164ebb8994de132074367a ]

  The function nvmet_ctrl_find_get() accepts out pointer to nvmet_ctrl
  structure. This function returns the same error value from two places
  that is :- NVME_SC_CONNECT_INVALID_PARAM | NVME_SC_DNR.

  Move this to the caller so we can change the return type to nvmet_ctrl.

  Now that we can changed the return type, instead of taking out pointer
  to the nvmet_ctrl structure remove that function parameter and return
  the valid nvmet_ctrl pointer on success and NULL on failure.

  Also, add and rename the goto labels for more readability with comments.
- Afs: Fix file locking on R/O volumes to operate in local mode. [David
  Howells]

  [ Upstream commit b590eb41be766c5a63acc7e8896a042f7a4e8293 ]

  AFS doesn't really do locking on R/O volumes as fileservers don't maintain
  state with each other and thus a lock on a R/O volume file on one
  fileserver will not be be visible to someone looking at the same file on
  another fileserver.

  Further, the server may return an error if you try it.

  Fix this by doing what other AFS clients do and handle filelocking on R/O
  volume files entirely within the client and don't touch the server.

  Fixes: 6c6c1d63c243 ("afs: Provide mount-time configurable byte-range file locking emulation")
  Signed-off-by: David Howells <dhowells@redhat.com>
  Reviewed-by: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Afs: Return ENOENT if no cell DNS record can be found. [David Howells]

  [ Upstream commit 0167236e7d66c5e1e85d902a6abc2529b7544539 ]

  Make AFS return error ENOENT if no cell SRV or AFSDB DNS record (or
  cellservdb config file record) can be found rather than returning
  EDESTADDRREQ.

  Also add cell name lookup info to the cursor dump.

  Fixes: d5c32c89b208 ("afs: Fix cell DNS lookup")
  Reported-by: Markus Suvanto <markus.suvanto@gmail.com>
  Link: https://bugzilla.kernel.org/show_bug.cgi?id=216637
  Signed-off-by: David Howells <dhowells@redhat.com>
  Reviewed-by: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Net: axienet: Fix check for partial TX checksum. [Samuel Holland]

  [ Upstream commit fd0413bbf8b11f56e8aa842783b0deda0dfe2926 ]

  Due to a typo, the code checked the RX checksum feature in the TX path.
- Amd-xgbe: propagate the correct speed and duplex status. [Raju
  Rangoju]

  [ Upstream commit 7a2323ac24a50311f64a3a9b54ed5bef5821ecae ]

  xgbe_get_link_ksettings() does not propagate correct speed and duplex
  information to ethtool during cable unplug. Due to which ethtool reports
  incorrect values for speed and duplex.

  Address this by propagating correct information.
- Amd-xgbe: handle the corner-case during tx completion. [Raju Rangoju]

  [ Upstream commit 7121205d5330c6a3cb3379348886d47c77b78d06 ]

  The existing implementation uses software logic to accumulate tx
  completions until the specified time (1ms) is met and then poll them.
  However, there exists a tiny gap which leads to a race between
  resetting and checking the tx_activate flag. Due to this the tx
  completions are not reported to upper layer and tx queue timeout
  kicks-in restarting the device.

  To address this, introduce a tx cleanup mechanism as part of the
  periodic maintenance process.
- Amd-xgbe: handle corner-case during sfp hotplug. [Raju Rangoju]

  [ Upstream commit 676ec53844cbdf2f47e68a076cdff7f0ec6cbe3f ]

  Force the mode change for SFI in Fixed PHY configurations. Fixed PHY
  configurations needs PLL to be enabled while doing mode set. When the
  SFP module isn't connected during boot, driver assumes AN is ON and
  attempts auto-negotiation. However, if the connected SFP comes up in
  Fixed PHY configuration the link will not come up as PLL isn't enabled
  while the initial mode set command is issued. So, force the mode change
  for SFI in Fixed PHY configuration to fix link issues.
- Arm/xen: fix xen_vcpu_info allocation alignment. [Stefano Stabellini]

  [ Upstream commit 7bf9a6b46549852a37e6d07e52c601c3c706b562 ]

  xen_vcpu_info is a percpu area than needs to be mapped by Xen.
  Currently, it could cross a page boundary resulting in Xen being unable
  to map it:

  [    0.567318] kernel BUG at arch/arm64/xen/../../arm/xen/enlighten.c:164!
  [    0.574002] Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP

  Fix the issue by using __alloc_percpu and requesting alignment for the
  memory allocation.
- Net/smc: avoid data corruption caused by decline. [D. Wythe]

  [ Upstream commit e6d71b437abc2f249e3b6a1ae1a7228e09c6e563 ]

  We found a data corruption issue during testing of SMC-R on Redis
  applications.

  The benchmark has a low probability of reporting a strange error as
  shown below.

  "Error: Protocol error, got "\xe2" as reply type byte"

  Finally, we found that the retrieved error data was as follows:

  0xE2 0xD4 0xC3 0xD9 0x04 0x00 0x2C 0x20 0xA6 0x56 0x00 0x16 0x3E 0x0C
  0xCB 0x04 0x02 0x01 0x00 0x00 0x20 0x00 0x00 0x00 0x00 0x00 0x00 0x00
  0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xE2

  It is quite obvious that this is a SMC DECLINE message, which means that
  the applications received SMC protocol message.
  We found that this was caused by the following situations:

  client                  server
          ¦  clc proposal
          ------------->
          ¦  clc accept
          <-------------
          ¦  clc confirm
          ------------->
  wait llc confirm
  			send llc confirm
          ¦failed llc confirm
          ¦   x------
  (after 2s)timeout
                          wait llc confirm rsp

  wait decline

  (after 1s) timeout
                          (after 2s) timeout
          ¦   decline
          -------------->
          ¦   decline
          <--------------

  As a result, a decline message was sent in the implementation, and this
  message was read from TCP by the already-fallback connection.

  This patch double the client timeout as 2x of the server value,
  With this simple change, the Decline messages should never cross or
  collide (during Confirm link timeout).

  This issue requires an immediate solution, since the protocol updates
  involve a more long-term solution.
- Net: usb: ax88179_178a: fix failed operations during ax88179_reset.
  [Jose Ignacio Tornos Martinez]

  [ Upstream commit 0739af07d1d947af27c877f797cb82ceee702515 ]

  Using generic ASIX Electronics Corp. AX88179 Gigabit Ethernet device,
  the following test cycle has been implemented:
      - power on
      - check logs
      - shutdown
      - after detecting the system shutdown, disconnect power
      - after approximately 60 seconds of sleep, power is restored
  Running some cycles, sometimes error logs like this appear:
      kernel: ax88179_178a 2-9:1.0 (unnamed net_device) (uninitialized): Failed to write reg index 0x0001: -19
      kernel: ax88179_178a 2-9:1.0 (unnamed net_device) (uninitialized): Failed to read reg index 0x0001: -19
      ...
  These failed operation are happening during ax88179_reset execution, so
  the initialization could not be correct.

  In order to avoid this, we need to increase the delay after reset and
  clock initial operations. By using these larger values, many cycles
  have been run and no failed operations appear.

  It would be better to check some status register to verify when the
  operation has finished, but I do not have found any available information
  (neither in the public datasheets nor in the manufacturer's driver). The
  only available information for the necessary delays is the maufacturer's
  driver (original values) but the proposed values are not enough for the
  tested devices.
- Ipv4: Correct/silence an endian warning in __ip_do_redirect. [Kunwu
  Chan]

  [ Upstream commit c0e2926266af3b5acf28df0a8fc6e4d90effe0bb ]

  net/ipv4/route.c:783:46: warning: incorrect type in argument 2 (different base types)
  net/ipv4/route.c:783:46:    expected unsigned int [usertype] key
  net/ipv4/route.c:783:46:    got restricted __be32 [usertype] new_gw
- HID: fix HID device resource race between HID core and debugging
  support. [Charles Yi]

  [ Upstream commit fc43e9c857b7aa55efba9398419b14d9e35dcc7d ]

  hid_debug_events_release releases resources bound to the HID device instance.
  hid_device_release releases the underlying HID device instance potentially
  before hid_debug_events_release has completed releasing debug resources bound
  to the same HID device instance.

  Reference count to prevent the HID device instance from being torn down
  preemptively when HID debugging support is used. When count reaches zero,
  release core resources of HID device instance using hiddev_free.

  The crash:

  [  120.728477][ T4396] kernel BUG at lib/list_debug.c:53!
  [  120.728505][ T4396] Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
  [  120.739806][ T4396] Modules linked in: bcmdhd dhd_static_buf 8822cu pcie_mhi r8168
  [  120.747386][ T4396] CPU: 1 PID: 4396 Comm: hidt_bridge Not tainted 5.10.110 #257
  [  120.754771][ T4396] Hardware name: Rockchip RK3588 EVB4 LP4 V10 Board (DT)
  [  120.761643][ T4396] pstate: 60400089 (nZCv daIf +PAN -UAO -TCO BTYPE=--)
  [  120.768338][ T4396] pc : __list_del_entry_valid+0x98/0xac
  [  120.773730][ T4396] lr : __list_del_entry_valid+0x98/0xac
  [  120.779120][ T4396] sp : ffffffc01e62bb60
  [  120.783126][ T4396] x29: ffffffc01e62bb60 x28: ffffff818ce3a200
  [  120.789126][ T4396] x27: 0000000000000009 x26: 0000000000980000
  [  120.795126][ T4396] x25: ffffffc012431000 x24: ffffff802c6d4e00
  [  120.801125][ T4396] x23: ffffff8005c66f00 x22: ffffffc01183b5b8
  [  120.807125][ T4396] x21: ffffff819df2f100 x20: 0000000000000000
  [  120.813124][ T4396] x19: ffffff802c3f0700 x18: ffffffc01d2cd058
  [  120.819124][ T4396] x17: 0000000000000000 x16: 0000000000000000
  [  120.825124][ T4396] x15: 0000000000000004 x14: 0000000000003fff
  [  120.831123][ T4396] x13: ffffffc012085588 x12: 0000000000000003
  [  120.837123][ T4396] x11: 00000000ffffbfff x10: 0000000000000003
  [  120.843123][ T4396] x9 : 455103d46b329300 x8 : 455103d46b329300
  [  120.849124][ T4396] x7 : 74707572726f6320 x6 : ffffffc0124b8cb5
  [  120.855124][ T4396] x5 : ffffffffffffffff x4 : 0000000000000000
  [  120.861123][ T4396] x3 : ffffffc011cf4f90 x2 : ffffff81fee7b948
  [  120.867122][ T4396] x1 : ffffffc011cf4f90 x0 : 0000000000000054
  [  120.873122][ T4396] Call trace:
  [  120.876259][ T4396]  __list_del_entry_valid+0x98/0xac
  [  120.881304][ T4396]  hid_debug_events_release+0x48/0x12c
  [  120.886617][ T4396]  full_proxy_release+0x50/0xbc
  [  120.891323][ T4396]  __fput+0xdc/0x238
  [  120.895075][ T4396]  ____fput+0x14/0x24
  [  120.898911][ T4396]  task_work_run+0x90/0x148
  [  120.903268][ T4396]  do_exit+0x1bc/0x8a4
  [  120.907193][ T4396]  do_group_exit+0x8c/0xa4
  [  120.911458][ T4396]  get_signal+0x468/0x744
  [  120.915643][ T4396]  do_signal+0x84/0x280
  [  120.919650][ T4396]  do_notify_resume+0xd0/0x218
  [  120.924262][ T4396]  work_pending+0xc/0x3f0

  [ Rahul Rameshbabu <sergeantsagara@protonmail.com>: rework changelog ]
- HID: core: store the unique system identifier in hid_device. [Benjamin
  Tissoires]

  [ Upstream commit 1e839143d674603b0bbbc4c513bca35404967dbc ]

  This unique identifier is currently used only for ensuring uniqueness in
  sysfs. However, this could be handful for userspace to refer to a specific
  hid_device by this id.

  2 use cases are in my mind: LEDs (and their naming convention), and
  HID-BPF.
- Drm/rockchip: vop: Fix color for RGB888/BGR888 format on VOP full.
  [Jonas Karlman]

  [ Upstream commit bb0a05acd6121ff0e810b44fdc24dbdfaa46b642 ]

  Use of DRM_FORMAT_RGB888 and DRM_FORMAT_BGR888 on e.g. RK3288, RK3328
  and RK3399 result in wrong colors being displayed.

  The issue can be observed using modetest:

    modetest -s <connector_id>@<crtc_id>:1920x1080-60@RG24
    modetest -s <connector_id>@<crtc_id>:1920x1080-60@BG24

  Vendor 4.4 kernel apply an inverted rb swap for these formats on VOP
  full framework (IP version 3.x) compared to VOP little framework (2.x).

  Fix colors by applying different rb swap for VOP full framework (3.x)
  and VOP little framework (2.x) similar to vendor 4.4 kernel.
- Ata: pata_isapnp: Add missing error check for devm_ioport_map() [Chen
  Ni]

  [ Upstream commit a6925165ea82b7765269ddd8dcad57c731aa00de ]

  Add missing error return check for devm_ioport_map() and return the
  error if this function call fails.
- Wireguard: use DEV_STATS_INC() [Eric Dumazet]

  [ Upstream commit 93da8d75a66568ba4bb5b14ad2833acd7304cd02 ]

  wg_xmit() can be called concurrently, KCSAN reported [1]
  some device stats updates can be lost.

  Use DEV_STATS_INC() for this unlikely case.

  [1]
  BUG: KCSAN: data-race in wg_xmit / wg_xmit

  read-write to 0xffff888104239160 of 8 bytes by task 1375 on cpu 0:
  wg_xmit+0x60f/0x680 drivers/net/wireguard/device.c:231
  __netdev_start_xmit include/linux/netdevice.h:4918 [inline]
  netdev_start_xmit include/linux/netdevice.h:4932 [inline]
  xmit_one net/core/dev.c:3543 [inline]
  dev_hard_start_xmit+0x11b/0x3f0 net/core/dev.c:3559
  ...

  read-write to 0xffff888104239160 of 8 bytes by task 1378 on cpu 1:
  wg_xmit+0x60f/0x680 drivers/net/wireguard/device.c:231
  __netdev_start_xmit include/linux/netdevice.h:4918 [inline]
  netdev_start_xmit include/linux/netdevice.h:4932 [inline]
  xmit_one net/core/dev.c:3543 [inline]
  dev_hard_start_xmit+0x11b/0x3f0 net/core/dev.c:3559
  ...

  v2: also change wg_packet_consume_data_done() (Hangbin Liu)
      and wg_packet_purge_staged_packets()
- Drm/panel: simple: Fix Innolux G101ICE-L01 timings. [Marek Vasut]

  [ Upstream commit 3f9a91b6c00e655d27bd785dcda1742dbdc31bda ]

  The Innolux G101ICE-L01 datasheet [1] page 17 table
  6.1 INPUT SIGNAL TIMING SPECIFICATIONS
  indicates that maximum vertical blanking time is 40 lines.
  Currently the driver uses 29 lines.

  Fix it, and since this panel is a DE panel, adjust the timings
  to make them less hostile to controllers which cannot do 1 px
  HSA/VSA, distribute the delays evenly between all three parts.

  [1] https://www.data-modul.com/sites/default/files/products/G101ICE-L01-C2-specification-12042389.pdf
- Drm/panel: simple: Fix Innolux G101ICE-L01 bus flags. [Marek Vasut]

  [ Upstream commit 06fc41b09cfbc02977acd9189473593a37d82d9b ]

  Add missing .bus_flags = DRM_BUS_FLAG_DE_HIGH to this panel description,
  ones which match both the datasheet and the panel display_timing flags .
- Drm/panel: auo,b101uan08.3: Fine tune the panel power sequence. [Xuxin
  Xiong]

  [ Upstream commit 6965809e526917b73c8f9178173184dcf13cec4b ]

  For "auo,b101uan08.3" this panel, it is stipulated in the panel spec that
  MIPI needs to keep the LP11 state before the lcm_reset pin is pulled high.
- Drm/panel: boe-tv101wum-nl6: Fine tune the panel power sequence.
  [Shuijing Li]

  [ Upstream commit 812562b8d881ce6d33fed8052b3a10b718430fb5 ]

  For "boe,tv105wum-nw0" this special panel, it is stipulated in
  the panel spec that MIPI needs to keep the LP11 state before
  the lcm_reset pin is pulled high.
- Afs: Make error on cell lookup failure consistent with OpenAFS. [David
  Howells]

  [ Upstream commit 2a4ca1b4b77850544408595e2433f5d7811a9daa ]

  When kafs tries to look up a cell in the DNS or the local config, it will
  translate a lookup failure into EDESTADDRREQ whereas OpenAFS translates it
  into ENOENT.  Applications such as West expect the latter behaviour and
  fail if they see the former.

  This can be seen by trying to mount an unknown cell:

     # mount -t afs %example.com:cell.root /mnt
     mount: /mnt: mount(2) system call failed: Destination address required.

  Fixes: 4d673da14533 ("afs: Support the AFS dynamic root")
  Reported-by: Markus Suvanto <markus.suvanto@gmail.com>
  Link: https://bugzilla.kernel.org/show_bug.cgi?id=216637
  Signed-off-by: David Howells <dhowells@redhat.com>
  Reviewed-by: Jeffrey Altman <jaltman@auristor.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- Afs: Fix afs_server_list to be cleaned up with RCU. [David Howells]

  [ Upstream commit e6bace7313d61e31f2b16fa3d774fd8cb3cb869e ]

  afs_server_list is accessed with the rcu_read_lock() held from
  volume->servers, so it needs to be cleaned up correctly.

  Fix this by using kfree_rcu() instead of kfree().

  Fixes: 8a070a964877 ("afs: Detect cell aliases 1 - Cells with root volumes")
  Signed-off-by: David Howells <dhowells@redhat.com>
  cc: Marc Dionne <marc.dionne@auristor.com>
  cc: linux-afs@lists.infradead.org
- PCI: keystone: Drop __init from ks_pcie_add_pcie_{ep,port}() [Nathan
  Chancellor]

  This commit has no upstream equivalent.

  After commit db5ebaeb8fda ("PCI: keystone: Don't discard .probe()
  callback") in 5.10.202, there are two modpost warnings when building with
  clang:

    WARNING: modpost: vmlinux.o(.text+0x5aa6dc): Section mismatch in reference from the function ks_pcie_probe() to the function .init.text:ks_pcie_add_pcie_port()
    The function ks_pcie_probe() references
    the function __init ks_pcie_add_pcie_port().
    This is often because ks_pcie_probe lacks a __init
    annotation or the annotation of ks_pcie_add_pcie_port is wrong.

    WARNING: modpost: vmlinux.o(.text+0x5aa6f4): Section mismatch in reference from the function ks_pcie_probe() to the function .init.text:ks_pcie_add_pcie_ep()
    The function ks_pcie_probe() references
    the function __init ks_pcie_add_pcie_ep().
    This is often because ks_pcie_probe lacks a __init
    annotation or the annotation of ks_pcie_add_pcie_ep is wrong.

  ks_pcie_add_pcie_ep() was removed in upstream commit a0fd361db8e5 ("PCI:
  dwc: Move "dbi", "dbi2", and "addr_space" resource setup into common
  code") and ks_pcie_add_pcie_port() was removed in upstream
  commit 60f5b73fa0f2 ("PCI: dwc: Remove unnecessary wrappers around
  dw_pcie_host_init()"), both of which happened before upstream
  commit 7994db905c0f ("PCI: keystone: Don't discard .probe() callback").

  As neither of these removal changes are really suitable for stable, just
  remove __init from these functions in stable, as it is no longer a
  correct annotation after dropping __init from ks_pcie_probe().
- RDMA/irdma: Prevent zero-length STAG registration. [Christopher
  Bednarz]

  commit bb6d73d9add68ad270888db327514384dfa44958 upstream.

  Currently irdma allows zero-length STAGs to be programmed in HW during
  the kernel mode fast register flow. Zero-length MR or STAG registration
  disable HW memory length checks.

  Improve gaps in bounds checking in irdma by preventing zero-length STAG or
  MR registrations except if the IB_PD_UNSAFE_GLOBAL_RKEY is set.

  This addresses the disclosure CVE-2023-25775.
- Linux 5.10.202. [Greg Kroah-Hartman]
- Interconnect: qcom: Add support for mask-based BCMs. [Mike Tipton]

  commit d8630f050d3fd2079f8617dd6c00c6509109c755 upstream.

  Some BCMs aren't directly associated with the data path (i.e. ACV) and
  therefore don't communicate using BW. Instead, they are simply
  enabled/disabled with a simple bit mask. Add support for these.

  Origin commit retrieved from:
  https://git.codelinaro.org/clo/la/kernel/msm-5.15/-/commit/2d1573e0206998151b342e6b52a4c0f7234d7e36

  Signed-off-by: Mike Tipton <mdtipton@codeaurora.org>
  [narmstrong: removed copyright change from original commit]
- Netfilter: nf_tables: disable toggling dormant table state more than
  once. [Pablo Neira Ayuso]

  commit c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1 upstream.

  nft -f -<<EOF
  add table ip t
  add table ip t { flags dormant; }
  add chain ip t c { type filter hook input priority 0; }
  add table ip t
  EOF

  Triggers a splat from nf core on next table delete because we lose
  track of right hook register state:

  WARNING: CPU: 2 PID: 1597 at net/netfilter/core.c:501 __nf_unregister_net_hook
  RIP: 0010:__nf_unregister_net_hook+0x41b/0x570
   nf_unregister_net_hook+0xb4/0xf0
   __nf_tables_unregister_hook+0x160/0x1d0
  [..]

  The above should have table in *active* state, but in fact no
  hooks were registered.

  Reject on/off/on games rather than attempting to fix this.
- Netfilter: nf_tables: fix table flag updates. [Pablo Neira Ayuso]

  commit 179d9ba5559a756f4322583388b3213fe4e391b0 upstream.

  The dormant flag need to be updated from the preparation phase,
  otherwise, two consecutive requests to dorm a table in the same batch
  might try to remove the same hooks twice, resulting in the following
  warning:

   hook not found, pf 3 num 0
   WARNING: CPU: 0 PID: 334 at net/netfilter/core.c:480 __nf_unregister_net_hook+0x1eb/0x610 net/netfilter/core.c:480
   Modules linked in:
   CPU: 0 PID: 334 Comm: kworker/u4:5 Not tainted 5.12.0-syzkaller #0
   Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
   Workqueue: netns cleanup_net
   RIP: 0010:__nf_unregister_net_hook+0x1eb/0x610 net/netfilter/core.c:480

  This patch is a partial revert of 0ce7cf4127f1 ("netfilter: nftables:
  update table flags from the commit phase") to restore the previous
  behaviour.

  However, there is still another problem: A batch containing a series of
  dorm-wakeup-dorm table and vice-versa also trigger the warning above
  since hook unregistration happens from the preparation phase, while hook
  registration occurs from the commit phase.

  To fix this problem, this patch adds two internal flags to annotate the
  original dormant flag status which are __NFT_TABLE_F_WAS_DORMANT and
  __NFT_TABLE_F_WAS_AWAKEN, to restore it from the abort path.

  The __NFT_TABLE_F_UPDATE bitmask allows to handle the dormant flag update
  with one single transaction.
- Netfilter: nftables: update table flags from the commit phase. [Pablo
  Neira Ayuso]

  commit 0ce7cf4127f14078ca598ba9700d813178a59409 upstream.

  Do not update table flags from the preparation phase. Store the flags
  update into the transaction, then update the flags from the commit
  phase.
- Tracing: Have trace_event_file have ref counters. [Steven Rostedt
  (Google)]

  commit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.

  The following can crash the kernel:

   # cd /sys/kernel/tracing
   # echo 'p:sched schedule' > kprobe_events
   # exec 5>>events/kprobes/sched/enable
   # > kprobe_events
   # exec 5>&-

  The above commands:

   1. Change directory to the tracefs directory
   2. Create a kprobe event (doesn't matter what one)
   3. Open bash file descriptor 5 on the enable file of the kprobe event
   4. Delete the kprobe event (removes the files too)
   5. Close the bash file descriptor 5

  The above causes a crash!

   BUG: kernel NULL pointer dereference, address: 0000000000000028
   #PF: supervisor read access in kernel mode
   #PF: error_code(0x0000) - not-present page
   PGD 0 P4D 0
   Oops: 0000 [#1] PREEMPT SMP PTI
   CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
   Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
   RIP: 0010:tracing_release_file_tr+0xc/0x50

  What happens here is that the kprobe event creates a trace_event_file
  "file" descriptor that represents the file in tracefs to the event. It
  maintains state of the event (is it enabled for the given instance?).
  Opening the "enable" file gets a reference to the event "file" descriptor
  via the open file descriptor. When the kprobe event is deleted, the file is
  also deleted from the tracefs system which also frees the event "file"
  descriptor.

  But as the tracefs file is still opened by user space, it will not be
  totally removed until the final dput() is called on it. But this is not
  true with the event "file" descriptor that is already freed. If the user
  does a write to or simply closes the file descriptor it will reference the
  event "file" descriptor that was just freed, causing a use-after-free bug.

  To solve this, add a ref count to the event "file" descriptor as well as a
  new flag called "FREED". The "file" will not be freed until the last
  reference is released. But the FREE flag will be set when the event is
  removed to prevent any more modifications to that event from happening,
  even if there's still a reference to the event "file" descriptor.
- Io_uring/fdinfo: lock SQ thread while retrieving thread cpu/pid. [Jens
  Axboe]

  commit 7644b1a1c9a7ae8ab99175989bfc8676055edb46 upstream.

  We could race with SQ thread exit, and if we do, we'll hit a NULL pointer
  dereference when the thread is cleared. Grab the SQPOLL data lock before
  attempting to get the task cpu and pid for fdinfo, this ensures we have a
  stable view of it.
- Drm/amd/display: Change the DMCUB mailbox memory location from FB to
  inbox. [Lewis Huang]

  commit 5911d02cac70d7fb52009fbd37423e63f8f6f9bc upstream.

  [WHY]
  Flush command sent to DMCUB spends more time for execution on
  a dGPU than on an APU. This causes cursor lag when using high
  refresh rate mouses.

  [HOW]
  1. Change the DMCUB mailbox memory location from FB to inbox.
  2. Only change windows memory to inbox.
- Drm/amdgpu: fix error handling in amdgpu_bo_list_get() [Christian
  König]

  commit 12f76050d8d4d10dab96333656b821bd4620d103 upstream.

  We should not leak the pointer where we couldn't grab the reference
  on to the caller because it can be that the error handling still
  tries to put the reference then.
- Drm/amd/pm: Handle non-terminated overdrive commands. [Bas
  Nieuwenhuizen]

  commit 08e9ebc75b5bcfec9d226f9e16bab2ab7b25a39a upstream.

  The incoming strings might not be terminated by a newline
  or a 0.

  (found while testing a program that just wrote the string
   itself, causing a crash)
- Ext4: remove gdb backup copy for meta bg in
  setup_new_flex_group_blocks. [Kemeng Shi]

  commit 40dd7953f4d606c280074f10d23046b6812708ce upstream.

  Wrong check of gdb backup in meta bg as following:
  first_group is the first group of meta_bg which contains target group, so
  target group is always >= first_group. We check if target group has gdb
  backup by comparing first_group with [group + 1] and [group +
  EXT4_DESC_PER_BLOCK(sb) - 1]. As group >= first_group, then [group + N] is
  > first_group. So no copy of gdb backup in meta bg is done in
  setup_new_flex_group_blocks.

  No need to do gdb backup copy in meta bg from setup_new_flex_group_blocks
  as we always copy updated gdb block to backups at end of
  ext4_flex_group_add as following:

  ext4_flex_group_add
    /* no gdb backup copy for meta bg any more */
    setup_new_flex_group_blocks

    /* update current group number */
    ext4_update_super
      sbi->s_groups_count += flex_gd->count;

    /*
     * if group in meta bg contains backup is added, the primary gdb block
     * of the meta bg will be copy to backup in new added group here.
     */
    for (; gdb_num <= gdb_num_end; gdb_num++)
      update_backups(...)

  In summary, we can remove wrong gdb backup copy code in
  setup_new_flex_group_blocks.
- Ext4: correct the start block of counting reserved clusters. [Zhang
  Yi]

  commit 40ea98396a3659062267d1fe5f99af4f7e4f05e3 upstream.

  When big allocate feature is enabled, we need to count and update
  reserved clusters before removing a delayed only extent_status entry.
  {init|count|get}_rsvd() have already done this, but the start block
  number of this counting isn't correct in the following case.

    lblk            end
     |               |
     v               v
            -------------------------
            |                       | orig_es
            -------------------------
                     ^              ^
        len1 is 0    |     len2     |

  If the start block of the orig_es entry founded is bigger than lblk, we
  passed lblk as start block to count_rsvd(), but the length is correct,
  finally, the range to be counted is offset. This patch fix this by
  passing the start blocks to 'orig_es->lblk + len1'.
- Ext4: correct return value of ext4_convert_meta_bg. [Kemeng Shi]

  commit 48f1551592c54f7d8e2befc72a99ff4e47f7dca0 upstream.

  Avoid to ignore error in "err".
- Ext4: correct offset of gdb backup in non meta_bg group to
  update_backups. [Kemeng Shi]

  commit 31f13421c004a420c0e9d288859c9ea9259ea0cc upstream.

  Commit 0aeaa2559d6d5 ("ext4: fix corruption when online resizing a 1K
  bigalloc fs") found that primary superblock's offset in its group is
  not equal to offset of backup superblock in its group when block size
  is 1K and bigalloc is enabled. As group descriptor blocks are right
  after superblock, we can't pass block number of gdb to update_backups
  for the same reason.

  The root casue of the issue above is that leading 1K padding block is
  count as data block offset for primary block while backup block has no
  padding block offset in its group.

  Remove padding data block count to fix the issue for gdb backups.

  For meta_bg case, update_backups treat blk_off as block number, do no
  conversion in this case.
- Ext4: apply umask if ACL support is disabled. [Max Kellermann]

  commit 484fd6c1de13b336806a967908a927cc0356e312 upstream.

  The function ext4_init_acl() calls posix_acl_create() which is
  responsible for applying the umask.  But without
  CONFIG_EXT4_FS_POSIX_ACL, ext4_init_acl() is an empty inline function,
  and nobody applies the umask.

  This fixes a bug which causes the umask to be ignored with O_TMPFILE
  on ext4:

   https://github.com/MusicPlayerDaemon/MPD/issues/558
   https://bugs.gentoo.org/show_bug.cgi?id=686142#c3
   https://bugzilla.kernel.org/show_bug.cgi?id=203625
- Revert "net: r8169: Disable multicast filter for RTL8168H and
  RTL8107E" [Heiner Kallweit]

  commit 6a26310273c323380da21eb23fcfd50e31140913 upstream.

  This reverts commit efa5f1311c4998e9e6317c52bc5ee93b3a0f36df.

  I couldn't reproduce the reported issue. What I did, based on a pcap
  packet log provided by the reporter:
  - Used same chip version (RTL8168h)
  - Set MAC address to the one used on the reporters system
  - Replayed the EAPOL unicast packet that, according to the reporter,
    was filtered out by the mc filter.
  The packet was properly received.

  Therefore the root cause of the reported issue seems to be somewhere
  else. Disabling mc filtering completely for the most common chip
  version is a quite big hammer. Therefore revert the change and wait
  for further analysis results from the reporter.
- Media: qcom: camss: Fix vfe_get() error jump. [Bryan O'Donoghue]

  commit 26bda3da00c3edef727a6acb00ed2eb4b22f8723 upstream.

  Right now it is possible to do a vfe_get() with the internal reference
  count at 1. If vfe_check_clock_rates() returns non-zero then we will
  leave the reference count as-is and

  run:
  - pm_runtime_put_sync()
  - vfe->ops->pm_domain_off()

  skip:
  - camss_disable_clocks()

  Subsequent vfe_put() calls will when the ref-count is non-zero
  unconditionally run:

  - pm_runtime_put_sync()
  - vfe->ops->pm_domain_off()
  - camss_disable_clocks()

  vfe_get() should not attempt to roll-back on error when the ref-count is
  non-zero as the upper layers will still do their own vfe_put() operations.

  vfe_put() will drop the reference count and do the necessary power
  domain release, the cleanup jumps in vfe_get() should only be run when
  the ref-count is zero.

  [   50.095796] CPU: 7 PID: 3075 Comm: cam Not tainted 6.3.2+ #80
  [   50.095798] Hardware name: LENOVO 21BXCTO1WW/21BXCTO1WW, BIOS N3HET82W (1.54 ) 05/26/2023
  [   50.095799] pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  [   50.095802] pc : refcount_warn_saturate+0xf4/0x148
  [   50.095804] lr : refcount_warn_saturate+0xf4/0x148
  [   50.095805] sp : ffff80000c7cb8b0
  [   50.095806] x29: ffff80000c7cb8b0 x28: ffff16ecc0e3fc10 x27: 0000000000000000
  [   50.095810] x26: 0000000000000000 x25: 0000000000020802 x24: 0000000000000000
  [   50.095813] x23: ffff16ecc7360640 x22: 00000000ffffffff x21: 0000000000000005
  [   50.095815] x20: ffff16ed175f4400 x19: ffffb4d9852942a8 x18: ffffffffffffffff
  [   50.095818] x17: ffffb4d9852d4a48 x16: ffffb4d983da5db8 x15: ffff80000c7cb320
  [   50.095821] x14: 0000000000000001 x13: 2e656572662d7265 x12: 7466612d65737520
  [   50.095823] x11: 00000000ffffefff x10: ffffb4d9850cebf0 x9 : ffffb4d9835cf954
  [   50.095826] x8 : 0000000000017fe8 x7 : c0000000ffffefff x6 : 0000000000057fa8
  [   50.095829] x5 : ffff16f813fe3d08 x4 : 0000000000000000 x3 : ffff621e8f4d2000
  [   50.095832] x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff16ed32119040
  [   50.095835] Call trace:
  [   50.095836]  refcount_warn_saturate+0xf4/0x148
  [   50.095838]  device_link_put_kref+0x84/0xc8
  [   50.095843]  device_link_del+0x38/0x58
  [   50.095846]  vfe_pm_domain_off+0x3c/0x50 [qcom_camss]
  [   50.095860]  vfe_put+0x114/0x140 [qcom_camss]
  [   50.095869]  csid_set_power+0x2c8/0x408 [qcom_camss]
  [   50.095878]  pipeline_pm_power_one+0x164/0x170 [videodev]
  [   50.095896]  pipeline_pm_power+0xc4/0x110 [videodev]
  [   50.095909]  v4l2_pipeline_pm_use+0x5c/0xa0 [videodev]
  [   50.095923]  v4l2_pipeline_pm_get+0x1c/0x30 [videodev]
  [   50.095937]  video_open+0x7c/0x100 [qcom_camss]
  [   50.095945]  v4l2_open+0x84/0x130 [videodev]
  [   50.095960]  chrdev_open+0xc8/0x250
  [   50.095964]  do_dentry_open+0x1bc/0x498
  [   50.095966]  vfs_open+0x34/0x40
  [   50.095968]  path_openat+0xb44/0xf20
  [   50.095971]  do_filp_open+0xa4/0x160
  [   50.095974]  do_sys_openat2+0xc8/0x188
  [   50.095975]  __arm64_sys_openat+0x6c/0xb8
  [   50.095977]  invoke_syscall+0x50/0x128
  [   50.095982]  el0_svc_common.constprop.0+0x4c/0x100
  [   50.095985]  do_el0_svc+0x40/0xa8
  [   50.095988]  el0_svc+0x2c/0x88
  [   50.095991]  el0t_64_sync_handler+0xf4/0x120
  [   50.095994]  el0t_64_sync+0x190/0x198
  [   50.095996] ---[ end trace 0000000000000000 ]---
- Mm: kmem: drop __GFP_NOFAIL when allocating objcg vectors. [Roman
  Gushchin]

  commit 24948e3b7b12e0031a6edb4f49bbb9fb2ad1e4e9 upstream.

  Objcg vectors attached to slab pages to store slab object ownership
  information are allocated using gfp flags for the original slab
  allocation.  Depending on slab page order and the size of slab objects,
  objcg vector can take several pages.

  If the original allocation was done with the __GFP_NOFAIL flag, it
  triggered a warning in the page allocation code.  Indeed, order > 1 pages
  should not been allocated with the __GFP_NOFAIL flag.

  Fix this by simply dropping the __GFP_NOFAIL flag when allocating the
  objcg vector.  It effectively allows to skip the accounting of a single
  slab object under a heavy memory pressure.

  An alternative would be to implement the mechanism to fallback to order-0
  allocations for accounting metadata, which is also not perfect because it
  will increase performance penalty and memory footprint of the kernel
  memory accounting under memory pressure.
- Nfsd: fix file memleak on client_opens_release. [Mahmoud Adam]

  commit bc1b5acb40201a0746d68a7d7cfc141899937f4f upstream.

  seq_release should be called to free the allocated seq_file
- Media: venus: hfi: add checks to handle capabilities from firmware.
  [Vikash Garodia]

  commit 8d0b89398b7ebc52103e055bf36b60b045f5258f upstream.

  The hfi parser, parses the capabilities received from venus firmware and
  copies them to core capabilities. Consider below api, for example,
  fill_caps - In this api, caps in core structure gets updated with the
  number of capabilities received in firmware data payload. If the same api
  is called multiple times, there is a possibility of copying beyond the max
  allocated size in core caps.
  Similar possibilities in fill_raw_fmts and fill_profile_level functions.
- Media: venus: hfi: fix the check to handle session buffer requirement.
  [Vikash Garodia]

  commit b18e36dfd6c935da60a971310374f3dfec3c82e1 upstream.

  Buffer requirement, for different buffer type, comes from video firmware.
  While copying these requirements, there is an OOB possibility when the
  payload from firmware is more than expected size. Fix the check to avoid
  the OOB possibility.
- Media: venus: hfi_parser: Add check to keep the number of codecs
  within range. [Vikash Garodia]

  commit 0768a9dd809ef52440b5df7dce5a1c1c7e97abbd upstream.

  Supported codec bitmask is populated from the payload from venus firmware.
  There is a possible case when all the bits in the codec bitmask is set. In
  such case, core cap for decoder is filled  and MAX_CODEC_NUM is utilized.
  Now while filling the caps for encoder, it can lead to access the caps
  array beyong 32 index. Hence leading to OOB write.
  The fix counts the supported encoder and decoder. If the count is more than
  max, then it skips accessing the caps.
- Media: sharp: fix sharp encoding. [Sean Young]

  commit 4f7efc71891462ab7606da7039f480d7c1584a13 upstream.

  The Sharp protocol[1] encoding has incorrect timings for bit space.

  [1] https://www.sbprojects.net/knowledge/ir/sharp.php
- Media: lirc: drop trailing space from scancode transmit. [Sean Young]

  commit c8a489f820179fb12251e262b50303c29de991ac upstream.

  When transmitting, infrared drivers expect an odd number of samples; iow
  without a trailing space. No problems have been observed so far, so
  this is just belt and braces.
- F2fs: avoid format-overflow warning. [Su Hui]

  commit e0d4e8acb3789c5a8651061fbab62ca24a45c063 upstream.

  With gcc and W=1 option, there's a warning like this:

  fs/f2fs/compress.c: In function ‘f2fs_init_page_array_cache’:
  fs/f2fs/compress.c:1984:47: error: ‘%u’ directive writing between
  1 and 7 bytes into a region of size between 5 and 8
  [-Werror=format-overflow=]
   1984 |  sprintf(slab_name, "f2fs_page_array_entry-%u:%u", MAJOR(dev),
  		MINOR(dev));
        |                                               ^~

  String "f2fs_page_array_entry-%u:%u" can up to 35. The first "%u" can up
  to 4 and the second "%u" can up to 7, so total size is "24 + 4 + 7 = 35".
  slab_name's size should be 35 rather than 32.
- I2c: i801: fix potential race in i801_block_transaction_byte_by_byte.
  [Heiner Kallweit]

  commit f78ca48a8ba9cdec96e8839351e49eec3233b177 upstream.

  Currently we set SMBHSTCNT_LAST_BYTE only after the host has started
  receiving the last byte. If we get e.g. preempted before setting
  SMBHSTCNT_LAST_BYTE, the host may be finished with receiving the byte
  before SMBHSTCNT_LAST_BYTE is set.
  Therefore change the code to set SMBHSTCNT_LAST_BYTE before writing
  SMBHSTSTS_BYTE_DONE for the byte before the last byte. Now the code
  is also consistent with what we do in i801_isr_byte_done().
- Net: phylink: initialize carrier state at creation. [Klaus Kudielka]

  commit 02d5fdbf4f2b8c406f7a4c98fa52aa181a11d733 upstream.

  Background: Turris Omnia (Armada 385); eth2 (mvneta) connected to SFP bus;
  SFP module is present, but no fiber connected, so definitely no carrier.

  After booting, eth2 is down, but netdev LED trigger surprisingly reports
  link active. Then, after "ip link set eth2 up", the link indicator goes
  away - as I would have expected it from the beginning.

  It turns out, that the default carrier state after netdev creation is
  "carrier ok". Some ethernet drivers explicitly call netif_carrier_off
  during probing, others (like mvneta) don't - which explains the current
  behaviour: only when the device is brought up, phylink_start calls
  netif_carrier_off.

  Fix this for all drivers using phylink, by calling netif_carrier_off in
  phylink_create.
- Net: dsa: lan9303: consequently nested-lock physical MDIO. [Alexander
  Sverdlin]

  commit 5a22fbcc10f3f7d94c5d88afbbffa240a3677057 upstream.

  When LAN9303 is MDIO-connected two callchains exist into
  mdio->bus->write():

  1. switch ports 1&2 ("physical" PHYs):

  virtual (switch-internal) MDIO bus (lan9303_switch_ops->phy_{read|write})->
    lan9303_mdio_phy_{read|write} -> mdiobus_{read|write}_nested

  2. LAN9303 virtual PHY:

  virtual MDIO bus (lan9303_phy_{read|write}) ->
    lan9303_virt_phy_reg_{read|write} -> regmap -> lan9303_mdio_{read|write}

  If the latter functions just take
  mutex_lock(&sw_dev->device->bus->mdio_lock) it triggers a LOCKDEP
  false-positive splat. It's false-positive because the first
  mdio_lock in the second callchain above belongs to virtual MDIO bus, the
  second mdio_lock belongs to physical MDIO bus.

  Consequent annotation in lan9303_mdio_{read|write} as nested lock
  (similar to lan9303_mdio_phy_{read|write}, it's the same physical MDIO bus)
  prevents the following splat:

  WARNING: possible circular locking dependency detected
  5.15.71 #1 Not tainted
  ------------------------------------------------------
  kworker/u4:3/609 is trying to acquire lock:
  ffff000011531c68 (lan9303_mdio:131:(&lan9303_mdio_regmap_config)->lock){+.+.}-{3:3}, at: regmap_lock_mutex
  but task is already holding lock:
  ffff0000114c44d8 (&bus->mdio_lock){+.+.}-{3:3}, at: mdiobus_read
  which lock already depends on the new lock.
  the existing dependency chain (in reverse order) is:
  -> #1 (&bus->mdio_lock){+.+.}-{3:3}:
         lock_acquire
         __mutex_lock
         mutex_lock_nested
         lan9303_mdio_read
         _regmap_read
         regmap_read
         lan9303_probe
         lan9303_mdio_probe
         mdio_probe
         really_probe
         __driver_probe_device
         driver_probe_device
         __device_attach_driver
         bus_for_each_drv
         __device_attach
         device_initial_probe
         bus_probe_device
         deferred_probe_work_func
         process_one_work
         worker_thread
         kthread
         ret_from_fork
  -> #0 (lan9303_mdio:131:(&lan9303_mdio_regmap_config)->lock){+.+.}-{3:3}:
         __lock_acquire
         lock_acquire.part.0
         lock_acquire
         __mutex_lock
         mutex_lock_nested
         regmap_lock_mutex
         regmap_read
         lan9303_phy_read
         dsa_slave_phy_read
         __mdiobus_read
         mdiobus_read
         get_phy_device
         mdiobus_scan
         __mdiobus_register
         dsa_register_switch
         lan9303_probe
         lan9303_mdio_probe
         mdio_probe
         really_probe
         __driver_probe_device
         driver_probe_device
         __device_attach_driver
         bus_for_each_drv
         __device_attach
         device_initial_probe
         bus_probe_device
         deferred_probe_work_func
         process_one_work
         worker_thread
         kthread
         ret_from_fork
  other info that might help us debug this:
   Possible unsafe locking scenario:
         CPU0                    CPU1
         ----                    ----
    lock(&bus->mdio_lock);
                                 lock(lan9303_mdio:131:(&lan9303_mdio_regmap_config)->lock);
                                 lock(&bus->mdio_lock);
    lock(lan9303_mdio:131:(&lan9303_mdio_regmap_config)->lock);
  *** DEADLOCK ***
  5 locks held by kworker/u4:3/609:
   #0: ffff000002842938 ((wq_completion)events_unbound){+.+.}-{0:0}, at: process_one_work
   #1: ffff80000bacbd60 (deferred_probe_work){+.+.}-{0:0}, at: process_one_work
   #2: ffff000007645178 (&dev->mutex){....}-{3:3}, at: __device_attach
   #3: ffff8000096e6e78 (dsa2_mutex){+.+.}-{3:3}, at: dsa_register_switch
   #4: ffff0000114c44d8 (&bus->mdio_lock){+.+.}-{3:3}, at: mdiobus_read
  stack backtrace:
  CPU: 1 PID: 609 Comm: kworker/u4:3 Not tainted 5.15.71 #1
  Workqueue: events_unbound deferred_probe_work_func
  Call trace:
   dump_backtrace
   show_stack
   dump_stack_lvl
   dump_stack
   print_circular_bug
   check_noncircular
   __lock_acquire
   lock_acquire.part.0
   lock_acquire
   __mutex_lock
   mutex_lock_nested
   regmap_lock_mutex
   regmap_read
   lan9303_phy_read
   dsa_slave_phy_read
   __mdiobus_read
   mdiobus_read
   get_phy_device
   mdiobus_scan
   __mdiobus_register
   dsa_register_switch
   lan9303_probe
   lan9303_mdio_probe
  ...
- I2c: designware: Disable TX_EMPTY irq while waiting for block length
  byte. [Tam Nguyen]

  commit e8183fa10c25c7b3c20670bf2b430ddcc1ee03c0 upstream.

  During SMBus block data read process, we have seen high interrupt rate
  because of TX_EMPTY irq status while waiting for block length byte (the
  first data byte after the address phase). The interrupt handler does not
  do anything because the internal state is kept as STATUS_WRITE_IN_PROGRESS.
  Hence, we should disable TX_EMPTY IRQ until I2C DesignWare receives
  first data byte from I2C device, then re-enable it to resume SMBus
  transaction.

  It takes 0.789 ms for host to receive data length from slave.
  Without the patch, i2c_dw_isr() is called 99 times by TX_EMPTY interrupt.
  And it is none after applying the patch.
- Lsm: fix default return value for inode_getsecctx. [Ondrej Mosnacek]

  commit b36995b8609a5a8fe5cf259a1ee768fcaed919f8 upstream.

  -EOPNOTSUPP is the return value that implements a "no-op" hook, not 0.

  Without this fix having only the BPF LSM enabled (with no programs
  attached) can cause uninitialized variable reads in
  nfsd4_encode_fattr(), because the BPF hook returns 0 without touching
  the 'ctxlen' variable and the corresponding 'contextlen' variable in
  nfsd4_encode_fattr() remains uninitialized, yet being treated as valid
  based on the 0 return value.
- Lsm: fix default return value for vm_enough_memory. [Ondrej Mosnacek]

  commit 866d648059d5faf53f1cd960b43fe8365ad93ea7 upstream.

  1 is the return value that implements a "no-op" hook, not 0.
- Revert ncsi: Propagate carrier gain/loss events to the NCSI
  controller. [Johnathan Mantey]

  commit 9e2e7efbbbff69d8340abb56d375dd79d1f5770f upstream.

  This reverts commit 3780bb29311eccb7a1c9641032a112eed237f7e3.

  The cited commit introduced unwanted behavior.

  The intent for the commit was to be able to detect carrier loss/gain
  for just the NIC connected to the BMC. The unwanted effect is a
  carrier loss for auxiliary paths also causes the BMC to lose
  carrier. The BMC never regains carrier despite the secondary NIC
  regaining a link.

  This change, when merged, needs to be backported to stable kernels.
  5.4-stable, 5.10-stable, 5.15-stable, 6.1-stable, 6.5-stable
- Arm64: dts: qcom: ipq6018: Fix tcsr_mutex register size. [Vignesh
  Viswanathan]

  [ Upstream commit 72fc3d58b87b0d622039c6299b89024fbb7b420f ]

  IPQ6018's TCSR Mutex HW lock register has 32 locks of size 4KB each.
  Total size of the TCSR Mutex registers is 128KB.

  Fix size of the tcsr_mutex hwlock register to 0x20000.

  Changes in v2:
   - Drop change to remove qcom,ipq6018-tcsr-mutex compatible string
   - Added Fixes and stable tags
- Arm64: dts: qcom: ipq6018: switch TCSR mutex to MMIO. [Krzysztof
  Kozlowski]

  [ Upstream commit f5e303aefc06b7508d7a490f9a2d80e4dc134c70 ]

  The TCSR mutex bindings allow device to be described only with address
  space (so it uses MMIO, not syscon regmap).  This seems reasonable as
  TCSR mutex is actually a dedicated IO address space and it also fixes DT
  schema checks:

    qcom/ipq6018-cp01-c1.dtb: hwlock: 'reg' is a required property
    qcom/ipq6018-cp01-c1.dtb: hwlock: 'syscon' does not match any of the regexes: 'pinctrl-[0-9]+'
- PCI: exynos: Don't discard .remove() callback. [Uwe Kleine-König]

  [ Upstream commit 83a939f0fdc208ff3639dd3d42ac9b3c35607fd2 ]

  With CONFIG_PCI_EXYNOS=y and exynos_pcie_remove() marked with __exit, the
  function is discarded from the driver. In this case a bound device can
  still get unbound, e.g via sysfs. Then no cleanup code is run resulting in
  resource leaks or worse.

  The right thing to do is do always have the remove callback available.
  This fixes the following warning by modpost:

    WARNING: modpost: drivers/pci/controller/dwc/pci-exynos: section mismatch in reference: exynos_pcie_driver+0x8 (section: .data) -> exynos_pcie_remove (section: .exit.text)

  (with ARCH=x86_64 W=1 allmodconfig).
- Bluetooth: btusb: Add 0bda:b85b for Fn-Link RTL8852BE. [Guan Wentao]

  [ Upstream commit da06ff1f585ea784c79f80e7fab0e0c4ebb49c1c ]

  Add PID/VID 0bda:b85b for Realtek RTL8852BE USB bluetooth part.
  The PID/VID was reported by the patch last year. [1]
  Some SBCs like rockpi 5B A8 module contains the device.
  And it`s founded in website. [2] [3]

  Here is the device tables in /sys/kernel/debug/usb/devices .

  T:  Bus=07 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  2 Spd=12   MxCh= 0
  D:  Ver= 1.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=0bda ProdID=b85b Rev= 0.00
  S:  Manufacturer=Realtek
  S:  Product=Bluetooth Radio
  S:  SerialNumber=00e04c000001
  C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
- Bluetooth: btusb: Add RTW8852BE device 13d3:3570 to device tables.
  [Masum Reza]

  [ Upstream commit 02be109d3a405dbc4d53fb4b4473d7a113548088 ]

  This device is used in TP-Link TX20E WiFi+Bluetooth adapter.

  Relevant information in /sys/kernel/debug/usb/devices
  about the Bluetooth device is listed as the below.

  T:  Bus=01 Lev=01 Prnt=01 Port=08 Cnt=01 Dev#=  2 Spd=12   MxCh= 0
  D:  Ver= 1.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=13d3 ProdID=3570 Rev= 0.00
  S:  Manufacturer=Realtek
  S:  Product=Bluetooth Radio
  S:  SerialNumber=00e04c000001
  C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
- Bluetooth: Add device 13d3:3571 to device tables. [Larry Finger]

  [ Upstream commit 069f534247bb6db4f8c2c2ea8e9155abf495c37e ]

  This device is part of a Realtek RTW8852BE chip. The device table is as follows:

  T:  Bus=03 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  2 Spd=12   MxCh= 0
  D:  Ver= 1.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=13d3 ProdID=3571 Rev= 0.00
  S:  Manufacturer=Realtek
  S:  Product=Bluetooth Radio
  S:  SerialNumber=00e04c000001
  C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
- Bluetooth: Add device 0bda:887b to device tables. [Larry Finger]

  [ Upstream commit 730a1d1a93a3e30c3723f87af97a8517334b2203 ]

  This device is part of a Realtek RTW8852BE chip.

  The device table entry is as follows:

  T:  Bus=03 Lev=01 Prnt=01 Port=12 Cnt=02 Dev#=  3 Spd=12   MxCh= 0
  D:  Ver= 1.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=0bda ProdID=887b Rev= 0.00
  S:  Manufacturer=Realtek
  S:  Product=Bluetooth Radio
  S:  SerialNumber=00e04c000001
  C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
- Bluetooth: btusb: Add Realtek RTL8852BE support ID 0x0cb8:0xc559.
  [Artem Lukyanov]

  [ Upstream commit 393b4916b7b5b94faf5c6a7c68df1c62d17e4f38 ]

  Add the support ID(0x0cb8, 0xc559) to usb_device_id table for
  Realtek RTL8852BE.

  The device info from /sys/kernel/debug/usb/devices as below.

  T:  Bus=03 Lev=01 Prnt=01 Port=02 Cnt=01 Dev#=  2 Spd=12   MxCh= 0
  D:  Ver= 1.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=0cb8 ProdID=c559 Rev= 0.00
  S:  Manufacturer=Realtek
  S:  Product=Bluetooth Radio
  S:  SerialNumber=00e04c000001
  C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
  E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
  I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
  I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
  I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
  I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
  I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
  I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
  E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
  E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
- Cpufreq: stats: Fix buffer overflow detection in trans_stats()
  [Christian Marangi]

  [ Upstream commit ea167a7fc2426f7685c3735e104921c1a20a6d3f ]

  Commit 3c0897c180c6 ("cpufreq: Use scnprintf() for avoiding potential
  buffer overflow") switched from snprintf to the more secure scnprintf
  but never updated the exit condition for PAGE_SIZE.

  As the commit say and as scnprintf document, what scnprintf returns what
  is actually written not counting the '\0' end char. This results in the
  case of len exceeding the size, len set to PAGE_SIZE - 1, as it can be
  written at max PAGE_SIZE - 1 (as '\0' is not counted)

  Because of len is never set to PAGE_SIZE, the function never break early,
  never prints the warning and never return -EFBIG.

  Fix this by changing the condition to PAGE_SIZE - 1 to correctly trigger
  the error.

  Cc: 5.10+ <stable@vger.kernel.org> # 5.10+
  Fixes: 3c0897c180c6 ("cpufreq: Use scnprintf() for avoiding potential buffer overflow")
  Signed-off-by: Christian Marangi <ansuelsmth@gmail.com>
  [ rjw: Subject and changelog edits ]
- Tty: serial: meson: fix hard LOCKUP on crtscts mode. [Pavel Krasavin]

  [ Upstream commit 2a1d728f20edeee7f26dc307ed9df4e0d23947ab ]

  There might be hard lockup if we set crtscts mode on port without RTS/CTS configured:

  # stty -F /dev/ttyAML6 crtscts; echo 1 > /dev/ttyAML6; echo 2 > /dev/ttyAML6
  [   95.890386] rcu: INFO: rcu_preempt detected stalls on CPUs/tasks:
  [   95.890857] rcu:     3-...0: (201 ticks this GP) idle=e33c/1/0x4000000000000000 softirq=5844/5846 fqs=4984
  [   95.900212] rcu:     (detected by 2, t=21016 jiffies, g=7753, q=296 ncpus=4)
  [   95.906972] Task dump for CPU 3:
  [   95.910178] task:bash            state:R  running task     stack:0     pid:205   ppid:1      flags:0x00000202
  [   95.920059] Call trace:
  [   95.922485]  __switch_to+0xe4/0x168
  [   95.925951]  0xffffff8003477508
  [   95.974379] watchdog: Watchdog detected hard LOCKUP on cpu 3
  [   95.974424] Modules linked in: 88x2cs(O) rtc_meson_vrtc

  Possible solution would be to not allow to setup crtscts on such port.

  Tested on S905X3 based board.

  Fixes: ff7693d079e5 ("ARM: meson: serial: add MesonX SoC on-chip uart driver")
  Cc: stable@vger.kernel.org
  Signed-off-by: Pavel Krasavin <pkrasavin@imaqliq.com>
  Reviewed-by: Neil Armstrong <neil.armstrong@linaro.org>
  Reviewed-by: Dmitry Rokosov <ddrokosov@salutedevices.com>

  v6: stable tag added
  v5: https://lore.kernel.org/lkml/OF43DA36FF.2BD3BB21-ON00258A47.005A8125-00258A47.005A9513@gdc.ru/
  added missed Reviewed-by tags, Fixes tag added according to Dmitry and Neil notes
  v4: https://lore.kernel.org/lkml/OF55521400.7512350F-ON00258A47.003F7254-00258A47.0040E15C@gdc.ru/
  More correct patch subject according to Jiri's note
  v3: https://lore.kernel.org/lkml/OF6CF5FFA0.CCFD0E8E-ON00258A46.00549EDF-00258A46.0054BB62@gdc.ru/
  "From:" line added to the mail
  v2: https://lore.kernel.org/lkml/OF950BEF72.7F425944-ON00258A46.00488A76-00258A46.00497D44@gdc.ru/
  braces for single statement removed according to Dmitry's note
  v1: https://lore.kernel.org/lkml/OF28B2B8C9.5BC0CD28-ON00258A46.0037688F-00258A46.0039155B@gdc.ru/
- Serial: meson: Use platform_get_irq() to get the interrupt. [Lad
  Prabhakar]

  [ Upstream commit 5b68061983471470d4109bac776145245f06bc09 ]

  platform_get_resource(pdev, IORESOURCE_IRQ, ..) relies on static
  allocation of IRQ resources in DT core code, this causes an issue
  when using hierarchical interrupt domains using "interrupts" property
  in the node as this bypasses the hierarchical setup and messes up the
  irq chaining.

  In preparation for removal of static setup of IRQ resource from DT core
  code use platform_get_irq().
- Tty: serial: meson: retrieve port FIFO size from DT. [Neil Armstrong]

  [ Upstream commit 27d44e05d7b85d9d4cfe0a3c0663ea49752ece93 ]

  Now the DT bindings has a property to get the FIFO size for a particular port,
  retrieve it and use to setup the FIFO interrupts threshold.
- Serial: meson: remove redundant initialization of variable id. [Colin
  Ian King]

  [ Upstream commit 021212f5335229ed12e3d31f9b7d30bd3bb66f7d ]

  The variable id being initialized with a value that is never read
  and it is being updated later with a new value. The initialization is
  redundant and can be removed. Since id is just being used in a for-loop
  inside a local scope, move the declaration of id to that scope.
- ALSA: hda/realtek - Enable internal speaker of ASUS K6500ZC.
  [Chandradeep Dey]

  commit 713f040cd22285fcc506f40a0d259566e6758c3c upstream.

  Apply the already existing quirk chain ALC294_FIXUP_ASUS_SPK to enable
  the internal speaker of ASUS K6500ZC.
- ALSA: hda/realtek - Add Dell ALC295 to pin fall back table. [Kailang
  Yang]

  commit 4b21a669ca21ed8f24ef4530b2918be5730114de upstream.

  Add ALC295 to pin fall back table.
  Remove 5 pin quirks for Dell ALC295.
  ALC295 was only support MIC2 for external MIC function.
  ALC295 assigned model "ALC269_FIXUP_DELL1_MIC_NO_PRESENCE" for pin
  fall back table.
  It was assigned wrong model. So, let's remove it.
- ALSA: info: Fix potential deadlock at disconnection. [Takashi Iwai]

  commit c7a60651953359f98dbf24b43e1bf561e1573ed4 upstream.

  As reported recently, ALSA core info helper may cause a deadlock at
  the forced device disconnection during the procfs operation.

  The proc_remove() (that is called from the snd_card_disconnect()
  helper) has a synchronization of the pending procfs accesses via
  wait_for_completion().  Meanwhile, ALSA procfs helper takes the global
  mutex_lock(&info_mutex) at both the proc_open callback and
  snd_card_info_disconnect() helper.  Since the proc_open can't finish
  due to the mutex lock, wait_for_completion() never returns, either,
  hence it deadlocks.

  	TASK#1				TASK#2
  	proc_reg_open()
  	  takes use_pde()
  	snd_info_text_entry_open()
  					snd_card_disconnect()
  					snd_info_card_disconnect()
  					  takes mutex_lock(&info_mutex)
  					proc_remove()
  					wait_for_completion(unused_pde)
  					  ... waiting task#1 closes
  	mutex_lock(&info_mutex)
  		=> DEADLOCK

  This patch is a workaround for avoiding the deadlock scenario above.

  The basic strategy is to move proc_remove() call outside the mutex
  lock.  proc_remove() can work gracefully without extra locking, and it
  can delete the tree recursively alone.  So, we call proc_remove() at
  snd_info_card_disconnection() at first, then delete the rest resources
  recursively within the info_mutex lock.

  After the change, the function snd_info_disconnect() doesn't do
  disconnection by itself any longer, but it merely clears the procfs
  pointer.  So rename the function to snd_info_clear_entries() for
  avoiding confusion.

  The similar change is applied to snd_info_free_entry(), too.  Since
  the proc_remove() is called only conditionally with the non-NULL
  entry->p, it's skipped after the snd_info_clear_entries() call.
- Xhci: Enable RPM on controllers that support low-power states.
  [Basavaraj Natikar]

  commit a5d6264b638efeca35eff72177fd28d149e0764b upstream.

  Use the low-power states of the underlying platform to enable runtime PM.
  If the platform doesn't support runtime D3, then enabling default RPM will
  result in the controller malfunctioning, as in the case of hotplug devices
  not being detected because of a failed interrupt generation.
- Parisc/pgtable: Do not drop upper 5 address bits of physical address.
  [Helge Deller]

  commit 166b0110d1ee53290bd11618df6e3991c117495a upstream.

  When calculating the pfn for the iitlbt/idtlbt instruction, do not
  drop the upper 5 address bits. This doesn't seem to have an effect
  on physical hardware which uses less physical address bits, but in
  qemu the missing bits are visible.
- Parisc: Prevent booting 64-bit kernels on PA1.x machines. [Helge
  Deller]

  commit a406b8b424fa01f244c1aab02ba186258448c36b upstream.

  Bail out early with error message when trying to boot a 64-bit kernel on
  32-bit machines. This fixes the previous commit to include the check for
  true 64-bit kernels as well.
- I3c: master: cdns: Fix reading status register. [Joshua Yeong]

  commit 4bd8405257da717cd556f99e5fb68693d12c9766 upstream.

  IBIR_DEPTH and CMDR_DEPTH should read from status0 instead of status1.
- Mtd: cfi_cmdset_0001: Byte swap OTP info. [Linus Walleij]

  commit 565fe150624ee77dc63a735cc1b3bff5101f38a3 upstream.

  Currently the offset into the device when looking for OTP
  bits can go outside of the address of the MTD NOR devices,
  and if that memory isn't readable, bad things happen
  on the IXP4xx (added prints that illustrate the problem before
  the crash):

  cfi_intelext_otp_walk walk OTP on chip 0 start at reg_prot_offset 0x00000100
  ixp4xx_copy_from copy from 0x00000100 to 0xc880dd78
  cfi_intelext_otp_walk walk OTP on chip 0 start at reg_prot_offset 0x12000000
  ixp4xx_copy_from copy from 0x12000000 to 0xc880dd78
  8<--- cut here ---
  Unable to handle kernel paging request at virtual address db000000
  [db000000] *pgd=00000000
  (...)

  This happens in this case because the IXP4xx is big endian and
  the 32- and 16-bit fields in the struct cfi_intelext_otpinfo are not
  properly byteswapped. Compare to how the code in read_pri_intelext()
  byteswaps the fields in struct cfi_pri_intelext.

  Adding a small byte swapping loop for the OTP in read_pri_intelext()
  and the crash goes away.

  The problem went unnoticed for many years until I enabled
  CONFIG_MTD_OTP on the IXP4xx as well, triggering the bug.
- Mm/memory_hotplug: use pfn math in place of direct struct page
  manipulation. [Zi Yan]

  commit 1640a0ef80f6d572725f5b0330038c18e98ea168 upstream.

  When dealing with hugetlb pages, manipulating struct page pointers
  directly can get to wrong struct page, since struct page is not guaranteed
  to be contiguous on SPARSEMEM without VMEMMAP.  Use pfn calculation to
  handle it properly.

  Without the fix, a wrong number of page might be skipped. Since skip cannot be
  negative, scan_movable_page() will end early and might miss a movable page with
  -ENOENT. This might fail offline_pages(). No bug is reported. The fix comes
  from code inspection.
- Mm/cma: use nth_page() in place of direct struct page manipulation.
  [Zi Yan]

  commit 2e7cfe5cd5b6b0b98abf57a3074885979e187c1c upstream.

  Patch series "Use nth_page() in place of direct struct page manipulation",
  v3.

  On SPARSEMEM without VMEMMAP, struct page is not guaranteed to be
  contiguous, since each memory section's memmap might be allocated
  independently.  hugetlb pages can go beyond a memory section size, thus
  direct struct page manipulation on hugetlb pages/subpages might give wrong
  struct page.  Kernel provides nth_page() to do the manipulation properly.
  Use that whenever code can see hugetlb pages.


  This patch (of 5):

  When dealing with hugetlb pages, manipulating struct page pointers
  directly can get to wrong struct page, since struct page is not guaranteed
  to be contiguous on SPARSEMEM without VMEMMAP.  Use nth_page() to handle
  it properly.

  Without the fix, page_kasan_tag_reset() could reset wrong page tags,
  causing a wrong kasan result.  No related bug is reported.  The fix
  comes from code inspection.
- Dmaengine: stm32-mdma: correct desc prep when channel running. [Alain
  Volmat]

  commit 03f25d53b145bc2f7ccc82fc04e4482ed734f524 upstream.

  In case of the prep descriptor while the channel is already running, the
  CCR register value stored into the channel could already have its EN bit
  set.  This would lead to a bad transfer since, at start transfer time,
  enabling the channel while other registers aren't yet properly set.
  To avoid this, ensure to mask the CCR_EN bit when storing the ccr value
  into the mdma channel structure.
- Mcb: fix error handling for different scenarios when parsing. [Sanjuán
  García, Jorge]

  commit 63ba2d07b4be72b94216d20561f43e1150b25d98 upstream.

  chameleon_parse_gdd() may fail for different reasons and end up
  in the err tag. Make sure we at least always free the mcb_device
  allocated with mcb_alloc_dev().

  If mcb_device_register() fails, make sure to give up the reference
  in the same place the device was added.
- I2c: core: Run atomic i2c xfer when !preemptible. [Benjamin Bara]

  commit aa49c90894d06e18a1ee7c095edbd2f37c232d02 upstream.

  Since bae1d3a05a8b, i2c transfers are non-atomic if preemption is
  disabled. However, non-atomic i2c transfers require preemption (e.g. in
  wait_for_completion() while waiting for the DMA).

  panic() calls preempt_disable_notrace() before calling
  emergency_restart(). Therefore, if an i2c device is used for the
  restart, the xfer should be atomic. This avoids warnings like:

  [   12.667612] WARNING: CPU: 1 PID: 1 at kernel/rcu/tree_plugin.h:318 rcu_note_context_switch+0x33c/0x6b0
  [   12.676926] Voluntary context switch within RCU read-side critical section!
  ...
  [   12.742376]  schedule_timeout from wait_for_completion_timeout+0x90/0x114
  [   12.749179]  wait_for_completion_timeout from tegra_i2c_wait_completion+0x40/0x70
  ...
  [   12.994527]  atomic_notifier_call_chain from machine_restart+0x34/0x58
  [   13.001050]  machine_restart from panic+0x2a8/0x32c

  Use !preemptible() instead, which is basically the same check as
  pre-v5.2.
- Kernel/reboot: emergency_restart: Set correct system_state. [Benjamin
  Bara]

  commit 60466c067927abbcaff299845abd4b7069963139 upstream.

  As the emergency restart does not call kernel_restart_prepare(), the
  system_state stays in SYSTEM_RUNNING.

  Since bae1d3a05a8b, this hinders i2c_in_atomic_xfer_mode() from becoming
  active, and therefore might lead to avoidable warnings in the restart
  handlers, e.g.:

  [   12.667612] WARNING: CPU: 1 PID: 1 at kernel/rcu/tree_plugin.h:318 rcu_note_context_switch+0x33c/0x6b0
  [   12.676926] Voluntary context switch within RCU read-side critical section!
  ...
  [   12.742376]  schedule_timeout from wait_for_completion_timeout+0x90/0x114
  [   12.749179]  wait_for_completion_timeout from tegra_i2c_wait_completion+0x40/0x70
  ...
  [   12.994527]  atomic_notifier_call_chain from machine_restart+0x34/0x58
  [   13.001050]  machine_restart from panic+0x2a8/0x32c

  Avoid these by setting the correct system_state.
- Quota: explicitly forbid quota files from being encrypted. [Eric
  Biggers]

  commit d3cc1b0be258191d6360c82ea158c2972f8d3991 upstream.

  Since commit d7e7b9af104c ("fscrypt: stop using keyrings subsystem for
  fscrypt_master_key"), xfstest generic/270 causes a WARNING when run on
  f2fs with test_dummy_encryption in the mount options:

  $ kvm-xfstests -c f2fs/encrypt generic/270
  [...]
  WARNING: CPU: 1 PID: 2453 at fs/crypto/keyring.c:240 fscrypt_destroy_keyring+0x1f5/0x260

  The cause of the WARNING is that not all encrypted inodes have been
  evicted before fscrypt_destroy_keyring() is called, which violates an
  assumption.  This happens because the test uses an external quota file,
  which gets automatically encrypted due to test_dummy_encryption.

  Encryption of quota files has never really been supported.  On ext4,
  ext4_quota_read() does not decrypt the data, so encrypted quota files
  are always considered invalid on ext4.  On f2fs, f2fs_quota_read() uses
  the pagecache, so trying to use an encrypted quota file gets farther,
  resulting in the issue described above being possible.  But this was
  never intended to be possible, and there is no use case for it.

  Therefore, make the quota support layer explicitly reject using
  IS_ENCRYPTED inodes when quotaon is attempted.
- Jbd2: fix potential data lost in recovering journal raced with
  synchronizing fs bdev. [Zhihao Cheng]

  commit 61187fce8600e8ef90e601be84f9d0f3222c1206 upstream.

  JBD2 makes sure journal data is fallen on fs device by sync_blockdev(),
  however, other process could intercept the EIO information from bdev's
  mapping, which leads journal recovering successful even EIO occurs during
  data written back to fs device.

  We found this problem in our product, iscsi + multipath is chosen for block
  device of ext4. Unstable network may trigger kpartx to rescan partitions in
  device mapper layer. Detailed process is shown as following:

    mount          kpartx          irq
  jbd2_journal_recover
   do_one_pass
    memcpy(nbh->b_data, obh->b_data) // copy data to fs dev from journal
    mark_buffer_dirty // mark bh dirty
           vfs_read
  	  generic_file_read_iter // dio
  	   filemap_write_and_wait_range
  	    __filemap_fdatawrite_range
  	     do_writepages
  	      block_write_full_folio
  	       submit_bh_wbc
  	            >>  EIO occurs in disk  <<
  	                     end_buffer_async_write
  			      mark_buffer_write_io_error
  			       mapping_set_error
  			        set_bit(AS_EIO, &mapping->flags) // set!
  	    filemap_check_errors
  	     test_and_clear_bit(AS_EIO, &mapping->flags) // clear!
   err2 = sync_blockdev
    filemap_write_and_wait
     filemap_check_errors
      test_and_clear_bit(AS_EIO, &mapping->flags) // false
   err2 = 0

  Filesystem is mounted successfully even data from journal is failed written
  into disk, and ext4/ocfs2 could become corrupted.

  Fix it by comparing the wb_err state in fs block device before recovering
  and after recovering.

  A reproducer can be found in the kernel bugzilla referenced below.
- PCI: keystone: Don't discard .probe() callback. [Uwe Kleine-König]

  commit 7994db905c0fd692cf04c527585f08a91b560144 upstream.

  The __init annotation makes the ks_pcie_probe() function disappear after
  booting completes. However a device can also be bound later. In that case,
  we try to call ks_pcie_probe(), but the backing memory is likely already
  overwritten.

  The right thing to do is do always have the probe callback available.  Note
  that the (wrong) __refdata annotation prevented this issue to be noticed by
  modpost.
- PCI: keystone: Don't discard .remove() callback. [Uwe Kleine-König]

  commit 200bddbb3f5202bbce96444fdc416305de14f547 upstream.

  With CONFIG_PCIE_KEYSTONE=y and ks_pcie_remove() marked with __exit, the
  function is discarded from the driver. In this case a bound device can
  still get unbound, e.g via sysfs. Then no cleanup code is run resulting in
  resource leaks or worse.

  The right thing to do is do always have the remove callback available.
  Note that this driver cannot be compiled as a module, so ks_pcie_remove()
  was always discarded before this change and modpost couldn't warn about
  this issue. Furthermore the __ref annotation also prevents a warning.
- Genirq/generic_chip: Make irq_remove_generic_chip() irqdomain aware.
  [Herve Codina]

  commit 5e7afb2eb7b2a7c81e9f608cbdf74a07606fd1b5 upstream.

  irq_remove_generic_chip() calculates the Linux interrupt number for removing the
  handler and interrupt chip based on gc::irq_base as a linear function of
  the bit positions of set bits in the @msk argument.

  When the generic chip is present in an irq domain, i.e. created with a call
  to irq_alloc_domain_generic_chips(), gc::irq_base contains not the base
  Linux interrupt number.  It contains the base hardware interrupt for this
  chip. It is set to 0 for the first chip in the domain, 0 + N for the next
  chip, where $N is the number of hardware interrupts per chip.

  That means the Linux interrupt number cannot be calculated based on
  gc::irq_base for irqdomain based chips without a domain map lookup, which
  is currently missing.

  Rework the code to take the irqdomain case into account and calculate the
  Linux interrupt number by a irqdomain lookup of the domain specific
  hardware interrupt number.

  [ tglx: Massage changelog. Reshuffle the logic and add a proper comment. ]
- Mmc: meson-gx: Remove setting of CMD_CFG_ERROR. [Rong Chen]

  commit 57925e16c9f7d18012bcf45bfa658f92c087981a upstream.

  For the t7 and older SoC families, the CMD_CFG_ERROR has no effect.
  Starting from SoC family C3, setting this bit without SG LINK data
  address will cause the controller to generate an IRQ and stop working.

  To fix it, don't set the bit CMD_CFG_ERROR anymore.
- Wifi: ath11k: fix htt pktlog locking. [Johan Hovold]

  commit 3f77c7d605b29df277d77e9ee75d96e7ad145d2d upstream.

  The ath11k active pdevs are protected by RCU but the htt pktlog handling
  code calling ath11k_mac_get_ar_by_pdev_id() was not marked as a
  read-side critical section.

  Mark the code in question as an RCU read-side critical section to avoid
  any potential use-after-free issues.

  Compile tested only.
- Wifi: ath11k: fix dfs radar event locking. [Johan Hovold]

  commit 3b6c14833165f689cc5928574ebafe52bbce5f1e upstream.

  The ath11k active pdevs are protected by RCU but the DFS radar event
  handling code calling ath11k_mac_get_ar_by_pdev_id() was not marked as a
  read-side critical section.

  Mark the code in question as an RCU read-side critical section to avoid
  any potential use-after-free issues.

  Compile tested only.
- Wifi: ath11k: fix temperature event locking. [Johan Hovold]

  commit 1a5352a81b4720ba43d9c899974e3bddf7ce0ce8 upstream.

  The ath11k active pdevs are protected by RCU but the temperature event
  handling code calling ath11k_mac_get_ar_by_pdev_id() was not marked as a
  read-side critical section as reported by RCU lockdep:

  	=============================
  	WARNING: suspicious RCU usage
  	6.6.0-rc6 #7 Not tainted
  	-----------------------------
  	drivers/net/wireless/ath/ath11k/mac.c:638 suspicious rcu_dereference_check() usage!

  	other info that might help us debug this:

  	rcu_scheduler_active = 2, debug_locks = 1
  	no locks held by swapper/0/0.
  	...
  	Call trace:
  	...
  	 lockdep_rcu_suspicious+0x16c/0x22c
  	 ath11k_mac_get_ar_by_pdev_id+0x194/0x1b0 [ath11k]
  	 ath11k_wmi_tlv_op_rx+0xa84/0x2c1c [ath11k]
  	 ath11k_htc_rx_completion_handler+0x388/0x510 [ath11k]

  Mark the code in question as an RCU read-side critical section to avoid
  any potential use-after-free issues.
- Ima: detect changes to the backing overlay file. [Mimi Zohar]

  commit b836c4d29f2744200b2af41e14bf50758dddc818 upstream.

  Commit 18b44bc5a672 ("ovl: Always reevaluate the file signature for
  IMA") forced signature re-evaulation on every file access.

  Instead of always re-evaluating the file's integrity, detect a change
  to the backing file, by comparing the cached file metadata with the
  backing file's metadata.  Verifying just the i_version has not changed
  is insufficient.  In addition save and compare the i_ino and s_dev
  as well.
- Firmware: qcom_scm: use 64-bit calling convention only when client is
  64-bit. [Kathiravan Thirumoorthy]

  commit 3337a6fea25370d3d244ec6bb38c71ee86fcf837 upstream.

  Per the "SMC calling convention specification", the 64-bit calling
  convention can only be used when the client is 64-bit. Whereas the
  32-bit calling convention can be used by either a 32-bit or a 64-bit
  client.

  Currently during SCM probe, irrespective of the client, 64-bit calling
  convention is made, which is incorrect and may lead to the undefined
  behaviour when the client is 32-bit. Let's fix it.
- Btrfs: don't arbitrarily slow down delalloc if we're committing.
  [Josef Bacik]

  commit 11aeb97b45ad2e0040cbb2a589bc403152526345 upstream.

  We have a random schedule_timeout() if the current transaction is
  committing, which seems to be a holdover from the original delalloc
  reservation code.

  Remove this, we have the proper flushing stuff, we shouldn't be hoping
  for random timing things to make everything work.  This just induces
  latency for no reason.
- Rcu: kmemleak: Ignore kmemleak false positives when RCU-freeing
  objects. [Catalin Marinas]

  commit 5f98fd034ca6fd1ab8c91a3488968a0e9caaabf6 upstream.

  Since the actual slab freeing is deferred when calling kvfree_rcu(), so
  is the kmemleak_free() callback informing kmemleak of the object
  deletion. From the perspective of the kvfree_rcu() caller, the object is
  freed and it may remove any references to it. Since kmemleak does not
  scan RCU internal data storing the pointer, it will report such objects
  as leaks during the grace period.

  Tell kmemleak to ignore such objects on the kvfree_call_rcu() path. Note
  that the tiny RCU implementation does not have such issue since the
  objects can be tracked from the rcu_ctrlblk structure.
- PM: hibernate: Clean up sync_read handling in snapshot_write_next()
  [Brian Geffon]

  commit d08970df1980476f27936e24d452550f3e9e92e1 upstream.

  In snapshot_write_next(), sync_read is set and unset in three different
  spots unnecessiarly. As a result there is a subtle bug where the first
  page after the meta data has been loaded unconditionally sets sync_read
  to 0. If this first PFN was actually a highmem page, then the returned
  buffer will be the global "buffer," and the page needs to be loaded
  synchronously.

  That is, I'm not sure we can always assume the following to be safe:

  	handle->buffer = get_buffer(&orig_bm, &ca);
  	handle->sync_read = 0;

  Because get_buffer() can call get_highmem_page_buffer() which can
  return 'buffer'.

  The easiest way to address this is just set sync_read before
  snapshot_write_next() returns if handle->buffer == buffer.

  Signed-off-by: Brian Geffon <bgeffon@google.com>
  Fixes: 8357376d3df2 ("[PATCH] swsusp: Improve handling of highmem")
  Cc: All applicable <stable@vger.kernel.org>
  [ rjw: Subject and changelog edits ]
- PM: hibernate: Use __get_safe_page() rather than touching the list.
  [Brian Geffon]

  commit f0c7183008b41e92fa676406d87f18773724b48b upstream.

  We found at least one situation where the safe pages list was empty and
  get_buffer() would gladly try to use a NULL pointer.
- Arm64: dts: qcom: ipq6018: Fix hwlock index for SMEM. [Vignesh
  Viswanathan]

  commit 95d97b111e1e184b0c8656137033ed64f2cf21e4 upstream.

  SMEM uses lock index 3 of the TCSR Mutex hwlock for allocations
  in SMEM region shared by the Host and FW.

  Fix the SMEM hwlock index to 3 for IPQ6018.
- PCI/ASPM: Fix L1 substate handling in aspm_attr_store_common() [Heiner
  Kallweit]

  commit 8e37372ad0bea4c9b4712d9943f6ae96cff9491f upstream.

  aspm_attr_store_common(), which handles sysfs control of ASPM, has the same
  problem as fb097dcd5a28 ("PCI/ASPM: Disable only ASPM_STATE_L1 when driver
  disables L1"): disabling L1 adds only ASPM_L1 (but not any of the L1.x
  substates) to the "aspm_disable" mask.

  Enabling one substate, e.g., L1.1, via sysfs removes ASPM_L1 from the
  disable mask.  Since disabling L1 via sysfs doesn't add any of the
  substates to the disable mask, enabling L1.1 actually enables *all* the
  substates.

  In this scenario:

    - Write 0 to "l1_aspm" to disable L1
    - Write 1 to "l1_1_aspm" to enable L1.1

  the intention is to disable L1 and all L1.x substates, then enable just
  L1.1, but in fact, *all* L1.x substates are enabled.

  Fix this by explicitly disabling all the L1.x substates when disabling L1.

  Fixes: 72ea91afbfb0 ("PCI/ASPM: Add sysfs attributes for controlling ASPM link states")
  Link: https://lore.kernel.org/r/6ba7dd79-9cfe-4ed0-a002-d99cb842f361@gmail.com
  Signed-off-by: Heiner Kallweit <hkallweit1@gmail.com>
  [bhelgaas: commit log]
- Mmc: sdhci_am654: fix start loop index for TAP value parsing. [Nitin
  Yadav]

  commit 71956d0cb56c1e5f9feeb4819db87a076418e930 upstream.

  ti,otap-del-sel-legacy/ti,itap-del-sel-legacy passed from DT
  are currently ignored for all SD/MMC and eMMC modes. Fix this
  by making start loop index to MMC_TIMING_LEGACY.
- Mmc: vub300: fix an error code. [Dan Carpenter]

  commit b44f9da81783fda72632ef9b0d05ea3f3ca447a5 upstream.

  This error path should return -EINVAL instead of success.
- Clk: qcom: ipq6018: drop the CLK_SET_RATE_PARENT flag from PLL clocks.
  [Kathiravan Thirumoorthy]

  commit 99cd4935cb972d0aafb16838bb2aeadbcaf196ce upstream.

  GPLL, NSS crypto PLL clock rates are fixed and shouldn't be scaled based
  on the request from dependent clocks. Doing so will result in the
  unexpected behaviour. So drop the CLK_SET_RATE_PARENT flag from the PLL
  clocks.
- Clk: qcom: ipq8074: drop the CLK_SET_RATE_PARENT flag from PLL clocks.
  [Kathiravan Thirumoorthy]

  commit e641a070137dd959932c7c222e000d9d941167a2 upstream.

  GPLL, NSS crypto PLL clock rates are fixed and shouldn't be scaled based
  on the request from dependent clocks. Doing so will result in the
  unexpected behaviour. So drop the CLK_SET_RATE_PARENT flag from the PLL
  clocks.
- Parisc/pdc: Add width field to struct pdc_model. [Helge Deller]

  commit 6240553b52c475d9fc9674de0521b77e692f3764 upstream.

  PDC2.0 specifies the additional PSW-bit field.
- Arm64: Restrict CPU_BIG_ENDIAN to GNU as or LLVM IAS 15.x or newer.
  [Nathan Chancellor]

  commit 146a15b873353f8ac28dc281c139ff611a3c4848 upstream.

  Prior to LLVM 15.0.0, LLVM's integrated assembler would incorrectly
  byte-swap NOP when compiling for big-endian, and the resulting series of
  bytes happened to match the encoding of FNMADD S21, S30, S0, S0.

  This went unnoticed until commit:

    34f66c4c4d5518c1 ("arm64: Use a positive cpucap for FP/SIMD")

  Prior to that commit, the kernel would always enable the use of FPSIMD
  early in boot when __cpu_setup() initialized CPACR_EL1, and so usage of
  FNMADD within the kernel was not detected, but could result in the
  corruption of user or kernel FPSIMD state.

  After that commit, the instructions happen to trap during boot prior to
  FPSIMD being detected and enabled, e.g.

  | Unhandled 64-bit el1h sync exception on CPU0, ESR 0x000000001fe00000 -- ASIMD
  | CPU: 0 PID: 0 Comm: swapper Not tainted 6.6.0-rc3-00013-g34f66c4c4d55 #1
  | Hardware name: linux,dummy-virt (DT)
  | pstate: 400000c9 (nZcv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  | pc : __pi_strcmp+0x1c/0x150
  | lr : populate_properties+0xe4/0x254
  | sp : ffffd014173d3ad0
  | x29: ffffd014173d3af0 x28: fffffbfffddffcb8 x27: 0000000000000000
  | x26: 0000000000000058 x25: fffffbfffddfe054 x24: 0000000000000008
  | x23: fffffbfffddfe000 x22: fffffbfffddfe000 x21: fffffbfffddfe044
  | x20: ffffd014173d3b70 x19: 0000000000000001 x18: 0000000000000005
  | x17: 0000000000000010 x16: 0000000000000000 x15: 00000000413e7000
  | x14: 0000000000000000 x13: 0000000000001bcc x12: 0000000000000000
  | x11: 00000000d00dfeed x10: ffffd414193f2cd0 x9 : 0000000000000000
  | x8 : 0101010101010101 x7 : ffffffffffffffc0 x6 : 0000000000000000
  | x5 : 0000000000000000 x4 : 0101010101010101 x3 : 000000000000002a
  | x2 : 0000000000000001 x1 : ffffd014171f2988 x0 : fffffbfffddffcb8
  | Kernel panic - not syncing: Unhandled exception
  | CPU: 0 PID: 0 Comm: swapper Not tainted 6.6.0-rc3-00013-g34f66c4c4d55 #1
  | Hardware name: linux,dummy-virt (DT)
  | Call trace:
  |  dump_backtrace+0xec/0x108
  |  show_stack+0x18/0x2c
  |  dump_stack_lvl+0x50/0x68
  |  dump_stack+0x18/0x24
  |  panic+0x13c/0x340
  |  el1t_64_irq_handler+0x0/0x1c
  |  el1_abort+0x0/0x5c
  |  el1h_64_sync+0x64/0x68
  |  __pi_strcmp+0x1c/0x150
  |  unflatten_dt_nodes+0x1e8/0x2d8
  |  __unflatten_device_tree+0x5c/0x15c
  |  unflatten_device_tree+0x38/0x50
  |  setup_arch+0x164/0x1e0
  |  start_kernel+0x64/0x38c
  |  __primary_switched+0xbc/0xc4

  Restrict CONFIG_CPU_BIG_ENDIAN to a known good assembler, which is
  either GNU as or LLVM's IAS 15.0.0 and newer, which contains the linked
  commit.
- ACPI: resource: Do IRQ override on TongFang GMxXGxx. [Werner Sembach]

  commit 0da9eccde3270b832c059ad618bf66e510c75d33 upstream.

  The TongFang GMxXGxx/TUXEDO Stellaris/Pollaris Gen5 needs IRQ overriding
  for the keyboard to work.

  Adding an entry for this laptop to the override_table makes the internal
  keyboard functional.
- Watchdog: move softlockup_panic back to early_param. [Krister
  Johansen]

  commit 8b793bcda61f6c3ed4f5b2ded7530ef6749580cb upstream.

  Setting softlockup_panic from do_sysctl_args() causes it to take effect
  later in boot.  The lockup detector is enabled before SMP is brought
  online, but do_sysctl_args runs afterwards.  If a user wants to set
  softlockup_panic on boot and have it trigger should a softlockup occur
  during onlining of the non-boot processors, they could do this prior to
  commit f117955a2255 ("kernel/watchdog.c: convert {soft/hard}lockup boot
  parameters to sysctl aliases").  However, after this commit the value
  of softlockup_panic is set too late to be of help for this type of
  problem.  Restore the prior behavior.
- PCI/sysfs: Protect driver's D3cold preference from user space. [Lukas
  Wunner]

  commit 70b70a4307cccebe91388337b1c85735ce4de6ff upstream.

  struct pci_dev contains two flags which govern whether the device may
  suspend to D3cold:

  * no_d3cold provides an opt-out for drivers (e.g. if a device is known
    to not wake from D3cold)

  * d3cold_allowed provides an opt-out for user space (default is true,
    user space may set to false)

  Since commit 9d26d3a8f1b0 ("PCI: Put PCIe ports into D3 during suspend"),
  the user space setting overwrites the driver setting.  Essentially user
  space is trusted to know better than the driver whether D3cold is
  working.

  That feels unsafe and wrong.  Assume that the change was introduced
  inadvertently and do not overwrite no_d3cold when d3cold_allowed is
  modified.  Instead, consider d3cold_allowed in addition to no_d3cold
  when choosing a suspend state for the device.

  That way, user space may opt out of D3cold if the driver hasn't, but it
  may no longer force an opt in if the driver has opted out.
- Hvc/xen: fix error path in xen_hvc_init() to always register frontend
  driver. [David Woodhouse]

  commit 2704c9a5593f4a47620c12dad78838ca62b52f48 upstream.

  The xen_hvc_init() function should always register the frontend driver,
  even when there's no primary console — as there may be secondary consoles.
  (Qemu can always add secondary consoles, but only the toolstack can add
  the primary because it's special.)
- Hvc/xen: fix console unplug. [David Woodhouse]

  commit a30badfd7c13fc8763a9e10c5a12ba7f81515a55 upstream.

  On unplug of a Xen console, xencons_disconnect_backend() unconditionally
  calls free_irq() via unbind_from_irqhandler(), causing a warning of
  freeing an already-free IRQ:

  (qemu) device_del con1
  [   32.050919] ------------[ cut here ]------------
  [   32.050942] Trying to free already-free IRQ 33
  [   32.050990] WARNING: CPU: 0 PID: 51 at kernel/irq/manage.c:1895 __free_irq+0x1d4/0x330

  It should be using evtchn_put() to tear down the event channel binding,
  and let the Linux IRQ side of it be handled by notifier_del_irq() through
  the HVC code.

  On which topic... xencons_disconnect_backend() should call hvc_remove()
  *first*, rather than tearing down the event channel and grant mapping
  while they are in use. And then the IRQ is guaranteed to be freed by
  the time it's torn down by evtchn_put().

  Since evtchn_put() also closes the actual event channel, avoid calling
  xenbus_free_evtchn() except in the failure path where the IRQ was not
  successfully set up.

  However, calling hvc_remove() at the start of xencons_disconnect_backend()
  still isn't early enough. An unplug request is indicated by the backend
  setting its state to XenbusStateClosing, which triggers a notification
  to xencons_backend_changed(), which... does nothing except set its own
  frontend state directly to XenbusStateClosed without *actually* tearing
  down the HVC device or, you know, making sure it isn't actively in use.

  So the backend sees the guest frontend set its state to XenbusStateClosed
  and stops servicing the interrupt... and the guest spins for ever in the
  domU_write_console() function waiting for the ring to drain.

  Fix that one by calling hvc_remove() from xencons_backend_changed() before
  signalling to the backend that it's OK to proceed with the removal.

  Tested with 'dd if=/dev/zero of=/dev/hvc1' while telling Qemu to remove
  the console device.
- Tty/sysrq: replace smp_processor_id() with get_cpu() [Muhammad Usama
  Anjum]

  commit dd976a97d15b47656991e185a94ef42a0fa5cfd4 upstream.

  The smp_processor_id() shouldn't be called from preemptible code.
  Instead use get_cpu() and put_cpu() which disables preemption in
  addition to getting the processor id. Enable preemption back after
  calling schedule_work() to make sure that the work gets scheduled on all
  cores other than the current core. We want to avoid a scenario where
  current core's stack trace is printed multiple times and one core's
  stack trace isn't printed because of scheduling of current task.

  This fixes the following bug:

  [  119.143590] sysrq: Show backtrace of all active CPUs
  [  119.143902] BUG: using smp_processor_id() in preemptible [00000000] code: bash/873
  [  119.144586] caller is debug_smp_processor_id+0x20/0x30
  [  119.144827] CPU: 6 PID: 873 Comm: bash Not tainted 5.10.124-dirty #3
  [  119.144861] Hardware name: QEMU QEMU Virtual Machine, BIOS 2023.05-1 07/22/2023
  [  119.145053] Call trace:
  [  119.145093]  dump_backtrace+0x0/0x1a0
  [  119.145122]  show_stack+0x18/0x70
  [  119.145141]  dump_stack+0xc4/0x11c
  [  119.145159]  check_preemption_disabled+0x100/0x110
  [  119.145175]  debug_smp_processor_id+0x20/0x30
  [  119.145195]  sysrq_handle_showallcpus+0x20/0xc0
  [  119.145211]  __handle_sysrq+0x8c/0x1a0
  [  119.145227]  write_sysrq_trigger+0x94/0x12c
  [  119.145247]  proc_reg_write+0xa8/0xe4
  [  119.145266]  vfs_write+0xec/0x280
  [  119.145282]  ksys_write+0x6c/0x100
  [  119.145298]  __arm64_sys_write+0x20/0x30
  [  119.145315]  el0_svc_common.constprop.0+0x78/0x1e4
  [  119.145332]  do_el0_svc+0x24/0x8c
  [  119.145348]  el0_svc+0x10/0x20
  [  119.145364]  el0_sync_handler+0x134/0x140
  [  119.145381]  el0_sync+0x180/0x1c0
- Audit: don't WARN_ON_ONCE(!current->mm) in audit_exe_compare() [Paul
  Moore]

  commit 969d90ec212bae4b45bf9d21d7daa30aa6cf055e upstream.

  eBPF can end up calling into the audit code from some odd places, and
  some of these places don't have @current set properly so we end up
  tripping the `WARN_ON_ONCE(!current->mm)` near the top of
  `audit_exe_compare()`.  While the basic `!current->mm` check is good,
  the `WARN_ON_ONCE()` results in some scary console messages so let's
  drop that and just do the regular `!current->mm` check to avoid
  problems.
- Audit: don't take task_lock() in audit_exe_compare() code path. [Paul
  Moore]

  commit 47846d51348dd62e5231a83be040981b17c955fa upstream.

  The get_task_exe_file() function locks the given task with task_lock()
  which when used inside audit_exe_compare() can cause deadlocks on
  systems that generate audit records when the task_lock() is held. We
  resolve this problem with two changes: ignoring those cases where the
  task being audited is not the current task, and changing our approach
  to obtaining the executable file struct to not require task_lock().

  With the intent of the audit exe filter being to filter on audit events
  generated by processes started by the specified executable, it makes
  sense that we would only want to use the exe filter on audit records
  associated with the currently executing process, e.g. @current.  If
  we are asked to filter records using a non-@current task_struct we can
  safely ignore the exe filter without negatively impacting the admin's
  expectations for the exe filter.

  Knowing that we only have to worry about filtering the currently
  executing task in audit_exe_compare() we can do away with the
  task_lock() and call get_mm_exe_file() with @current->mm directly.
- KVM: x86: Ignore MSR_AMD64_TW_CFG access. [Maciej S. Szmigiero]

  commit 2770d4722036d6bd24bcb78e9cd7f6e572077d03 upstream.

  Hyper-V enabled Windows Server 2022 KVM VM cannot be started on Zen1 Ryzen
  since it crashes at boot with SYSTEM_THREAD_EXCEPTION_NOT_HANDLED +
  STATUS_PRIVILEGED_INSTRUCTION (in other words, because of an unexpected #GP
  in the guest kernel).

  This is because Windows tries to set bit 8 in MSR_AMD64_TW_CFG and can't
  handle receiving a #GP when doing so.

  Give this MSR the same treatment that commit 2e32b7190641
  ("x86, kvm: Add MSR_AMD64_BU_CFG2 to the list of ignored MSRs") gave
  MSR_AMD64_BU_CFG2 under justification that this MSR is baremetal-relevant
  only.
  Although apparently it was then needed for Linux guests, not Windows as in
  this case.

  With this change, the aforementioned guest setup is able to finish booting
  successfully.

  This issue can be reproduced either on a Summit Ridge Ryzen (with
  just "-cpu host") or on a Naples EPYC (with "-cpu host,stepping=1" since
  EPYC is ordinarily stepping 2).

  Alternatively, userspace could solve the problem by using MSR filters, but
  forcing every userspace to define a filter isn't very friendly and doesn't
  add much, if any, value.  The only potential hiccup is if one of these
  "baremetal-only" MSRs ever requires actual emulation and/or has F/M/S
  specific behavior.  But if that happens, then KVM can still punt *that*
  handling to userspace since userspace MSR filters "win" over KVM's default
  handling.

  Signed-off-by: Maciej S. Szmigiero <maciej.szmigiero@oracle.com>
  Cc: stable@vger.kernel.org
  Link: https://lore.kernel.org/r/1ce85d9c7c9e9632393816cf19c902e0a3f411f1.1697731406.git.maciej.szmigiero@oracle.com
  [sean: call out MSR filtering alternative]
- KVM: x86: hyper-v: Don't auto-enable stimer on write from user-space.
  [Nicolas Saenz Julienne]

  commit d6800af51c76b6dae20e6023bbdc9b3da3ab5121 upstream.

  Don't apply the stimer's counter side effects when modifying its
  value from user-space, as this may trigger spurious interrupts.

  For example:
   - The stimer is configured in auto-enable mode.
   - The stimer's count is set and the timer enabled.
   - The stimer expires, an interrupt is injected.
   - The VM is live migrated.
   - The stimer config and count are deserialized, auto-enable is ON, the
     stimer is re-enabled.
   - The stimer expires right away, and injects an unwarranted interrupt.
- X86/cpu/hygon: Fix the CPU topology evaluation for real. [Pu Wen]

  commit ee545b94d39a00c93dc98b1dbcbcf731d2eadeb4 upstream.

  Hygon processors with a model ID > 3 have CPUID leaf 0xB correctly
  populated and don't need the fixed package ID shift workaround. The fixup
  is also incorrect when running in a guest.
- Scsi: megaraid_sas: Increase register read retry rount from 3 to 30
  for selected registers. [Chandrakanth patil]

  commit 8e3ed9e786511ad800c33605ed904b9de49323cf upstream.

  In BMC environments with concurrent access to multiple registers, certain
  registers occasionally yield a value of 0 even after 3 retries due to
  hardware errata. As a fix, we have extended the retry count from 3 to 30.

  The same errata applies to the mpt3sas driver, and a similar patch has
  been accepted. Please find more details in the mpt3sas patch reference
  link.
- Scsi: mpt3sas: Fix loop logic. [Ranjan Kumar]

  commit 3c978492c333f0c08248a8d51cecbe5eb5f617c9 upstream.

  The retry loop continues to iterate until the count reaches 30, even after
  receiving the correct value. Exit loop when a non-zero value is read.
- Bpf: Fix precision tracking for BPF_ALU | BPF_TO_BE | BPF_END. [Shung-
  Hsi Yu]

  commit 291d044fd51f8484066300ee42afecf8c8db7b3a upstream.

  BPF_END and BPF_NEG has a different specification for the source bit in
  the opcode compared to other ALU/ALU64 instructions, and is either
  reserved or use to specify the byte swap endianness. In both cases the
  source bit does not encode source operand location, and src_reg is a
  reserved field.

  backtrack_insn() currently does not differentiate BPF_END and BPF_NEG
  from other ALU/ALU64 instructions, which leads to r0 being incorrectly
  marked as precise when processing BPF_ALU | BPF_TO_BE | BPF_END
  instructions. This commit teaches backtrack_insn() to correctly mark
  precision for such case.

  While precise tracking of BPF_NEG and other BPF_END instructions are
  correct and does not need fixing, this commit opt to process all BPF_NEG
  and BPF_END instructions within the same if-clause to better align with
  current convention used in the verifier (e.g. check_alu_op).
- Bpf: Fix check_stack_write_fixed_off() to correctly spill imm. [Hao
  Sun]

  commit 811c363645b33e6e22658634329e95f383dfc705 upstream.

  In check_stack_write_fixed_off(), imm value is cast to u32 before being
  spilled to the stack. Therefore, the sign information is lost, and the
  range information is incorrect when load from the stack again.

  For the following prog:
  0: r2 = r10
  1: *(u64*)(r2 -40) = -44
  2: r0 = *(u64*)(r2 - 40)
  3: if r0 s<= 0xa goto +2
  4: r0 = 1
  5: exit
  6: r0  = 0
  7: exit

  The verifier gives:
  func#0 @0
  0: R1=ctx(off=0,imm=0) R10=fp0
  0: (bf) r2 = r10                      ; R2_w=fp0 R10=fp0
  1: (7a) *(u64 *)(r2 -40) = -44        ; R2_w=fp0 fp-40_w=4294967252
  2: (79) r0 = *(u64 *)(r2 -40)         ; R0_w=4294967252 R2_w=fp0
  fp-40_w=4294967252
  3: (c5) if r0 s< 0xa goto pc+2
  mark_precise: frame0: last_idx 3 first_idx 0 subseq_idx -1
  mark_precise: frame0: regs=r0 stack= before 2: (79) r0 = *(u64 *)(r2 -40)
  3: R0_w=4294967252
  4: (b7) r0 = 1                        ; R0_w=1
  5: (95) exit
  verification time 7971 usec
  stack depth 40
  processed 6 insns (limit 1000000) max_states_per_insn 0 total_states 0
  peak_states 0 mark_read 0

  So remove the incorrect cast, since imm field is declared as s32, and
  __mark_reg_known() takes u64, so imm would be correctly sign extended
  by compiler.
- Randstruct: Fix gcc-plugin performance mode to stay in group. [Kees
  Cook]

  commit 381fdb73d1e2a48244de7260550e453d1003bb8e upstream.

  The performance mode of the gcc-plugin randstruct was shuffling struct
  members outside of the cache-line groups. Limit the range to the
  specified group indexes.
- Powerpc/perf: Fix disabling BHRB and instruction sampling. [Nicholas
  Piggin]

  commit ea142e590aec55ba40c5affb4d49e68c713c63dc upstream.

  When the PMU is disabled, MMCRA is not updated to disable BHRB and
  instruction sampling. This can lead to those features remaining enabled,
  which can slow down a real or emulated CPU.
- Media: venus: hfi: add checks to perform sanity on queue pointers.
  [Vikash Garodia]

  commit 5e538fce33589da6d7cb2de1445b84d3a8a692f7 upstream.

  Read and write pointers are used to track the packet index in the memory
  shared between video driver and firmware. There is a possibility of OOB
  access if the read or write pointer goes beyond the queue memory size.
  Add checks for the read and write pointer to avoid OOB access.
- Cifs: fix check of rc in function generate_smb3signingkey. [Ekaterina
  Esina]

  [ Upstream commit 181724fc72486dec2bec8803459be05b5162aaa8 ]

  Remove extra check after condition, add check after generating key
  for encryption. The check is needed to return non zero rc before
  rewriting it with generating key for decryption.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.
- Cifs: spnego: add ';' in HOST_KEY_LEN. [Anastasia Belova]

  [ Upstream commit ff31ba19d732efb9aca3633935d71085e68d5076 ]

  "host=" should start with ';' (as in cifs_get_spnego_key)
  So its length should be 6.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.
- Tools/power/turbostat: Fix a knl bug. [Zhang Rui]

  [ Upstream commit 137f01b3529d292a68d22e9681e2f903c768f790 ]

  MSR_KNL_CORE_C6_RESIDENCY should be evaluated only if
  1. this is KNL platform
  AND
  2. need to get C6 residency or need to calculate C1 residency

  Fix the broken logic introduced by commit 1e9042b9c8d4 ("tools/power
  turbostat: Fix CPU%C1 display value").
- Macvlan: Don't propagate promisc change to lower dev in passthru.
  [Vlad Buslov]

  [ Upstream commit 7e1caeace0418381f36b3aa8403dfd82fc57fc53 ]

  Macvlan device in passthru mode sets its lower device promiscuous mode
  according to its MACVLAN_FLAG_NOPROMISC flag instead of synchronizing it to
  its own promiscuity setting. However, macvlan_change_rx_flags() function
  doesn't check the mode before propagating such changes to the lower device
  which can cause net_device->promiscuity counter overflow as illustrated by
  reproduction example [0] and resulting dmesg log [1]. Fix the issue by
  first verifying the mode in macvlan_change_rx_flags() function before
  propagating promiscuous mode change to the lower device.

  [0]:
  ip link add macvlan1 link enp8s0f0 type macvlan mode passthru
  ip link set macvlan1 promisc on
  ip l set dev macvlan1 up
  ip link set macvlan1 promisc off
  ip l set dev macvlan1 down
  ip l set dev macvlan1 up

  [1]:
  [ 5156.281724] macvlan1: entered promiscuous mode
  [ 5156.285467] mlx5_core 0000:08:00.0 enp8s0f0: entered promiscuous mode
  [ 5156.287639] macvlan1: left promiscuous mode
  [ 5156.288339] mlx5_core 0000:08:00.0 enp8s0f0: left promiscuous mode
  [ 5156.290907] mlx5_core 0000:08:00.0 enp8s0f0: entered promiscuous mode
  [ 5156.317197] mlx5_core 0000:08:00.0 enp8s0f0: promiscuity touches roof, set promiscuity failed. promiscuity feature of device might be broken.
- Net/mlx5e: Check return value of snprintf writing to fw_version buffer
  for representors. [Rahul Rameshbabu]

  [ Upstream commit 1b2bd0c0264febcd8d47209079a6671c38e6558b ]

  Treat the operation as an error case when the return value is equivalent to
  the size of the name buffer. Failed to write null terminator to the name
  buffer, making the string malformed and should not be used. Provide a
  string with only the firmware version when forming the string with the
  board id fails. This logic for representors is identical to normal flow
  with ethtool.

  Without check, will trigger -Wformat-truncation with W=1.

      drivers/net/ethernet/mellanox/mlx5/core/en_rep.c: In function 'mlx5e_rep_get_drvinfo':
      drivers/net/ethernet/mellanox/mlx5/core/en_rep.c:78:31: warning: '%.16s' directive output may be truncated writing up to 16 bytes into a region of size between 13 and 22 [-Wformat-truncation=]
        78 |                  "%d.%d.%04d (%.16s)",
           |                               ^~~~~
      drivers/net/ethernet/mellanox/mlx5/core/en_rep.c:77:9: note: 'snprintf' output between 12 and 37 bytes into a destination of size 32
        77 |         snprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),
           |         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        78 |                  "%d.%d.%04d (%.16s)",
           |                  ~~~~~~~~~~~~~~~~~~~~~
        79 |                  fw_rev_maj(mdev), fw_rev_min(mdev),
           |                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        80 |                  fw_rev_sub(mdev), mdev->board_id);
           |                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Net/mlx5_core: Clean driver version and name. [Leon Romanovsky]

  [ Upstream commit 17a7612b99e66d2539341ab4f888f970c2c7f76d ]

  Remove exposed driver version as it was done in other drivers,
  so module version will work correctly by displaying the kernel
  version for which it is compiled.

  And move mlx5_core module name to general include, so auxiliary drivers
  will be able to use it as a basis for a name in their device ID tables.
- Net/mlx5e: fix double free of encap_header. [Dust Li]

  [ Upstream commit 6f9b1a0731662648949a1c0587f6acb3b7f8acf1 ]

  When mlx5_packet_reformat_alloc() fails, the encap_header allocated in
  mlx5e_tc_tun_create_header_ipv4{6} will be released within it. However,
  e->encap_header is already set to the previously freed encap_header
  before mlx5_packet_reformat_alloc(). As a result, the later
  mlx5e_encap_put() will free e->encap_header again, causing a double free
  issue.

  mlx5e_encap_put()
      --> mlx5e_encap_dealloc()
          --> kfree(e->encap_header)

  This happens when cmd: MLX5_CMD_OP_ALLOC_PACKET_REFORMAT_CONTEXT fail.

  This patch fix it by not setting e->encap_header until
  mlx5_packet_reformat_alloc() success.
- Net: stmmac: fix rx budget limit check. [Baruch Siach]

  [ Upstream commit fa02de9e75889915b554eda1964a631fd019973b ]

  The while loop condition verifies 'count < limit'. Neither value change
  before the 'count >= limit' check. As is this check is dead code. But
  code inspection reveals a code path that modifies 'count' and then goto
  'drain_data' and back to 'read_again'. So there is a need to verify
  count value sanity after 'read_again'.

  Move 'read_again' up to fix the count limit check.
- Netfilter: nf_conntrack_bridge: initialize err to 0. [Linkui Xiao]

  [ Upstream commit a44af08e3d4d7566eeea98d7a29fe06e7b9de944 ]

  K2CI reported a problem:

  	consume_skb(skb);
  	return err;
  [nf_br_ip_fragment() error]  uninitialized symbol 'err'.

  err is not initialized, because returning 0 is expected, initialize err
  to 0.
- Net: ethernet: cortina: Fix MTU max setting. [Linus Walleij]

  [ Upstream commit dc6c0bfbaa947dd7976e30e8c29b10c868b6fa42 ]

  The RX max frame size is over 10000 for the Gemini ethernet,
  but the TX max frame size is actually just 2047 (0x7ff after
  checking the datasheet). Reflect this in what we offer to Linux,
  cap the MTU at the TX max frame minus ethernet headers.

  We delete the code disabling the hardware checksum for large
  MTUs as netdev->mtu can no longer be larger than
  netdev->max_mtu meaning the if()-clause in gmac_fix_features()
  is never true.
- Net: ethernet: cortina: Handle large frames. [Linus Walleij]

  [ Upstream commit d4d0c5b4d279bfe3585fbd806efefd3e51c82afa ]

  The Gemini ethernet controller provides hardware checksumming
  for frames up to 1514 bytes including ethernet headers but not
  FCS.

  If we start sending bigger frames (after first bumping up the MTU
  on both interfaces sending and receiving the frames), truncated
  packets start to appear on the target such as in this tcpdump
  resulting from ping -s 1474:

  23:34:17.241983 14:d6:4d:a8:3c:4f (oui Unknown) > bc:ae:c5:6b:a8:3d (oui Unknown),
  ethertype IPv4 (0x0800), length 1514: truncated-ip - 2 bytes missing!
  (tos 0x0, ttl 64, id 32653, offset 0, flags [DF], proto ICMP (1), length 1502)
  OpenWrt.lan > Fecusia: ICMP echo request, id 1672, seq 50, length 1482

  If we bypass the hardware checksumming and provide a software
  fallback, everything starts working fine up to the max TX MTU
  of 2047 bytes, for example ping -s2000 192.168.1.2:

  00:44:29.587598 bc:ae:c5:6b:a8:3d (oui Unknown) > 14:d6:4d:a8:3c:4f (oui Unknown),
  ethertype IPv4 (0x0800), length 2042:
  (tos 0x0, ttl 64, id 51828, offset 0, flags [none], proto ICMP (1), length 2028)
  Fecusia > OpenWrt.lan: ICMP echo reply, id 1683, seq 4, length 2008

  The bit enabling to bypass hardware checksum (or any of the
  "TSS" bits) are undocumented in the hardware reference manual.
  The entire hardware checksum unit appears undocumented. The
  conclusion that we need to use the "bypass" bit was found by
  trial-and-error.

  Since no hardware checksum will happen, we slot in a software
  checksum fallback.

  Check for the condition where we need to compute checksum on the
  skb with either hardware or software using == CHECKSUM_PARTIAL instead
  of != CHECKSUM_NONE which is an incomplete check according to
  <linux/skbuff.h>.

  On the D-Link DIR-685 router this fixes a bug on the conduit
  interface to the RTL8366RB DSA switch: as the switch needs to add
  space for its tag it increases the MTU on the conduit interface
  to 1504 and that means that when the router sends packages
  of 1500 bytes these get an extra 4 bytes of DSA tag and the
  transfer fails because of the erroneous hardware checksumming,
  affecting such basic functionality as the LuCI web interface.
- Net: ethernet: cortina: Fix max RX frame define. [Linus Walleij]

  [ Upstream commit 510e35fb931ffc3b100e5d5ae4595cd3beca9f1a ]

  Enumerator 3 is 1548 bytes according to the datasheet.
  Not 1542.
- Bonding: stop the device in bond_setup_by_slave() [Eric Dumazet]

  [ Upstream commit 3cffa2ddc4d3fcf70cde361236f5a614f81a09b2 ]

  Commit 9eed321cde22 ("net: lapbether: only support ethernet devices")
  has been able to keep syzbot away from net/lapb, until today.

  In the following splat [1], the issue is that a lapbether device has
  been created on a bonding device without members. Then adding a non
  ARPHRD_ETHER member forced the bonding master to change its type.

  The fix is to make sure we call dev_close() in bond_setup_by_slave()
  so that the potential linked lapbether devices (or any other devices
  having assumptions on the physical device) are removed.

  A similar bug has been addressed in commit 40baec225765
  ("bonding: fix panic on non-ARPHRD_ETHER enslave failure")

  [1]
  skbuff: skb_under_panic: text:ffff800089508810 len:44 put:40 head:ffff0000c78e7c00 data:ffff0000c78e7bea tail:0x16 end:0x140 dev:bond0
  kernel BUG at net/core/skbuff.c:192 !
  Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP
  Modules linked in:
  CPU: 0 PID: 6007 Comm: syz-executor383 Not tainted 6.6.0-rc3-syzkaller-gbf6547d8715b #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/04/2023
  pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  pc : skb_panic net/core/skbuff.c:188 [inline]
  pc : skb_under_panic+0x13c/0x140 net/core/skbuff.c:202
  lr : skb_panic net/core/skbuff.c:188 [inline]
  lr : skb_under_panic+0x13c/0x140 net/core/skbuff.c:202
  sp : ffff800096a06aa0
  x29: ffff800096a06ab0 x28: ffff800096a06ba0 x27: dfff800000000000
  x26: ffff0000ce9b9b50 x25: 0000000000000016 x24: ffff0000c78e7bea
  x23: ffff0000c78e7c00 x22: 000000000000002c x21: 0000000000000140
  x20: 0000000000000028 x19: ffff800089508810 x18: ffff800096a06100
  x17: 0000000000000000 x16: ffff80008a629a3c x15: 0000000000000001
  x14: 1fffe00036837a32 x13: 0000000000000000 x12: 0000000000000000
  x11: 0000000000000201 x10: 0000000000000000 x9 : cb50b496c519aa00
  x8 : cb50b496c519aa00 x7 : 0000000000000001 x6 : 0000000000000001
  x5 : ffff800096a063b8 x4 : ffff80008e280f80 x3 : ffff8000805ad11c
  x2 : 0000000000000001 x1 : 0000000100000201 x0 : 0000000000000086
  Call trace:
  skb_panic net/core/skbuff.c:188 [inline]
  skb_under_panic+0x13c/0x140 net/core/skbuff.c:202
  skb_push+0xf0/0x108 net/core/skbuff.c:2446
  ip6gre_header+0xbc/0x738 net/ipv6/ip6_gre.c:1384
  dev_hard_header include/linux/netdevice.h:3136 [inline]
  lapbeth_data_transmit+0x1c4/0x298 drivers/net/wan/lapbether.c:257
  lapb_data_transmit+0x8c/0xb0 net/lapb/lapb_iface.c:447
  lapb_transmit_buffer+0x178/0x204 net/lapb/lapb_out.c:149
  lapb_send_control+0x220/0x320 net/lapb/lapb_subr.c:251
  __lapb_disconnect_request+0x9c/0x17c net/lapb/lapb_iface.c:326
  lapb_device_event+0x288/0x4e0 net/lapb/lapb_iface.c:492
  notifier_call_chain+0x1a4/0x510 kernel/notifier.c:93
  raw_notifier_call_chain+0x3c/0x50 kernel/notifier.c:461
  call_netdevice_notifiers_info net/core/dev.c:1970 [inline]
  call_netdevice_notifiers_extack net/core/dev.c:2008 [inline]
  call_netdevice_notifiers net/core/dev.c:2022 [inline]
  __dev_close_many+0x1b8/0x3c4 net/core/dev.c:1508
  dev_close_many+0x1e0/0x470 net/core/dev.c:1559
  dev_close+0x174/0x250 net/core/dev.c:1585
  lapbeth_device_event+0x2e4/0x958 drivers/net/wan/lapbether.c:466
  notifier_call_chain+0x1a4/0x510 kernel/notifier.c:93
  raw_notifier_call_chain+0x3c/0x50 kernel/notifier.c:461
  call_netdevice_notifiers_info net/core/dev.c:1970 [inline]
  call_netdevice_notifiers_extack net/core/dev.c:2008 [inline]
  call_netdevice_notifiers net/core/dev.c:2022 [inline]
  __dev_close_many+0x1b8/0x3c4 net/core/dev.c:1508
  dev_close_many+0x1e0/0x470 net/core/dev.c:1559
  dev_close+0x174/0x250 net/core/dev.c:1585
  bond_enslave+0x2298/0x30cc drivers/net/bonding/bond_main.c:2332
  bond_do_ioctl+0x268/0xc64 drivers/net/bonding/bond_main.c:4539
  dev_ifsioc+0x754/0x9ac
  dev_ioctl+0x4d8/0xd34 net/core/dev_ioctl.c:786
  sock_do_ioctl+0x1d4/0x2d0 net/socket.c:1217
  sock_ioctl+0x4e8/0x834 net/socket.c:1322
  vfs_ioctl fs/ioctl.c:51 [inline]
  __do_sys_ioctl fs/ioctl.c:871 [inline]
  __se_sys_ioctl fs/ioctl.c:857 [inline]
  __arm64_sys_ioctl+0x14c/0x1c8 fs/ioctl.c:857
  __invoke_syscall arch/arm64/kernel/syscall.c:37 [inline]
  invoke_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:51
  el0_svc_common+0x130/0x23c arch/arm64/kernel/syscall.c:136
  do_el0_svc+0x48/0x58 arch/arm64/kernel/syscall.c:155
  el0_svc+0x58/0x16c arch/arm64/kernel/entry-common.c:678
  el0t_64_sync_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:696
  el0t_64_sync+0x190/0x194 arch/arm64/kernel/entry.S:591
- Ptp: annotate data-race around q->head and q->tail. [Eric Dumazet]

  [ Upstream commit 73bde5a3294853947252cd9092a3517c7cb0cd2d ]

  As I was working on a syzbot report, I found that KCSAN would
  probably complain that reading q->head or q->tail without
  barriers could lead to invalid results.

  Add corresponding READ_ONCE() and WRITE_ONCE() to avoid
  load-store tearing.
- Xen/events: fix delayed eoi list handling. [Juergen Gross]

  [ Upstream commit 47d970204054f859f35a2237baa75c2d84fcf436 ]

  When delaying eoi handling of events, the related elements are queued
  into the percpu lateeoi list. In case the list isn't empty, the
  elements should be sorted by the time when eoi handling is to happen.

  Unfortunately a new element will never be queued at the start of the
  list, even if it has a handling time lower than all other list
  elements.

  Fix that by handling that case the same way as for an empty list.
- Ppp: limit MRU to 64K. [Willem de Bruijn]

  [ Upstream commit c0a2a1b0d631fc460d830f52d06211838874d655 ]

  ppp_sync_ioctl allows setting device MRU, but does not sanity check
  this input.

  Limit to a sane upper bound of 64KB.

  No implementation I could find generates larger than 64KB frames.
  RFC 2823 mentions an upper bound of PPP over SDL of 64KB based on the
  16-bit length field. Other protocols will be smaller, such as PPPoE
  (9KB jumbo frame) and PPPoA (18190 maximum CPCS-SDU size, RFC 2364).
  PPTP and L2TP encapsulate in IP.

  Syzbot managed to trigger alloc warning in __alloc_pages:

  	if (WARN_ON_ONCE_GFP(order > MAX_ORDER, gfp))

      WARNING: CPU: 1 PID: 37 at mm/page_alloc.c:4544 __alloc_pages+0x3ab/0x4a0 mm/page_alloc.c:4544

      __alloc_skb+0x12b/0x330 net/core/skbuff.c:651
      __netdev_alloc_skb+0x72/0x3f0 net/core/skbuff.c:715
      netdev_alloc_skb include/linux/skbuff.h:3225 [inline]
      dev_alloc_skb include/linux/skbuff.h:3238 [inline]
      ppp_sync_input drivers/net/ppp/ppp_synctty.c:669 [inline]
      ppp_sync_receive+0xff/0x680 drivers/net/ppp/ppp_synctty.c:334
      tty_ldisc_receive_buf+0x14c/0x180 drivers/tty/tty_buffer.c:390
      tty_port_default_receive_buf+0x70/0xb0 drivers/tty/tty_port.c:37
      receive_buf drivers/tty/tty_buffer.c:444 [inline]
      flush_to_ldisc+0x261/0x780 drivers/tty/tty_buffer.c:494
      process_one_work+0x884/0x15c0 kernel/workqueue.c:2630

  With call

      ioctl$PPPIOCSMRU1(r1, 0x40047452, &(0x7f0000000100)=0x5e6417a8)

  Similar code exists in other drivers that implement ppp_channel_ops
  ioctl PPPIOCSMRU. Those might also be in scope. Notably excluded from
  this are pppol2tp_ioctl and pppoe_ioctl.

  This code goes back to the start of git history.
- Tipc: Fix kernel-infoleak due to uninitialized TLV value. [Shigeru
  Yoshida]

  [ Upstream commit fb317eb23b5ee4c37b0656a9a52a3db58d9dd072 ]

  KMSAN reported the following kernel-infoleak issue:

  =====================================================
  BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:114 [inline]
  BUG: KMSAN: kernel-infoleak in copy_to_user_iter lib/iov_iter.c:24 [inline]
  BUG: KMSAN: kernel-infoleak in iterate_ubuf include/linux/iov_iter.h:29 [inline]
  BUG: KMSAN: kernel-infoleak in iterate_and_advance2 include/linux/iov_iter.h:245 [inline]
  BUG: KMSAN: kernel-infoleak in iterate_and_advance include/linux/iov_iter.h:271 [inline]
  BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x4ec/0x2bc0 lib/iov_iter.c:186
   instrument_copy_to_user include/linux/instrumented.h:114 [inline]
   copy_to_user_iter lib/iov_iter.c:24 [inline]
   iterate_ubuf include/linux/iov_iter.h:29 [inline]
   iterate_and_advance2 include/linux/iov_iter.h:245 [inline]
   iterate_and_advance include/linux/iov_iter.h:271 [inline]
   _copy_to_iter+0x4ec/0x2bc0 lib/iov_iter.c:186
   copy_to_iter include/linux/uio.h:197 [inline]
   simple_copy_to_iter net/core/datagram.c:532 [inline]
   __skb_datagram_iter.5+0x148/0xe30 net/core/datagram.c:420
   skb_copy_datagram_iter+0x52/0x210 net/core/datagram.c:546
   skb_copy_datagram_msg include/linux/skbuff.h:3960 [inline]
   netlink_recvmsg+0x43d/0x1630 net/netlink/af_netlink.c:1967
   sock_recvmsg_nosec net/socket.c:1044 [inline]
   sock_recvmsg net/socket.c:1066 [inline]
   __sys_recvfrom+0x476/0x860 net/socket.c:2246
   __do_sys_recvfrom net/socket.c:2264 [inline]
   __se_sys_recvfrom net/socket.c:2260 [inline]
   __x64_sys_recvfrom+0x130/0x200 net/socket.c:2260
   do_syscall_x64 arch/x86/entry/common.c:51 [inline]
   do_syscall_64+0x44/0x110 arch/x86/entry/common.c:82
   entry_SYSCALL_64_after_hwframe+0x63/0x6b

  Uninit was created at:
   slab_post_alloc_hook+0x103/0x9e0 mm/slab.h:768
   slab_alloc_node mm/slub.c:3478 [inline]
   kmem_cache_alloc_node+0x5f7/0xb50 mm/slub.c:3523
   kmalloc_reserve+0x13c/0x4a0 net/core/skbuff.c:560
   __alloc_skb+0x2fd/0x770 net/core/skbuff.c:651
   alloc_skb include/linux/skbuff.h:1286 [inline]
   tipc_tlv_alloc net/tipc/netlink_compat.c:156 [inline]
   tipc_get_err_tlv+0x90/0x5d0 net/tipc/netlink_compat.c:170
   tipc_nl_compat_recv+0x1042/0x15d0 net/tipc/netlink_compat.c:1324
   genl_family_rcv_msg_doit net/netlink/genetlink.c:972 [inline]
   genl_family_rcv_msg net/netlink/genetlink.c:1052 [inline]
   genl_rcv_msg+0x1220/0x12c0 net/netlink/genetlink.c:1067
   netlink_rcv_skb+0x4a4/0x6a0 net/netlink/af_netlink.c:2545
   genl_rcv+0x41/0x60 net/netlink/genetlink.c:1076
   netlink_unicast_kernel net/netlink/af_netlink.c:1342 [inline]
   netlink_unicast+0xf4b/0x1230 net/netlink/af_netlink.c:1368
   netlink_sendmsg+0x1242/0x1420 net/netlink/af_netlink.c:1910
   sock_sendmsg_nosec net/socket.c:730 [inline]
   __sock_sendmsg net/socket.c:745 [inline]
   ____sys_sendmsg+0x997/0xd60 net/socket.c:2588
   ___sys_sendmsg+0x271/0x3b0 net/socket.c:2642
   __sys_sendmsg net/socket.c:2671 [inline]
   __do_sys_sendmsg net/socket.c:2680 [inline]
   __se_sys_sendmsg net/socket.c:2678 [inline]
   __x64_sys_sendmsg+0x2fa/0x4a0 net/socket.c:2678
   do_syscall_x64 arch/x86/entry/common.c:51 [inline]
   do_syscall_64+0x44/0x110 arch/x86/entry/common.c:82
   entry_SYSCALL_64_after_hwframe+0x63/0x6b

  Bytes 34-35 of 36 are uninitialized
  Memory access of size 36 starts at ffff88802d464a00
  Data copied to user address 00007ff55033c0a0

  CPU: 0 PID: 30322 Comm: syz-executor.0 Not tainted 6.6.0-14500-g1c41041124bd #10
  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-1.fc38 04/01/2014
  =====================================================

  tipc_add_tlv() puts TLV descriptor and value onto `skb`. This size is
  calculated with TLV_SPACE() macro. It adds the size of struct tlv_desc and
  the length of TLV value passed as an argument, and aligns the result to a
  multiple of TLV_ALIGNTO, i.e., a multiple of 4 bytes.

  If the size of struct tlv_desc plus the length of TLV value is not aligned,
  the current implementation leaves the remaining bytes uninitialized. This
  is the cause of the above kernel-infoleak issue.

  This patch resolves this issue by clearing data up to an aligned size.
- Net: hns3: fix VF reset fail issue. [Jijie Shao]

  [ Upstream commit 65e98bb56fa3ce2edb400930c05238c9b380500e ]

  Currently the reset process in hns3 and firmware watchdog init process is
  asynchronous. We think firmware watchdog initialization is completed
  before VF clear the interrupt source. However, firmware initialization
  may not complete early. So VF will receive multiple reset interrupts
  and fail to reset.

  So we add delay before VF interrupt source and 5 ms delay
  is enough to avoid second reset interrupt.
- Net: hns3: fix variable may not initialized problem in
  hns3_init_mac_addr() [Yonglong Liu]

  [ Upstream commit dbd2f3b20c6ae425665b6975d766e3653d453e73 ]

  When a VF is calling hns3_init_mac_addr(), get_mac_addr() may
  return fail, then the value of mac_addr_temp is not initialized.
- Tty: Fix uninit-value access in ppp_sync_receive() [Shigeru Yoshida]

  [ Upstream commit 719639853d88071dfdfd8d9971eca9c283ff314c ]

  KMSAN reported the following uninit-value access issue:

  =====================================================
  BUG: KMSAN: uninit-value in ppp_sync_input drivers/net/ppp/ppp_synctty.c:690 [inline]
  BUG: KMSAN: uninit-value in ppp_sync_receive+0xdc9/0xe70 drivers/net/ppp/ppp_synctty.c:334
   ppp_sync_input drivers/net/ppp/ppp_synctty.c:690 [inline]
   ppp_sync_receive+0xdc9/0xe70 drivers/net/ppp/ppp_synctty.c:334
   tiocsti+0x328/0x450 drivers/tty/tty_io.c:2295
   tty_ioctl+0x808/0x1920 drivers/tty/tty_io.c:2694
   vfs_ioctl fs/ioctl.c:51 [inline]
   __do_sys_ioctl fs/ioctl.c:871 [inline]
   __se_sys_ioctl+0x211/0x400 fs/ioctl.c:857
   __x64_sys_ioctl+0x97/0xe0 fs/ioctl.c:857
   do_syscall_x64 arch/x86/entry/common.c:51 [inline]
   do_syscall_64+0x44/0x110 arch/x86/entry/common.c:82
   entry_SYSCALL_64_after_hwframe+0x63/0x6b

  Uninit was created at:
   __alloc_pages+0x75d/0xe80 mm/page_alloc.c:4591
   __alloc_pages_node include/linux/gfp.h:238 [inline]
   alloc_pages_node include/linux/gfp.h:261 [inline]
   __page_frag_cache_refill+0x9a/0x2c0 mm/page_alloc.c:4691
   page_frag_alloc_align+0x91/0x5d0 mm/page_alloc.c:4722
   page_frag_alloc include/linux/gfp.h:322 [inline]
   __netdev_alloc_skb+0x215/0x6d0 net/core/skbuff.c:728
   netdev_alloc_skb include/linux/skbuff.h:3225 [inline]
   dev_alloc_skb include/linux/skbuff.h:3238 [inline]
   ppp_sync_input drivers/net/ppp/ppp_synctty.c:669 [inline]
   ppp_sync_receive+0x237/0xe70 drivers/net/ppp/ppp_synctty.c:334
   tiocsti+0x328/0x450 drivers/tty/tty_io.c:2295
   tty_ioctl+0x808/0x1920 drivers/tty/tty_io.c:2694
   vfs_ioctl fs/ioctl.c:51 [inline]
   __do_sys_ioctl fs/ioctl.c:871 [inline]
   __se_sys_ioctl+0x211/0x400 fs/ioctl.c:857
   __x64_sys_ioctl+0x97/0xe0 fs/ioctl.c:857
   do_syscall_x64 arch/x86/entry/common.c:51 [inline]
   do_syscall_64+0x44/0x110 arch/x86/entry/common.c:82
   entry_SYSCALL_64_after_hwframe+0x63/0x6b

  CPU: 0 PID: 12950 Comm: syz-executor.1 Not tainted 6.6.0-14500-g1c41041124bd #10
  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-1.fc38 04/01/2014
  =====================================================

  ppp_sync_input() checks the first 2 bytes of the data are PPP_ALLSTATIONS
  and PPP_UI. However, if the data length is 1 and the first byte is
  PPP_ALLSTATIONS, an access to an uninitialized value occurs when checking
  PPP_UI. This patch resolves this issue by checking the data length.
- Ipvlan: add ipvlan_route_v6_outbound() helper. [Eric Dumazet]

  [ Upstream commit 18f039428c7df183b09c69ebf10ffd4e521035d2 ]

  Inspired by syzbot reports using a stack of multiple ipvlan devices.

  Reduce stack size needed in ipvlan_process_v6_outbound() by moving
  the flowi6 struct used for the route lookup in an non inlined
  helper. ipvlan_route_v6_outbound() needs 120 bytes on the stack,
  immediately reclaimed.

  Also make sure ipvlan_process_v4_outbound() is not inlined.

  We might also have to lower MAX_NEST_DEV, because only syzbot uses
  setups with more than four stacked devices.

  BUG: TASK stack guard page was hit at ffffc9000e803ff8 (stack is ffffc9000e804000..ffffc9000e808000)
  stack guard page: 0000 [#1] SMP KASAN
  CPU: 0 PID: 13442 Comm: syz-executor.4 Not tainted 6.1.52-syzkaller #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 10/09/2023
  RIP: 0010:kasan_check_range+0x4/0x2a0 mm/kasan/generic.c:188
  Code: 48 01 c6 48 89 c7 e8 db 4e c1 03 31 c0 5d c3 cc 0f 0b eb 02 0f 0b b8 ea ff ff ff 5d c3 cc 00 00 cc cc 00 00 cc cc 55 48 89 e5 <41> 57 41 56 41 55 41 54 53 b0 01 48 85 f6 0f 84 a4 01 00 00 48 89
  RSP: 0018:ffffc9000e804000 EFLAGS: 00010246
  RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff817e5bf2
  RDX: 0000000000000000 RSI: 0000000000000008 RDI: ffffffff887c6568
  RBP: ffffc9000e804000 R08: 0000000000000000 R09: 0000000000000000
  R10: 0000000000000000 R11: dffffc0000000001 R12: 1ffff92001d0080c
  R13: dffffc0000000000 R14: ffffffff87e6b100 R15: 0000000000000000
  FS: 00007fd0c55826c0(0000) GS:ffff8881f6800000(0000) knlGS:0000000000000000
  CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: ffffc9000e803ff8 CR3: 0000000170ef7000 CR4: 00000000003506f0
  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
  Call Trace:
  <#DF>
  </#DF>
  <TASK>
  [<ffffffff81f281d1>] __kasan_check_read+0x11/0x20 mm/kasan/shadow.c:31
  [<ffffffff817e5bf2>] instrument_atomic_read include/linux/instrumented.h:72 [inline]
  [<ffffffff817e5bf2>] _test_bit include/asm-generic/bitops/instrumented-non-atomic.h:141 [inline]
  [<ffffffff817e5bf2>] cpumask_test_cpu include/linux/cpumask.h:506 [inline]
  [<ffffffff817e5bf2>] cpu_online include/linux/cpumask.h:1092 [inline]
  [<ffffffff817e5bf2>] trace_lock_acquire include/trace/events/lock.h:24 [inline]
  [<ffffffff817e5bf2>] lock_acquire+0xe2/0x590 kernel/locking/lockdep.c:5632
  [<ffffffff8563221e>] rcu_lock_acquire+0x2e/0x40 include/linux/rcupdate.h:306
  [<ffffffff8561464d>] rcu_read_lock include/linux/rcupdate.h:747 [inline]
  [<ffffffff8561464d>] ip6_pol_route+0x15d/0x1440 net/ipv6/route.c:2221
  [<ffffffff85618120>] ip6_pol_route_output+0x50/0x80 net/ipv6/route.c:2606
  [<ffffffff856f65b5>] pol_lookup_func include/net/ip6_fib.h:584 [inline]
  [<ffffffff856f65b5>] fib6_rule_lookup+0x265/0x620 net/ipv6/fib6_rules.c:116
  [<ffffffff85618009>] ip6_route_output_flags_noref+0x2d9/0x3a0 net/ipv6/route.c:2638
  [<ffffffff8561821a>] ip6_route_output_flags+0xca/0x340 net/ipv6/route.c:2651
  [<ffffffff838bd5a3>] ip6_route_output include/net/ip6_route.h:100 [inline]
  [<ffffffff838bd5a3>] ipvlan_process_v6_outbound drivers/net/ipvlan/ipvlan_core.c:473 [inline]
  [<ffffffff838bd5a3>] ipvlan_process_outbound drivers/net/ipvlan/ipvlan_core.c:529 [inline]
  [<ffffffff838bd5a3>] ipvlan_xmit_mode_l3 drivers/net/ipvlan/ipvlan_core.c:602 [inline]
  [<ffffffff838bd5a3>] ipvlan_queue_xmit+0xc33/0x1be0 drivers/net/ipvlan/ipvlan_core.c:677
  [<ffffffff838c2909>] ipvlan_start_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan_main.c:229
  [<ffffffff84d03900>] netdev_start_xmit include/linux/netdevice.h:4966 [inline]
  [<ffffffff84d03900>] xmit_one net/core/dev.c:3644 [inline]
  [<ffffffff84d03900>] dev_hard_start_xmit+0x320/0x980 net/core/dev.c:3660
  [<ffffffff84d080e2>] __dev_queue_xmit+0x16b2/0x3370 net/core/dev.c:4324
  [<ffffffff855ce4cd>] dev_queue_xmit include/linux/netdevice.h:3067 [inline]
  [<ffffffff855ce4cd>] neigh_hh_output include/net/neighbour.h:529 [inline]
  [<ffffffff855ce4cd>] neigh_output include/net/neighbour.h:543 [inline]
  [<ffffffff855ce4cd>] ip6_finish_output2+0x160d/0x1ae0 net/ipv6/ip6_output.c:139
  [<ffffffff855b8616>] __ip6_finish_output net/ipv6/ip6_output.c:200 [inline]
  [<ffffffff855b8616>] ip6_finish_output+0x6c6/0xb10 net/ipv6/ip6_output.c:211
  [<ffffffff855b7e3c>] NF_HOOK_COND include/linux/netfilter.h:298 [inline]
  [<ffffffff855b7e3c>] ip6_output+0x2bc/0x3d0 net/ipv6/ip6_output.c:232
  [<ffffffff8575d27f>] dst_output include/net/dst.h:444 [inline]
  [<ffffffff8575d27f>] ip6_local_out+0x10f/0x140 net/ipv6/output_core.c:161
  [<ffffffff838bdae4>] ipvlan_process_v6_outbound drivers/net/ipvlan/ipvlan_core.c:483 [inline]
  [<ffffffff838bdae4>] ipvlan_process_outbound drivers/net/ipvlan/ipvlan_core.c:529 [inline]
  [<ffffffff838bdae4>] ipvlan_xmit_mode_l3 drivers/net/ipvlan/ipvlan_core.c:602 [inline]
  [<ffffffff838bdae4>] ipvlan_queue_xmit+0x1174/0x1be0 drivers/net/ipvlan/ipvlan_core.c:677
  [<ffffffff838c2909>] ipvlan_start_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan_main.c:229
  [<ffffffff84d03900>] netdev_start_xmit include/linux/netdevice.h:4966 [inline]
  [<ffffffff84d03900>] xmit_one net/core/dev.c:3644 [inline]
  [<ffffffff84d03900>] dev_hard_start_xmit+0x320/0x980 net/core/dev.c:3660
  [<ffffffff84d080e2>] __dev_queue_xmit+0x16b2/0x3370 net/core/dev.c:4324
  [<ffffffff855ce4cd>] dev_queue_xmit include/linux/netdevice.h:3067 [inline]
  [<ffffffff855ce4cd>] neigh_hh_output include/net/neighbour.h:529 [inline]
  [<ffffffff855ce4cd>] neigh_output include/net/neighbour.h:543 [inline]
  [<ffffffff855ce4cd>] ip6_finish_output2+0x160d/0x1ae0 net/ipv6/ip6_output.c:139
  [<ffffffff855b8616>] __ip6_finish_output net/ipv6/ip6_output.c:200 [inline]
  [<ffffffff855b8616>] ip6_finish_output+0x6c6/0xb10 net/ipv6/ip6_output.c:211
  [<ffffffff855b7e3c>] NF_HOOK_COND include/linux/netfilter.h:298 [inline]
  [<ffffffff855b7e3c>] ip6_output+0x2bc/0x3d0 net/ipv6/ip6_output.c:232
  [<ffffffff8575d27f>] dst_output include/net/dst.h:444 [inline]
  [<ffffffff8575d27f>] ip6_local_out+0x10f/0x140 net/ipv6/output_core.c:161
  [<ffffffff838bdae4>] ipvlan_process_v6_outbound drivers/net/ipvlan/ipvlan_core.c:483 [inline]
  [<ffffffff838bdae4>] ipvlan_process_outbound drivers/net/ipvlan/ipvlan_core.c:529 [inline]
  [<ffffffff838bdae4>] ipvlan_xmit_mode_l3 drivers/net/ipvlan/ipvlan_core.c:602 [inline]
  [<ffffffff838bdae4>] ipvlan_queue_xmit+0x1174/0x1be0 drivers/net/ipvlan/ipvlan_core.c:677
  [<ffffffff838c2909>] ipvlan_start_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan_main.c:229
  [<ffffffff84d03900>] netdev_start_xmit include/linux/netdevice.h:4966 [inline]
  [<ffffffff84d03900>] xmit_one net/core/dev.c:3644 [inline]
  [<ffffffff84d03900>] dev_hard_start_xmit+0x320/0x980 net/core/dev.c:3660
  [<ffffffff84d080e2>] __dev_queue_xmit+0x16b2/0x3370 net/core/dev.c:4324
  [<ffffffff855ce4cd>] dev_queue_xmit include/linux/netdevice.h:3067 [inline]
  [<ffffffff855ce4cd>] neigh_hh_output include/net/neighbour.h:529 [inline]
  [<ffffffff855ce4cd>] neigh_output include/net/neighbour.h:543 [inline]
  [<ffffffff855ce4cd>] ip6_finish_output2+0x160d/0x1ae0 net/ipv6/ip6_output.c:139
  [<ffffffff855b8616>] __ip6_finish_output net/ipv6/ip6_output.c:200 [inline]
  [<ffffffff855b8616>] ip6_finish_output+0x6c6/0xb10 net/ipv6/ip6_output.c:211
  [<ffffffff855b7e3c>] NF_HOOK_COND include/linux/netfilter.h:298 [inline]
  [<ffffffff855b7e3c>] ip6_output+0x2bc/0x3d0 net/ipv6/ip6_output.c:232
  [<ffffffff8575d27f>] dst_output include/net/dst.h:444 [inline]
  [<ffffffff8575d27f>] ip6_local_out+0x10f/0x140 net/ipv6/output_core.c:161
  [<ffffffff838bdae4>] ipvlan_process_v6_outbound drivers/net/ipvlan/ipvlan_core.c:483 [inline]
  [<ffffffff838bdae4>] ipvlan_process_outbound drivers/net/ipvlan/ipvlan_core.c:529 [inline]
  [<ffffffff838bdae4>] ipvlan_xmit_mode_l3 drivers/net/ipvlan/ipvlan_core.c:602 [inline]
  [<ffffffff838bdae4>] ipvlan_queue_xmit+0x1174/0x1be0 drivers/net/ipvlan/ipvlan_core.c:677
  [<ffffffff838c2909>] ipvlan_start_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan_main.c:229
  [<ffffffff84d03900>] netdev_start_xmit include/linux/netdevice.h:4966 [inline]
  [<ffffffff84d03900>] xmit_one net/core/dev.c:3644 [inline]
  [<ffffffff84d03900>] dev_hard_start_xmit+0x320/0x980 net/core/dev.c:3660
  [<ffffffff84d080e2>] __dev_queue_xmit+0x16b2/0x3370 net/core/dev.c:4324
  [<ffffffff855ce4cd>] dev_queue_xmit include/linux/netdevice.h:3067 [inline]
  [<ffffffff855ce4cd>] neigh_hh_output include/net/neighbour.h:529 [inline]
  [<ffffffff855ce4cd>] neigh_output include/net/neighbour.h:543 [inline]
  [<ffffffff855ce4cd>] ip6_finish_output2+0x160d/0x1ae0 net/ipv6/ip6_output.c:139
  [<ffffffff855b8616>] __ip6_finish_output net/ipv6/ip6_output.c:200 [inline]
  [<ffffffff855b8616>] ip6_finish_output+0x6c6/0xb10 net/ipv6/ip6_output.c:211
  [<ffffffff855b7e3c>] NF_HOOK_COND include/linux/netfilter.h:298 [inline]
  [<ffffffff855b7e3c>] ip6_output+0x2bc/0x3d0 net/ipv6/ip6_output.c:232
  [<ffffffff8575d27f>] dst_output include/net/dst.h:444 [inline]
  [<ffffffff8575d27f>] ip6_local_out+0x10f/0x140 net/ipv6/output_core.c:161
  [<ffffffff838bdae4>] ipvlan_process_v6_outbound drivers/net/ipvlan/ipvlan_core.c:483 [inline]
  [<ffffffff838bdae4>] ipvlan_process_outbound drivers/net/ipvlan/ipvlan_core.c:529 [inline]
  [<ffffffff838bdae4>] ipvlan_xmit_mode_l3 drivers/net/ipvlan/ipvlan_core.c:602 [inline]
  [<ffffffff838bdae4>] ipvlan_queue_xmit+0x1174/0x1be0 drivers/net/ipvlan/ipvlan_core.c:677
  [<ffffffff838c2909>] ipvlan_start_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan_main.c:229
  [<ffffffff84d03900>] netdev_start_xmit include/linux/netdevice.h:4966 [inline]
  [<ffffffff84d03900>] xmit_one net/core/dev.c:3644 [inline]
  [<ffffffff84d03900>] dev_hard_start_xmit+0x320/0x980 net/core/dev.c:3660
  [<ffffffff84d080e2>] __dev_queue_xmit+0x16b2/0x3370 net/core/dev.c:4324
  [<ffffffff84d4a65e>] dev_queue_xmit include/linux/netdevice.h:3067 [inline]
  [<ffffffff84d4a65e>] neigh_resolve_output+0x64e/0x750 net/core/neighbour.c:1560
  [<ffffffff855ce503>] neigh_output include/net/neighbour.h:545 [inline]
  [<ffffffff855ce503>] ip6_finish_output2+0x1643/0x1ae0 net/ipv6/ip6_output.c:139
  [<ffffffff855b8616>] __ip6_finish_output net/ipv6/ip6_output.c:200 [inline]
  [<ffffffff855b8616>] ip6_finish_output+0x6c6/0xb10 net/ipv6/ip6_output.c:211
  [<ffffffff855b7e3c>] NF_HOOK_COND include/linux/netfilter.h:298 [inline]
  [<ffffffff855b7e3c>] ip6_output+0x2bc/0x3d0 net/ipv6/ip6_output.c:232
  [<ffffffff855b9ce4>] dst_output include/net/dst.h:444 [inline]
  [<ffffffff855b9ce4>] NF_HOOK include/linux/netfilter.h:309 [inline]
  [<ffffffff855b9ce4>] ip6_xmit+0x11a4/0x1b20 net/ipv6/ip6_output.c:352
  [<ffffffff8597984e>] sctp_v6_xmit+0x9ae/0x1230 net/sctp/ipv6.c:250
  [<ffffffff8594623e>] sctp_packet_transmit+0x25de/0x2bc0 net/sctp/output.c:653
  [<ffffffff858f5142>] sctp_packet_singleton+0x202/0x310 net/sctp/outqueue.c:783
  [<ffffffff858ea411>] sctp_outq_flush_ctrl net/sctp/outqueue.c:914 [inline]
  [<ffffffff858ea411>] sctp_outq_flush+0x661/0x3d40 net/sctp/outqueue.c:1212
  [<ffffffff858f02f9>] sctp_outq_uncork+0x79/0xb0 net/sctp/outqueue.c:764
  [<ffffffff8589f060>] sctp_side_effects net/sctp/sm_sideeffect.c:1199 [inline]
  [<ffffffff8589f060>] sctp_do_sm+0x55c0/0x5c30 net/sctp/sm_sideeffect.c:1170
  [<ffffffff85941567>] sctp_primitive_ASSOCIATE+0x97/0xc0 net/sctp/primitive.c:73
  [<ffffffff859408b2>] sctp_sendmsg_to_asoc+0xf62/0x17b0 net/sctp/socket.c:1839
  [<ffffffff85910b5e>] sctp_sendmsg+0x212e/0x33b0 net/sctp/socket.c:2029
  [<ffffffff8544d559>] inet_sendmsg+0x149/0x310 net/ipv4/af_inet.c:849
  [<ffffffff84c6c4d2>] sock_sendmsg_nosec net/socket.c:716 [inline]
  [<ffffffff84c6c4d2>] sock_sendmsg net/socket.c:736 [inline]
  [<ffffffff84c6c4d2>] ____sys_sendmsg+0x572/0x8c0 net/socket.c:2504
  [<ffffffff84c6ca91>] ___sys_sendmsg net/socket.c:2558 [inline]
  [<ffffffff84c6ca91>] __sys_sendmsg+0x271/0x360 net/socket.c:2587
  [<ffffffff84c6cbff>] __do_sys_sendmsg net/socket.c:2596 [inline]
  [<ffffffff84c6cbff>] __se_sys_sendmsg net/socket.c:2594 [inline]
  [<ffffffff84c6cbff>] __x64_sys_sendmsg+0x7f/0x90 net/socket.c:2594
  [<ffffffff85b32553>] do_syscall_x64 arch/x86/entry/common.c:51 [inline]
  [<ffffffff85b32553>] do_syscall_64+0x53/0x80 arch/x86/entry/common.c:84
  [<ffffffff85c00087>] entry_SYSCALL_64_after_hwframe+0x63/0xcd
- Gfs2: Silence "suspicious RCU usage in gfs2_permission" warning.
  [Andreas Gruenbacher]

  [ Upstream commit 074d7306a4fe22fcac0b53f699f92757ab1cee99 ]

  Commit 0abd1557e21c added rcu_dereference() for dereferencing ip->i_gl
  in gfs2_permission.  This now causes lockdep to complain when
  gfs2_permission is called in non-RCU context:

      WARNING: suspicious RCU usage in gfs2_permission

  Switch to rcu_dereference_check() and check for the MAY_NOT_BLOCK flag
  to shut up lockdep when we know that dereferencing ip->i_gl is safe.
- SUNRPC: Fix RPC client cleaned up the freed pipefs dentries. [felix]

  [ Upstream commit bfca5fb4e97c46503ddfc582335917b0cc228264 ]

  RPC client pipefs dentries cleanup is in separated rpc_remove_pipedir()
  workqueue,which takes care about pipefs superblock locking.
  In some special scenarios, when kernel frees the pipefs sb of the
  current client and immediately alloctes a new pipefs sb,
  rpc_remove_pipedir function would misjudge the existence of pipefs
  sb which is not the one it used to hold. As a result,
  the rpc_remove_pipedir would clean the released freed pipefs dentries.

  To fix this issue, rpc_remove_pipedir should check whether the
  current pipefs sb is consistent with the original pipefs sb.

  This error can be catched by KASAN:
  =========================================================
  [  250.497700] BUG: KASAN: slab-use-after-free in dget_parent+0x195/0x200
  [  250.498315] Read of size 4 at addr ffff88800a2ab804 by task kworker/0:18/106503
  [  250.500549] Workqueue: events rpc_free_client_work
  [  250.501001] Call Trace:
  [  250.502880]  kasan_report+0xb6/0xf0
  [  250.503209]  ? dget_parent+0x195/0x200
  [  250.503561]  dget_parent+0x195/0x200
  [  250.503897]  ? __pfx_rpc_clntdir_depopulate+0x10/0x10
  [  250.504384]  rpc_rmdir_depopulate+0x1b/0x90
  [  250.504781]  rpc_remove_client_dir+0xf5/0x150
  [  250.505195]  rpc_free_client_work+0xe4/0x230
  [  250.505598]  process_one_work+0x8ee/0x13b0
  ...
  [   22.039056] Allocated by task 244:
  [   22.039390]  kasan_save_stack+0x22/0x50
  [   22.039758]  kasan_set_track+0x25/0x30
  [   22.040109]  __kasan_slab_alloc+0x59/0x70
  [   22.040487]  kmem_cache_alloc_lru+0xf0/0x240
  [   22.040889]  __d_alloc+0x31/0x8e0
  [   22.041207]  d_alloc+0x44/0x1f0
  [   22.041514]  __rpc_lookup_create_exclusive+0x11c/0x140
  [   22.041987]  rpc_mkdir_populate.constprop.0+0x5f/0x110
  [   22.042459]  rpc_create_client_dir+0x34/0x150
  [   22.042874]  rpc_setup_pipedir_sb+0x102/0x1c0
  [   22.043284]  rpc_client_register+0x136/0x4e0
  [   22.043689]  rpc_new_client+0x911/0x1020
  [   22.044057]  rpc_create_xprt+0xcb/0x370
  [   22.044417]  rpc_create+0x36b/0x6c0
  ...
  [   22.049524] Freed by task 0:
  [   22.049803]  kasan_save_stack+0x22/0x50
  [   22.050165]  kasan_set_track+0x25/0x30
  [   22.050520]  kasan_save_free_info+0x2b/0x50
  [   22.050921]  __kasan_slab_free+0x10e/0x1a0
  [   22.051306]  kmem_cache_free+0xa5/0x390
  [   22.051667]  rcu_core+0x62c/0x1930
  [   22.051995]  __do_softirq+0x165/0x52a
  [   22.052347]
  [   22.052503] Last potentially related work creation:
  [   22.052952]  kasan_save_stack+0x22/0x50
  [   22.053313]  __kasan_record_aux_stack+0x8e/0xa0
  [   22.053739]  __call_rcu_common.constprop.0+0x6b/0x8b0
  [   22.054209]  dentry_free+0xb2/0x140
  [   22.054540]  __dentry_kill+0x3be/0x540
  [   22.054900]  shrink_dentry_list+0x199/0x510
  [   22.055293]  shrink_dcache_parent+0x190/0x240
  [   22.055703]  do_one_tree+0x11/0x40
  [   22.056028]  shrink_dcache_for_umount+0x61/0x140
  [   22.056461]  generic_shutdown_super+0x70/0x590
  [   22.056879]  kill_anon_super+0x3a/0x60
  [   22.057234]  rpc_kill_sb+0x121/0x200
- NFSv4.1: fix SP4_MACH_CRED protection for pnfs IO. [Olga Kornievskaia]

  [ Upstream commit 5cc7688bae7f0757c39c1d3dfdd827b724061067 ]

  If the client is doing pnfs IO and Kerberos is configured and EXCHANGEID
  successfully negotiated SP4_MACH_CRED and WRITE/COMMIT are on the
  list of state protected operations, then we need to make sure to
  choose the DS's rpc_client structure instead of the MDS's one.
- SUNRPC: Add an IS_ERR() check back to where it was. [Dan Carpenter]

  [ Upstream commit 4f3ed837186fc0d2722ba8d2457a594322e9c2ef ]

  This IS_ERR() check was deleted during in a cleanup because, at the time,
  the rpcb_call_async() function could not return an error pointer.  That
  changed in commit 25cf32ad5dba ("SUNRPC: Handle allocation failure in
  rpc_new_task()") and now it can return an error pointer.  Put the check
  back.

  A related revert was done in commit 13bd90141804 ("Revert "SUNRPC:
  Remove unreachable error condition"").
- SUNRPC: ECONNRESET might require a rebind. [Trond Myklebust]

  [ Upstream commit 4b09ca1508a60be30b2e3940264e93d7aeb5c97e ]

  If connect() is returning ECONNRESET, it usually means that nothing is
  listening on that port. If so, a rebind might be required in order to
  obtain the new port on which the RPC service is listening.
- Xhci: turn cancelled td cleanup to its own function. [Mathias Nyman]

  [ Upstream commit 4db356924a50f72a00834ae04f11202d9703faeb ]

  Refactor handler for stop endpoint command completion. Yank out the part
  that invalidates cancelled TDs and turn it into a separate function.

  Invalidating cancelled TDs should be done while the ring is stopped,
  but not exclusively in the stop endpoint command completeion handler.

  We will need to invalidate TDs after resetting endpoints as well.
- Wifi: iwlwifi: Use FW rate for non-data frames. [Miri Korenblit]

  [ Upstream commit 499d02790495958506a64f37ceda7e97345a50a8 ]

  Currently we are setting the rate in the tx cmd for
  mgmt frames (e.g. during connection establishment).
  This was problematic when sending mgmt frames in eSR mode,
  as we don't know what link this frame will be sent on
  (This is decided by the FW), so we don't know what is the
  lowest rate.
  Fix this by not setting the rate in tx cmd and rely
  on FW to choose the right one.
  Set rate only for injected frames with fixed rate,
  or when no sta is given.
  Also set for important frames (EAPOL etc.) the High Priority flag.
- Pwm: Fix double shift bug. [Dan Carpenter]

  [ Upstream commit d27abbfd4888d79dd24baf50e774631046ac4732 ]

  These enums are passed to set/test_bit().  The set/test_bit() functions
  take a bit number instead of a shifted value.  Passing a shifted value
  is a double shift bug like doing BIT(BIT(1)).  The double shift bug
  doesn't cause a problem here because we are only checking 0 and 1 but
  if the value was 5 or above then it can lead to a buffer overflow.
- Drm/amdgpu: fix software pci_unplug on some chips. [Vitaly Prosyak]

  [ Upstream commit 4638e0c29a3f2294d5de0d052a4b8c9f33ccb957 ]

  When software 'pci unplug' using IGT is executed we got a sysfs directory
  entry is NULL for differant ras blocks like hdp, umc, etc.
  Before call 'sysfs_remove_file_from_group' and 'sysfs_remove_group'
  check that 'sd' is  not NULL.

  [  +0.000001] RIP: 0010:sysfs_remove_group+0x83/0x90
  [  +0.000002] Code: 31 c0 31 d2 31 f6 31 ff e9 9a a8 b4 00 4c 89 e7 e8 f2 a2 ff ff eb c2 49 8b 55 00 48 8b 33 48 c7 c7 80 65 94 82 e8 cd 82 bb ff <0f> 0b eb cc 66 0f 1f 84 00 00 00 00 00 90 90 90 90 90 90 90 90 90
  [  +0.000001] RSP: 0018:ffffc90002067c90 EFLAGS: 00010246
  [  +0.000002] RAX: 0000000000000000 RBX: ffffffff824ea180 RCX: 0000000000000000
  [  +0.000001] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
  [  +0.000001] RBP: ffffc90002067ca8 R08: 0000000000000000 R09: 0000000000000000
  [  +0.000001] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
  [  +0.000001] R13: ffff88810a395f48 R14: ffff888101aab0d0 R15: 0000000000000000
  [  +0.000001] FS:  00007f5ddaa43a00(0000) GS:ffff88841e800000(0000) knlGS:0000000000000000
  [  +0.000002] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [  +0.000001] CR2: 00007f8ffa61ba50 CR3: 0000000106432000 CR4: 0000000000350ef0
  [  +0.000001] Call Trace:
  [  +0.000001]  <TASK>
  [  +0.000001]  ? show_regs+0x72/0x90
  [  +0.000002]  ? sysfs_remove_group+0x83/0x90
  [  +0.000002]  ? __warn+0x8d/0x160
  [  +0.000001]  ? sysfs_remove_group+0x83/0x90
  [  +0.000001]  ? report_bug+0x1bb/0x1d0
  [  +0.000003]  ? handle_bug+0x46/0x90
  [  +0.000001]  ? exc_invalid_op+0x19/0x80
  [  +0.000002]  ? asm_exc_invalid_op+0x1b/0x20
  [  +0.000003]  ? sysfs_remove_group+0x83/0x90
  [  +0.000001]  dpm_sysfs_remove+0x61/0x70
  [  +0.000002]  device_del+0xa3/0x3d0
  [  +0.000002]  ? ktime_get_mono_fast_ns+0x46/0xb0
  [  +0.000002]  device_unregister+0x18/0x70
  [  +0.000001]  i2c_del_adapter+0x26d/0x330
  [  +0.000002]  arcturus_i2c_control_fini+0x25/0x50 [amdgpu]
  [  +0.000236]  smu_sw_fini+0x38/0x260 [amdgpu]
  [  +0.000241]  amdgpu_device_fini_sw+0x116/0x670 [amdgpu]
  [  +0.000186]  ? mutex_lock+0x13/0x50
  [  +0.000003]  amdgpu_driver_release_kms+0x16/0x40 [amdgpu]
  [  +0.000192]  drm_minor_release+0x4f/0x80 [drm]
  [  +0.000025]  drm_release+0xfe/0x150 [drm]
  [  +0.000027]  __fput+0x9f/0x290
  [  +0.000002]  ____fput+0xe/0x20
  [  +0.000002]  task_work_run+0x61/0xa0
  [  +0.000002]  exit_to_user_mode_prepare+0x150/0x170
  [  +0.000002]  syscall_exit_to_user_mode+0x2a/0x50
- ASoC: ti: omap-mcbsp: Fix runtime PM underflow warnings. [Tony
  Lindgren]

  [ Upstream commit fbb74e56378d8306f214658e3d525a8b3f000c5a ]

  We need to check for an active device as otherwise we get warnings
  for some mcbsp instances for "Runtime PM usage count underflow!".
- Kgdb: Flush console before entering kgdb on panic. [Douglas Anderson]

  [ Upstream commit dd712d3d45807db9fcae28a522deee85c1f2fde6 ]

  When entering kdb/kgdb on a kernel panic, it was be observed that the
  console isn't flushed before the `kdb` prompt came up. Specifically,
  when using the buddy lockup detector on arm64 and running:
    echo HARDLOCKUP > /sys/kernel/debug/provoke-crash/DIRECT

  I could see:
    [   26.161099] lkdtm: Performing direct entry HARDLOCKUP
    [   32.499881] watchdog: Watchdog detected hard LOCKUP on cpu 6
    [   32.552865] Sending NMI from CPU 5 to CPUs 6:
    [   32.557359] NMI backtrace for cpu 6
    ... [backtrace for cpu 6] ...
    [   32.558353] NMI backtrace for cpu 5
    ... [backtrace for cpu 5] ...
    [   32.867471] Sending NMI from CPU 5 to CPUs 0-4,7:
    [   32.872321] NMI backtrace forP cpuANC: Hard LOCKUP

    Entering kdb (current=..., pid 0) on processor 5 due to Keyboard Entry
    [5]kdb>

  As you can see, backtraces for the other CPUs start printing and get
  interleaved with the kdb PANIC print.

  Let's replicate the commands to flush the console in the kdb panic
  entry point to avoid this.
- Drm/amd/display: Avoid NULL dereference of timing generator. [Wayne
  Lin]

  [ Upstream commit b1904ed480cee3f9f4036ea0e36d139cb5fee2d6 ]

  [Why & How]
  Check whether assigned timing generator is NULL or not before
  accessing its funcs to prevent NULL dereference.
- Media: imon: fix access to invalid resource for the second interface.
  [Takashi Iwai]

  [ Upstream commit a1766a4fd83befa0b34d932d532e7ebb7fab1fa7 ]

  imon driver probes two USB interfaces, and at the probe of the second
  interface, the driver assumes blindly that the first interface got
  bound with the same imon driver.  It's usually true, but it's still
  possible that the first interface is bound with another driver via a
  malformed descriptor.  Then it may lead to a memory corruption, as
  spotted by syzkaller; imon driver accesses the data from drvdata as
  struct imon_context object although it's a completely different one
  that was assigned by another driver.

  This patch adds a sanity check -- whether the first interface is
  really bound with the imon driver or not -- for avoiding the problem
  above at the probe time.
- Media: cobalt: Use FIELD_GET() to extract Link Width. [Ilpo Järvinen]

  [ Upstream commit f301fedbeecfdce91cb898d6fa5e62f269801fee ]

  Use FIELD_GET() to extract PCIe Negotiated and Maximum Link Width fields
  instead of custom masking and shifting.
- Gfs2: fix an oops in gfs2_permission. [Al Viro]

  [ Upstream commit 0abd1557e21c617bd13fc18f7725fc6363c05913 ]

  In RCU mode, we might race with gfs2_evict_inode(), which zeroes
  ->i_gl.  Freeing of the object it points to is RCU-delayed, so
  if we manage to fetch the pointer before it's been replaced with
  NULL, we are fine.  Check if we'd fetched NULL and treat that
  as "bail out and tell the caller to get out of RCU mode".
- Gfs2: ignore negated quota changes. [Bob Peterson]

  [ Upstream commit 4c6a08125f2249531ec01783a5f4317d7342add5 ]

  When lots of quota changes are made, there may be cases in which an
  inode's quota information is increased and then decreased, such as when
  blocks are added to a file, then deleted from it. If the timing is
  right, function do_qc can add pending quota changes to a transaction,
  then later, another call to do_qc can negate those changes, resulting
  in a net gain of 0. The quota_change information is recorded in the qc
  buffer (and qd element of the inode as well). The buffer is added to the
  transaction by the first call to do_qc, but a subsequent call changes
  the value from non-zero back to zero. At that point it's too late to
  remove the buffer_head from the transaction. Later, when the quota sync
  code is called, the zero-change qd element is discovered and flagged as
  an assert warning. If the fs is mounted with errors=panic, the kernel
  will panic.

  This is usually seen when files are truncated and the quota changes are
  negated by punch_hole/truncate which uses gfs2_quota_hold and
  gfs2_quota_unhold rather than block allocations that use gfs2_quota_lock
  and gfs2_quota_unlock which automatically do quota sync.

  This patch solves the problem by adding a check to qd_check_sync such
  that net-zero quota changes already added to the transaction are no
  longer deemed necessary to be synced, and skipped.

  In this case references are taken for the qd and the slot from do_qc
  so those need to be put. The normal sequence of events for a normal
  non-zero quota change is as follows:

  gfs2_quota_change
     do_qc
        qd_hold
        slot_hold

  Later, when the changes are to be synced:

  gfs2_quota_sync
     qd_fish
        qd_check_sync
           gets qd ref via lockref_get_not_dead
     do_sync
        do_qc(QC_SYNC)
           qd_put
  	    lockref_put_or_lock
     qd_unlock
        qd_put
           lockref_put_or_lock

  In the net-zero change case, we add a check to qd_check_sync so it puts
  the qd and slot references acquired in gfs2_quota_change and skip the
  unneeded sync.
- Media: vivid: avoid integer overflow. [Hans Verkuil]

  [ Upstream commit 4567ebf8e8f9546b373e78e3b7d584cc30b62028 ]

  Fixes these compiler warnings:

  drivers/media/test-drivers/vivid/vivid-rds-gen.c: In function 'vivid_rds_gen_fill':
  drivers/media/test-drivers/vivid/vivid-rds-gen.c:147:56: warning: '.' directive output may be truncated writing 1 byte into a region of size between 0 and 3 [-Wformat-truncation=]
    147 |         snprintf(rds->psname, sizeof(rds->psname), "%6d.%1d",
        |                                                        ^
  drivers/media/test-drivers/vivid/vivid-rds-gen.c:147:52: note: directive argument in the range [0, 9]
    147 |         snprintf(rds->psname, sizeof(rds->psname), "%6d.%1d",
        |                                                    ^~~~~~~~~
  drivers/media/test-drivers/vivid/vivid-rds-gen.c:147:9: note: 'snprintf' output between 9 and 12 bytes into a destination of size 9
    147 |         snprintf(rds->psname, sizeof(rds->psname), "%6d.%1d",
        |         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    148 |                  freq / 16, ((freq & 0xf) * 10) / 16);
        |                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Media: gspca: cpia1: shift-out-of-bounds in set_flicker. [Rajeshwar R
  Shinde]

  [ Upstream commit 099be1822d1f095433f4b08af9cc9d6308ec1953 ]

  Syzkaller reported the following issue:
  UBSAN: shift-out-of-bounds in drivers/media/usb/gspca/cpia1.c:1031:27
  shift exponent 245 is too large for 32-bit type 'int'

  When the value of the variable "sd->params.exposure.gain" exceeds the
  number of bits in an integer, a shift-out-of-bounds error is reported. It
  is triggered because the variable "currentexp" cannot be left-shifted by
  more than the number of bits in an integer. In order to avoid invalid
  range during left-shift, the conditional expression is added.
- I2c: sun6i-p2wi: Prevent potential division by zero. [Axel Lin]

  [ Upstream commit 5ac61d26b8baff5b2e5a9f3dc1ef63297e4b53e7 ]

  Make sure we don't OOPS in case clock-frequency is set to 0 in a DT. The
  variable set here is later used as a divisor.
- 9p/trans_fd: Annotate data-racy writes to file::f_flags. [Marco Elver]

  [ Upstream commit 355f074609dbf3042900ea9d30fcd2b0c323a365 ]

  syzbot reported:

   | BUG: KCSAN: data-race in p9_fd_create / p9_fd_create
   |
   | read-write to 0xffff888130fb3d48 of 4 bytes by task 15599 on cpu 0:
   |  p9_fd_open net/9p/trans_fd.c:842 [inline]
   |  p9_fd_create+0x210/0x250 net/9p/trans_fd.c:1092
   |  p9_client_create+0x595/0xa70 net/9p/client.c:1010
   |  v9fs_session_init+0xf9/0xd90 fs/9p/v9fs.c:410
   |  v9fs_mount+0x69/0x630 fs/9p/vfs_super.c:123
   |  legacy_get_tree+0x74/0xd0 fs/fs_context.c:611
   |  vfs_get_tree+0x51/0x190 fs/super.c:1519
   |  do_new_mount+0x203/0x660 fs/namespace.c:3335
   |  path_mount+0x496/0xb30 fs/namespace.c:3662
   |  do_mount fs/namespace.c:3675 [inline]
   |  __do_sys_mount fs/namespace.c:3884 [inline]
   |  [...]
   |
   | read-write to 0xffff888130fb3d48 of 4 bytes by task 15563 on cpu 1:
   |  p9_fd_open net/9p/trans_fd.c:842 [inline]
   |  p9_fd_create+0x210/0x250 net/9p/trans_fd.c:1092
   |  p9_client_create+0x595/0xa70 net/9p/client.c:1010
   |  v9fs_session_init+0xf9/0xd90 fs/9p/v9fs.c:410
   |  v9fs_mount+0x69/0x630 fs/9p/vfs_super.c:123
   |  legacy_get_tree+0x74/0xd0 fs/fs_context.c:611
   |  vfs_get_tree+0x51/0x190 fs/super.c:1519
   |  do_new_mount+0x203/0x660 fs/namespace.c:3335
   |  path_mount+0x496/0xb30 fs/namespace.c:3662
   |  do_mount fs/namespace.c:3675 [inline]
   |  __do_sys_mount fs/namespace.c:3884 [inline]
   |  [...]
   |
   | value changed: 0x00008002 -> 0x00008802

  Within p9_fd_open(), O_NONBLOCK is added to f_flags of the read and
  write files. This may happen concurrently if e.g. mounting process
  modifies the fd in another thread.

  Mark the plain read-modify-writes as intentional data-races, with the
  assumption that the result of executing the accesses concurrently will
  always result in the same result despite the accesses themselves not
  being atomic.
- Usb: gadget: f_ncm: Always set current gadget in ncm_bind() [Hardik
  Gajjar]

  [ Upstream commit a04224da1f3424b2c607b12a3bd1f0e302fb8231 ]

  Previously, gadget assignment to the net device occurred exclusively
  during the initial binding attempt.

  Nevertheless, the gadget pointer could change during bind/unbind
  cycles due to various conditions, including the unloading/loading
  of the UDC device driver or the detachment/reconnection of an
  OTG-capable USB hub device.

  This patch relocates the gether_set_gadget() function out from
  ncm_opts->bound condition check, ensuring that the correct gadget
  is assigned during each bind request.

  The provided logs demonstrate the consistency of ncm_opts throughout
  the power cycle, while the gadget may change.

  * OTG hub connected during boot up and assignment of gadget and
    ncm_opts pointer

  [    2.366301] usb 2-1.5: New USB device found, idVendor=2996, idProduct=0105
  [    2.366304] usb 2-1.5: New USB device strings: Mfr=1, Product=2, SerialNumber=3
  [    2.366306] usb 2-1.5: Product: H2H Bridge
  [    2.366308] usb 2-1.5: Manufacturer: Aptiv
  [    2.366309] usb 2-1.5: SerialNumber: 13FEB2021
  [    2.427989] usb 2-1.5: New USB device found, VID=2996, PID=0105
  [    2.428959] dabridge 2-1.5:1.0: dabridge 2-4 total endpoints=5, 0000000093a8d681
  [    2.429710] dabridge 2-1.5:1.0: P(0105) D(22.06.22) F(17.3.16) H(1.1) high-speed
  [    2.429714] dabridge 2-1.5:1.0: Hub 2-2 P(0151) V(06.87)
  [    2.429956] dabridge 2-1.5:1.0: All downstream ports in host mode

  [    2.430093] gadget 000000003c414d59 ------> gadget pointer

  * NCM opts and associated gadget pointer during First ncm_bind

  [   34.763929] NCM opts 00000000aa304ac9
  [   34.763930] NCM gadget 000000003c414d59

  * OTG capable hub disconnecte or assume driver unload.

  [   97.203114] usb 2-1: USB disconnect, device number 2
  [   97.203118] usb 2-1.1: USB disconnect, device number 3
  [   97.209217] usb 2-1.5: USB disconnect, device number 4
  [   97.230990] dabr_udc deleted

  * Reconnect the OTG hub or load driver assaign new gadget pointer.

  [  111.534035] usb 2-1.1: New USB device found, idVendor=2996, idProduct=0120, bcdDevice= 6.87
  [  111.534038] usb 2-1.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
  [  111.534040] usb 2-1.1: Product: Vendor
  [  111.534041] usb 2-1.1: Manufacturer: Aptiv
  [  111.534042] usb 2-1.1: SerialNumber: Superior
  [  111.535175] usb 2-1.1: New USB device found, VID=2996, PID=0120
  [  111.610995] usb 2-1.5: new high-speed USB device number 8 using xhci-hcd
  [  111.630052] usb 2-1.5: New USB device found, idVendor=2996, idProduct=0105, bcdDevice=21.02
  [  111.630055] usb 2-1.5: New USB device strings: Mfr=1, Product=2, SerialNumber=3
  [  111.630057] usb 2-1.5: Product: H2H Bridge
  [  111.630058] usb 2-1.5: Manufacturer: Aptiv
  [  111.630059] usb 2-1.5: SerialNumber: 13FEB2021
  [  111.687464] usb 2-1.5: New USB device found, VID=2996, PID=0105
  [  111.690375] dabridge 2-1.5:1.0: dabridge 2-8 total endpoints=5, 000000000d87c961
  [  111.691172] dabridge 2-1.5:1.0: P(0105) D(22.06.22) F(17.3.16) H(1.1) high-speed
  [  111.691176] dabridge 2-1.5:1.0: Hub 2-6 P(0151) V(06.87)
  [  111.691646] dabridge 2-1.5:1.0: All downstream ports in host mode

  [  111.692298] gadget 00000000dc72f7a9 --------> new gadget ptr on connect

  * NCM opts and associated gadget pointer during second ncm_bind

  [  113.271786] NCM opts 00000000aa304ac9 -----> same opts ptr used during first bind
  [  113.271788] NCM gadget 00000000dc72f7a9 ----> however new gaget ptr, that will not set
                                                   in net_device due to ncm_opts->bound = true
- Tty: vcc: Add check for kstrdup() in vcc_probe() [Yi Yang]

  [ Upstream commit d81ffb87aaa75f842cd7aa57091810353755b3e6 ]

  Add check for the return value of kstrdup() and return the error, if it
  fails in order to avoid NULL pointer dereference.
- Exfat: support handle zero-size directory. [Yuezhang Mo]

  [ Upstream commit dab48b8f2fe7264d51ec9eed0adea0fe3c78830a ]

  After repairing a corrupted file system with exfatprogs' fsck.exfat,
  zero-size directories may result. It is also possible to create
  zero-size directories in other exFAT implementation, such as Paragon
  ufsd dirver.

  As described in the specification, the lower directory size limits
  is 0 bytes.

  Without this commit, sub-directories and files cannot be created
  under a zero-size directory, and it cannot be removed.
- HID: Add quirk for Dell Pro Wireless Keyboard and Mouse KM5221W. [Jiri
  Kosina]

  [ Upstream commit 62cc9c3cb3ec1bf31cc116146185ed97b450836a ]

  This device needs ALWAYS_POLL quirk, otherwise it keeps reconnecting
  indefinitely.
- Misc: pci_endpoint_test: Add Device ID for R-Car S4-8 PCIe controller.
  [Yoshihiro Shimoda]

  [ Upstream commit 6c4b39937f4e65688ea294725ae432b2565821ff ]

  Add Renesas R8A779F0 in pci_device_id table so that pci-epf-test
  can be used for testing PCIe EP on R-Car S4-8.
- Scsi: libfc: Fix potential NULL pointer dereference in
  fc_lport_ptp_setup() [Wenchao Hao]

  [ Upstream commit 4df105f0ce9f6f30cda4e99f577150d23f0c9c5f ]

  fc_lport_ptp_setup() did not check the return value of fc_rport_create()
  which can return NULL and would cause a NULL pointer dereference. Address
  this issue by checking return value of fc_rport_create() and log error
  message on fc_rport_create() failed.
- Atm: iphase: Do PCI error checks on own line. [Ilpo Järvinen]

  [ Upstream commit c28742447ca9879b52fbaf022ad844f0ffcd749c ]

  In get_esi() PCI errors are checked inside line-split "if" conditions (in
  addition to the file not following the coding style). To make the code in
  get_esi() more readable, fix the coding style and use the usual error
  handling pattern with a separate variable.

  In addition, initialization of 'error' variable at declaration is not
  needed.

  No functional changes intended.
- PCI: tegra194: Use FIELD_GET()/FIELD_PREP() with Link Width fields.
  [Ilpo Järvinen]

  [ Upstream commit 759574abd78e3b47ec45bbd31a64e8832cf73f97 ]

  Use FIELD_GET() to extract PCIe Negotiated Link Width field instead of
  custom masking and shifting.

  Similarly, change custom code that misleadingly used
  PCI_EXP_LNKSTA_NLW_SHIFT to prepare value for PCI_EXP_LNKCAP write
  to use FIELD_PREP() with correct field define (PCI_EXP_LNKCAP_MLW).
- ALSA: hda: Fix possible null-ptr-deref when assigning a stream.
  [Cezary Rojewski]

  [ Upstream commit f93dc90c2e8ed664985e366aa6459ac83cdab236 ]

  While AudioDSP drivers assign streams exclusively of HOST or LINK type,
  nothing blocks a user to attempt to assign a COUPLED stream. As
  supplied substream instance may be a stub, what is the case when
  code-loading, such scenario ends with null-ptr-deref.
- ARM: 9320/1: fix stack depot IRQ stack filter. [Vincent Whitchurch]

  [ Upstream commit b0150014878c32197cfa66e3e2f79e57f66babc0 ]

  Place IRQ handlers such as gic_handle_irq() in the irqentry section even
  if FUNCTION_GRAPH_TRACER is not enabled.  Without this, the stack
  depot's filter_irq_stacks() does not correctly filter out IRQ stacks in
  those configurations, which hampers deduplication and eventually leads
  to "Stack depot reached limit capacity" splats with KASAN.

  A similar fix was done for arm64 in commit f6794950f0e5ba37e3bbed
  ("arm64: set __exception_irq_entry with __irq_entry as a default").
- HID: lenovo: Detect quirk-free fw on cptkbd and stop applying
  workaround. [Mikhail Khvainitski]

  [ Upstream commit 46a0a2c96f0f47628190f122c2e3d879e590bcbe ]

  Built-in firmware of cptkbd handles scrolling by itself (when middle
  button is pressed) but with issues: it does not support horizontal and
  hi-res scrolling and upon middle button release it sends middle button
  click even if there was a scrolling event. Commit 3cb5ff0220e3 ("HID:
  lenovo: Hide middle-button press until release") workarounds last
  issue but it's impossible to workaround scrolling-related issues
  without firmware modification.

  Likely, Dennis Schneider has reverse engineered the firmware and
  provided an instruction on how to patch it [1]. However,
  aforementioned workaround prevents userspace (libinput) from knowing
  exact moment when middle button has been pressed down and performing
  "On-Button scrolling". This commit detects correctly-behaving patched
  firmware if cursor movement events has been received during middle
  button being pressed and stops applying workaround for this device.
- Jfs: fix array-index-out-of-bounds in diAlloc. [Manas Ghandat]

  [ Upstream commit 05d9ea1ceb62a55af6727a69269a4fd310edf483 ]

  Currently there is not check against the agno of the iag while
  allocating new inodes to avoid fragmentation problem. Added the check
  which is required.
- Jfs: fix array-index-out-of-bounds in dbFindLeaf. [Manas Ghandat]

  [ Upstream commit 22cad8bc1d36547cdae0eef316c47d917ce3147c ]

  Currently while searching for dmtree_t for sufficient free blocks there
  is an array out of bounds while getting element in tp->dm_stree. To add
  the required check for out of bound we first need to determine the type
  of dmtree. Thus added an extra parameter to dbFindLeaf so that the type
  of tree can be determined and the required check can be applied.
- Fs/jfs: Add validity check for db_maxag and db_agpref. [Juntong Deng]

  [ Upstream commit 64933ab7b04881c6c18b21ff206c12278341c72e ]

  Both db_maxag and db_agpref are used as the index of the
  db_agfree array, but there is currently no validity check for
  db_maxag and db_agpref, which can lead to errors.

  The following is related bug reported by Syzbot:

  UBSAN: array-index-out-of-bounds in fs/jfs/jfs_dmap.c:639:20
  index 7936 is out of range for type 'atomic_t[128]'

  Add checking that the values of db_maxag and db_agpref are valid
  indexes for the db_agfree array.
- Fs/jfs: Add check for negative db_l2nbperpage. [Juntong Deng]

  [ Upstream commit 525b861a008143048535011f3816d407940f4bfa ]

  l2nbperpage is log2(number of blks per page), and the minimum legal
  value should be 0, not negative.

  In the case of l2nbperpage being negative, an error will occur
  when subsequently used as shift exponent.

  Syzbot reported this bug:

  UBSAN: shift-out-of-bounds in fs/jfs/jfs_dmap.c:799:12
  shift exponent -16777216 is negative
- RDMA/hfi1: Use FIELD_GET() to extract Link Width. [Ilpo Järvinen]

  [ Upstream commit 8bf7187d978610b9e327a3d92728c8864a575ebd ]

  Use FIELD_GET() to extract PCIe Negotiated Link Width field instead of
  custom masking and shifting, and remove extract_width() which only
  wraps that FIELD_GET().
- Crypto: pcrypt - Fix hungtask for PADATA_RESET. [Lu Jialin]

  [ Upstream commit 8f4f68e788c3a7a696546291258bfa5fdb215523 ]

  We found a hungtask bug in test_aead_vec_cfg as follows:

  INFO: task cryptomgr_test:391009 blocked for more than 120 seconds.
  "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
  Call trace:
   __switch_to+0x98/0xe0
   __schedule+0x6c4/0xf40
   schedule+0xd8/0x1b4
   schedule_timeout+0x474/0x560
   wait_for_common+0x368/0x4e0
   wait_for_completion+0x20/0x30
   wait_for_completion+0x20/0x30
   test_aead_vec_cfg+0xab4/0xd50
   test_aead+0x144/0x1f0
   alg_test_aead+0xd8/0x1e0
   alg_test+0x634/0x890
   cryptomgr_test+0x40/0x70
   kthread+0x1e0/0x220
   ret_from_fork+0x10/0x18
   Kernel panic - not syncing: hung_task: blocked tasks

  For padata_do_parallel, when the return err is 0 or -EBUSY, it will call
  wait_for_completion(&wait->completion) in test_aead_vec_cfg. In normal
  case, aead_request_complete() will be called in pcrypt_aead_serial and the
  return err is 0 for padata_do_parallel. But, when pinst->flags is
  PADATA_RESET, the return err is -EBUSY for padata_do_parallel, and it
  won't call aead_request_complete(). Therefore, test_aead_vec_cfg will
  hung at wait_for_completion(&wait->completion), which will cause
  hungtask.

  The problem comes as following:
  (padata_do_parallel)                 |
      rcu_read_lock_bh();              |
      err = -EINVAL;                   |   (padata_replace)
                                       |     pinst->flags |= PADATA_RESET;
      err = -EBUSY                     |
      if (pinst->flags & PADATA_RESET) |
          rcu_read_unlock_bh()         |
          return err

  In order to resolve the problem, we replace the return err -EBUSY with
  -EAGAIN, which means parallel_data is changing, and the caller should call
  it again.

  v3:
  remove retry and just change the return err.
  v2:
  introduce padata_try_do_parallel() in pcrypt_aead_encrypt and
  pcrypt_aead_decrypt to solve the hungtask.
- ASoC: soc-card: Add storage for PCI SSID. [Richard Fitzgerald]

  [ Upstream commit 47f56e38a199bd45514b8e0142399cba4feeaf1a ]

  Add members to struct snd_soc_card to store the PCI subsystem ID (SSID)
  of the soundcard.

  The PCI specification provides two registers to store a vendor-specific
  SSID that can be read by drivers to uniquely identify a particular
  "soundcard". This is defined in the PCI specification to distinguish
  products that use the same silicon (and therefore have the same silicon
  ID) so that product-specific differences can be applied.

  PCI only defines 0xFFFF as an invalid value. 0x0000 is not defined as
  invalid. So the usual pattern of zero-filling the struct and then
  assuming a zero value unset will not work. A flag is included to
  indicate when the SSID information has been filled in.

  Unlike DMI information, which has a free-format entirely up to the vendor,
  the PCI SSID has a strictly defined format and a registry of vendor IDs.

  It is usual in Windows drivers that the SSID is used as the sole identifier
  of the specific end-product and the Windows driver contains tables mapping
  that to information about the hardware setup, rather than using ACPI
  properties.

  This SSID is important information for ASoC components that need to apply
  hardware-specific configuration on PCI-based systems.

  As the SSID is a generic part of the PCI specification and is treated as
  identifying the "soundcard", it is reasonable to include this information
  in struct snd_soc_card, instead of components inventing their own custom
  ways to pass this information around.
- Selftests/efivarfs: create-read: fix a resource leak. [zhujun2]

  [ Upstream commit 3f6f8a8c5e11a9b384a36df4f40f0c9a653b6975 ]

  The opened file should be closed in main(), otherwise resource
  leak will occur that this problem was discovered by code reading
- Drm/amdgpu: Fix a null pointer access when the smc_rreg pointer is
  NULL. [Qu Huang]

  [ Upstream commit 5104fdf50d326db2c1a994f8b35dcd46e63ae4ad ]

  In certain types of chips, such as VEGA20, reading the amdgpu_regs_smc file could result in an abnormal null pointer access when the smc_rreg pointer is NULL. Below are the steps to reproduce this issue and the corresponding exception log:

  1. Navigate to the directory: /sys/kernel/debug/dri/0
  2. Execute command: cat amdgpu_regs_smc
  3. Exception Log::
  [4005007.702554] BUG: kernel NULL pointer dereference, address: 0000000000000000
  [4005007.702562] #PF: supervisor instruction fetch in kernel mode
  [4005007.702567] #PF: error_code(0x0010) - not-present page
  [4005007.702570] PGD 0 P4D 0
  [4005007.702576] Oops: 0010 [#1] SMP NOPTI
  [4005007.702581] CPU: 4 PID: 62563 Comm: cat Tainted: G           OE     5.15.0-43-generic #46-Ubunt       u
  [4005007.702590] RIP: 0010:0x0
  [4005007.702598] Code: Unable to access opcode bytes at RIP 0xffffffffffffffd6.
  [4005007.702600] RSP: 0018:ffffa82b46d27da0 EFLAGS: 00010206
  [4005007.702605] RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffa82b46d27e68
  [4005007.702609] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff9940656e0000
  [4005007.702612] RBP: ffffa82b46d27dd8 R08: 0000000000000000 R09: ffff994060c07980
  [4005007.702615] R10: 0000000000020000 R11: 0000000000000000 R12: 00007f5e06753000
  [4005007.702618] R13: ffff9940656e0000 R14: ffffa82b46d27e68 R15: 00007f5e06753000
  [4005007.702622] FS:  00007f5e0755b740(0000) GS:ffff99479d300000(0000) knlGS:0000000000000000
  [4005007.702626] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [4005007.702629] CR2: ffffffffffffffd6 CR3: 00000003253fc000 CR4: 00000000003506e0
  [4005007.702633] Call Trace:
  [4005007.702636]  <TASK>
  [4005007.702640]  amdgpu_debugfs_regs_smc_read+0xb0/0x120 [amdgpu]
  [4005007.703002]  full_proxy_read+0x5c/0x80
  [4005007.703011]  vfs_read+0x9f/0x1a0
  [4005007.703019]  ksys_read+0x67/0xe0
  [4005007.703023]  __x64_sys_read+0x19/0x20
  [4005007.703028]  do_syscall_64+0x5c/0xc0
  [4005007.703034]  ? do_user_addr_fault+0x1e3/0x670
  [4005007.703040]  ? exit_to_user_mode_prepare+0x37/0xb0
  [4005007.703047]  ? irqentry_exit_to_user_mode+0x9/0x20
  [4005007.703052]  ? irqentry_exit+0x19/0x30
  [4005007.703057]  ? exc_page_fault+0x89/0x160
  [4005007.703062]  ? asm_exc_page_fault+0x8/0x30
  [4005007.703068]  entry_SYSCALL_64_after_hwframe+0x44/0xae
  [4005007.703075] RIP: 0033:0x7f5e07672992
  [4005007.703079] Code: c0 e9 b2 fe ff ff 50 48 8d 3d fa b2 0c 00 e8 c5 1d 02 00 0f 1f 44 00 00 f3 0f        1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 0f 05 <48> 3d 00 f0 ff ff 77 56 c3 0f 1f 44 00 00 48 83 e       c 28 48 89 54 24
  [4005007.703083] RSP: 002b:00007ffe03097898 EFLAGS: 00000246 ORIG_RAX: 0000000000000000
  [4005007.703088] RAX: ffffffffffffffda RBX: 0000000000020000 RCX: 00007f5e07672992
  [4005007.703091] RDX: 0000000000020000 RSI: 00007f5e06753000 RDI: 0000000000000003
  [4005007.703094] RBP: 00007f5e06753000 R08: 00007f5e06752010 R09: 00007f5e06752010
  [4005007.703096] R10: 0000000000000022 R11: 0000000000000246 R12: 0000000000022000
  [4005007.703099] R13: 0000000000000003 R14: 0000000000020000 R15: 0000000000020000
  [4005007.703105]  </TASK>
  [4005007.703107] Modules linked in: nf_tables libcrc32c nfnetlink algif_hash af_alg binfmt_misc nls_       iso8859_1 ipmi_ssif ast intel_rapl_msr intel_rapl_common drm_vram_helper drm_ttm_helper amd64_edac t       tm edac_mce_amd kvm_amd ccp mac_hid k10temp kvm acpi_ipmi ipmi_si rapl sch_fq_codel ipmi_devintf ipm       i_msghandler msr parport_pc ppdev lp parport mtd pstore_blk efi_pstore ramoops pstore_zone reed_solo       mon ip_tables x_tables autofs4 ib_uverbs ib_core amdgpu(OE) amddrm_ttm_helper(OE) amdttm(OE) iommu_v       2 amd_sched(OE) amdkcl(OE) drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops cec rc_core        drm igb ahci xhci_pci libahci i2c_piix4 i2c_algo_bit xhci_pci_renesas dca
  [4005007.703184] CR2: 0000000000000000
  [4005007.703188] ---[ end trace ac65a538d240da39 ]---
  [4005007.800865] RIP: 0010:0x0
  [4005007.800871] Code: Unable to access opcode bytes at RIP 0xffffffffffffffd6.
  [4005007.800874] RSP: 0018:ffffa82b46d27da0 EFLAGS: 00010206
  [4005007.800878] RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffa82b46d27e68
  [4005007.800881] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff9940656e0000
  [4005007.800883] RBP: ffffa82b46d27dd8 R08: 0000000000000000 R09: ffff994060c07980
  [4005007.800886] R10: 0000000000020000 R11: 0000000000000000 R12: 00007f5e06753000
  [4005007.800888] R13: ffff9940656e0000 R14: ffffa82b46d27e68 R15: 00007f5e06753000
  [4005007.800891] FS:  00007f5e0755b740(0000) GS:ffff99479d300000(0000) knlGS:0000000000000000
  [4005007.800895] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [4005007.800898] CR2: ffffffffffffffd6 CR3: 00000003253fc000 CR4: 00000000003506e0
- Drm/panel: st7703: Pick different reset sequence. [Ondrej Jirman]

  [ Upstream commit d12d635bb03c7cb4830acb641eb176ee9ff2aa89 ]

  Switching to a different reset sequence, enabling IOVCC before enabling
  VCC.

  There also needs to be a delay after enabling the supplies and before
  deasserting the reset. The datasheet specifies 1ms after the supplies
  reach the required voltage. Use 10-20ms to also give the power supplies
  some time to reach the required voltage, too.

  This fixes intermittent panel initialization failures and screen
  corruption during resume from sleep on panel xingbangda,xbd599 (e.g.
  used in PinePhone).
- Drm/panel/panel-tpo-tpg110: fix a possible null pointer dereference.
  [Ma Ke]

  [ Upstream commit f22def5970c423ea7f87d5247bd0ef91416b0658 ]

  In tpg110_get_modes(), the return value of drm_mode_duplicate() is
  assigned to mode, which will lead to a NULL pointer dereference on
  failure of drm_mode_duplicate(). Add a check to avoid npd.
- Drm/panel: fix a possible null pointer dereference. [Ma Ke]

  [ Upstream commit 924e5814d1f84e6fa5cb19c6eceb69f066225229 ]

  In versatile_panel_get_modes(), the return value of drm_mode_duplicate()
  is assigned to mode, which will lead to a NULL pointer dereference
  on failure of drm_mode_duplicate(). Add a check to avoid npd.
- Drm/amdgpu: Fix potential null pointer derefernce. [Stanley.Yang]

  [ Upstream commit 80285ae1ec8717b597b20de38866c29d84d321a1 ]

  The amdgpu_ras_get_context may return NULL if device
  not support ras feature, so add check before using.
- Drm/amd: Fix UBSAN array-index-out-of-bounds for Polaris and Tonga.
  [Mario Limonciello]

  [ Upstream commit 0f0e59075b5c22f1e871fbd508d6e4f495048356 ]

  For pptable structs that use flexible array sizes, use flexible arrays.
- Drm/amd: Fix UBSAN array-index-out-of-bounds for SMU7. [Mario
  Limonciello]

  [ Upstream commit 760efbca74a405dc439a013a5efaa9fadc95a8c3 ]

  For pptable structs that use flexible array sizes, use flexible arrays.
- Drm/msm/dp: skip validity check for DP CTS EDID checksum. [Jani
  Nikula]

  [ Upstream commit a251c9d8e30833b260101edb9383b176ee2b7cb1 ]

  The DP CTS test for EDID last block checksum expects the checksum for
  the last block, invalid or not. Skip the validity check.

  For the most part (*), the EDIDs returned by drm_get_edid() will be
  valid anyway, and there's the CTS workaround to get the checksum for
  completely invalid EDIDs. See commit 7948fe12d47a ("drm/msm/dp: return
  correct edid checksum after corrupted edid checksum read").

  This lets us remove one user of drm_edid_block_valid() with hopes the
  function can be removed altogether in the future.

  (*) drm_get_edid() ignores checksum errors on CTA extensions.
- Drm/komeda: drop all currently held locks if deadlock happens.
  [baozhu.liu]

  [ Upstream commit 19ecbe8325a2a7ffda5ff4790955b84eaccba49f ]

  If komeda_pipeline_unbound_components() returns -EDEADLK,
  it means that a deadlock happened in the locking context.
  Currently, komeda is not dealing with the deadlock properly,producing the
  following output when CONFIG_DEBUG_WW_MUTEX_SLOWPATH is enabled:

   ------------[ cut here ]------------
  [   26.103984] WARNING: CPU: 2 PID: 345 at drivers/gpu/drm/arm/display/komeda/komeda_pipeline_state.c:1248
  	       komeda_release_unclaimed_resources+0x13c/0x170
  [   26.117453] Modules linked in:
  [   26.120511] CPU: 2 PID: 345 Comm: composer@2.1-se Kdump: loaded Tainted: G   W  5.10.110-SE-SDK1.8-dirty #16
  [   26.131374] Hardware name: Siengine Se1000 Evaluation board (DT)
  [   26.137379] pstate: 20400009 (nzCv daif +PAN -UAO -TCO BTYPE=--)
  [   26.143385] pc : komeda_release_unclaimed_resources+0x13c/0x170
  [   26.149301] lr : komeda_release_unclaimed_resources+0xbc/0x170
  [   26.155130] sp : ffff800017b8b8d0
  [   26.158442] pmr_save: 000000e0
  [   26.161493] x29: ffff800017b8b8d0 x28: ffff000cf2f96200
  [   26.166805] x27: ffff000c8f5a8800 x26: 0000000000000000
  [   26.172116] x25: 0000000000000038 x24: ffff8000116a0140
  [   26.177428] x23: 0000000000000038 x22: ffff000cf2f96200
  [   26.182739] x21: ffff000cfc300300 x20: ffff000c8ab77080
  [   26.188051] x19: 0000000000000003 x18: 0000000000000000
  [   26.193362] x17: 0000000000000000 x16: 0000000000000000
  [   26.198672] x15: b400e638f738ba38 x14: 0000000000000000
  [   26.203983] x13: 0000000106400a00 x12: 0000000000000000
  [   26.209294] x11: 0000000000000000 x10: 0000000000000000
  [   26.214604] x9 : ffff800012f80000 x8 : ffff000ca3308000
  [   26.219915] x7 : 0000000ff3000000 x6 : ffff80001084034c
  [   26.225226] x5 : ffff800017b8bc40 x4 : 000000000000000f
  [   26.230536] x3 : ffff000ca3308000 x2 : 0000000000000000
  [   26.235847] x1 : 0000000000000000 x0 : ffffffffffffffdd
  [   26.241158] Call trace:
  [   26.243604] komeda_release_unclaimed_resources+0x13c/0x170
  [   26.249175] komeda_crtc_atomic_check+0x68/0xf0
  [   26.253706] drm_atomic_helper_check_planes+0x138/0x1f4
  [   26.258929] komeda_kms_check+0x284/0x36c
  [   26.262939] drm_atomic_check_only+0x40c/0x714
  [   26.267381] drm_atomic_nonblocking_commit+0x1c/0x60
  [   26.272344] drm_mode_atomic_ioctl+0xa3c/0xb8c
  [   26.276787] drm_ioctl_kernel+0xc4/0x120
  [   26.280708] drm_ioctl+0x268/0x534
  [   26.284109] __arm64_sys_ioctl+0xa8/0xf0
  [   26.288030] el0_svc_common.constprop.0+0x80/0x240
  [   26.292817] do_el0_svc+0x24/0x90
  [   26.296132] el0_svc+0x20/0x30
  [   26.299185] el0_sync_handler+0xe8/0xf0
  [   26.303018] el0_sync+0x1a4/0x1c0
  [   26.306330] irq event stamp: 0
  [   26.309384] hardirqs last  enabled at (0): [<0000000000000000>] 0x0
  [   26.315650] hardirqs last disabled at (0): [<ffff800010056d34>] copy_process+0x5d0/0x183c
  [   26.323825] softirqs last  enabled at (0): [<ffff800010056d34>] copy_process+0x5d0/0x183c
  [   26.331997] softirqs last disabled at (0): [<0000000000000000>] 0x0
  [   26.338261] ---[ end trace 20ae984fa860184a ]---
  [   26.343021] ------------[ cut here ]------------
  [   26.347646] WARNING: CPU: 3 PID: 345 at drivers/gpu/drm/drm_modeset_lock.c:228 drm_modeset_drop_locks+0x84/0x90
  [   26.357727] Modules linked in:
  [   26.360783] CPU: 3 PID: 345 Comm: composer@2.1-se Kdump: loaded Tainted: G   W  5.10.110-SE-SDK1.8-dirty #16
  [   26.371645] Hardware name: Siengine Se1000 Evaluation board (DT)
  [   26.377647] pstate: 20400009 (nzCv daif +PAN -UAO -TCO BTYPE=--)
  [   26.383649] pc : drm_modeset_drop_locks+0x84/0x90
  [   26.388351] lr : drm_mode_atomic_ioctl+0x860/0xb8c
  [   26.393137] sp : ffff800017b8bb10
  [   26.396447] pmr_save: 000000e0
  [   26.399497] x29: ffff800017b8bb10 x28: 0000000000000001
  [   26.404807] x27: 0000000000000038 x26: 0000000000000002
  [   26.410115] x25: ffff000cecbefa00 x24: ffff000cf2f96200
  [   26.415423] x23: 0000000000000001 x22: 0000000000000018
  [   26.420731] x21: 0000000000000001 x20: ffff800017b8bc10
  [   26.426039] x19: 0000000000000000 x18: 0000000000000000
  [   26.431347] x17: 0000000002e8bf2c x16: 0000000002e94c6b
  [   26.436655] x15: 0000000002ea48b9 x14: ffff8000121f0300
  [   26.441963] x13: 0000000002ee2ca8 x12: ffff80001129cae0
  [   26.447272] x11: ffff800012435000 x10: ffff000ed46b5e88
  [   26.452580] x9 : ffff000c9935e600 x8 : 0000000000000000
  [   26.457888] x7 : 000000008020001e x6 : 000000008020001f
  [   26.463196] x5 : ffff80001085fbe0 x4 : fffffe0033a59f20
  [   26.468504] x3 : 000000008020001e x2 : 0000000000000000
  [   26.473813] x1 : 0000000000000000 x0 : ffff000c8f596090
  [   26.479122] Call trace:
  [   26.481566] drm_modeset_drop_locks+0x84/0x90
  [   26.485918] drm_mode_atomic_ioctl+0x860/0xb8c
  [   26.490359] drm_ioctl_kernel+0xc4/0x120
  [   26.494278] drm_ioctl+0x268/0x534
  [   26.497677] __arm64_sys_ioctl+0xa8/0xf0
  [   26.501598] el0_svc_common.constprop.0+0x80/0x240
  [   26.506384] do_el0_svc+0x24/0x90
  [   26.509697] el0_svc+0x20/0x30
  [   26.512748] el0_sync_handler+0xe8/0xf0
  [   26.516580] el0_sync+0x1a4/0x1c0
  [   26.519891] irq event stamp: 0
  [   26.522943] hardirqs last  enabled at (0): [<0000000000000000>] 0x0
  [   26.529207] hardirqs last disabled at (0): [<ffff800010056d34>] copy_process+0x5d0/0x183c
  [   26.537379] softirqs last  enabled at (0): [<ffff800010056d34>] copy_process+0x5d0/0x183c
  [   26.545550] softirqs last disabled at (0): [<0000000000000000>] 0x0
  [   26.551812] ---[ end trace 20ae984fa860184b ]---

  According to the call trace information,it can be located to be
  WARN_ON(IS_ERR(c_st)) in the komeda_pipeline_unbound_components function;
  Then follow the function.
  komeda_pipeline_unbound_components
  -> komeda_component_get_state_and_set_user
    -> komeda_pipeline_get_state_and_set_crtc
      -> komeda_pipeline_get_state
        ->drm_atomic_get_private_obj_state
          -> drm_atomic_get_private_obj_state
            -> drm_modeset_lock

  komeda_pipeline_unbound_components
  -> komeda_component_get_state_and_set_user
    -> komeda_component_get_state
      -> drm_atomic_get_private_obj_state
       -> drm_modeset_lock

  ret = drm_modeset_lock(&obj->lock, state->acquire_ctx); if (ret)
  	return ERR_PTR(ret);
  Here it return -EDEADLK.

  deal with the deadlock as suggested by [1], using the
  function drm_modeset_backoff().
  [1] https://docs.kernel.org/gpu/drm-kms.html?highlight=kms#kms-locking

  Therefore, handling this problem can be solved
  by adding return -EDEADLK back to the drm_modeset_backoff processing flow
  in the drm_mode_atomic_ioctl function.
- Platform/x86: thinkpad_acpi: Add battery quirk for Thinkpad X120e.
  [Olli Asikainen]

  [ Upstream commit 916646758aea81a143ce89103910f715ed923346 ]

  Thinkpad X120e also needs this battery quirk.
- Bluetooth: Fix double free in hci_conn_cleanup. [ZhengHan Wang]

  [ Upstream commit a85fb91e3d728bdfc80833167e8162cce8bc7004 ]

  syzbot reports a slab use-after-free in hci_conn_hash_flush [1].
  After releasing an object using hci_conn_del_sysfs in the
  hci_conn_cleanup function, releasing the same object again
  using the hci_dev_put and hci_conn_put functions causes a double free.
  Here's a simplified flow:

  hci_conn_del_sysfs:
    hci_dev_put
      put_device
        kobject_put
          kref_put
            kobject_release
              kobject_cleanup
                kfree_const
                  kfree(name)

  hci_dev_put:
    ...
      kfree(name)

  hci_conn_put:
    put_device
      ...
        kfree(name)

  This patch drop the hci_dev_put and hci_conn_put function
  call in hci_conn_cleanup function, because the object is
  freed in hci_conn_del_sysfs function.

  This patch also fixes the refcounting in hci_conn_add_sysfs() and
  hci_conn_del_sysfs() to take into account device_add() failures.

  This fixes CVE-2023-28464.
- Bluetooth: btusb: Add date->evt_skb is NULL check. [youwan Wang]

  [ Upstream commit 624820f7c8826dd010e8b1963303c145f99816e9 ]

  fix crash because of null pointers

  [ 6104.969662] BUG: kernel NULL pointer dereference, address: 00000000000000c8
  [ 6104.969667] #PF: supervisor read access in kernel mode
  [ 6104.969668] #PF: error_code(0x0000) - not-present page
  [ 6104.969670] PGD 0 P4D 0
  [ 6104.969673] Oops: 0000 [#1] SMP NOPTI
  [ 6104.969684] RIP: 0010:btusb_mtk_hci_wmt_sync+0x144/0x220 [btusb]
  [ 6104.969688] RSP: 0018:ffffb8d681533d48 EFLAGS: 00010246
  [ 6104.969689] RAX: 0000000000000000 RBX: ffff8ad560bb2000 RCX: 0000000000000006
  [ 6104.969691] RDX: 0000000000000000 RSI: ffffb8d681533d08 RDI: 0000000000000000
  [ 6104.969692] RBP: ffffb8d681533d70 R08: 0000000000000001 R09: 0000000000000001
  [ 6104.969694] R10: 0000000000000001 R11: 00000000fa83b2da R12: ffff8ad461d1d7c0
  [ 6104.969695] R13: 0000000000000000 R14: ffff8ad459618c18 R15: ffffb8d681533d90
  [ 6104.969697] FS:  00007f5a1cab9d40(0000) GS:ffff8ad578200000(0000) knlGS:00000
  [ 6104.969699] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [ 6104.969700] CR2: 00000000000000c8 CR3: 000000018620c001 CR4: 0000000000760ef0
  [ 6104.969701] PKRU: 55555554
  [ 6104.969702] Call Trace:
  [ 6104.969708]  btusb_mtk_shutdown+0x44/0x80 [btusb]
  [ 6104.969732]  hci_dev_do_close+0x470/0x5c0 [bluetooth]
  [ 6104.969748]  hci_rfkill_set_block+0x56/0xa0 [bluetooth]
  [ 6104.969753]  rfkill_set_block+0x92/0x160
  [ 6104.969755]  rfkill_fop_write+0x136/0x1e0
  [ 6104.969759]  __vfs_write+0x18/0x40
  [ 6104.969761]  vfs_write+0xdf/0x1c0
  [ 6104.969763]  ksys_write+0xb1/0xe0
  [ 6104.969765]  __x64_sys_write+0x1a/0x20
  [ 6104.969769]  do_syscall_64+0x51/0x180
  [ 6104.969771]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
  [ 6104.969773] RIP: 0033:0x7f5a21f18fef
  [ 6104.9] RSP: 002b:00007ffeefe39010 EFLAGS: 00000293 ORIG_RAX: 0000000000000001
  [ 6104.969780] RAX: ffffffffffffffda RBX: 000055c10a7560a0 RCX: 00007f5a21f18fef
  [ 6104.969781] RDX: 0000000000000008 RSI: 00007ffeefe39060 RDI: 0000000000000012
  [ 6104.969782] RBP: 00007ffeefe39060 R08: 0000000000000000 R09: 0000000000000017
  [ 6104.969784] R10: 00007ffeefe38d97 R11: 0000000000000293 R12: 0000000000000002
  [ 6104.969785] R13: 00007ffeefe39220 R14: 00007ffeefe391a0 R15: 000055c10a72acf0
- Wifi: ath10k: Don't touch the CE interrupt registers after power up.
  [Douglas Anderson]

  [ Upstream commit 170c75d43a77dc937c58f07ecf847ba1b42ab74e ]

  As talked about in commit d66d24ac300c ("ath10k: Keep track of which
  interrupts fired, don't poll them"), if we access the copy engine
  register at a bad time then ath10k can go boom. However, it's not
  necessarily easy to know when it's safe to access them.

  The ChromeOS test labs saw a crash that looked like this at
  shutdown/reboot time (on a chromeos-5.15 kernel, but likely the
  problem could also reproduce upstream):

  Internal error: synchronous external abort: 96000010 [#1] PREEMPT SMP
  ...
  CPU: 4 PID: 6168 Comm: reboot Not tainted 5.15.111-lockdep-19350-g1d624fe6758f #1 010b9b233ab055c27c6dc88efb0be2f4e9e86f51
  Hardware name: Google Kingoftown (DT)
  ...
  pc : ath10k_snoc_read32+0x50/0x74 [ath10k_snoc]
  lr : ath10k_snoc_read32+0x24/0x74 [ath10k_snoc]
  ...
  Call trace:
  ath10k_snoc_read32+0x50/0x74 [ath10k_snoc ...]
  ath10k_ce_disable_interrupt+0x190/0x65c [ath10k_core ...]
  ath10k_ce_disable_interrupts+0x8c/0x120 [ath10k_core ...]
  ath10k_snoc_hif_stop+0x78/0x660 [ath10k_snoc ...]
  ath10k_core_stop+0x13c/0x1ec [ath10k_core ...]
  ath10k_halt+0x398/0x5b0 [ath10k_core ...]
  ath10k_stop+0xfc/0x1a8 [ath10k_core ...]
  drv_stop+0x148/0x6b4 [mac80211 ...]
  ieee80211_stop_device+0x70/0x80 [mac80211 ...]
  ieee80211_do_stop+0x10d8/0x15b0 [mac80211 ...]
  ieee80211_stop+0x144/0x1a0 [mac80211 ...]
  __dev_close_many+0x1e8/0x2c0
  dev_close_many+0x198/0x33c
  dev_close+0x140/0x210
  cfg80211_shutdown_all_interfaces+0xc8/0x1e0 [cfg80211 ...]
  ieee80211_remove_interfaces+0x118/0x5c4 [mac80211 ...]
  ieee80211_unregister_hw+0x64/0x1f4 [mac80211 ...]
  ath10k_mac_unregister+0x4c/0xf0 [ath10k_core ...]
  ath10k_core_unregister+0x80/0xb0 [ath10k_core ...]
  ath10k_snoc_free_resources+0xb8/0x1ec [ath10k_snoc ...]
  ath10k_snoc_shutdown+0x98/0xd0 [ath10k_snoc ...]
  platform_shutdown+0x7c/0xa0
  device_shutdown+0x3e0/0x58c
  kernel_restart_prepare+0x68/0xa0
  kernel_restart+0x28/0x7c

  Though there's no known way to reproduce the problem, it makes sense
  that it would be the same issue where we're trying to access copy
  engine registers when it's not allowed.

  Let's fix this by changing how we "disable" the interrupts. Instead of
  tweaking the copy engine registers we'll just use disable_irq() and
  enable_irq(). Then we'll configure the interrupts once at power up
  time.
- Net: annotate data-races around sk->sk_dst_pending_confirm. [Eric
  Dumazet]

  [ Upstream commit eb44ad4e635132754bfbcb18103f1dcb7058aedd ]

  This field can be read or written without socket lock being held.

  Add annotations to avoid load-store tearing.
- Net: annotate data-races around sk->sk_tx_queue_mapping. [Eric
  Dumazet]

  [ Upstream commit 0bb4d124d34044179b42a769a0c76f389ae973b6 ]

  This field can be read or written without socket lock being held.

  Add annotations to avoid load-store tearing.
- Wifi: ath10k: fix clang-specific fortify warning. [Dmitry Antipov]

  [ Upstream commit cb4c132ebfeac5962f7258ffc831caa0c4dada1a ]

  When compiling with clang 16.0.6 and CONFIG_FORTIFY_SOURCE=y, I've
  noticed the following (somewhat confusing due to absence of an actual
  source code location):

  In file included from drivers/net/wireless/ath/ath10k/debug.c:8:
  In file included from ./include/linux/module.h:13:
  In file included from ./include/linux/stat.h:19:
  In file included from ./include/linux/time.h:60:
  In file included from ./include/linux/time32.h:13:
  In file included from ./include/linux/timex.h:67:
  In file included from ./arch/x86/include/asm/timex.h:5:
  In file included from ./arch/x86/include/asm/processor.h:23:
  In file included from ./arch/x86/include/asm/msr.h:11:
  In file included from ./arch/x86/include/asm/cpumask.h:5:
  In file included from ./include/linux/cpumask.h:12:
  In file included from ./include/linux/bitmap.h:11:
  In file included from ./include/linux/string.h:254:
  ./include/linux/fortify-string.h:592:4: warning: call to '__read_overflow2_field'
  declared with 'warning' attribute: detected read beyond size of field (2nd
  parameter); maybe use struct_group()? [-Wattribute-warning]
                          __read_overflow2_field(q_size_field, size);

  The compiler actually complains on 'ath10k_debug_get_et_strings()' where
  fortification logic inteprets call to 'memcpy()' as an attempt to copy
  the whole 'ath10k_gstrings_stats' array from it's first member and so
  issues an overread warning. This warning may be silenced by passing
  an address of the whole array and not the first member to 'memcpy()'.
- Wifi: ath9k: fix clang-specific fortify warnings. [Dmitry Antipov]

  [ Upstream commit 95f97fe0ac974467ab4da215985a32b2fdf48af0 ]

  When compiling with clang 16.0.6 and CONFIG_FORTIFY_SOURCE=y, I've
  noticed the following (somewhat confusing due to absence of an actual
  source code location):

  In file included from drivers/net/wireless/ath/ath9k/debug.c:17:
  In file included from ./include/linux/slab.h:16:
  In file included from ./include/linux/gfp.h:7:
  In file included from ./include/linux/mmzone.h:8:
  In file included from ./include/linux/spinlock.h:56:
  In file included from ./include/linux/preempt.h:79:
  In file included from ./arch/x86/include/asm/preempt.h:9:
  In file included from ./include/linux/thread_info.h:60:
  In file included from ./arch/x86/include/asm/thread_info.h:53:
  In file included from ./arch/x86/include/asm/cpufeature.h:5:
  In file included from ./arch/x86/include/asm/processor.h:23:
  In file included from ./arch/x86/include/asm/msr.h:11:
  In file included from ./arch/x86/include/asm/cpumask.h:5:
  In file included from ./include/linux/cpumask.h:12:
  In file included from ./include/linux/bitmap.h:11:
  In file included from ./include/linux/string.h:254:
  ./include/linux/fortify-string.h:592:4: warning: call to '__read_overflow2_field'
  declared with 'warning' attribute: detected read beyond size of field (2nd
  parameter); maybe use struct_group()? [-Wattribute-warning]
                          __read_overflow2_field(q_size_field, size);

  In file included from drivers/net/wireless/ath/ath9k/htc_drv_debug.c:17:
  In file included from drivers/net/wireless/ath/ath9k/htc.h:20:
  In file included from ./include/linux/module.h:13:
  In file included from ./include/linux/stat.h:19:
  In file included from ./include/linux/time.h:60:
  In file included from ./include/linux/time32.h:13:
  In file included from ./include/linux/timex.h:67:
  In file included from ./arch/x86/include/asm/timex.h:5:
  In file included from ./arch/x86/include/asm/processor.h:23:
  In file included from ./arch/x86/include/asm/msr.h:11:
  In file included from ./arch/x86/include/asm/cpumask.h:5:
  In file included from ./include/linux/cpumask.h:12:
  In file included from ./include/linux/bitmap.h:11:
  In file included from ./include/linux/string.h:254:
  ./include/linux/fortify-string.h:592:4: warning: call to '__read_overflow2_field'
  declared with 'warning' attribute: detected read beyond size of field (2nd
  parameter); maybe use struct_group()? [-Wattribute-warning]
                          __read_overflow2_field(q_size_field, size);

  The compiler actually complains on 'ath9k_get_et_strings()' and
  'ath9k_htc_get_et_strings()' due to the same reason: fortification logic
  inteprets call to 'memcpy()' as an attempt to copy the whole array from
  it's first member and so issues an overread warning. These warnings may
  be silenced by passing an address of the whole array and not the first
  member to 'memcpy()'.
- Bpf: Detect IP == ksym.end as part of BPF program. [Kumar Kartikeya
  Dwivedi]

  [ Upstream commit 66d9111f3517f85ef2af0337ece02683ce0faf21 ]

  Now that bpf_throw kfunc is the first such call instruction that has
  noreturn semantics within the verifier, this also kicks in dead code
  elimination in unprecedented ways. For one, any instruction following
  a bpf_throw call will never be marked as seen. Moreover, if a callchain
  ends up throwing, any instructions after the call instruction to the
  eventually throwing subprog in callers will also never be marked as
  seen.

  The tempting way to fix this would be to emit extra 'int3' instructions
  which bump the jited_len of a program, and ensure that during runtime
  when a program throws, we can discover its boundaries even if the call
  instruction to bpf_throw (or to subprogs that always throw) is emitted
  as the final instruction in the program.

  An example of such a program would be this:

  do_something():
  	...
  	r0 = 0
  	exit

  foo():
  	r1 = 0
  	call bpf_throw
  	r0 = 0
  	exit

  bar(cond):
  	if r1 != 0 goto pc+2
  	call do_something
  	exit
  	call foo
  	r0 = 0  // Never seen by verifier
  	exit	//

  main(ctx):
  	r1 = ...
  	call bar
  	r0 = 0
  	exit

  Here, if we do end up throwing, the stacktrace would be the following:

  bpf_throw
  foo
  bar
  main

  In bar, the final instruction emitted will be the call to foo, as such,
  the return address will be the subsequent instruction (which the JIT
  emits as int3 on x86). This will end up lying outside the jited_len of
  the program, thus, when unwinding, we will fail to discover the return
  address as belonging to any program and end up in a panic due to the
  unreliable stack unwinding of BPF programs that we never expect.

  To remedy this case, make bpf_prog_ksym_find treat IP == ksym.end as
  part of the BPF program, so that is_bpf_text_address returns true when
  such a case occurs, and we are able to unwind reliably when the final
  instruction ends up being a call instruction.
- Wifi: mac80211: don't return unset power in ieee80211_get_tx_power()
  [Ping-Ke Shih]

  [ Upstream commit e160ab85166e77347d0cbe5149045cb25e83937f ]

  We can get a UBSAN warning if ieee80211_get_tx_power() returns the
  INT_MIN value mac80211 internally uses for "unset power level".

   UBSAN: signed-integer-overflow in net/wireless/nl80211.c:3816:5
   -2147483648 * 100 cannot be represented in type 'int'
   CPU: 0 PID: 20433 Comm: insmod Tainted: G        WC OE
   Call Trace:
    dump_stack+0x74/0x92
    ubsan_epilogue+0x9/0x50
    handle_overflow+0x8d/0xd0
    __ubsan_handle_mul_overflow+0xe/0x10
    nl80211_send_iface+0x688/0x6b0 [cfg80211]
    [...]
    cfg80211_register_wdev+0x78/0xb0 [cfg80211]
    cfg80211_netdev_notifier_call+0x200/0x620 [cfg80211]
    [...]
    ieee80211_if_add+0x60e/0x8f0 [mac80211]
    ieee80211_register_hw+0xda5/0x1170 [mac80211]

  In this case, simply return an error instead, to indicate
  that no data is available.
- Wifi: mac80211_hwsim: fix clang-specific fortify warning. [Dmitry
  Antipov]

  [ Upstream commit cbaccdc42483c65016f1bae89128c08dc17cfb2a ]

  When compiling with clang 16.0.6 and CONFIG_FORTIFY_SOURCE=y, I've
  noticed the following (somewhat confusing due to absence of an actual
  source code location):

  In file included from drivers/net/wireless/virtual/mac80211_hwsim.c:18:
  In file included from ./include/linux/slab.h:16:
  In file included from ./include/linux/gfp.h:7:
  In file included from ./include/linux/mmzone.h:8:
  In file included from ./include/linux/spinlock.h:56:
  In file included from ./include/linux/preempt.h:79:
  In file included from ./arch/x86/include/asm/preempt.h:9:
  In file included from ./include/linux/thread_info.h:60:
  In file included from ./arch/x86/include/asm/thread_info.h:53:
  In file included from ./arch/x86/include/asm/cpufeature.h:5:
  In file included from ./arch/x86/include/asm/processor.h:23:
  In file included from ./arch/x86/include/asm/msr.h:11:
  In file included from ./arch/x86/include/asm/cpumask.h:5:
  In file included from ./include/linux/cpumask.h:12:
  In file included from ./include/linux/bitmap.h:11:
  In file included from ./include/linux/string.h:254:
  ./include/linux/fortify-string.h:592:4: warning: call to '__read_overflow2_field'
  declared with 'warning' attribute: detected read beyond size of field (2nd
  parameter); maybe use struct_group()? [-Wattribute-warning]
                          __read_overflow2_field(q_size_field, size);

  The compiler actually complains on 'mac80211_hwsim_get_et_strings()' where
  fortification logic inteprets call to 'memcpy()' as an attempt to copy the
  whole 'mac80211_hwsim_gstrings_stats' array from its first member and so
  issues an overread warning. This warning may be silenced by passing
  an address of the whole array and not the first member to 'memcpy()'.
- X86/mm: Drop the 4 MB restriction on minimal NUMA node memory size.
  [Mike Rapoport (IBM)]

  [ Upstream commit a1e2b8b36820d8c91275f207e77e91645b7c6836 ]

  Qi Zheng reported crashes in a production environment and provided a
  simplified example as a reproducer:

   |  For example, if we use Qemu to start a two NUMA node kernel,
   |  one of the nodes has 2M memory (less than NODE_MIN_SIZE),
   |  and the other node has 2G, then we will encounter the
   |  following panic:
   |
   |    BUG: kernel NULL pointer dereference, address: 0000000000000000
   |    <...>
   |    RIP: 0010:_raw_spin_lock_irqsave+0x22/0x40
   |    <...>
   |    Call Trace:
   |      <TASK>
   |      deactivate_slab()
   |      bootstrap()
   |      kmem_cache_init()
   |      start_kernel()
   |      secondary_startup_64_no_verify()

  The crashes happen because of inconsistency between the nodemask that
  has nodes with less than 4MB as memoryless, and the actual memory fed
  into the core mm.

  The commit:

    9391a3f9c7f1 ("[PATCH] x86_64: Clear more state when ignoring empty node in SRAT parsing")

  ... that introduced minimal size of a NUMA node does not explain why
  a node size cannot be less than 4MB and what boot failures this
  restriction might fix.

  Fixes have been submitted to the core MM code to tighten up the
  memory topologies it accepts and to not crash on weird input:

    mm: page_alloc: skip memoryless nodes entirely
    mm: memory_hotplug: drop memoryless node from fallback lists

  Andrew has accepted them into the -mm tree, but there are no
  stable SHA1's yet.

  This patch drops the limitation for minimal node size on x86:

    - which works around the crash without the fixes to the core MM.
    - makes x86 topologies less weird,
    - removes an arbitrary and undocumented limitation on NUMA topologies.

  [ mingo: Improved changelog clarity. ]
- Clocksource/drivers/timer-atmel-tcb: Fix initialization on SAM9
  hardware. [Ronald Wahl]

  [ Upstream commit 6d3bc4c02d59996d1d3180d8ed409a9d7d5900e0 ]

  On SAM9 hardware two cascaded 16 bit timers are used to form a 32 bit
  high resolution timer that is used as scheduler clock when the kernel
  has been configured that way (CONFIG_ATMEL_CLOCKSOURCE_TCB).

  The driver initially triggers a reset-to-zero of the two timers but this
  reset is only performed on the next rising clock. For the first timer
  this is ok - it will be in the next 60ns (16MHz clock). For the chained
  second timer this will only happen after the first timer overflows, i.e.
  after 2^16 clocks (~4ms with a 16MHz clock). So with other words the
  scheduler clock resets to 0 after the first 2^16 clock cycles.

  It looks like that the scheduler does not like this and behaves wrongly
  over its lifetime, e.g. some tasks are scheduled with a long delay. Why
  that is and if there are additional requirements for this behaviour has
  not been further analysed.

  There is a simple fix for resetting the second timer as well when the
  first timer is reset and this is to set the ATMEL_TC_ASWTRG_SET bit in
  the Channel Mode register (CMR) of the first timer. This will also rise
  the TIOA line (clock input of the second timer) when a software trigger
  respective SYNC is issued.
- Clocksource/drivers/timer-imx-gpt: Fix potential memory leak. [Jacky
  Bai]

  [ Upstream commit 8051a993ce222a5158bccc6ac22ace9253dd71cb ]

  Fix coverity Issue CID 250382:  Resource leak (RESOURCE_LEAK).
  Add kfree when error return.
- Perf/core: Bail out early if the request AUX area is out of bound.
  [Shuai Xue]

  [ Upstream commit 54aee5f15b83437f23b2b2469bcf21bdd9823916 ]

  When perf-record with a large AUX area, e.g 4GB, it fails with:

      #perf record -C 0 -m ,4G -e arm_spe_0// -- sleep 1
      failed to mmap with 12 (Cannot allocate memory)

  and it reveals a WARNING with __alloc_pages():

  	------------[ cut here ]------------
  	WARNING: CPU: 44 PID: 17573 at mm/page_alloc.c:5568 __alloc_pages+0x1ec/0x248
  	Call trace:
  	 __alloc_pages+0x1ec/0x248
  	 __kmalloc_large_node+0xc0/0x1f8
  	 __kmalloc_node+0x134/0x1e8
  	 rb_alloc_aux+0xe0/0x298
  	 perf_mmap+0x440/0x660
  	 mmap_region+0x308/0x8a8
  	 do_mmap+0x3c0/0x528
  	 vm_mmap_pgoff+0xf4/0x1b8
  	 ksys_mmap_pgoff+0x18c/0x218
  	 __arm64_sys_mmap+0x38/0x58
  	 invoke_syscall+0x50/0x128
  	 el0_svc_common.constprop.0+0x58/0x188
  	 do_el0_svc+0x34/0x50
  	 el0_svc+0x34/0x108
  	 el0t_64_sync_handler+0xb8/0xc0
  	 el0t_64_sync+0x1a4/0x1a8

  'rb->aux_pages' allocated by kcalloc() is a pointer array which is used to
  maintains AUX trace pages. The allocated page for this array is physically
  contiguous (and virtually contiguous) with an order of 0..MAX_ORDER. If the
  size of pointer array crosses the limitation set by MAX_ORDER, it reveals a
  WARNING.

  So bail out early with -ENOMEM if the request AUX area is out of bound,
  e.g.:

      #perf record -C 0 -m ,4G -e arm_spe_0// -- sleep 1
      failed to mmap with 12 (Cannot allocate memory)
- Locking/ww_mutex/test: Fix potential workqueue corruption. [John
  Stultz]

  [ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]

  In some cases running with the test-ww_mutex code, I was seeing
  odd behavior where sometimes it seemed flush_workqueue was
  returning before all the work threads were finished.

  Often this would cause strange crashes as the mutexes would be
  freed while they were being used.

  Looking at the code, there is a lifetime problem as the
  controlling thread that spawns the work allocates the
  "struct stress" structures that are passed to the workqueue
  threads. Then when the workqueue threads are finished,
  they free the stress struct that was passed to them.

  Unfortunately the workqueue work_struct node is in the stress
  struct. Which means the work_struct is freed before the work
  thread returns and while flush_workqueue is waiting.

  It seems like a better idea to have the controlling thread
  both allocate and free the stress structures, so that we can
  be sure we don't corrupt the workqueue by freeing the structure
  prematurely.

  So this patch reworks the test to do so, and with this change
  I no longer see the early flush_workqueue returns.
- Linux 5.10.201. [Greg Kroah-Hartman]
- Btrfs: use u64 for buffer sizes in the tree search ioctls. [Filipe
  Manana]

  [ Upstream commit dec96fc2dcb59723e041416b8dc53e011b4bfc2e ]

  In the tree search v2 ioctl we use the type size_t, which is an unsigned
  long, to track the buffer size in the local variable 'buf_size'. An
  unsigned long is 32 bits wide on a 32 bits architecture. The buffer size
  defined in struct btrfs_ioctl_search_args_v2 is a u64, so when we later
  try to copy the local variable 'buf_size' to the argument struct, when
  the search returns -EOVERFLOW, we copy only 32 bits which will be a
  problem on big endian systems.

  Fix this by using a u64 type for the buffer sizes, not only at
  btrfs_ioctl_tree_search_v2(), but also everywhere down the call chain
  so that we can use the u64 at btrfs_ioctl_tree_search_v2().
- Revert "mmc: core: Capture correct oemid-bits for eMMC cards"
  [Dominique Martinet]

  commit 421b605edb1ce611dee06cf6fd9a1c1f2fd85ad0 upstream.

  This reverts commit 84ee19bffc9306128cd0f1c650e89767079efeff.

  The commit above made quirks with an OEMID fail to be applied, as they
  were checking card->cid.oemid for the full 16 bits defined in MMC_FIXUP
  macros but the field would only contain the bottom 8 bits.

  eMMC v5.1A might have bogus values in OEMID's higher bits so another fix
  will be made, but it has been decided to revert this until that is ready.
- Tracing/kprobes: Fix the order of argument descriptions. [Yujie Liu]

  [ Upstream commit f032c53bea6d2057c14553832d846be2f151cfb2 ]

  The order of descriptions should be consistent with the argument list of
  the function, so "kretprobe" should be the second one.

  int __kprobe_event_gen_cmd_start(struct dynevent_cmd *cmd, bool kretprobe,
                                   const char *name, const char *loc, ...)
- Fbdev: fsl-diu-fb: mark wr_reg_wa() static. [Arnd Bergmann]

  [ Upstream commit a5035c81847430dfa3482807b07325f29e9e8c09 ]

  wr_reg_wa() is not an appropriate name for a global function, and doesn't need
  to be global anyway, so mark it static and avoid the warning:

  drivers/video/fbdev/fsl-diu-fb.c:493:6: error: no previous prototype for 'wr_reg_wa' [-Werror=missing-prototypes]
- Fbdev: imsttfb: fix a resource leak in probe. [Dan Carpenter]

  [ Upstream commit aba6ab57a910ad4b940c2024d15f2cdbf5b7f76b ]

  I've re-written the error handling but the bug is that if init_imstt()
  fails we need to call iounmap(par->cmap_regs).
- Fbdev: imsttfb: Fix error path of imsttfb_probe() [Helge Deller]

  [ Upstream commit 518ecb6a209f6ff678aeadf9f2bf870c0982ca85 ]

  Release ressources when init_imstt() returns failure.
- Spi: spi-zynq-qspi: add spi-mem to driver kconfig dependencies. [Amit
  Kumar Mahapatra]

  [ Upstream commit c2ded280a4b1b7bd93e53670528504be08d24967 ]

  Zynq QSPI driver has been converted to use spi-mem framework so
  add spi-mem to driver kconfig dependencies.
- Drm/syncobj: fix DRM_SYNCOBJ_WAIT_FLAGS_WAIT_AVAILABLE. [Erik
  Kurzinger]

  [ Upstream commit 101c9f637efa1655f55876644d4439e552267527 ]

  If DRM_IOCTL_SYNCOBJ_TIMELINE_WAIT is invoked with the
  DRM_SYNCOBJ_WAIT_FLAGS_WAIT_AVAILABLE flag set but no fence has yet been
  submitted for the given timeline point the call will fail immediately
  with EINVAL. This does not match the intended behavior where the call
  should wait until the fence has been submitted (or the timeout expires).

  The following small example program illustrates the issue. It should
  wait for 5 seconds and then print ETIME, but instead it terminates right
  away after printing EINVAL.

    #include <stdio.h>
    #include <fcntl.h>
    #include <time.h>
    #include <errno.h>
    #include <xf86drm.h>
    int main(void)
    {
        int fd = open("/dev/dri/card0", O_RDWR);
        uint32_t syncobj;
        drmSyncobjCreate(fd, 0, &syncobj);
        struct timespec ts;
        clock_gettime(CLOCK_MONOTONIC, &ts);
        uint64_t point = 1;
        if (drmSyncobjTimelineWait(fd, &syncobj, &point, 1,
                                   ts.tv_sec * 1000000000 + ts.tv_nsec + 5000000000, // 5s
                                   DRM_SYNCOBJ_WAIT_FLAGS_WAIT_AVAILABLE, NULL)) {
            printf("drmSyncobjTimelineWait failed %d\n", errno);
        }
    }

  Fixes: 01d6c3578379 ("drm/syncobj: add support for timeline point wait v8")
  Signed-off-by: Erik Kurzinger <ekurzinger@nvidia.com>
  Reviewed by: Simon Ser <contact@emersion.fd>
- X86/sev-es: Allow copy_from_kernel_nofault() in earlier boot. [Adam
  Dunlap]

  [ Upstream commit f79936545fb122856bd78b189d3c7ee59928c751 ]

  Previously, if copy_from_kernel_nofault() was called before
  boot_cpu_data.x86_virt_bits was set up, then it would trigger undefined
  behavior due to a shift by 64.

  This ended up causing boot failures in the latest version of ubuntu2204
  in the gcp project when using SEV-SNP.

  Specifically, this function is called during an early #VC handler which
  is triggered by a CPUID to check if NX is implemented.
- X86: Share definition of __is_canonical_address() [Adrian Hunter]

  [ Upstream commit 1fb85d06ad6754796cd1b920639ca9d8840abefd ]

  Reduce code duplication by moving canonical address code to a common header
  file.
- Netfilter: nat: fix ipv6 nat redirect with mapped and scoped
  addresses. [Florian Westphal]

  [ Upstream commit 80abbe8a8263106fe45a4f293b92b5c74cc9cc8a ]

  The ipv6 redirect target was derived from the ipv4 one, i.e. its
  identical to a 'dnat' with the first (primary) address assigned to the
  network interface.  The code has been moved around to make it usable
  from nf_tables too, but its still the same as it was back when this
  was added in 2012.

  IPv6, however, has different types of addresses, if the 'wrong' address
  comes first the redirection does not work.

  In Daniels case, the addresses are:
    inet6 ::ffff:192 ...
    inet6 2a01: ...

  ... so the function attempts to redirect to the mapped address.

  Add more checks before the address is deemed correct:
  1. If the packets' daddr is scoped, search for a scoped address too
  2. skip tentative addresses
  3. skip mapped addresses

  Use the first address that appears to match our needs.
- Netfilter: nft_redir: use `struct nf_nat_range2` throughout and
  deduplicate eval call-backs. [Jeremy Sowden]

  [ Upstream commit 6f56ad1b92328997e1b1792047099df6f8d7acb5 ]

  `nf_nat_redirect_ipv4` takes a `struct nf_nat_ipv4_multi_range_compat`,
  but converts it internally to a `struct nf_nat_range2`.  Change the
  function to take the latter, factor out the code now shared with
  `nf_nat_redirect_ipv6`, move the conversion to the xt_REDIRECT module,
  and update the ipv4 range initialization in the nft_redir module.

  Replace a bare hex constant for 127.0.0.1 with a macro.

  Remove `WARN_ON`.  `nf_nat_setup_info` calls `nf_ct_is_confirmed`:

  	/* Can't setup nat info for confirmed ct. */
  	if (nf_ct_is_confirmed(ct))
  		return NF_ACCEPT;

  This means that `ct` cannot be null or the kernel will crash, and
  implies that `ctinfo` is `IP_CT_NEW` or `IP_CT_RELATED`.

  nft_redir has separate ipv4 and ipv6 call-backs which share much of
  their code, and an inet one switch containing a switch that calls one of
  the others based on the family of the packet.  Merge the ipv4 and ipv6
  ones into the inet one in order to get rid of the duplicate code.

  Const-qualify the `priv` pointer since we don't need to write through
  it.

  Assign `priv->flags` to the range instead of OR-ing it in.

  Set the `NF_NAT_RANGE_PROTO_SPECIFIED` flag once during init, rather
  than on every eval.
- Netfilter: xt_recent: fix (increase) ipv6 literal buffer length.
  [Maciej Żenczykowski]

  [ Upstream commit 7b308feb4fd2d1c06919445c65c8fbf8e9fd1781 ]

  in6_pton() supports 'low-32-bit dot-decimal representation'
  (this is useful with DNS64/NAT64 networks for example):

    # echo +aaaa:bbbb:cccc:dddd:eeee:ffff:1.2.3.4 > /proc/self/net/xt_recent/DEFAULT
    # cat /proc/self/net/xt_recent/DEFAULT
    src=aaaa:bbbb:cccc:dddd:eeee:ffff:0102:0304 ttl: 0 last_seen: 9733848829 oldest_pkt: 1 9733848829

  but the provided buffer is too short:

    # echo +aaaa:bbbb:cccc:dddd:eeee:ffff:255.255.255.255 > /proc/self/net/xt_recent/DEFAULT
    -bash: echo: write error: Invalid argument
- R8169: respect userspace disabling IFF_MULTICAST. [Heiner Kallweit]

  [ Upstream commit 8999ce4cfc87e61b4143ec2e7b93d8e92e11fa7f ]

  So far we ignore the setting of IFF_MULTICAST. Fix this and clear bit
  AcceptMulticast if IFF_MULTICAST isn't set.

  Note: Based on the implementations I've seen it doesn't seem to be 100% clear
  what a driver is supposed to do if IFF_ALLMULTI is set but IFF_MULTICAST
  is not. This patch is based on the understanding that IFF_MULTICAST has
  precedence.
- Tg3: power down device only on SYSTEM_POWER_OFF. [George Shuklin]

  [ Upstream commit 9fc3bc7643341dc5be7d269f3d3dbe441d8d7ac3 ]

  Dell R650xs servers hangs on reboot if tg3 driver calls
  tg3_power_down.

  This happens only if network adapters (BCM5720 for R650xs) were
  initialized using SNP (e.g. by booting ipxe.efi).

  The actual problem is on Dell side, but this fix allows servers
  to come back alive after reboot.
- Net/smc: put sk reference if close work was canceled. [D. Wythe]

  [ Upstream commit aa96fbd6d78d9770323b21e2c92bd38821be8852 ]

  Note that we always hold a reference to sock when attempting
  to submit close_work. Therefore, if we have successfully
  canceled close_work from pending, we MUST release that reference
  to avoid potential leaks.
- Net/smc: allow cdc msg send rather than drop it with NULL sndbuf_desc.
  [D. Wythe]

  [ Upstream commit c5bf605ba4f9d6fbbb120595ab95002f4716edcb ]

  This patch re-fix the issues mentioned by commit 22a825c541d7
  ("net/smc: fix NULL sndbuf_desc in smc_cdc_tx_handler()").

  Blocking sending message do solve the issues though, but it also
  prevents the peer to receive the final message. Besides, in logic,
  whether the sndbuf_desc is NULL or not have no impact on the processing
  of cdc message sending.

  Hence that, this patch allows the cdc message sending but to check the
  sndbuf_desc with care in smc_cdc_tx_handler().
- Net/smc: fix dangling sock under state SMC_APPFINCLOSEWAIT. [D. Wythe]

  [ Upstream commit 5211c9729484c923f8d2e06bd29f9322cc42bb8f ]

  Considering scenario:

  				smc_cdc_rx_handler
  __smc_release
  				sock_set_flag
  smc_close_active()
  sock_set_flag

  __set_bit(DEAD)			__set_bit(DONE)

  Dues to __set_bit is not atomic, the DEAD or DONE might be lost.
  if the DEAD flag lost, the state SMC_CLOSED  will be never be reached
  in smc_close_passive_work:

  if (sock_flag(sk, SOCK_DEAD) &&
  	smc_close_sent_any_close(conn)) {
  	sk->sk_state = SMC_CLOSED;
  } else {
  	/* just shutdown, but not yet closed locally */
  	sk->sk_state = SMC_APPFINCLOSEWAIT;
  }

  Replace sock_set_flags or __set_bit to set_bit will fix this problem.
  Since set_bit is atomic.
- Net: stmmac: xgmac: Enable support for multiple Flexible PPS outputs.
  [Furong Xu]

  [ Upstream commit db456d90a4c1b43b6251fa4348c8adc59b583274 ]

  From XGMAC Core 3.20 and later, each Flexible PPS has individual PPSEN bit
  to select Fixed mode or Flexible mode. The PPSEN must be set, or it stays
  in Fixed PPS mode by default.
  XGMAC Core prior 3.20, only PPSEN0(bit 4) is writable. PPSEN{1,2,3} are
  read-only reserved, and they are already in Flexible mode by default, our
  new code always set PPSEN{1,2,3} do not make things worse ;-)
- Fix termination state for idr_for_each_entry_ul() [NeilBrown]

  [ Upstream commit e8ae8ad479e2d037daa33756e5e72850a7bd37a9 ]

  The comment for idr_for_each_entry_ul() states

    after normal termination @entry is left with the value NULL

  This is not correct in the case where UINT_MAX has an entry in the idr.
  In that case @entry will be non-NULL after termination.
  No current code depends on the documentation being correct, but to
  save future code we should fix it.

  Also fix idr_for_each_entry_continue_ul().  While this is not documented
  as leaving @entry as NULL, the mellanox driver appears to depend on
  it doing so.  So make that explicit in the documentation as well as in
  the code.
- Net: r8169: Disable multicast filter for RTL8168H and RTL8107E.
  [Patrick Thompson]

  [ Upstream commit efa5f1311c4998e9e6317c52bc5ee93b3a0f36df ]

  RTL8168H and RTL8107E ethernet adapters erroneously filter unicast
  eapol packets unless allmulti is enabled. These devices correspond to
  RTL_GIGA_MAC_VER_46 and VER_48. Add an exception for VER_46 and VER_48
  in the same way that VER_35 has an exception.
- Dccp/tcp: Call security_inet_conn_request() after setting IPv6
  addresses. [Kuniyuki Iwashima]

  [ Upstream commit 23be1e0e2a83a8543214d2599a31d9a2185a796b ]

  Initially, commit 4237c75c0a35 ("[MLSXFRM]: Auto-labeling of child
  sockets") introduced security_inet_conn_request() in some functions
  where reqsk is allocated.  The hook is added just after the allocation,
  so reqsk's IPv6 remote address was not initialised then.

  However, SELinux/Smack started to read it in netlbl_req_setattr()
  after commit e1adea927080 ("calipso: Allow request sockets to be
  relabelled by the lsm.").

  Commit 284904aa7946 ("lsm: Relocate the IPv4 security_inet_conn_request()
  hooks") fixed that kind of issue only in TCPv4 because IPv6 labeling was
  not supported at that time.  Finally, the same issue was introduced again
  in IPv6.

  Let's apply the same fix on DCCPv6 and TCPv6.
- Dccp: Call security_inet_conn_request() after setting IPv4 addresses.
  [Kuniyuki Iwashima]

  [ Upstream commit fa2df45af13091f76b89adb84a28f13818d5d631 ]

  Initially, commit 4237c75c0a35 ("[MLSXFRM]: Auto-labeling of child
  sockets") introduced security_inet_conn_request() in some functions
  where reqsk is allocated.  The hook is added just after the allocation,
  so reqsk's IPv4 remote address was not initialised then.

  However, SELinux/Smack started to read it in netlbl_req_setattr()
  after the cited commits.

  This bug was partially fixed by commit 284904aa7946 ("lsm: Relocate
  the IPv4 security_inet_conn_request() hooks").

  This patch fixes the last bug in DCCPv4.
- Inet: shrink struct flowi_common. [Eric Dumazet]

  [ Upstream commit 1726483b79a72e0150734d5367e4a0238bf8fcff ]

  I am looking at syzbot reports triggering kernel stack overflows
  involving a cascade of ipvlan devices.

  We can save 8 bytes in struct flowi_common.

  This patch alone will not fix the issue, but is a start.
- Tipc: Change nla_policy for bearer-related names to NLA_NUL_STRING.
  [Shigeru Yoshida]

  [ Upstream commit 19b3f72a41a8751e26bffc093bb7e1cef29ad579 ]

  syzbot reported the following uninit-value access issue [1]:

  =====================================================
  BUG: KMSAN: uninit-value in strlen lib/string.c:418 [inline]
  BUG: KMSAN: uninit-value in strstr+0xb8/0x2f0 lib/string.c:756
   strlen lib/string.c:418 [inline]
   strstr+0xb8/0x2f0 lib/string.c:756
   tipc_nl_node_reset_link_stats+0x3ea/0xb50 net/tipc/node.c:2595
   genl_family_rcv_msg_doit net/netlink/genetlink.c:971 [inline]
   genl_family_rcv_msg net/netlink/genetlink.c:1051 [inline]
   genl_rcv_msg+0x11ec/0x1290 net/netlink/genetlink.c:1066
   netlink_rcv_skb+0x371/0x650 net/netlink/af_netlink.c:2545
   genl_rcv+0x40/0x60 net/netlink/genetlink.c:1075
   netlink_unicast_kernel net/netlink/af_netlink.c:1342 [inline]
   netlink_unicast+0xf47/0x1250 net/netlink/af_netlink.c:1368
   netlink_sendmsg+0x1238/0x13d0 net/netlink/af_netlink.c:1910
   sock_sendmsg_nosec net/socket.c:730 [inline]
   sock_sendmsg net/socket.c:753 [inline]
   ____sys_sendmsg+0x9c2/0xd60 net/socket.c:2541
   ___sys_sendmsg+0x28d/0x3c0 net/socket.c:2595
   __sys_sendmsg net/socket.c:2624 [inline]
   __do_sys_sendmsg net/socket.c:2633 [inline]
   __se_sys_sendmsg net/socket.c:2631 [inline]
   __x64_sys_sendmsg+0x307/0x490 net/socket.c:2631
   do_syscall_x64 arch/x86/entry/common.c:50 [inline]
   do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
   entry_SYSCALL_64_after_hwframe+0x63/0xcd

  Uninit was created at:
   slab_post_alloc_hook+0x12f/0xb70 mm/slab.h:767
   slab_alloc_node mm/slub.c:3478 [inline]
   kmem_cache_alloc_node+0x577/0xa80 mm/slub.c:3523
   kmalloc_reserve+0x13d/0x4a0 net/core/skbuff.c:559
   __alloc_skb+0x318/0x740 net/core/skbuff.c:650
   alloc_skb include/linux/skbuff.h:1286 [inline]
   netlink_alloc_large_skb net/netlink/af_netlink.c:1214 [inline]
   netlink_sendmsg+0xb34/0x13d0 net/netlink/af_netlink.c:1885
   sock_sendmsg_nosec net/socket.c:730 [inline]
   sock_sendmsg net/socket.c:753 [inline]
   ____sys_sendmsg+0x9c2/0xd60 net/socket.c:2541
   ___sys_sendmsg+0x28d/0x3c0 net/socket.c:2595
   __sys_sendmsg net/socket.c:2624 [inline]
   __do_sys_sendmsg net/socket.c:2633 [inline]
   __se_sys_sendmsg net/socket.c:2631 [inline]
   __x64_sys_sendmsg+0x307/0x490 net/socket.c:2631
   do_syscall_x64 arch/x86/entry/common.c:50 [inline]
   do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
   entry_SYSCALL_64_after_hwframe+0x63/0xcd

  TIPC bearer-related names including link names must be null-terminated
  strings. If a link name which is not null-terminated is passed through
  netlink, strstr() and similar functions can cause buffer overrun. This
  causes the above issue.

  This patch changes the nla_policy for bearer-related names from NLA_STRING
  to NLA_NUL_STRING. This resolves the issue by ensuring that only
  null-terminated strings are accepted as bearer-related names.

  syzbot reported similar uninit-value issue related to bearer names [2]. The
  root cause of this issue is that a non-null-terminated bearer name was
  passed. This patch also resolved this issue.
- Hsr: Prevent use after free in prp_create_tagged_frame() [Dan
  Carpenter]

  [ Upstream commit 876f8ab52363f649bcc74072157dfd7adfbabc0d ]

  The prp_fill_rct() function can fail.  In that situation, it frees the
  skb and returns NULL.  Meanwhile on the success path, it returns the
  original skb.  So it's straight forward to fix bug by using the returned
  value.
- Llc: verify mac len before reading mac header. [Willem de Bruijn]

  [ Upstream commit 7b3ba18703a63f6fd487183b9262b08e5632da1b ]

  LLC reads the mac header with eth_hdr without verifying that the skb
  has an Ethernet header.

  Syzbot was able to enter llc_rcv on a tun device. Tun can insert
  packets without mac len and with user configurable skb->protocol
  (passing a tun_pi header when not configuring IFF_NO_PI).

      BUG: KMSAN: uninit-value in llc_station_ac_send_test_r net/llc/llc_station.c:81 [inline]
      BUG: KMSAN: uninit-value in llc_station_rcv+0x6fb/0x1290 net/llc/llc_station.c:111
      llc_station_ac_send_test_r net/llc/llc_station.c:81 [inline]
      llc_station_rcv+0x6fb/0x1290 net/llc/llc_station.c:111
      llc_rcv+0xc5d/0x14a0 net/llc/llc_input.c:218
      __netif_receive_skb_one_core net/core/dev.c:5523 [inline]
      __netif_receive_skb+0x1a6/0x5a0 net/core/dev.c:5637
      netif_receive_skb_internal net/core/dev.c:5723 [inline]
      netif_receive_skb+0x58/0x660 net/core/dev.c:5782
      tun_rx_batched+0x3ee/0x980 drivers/net/tun.c:1555
      tun_get_user+0x54c5/0x69c0 drivers/net/tun.c:2002

  Add a mac_len test before all three eth_hdr(skb) calls under net/llc.

  There are further uses in include/net/llc_pdu.h. All these are
  protected by a test skb->protocol == ETH_P_802_2. Which does not
  protect against this tun scenario.

  But the mac_len test added in this patch in llc_fixup_skb will
  indirectly protect those too. That is called from llc_rcv before any
  other LLC code.

  It is tempting to just add a blanket mac_len check in llc_rcv, but
  not sure whether that could break valid LLC paths that do not assume
  an Ethernet header. 802.2 LLC may be used on top of non-802.3
  protocols in principle. The below referenced commit shows that used
  to, on top of Token Ring.

  At least one of the three eth_hdr uses goes back to before the start
  of git history. But the one that syzbot exercises is introduced in
  this commit. That commit is old enough (2008), that effectively all
  stable kernels should receive this.
- Input: synaptics-rmi4 - fix use after free in
  rmi_unregister_function() [Dan Carpenter]

  [ Upstream commit eb988e46da2e4eae89f5337e047ce372fe33d5b1 ]

  The put_device() calls rmi_release_function() which frees "fn" so the
  dereference on the next line "fn->num_of_irqs" is a use after free.
  Move the put_device() to the end to fix this.
- Pwm: brcmstb: Utilize appropriate clock APIs in suspend/resume.
  [Florian Fainelli]

  [ Upstream commit e9bc4411548aaa738905d37851a0146c16b3bb21 ]

  The suspend/resume functions currently utilize
  clk_disable()/clk_enable() respectively which may be no-ops with certain
  clock providers such as SCMI. Fix this to use clk_disable_unprepare()
  and clk_prepare_enable() respectively as we should.
- Pwm: sti: Reduce number of allocations and drop usage of chip_data.
  [Uwe Kleine-König]

  [ Upstream commit 2d6812b41e0d832919d72c72ebddf361df53ba1b ]

  Instead of using one allocation per capture channel, use a single one. Also
  store it in driver data instead of chip data.

  This has several advantages:

   - driver data isn't cleared when pwm_put() is called
   - Reduces memory fragmentation

  Also register the pwm chip only after the per capture channel data is
  initialized as the capture callback relies on this initialization and it
  might be called even before pwmchip_add() returns.

  It would be still better to have struct sti_pwm_compat_data and the
  per-channel data struct sti_cpt_ddata in a single memory chunk, but that's
  not easily possible because the number of capture channels isn't known yet
  when the driver data struct is allocated.
- Pwm: sti: Avoid conditional gotos. [Thierry Reding]

  [ Upstream commit fd3ae02bb66f091e55f363d32eca7b4039977bf5 ]

  Using gotos for conditional code complicates this code significantly.
  Convert the code to simple conditional blocks to increase readability.
- Regmap: prevent noinc writes from clobbering cache. [Ben Wolsieffer]

  [ Upstream commit 984a4afdc87a1fc226fd657b1cd8255c13d3fc1a ]

  Currently, noinc writes are cached as if they were standard incrementing
  writes, overwriting unrelated register values in the cache. Instead, we
  want to cache the last value written to the register, as is done in the
  accelerated noinc handler (regmap_noinc_readwrite).
- Media: dvb-usb-v2: af9035: fix missing unlock. [Hans Verkuil]

  [ Upstream commit f31b2cb85f0ee165d78e1c43f6d69f82cc3b2145 ]

  Instead of returning an error, goto the mutex unlock at
  the end of the function.

  Fixes smatch warning:

  drivers/media/usb/dvb-usb-v2/af9035.c:467 af9035_i2c_master_xfer() warn: inconsistent returns '&d->i2c_mutex'.
    Locked on  : 326,387
    Unlocked on: 465,467
- Media: cedrus: Fix clock/reset sequence. [Jernej Skrabec]

  [ Upstream commit 36fe515c1a3cd5eac148e8a591a82108d92d5522 ]

  According to H6 user manual, resets should always be de-asserted before
  clocks are enabled. This is also consistent with vendor driver.
- Media: vidtv: mux: Add check and kfree for kstrdup. [Jiasheng Jiang]

  [ Upstream commit 1fd6eb12642e0c32692924ff359c07de4b781d78 ]

  Add check for the return value of kstrdup() and return the error
  if it fails in order to avoid NULL pointer dereference.
  Moreover, use kfree() in the later error handling in order to avoid
  memory leak.
- Media: vidtv: psi: Add check for kstrdup. [Jiasheng Jiang]

  [ Upstream commit 76a2c5df6ca8bd8ada45e953b8c72b746f42918d ]

  Add check for the return value of kstrdup() and return the error
  if it fails in order to avoid NULL pointer dereference.
- Media: s3c-camif: Avoid inappropriate kfree() [Katya Orlova]

  [ Upstream commit 61334819aca018c3416ee6c330a08a49c1524fc3 ]

  s3c_camif_register_video_node() works with video_device structure stored
  as a field of camif_vp, so it should not be kfreed.
  But there is video_device_release() on error path that do it.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.
- Media: bttv: fix use after free error due to btv->timeout timer.
  [Zheng Wang]

  [ Upstream commit bd5b50b329e850d467e7bcc07b2b6bde3752fbda ]

  There may be some a race condition between timer function
  bttv_irq_timeout and bttv_remove. The timer is setup in
  probe and there is no timer_delete operation in remove
  function. When it hit kfree btv, the function might still be
  invoked, which will cause use after free bug.

  This bug is found by static analysis, it may be false positive.

  Fix it by adding del_timer_sync invoking to the remove function.

  cpu0                cpu1
                    bttv_probe
                      ->timer_setup
                        ->bttv_set_dma
                          ->mod_timer;
  bttv_remove
    ->kfree(btv);
                    ->bttv_irq_timeout
                      ->USE btv
- Media: i2c: max9286: Fix some redundant of_node_put() calls.
  [Christophe JAILLET]

  [ Upstream commit 0822315e46b400f611cba1193456ee6a5dc3e41d ]

  This is odd to have a of_node_put() just after a for_each_child_of_node()
  or a for_each_endpoint_of_node() loop. It should already be called
  during the last iteration.

  Remove these calls.
- Pcmcia: ds: fix possible name leak in error path in
  pcmcia_device_add() [Yang Yingliang]

  [ Upstream commit 99e1241049a92dd3e9a90a0f91e32ce390133278 ]

  Afer commit 1fa5ae857bb1 ("driver core: get rid of struct device's
  bus_id string array"), the name of device is allocated dynamically.
  Therefore, it needs to be freed, which is done by the driver core for
  us once all references to the device are gone. Therefore, move the
  dev_set_name() call immediately before the call device_register(), which
  either succeeds (then the freeing will be done upon subsequent remvoal),
  or puts the reference in the error call. Also, it is not unusual that the
  return value of dev_set_name is not checked.

  Fixes: 1fa5ae857bb1 ("driver core: get rid of struct device's bus_id string array")
  Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
  [linux@dominikbrodowski.net: simplification, commit message modified]
- Pcmcia: ds: fix refcount leak in pcmcia_device_add() [Yang Yingliang]

  [ Upstream commit 402ab979b29126068e0b596b641422ff7490214c ]

  As the comment of device_register() says, it should use put_device()
  to give up the reference in the error path. Then, insofar resources
  will be freed in pcmcia_release_dev(), the error path is no longer
  needed. In particular, this means that the (previously missing) dropping
  of the reference to &p_dev->function_config->ref is now handled by
  pcmcia_release_dev().

  Fixes: 360b65b95bae ("[PATCH] pcmcia: make config_t independent, add reference counting")
  Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
  [linux@dominikbrodowski.net: simplification, commit message rewrite]
- Pcmcia: cs: fix possible hung task and memory leak pccardd() [Yang
  Yingliang]

  [ Upstream commit e3ea1b4847e49234e691c0d66bf030bd65bb7f2b ]

  If device_register() returns error in pccardd(), it leads two issues:

  1. The socket_released has never been completed, it will block
     pcmcia_unregister_socket(), because of waiting for completion
     of socket_released.
  2. The device name allocated by dev_set_name() is leaked.

  Fix this two issues by calling put_device() when device_register() fails.
  socket_released can be completed in pcmcia_release_socket(), the name can
  be freed in kobject_cleanup().
- Rtc: pcf85363: fix wrong mask/val parameters in regmap_update_bits
  call. [Javier Carrasco]

  [ Upstream commit 2be36c09b6b07306be33519e1aa70d2e2a2161bb ]

  The current implementation passes PIN_IO_INTA_OUT (2) as a mask and
  PIN_IO_INTAPM (GENMASK(1, 0)) as a value.
  Swap the variables to assign mask and value the right way.

  This error was first introduced with the alarm support. For better or
  worse it worked as expected because 0x02 was applied as a mask to 0x03,
  resulting 0x02 anyway. This will of course not work for any other value.
- I3c: Fix potential refcount leak in i3c_master_register_new_i3c_devs.
  [Dinghao Liu]

  [ Upstream commit cab63f64887616e3c4e31cfd8103320be6ebc8d3 ]

  put_device() needs to be called on failure of device_register()
  to give up the reference initialized in it to avoid refcount leak.
- Perf hist: Add missing puts to hist__account_cycles. [Ian Rogers]

  [ Upstream commit c1149037f65bcf0334886180ebe3d5efcf214912 ]

  Caught using reference count checking on perf top with
  "--call-graph=lbr". After this no memory leaks were detected.
- Perf machine: Avoid out of bounds LBR memory read. [Ian Rogers]

  [ Upstream commit ab8ce150781d326c6bfbe1e09f175ffde1186f80 ]

  Running perf top with address sanitizer and "--call-graph=lbr" fails
  due to reading sample 0 when no samples exist. Add a guard to prevent
  this.
- Usb: host: xhci-plat: fix possible kernel oops while resuming. [Sergey
  Shtylyov]

  [ Upstream commit a5f928db59519a15e82ecba4ae3e7cbf5a44715a ]

  If this driver enables the xHC clocks while resuming from sleep, it calls
  clk_prepare_enable() without checking for errors and blithely goes on to
  read/write the xHC's registers -- which, with the xHC not being clocked,
  at least on ARM32 usually causes an imprecise external abort exceptions
  which cause kernel oops.  Currently, the chips for which the driver does
  the clock dance on suspend/resume seem to be the Broadcom STB SoCs, based
  on ARM32 CPUs, as it seems...

  Found by Linux Verification Center (linuxtesting.org) with the Svace static
  analysis tool.
- Xhci: Loosen RPM as default policy to cover for AMD xHC 1.1.
  [Basavaraj Natikar]

  [ Upstream commit 4baf1218150985ee3ab0a27220456a1f027ea0ac ]

  The AMD USB host controller (1022:43f7) isn't going into PCI D3 by default
  without anything connected. This is because the policy that was introduced
  by commit a611bf473d1f ("xhci-pci: Set runtime PM as default policy on all
  xHC 1.2 or later devices") only covered 1.2 or later.

  The 1.1 specification also has the same requirement as the 1.2
  specification for D3 support. So expand the runtime PM as default policy
  to all AMD 1.1 devices as well.
- Powerpc/pseries: fix potential memory leak in init_cpu_associativity()
  [Wang Yufen]

  [ Upstream commit 95f1a128cd728a7257d78e868f1f5a145fc43736 ]

  If the vcpu_associativity alloc memory successfully but the
  pcpu_associativity fails to alloc memory, the vcpu_associativity
  memory leaks.
- Powerpc/imc-pmu: Use the correct spinlock initializer. [Sebastian
  Andrzej Siewior]

  [ Upstream commit 007240d59c11f87ac4f6cfc6a1d116630b6b634c ]

  The macro __SPIN_LOCK_INITIALIZER() is implementation specific. Users
  that desire to initialize a spinlock in a struct must use
  __SPIN_LOCK_UNLOCKED().

  Use __SPIN_LOCK_UNLOCKED() for the spinlock_t in imc_global_refc.
- Powerpc/xive: Fix endian conversion size. [Benjamin Gray]

  [ Upstream commit ff7a60ab1e065257a0e467c13b519f4debcd7fcf ]

  Sparse reports a size mismatch in the endian swap. The Opal
  implementation[1] passes the value as a __be64, and the receiving
  variable out_qsize is a u64, so the use of be32_to_cpu() appears to be
  an error.

  [1]: https://github.com/open-power/skiboot/blob/80e2b1dc73/hw/xive.c#L3854
- Powerpc/40x: Remove stale PTE_ATOMIC_UPDATES macro. [Christophe Leroy]

  [ Upstream commit cc8ee288f484a2a59c01ccd4d8a417d6ed3466e3 ]

  40x TLB handlers were reworked by commit 2c74e2586bb9 ("powerpc/40x:
  Rework 40x PTE access and TLB miss") to not require PTE_ATOMIC_UPDATES
  anymore.

  Then commit 4e1df545e2fa ("powerpc/pgtable: Drop PTE_ATOMIC_UPDATES")
  removed all code related to PTE_ATOMIC_UPDATES.

  Remove left over PTE_ATOMIC_UPDATES macro.
- Modpost: fix tee MODULE_DEVICE_TABLE built on big-endian host.
  [Masahiro Yamada]

  [ Upstream commit 7f54e00e5842663c2cea501bbbdfa572c94348a3 ]

  When MODULE_DEVICE_TABLE(tee, ) is built on a host with a different
  endianness from the target architecture, it results in an incorrect
  MODULE_ALIAS().

  For example, see a case where drivers/char/hw_random/optee-rng.c
  is built as a module for ARM little-endian.

  If you build it on a little-endian host, you will get the correct
  MODULE_ALIAS:

      $ grep MODULE_ALIAS drivers/char/hw_random/optee-rng.mod.c
      MODULE_ALIAS("tee:ab7a617c-b8e7-4d8f-8301-d09b61036b64*");

  However, if you build it on a big-endian host, you will get a wrong
  MODULE_ALIAS:

      $ grep MODULE_ALIAS drivers/char/hw_random/optee-rng.mod.c
      MODULE_ALIAS("tee:646b0361-9bd0-0183-8f4d-e7b87c617aab*");

  The same problem also occurs when you enable CONFIG_CPU_BIG_ENDIAN,
  and build it on a little-endian host.

  This issue has been unnoticed because the ARM kernel is configured for
  little-endian by default, and most likely built on a little-endian host
  (cross-build on x86 or native-build on ARM).

  The uuid field must not be reversed because uuid_t is an array of __u8.
- Interconnect: qcom: sc7180: Set ACV enable_mask. [Konrad Dybcio]

  [ Upstream commit 1ad83c4792722fe134c1352591420702ff7b9091 ]

  ACV expects an enable_mask corresponding to the APPS RSC, fill it in.
- Interconnect: qcom: sc7180: Retire DEFINE_QBCM. [Konrad Dybcio]

  [ Upstream commit e451b2ea5a11fb3f6d83e1f834ae6a5f55a02bba ]

  The struct definition macros are hard to read and compare, expand them.
- F2fs: fix to initialize map.m_pblk in f2fs_precache_extents() [Chao
  Yu]

  [ Upstream commit 8b07c1fb0f1ad139373c8253f2fad8bc43fab07d ]

  Otherwise, it may print random physical block address in tracepoint
  of f2fs_map_blocks() as below:

  f2fs_map_blocks: dev = (253,16), ino = 2297, file offset = 0, start blkaddr = 0xa356c421, len = 0x0, flags = 0
- Dmaengine: pxa_dma: Remove an erroneous BUG_ON() in pxad_free_desc()
  [Christophe JAILLET]

  [ Upstream commit 83c761f568733277ce1f7eb9dc9e890649c29a8c ]

  If pxad_alloc_desc() fails on the first dma_pool_alloc() call, then
  sw_desc->nb_desc is zero.
  In such a case pxad_free_desc() is called and it will BUG_ON().

  Remove this erroneous BUG_ON().

  It is also useless, because if "sw_desc->nb_desc == 0", then, on the first
  iteration of the for loop, i is -1 and the loop will not be executed.
  (both i and sw_desc->nb_desc are 'int')
- USB: usbip: fix stub_dev hub disconnect. [Jonas Blixt]

  [ Upstream commit 97475763484245916735a1aa9a3310a01d46b008 ]

  If a hub is disconnected that has device(s) that's attached to the usbip layer
  the disconnect function might fail because it tries to release the port
  on an already disconnected hub.
- Tools: iio: iio_generic_buffer ensure alignment. [Matti Vaittinen]

  [ Upstream commit 2d3dff577dd0ea8fe9637a13822f7603c4a881c8 ]

  The iio_generic_buffer can return garbage values when the total size of
  scan data is not a multiple of the largest element in the scan. This can be
  demonstrated by reading a scan, consisting, for example of one 4-byte and
  one 2-byte element, where the 4-byte element is first in the buffer.

  The IIO generic buffer code does not take into account the last two
  padding bytes that are needed to ensure that the 4-byte data for next
  scan is correctly aligned.

  Add the padding bytes required to align the next sample with the scan size.
- Tools: iio: iio_generic_buffer: Fix some integer type and calculation.
  [Chenyuan Mi]

  [ Upstream commit 49d736313d0975ddeb156f4f59801da833f78b30 ]

  In function size_from_channelarray(), the return value 'bytes' is defined
  as int type. However, the calcution of 'bytes' in this function is designed
  to use the unsigned int type. So it is necessary to change 'bytes' type to
  unsigned int to avoid integer overflow.

  The size_from_channelarray() is called in main() function, its return value
  is directly multipled by 'buf_len' and then used as the malloc() parameter.
  The 'buf_len' is completely controllable by user, thus a multiplication
  overflow may occur here. This could allocate an unexpected small area.
- Tools: iio: privatize globals and functions in iio_generic_buffer.c
  file. [Alexandru Ardelean]

  [ Upstream commit ebe5112535b5cf389ca7d337cf6a0c1d885f9880 ]

  Mostly a tidy-up.
  But also helps to understand the limits of scope of these functions and
  globals.
- Misc: st_core: Do not call kfree_skb() under spin_lock_irqsave()
  [Jinjie Ruan]

  [ Upstream commit 4d08c3d12b61022501989f9f071514d2d6f77c47 ]

  It is not allowed to call kfree_skb() from hardware interrupt
  context or with hardware interrupts being disabled.
  So replace kfree_skb() with dev_kfree_skb_irq() under
  spin_lock_irqsave(). Compile tested only.
- Dmaengine: ti: edma: handle irq_of_parse_and_map() errors. [Dan
  Carpenter]

  [ Upstream commit 14f6d317913f634920a640e9047aa2e66f5bdcb7 ]

  Zero is not a valid IRQ for in-kernel code and the irq_of_parse_and_map()
  function returns zero on error.  So this check for valid IRQs should only
  accept values > 0.
- Usb: dwc2: fix possible NULL pointer dereference caused by driver
  concurrency. [Jia-Ju Bai]

  [ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]

  In _dwc2_hcd_urb_enqueue(), "urb->hcpriv = NULL" is executed without
  holding the lock "hsotg->lock". In _dwc2_hcd_urb_dequeue():

      spin_lock_irqsave(&hsotg->lock, flags);
      ...
  	if (!urb->hcpriv) {
  		dev_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
  		goto out;
  	}
      rc = dwc2_hcd_urb_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
      ...
  out:
      spin_unlock_irqrestore(&hsotg->lock, flags);

  When _dwc2_hcd_urb_enqueue() and _dwc2_hcd_urb_dequeue() are
  concurrently executed, the NULL check of "urb->hcpriv" can be executed
  before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
  in the function call to dwc2_hcd_urb_dequeue(), which can cause a NULL
  pointer dereference.

  This possible bug is found by an experimental static analysis tool
  developed by myself. This tool analyzes the locking APIs to extract
  function pairs that can be concurrently executed, and then analyzes the
  instructions in the paired functions to identify possible concurrency
  bugs including data races and atomicity violations. The above possible
  bug is reported, when my tool analyzes the source code of Linux 6.5.

  To fix this possible bug, "urb->hcpriv = NULL" should be executed with
  holding the lock "hsotg->lock". After using this patch, my tool never
  reports the possible bug, with the kernelconfiguration allyesconfig for
  x86_64. Because I have no associated hardware, I cannot test the patch
  in runtime testing, and just verify it according to the code logic.
- Livepatch: Fix missing newline character in klp_resolve_symbols()
  [Zheng Yejian]

  [ Upstream commit 67e18e132f0fd738f8c8cac3aa1420312073f795 ]

  Without the newline character, the log may not be printed immediately
  after the error occurs.
- Tty: tty_jobctrl: fix pid memleak in disassociate_ctty() [Yi Yang]

  [ Upstream commit 11e7f27b79757b6586645d87b95d5b78375ecdfc ]

  There is a pid leakage:
  ------------------------------
  unreferenced object 0xffff88810c181940 (size 224):
    comm "sshd", pid 8191, jiffies 4294946950 (age 524.570s)
    hex dump (first 32 bytes):
      01 00 00 00 00 00 00 00 00 00 00 00 ad 4e ad de  .............N..
      ff ff ff ff 6b 6b 6b 6b ff ff ff ff ff ff ff ff  ....kkkk........
    backtrace:
      [<ffffffff814774e6>] kmem_cache_alloc+0x5c6/0x9b0
      [<ffffffff81177342>] alloc_pid+0x72/0x570
      [<ffffffff81140ac4>] copy_process+0x1374/0x2470
      [<ffffffff81141d77>] kernel_clone+0xb7/0x900
      [<ffffffff81142645>] __se_sys_clone+0x85/0xb0
      [<ffffffff8114269b>] __x64_sys_clone+0x2b/0x30
      [<ffffffff83965a72>] do_syscall_64+0x32/0x80
      [<ffffffff83a00085>] entry_SYSCALL_64_after_hwframe+0x61/0xc6

  It turns out that there is a race condition between disassociate_ctty() and
  tty_signal_session_leader(), which caused this leakage.

  The pid memleak is triggered by the following race:
  task[sshd]                     task[bash]
  -----------------------        -----------------------
                                 disassociate_ctty();
                                 spin_lock_irq(&current->sighand->siglock);
                                 put_pid(current->signal->tty_old_pgrp);
                                 current->signal->tty_old_pgrp = NULL;
                                 tty = tty_kref_get(current->signal->tty);
                                 spin_unlock_irq(&current->sighand->siglock);
  tty_vhangup();
  tty_lock(tty);
  ...
  tty_signal_session_leader();
  spin_lock_irq(&p->sighand->siglock);
  ...
  if (tty->ctrl.pgrp) //tty->ctrl.pgrp is not NULL
  p->signal->tty_old_pgrp = get_pid(tty->ctrl.pgrp); //An extra get
  spin_unlock_irq(&p->sighand->siglock);
  ...
  tty_unlock(tty);
                                 if (tty) {
                                     tty_lock(tty);
                                     ...
                                     put_pid(tty->ctrl.pgrp);
                                     tty->ctrl.pgrp = NULL; //It's too late
                                     ...
                                     tty_unlock(tty);
                                 }

  The issue is believed to be introduced by commit c8bcd9c5be24 ("tty:
  Fix ->session locking") who moves the unlock of siglock in
  disassociate_ctty() above "if (tty)", making a small window allowing
  tty_signal_session_leader() to kick in. It can be easily reproduced by
  adding a delay before "if (tty)" and at the entrance of
  tty_signal_session_leader().

  To fix this issue, we move "put_pid(current->signal->tty_old_pgrp)" after
  "tty->ctrl.pgrp = NULL".
- Leds: trigger: ledtrig-cpu:: Fix 'output may be truncated' issue for
  'cpu' [Christophe JAILLET]

  [ Upstream commit ff50f53276131a3059e8307d11293af388ed2bcd ]

  In order to teach the compiler that 'trig->name' will never be truncated,
  we need to tell it that 'cpu' is not negative.

  When building with W=1, this fixes the following warnings:

    drivers/leds/trigger/ledtrig-cpu.c: In function ‘ledtrig_cpu_init’:
    drivers/leds/trigger/ledtrig-cpu.c:155:56: error: ‘%d’ directive output may be truncated writing between 1 and 11 bytes into a region of size 5 [-Werror=format-truncation=]
      155 |                 snprintf(trig->name, MAX_NAME_LEN, "cpu%d", cpu);
          |                                                        ^~
    drivers/leds/trigger/ledtrig-cpu.c:155:52: note: directive argument in the range [-2147483648, 7]
      155 |                 snprintf(trig->name, MAX_NAME_LEN, "cpu%d", cpu);
          |                                                    ^~~~~~~
    drivers/leds/trigger/ledtrig-cpu.c:155:17: note: ‘snprintf’ output between 5 and 15 bytes into a destination of size 8
      155 |                 snprintf(trig->name, MAX_NAME_LEN, "cpu%d", cpu);
          |                 ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Leds: pwm: Don't disable the PWM when the LED should be off. [Uwe
  Kleine-König]

  [ Upstream commit 76fe464c8e64e71b2e4af11edeef0e5d85eeb6aa ]

  Disabling a PWM (i.e. calling pwm_apply_state with .enabled = false)
  gives no guarantees what the PWM output does. It might freeze where it
  currently is, or go in a High-Z state or drive the active or inactive
  state, it might even continue to toggle.

  To ensure that the LED gets really disabled, don't disable the PWM even
  when .duty_cycle is zero.

  This fixes disabling a leds-pwm LED on i.MX28. The PWM on this SoC is
  one of those that freezes its output on disable, so if you disable an
  LED that is full on, it stays on. If you disable a LED with half
  brightness it goes off in 50% of the cases and full on in the other 50%.
- Mfd: dln2: Fix double put in dln2_probe. [Dinghao Liu]

  [ Upstream commit 759c409bc5fc496cbc22cd0b392d3cbb0c0e23eb ]

  The dln2_free() already contains usb_put_dev(). Therefore,
  the redundant usb_put_dev() before dln2_free() may lead to
  a double free.
- Mfd: core: Ensure disabled devices are skipped without aborting.
  [Herve Codina]

  [ Upstream commit 7ba7bdef4d14e3722e2842da3b48cbadb73e52d6 ]

  The loop searching for a matching device based on its compatible
  string is aborted when a matching disabled device is found.
  This abort prevents to add devices as soon as one disabled device
  is found.

  Continue searching for an other device instead of aborting on the
  first disabled one fixes the issue.
- Mfd: core: Un-constify mfd_cell.of_reg. [Michał Mirosław]

  [ Upstream commit 3c70342f1f0045dc827bb2f02d814ce31e0e0d05 ]

  Enable dynamically filling in the whole mfd_cell structure. All other
  fields already allow that.
- ASoC: ams-delta.c: use component after check. [Kuninori Morimoto]

  [ Upstream commit bd0f7498bc9084d8cccc5484cd004b40f314b763 ]

  	static void cx81801_close()
  	{
  		...
  (A)		struct snd_soc_dapm_context *dapm = &component->card->dapm;
  		...
  (B)		if (!component)
  			return;
  	}

  (A) uses component before NULL check (B). This patch moves it after (B).
- Padata: Fix refcnt handling in padata_free_shell() [WangJinchao]

  [ Upstream commit 7ddc21e317b360c3444de3023bcc83b85fabae2f ]

  In a high-load arm64 environment, the pcrypt_aead01 test in LTP can lead
  to system UAF (Use-After-Free) issues. Due to the lengthy analysis of
  the pcrypt_aead01 function call, I'll describe the problem scenario
  using a simplified model:

  Suppose there's a user of padata named `user_function` that adheres to
  the padata requirement of calling `padata_free_shell` after `serial()`
  has been invoked, as demonstrated in the following code:

  ```c
  struct request {
      struct padata_priv padata;
      struct completion *done;
  };

  void parallel(struct padata_priv *padata) {
      do_something();
  }

  void serial(struct padata_priv *padata) {
      struct request *request = container_of(padata,
      				struct request,
  				padata);
      complete(request->done);
  }

  void user_function() {
      DECLARE_COMPLETION(done)
      padata->parallel = parallel;
      padata->serial = serial;
      padata_do_parallel();
      wait_for_completion(&done);
      padata_free_shell();
  }
  ```

  In the corresponding padata.c file, there's the following code:

  ```c
  static void padata_serial_worker(struct work_struct *serial_work) {
      ...
      cnt = 0;

      while (!list_empty(&local_list)) {
          ...
          padata->serial(padata);
          cnt++;
      }

      local_bh_enable();

      if (refcount_sub_and_test(cnt, &pd->refcnt))
          padata_free_pd(pd);
  }
  ```

  Because of the high system load and the accumulation of unexecuted
  softirq at this moment, `local_bh_enable()` in padata takes longer
  to execute than usual. Subsequently, when accessing `pd->refcnt`,
  `pd` has already been released by `padata_free_shell()`, resulting
  in a UAF issue with `pd->refcnt`.

  The fix is straightforward: add `refcount_dec_and_test` before calling
  `padata_free_pd` in `padata_free_shell`.
- Padata: Convert from atomic_t to refcount_t on parallel_data->refcnt.
  [Xiyu Yang]

  [ Upstream commit d5ee8e750c9449e9849a09ce6fb6b8adeaa66adc ]

  refcount_t type and corresponding API can protect refcounters from
  accidental underflow and overflow and further use-after-free situations.
- ASoC: Intel: Skylake: Fix mem leak when parsing UUIDs fails. [Cezary
  Rojewski]

  [ Upstream commit 168d97844a61db302dec76d44406e9d4d7106b8e ]

  Error path in snd_skl_parse_uuids() shall free last allocated module if
  its instance_id allocation fails.
- HID: logitech-hidpp: Move get_wireless_feature_index() check to
  hidpp_connect_event() [Hans de Goede]

  [ Upstream commit ba9de350509504fb748837b71e23d7e84c83d93c ]

  Calling get_wireless_feature_index() from probe() causes
  the wireless_feature_index to only get set for unifying devices which
  are already connected at probe() time. It does not get set for devices
  which connect later.

  Fix this by moving get_wireless_feature_index() to hidpp_connect_event(),
  this does not make a difference for devices connected at probe() since
  probe() will queue the hidpp_connect_event() for those at probe time.

  This series has been tested on the following devices:
  Logitech Bluetooth Laser Travel Mouse (bluetooth, HID++ 1.0)
  Logitech M720 Triathlon (bluetooth, HID++ 4.5)
  Logitech M720 Triathlon (unifying, HID++ 4.5)
  Logitech K400 Pro (unifying, HID++ 4.1)
  Logitech K270 (eQUAD nano Lite, HID++ 2.0)
  Logitech M185 (eQUAD nano Lite, HID++ 4.5)
  Logitech LX501 keyboard (27 Mhz, HID++ builtin scroll-wheel, HID++ 1.0)
  Logitech M-RAZ105 mouse (27 Mhz, HID++ extra mouse buttons, HID++ 1.0)

  And by bentiss:
  Logitech Touchpad T650 (unifying)
  Logitech Touchpad T651 (bluetooth)
  Logitech MX Master 3B (BLE)
  Logitech G403 (plain USB / Gaming receiver)
- HID: logitech-hidpp: Revert "Don't restart communication if not
  necessary" [Hans de Goede]

  [ Upstream commit 55bf70362ffc4ddd7c8745e2fe880edac00e4aff ]

  Commit 91cf9a98ae41 ("HID: logitech-hidpp: make .probe usbhid capable")
  makes hidpp_probe() first call hid_hw_start(hdev, 0) to allow IO
  without connecting any hid subdrivers (hid-input, hidraw).

  This is done to allow to retrieve the device's name and serial number
  and store these in hdev->name and hdev->uniq.

  Then later on IO was stopped and started again with hid_hw_start(hdev,
  HID_CONNECT_DEFAULT) connecting hid-input and hidraw after the name
  and serial number have been setup.

  Commit 498ba2069035 ("HID: logitech-hidpp: Don't restart communication
  if not necessary") changed the probe() code to only do the start with
  a 0 connect-mask + restart later for unifying devices.

  But for non unifying devices hdev->name and hdev->uniq are updated too.
  So this change re-introduces the problem for which the start with
  a 0 connect-mask + restart later behavior was introduced.

  The previous patch in this series changes the unifying path to instead of
  restarting IO only call hid_connect() later. This avoids possible issues
  with restarting IO seen on non unifying devices.

  Revert the change to limit the restart behavior to unifying devices to
  fix hdev->name changing after userspace facing devices have already been
  registered.

  This series has been tested on the following devices:
  Logitech Bluetooth Laser Travel Mouse (bluetooth, HID++ 1.0)
  Logitech M720 Triathlon (bluetooth, HID++ 4.5)
  Logitech M720 Triathlon (unifying, HID++ 4.5)
  Logitech K400 Pro (unifying, HID++ 4.1)
  Logitech K270 (eQUAD nano Lite, HID++ 2.0)
  Logitech M185 (eQUAD nano Lite, HID++ 4.5)
  Logitech LX501 keyboard (27 Mhz, HID++ builtin scroll-wheel, HID++ 1.0)
  Logitech M-RAZ105 mouse (27 Mhz, HID++ extra mouse buttons, HID++ 1.0)

  And by bentiss:
  Logitech Touchpad T650 (unifying)
  Logitech Touchpad T651 (bluetooth)
  Logitech MX Master 3B (BLE)
  Logitech G403 (plain USB / Gaming receiver)
- HID: logitech-hidpp: Don't restart IO, instead defer hid_connect()
  only. [Hans de Goede]

  [ Upstream commit 11ca0322a41920df2b462d2e45b0731e47ff475b ]

  Restarting IO causes 2 problems:

  1. Some devices do not like IO being restarted this was addressed in
     commit 498ba2069035 ("HID: logitech-hidpp: Don't restart communication
     if not necessary"), but that change has issues of its own and needs to
     be reverted.

  2. Restarting IO and specifically calling hid_device_io_stop() causes
     received packets to be missed, which may cause connect-events to
     get missed.

  Restarting IO was introduced in commit 91cf9a98ae41 ("HID: logitech-hidpp:
  make .probe usbhid capable") to allow to retrieve the device's name and
  serial number and store these in hdev->name and hdev->uniq before
  connecting any hid subdrivers (hid-input, hidraw) exporting this info
  to userspace.

  But this does not require restarting IO, this merely requires deferring
  calling hid_connect(). Calling hid_hw_start() with a connect-mask of
  0 makes it skip calling hid_connect(), so hidpp_probe() can simply call
  hid_connect() later without needing to restart IO.

  Remove the stop + restart of IO and instead just call hid_connect() later
  to avoid the issues caused by restarting IO.

  Now that IO is no longer stopped, hid_hw_close() must be called at the end
  of probe() to balance the hid_hw_open() done at the beginning probe().

  This series has been tested on the following devices:
  Logitech Bluetooth Laser Travel Mouse (bluetooth, HID++ 1.0)
  Logitech M720 Triathlon (bluetooth, HID++ 4.5)
  Logitech M720 Triathlon (unifying, HID++ 4.5)
  Logitech K400 Pro (unifying, HID++ 4.1)
  Logitech K270 (eQUAD nano Lite, HID++ 2.0)
  Logitech M185 (eQUAD nano Lite, HID++ 4.5)
  Logitech LX501 keyboard (27 Mhz, HID++ builtin scroll-wheel, HID++ 1.0)
  Logitech M-RAZ105 mouse (27 Mhz, HID++ extra mouse buttons, HID++ 1.0)

  And by bentiss:
  Logitech Touchpad T650 (unifying)
  Logitech Touchpad T651 (bluetooth)
  Logitech MX Master 3B (BLE)
  Logitech G403 (plain USB / Gaming receiver)
- HID: logitech-hidpp: Remove HIDPP_QUIRK_NO_HIDINPUT quirk. [Bastien
  Nocera]

  [ Upstream commit d83956c8855c6c2ed4bd16cec4a5083d63df17e4 ]

  HIDPP_QUIRK_NO_HIDINPUT isn't used by any devices but still happens to
  work as HIDPP_QUIRK_DELAYED_INIT is defined to the same value. Remove
  HIDPP_QUIRK_NO_HIDINPUT and use HIDPP_QUIRK_DELAYED_INIT everywhere
  instead.

  Tested on a T650 which requires that quirk, and a number of unifying and
  Bluetooth devices that don't.
- Revert "HID: logitech-hidpp: add a module parameter to keep firmware
  gestures" [Bastien Nocera]

  [ Upstream commit cae253d6033da885e71c29c1591b22838a52de76 ]

  Now that we're in 2022, and the majority of desktop environments can and
  should support touchpad gestures through libinput, remove the legacy
  module parameter that made it possible to use gestures implemented in
  firmware.

  This will eventually allow simplifying the driver's initialisation code.

  This reverts commit 9188dbaed68a4b23dc96eba165265c08caa7dc2a.
- Sh: bios: Revive earlyprintk support. [Geert Uytterhoeven]

  [ Upstream commit 553f7ac78fbb41b2c93ab9b9d78e42274d27daa9 ]

  The SuperH BIOS earlyprintk code is protected by CONFIG_EARLY_PRINTK.
  However, when this protection was added, it was missed that SuperH no
  longer defines an EARLY_PRINTK config symbol since commit
  e76fe57447e88916 ("sh: Remove old early serial console code V2"), so
  BIOS earlyprintk can no longer be used.

  Fix this by reviving the EARLY_PRINTK config symbol.
- Hid: cp2112: Fix IRQ shutdown stopping polling for all IRQs on chip.
  [Danny Kaehn]

  [ Upstream commit dc3115e6c5d9863ec1a9ff1acf004ede93c34361 ]

  Previously cp2112_gpio_irq_shutdown() always cancelled the
  gpio_poll_worker, even if other IRQs were still active, and did not set
  the gpio_poll flag to false. This resulted in any call to _shutdown()
  resulting in interrupts no longer functioning on the chip until a
  _remove() occurred (a.e. the cp2112 is unplugged or system rebooted).

  Only cancel polling if all IRQs are disabled/masked, and correctly set
  the gpio_poll flag, allowing polling to restart when an interrupt is
  next enabled.
- RDMA/hfi1: Workaround truncation compilation error. [Leon Romanovsky]

  [ Upstream commit d4b2d165714c0ce8777d5131f6e0aad617b7adc4 ]

  Increase name array to be large enough to overcome the following
  compilation error.

  drivers/infiniband/hw/hfi1/efivar.c: In function ‘read_hfi1_efi_var’:
  drivers/infiniband/hw/hfi1/efivar.c:124:44: error: ‘snprintf’ output may be truncated before the last format character [-Werror=format-truncation=]
    124 |         snprintf(name, sizeof(name), "%s-%s", prefix_name, kind);
        |                                            ^
  drivers/infiniband/hw/hfi1/efivar.c:124:9: note: ‘snprintf’ output 2 or more bytes (assuming 65) into a destination of size 64
    124 |         snprintf(name, sizeof(name), "%s-%s", prefix_name, kind);
        |         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  drivers/infiniband/hw/hfi1/efivar.c:133:52: error: ‘snprintf’ output may be truncated before the last format character [-Werror=format-truncation=]
    133 |                 snprintf(name, sizeof(name), "%s-%s", prefix_name, kind);
        |                                                    ^
  drivers/infiniband/hw/hfi1/efivar.c:133:17: note: ‘snprintf’ output 2 or more bytes (assuming 65) into a destination of size 64
    133 |                 snprintf(name, sizeof(name), "%s-%s", prefix_name, kind);
        |                 ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  cc1: all warnings being treated as errors
  make[6]: *** [scripts/Makefile.build:243: drivers/infiniband/hw/hfi1/efivar.o] Error 1
- Scsi: ufs: core: Leave space for '\0' in utf8 desc string. [Daniel
  Mentz]

  [ Upstream commit a75a16c62a2540f11eeae4f2b50e95deefb652ea ]

  utf16s_to_utf8s does not NULL terminate the output string. For us to be
  able to add a NULL character when utf16s_to_utf8s returns, we need to make
  sure that there is space for such NULL character at the end of the output
  buffer. We can achieve this by passing an output buffer size to
  utf16s_to_utf8s that is one character less than what we allocated.

  Other call sites of utf16s_to_utf8s appear to be using the same technique
  where they artificially reduce the buffer size by one to leave space for a
  NULL character or line feed character.
- ASoC: fsl: Fix PM disable depth imbalance in fsl_easrc_probe. [Zhang
  Shurong]

  [ Upstream commit 9e630efb5a4af56fdb15aa10405f5cfd3f5f5b83 ]

  The pm_runtime_enable will increase power disable depth. Thus
  a pairing decrement is needed on the error handling path to
  keep it balanced according to context. We fix it by calling
  pm_runtime_disable when error returns.
- RDMA/hns: Fix signed-unsigned mixed comparisons. [Chengchang Tang]

  [ Upstream commit b5f9efff101b06fd06a5e280a2b00b1335f5f476 ]

  The ib_mtu_enum_to_int() and uverbs_attr_get_len() may returns a negative
  value. In this case, mixed comparisons of signed and unsigned types will
  throw wrong results.

  This patch adds judgement for this situation.
- RDMA/hns: Fix uninitialized ucmd in hns_roce_create_qp_common()
  [Chengchang Tang]

  [ Upstream commit c64e9710f9241e38a1c761ed1c1a30854784da66 ]

  ucmd in hns_roce_create_qp_common() are not initialized. But it works fine
  until new member sdb_addr is added to struct hns_roce_ib_create_qp.

  If the user-mode driver uses an old version ABI, then the value of the new
  member will be undefined after ib_copy_from_udata().

  This patch fixes it by initialize this variable to 0. And the default value
  of the new member sdb_addr will be 0 which is invalid.
- IB/mlx5: Fix rdma counter binding for RAW QP. [Patrisious Haddad]

  [ Upstream commit c1336bb4aa5e809a622a87d74311275514086596 ]

  Previously when we had a RAW QP, we bound a counter to it when it moved
  to INIT state, using the counter context inside RQC.

  But when we try to modify that counter later in RTS state we used
  modify QP which tries to change the counter inside QPC instead of RQC.

  Now we correctly modify the counter set_id inside of RQC instead of QPC
  for the RAW QP.
- ASoC: fsl: mpc5200_dma.c: Fix warning of Function parameter or member
  not described. [Kuninori Morimoto]

  [ Upstream commit 4a221b2e3340f4a3c2b414c46c846a26c6caf820 ]

  This patch fixes the warnings of "Function parameter or member 'xxx'
  not described".

  >> sound/soc/fsl/mpc5200_dma.c:116: warning: Function parameter or member 'component' not described in 'psc_dma_trigger'
     sound/soc/fsl/mpc5200_dma.c:116: warning: Function parameter or member 'substream' not described in 'psc_dma_trigger'
     sound/soc/fsl/mpc5200_dma.c:116: warning: Function parameter or member 'cmd' not described in 'psc_dma_trigger'
- Ext4: move 'ix' sanity check to corrent position. [Gou Hao]

  [ Upstream commit af90a8f4a09ec4a3de20142e37f37205d4687f28 ]

  Check 'ix' before it is used.
- ARM: 9321/1: memset: cast the constant byte to unsigned char. [Kursad
  Oney]

  [ Upstream commit c0e824661f443b8cab3897006c1bbc69fd0e7bc4 ]

  memset() description in ISO/IEC 9899:1999 (and elsewhere) says:

  	The memset function copies the value of c (converted to an
  	unsigned char) into each of the first n characters of the
  	object pointed to by s.

  The kernel's arm32 memset does not cast c to unsigned char. This results
  in the following code to produce erroneous output:

  	char a[128];
  	memset(a, -128, sizeof(a));

  This is because gcc will generally emit the following code before
  it calls memset() :

  	mov   r0, r7
  	mvn   r1, #127        ; 0x7f
  	bl    00000000 <memset>

  r1 ends up with 0xffffff80 before being used by memset() and the
  'a' array will have -128 once in every four bytes while the other
  bytes will be set incorrectly to -1 like this (printing the first
  8 bytes) :

  	test_module: -128 -1 -1 -1
  	test_module: -1 -1 -1 -128

  The change here is to 'and' r1 with 255 before it is used.
- Hid: cp2112: Fix duplicate workqueue initialization. [Danny Kaehn]

  [ Upstream commit e3c2d2d144c082dd71596953193adf9891491f42 ]

  Previously the cp2112 driver called INIT_DELAYED_WORK within
  cp2112_gpio_irq_startup, resulting in duplicate initilizations of the
  workqueue on subsequent IRQ startups following an initial request. This
  resulted in a warning in set_work_data in workqueue.c, as well as a rare
  NULL dereference within process_one_work in workqueue.c.

  Initialize the workqueue within _probe instead.
- Crypto: qat - increase size of buffers. [Giovanni Cabiddu]

  [ Upstream commit 4e4e2ed22d505c5bacf65c6a39bfb6d120d24785 ]

  Increase the size of the buffers used for composing the names used for
  the transport debugfs entries and the vector name to avoid a potential
  truncation.

  This resolves the following errors when compiling the driver with W=1
  and KCFLAGS=-Werror on GCC 12.3.1:

      drivers/crypto/intel/qat/qat_common/adf_transport_debug.c: In function ‘adf_ring_debugfs_add’:
      drivers/crypto/intel/qat/qat_common/adf_transport_debug.c:100:60: error: ‘snprintf’ output may be truncated before the last format character [-Werror=format-truncation=]
      drivers/crypto/intel/qat/qat_common/adf_isr.c: In function ‘adf_isr_resource_alloc’:
      drivers/crypto/intel/qat/qat_common/adf_isr.c:197:47: error: ‘%d’ directive output may be truncated writing between 1 and 11 bytes into a region of size between 0 and 5 [-Werror=format-truncation=]
- Crypto: qat - mask device capabilities with soft straps. [Giovanni
  Cabiddu]

  [ Upstream commit 7b07ed5042c5d21467af5aa055f2b49b2e661a83 ]

  Enable acceleration engines (AEs) and accelerators based on soft straps
  and fuses. When looping with a number of AEs or accelerators, ignore the
  ones that are disabled.

  This patch is based on earlier work done by Conor McLoughlin.
- Crypto: caam/jr - fix Chacha20 + Poly1305 self test failure. [Gaurav
  Jain]

  [ Upstream commit a8d3cdcc092fb2f2882acb6c20473a1be0ef4484 ]

  key buffer is not copied in chachapoly_setkey function,
  results in wrong output for encryption/decryption operation.

  fix this by memcpy the key in caam_ctx key arrary
- Crypto: caam/qi2 - fix Chacha20 + Poly1305 self test failure. [Gaurav
  Jain]

  [ Upstream commit 7b8c6aee0d5b864e70c0da82583f9862e374eaf3 ]

  key buffer is not copied in chachapoly_setkey function,
  results in wrong output for encryption/decryption operation.

  fix this by memcpy the key in caam_ctx key arrary
- Nd_btt: Make BTT lanes preemptible. [Tomas Glozar]

  [ Upstream commit 36c75ce3bd299878fd9b238e9803d3817ddafbf3 ]

  nd_region_acquire_lane uses get_cpu, which disables preemption. This is
  an issue on PREEMPT_RT kernels, since btt_write_pg and also
  nd_region_acquire_lane itself take a spin lock, resulting in BUG:
  sleeping function called from invalid context.

  Fix the issue by replacing get_cpu with smp_process_id and
  migrate_disable when needed. This makes BTT operations preemptible, thus
  permitting the use of spin_lock.

  BUG example occurring when running ndctl tests on PREEMPT_RT kernel:

  BUG: sleeping function called from invalid context at
  kernel/locking/spinlock_rt.c:48
  in_atomic(): 1, irqs_disabled(): 0, non_block: 0, pid: 4903, name:
  libndctl
  preempt_count: 1, expected: 0
  RCU nest depth: 0, expected: 0
  Preemption disabled at:
  [<ffffffffc1313db5>] nd_region_acquire_lane+0x15/0x90 [libnvdimm]
  Call Trace:
   <TASK>
   dump_stack_lvl+0x8e/0xb0
   __might_resched+0x19b/0x250
   rt_spin_lock+0x4c/0x100
   ? btt_write_pg+0x2d7/0x500 [nd_btt]
   btt_write_pg+0x2d7/0x500 [nd_btt]
   ? local_clock_noinstr+0x9/0xc0
   btt_submit_bio+0x16d/0x270 [nd_btt]
   __submit_bio+0x48/0x80
   __submit_bio_noacct+0x7e/0x1e0
   submit_bio_wait+0x58/0xb0
   __blkdev_direct_IO_simple+0x107/0x240
   ? inode_set_ctime_current+0x51/0x110
   ? __pfx_submit_bio_wait_endio+0x10/0x10
   blkdev_write_iter+0x1d8/0x290
   vfs_write+0x237/0x330
   ...
   </TASK>
- Libnvdimm/of_pmem: Use devm_kstrdup instead of kstrdup and check its
  return value. [Chen Ni]

  [ Upstream commit 6fd4ebfc4d61e3097b595ab2725d513e3bbd6739 ]

  Use devm_kstrdup() instead of kstrdup() and check its return value to
  avoid memory leak.
- Hwrng: geode - fix accessing registers. [Jonas Gorski]

  [ Upstream commit 464bd8ec2f06707f3773676a1bd2c64832a3c805 ]

  When the membase and pci_dev pointer were moved to a new struct in priv,
  the actual membase users were left untouched, and they started reading
  out arbitrary memory behind the struct instead of registers. This
  unfortunately turned the RNG into a constant number generator, depending
  on the content of what was at that offset.

  To fix this, update geode_rng_data_{read,present}() to also get the
  membase via amd_geode_priv, and properly read from the right addresses
  again.
- Crypto: hisilicon/hpre - Fix a erroneous check after snprintf()
  [Christophe JAILLET]

  [ Upstream commit c977950146720abff14e46d8c53f5638b06a9182 ]

  This error handling looks really strange.
  Check if the string has been truncated instead.
- Selftests/resctrl: Ensure the benchmark commands fits to its array.
  [Ilpo Järvinen]

  [ Upstream commit 4a28c7665c2a1ac0400864eabb0c641e135f61aa ]

  Benchmark command is copied into an array in the stack. The array is
  BENCHMARK_ARGS items long but the command line could try to provide a
  longer command. Argument size is also fixed by BENCHMARK_ARG_SIZE (63
  bytes of space after fitting the terminating \0 character) and user
  could have inputted argument longer than that.

  Return error in case the benchmark command does not fit to the space
  allocated for it.
- Selftests/pidfd: Fix ksft print formats. [Maciej Wieczor-Retman]

  [ Upstream commit 4d7f4e8158b62f63031510cdc24acc520956c091 ]

  Compiling pidfd selftest after adding a __printf() attribute to
  ksft_print_msg() and ksft_test_result_pass() exposes -Wformat warnings
  in error_report(), test_pidfd_poll_exec_thread(),
  child_poll_exec_test(), test_pidfd_poll_leader_exit_thread(),
  child_poll_leader_exit_test().

  The ksft_test_result_pass() in error_report() expects a string but
  doesn't provide any argument after the format string. All the other
  calls to ksft_print_msg() in the functions mentioned above have format
  strings that don't match with other passed arguments.

  Fix format specifiers so they match the passed variables.

  Add a missing variable to ksft_test_result_pass() inside
  error_report() so it matches other cases in the switch statement.
- Clk: scmi: Free scmi_clk allocated when the clocks with invalid info
  are skipped. [Sudeep Holla]

  [ Upstream commit 3537a75e73f3420614a358d0c8b390ea483cc87d ]

  Add the missing devm_kfree() when we skip the clocks with invalid or
  missing information from the firmware.
- Firmware: ti_sci: Mark driver as non removable. [Dhruva Gole]

  [ Upstream commit 7b7a224b1ba1703583b25a3641ad9798f34d832a ]

  The TI-SCI message protocol provides a way to communicate between
  various compute processors with a central system controller entity. It
  provides the fundamental device management capability and clock control
  in the SOCs that it's used in.

  The remove function failed to do all the necessary cleanup if
  there are registered users. Some things are freed however which
  likely results in an oops later on.

  Ensure that the driver isn't unbound by suppressing its bind and unbind
  sysfs attributes. As the driver is built-in there is no way to remove
  device once bound.

  We can also remove the ti_sci_remove call along with the
  ti_sci_debugfs_destroy as there are no callers for it any longer.
- Soc: qcom: llcc: Handle a second device without data corruption. [Uwe
  Kleine-König]

  [ Upstream commit f1a1bc8775b26345aba2be278118999e7f661d3d ]

  Usually there is only one llcc device. But if there were a second, even
  a failed probe call would modify the global drv_data pointer. So check
  if drv_data is valid before overwriting it.
- ARM: dts: qcom: mdm9615: populate vsdcc fixed regulator. [Krzysztof
  Kozlowski]

  [ Upstream commit 09f8ee81b6da5f76de8b83c8bfc4475b54e101e0 ]

  Fixed regulator put under "regulators" node will not be populated,
  unless simple-bus or something similar is used.  Drop the "regulators"
  wrapper node to fix this.
- Arm64: dts: qcom: sdm845-mtp: fix WiFi configuration. [Dmitry
  Baryshkov]

  [ Upstream commit b33868a52f342d9b1f20aa5bffe40cbd69bd0a4b ]

  Enable the host-cap-8bit quirk on this device. It is required for the
  WiFi to function properly.
- Arm64: dts: qcom: msm8916: Fix iommu local address range. [Gaurav
  Kohli]

  [ Upstream commit 2de8ee9f58fa51f707c71f8fbcd8470ab0078102 ]

  Fix the apps iommu local address space range as per data sheet.
- Xen-pciback: Consider INTx disabled when MSI/MSI-X is enabled. [Marek
  Marczykowski-Górecki]

  [ Upstream commit 2c269f42d0f382743ab230308b836ffe5ae9b2ae ]

  Linux enables MSI-X before disabling INTx, but keeps MSI-X masked until
  the table is filled. Then it disables INTx just before clearing MASKALL
  bit. Currently this approach is rejected by xen-pciback.
  According to the PCIe spec, device cannot use INTx when MSI/MSI-X is
  enabled (in other words: enabling MSI/MSI-X implicitly disables INTx).

  Change the logic to consider INTx disabled if MSI/MSI-X is enabled. This
  applies to three places:
   - checking currently enabled interrupts type,
   - transition to MSI/MSI-X - where INTx would be implicitly disabled,
   - clearing INTx disable bit - which can be allowed even if MSI/MSI-X is
     enabled, as device should consider INTx disabled anyway in that case
- Drm/rockchip: Fix type promotion bug in rockchip_gem_iommu_map() [Dan
  Carpenter]

  [ Upstream commit 6471da5ee311d53ef46eebcb7725bc94266cc0cf ]

  The "ret" variable is declared as ssize_t and it can hold negative error
  codes but the "rk_obj->base.size" variable is type size_t.  This means
  that when we compare them, they are both type promoted to size_t and the
  negative error code becomes a high unsigned value and is treated as
  success.  Add a cast to fix this.
- Arm64/arm: xen: enlighten: Fix KPTI checks. [Mark Rutland]

  [ Upstream commit 20f3b8eafe0ba5d3c69d5011a9b07739e9645132 ]

  When KPTI is in use, we cannot register a runstate region as XEN
  requires that this is always a valid VA, which we cannot guarantee. Due
  to this, xen_starting_cpu() must avoid registering each CPU's runstate
  region, and xen_guest_init() must avoid setting up features that depend
  upon it.

  We tried to ensure that in commit:

    f88af7229f6f22ce (" xen/arm: do not setup the runstate info page if kpti is enabled")

  ... where we added checks for xen_kernel_unmapped_at_usr(), which wraps
  arm64_kernel_unmapped_at_el0() on arm64 and is always false on 32-bit
  arm.

  Unfortunately, as xen_guest_init() is an early_initcall, this happens
  before secondary CPUs are booted and arm64 has finalized the
  ARM64_UNMAP_KERNEL_AT_EL0 cpucap which backs
  arm64_kernel_unmapped_at_el0(), and so this can subsequently be set as
  secondary CPUs are onlined. On a big.LITTLE system where the boot CPU
  does not require KPTI but some secondary CPUs do, this will result in
  xen_guest_init() intializing features that depend on the runstate
  region, and xen_starting_cpu() registering the runstate region on some
  CPUs before KPTI is subsequent enabled, resulting the the problems the
  aforementioned commit tried to avoid.

  Handle this more robsutly by deferring the initialization of the
  runstate region until secondary CPUs have been initialized and the
  ARM64_UNMAP_KERNEL_AT_EL0 cpucap has been finalized. The per-cpu work is
  moved into a new hotplug starting function which is registered later
  when we're certain that KPTI will not be used.
- Drm/rockchip: cdn-dp: Fix some error handling paths in cdn_dp_probe()
  [Christophe JAILLET]

  [ Upstream commit 44b968d0d0868b7a9b7a5c64464ada464ff4d532 ]

  cdn_dp_audio_codec_init() can fail. So add some error handling.

  If component_add() fails, the previous cdn_dp_audio_codec_init() call
  should be undone, as already done in the remove function.
- Drm/mediatek: Fix iommu fault during crtc enabling. [Jason-JH.Lin]

  [ Upstream commit 53412dc2905401207f264dc30890f6b9e41524a6 ]

  The difference between drm_atomic_helper_commit_tail() and
  drm_atomic_helper_commit_tail_rpm() is
  drm_atomic_helper_commit_tail() will commit plane first and
  then enable crtc, drm_atomic_helper_commit_tail_rpm() will
  enable crtc first and then commit plane.

  Before mediatek-drm enables crtc, the power and clk required
  by OVL have not been turned on, so the commit plane cannot be
  committed before crtc is enabled. That means OVL layer should
  not be enabled before crtc is enabled.
  Therefore, the atomic_commit_tail of mediatek-drm is hooked with
  drm_atomic_helper_commit_tail_rpm().

  Another reason is that the plane_state of drm_atomic_state is not
  synchronized with the plane_state stored in mtk_crtc during crtc enablng,
  so just set all planes to disabled.
- Drm/bridge: tc358768: Fix bit updates. [Tomi Valkeinen]

  [ Upstream commit 66962d5c3c51377b9b90cae35b7e038950438e02 ]

  The driver has a few places where it does:

  if (thing_is_enabled_in_config)
  	update_thing_bit_in_hw()

  This means that if the thing is _not_ enabled, the bit never gets
  cleared. This affects the h/vsyncs and continuous DSI clock bits.

  Fix the driver to always update the bit.
- Drm/bridge: tc358768: Disable non-continuous clock mode. [Dmitry
  Osipenko]

  [ Upstream commit fbc5a90e82c1131869e76ce5b082693b8a75c121 ]

  Non-continuous clock mode doesn't work because driver doesn't support it
  properly. The bridge driver programs wrong bitfields that are required by
  the non-continuous mode (BTACNTRL1 register bitfields are swapped in the
  code), but fixing them doesn't help.

  Display panel of ASUS Transformer TF700T tablet supports non-continuous
  mode and display doesn't work at all using that mode. There are no
  device-trees that are actively using this DSI bridge in upstream yet,
  so clearly the broken mode wasn't ever tested properly. It's a bit too
  difficult to get LP mode working, hence let's disable the offending mode
  for now and fall back to continuous mode.
- Drm/bridge: tc358768: Fix use of uninitialized variable. [Tomi
  Valkeinen]

  [ Upstream commit a2d9036615f0adfa5b0a46bb2ce42ef1d9a04fbe ]

  smatch reports:

  drivers/gpu/drm/bridge/tc358768.c:223 tc358768_update_bits() error: uninitialized symbol 'orig'.

  Fix this by bailing out from tc358768_update_bits() if the
  tc358768_read() produces an error.
- Drm/radeon: possible buffer overflow. [Konstantin Meskhidze]

  [ Upstream commit dd05484f99d16715a88eedfca363828ef9a4c2d4 ]

  Buffer 'afmt_status' of size 6 could overflow, since index 'afmt_idx' is
  checked after access.
- Drm/rockchip: vop: Fix call to crtc reset helper. [Jonas Karlman]

  [ Upstream commit 5aacd290837828c089a83ac9795c74c4c9e2c923 ]

  Allocation of crtc_state may fail in vop_crtc_reset, causing an invalid
  pointer to be passed to __drm_atomic_helper_crtc_reset.

  Fix this by adding a NULL check of crtc_state, similar to other drivers.
- Drm/rockchip: vop: Fix reset of state in duplicate state crtc funcs.
  [Jonas Karlman]

  [ Upstream commit 13fc28804bf10ca0b7bce3efbba95c534836d7ca ]

  struct rockchip_crtc_state members such as output_type, output_bpc and
  enable_afbc is always reset to zero in the atomic_duplicate_state crtc
  funcs.

  Fix this by using kmemdup on the subclass rockchip_crtc_state struct.
- Hwmon: (coretemp) Fix potentially truncated sysfs attribute name.
  [Zhang Rui]

  [ Upstream commit bbfff736d30e5283ad09e748caff979d75ddef7f ]

  When build with W=1 and "-Werror=format-truncation", below error is
  observed in coretemp driver,

     drivers/hwmon/coretemp.c: In function 'create_core_data':
  >> drivers/hwmon/coretemp.c:393:34: error: '%s' directive output may be truncated writing likely 5 or more bytes into a region of size between 3 and 13 [-Werror=format-truncation=]
       393 |                          "temp%d_%s", attr_no, suffixes[i]);
           |                                  ^~
     drivers/hwmon/coretemp.c:393:26: note: assuming directive output of 5 bytes
       393 |                          "temp%d_%s", attr_no, suffixes[i]);
           |                          ^~~~~~~~~~~
     drivers/hwmon/coretemp.c:392:17: note: 'snprintf' output 7 or more bytes (assuming 22) into a destination of size 19
       392 |                 snprintf(tdata->attr_name[i], CORETEMP_NAME_LENGTH,
           |                 ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       393 |                          "temp%d_%s", attr_no, suffixes[i]);
           |                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     cc1: all warnings being treated as errors

  Given that
  1. '%d' could take 10 charactors,
  2. '%s' could take 10 charactors ("crit_alarm"),
  3. "temp", "_" and the NULL terminator take 6 charactors,
  fix the problem by increasing CORETEMP_NAME_LENGTH to 28.
- Hwmon: (axi-fan-control) Fix possible NULL pointer dereference.
  [Dragos Bogdan]

  [ Upstream commit 2a5b3370a1d9750eca325292e291c8c7cb8cf2e0 ]

  axi_fan_control_irq_handler(), dependent on the private
  axi_fan_control_data structure, might be called before the hwmon
  device is registered. That will cause an "Unable to handle kernel
  NULL pointer dereference" error.
- Hwmon: (axi-fan-control) Support temperature vs pwm points. [Nuno Sá]

  [ Upstream commit 2aee7e67bee7a5aa741bad6a0a472f108b29ad40 ]

  The HW has some predefined points where it will associate a PWM value.
  However some users might want to better set these points to their
  usecases. This patch exposes these points as pwm auto_points:

   * pwm1_auto_point1_temp_hyst: temperature threshold below which PWM should
     be 0%;
   * pwm1_auto_point1_temp: temperature threshold above which PWM should be
     25%;
   * pwm1_auto_point2_temp_hyst: temperature threshold below which PWM should
     be 25%;
   * pwm1_auto_point2_temp: temperature threshold above which PWM should be
     50%;
   * pwm1_auto_point3_temp_hyst: temperature threshold below which PWM should
     be 50%;
   * pwm1_auto_point3_temp: temperature threshold above which PWM should be
     75%;
   * pwm1_auto_point4_temp_hyst: temperature threshold below which PWM should
     be 75%;
   * pwm1_auto_point4_temp: temperature threshold above which PWM should be
     100%;
- Platform/x86: wmi: Fix opening of char device. [Armin Wolf]

  [ Upstream commit eba9ac7abab91c8f6d351460239108bef5e7a0b6 ]

  Since commit fa1f68db6ca7 ("drivers: misc: pass miscdevice pointer via
  file private data"), the miscdevice stores a pointer to itself inside
  filp->private_data, which means that private_data will not be NULL when
  wmi_char_open() is called. This might cause memory corruption should
  wmi_char_open() be unable to find its driver, something which can
  happen when the associated WMI device is deleted in wmi_free_devices().

  Fix the problem by using the miscdevice pointer to retrieve the WMI
  device data associated with a char device using container_of(). This
  also avoids wmi_char_open() picking a wrong WMI device bound to a
  driver with the same name as the original driver.
- Platform/x86: wmi: remove unnecessary initializations. [Barnabás
  Pőcze]

  [ Upstream commit 43aacf838ef7384d985ef5385ecb0124f8c70007 ]

  Some pointers are initialized when they are defined,
  but they are almost immediately reassigned in the
  following lines. Remove these superfluous assignments.
- Platform/x86: wmi: Fix probe failure when failing to register WMI
  devices. [Armin Wolf]

  [ Upstream commit ed85891a276edaf7a867de0e9acd0837bc3008f2 ]

  When a WMI device besides the first one somehow fails to register,
  retval is returned while still containing a negative error code. This
  causes the ACPI device fail to probe, leaving behind zombie WMI devices
  leading to various errors later.

  Handle the single error path separately and return 0 unconditionally
  after trying to register all WMI devices to solve the issue. Also
  continue to register WMI devices even if some fail to allocate memory.
- Clk: qcom: config IPQ_APSS_6018 should depend on QCOM_SMEM.
  [Varadarajan Narayanan]

  [ Upstream commit 6a15647d0adc686226045e8046369f34d6ab03ed ]

  The config IPQ_APSS_6018 should depend on QCOM_SMEM, to
  avoid the following error reported by 'kernel test robot'

  	loongarch64-linux-ld: drivers/clk/qcom/apss-ipq6018.o: in function `apss_ipq6018_probe':
  	>> apss-ipq6018.c:(.text+0xd0): undefined reference to `qcom_smem_get_soc_id'
- Clk: mediatek: clk-mt2701: Add check for mtk_alloc_clk_data. [Jiasheng
  Jiang]

  [ Upstream commit 0d6e24b422a2166a9297a8286ff2e6ab9a5e8cd3 ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: mediatek: clk-mt7629: Add check for mtk_alloc_clk_data. [Jiasheng
  Jiang]

  [ Upstream commit 2befa515c1bb6cdd33c262b909d93d1973a219aa ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: mediatek: clk-mt7629-eth: Add check for mtk_alloc_clk_data.
  [Jiasheng Jiang]

  [ Upstream commit 0884393c63cc9a1772f7121a6645ba7bd76feeb9 ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: mediatek: clk-mt6797: Add check for mtk_alloc_clk_data. [Jiasheng
  Jiang]

  [ Upstream commit 606f6366a35a3329545e38129804d65ef26ed7d2 ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: mediatek: clk-mt6779: Add check for mtk_alloc_clk_data. [Jiasheng
  Jiang]

  [ Upstream commit 1f57f78fbacf630430bf954e5a84caafdfea30c0 ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: mediatek: clk-mt6765: Add check for mtk_alloc_clk_data. [Jiasheng
  Jiang]

  [ Upstream commit b82681042724924ae3ba0f2f2eeec217fa31e830 ]

  Add the check for the return value of mtk_alloc_clk_data() in order to
  avoid NULL pointer dereference.
- Clk: npcm7xx: Fix incorrect kfree. [Jonathan Neuschäfer]

  [ Upstream commit bbc5080bef4a245106aa8e8d424ba8847ca7c0ca ]

  The corresponding allocation is:

  > npcm7xx_clk_data = kzalloc(struct_size(npcm7xx_clk_data, hws,
  > 			     NPCM7XX_NUM_CLOCKS), GFP_KERNEL);

  ... so, kfree should be applied to npcm7xx_clk_data, not
  npcm7xx_clk_data->hws.
- Clk: ti: fix double free in of_ti_divider_clk_setup() [Dan Carpenter]

  [ Upstream commit 7af5b9eadd64c9e02a71f97c45bcdf3b64841f6b ]

  The "div" pointer is freed in _register_divider() and again in
  of_ti_divider_clk_setup().  Delete the free in _register_divider()
- Clk: ti: change ti_clk_register[_omap_hw]() API. [Dario Binacchi]

  [ Upstream commit 3400d546a741a2b2001d88e7fa29110d45a3930d ]

  The ti_clk_register() and ti_clk_register_omap_hw() functions are always
  called with the parameter of type "struct device" set to NULL, since the
  functions from which they are called always have a parameter of type
  "struct device_node". Replacing "struct device" type parameter with
  "struct device_node" will allow you to register a TI clock to the common
  clock framework by taking advantage of the facilities provided by the
  "struct device_node" type. Further, adding the "of_" prefix to the name
  of these functions explicitly binds them to the "struct device_node"
  type.

  The patch has been tested on a Beaglebone board.
- Clk: ti: Update component clocks to use ti_dt_clk_name() [Tony
  Lindgren]

  [ Upstream commit ed06099c5d0b329082cc19c58eace0b20bf7fe70 ]

  Let's update all the TI component clocks to use ti_dt_clk_name() instead
  of devicetree node name if available.
- Clk: ti: Update pll and clockdomain clocks to use ti_dt_clk_name()
  [Tony Lindgren]

  [ Upstream commit 9e56a7d4263ca1c51d867e811cf2dd7e61b6469e ]

  Let's update the TI pll and clockdomain clocks to use ti_dt_clk_name()
  instead of devicetree node name if available.
- Clk: ti: Add ti_dt_clk_name() helper to use clock-output-names. [Tony
  Lindgren]

  [ Upstream commit 2c1593328d7f02fe49de5ad6b42c36296c9d6922 ]

  Let's create the clock alias based on the clock-output-names property if
  available. Also the component clock drivers can use ti_dt_clk_name() in
  the following patches.
- Clk: keystone: pll: fix a couple NULL vs IS_ERR() checks. [Dan
  Carpenter]

  [ Upstream commit a5d14f8b551eb1551c10053653ee8e27f19672fa ]

  The clk_register_divider() and clk_register_mux() functions returns
  error pointers on error but this code checks for NULL.  Fix that.
- Spi: nxp-fspi: use the correct ioremap function. [Han Xu]

  [ Upstream commit c3aa5cb264a38ae9bbcce32abca4c155af0456df ]

  AHB memory as MMIO should be mapped with ioremap rather than ioremap_wc,
  which should have been used initially just to handle unaligned access as
  a workaround.
- Clk: linux/clk-provider.h: fix kernel-doc warnings and typos. [Randy
  Dunlap]

  [ Upstream commit 84aefafe6b294041b7fa0757414c4a29c1bdeea2 ]

  Fix spelling of "Structure".

  Fix multiple kernel-doc warnings:

  clk-provider.h:269: warning: Function parameter or member 'recalc_rate' not described in 'clk_ops'
  clk-provider.h:468: warning: Function parameter or member 'parent_data' not described in 'clk_hw_register_fixed_rate_with_accuracy_parent_data'
  clk-provider.h:468: warning: Excess function parameter 'parent_name' description in 'clk_hw_register_fixed_rate_with_accuracy_parent_data'
  clk-provider.h:482: warning: Function parameter or member 'parent_data' not described in 'clk_hw_register_fixed_rate_parent_accuracy'
  clk-provider.h:482: warning: Excess function parameter 'parent_name' description in 'clk_hw_register_fixed_rate_parent_accuracy'
  clk-provider.h:687: warning: Function parameter or member 'flags' not described in 'clk_divider'
  clk-provider.h:1164: warning: Function parameter or member 'flags' not described in 'clk_fractional_divider'
  clk-provider.h:1164: warning: Function parameter or member 'approximation' not described in 'clk_fractional_divider'
  clk-provider.h:1213: warning: Function parameter or member 'flags' not described in 'clk_multiplier'
- Clk: asm9260: use parent index to link the reference clock. [Dmitry
  Baryshkov]

  [ Upstream commit f5290d8e4f0caa81a491448a27dd70e726095d07 ]

  Rewrite clk-asm9260 to use parent index to use the reference clock.
  During this rework two helpers are added:

  - clk_hw_register_mux_table_parent_data() to supplement
    clk_hw_register_mux_table() but using parent_data instead of
    parent_names

  - clk_hw_register_fixed_rate_parent_accuracy() to be used instead of
    directly calling __clk_hw_register_fixed_rate(). The later function is
    an internal API, which is better not to be called directly.
- Clk: imx: imx8mq: correct error handling path. [Peng Fan]

  [ Upstream commit 577ad169966e6e75b10e004389a3f79813e84b5d ]

  Avoid memory leak in error handling path. It does not make
  much sense for the SoC without clk driver, to make program behavior
  correct, let's fix it.
- Clk: imx: Select MXC_CLK for CLK_IMX8QXP. [Abel Vesa]

  [ Upstream commit 317e69c49b4ceef8aebb47d771498ccb3571bdf9 ]

  If the i.MX8QXP clock provider is built-in but the MXC_CLK is
  built as module, build fails:

  aarch64-linux-ld: drivers/clk/imx/clk-imx8-acm.o: in function `imx8_acm_clk_probe':
  clk-imx8-acm.c:(.text+0x3d0): undefined reference to `imx_check_clk_hws'

  Fix that by selecting MXC_CLK in case of CLK_IMX8QXP.
- Clk: qcom: gcc-sm8150: Fix gcc_sdcc2_apps_clk_src. [Danila Tikhonov]

  [ Upstream commit 7138c244fb293f24ce8ab782961022eff00a10c4 ]

  Set .flags = CLK_OPS_PARENT_ENABLE to fix "gcc_sdcc2_apps_clk_src: rcg
  didn't update its configuration" error.
- Clk: qcom: gcc-sm8150: use ARRAY_SIZE instead of specifying
  num_parents. [Dmitry Baryshkov]

  [ Upstream commit 60ca4670fd6436c07cea38472ebcee3b00f03bc7 ]

  Use ARRAY_SIZE() instead of manually specifying num_parents. This makes
  adding/removing entries to/from parent_data easy and errorproof.
- Clk: qcom: mmcc-msm8998: Fix the SMMU GDSC. [Konrad Dybcio]

  [ Upstream commit 1fc62c8347397faf4e18249e88ecd4470c0a5357 ]

  The SMMU GDSC doesn't have to be ALWAYS-ON and shouldn't feature the
  HW_CTRL flag (it's separate from hw_ctrl_addr).  In addition to that,
  it should feature a cxc entry for bimc_smmu_axi_clk and be marked as
  votable.

  Fix all of these issues.
- Clk: qcom: mmcc-msm8998: Set bimc_smmu_gdsc always on.
  [AngeloGioacchino Del Regno]

  [ Upstream commit 68e1d106eb4dceb61bc2818d829786b364fd502b ]

  This GDSC enables (or cuts!) power to the Multimedia Subsystem IOMMU
  (mmss smmu), which has bootloader pre-set secure contexts.
  In the event of a complete power loss, the secure contexts will be
  reset and the hypervisor will crash the SoC.

  To prevent this, and get a working multimedia subsystem, set this
  GDSC as always on.
- Clk: qcom: mmcc-msm8998: Don't check halt bit on some branch clks.
  [Konrad Dybcio]

  [ Upstream commit 9906c4140897bbdbff7bb71c6ae67903cb9954ce ]

  Some branch clocks are governed externally and we're only supposed to
  send a request concerning their shutdown, not actually ensure it happens.

  Use the BRANCH_HALT_SKIP define to skip checking the halt bit.
- Clk: qcom: mmcc-msm8998: Add hardware clockgating registers to some
  clks. [AngeloGioacchino Del Regno]

  [ Upstream commit fa92f3b093d6ca624f42d444d5a206f8724b6bb3 ]

  Hardware clock gating is supported on some of the clocks declared in
  there: ignoring that it does exist may lead to unstabilities on some
  firmwares.
  Add the HWCG registers where applicable to stop potential crashes.

  This was verified on a smartphone shipped with a recent MSM8998
  firmware, which will experience random crashes without this change.
- Clk: qcom: clk-rcg2: Fix clock rate overflow for high parent
  frequencies. [Devi Priya]

  [ Upstream commit f7b7d30158cff246667273bd2a62fc93ee0725d2 ]

  If the parent clock rate is greater than unsigned long max/2 then
  integer overflow happens when calculating the clock rate on 32-bit systems.
  As RCG2 uses half integer dividers, the clock rate is first being
  multiplied by 2 which will overflow the unsigned long max value.
  Hence, replace the common pattern of doing 64-bit multiplication
  and then a do_div() call with simpler mult_frac call.

  Fixes: bcd61c0f535a ("clk: qcom: Add support for root clock generators (RCGs)")
  Signed-off-by: Devi Priya <quic_devipriy@quicinc.com>
  Reviewed-by: Marijn Suijten <marijn.suijten@somainline.org>
  Link: https://lore.kernel.org/r/20230901073640.4973-1-quic_devipriy@quicinc.com
  [bjorn: Also drop unnecessary {} around single statements]
- Regmap: debugfs: Fix a erroneous check after snprintf() [Christophe
  JAILLET]

  [ Upstream commit d3601857e14de6369f00ae19564f1d817d175d19 ]

  This error handling looks really strange.
  Check if the string has been truncated instead.
- Ipvlan: properly track tx_errors. [Eric Dumazet]

  [ Upstream commit ff672b9ffeb3f82135488ac16c5c5eb4b992999b ]

  Both ipvlan_process_v4_outbound() and ipvlan_process_v6_outbound()
  increment dev->stats.tx_errors in case of errors.

  Unfortunately there are two issues :

  1) ipvlan_get_stats64() does not propagate dev->stats.tx_errors to user.

  2) Increments are not atomic. KCSAN would complain eventually.

  Use DEV_STATS_INC() to not miss an update, and change ipvlan_get_stats64()
  to copy the value back to user.
- Net: add DEV_STATS_READ() helper. [Eric Dumazet]

  [ Upstream commit 0b068c714ca9479d2783cc333fff5bc2d4a6d45c ]

  Companion of DEV_STATS_INC() & DEV_STATS_ADD().

  This is going to be used in the series.

  Use it in macsec_get_stats64().
- Ipv6: avoid atomic fragment on GSO packets. [Yan Zhai]

  [ Upstream commit 03d6c848bfb406e9ef6d9846d759e97beaeea113 ]

  When the ipv6 stack output a GSO packet, if its gso_size is larger than
  dst MTU, then all segments would be fragmented. However, it is possible
  for a GSO packet to have a trailing segment with smaller actual size
  than both gso_size as well as the MTU, which leads to an "atomic
  fragment". Atomic fragments are considered harmful in RFC-8021. An
  Existing report from APNIC also shows that atomic fragments are more
  likely to be dropped even it is equivalent to a no-op [1].

  Add an extra check in the GSO slow output path. For each segment from
  the original over-sized packet, if it fits with the path MTU, then avoid
  generating an atomic fragment.
- ACPI: sysfs: Fix create_pnp_modalias() and create_of_modalias()
  [Christophe JAILLET]

  [ Upstream commit 48cf49d31994ff97b33c4044e618560ec84d35fb ]

  snprintf() does not return negative values on error.

  To know if the buffer was too small, the returned value needs to be
  compared with the length of the passed buffer. If it is greater or
  equal, the output has been truncated, so add checks for the truncation
  to create_pnp_modalias() and create_of_modalias(). Also make them
  return -ENOMEM in that case, as they already do that elsewhere.

  Moreover, the remaining size of the buffer used by snprintf() needs to
  be updated after the first write to avoid out-of-bounds access as
  already done correctly in create_pnp_modalias(), but not in
  create_of_modalias(), so change the latter accordingly.

  Fixes: 8765c5ba1949 ("ACPI / scan: Rework modalias creation when "compatible" is present")
  Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
  [ rjw: Merge two patches into one, combine changelogs, add subject ]
- Tcp: fix cookie_init_timestamp() overflows. [Eric Dumazet]

  [ Upstream commit 73ed8e03388d16c12fc577e5c700b58a29045a15 ]

  cookie_init_timestamp() is supposed to return a 64bit timestamp
  suitable for both TSval determination and setting of skb->tstamp.

  Unfortunately it uses 32bit fields and overflows after
  2^32 * 10^6 nsec (~49 days) of uptime.

  Generated TSval are still correct, but skb->tstamp might be set
  far away in the past, potentially confusing other layers.

  tcp_ns_to_ts() is changed to return a full 64bit value,
  ts and ts_now variables are changed to u64 type,
  and TSMASK is removed in favor of shifts operations.

  While we are at it, change this sequence:
  		ts >>= TSBITS;
  		ts--;
  		ts <<= TSBITS;
  		ts |= options;
  to:
  		ts -= (1UL << TSBITS);
- Chtls: fix tp->rcv_tstamp initialization. [Eric Dumazet]

  [ Upstream commit 225d9ddbacb102621af6d28ff7bf5a0b4ce249d8 ]

  tp->rcv_tstamp should be set to tcp_jiffies, not tcp_time_stamp().
- R8169: fix rare issue with broken rx after link-down on RTL8125.
  [Heiner Kallweit]

  [ Upstream commit 621735f590643e3048ca2060c285b80551660601 ]

  In very rare cases (I've seen two reports so far about different
  RTL8125 chip versions) it seems the MAC locks up when link goes down
  and requires a software reset to get revived.
  Realtek doesn't publish hw errata information, therefore the root cause
  is unknown. Realtek vendor drivers do a full hw re-initialization on
  each link-up event, the slimmed-down variant here was reported to fix
  the issue for the reporting user.
  It's not fully clear which parts of the NIC are reset as part of the
  software reset, therefore I can't rule out side effects.
- R8169: use tp_to_dev instead of open code. [Juhee Kang]

  [ Upstream commit 4b6c6065fca123d419afef005a696f51e6590470 ]

  The open code is defined as a helper function(tp_to_dev) on r8169_main.c,
  which the open code is &tp->pci_dev->dev. The helper function was added
  in commit 1e1205b7d3e9 ("r8169: add helper tp_to_dev"). And then later,
  commit f1e911d5d0df ("r8169: add basic phylib support") added
  r8169_phylink_handler function but it didn't use the helper function.
  Thus, tp_to_dev() replaces the open code. This patch doesn't change logic.
- Thermal: core: prevent potential string overflow. [Dan Carpenter]

  [ Upstream commit c99626092efca3061b387043d4a7399bf75fbdd5 ]

  The dev->id value comes from ida_alloc() so it's a number between zero
  and INT_MAX.  If it's too high then these sprintf()s will overflow.
- PM / devfreq: rockchip-dfi: Make pmu regmap mandatory. [Sascha Hauer]

  [ Upstream commit 1e0731c05c985deb68a97fa44c1adcd3305dda90 ]

  As a matter of fact the regmap_pmu already is mandatory because
  it is used unconditionally in the driver. Bail out gracefully in
  probe() rather than crashing later.
- Can: dev: can_restart(): fix race condition between controller restart
  and netif_carrier_on() [Marc Kleine-Budde]

  [ Upstream commit 6841cab8c4504835e4011689cbdb3351dec693fd ]

  This race condition was discovered while updating the at91_can driver
  to use can_bus_off(). The following scenario describes how the
  converted at91_can driver would behave.

  When a CAN device goes into BUS-OFF state, the driver usually
  stops/resets the CAN device and calls can_bus_off().

  This function sets the netif carrier to off, and (if configured by
  user space) schedules a delayed work that calls can_restart() to
  restart the CAN device.

  The can_restart() function first checks if the carrier is off and
  triggers an error message if the carrier is OK.

  Then it calls the driver's do_set_mode() function to restart the
  device, then it sets the netif carrier to on. There is a race window
  between these two calls.

  The at91 CAN controller (observed on the sama5d3, a single core 32 bit
  ARM CPU) has a hardware limitation. If the device goes into bus-off
  while sending a CAN frame, there is no way to abort the sending of
  this frame. After the controller is enabled again, another attempt is
  made to send it.

  If the bus is still faulty, the device immediately goes back to the
  bus-off state. The driver calls can_bus_off(), the netif carrier is
  switched off and another can_restart is scheduled. This occurs within
  the race window before the original can_restart() handler marks the
  netif carrier as OK. This would cause the 2nd can_restart() to be
  called with an OK netif carrier, resulting in an error message.

  The flow of the 1st can_restart() looks like this:

  can_restart()
      // bail out if netif_carrier is OK

      netif_carrier_ok(dev)
      priv->do_set_mode(dev, CAN_MODE_START)
          // enable CAN controller
          // sama5d3 restarts sending old message

          // CAN devices goes into BUS_OFF, triggers IRQ

  // IRQ handler start
      at91_irq()
          at91_irq_err_line()
              can_bus_off()
                  netif_carrier_off()
                  schedule_delayed_work()
  // IRQ handler end

      netif_carrier_on()

  The 2nd can_restart() will be called with an OK netif carrier and the
  error message will be printed.

  To close the race window, first set the netif carrier to on, then
  restart the controller. In case the restart fails with an error code,
  roll back the netif carrier to off.
- Can: dev: can_restart(): don't crash kernel if carrier is OK. [Marc
  Kleine-Budde]

  [ Upstream commit fe5c9940dfd8ba0c73672dddb30acd1b7a11d4c7 ]

  During testing, I triggered a can_restart() with the netif carrier
  being OK [1]. The BUG_ON, which checks if the carrier is OK, results
  in a fatal kernel crash. This is neither helpful for debugging nor for
  a production system.

  [1] The root cause is a race condition in can_restart() which will be
  fixed in the next patch.

  Do not crash the kernel, issue an error message instead, and continue
  restarting the CAN device anyway.
- Wifi: rtlwifi: fix EDCA limit set by BT coexistence. [Dmitry Antipov]

  [ Upstream commit 3391ee7f9ea508c375d443cd712c2e699be235b4 ]

  In 'rtl92c_dm_check_edca_turbo()', 'rtl88e_dm_check_edca_turbo()',
  and 'rtl8723e_dm_check_edca_turbo()', the DL limit should be set
  from the corresponding field of 'rtlpriv->btcoexist' rather than
  UL. Compile tested only.
- Tcp_metrics: do not create an entry from tcp_init_metrics() [Eric
  Dumazet]

  [ Upstream commit a135798e6e200ecb2f864cecca6d257ba278370c ]

  tcp_init_metrics() only wants to get metrics if they were
  previously stored in the cache. Creating an entry is adding
  useless costs, especially when tcp_no_metrics_save is set.
- Tcp_metrics: properly set tp->snd_ssthresh in tcp_init_metrics() [Eric
  Dumazet]

  [ Upstream commit 081480014a64a69d901f8ef1ffdd56d6085cf87e ]

  We need to set tp->snd_ssthresh to TCP_INFINITE_SSTHRESH
  in the case tcp_get_metrics() fails for some reason.
- Tcp_metrics: add missing barriers on delete. [Eric Dumazet]

  [ Upstream commit cbc3a153222805d65f821e10f4f78b6afce06f86 ]

  When removing an item from RCU protected list, we must prevent
  store-tearing, using rcu_assign_pointer() or WRITE_ONCE().
- Wifi: mt76: mt7603: rework/fix rx pse hang check. [Felix Fietkau]

  [ Upstream commit baa19b2e4b7bbb509a7ca7939c8785477dcd40ee ]

  It turns out that the code in mt7603_rx_pse_busy() does not detect actual
  hardware hangs, it only checks for busy conditions in PSE.
  A reset should only be performed if these conditions are true and if there
  is no rx activity as well.
  Reset the counter whenever a rx interrupt occurs. In order to also deal with
  a fully loaded CPU that leaves interrupts disabled with continuous NAPI
  polling, also check for pending rx interrupts in the function itself.
- Wifi: rtw88: debug: Fix the NULL vs IS_ERR() bug for
  debugfs_create_file() [Jinjie Ruan]

  [ Upstream commit 74f7957c9b1b95553faaf146a2553e023a9d1720 ]

  Since debugfs_create_file() return ERR_PTR and never return NULL, so use
  IS_ERR() to check it instead of checking NULL.
- Net: spider_net: Use size_add() in call to struct_size() [Gustavo A.
  R. Silva]

  [ Upstream commit 0201409079b975e46cc40e8bdff4bd61329ee10f ]

  If, for any reason, the open-coded arithmetic causes a wraparound,
  the protection that `struct_size()` adds against potential integer
  overflows is defeated. Fix this by hardening call to `struct_size()`
  with `size_add()`.
- Tipc: Use size_add() in calls to struct_size() [Gustavo A. R. Silva]

  [ Upstream commit 2506a91734754de690869824fb0d1ac592ec1266 ]

  If, for any reason, the open-coded arithmetic causes a wraparound,
  the protection that `struct_size()` adds against potential integer
  overflows is defeated. Fix this by hardening call to `struct_size()`
  with `size_add()`.
- Mlxsw: Use size_mul() in call to struct_size() [Gustavo A. R. Silva]

  [ Upstream commit e22c6ea025013ae447fe269269753ffec763dde5 ]

  If, for any reason, the open-coded arithmetic causes a wraparound, the
  protection that `struct_size()` adds against potential integer overflows
  is defeated. Fix this by hardening call to `struct_size()` with `size_mul()`.
- Gve: Use size_add() in call to struct_size() [Gustavo A. R. Silva]

  [ Upstream commit d692873cbe861a870cdc9cbfb120eefd113c3dfd ]

  If, for any reason, `tx_stats_num + rx_stats_num` wraps around, the
  protection that struct_size() adds against potential integer overflows
  is defeated. Fix this by hardening call to struct_size() with size_add().
- Overflow: Implement size_t saturating arithmetic helpers. [Kees Cook]

  [ Upstream commit e1be43d9b5d0d1310dbd90185a8e5c7145dde40f ]

  In order to perform more open-coded replacements of common allocation
  size arithmetic, the kernel needs saturating (SIZE_MAX) helpers for
  multiplication, addition, and subtraction. For example, it is common in
  allocators, especially on realloc, to add to an existing size:

      p = krealloc(map->patch,
                   sizeof(struct reg_sequence) * (map->patch_regs + num_regs),
                   GFP_KERNEL);

  There is no existing saturating replacement for this calculation, and
  just leaving the addition open coded inside array_size() could
  potentially overflow as well. For example, an overflow in an expression
  for a size_t argument might wrap to zero:

      array_size(anything, something_at_size_max + 1) == 0

  Introduce size_mul(), size_add(), and size_sub() helpers that
  implicitly promote arguments to size_t and saturated calculations for
  use in allocations. With these helpers it is also possible to redefine
  array_size(), array3_size(), flex_array_size(), and struct_size() in
  terms of the new helpers.

  As with the check_*_overflow() helpers, the new helpers use __must_check,
  though what is really desired is a way to make sure that assignment is
  only to a size_t lvalue. Without this, it's still possible to introduce
  overflow/underflow via type conversion (i.e. from size_t to int).
  Enforcing this will currently need to be left to static analysis or
  future use of -Wconversion.

  Additionally update the overflow unit tests to force runtime evaluation
  for the pathological cases.
- Tcp: call tcp_try_undo_recovery when an RTOd TFO SYNACK is ACKed.
  [Aananth V]

  [ Upstream commit e326578a21414738de45f77badd332fb00bd0f58 ]

  For passive TCP Fast Open sockets that had SYN/ACK timeout and did not
  send more data in SYN_RECV, upon receiving the final ACK in 3WHS, the
  congestion state may awkwardly stay in CA_Loss mode unless the CA state
  was undone due to TCP timestamp checks. However, if
  tcp_rcv_synrecv_state_fastopen() decides not to undo, then we should
  enter CA_Open, because at that point we have received an ACK covering
  the retransmitted SYNACKs. Currently, the icsk_ca_state is only set to
  CA_Open after we receive an ACK for a data-packet. This is because
  tcp_ack does not call tcp_fastretrans_alert (and tcp_process_loss) if
  !prior_packets

  Note that tcp_process_loss() calls tcp_try_undo_recovery(), so having
  tcp_rcv_synrecv_state_fastopen() decide that if we're in CA_Loss we
  should call tcp_try_undo_recovery() is consistent with that, and
  low risk.
- Udp: add missing WRITE_ONCE() around up->encap_rcv. [Eric Dumazet]

  [ Upstream commit 6d5a12eb91224d707f8691dccb40a5719fe5466d ]

  UDP_ENCAP_ESPINUDP_NON_IKE setsockopt() writes over up->encap_rcv
  while other cpus read it.
- I40e: fix potential memory leaks in i40e_remove() [Andrii Staikov]

  [ Upstream commit 5ca636d927a106780451d957734f02589b972e2b ]

  Instead of freeing memory of a single VSI, make sure
  the memory for all VSIs is cleared before releasing VSIs.
  Add releasing of their resources in a loop with the iteration
  number equal to the number of allocated VSIs.
- Genirq/matrix: Exclude managed interrupts in irq_matrix_allocated()
  [Chen Yu]

  [ Upstream commit a0b0bad10587ae2948a7c36ca4ffc206007fbcf3 ]

  When a CPU is about to be offlined, x86 validates that all active
  interrupts which are targeted to this CPU can be migrated to the remaining
  online CPUs. If not, the offline operation is aborted.

  The validation uses irq_matrix_allocated() to retrieve the number of
  vectors which are allocated on the outgoing CPU. The returned number of
  allocated vectors includes also vectors which are associated to managed
  interrupts.

  That's overaccounting because managed interrupts are:

    - not migrated when the affinity mask of the interrupt targets only
      the outgoing CPU

    - migrated to another CPU, but in that case the vector is already
      pre-allocated on the potential target CPUs and must not be taken into
      account.

  As a consequence the check whether the remaining online CPUs have enough
  capacity for migrating the allocated vectors from the outgoing CPU might
  fail incorrectly.

  Let irq_matrix_allocated() return only the number of allocated non-managed
  interrupts to make this validation check correct.

  [ tglx: Amend changelog and fixup kernel-doc comment ]
- Pstore/platform: Add check for kstrdup. [Jiasheng Jiang]

  [ Upstream commit a19d48f7c5d57c0f0405a7d4334d1d38fe9d3c1c ]

  Add check for the return value of kstrdup() and return the error
  if it fails in order to avoid NULL pointer dereference.
- X86/boot: Fix incorrect startup_gdt_descr.size. [Yuntao Wang]

  [ Upstream commit 001470fed5959d01faecbd57fcf2f60294da0de1 ]

  Since the size value is added to the base address to yield the last valid
  byte address of the GDT, the current size value of startup_gdt_descr is
  incorrect (too large by one), fix it.

  [ mingo: This probably never mattered, because startup_gdt[] is only used
           in a very controlled fashion - but make it consistent nevertheless. ]
- Futex: Don't include process MM in futex key on no-MMU. [Ben
  Wolsieffer]

  [ Upstream commit c73801ae4f22b390228ebf471d55668e824198b6 ]

  On no-MMU, all futexes are treated as private because there is no need
  to map a virtual address to physical to match the futex across
  processes. This doesn't quite work though, because private futexes
  include the current process's mm_struct as part of their key. This makes
  it impossible for one process to wake up a shared futex being waited on
  in another process.

  Fix this bug by excluding the mm_struct from the key. With
  a single address space, the futex address is already a unique key.
- X86/srso: Fix SBPB enablement for (possible) future fixed HW. [Josh
  Poimboeuf]

  [ Upstream commit 1d1142ac51307145dbb256ac3535a1d43a1c9800 ]

  Make the SBPB check more robust against the (possible) case where future
  HW has SRSO fixed but doesn't have the SRSO_NO bit set.
- Vfs: fix readahead(2) on block devices. [Reuben Hawkins]

  [ Upstream commit 7116c0af4b8414b2f19fdb366eea213cbd9d91c2 ]

  Readahead was factored to call generic_fadvise.  That refactor added an
  S_ISREG restriction which broke readahead on block devices.

  In addition to S_ISREG, this change checks S_ISBLK to fix block device
  readahead.  There is no change in behavior with any file type besides block
  devices in this change.
- Sched/uclamp: Ignore (util == 0) optimization in feec() when
  p_util_max = 0. [Qais Yousef]

  [ Upstream commit 23c9519def98ee0fa97ea5871535e9b136f522fc ]

  find_energy_efficient_cpu() bails out early if effective util of the
  task is 0 as the delta at this point will be zero and there's nothing
  for EAS to do. When uclamp is being used, this could lead to wrong
  decisions when uclamp_max is set to 0. In this case the task is capped
  to performance point 0, but it is actually running and consuming energy
  and we can benefit from EAS energy calculations.

  Rework the condition so that it bails out when both util and uclamp_min
  are 0.

  We can do that without needing to use uclamp_task_util(); remove it.
- Iov_iter, x86: Be consistent about the __user tag on copy_mc_to_user()
  [David Howells]

  [ Upstream commit 066baf92bed934c9fb4bcee97a193f47aa63431c ]

  copy_mc_to_user() has the destination marked __user on powerpc, but not on
  x86; the latter results in a sparse warning in lib/iov_iter.c.

  Fix this by applying the tag on x86 too.

  Fixes: ec6347bb4339 ("x86, powerpc: Rename memcpy_mcsafe() to copy_mc_to_{user, kernel}()")
  Signed-off-by: David Howells <dhowells@redhat.com>
  Link: https://lore.kernel.org/r/20230925120309.1731676-3-dhowells@redhat.com
  cc: Dan Williams <dan.j.williams@intel.com>
  cc: Thomas Gleixner <tglx@linutronix.de>
  cc: Ingo Molnar <mingo@redhat.com>
  cc: Borislav Petkov <bp@alien8.de>
  cc: Dave Hansen <dave.hansen@linux.intel.com>
  cc: "H. Peter Anvin" <hpa@zytor.com>
  cc: Alexander Viro <viro@zeniv.linux.org.uk>
  cc: Jens Axboe <axboe@kernel.dk>
  cc: Christoph Hellwig <hch@lst.de>
  cc: Christian Brauner <christian@brauner.io>
  cc: Matthew Wilcox <willy@infradead.org>
  cc: Linus Torvalds <torvalds@linux-foundation.org>
  cc: David Laight <David.Laight@ACULAB.COM>
  cc: x86@kernel.org
  cc: linux-block@vger.kernel.org
  cc: linux-fsdevel@vger.kernel.org
  cc: linux-mm@kvack.org
- Linux 5.10.200. [Greg Kroah-Hartman]
- ALSA: hda: intel-dsp-config: Fix JSL Chromebook quirk detection. [Mark
  Hasemeyer]

  commit 7c05b44e1a50d9cbfc4f731dddc436a24ddc129a upstream.

  Some Jasperlake Chromebooks overwrite the system vendor DMI value to the
  name of the OEM that manufactured the device. This breaks Chromebook
  quirk detection as it expects the system vendor to be "Google".

  Add another quirk detection entry that looks for "Google" in the BIOS
  version.
- Tty: 8250: Add support for Intashield IS-100. [Cameron Williams]

  commit 4d994e3cf1b541ff32dfb03fbbc60eea68f9645b upstream.

  Add support for the Intashield IS-100 1 port serial card.
- Tty: 8250: Add support for Brainboxes UP cards. [Cameron Williams]

  commit 2c6fec1e1532f15350be7e14ba6b88a39d289fe4 upstream.

  Add support for the Brainboxes UP (powered PCI) range of
  cards, namely UP-189, UP-200, UP-869 and UP-880.
- Tty: 8250: Add support for additional Brainboxes UC cards. [Cameron
  Williams]

  commit c563db486db7d245c0e2f319443417ae8e692f7f upstream.

  Add device IDs for some more Brainboxes UC cards, namely
  UC-235/UC-246, UC-253/UC-734, UC-302, UC-313, UC-346, UC-357,
  UC-607 and UC-836.
- Tty: 8250: Remove UC-257 and UC-431. [Cameron Williams]

  commit 33092fb3af51deb80849e90a17bada44bbcde6b3 upstream.

  The UC-257 is a serial + LPT card, so remove it from this driver.
  A patch has been submitted to add it to parport_serial instead.

  Additionaly, the UC-431 does not use this card ID, only the UC-420
  does. The 431 is a 3-port card and there is no generic 3-port configuration
  available, so remove reference to it from this driver.
- Usb: raw-gadget: properly handle interrupted requests. [Andrey
  Konovalov]

  commit e8033bde451eddfb9b1bbd6e2d848c1b5c277222 upstream.

  Currently, if a USB request that was queued by Raw Gadget is interrupted
  (via a signal), wait_for_completion_interruptible returns -ERESTARTSYS.
  Raw Gadget then attempts to propagate this value to userspace as a return
  value from its ioctls. However, when -ERESTARTSYS is returned by a syscall
  handler, the kernel internally restarts the syscall.

  This doesn't allow userspace applications to interrupt requests queued by
  Raw Gadget (which is required when the emulated device is asked to switch
  altsettings). It also violates the implied interface of Raw Gadget that a
  single ioctl must only queue a single USB request.

  Instead, make Raw Gadget do what GadgetFS does: check whether the request
  was interrupted (dequeued with status == -ECONNRESET) and report -EINTR to
  userspace.
- Usb: storage: set 1.50 as the lower bcdDevice for older "Super Top"
  compatibility. [LihaSika]

  commit 0e3139e6543b241b3e65956a55c712333bef48ac upstream.

  Change lower bcdDevice value for "Super Top USB 2.0  SATA BRIDGE" to match
  1.50. I have such an older device with bcdDevice=1.50 and it will not work
  otherwise.
- PCI: Prevent xHCI driver from claiming AMD VanGogh USB3 DRD device.
  [Vicki Pfau]

  commit 7e6f3b6d2c352b5fde37ce3fed83bdf6172eebd4 upstream.

  The AMD VanGogh SoC contains a DesignWare USB3 Dual-Role Device that can be
  operated as either a USB Host or a USB Device, similar to on the AMD Nolan
  platform.

  be6646bfbaec ("PCI: Prevent xHCI driver from claiming AMD Nolan USB3 DRD
  device") added a quirk to let the dwc3 driver claim the Nolan device since
  it provides more specific support.

  Extend that quirk to include the VanGogh SoC USB3 device.

  Link: https://lore.kernel.org/r/20230927202212.2388216-1-vi@endrift.com
  Signed-off-by: Vicki Pfau <vi@endrift.com>
  [bhelgaas: include be6646bfbaec reference, add stable tag]
- Can: isotp: isotp_sendmsg(): fix TX state detection and wait behavior.
  [Lukas Magel]

  [ Upstream commit d9c2ba65e651467de739324d978b04ed8729f483 ]

  With patch [1], isotp_poll was updated to also queue the poller in the
  so->wait queue, which is used for send state changes. Since the queue
  now also contains polling tasks that are not interested in sending, the
  queue fill state can no longer be used as an indication of send
  readiness. As a consequence, nonblocking writes can lead to a race and
  lock-up of the socket if there is a second task polling the socket in
  parallel.

  With this patch, isotp_sendmsg does not consult wq_has_sleepers but
  instead tries to atomically set so->tx.state and waits on so->wait if it
  is unable to do so. This behavior is in alignment with isotp_poll, which
  also checks so->tx.state to determine send readiness.

  V2:
  - Revert direct exit to goto err_event_drop

  [1] https://lore.kernel.org/all/20230331125511.372783-1-michal.sojka@cvut.cz
- Can: isotp: isotp_bind(): do not validate unused address information.
  [Oliver Hartkopp]

  commit b76b163f46b661499921a0049982764a6659bfe7 upstream

  With commit 2aa39889c463 ("can: isotp: isotp_bind(): return -EINVAL on
  incorrect CAN ID formatting") the bind() syscall returns -EINVAL when
  the given CAN ID needed to be sanitized. But in the case of an unconfirmed
  broadcast mode the rx CAN ID is not needed and may be uninitialized from
  the caller - which is ok.

  This patch makes sure the result of an inproper CAN ID format is only
  provided when the address information is needed.
- Can: isotp: add local echo tx processing and tx without FC. [Oliver
  Hartkopp]

  commit 4b7fe92c06901f4563af0e36d25223a5ab343782 upstream
  commit 9f39d36530e5678d092d53c5c2c60d82b4dcc169 upstream
  commit 051737439eaee5bdd03d3c2ef5510d54a478fd05 upstream

  Due to the existing patch order applied to isotp.c in the stable kernel the
  original order of depending patches the three original patches
  4b7fe92c0690 ("can: isotp: add local echo tx processing for consecutive frames")
  9f39d36530e5 ("can: isotp: add support for transmission without flow control")
  051737439eae ("can: isotp: fix race between isotp_sendsmg() and isotp_release()")
  can not be split into different patches that can be applied in working steps
  to the stable tree.
- Can: isotp: handle wait_event_interruptible() return values. [Oliver
  Hartkopp]

  commit 823b2e42720f96f277940c37ea438b7c5ead51a4 upstream

  When wait_event_interruptible() has been interrupted by a signal the
  tx.state value might not be ISOTP_IDLE. Force the state machines
  into idle state to inhibit the timer handlers to continue working.
- Can: isotp: check CAN address family in isotp_bind() [Oliver Hartkopp]

  commit c6adf659a8ba85913e16a571d5a9bcd17d3d1234 upstream

  Add missing check to block non-AF_CAN binds.

  Syzbot created some code which matched the right sockaddr struct size
  but used AF_XDP (0x2C) instead of AF_CAN (0x1D) in the address family
  field:

  bind$xdp(r2, &(0x7f0000000540)={0x2c, 0x0, r4, 0x0, r2}, 0x10)
                                  ^^^^
  This has no funtional impact but the userspace should be notified about
  the wrong address family field content.
- Can: isotp: isotp_bind(): return -EINVAL on incorrect CAN ID
  formatting. [Oliver Hartkopp]

  commit 2aa39889c463195a0dfe2aff9fad413139c32a4f upstream

  Commit 3ea566422cbd ("can: isotp: sanitize CAN ID checks in
  isotp_bind()") checks the given CAN ID address information by
  sanitizing the input values.

  This check (silently) removes obsolete bits by masking the given CAN
  IDs.

  Derek Will suggested to give a feedback to the application programmer
  when the 'sanitizing' was actually needed which means the programmer
  provided CAN ID content in a wrong format (e.g. SFF CAN IDs with a CAN
  ID > 0x7FF).
- Can: isotp: set max PDU size to 64 kByte. [Oliver Hartkopp]

  commit 9c0c191d82a1de964ac953a1df8b5744ec670b07 upstream

  The reason to extend the max PDU size from 4095 Byte (12 bit length value)
  to a 32 bit value (up to 4 GByte) was to be able to flash 64 kByte
  bootloaders with a single ISO-TP PDU. The max PDU size in the Linux kernel
  implementation was set to 8200 Bytes to be able to test the length
  information escape sequence.

  It turns out that the demand for 64 kByte PDUs is real so the value for
  MAX_MSG_LENGTH is set to 66000 to be able to potentially add some checksums
  to the 65.536 Byte block.
- Can: isotp: Add error message if txqueuelen is too small. [Patrick
  Menschel]

  commit c69d190f7bb9a03cf5237d45a457993730d01605 upstream

  This patch adds an additional error message in case that txqueuelen is
  set too small and advices the user to increase txqueuelen.

  This is likely to happen even with small transfers if txqueuelen is at
  default value 10 frames.
- Can: isotp: add symbolic error message to isotp_module_init() [Patrick
  Menschel]

  commit 6a5ddae578842652719fb926b22f1d510fe50bee upstream

  This patch adds the value of err with format %pe to the already
  existing error message.
- Can: isotp: change error format from decimal to symbolic error names.
  [Patrick Menschel]

  commit 46d8657a6b284e32b6b3bf1a6c93ee507fdd3cdb upstream

  This patch changes the format string for errors from decimal %d to
  symbolic error names %pe to achieve more comprehensive log messages.
- Powerpc/mm: Fix boot crash with FLATMEM. [Michael Ellerman]

  [ Upstream commit daa9ada2093ed23d52b4c1fe6e13cf78f55cc85f ]

  Erhard reported that his G5 was crashing with v6.6-rc kernels:

    mpic: Setting up HT PICs workarounds for U3/U4
    BUG: Unable to handle kernel data access at 0xfeffbb62ffec65fe
    Faulting instruction address: 0xc00000000005dc40
    Oops: Kernel access of bad area, sig: 11 [#1]
    BE PAGE_SIZE=4K MMU=Hash SMP NR_CPUS=2 PowerMac
    Modules linked in:
    CPU: 0 PID: 0 Comm: swapper/0 Tainted: G                T  6.6.0-rc3-PMacGS #1
    Hardware name: PowerMac11,2 PPC970MP 0x440101 PowerMac
    NIP:  c00000000005dc40 LR: c000000000066660 CTR: c000000000007730
    REGS: c0000000022bf510 TRAP: 0380   Tainted: G                T (6.6.0-rc3-PMacGS)
    MSR:  9000000000001032 <SF,HV,ME,IR,DR,RI>  CR: 44004242  XER: 00000000
    IRQMASK: 3
    GPR00: 0000000000000000 c0000000022bf7b0 c0000000010c0b00 00000000000001ac
    GPR04: 0000000003c80000 0000000000000300 c0000000f20001ae 0000000000000300
    GPR08: 0000000000000006 feffbb62ffec65ff 0000000000000001 0000000000000000
    GPR12: 9000000000001032 c000000002362000 c000000000f76b80 000000000349ecd8
    GPR16: 0000000002367ba8 0000000002367f08 0000000000000006 0000000000000000
    GPR20: 00000000000001ac c000000000f6f920 c0000000022cd985 000000000000000c
    GPR24: 0000000000000300 00000003b0a3691d c0003e008030000e 0000000000000000
    GPR28: c00000000000000c c0000000f20001ee feffbb62ffec65fe 00000000000001ac
    NIP hash_page_do_lazy_icache+0x50/0x100
    LR  __hash_page_4K+0x420/0x590
    Call Trace:
      hash_page_mm+0x364/0x6f0
      do_hash_fault+0x114/0x2b0
      data_access_common_virt+0x198/0x1f0
    --- interrupt: 300 at mpic_init+0x4bc/0x10c4
    NIP:  c000000002020a5c LR: c000000002020a04 CTR: 0000000000000000
    REGS: c0000000022bf9f0 TRAP: 0300   Tainted: G                T (6.6.0-rc3-PMacGS)
    MSR:  9000000000001032 <SF,HV,ME,IR,DR,RI>  CR: 24004248  XER: 00000000
    DAR: c0003e008030000e DSISR: 40000000 IRQMASK: 1
    ...
    NIP mpic_init+0x4bc/0x10c4
    LR  mpic_init+0x464/0x10c4
    --- interrupt: 300
      pmac_setup_one_mpic+0x258/0x2dc
      pmac_pic_init+0x28c/0x3d8
      init_IRQ+0x90/0x140
      start_kernel+0x57c/0x78c
      start_here_common+0x1c/0x20

  A bisect pointed to the breakage beginning with commit 9fee28baa601 ("powerpc:
  implement the new page table range API").

  Analysis of the oops pointed to a struct page with a corrupted
  compound_head being loaded via page_folio() -> _compound_head() in
  hash_page_do_lazy_icache().

  The access by the mpic code is to an MMIO address, so the expectation
  is that the struct page for that address would be initialised by
  init_unavailable_range(), as pointed out by Aneesh.

  Instrumentation showed that was not the case, which eventually lead to
  the realisation that pfn_valid() was returning false for that address,
  causing the struct page to not be initialised.

  Because the system is using FLATMEM, the version of pfn_valid() in
  memory_model.h is used:

  static inline int pfn_valid(unsigned long pfn)
  {
  	...
  	return pfn >= pfn_offset && (pfn - pfn_offset) < max_mapnr;
  }

  Which relies on max_mapnr being initialised. Early in boot max_mapnr is
  zero meaning no PFNs are valid.

  max_mapnr is initialised in mem_init() called via:

    start_kernel()
      mm_core_init()  # init/main.c:928
        mem_init()

  But that is too late for the usage in init_unavailable_range() called via:

    start_kernel()
      setup_arch()    # init/main.c:893
        paging_init()
          free_area_init()
            init_unavailable_range()

  Although max_mapnr is currently set in mem_init(), the value is actually
  already available much earlier, as soon as mem_topology_setup() has
  completed, which is also before paging_init() is called. So move the
  initialisation there, which causes paging_init() to correctly initialise
  the struct page and fixes the bug.

  This bug seems to have been lurking for years, but went unnoticed
  because the pre-folio code was inspecting the uninitialised page->flags
  but not dereferencing it.

  Thanks to Erhard and Aneesh for help debugging.
- Net: chelsio: cxgb4: add an error code check in t4_load_phy_fw. [Su
  Hui]

  [ Upstream commit 9f771493da935299c6393ad3563b581255d01a37 ]

  t4_set_params_timeout() can return -EINVAL if failed, add check
  for this.
- Platform/mellanox: mlxbf-tmfifo: Fix a warning message. [Liming Sun]

  [ Upstream commit 99c09c985e5973c8f0ad976ebae069548dd86f12 ]

  This commit fixes the smatch static checker warning in function
  mlxbf_tmfifo_rxtx_word() which complains data not initialized at
  line 634 when IS_VRING_DROP() is TRUE.
- Scsi: mpt3sas: Fix in error path. [Tomas Henzl]

  [ Upstream commit e40c04ade0e2f3916b78211d747317843b11ce10 ]

  The driver should be deregistered as misc driver after PCI registration
  failure.
- Fbdev: uvesafb: Call cn_del_callback() at the end of uvesafb_exit()
  [Jorge Maidana]

  [ Upstream commit 1022e7e2f40574c74ed32c3811b03d26b0b81daf ]

  Delete the v86d netlink only after all the VBE tasks have been
  completed.

  Fixes initial state restore on module unload:
  uvesafb: VBE state restore call failed (eax=0x4f04, err=-19)
- ASoC: rt5650: fix the wrong result of key button. [Shuming Fan]

  [ Upstream commit f88dfbf333b3661faff996bb03af2024d907b76a ]

  The RT5650 should enable a power setting for button detection to avoid the wrong result.
- Netfilter: nfnetlink_log: silence bogus compiler warning. [Florian
  Westphal]

  [ Upstream commit 2e1d175410972285333193837a4250a74cd472e6 ]

  net/netfilter/nfnetlink_log.c:800:18: warning: variable 'ctinfo' is uninitialized

  The warning is bogus, the variable is only used if ct is non-NULL and
  always initialised in that case.  Init to 0 too to silence this.
- Spi: npcm-fiu: Fix UMA reads when dummy.nbytes == 0. [William A.
  Kennington III]

  [ Upstream commit 2ec8b010979036c2fe79a64adb6ecc0bd11e91d1 ]

  We don't want to use the value of ilog2(0) as dummy.buswidth is 0 when
  dummy.nbytes is 0. Since we have no dummy bytes, we don't need to
  configure the dummy byte bits per clock register value anyway.
- Fbdev: atyfb: only use ioremap_uc() on i386 and ia64. [Arnd Bergmann]

  [ Upstream commit c1a8d1d0edb71dec15c9649cb56866c71c1ecd9e ]

  ioremap_uc() is only meaningful on old x86-32 systems with the PAT
  extension, and on ia64 with its slightly unconventional ioremap()
  behavior, everywhere else this is the same as ioremap() anyway.

  Change the only driver that still references ioremap_uc() to only do so
  on x86-32/ia64 in order to allow removing that interface at some
  point in the future for the other architectures.

  On some architectures, ioremap_uc() just returns NULL, changing
  the driver to call ioremap() means that they now have a chance
  of working correctly.
- Input: synaptics-rmi4 - handle reset delay when using SMBus trsnsport.
  [Dmitry Torokhov]

  [ Upstream commit 5030b2fe6aab37fe42d14f31842ea38be7c55c57 ]

  Touch controllers need some time after receiving reset command for the
  firmware to finish re-initializing and be ready to respond to commands
  from the host. The driver already had handling for the post-reset delay
  for I2C and SPI transports, this change adds the handling to
  SMBus-connected devices.

  SMBus devices are peculiar because they implement legacy PS/2
  compatibility mode, so reset is actually issued by psmouse driver on the
  associated serio port, after which the control is passed to the RMI4
  driver with SMBus companion device.

  Note that originally the delay was added to psmouse driver in
  92e24e0e57f7 ("Input: psmouse - add delay when deactivating for SMBus
  mode"), but that resulted in an unwanted delay in "fast" reconnect
  handler for the serio port, so it was decided to revert the patch and
  have the delay being handled in the RMI4 driver, similar to the other
  transports.
- Dmaengine: ste_dma40: Fix PM disable depth imbalance in d40_probe.
  [Zhang Shurong]

  [ Upstream commit 0618c077a8c20e8c81e367988f70f7e32bb5a717 ]

  The pm_runtime_enable will increase power disable depth. Thus
  a pairing decrement is needed on the error handling path to
  keep it balanced according to context.
  We fix it by calling pm_runtime_disable when error returns.
- Irqchip/stm32-exti: add missing DT IRQ flag translation. [Ben
  Wolsieffer]

  [ Upstream commit 8554cba1d6dbd3c74e0549e28ddbaccbb1d6b30a ]

  The STM32F4/7 EXTI driver was missing the xlate callback, so IRQ trigger
  flags specified in the device tree were being ignored. This was
  preventing the RTC alarm interrupt from working, because it must be set
  to trigger on the rising edge to function correctly.
- Net: sched: cls_u32: Fix allocation size in u32_init() [Gustavo A. R.
  Silva]

  [ Upstream commit c4d49196ceec80e30e8d981410d73331b49b7850 ]

  commit d61491a51f7e ("net/sched: cls_u32: Replace one-element array
  with flexible-array member") incorrecly replaced an instance of
  `sizeof(*tp_c)` with `struct_size(tp_c, hlist->ht, 1)`. This results
  in a an over-allocation of 8 bytes.

  This change is wrong because `hlist` in `struct tc_u_common` is a
  pointer:

  net/sched/cls_u32.c:
  struct tc_u_common {
          struct tc_u_hnode __rcu *hlist;
          void                    *ptr;
          int                     refcnt;
          struct idr              handle_idr;
          struct hlist_node       hnode;
          long                    knodes;
  };

  So, the use of `struct_size()` makes no sense: we don't need to allocate
  any extra space for a flexible-array member. `sizeof(*tp_c)` is just fine.

  So, `struct_size(tp_c, hlist->ht, 1)` translates to:

  sizeof(*tp_c) + sizeof(tp_c->hlist->ht) ==
  sizeof(struct tc_u_common) + sizeof(struct tc_u_knode *) ==
  						144 + 8  == 0x98 (byes)
  						     ^^^
  						      |
  						unnecessary extra
  						allocation size

  $ pahole -C tc_u_common net/sched/cls_u32.o
  struct tc_u_common {
  	struct tc_u_hnode *        hlist;                /*     0     8 */
  	void *                     ptr;                  /*     8     8 */
  	int                        refcnt;               /*    16     4 */

  	/* XXX 4 bytes hole, try to pack */

  	struct idr                 handle_idr;           /*    24    96 */
  	/* --- cacheline 1 boundary (64 bytes) was 56 bytes ago --- */
  	struct hlist_node          hnode;                /*   120    16 */
  	/* --- cacheline 2 boundary (128 bytes) was 8 bytes ago --- */
  	long int                   knodes;               /*   136     8 */

  	/* size: 144, cachelines: 3, members: 6 */
  	/* sum members: 140, holes: 1, sum holes: 4 */
  	/* last cacheline: 16 bytes */
  };

  And with `sizeof(*tp_c)`, we have:

  	sizeof(*tp_c) == sizeof(struct tc_u_common) == 144 == 0x90 (bytes)

  which is the correct and original allocation size.

  Fix this issue by replacing `struct_size(tp_c, hlist->ht, 1)` with
  `sizeof(*tp_c)`, and avoid allocating 8 too many bytes.

  The following difference in binary output is expected and reflects the
  desired change:

  | net/sched/cls_u32.o
  | @@ -6148,7 +6148,7 @@
  | include/linux/slab.h:599
  |     2cf5:      mov    0x0(%rip),%rdi        # 2cfc <u32_init+0xfc>
  |                        2cf8: R_X86_64_PC32     kmalloc_caches+0xc
  |-    2cfc:      mov    $0x98,%edx
  |+    2cfc:      mov    $0x90,%edx
- X86: Fix .brk attribute in linker script. [Juergen Gross]

  commit 7e09ac27f43b382f5fe9bb7c7f4c465ece1f8a23 upstream.

  Commit in Fixes added the "NOLOAD" attribute to the .brk section as a
  "failsafe" measure.

  Unfortunately, this leads to the linker no longer covering the .brk
  section in a program header, resulting in the kernel loader not knowing
  that the memory for the .brk section must be reserved.

  This has led to crashes when loading the kernel as PV dom0 under Xen,
  but other scenarios could be hit by the same problem (e.g. in case an
  uncompressed kernel is used and the initrd is placed directly behind
  it).

  So drop the "NOLOAD" attribute. This has been verified to correctly
  cover the .brk section by a program header of the resulting ELF file.
- Rpmsg: Fix possible refcount leak in rpmsg_register_device_override()
  [Hangyu Hua]

  commit d7bd416d35121c95fe47330e09a5c04adbc5f928 upstream.

  rpmsg_register_device_override need to call put_device to free vch when
  driver_set_override fails.

  Fix this by adding a put_device() to the error path.
- Rpmsg: glink: Release driver_override. [Bjorn Andersson]

  commit fb80ef67e8ff6a00d3faad4cb348dafdb8eccfd8 upstream.

  Upon termination of the rpmsg_device, driver_override needs to be freed
  to avoid leaking the potentially assigned string.
- Rpmsg: Fix calling device_lock() on non-initialized device. [Krzysztof
  Kozlowski]

  commit bb17d110cbf270d5247a6e261c5ad50e362d1675 upstream.

  driver_set_override() helper uses device_lock() so it should not be
  called before rpmsg_register_device() (which calls device_register()).
  Effect can be seen with CONFIG_DEBUG_MUTEXES:

    DEBUG_LOCKS_WARN_ON(lock->magic != lock)
    WARNING: CPU: 3 PID: 57 at kernel/locking/mutex.c:582 __mutex_lock+0x1ec/0x430
    ...
    Call trace:
     __mutex_lock+0x1ec/0x430
     mutex_lock_nested+0x44/0x50
     driver_set_override+0x124/0x150
     qcom_glink_native_probe+0x30c/0x3b0
     glink_rpm_probe+0x274/0x350
     platform_probe+0x6c/0xe0
     really_probe+0x17c/0x3d0
     __driver_probe_device+0x114/0x190
     driver_probe_device+0x3c/0xf0
     ...

  Refactor the rpmsg_register_device() function to use two-step device
  registering (initialization + add) and call driver_set_override() in
  proper moment.

  This moves the code around, so while at it also NULL-ify the
  rpdev->driver_override in error path to be sure it won't be kfree()
  second time.
- Rpmsg: Fix kfree() of static memory on setting driver_override.
  [Krzysztof Kozlowski]

  commit 42cd402b8fd4672b692400fe5f9eecd55d2794ac upstream.

  The driver_override field from platform driver should not be initialized
  from static memory (string literal) because the core later kfree() it,
  for example when driver_override is set via sysfs.

  Use dedicated helper to set driver_override properly.
- Rpmsg: Constify local variable in field store macro. [Krzysztof
  Kozlowski]

  commit e5f89131a06142e91073b6959d91cea73861d40e upstream.

  Memory pointed by variable 'old' in field store macro is not modified,
  so it can be made a pointer to const.
- Driver: platform: Add helper for safer setting of driver_override.
  [Krzysztof Kozlowski]

  commit 6c2f421174273de8f83cde4286d1c076d43a2d35 upstream.

  Several core drivers and buses expect that driver_override is a
  dynamically allocated memory thus later they can kfree() it.

  However such assumption is not documented, there were in the past and
  there are already users setting it to a string literal. This leads to
  kfree() of static memory during device release (e.g. in error paths or
  during unbind):

      kernel BUG at ../mm/slub.c:3960!
      Internal error: Oops - BUG: 0 [#1] PREEMPT SMP ARM
      ...
      (kfree) from [<c058da50>] (platform_device_release+0x88/0xb4)
      (platform_device_release) from [<c0585be0>] (device_release+0x2c/0x90)
      (device_release) from [<c0a69050>] (kobject_put+0xec/0x20c)
      (kobject_put) from [<c0f2f120>] (exynos5_clk_probe+0x154/0x18c)
      (exynos5_clk_probe) from [<c058de70>] (platform_drv_probe+0x6c/0xa4)
      (platform_drv_probe) from [<c058b7ac>] (really_probe+0x280/0x414)
      (really_probe) from [<c058baf4>] (driver_probe_device+0x78/0x1c4)
      (driver_probe_device) from [<c0589854>] (bus_for_each_drv+0x74/0xb8)
      (bus_for_each_drv) from [<c058b48c>] (__device_attach+0xd4/0x16c)
      (__device_attach) from [<c058a638>] (bus_probe_device+0x88/0x90)
      (bus_probe_device) from [<c05871fc>] (device_add+0x3dc/0x62c)
      (device_add) from [<c075ff10>] (of_platform_device_create_pdata+0x94/0xbc)
      (of_platform_device_create_pdata) from [<c07600ec>] (of_platform_bus_create+0x1a8/0x4fc)
      (of_platform_bus_create) from [<c0760150>] (of_platform_bus_create+0x20c/0x4fc)
      (of_platform_bus_create) from [<c07605f0>] (of_platform_populate+0x84/0x118)
      (of_platform_populate) from [<c0f3c964>] (of_platform_default_populate_init+0xa0/0xb8)
      (of_platform_default_populate_init) from [<c01031f8>] (do_one_initcall+0x8c/0x404)

  Provide a helper which clearly documents the usage of driver_override.
  This will allow later to reuse the helper and reduce the amount of
  duplicated code.

  Convert the platform driver to use a new helper and make the
  driver_override field const char (it is not modified by the core).
- Objtool/x86: add missing embedded_insn check. [John Sperbeck]

  When dbf460087755 ("objtool/x86: Fixup frame-pointer vs rethunk")
  was backported to some stable branches, the check for dest->embedded_insn
  in is_special_call() was missed.  The result is that the warning it
  was intended to suppress still appears.  For example on 6.1 (on kernels
  before 6.1, the '-s' argument would instead be 'check'):

  $ tools/objtool/objtool -s arch/x86/lib/retpoline.o
  arch/x86/lib/retpoline.o: warning: objtool: srso_untrain_ret+0xd:
      call without frame pointer save/setup

  With this patch, the warning is correctly suppressed, and the
  kernel still passes the normal Google kernel developer tests.
- Ext4: avoid overlapping preallocations due to overflow. [Baokun Li]

  commit bedc5d34632c21b5adb8ca7143d4c1f794507e4c upstream.

  Let's say we want to allocate 2 blocks starting from 4294966386, after
  predicting the file size, start is aligned to 4294965248, len is changed
  to 2048, then end = start + size = 0x100000000. Since end is of
  type ext4_lblk_t, i.e. uint, end is truncated to 0.

  This causes (pa->pa_lstart >= end) to always hold when checking if the
  current extent to be allocated crosses already preallocated blocks, so the
  resulting ac_g_ex may cross already preallocated blocks. Hence we convert
  the end type to loff_t and use pa_logical_end() to avoid overflow.
- Ext4: fix BUG in ext4_mb_new_inode_pa() due to overflow. [Baokun Li]

  commit bc056e7163ac7db945366de219745cf94f32a3e6 upstream.

  When we calculate the end position of ext4_free_extent, this position may
  be exactly where ext4_lblk_t (i.e. uint) overflows. For example, if
  ac_g_ex.fe_logical is 4294965248 and ac_orig_goal_len is 2048, then the
  computed end is 0x100000000, which is 0. If ac->ac_o_ex.fe_logical is not
  the first case of adjusting the best extent, that is, new_bex_end > 0, the
  following BUG_ON will be triggered:

  =========================================================
  kernel BUG at fs/ext4/mballoc.c:5116!
  invalid opcode: 0000 [#1] PREEMPT SMP PTI
  CPU: 3 PID: 673 Comm: xfs_io Tainted: G E 6.5.0-rc1+ #279
  RIP: 0010:ext4_mb_new_inode_pa+0xc5/0x430
  Call Trace:
   <TASK>
   ext4_mb_use_best_found+0x203/0x2f0
   ext4_mb_try_best_found+0x163/0x240
   ext4_mb_regular_allocator+0x158/0x1550
   ext4_mb_new_blocks+0x86a/0xe10
   ext4_ext_map_blocks+0xb0c/0x13a0
   ext4_map_blocks+0x2cd/0x8f0
   ext4_iomap_begin+0x27b/0x400
   iomap_iter+0x222/0x3d0
   __iomap_dio_rw+0x243/0xcb0
   iomap_dio_rw+0x16/0x80
  =========================================================

  A simple reproducer demonstrating the problem:

  	mkfs.ext4 -F /dev/sda -b 4096 100M
  	mount /dev/sda /tmp/test
  	fallocate -l1M /tmp/test/tmp
  	fallocate -l10M /tmp/test/file
  	fallocate -i -o 1M -l16777203M /tmp/test/file
  	fsstress -d /tmp/test -l 0 -n 100000 -p 8 &
  	sleep 10 && killall -9 fsstress
  	rm -f /tmp/test/tmp
  	xfs_io -c "open -ad /tmp/test/file" -c "pwrite -S 0xff 0 8192"

  We simply refactor the logic for adjusting the best extent by adding
  a temporary ext4_free_extent ex and use extent_logical_end() to avoid
  overflow, which also simplifies the code.
- Ext4: add two helper functions extent_logical_end() and
  pa_logical_end() [Baokun Li]

  commit 43bbddc067883d94de7a43d5756a295439fbe37d upstream.

  When we use lstart + len to calculate the end of free extent or prealloc
  space, it may exceed the maximum value of 4294967295(0xffffffff) supported
  by ext4_lblk_t and cause overflow, which may lead to various problems.

  Therefore, we add two helper functions, extent_logical_end() and
  pa_logical_end(), to limit the type of end to loff_t, and also convert
  lstart to loff_t for calculation to avoid overflow.
- X86/mm: Fix RESERVE_BRK() for older binutils. [Josh Poimboeuf]

  commit e32683c6f7d22ba624e0bfc58b02cf3348bdca63 upstream.

  With binutils 2.26, RESERVE_BRK() causes a build failure:

    /tmp/ccnGOKZ5.s: Assembler messages:
    /tmp/ccnGOKZ5.s:98: Error: missing ')'
    /tmp/ccnGOKZ5.s:98: Error: missing ')'
    /tmp/ccnGOKZ5.s:98: Error: missing ')'
    /tmp/ccnGOKZ5.s:98: Error: junk at end of line, first unrecognized
    character is `U'

  The problem is this line:

    RESERVE_BRK(early_pgt_alloc, INIT_PGT_BUF_SIZE)

  Specifically, the INIT_PGT_BUF_SIZE macro which (via PAGE_SIZE's use
  _AC()) has a "1UL", which makes older versions of the assembler unhappy.
  Unfortunately the _AC() macro doesn't work for inline asm.

  Inline asm was only needed here to convince the toolchain to add the
  STT_NOBITS flag.  However, if a C variable is placed in a section whose
  name is prefixed with ".bss", GCC and Clang automatically set
  STT_NOBITS.  In fact, ".bss..page_aligned" already relies on this trick.

  So fix the build failure (and simplify the macro) by allocating the
  variable in C.

  Also, add NOLOAD to the ".brk" output section clause in the linker
  script.  This is a failsafe in case the ".bss" prefix magic trick ever
  stops working somehow.  If there's a section type mismatch, the GNU
  linker will force the ".brk" output section to be STT_NOBITS.  The LLVM
  linker will fail with a "section type mismatch" error.

  Note this also changes the name of the variable from .brk.##name to
  __brk_##name.  The variable names aren't actually used anywhere, so it's
  harmless.

  Fixes: a1e2c031ec39 ("x86/mm: Simplify RESERVE_BRK()")
  Reported-by: Joe Damato <jdamato@fastly.com>
  Reported-by: Byungchul Park <byungchul.park@lge.com>
  Signed-off-by: Josh Poimboeuf <jpoimboe@kernel.org>
  Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
  Tested-by: Joe Damato <jdamato@fastly.com>
  Link: https://lore.kernel.org/r/22d07a44c80d8e8e1e82b9a806ddc8c6bbb2606e.1654759036.git.jpoimboe@kernel.org
  [nathan: Fix trivial conflict due to lack of 81519f778830]
- X86/mm: Simplify RESERVE_BRK() [Josh Poimboeuf]

  commit a1e2c031ec3949b8c039b739c0b5bf9c30007b00 upstream.

  RESERVE_BRK() reserves data in the .brk_reservation section.  The data
  is initialized to zero, like BSS, so the macro specifies 'nobits' to
  prevent the data from taking up space in the vmlinux binary.  The only
  way to get the compiler to do that (without putting the variable in .bss
  proper) is to use inline asm.

  The macro also has a hack which encloses the inline asm in a discarded
  function, which allows the size to be passed (global inline asm doesn't
  allow inputs).

  Remove the need for the discarded function hack by just stringifying the
  size rather than supplying it as an input to the inline asm.

  Signed-off-by: Josh Poimboeuf <jpoimboe@redhat.com>
  Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
  Signed-off-by: Borislav Petkov <bp@suse.de>
  Reviewed-by: Borislav Petkov <bp@suse.de>
  Link: https://lore.kernel.org/r/20220506121631.133110232@infradead.org
  [nathan: Resolve conflict due to lack of 2b6ff7dea670]
- F2fs: fix to do sanity check on inode type during garbage collection.
  [Chao Yu]

  commit 9056d6489f5a41cfbb67f719d2c0ce61ead72d9f upstream.

  As report by Wenqing Liu in bugzilla:

  https://bugzilla.kernel.org/show_bug.cgi?id=215231

  - Overview
  kernel NULL pointer dereference triggered  in folio_mark_dirty() when mount and operate on a crafted f2fs image

  - Reproduce
  tested on kernel 5.16-rc3, 5.15.X under root

  1. mkdir mnt
  2. mount -t f2fs tmp1.img mnt
  3. touch tmp
  4. cp tmp mnt

  F2FS-fs (loop0): sanity_check_inode: inode (ino=49) extent info [5942, 4294180864, 4] is incorrect, run fsck to fix
  F2FS-fs (loop0): f2fs_check_nid_range: out-of-range nid=31340049, run fsck to fix.
  BUG: kernel NULL pointer dereference, address: 0000000000000000
   folio_mark_dirty+0x33/0x50
   move_data_page+0x2dd/0x460 [f2fs]
   do_garbage_collect+0xc18/0x16a0 [f2fs]
   f2fs_gc+0x1d3/0xd90 [f2fs]
   f2fs_balance_fs+0x13a/0x570 [f2fs]
   f2fs_create+0x285/0x840 [f2fs]
   path_openat+0xe6d/0x1040
   do_filp_open+0xc5/0x140
   do_sys_openat2+0x23a/0x310
   do_sys_open+0x57/0x80

  The root cause is for special file: e.g. character, block, fifo or socket file,
  f2fs doesn't assign address space operations pointer array for mapping->a_ops field,
  so, in a fuzzed image, SSA table indicates a data block belong to special file, when
  f2fs tries to migrate that block, it causes NULL pointer access once move_data_page()
  calls a_ops->set_dirty_page().
- Smbdirect: missing rc checks while waiting for rdma events. [Steve
  French]

  commit 0555b221528e9cb11f5766dcdee19c809187e42e upstream.

  There were two places where we weren't checking for error
  (e.g. ERESTARTSYS) while waiting for rdma resolution.
- Kobject: Fix slab-out-of-bounds in fill_kobj_path() [Wang Hai]

  commit 3bb2a01caa813d3a1845d378bbe4169ef280d394 upstream.

  In kobject_get_path(), if kobj->name is changed between calls
  get_kobj_path_length() and fill_kobj_path() and the length becomes
  longer, then fill_kobj_path() will have an out-of-bounds bug.

  The actual current problem occurs when the ixgbe probe.

  In ixgbe_mii_bus_init(), if the length of netdev->dev.kobj.name
  length becomes longer, out-of-bounds will occur.

  cpu0                                         cpu1
  ixgbe_probe
   register_netdev(netdev)
    netdev_register_kobject
     device_add
      kobject_uevent // Sending ADD events
                                               systemd-udevd // rename netdev
                                                dev_change_name
                                                 device_rename
                                                  kobject_rename
   ixgbe_mii_bus_init                             |
    mdiobus_register                              |
     __mdiobus_register                           |
      device_register                             |
       device_add                                 |
        kobject_uevent                            |
         kobject_get_path                         |
          len = get_kobj_path_length // old name  |
          path = kzalloc(len, gfp_mask);          |
                                                  kobj->name = name;
                                                  /* name length becomes
                                                   * longer
                                                   */
          fill_kobj_path /* kobj path length is
                          * longer than path,
                          * resulting in out of
                          * bounds when filling path
                          */

  This is the kasan report:

  ==================================================================
  BUG: KASAN: slab-out-of-bounds in fill_kobj_path+0x50/0xc0
  Write of size 7 at addr ff1100090573d1fd by task kworker/28:1/673

   Workqueue: events work_for_cpu_fn
   Call Trace:
   <TASK>
   dump_stack_lvl+0x34/0x48
   print_address_description.constprop.0+0x86/0x1e7
   print_report+0x36/0x4f
   kasan_report+0xad/0x130
   kasan_check_range+0x35/0x1c0
   memcpy+0x39/0x60
   fill_kobj_path+0x50/0xc0
   kobject_get_path+0x5a/0xc0
   kobject_uevent_env+0x140/0x460
   device_add+0x5c7/0x910
   __mdiobus_register+0x14e/0x490
   ixgbe_probe.cold+0x441/0x574 [ixgbe]
   local_pci_probe+0x78/0xc0
   work_for_cpu_fn+0x26/0x40
   process_one_work+0x3b6/0x6a0
   worker_thread+0x368/0x520
   kthread+0x165/0x1a0
   ret_from_fork+0x1f/0x30

  This reproducer triggers that bug:

  while:
  do
      rmmod ixgbe
      sleep 0.5
      modprobe ixgbe
      sleep 0.5

  When calling fill_kobj_path() to fill path, if the name length of
  kobj becomes longer, return failure and retry. This fixes the problem.
- X86/i8259: Skip probing when ACPI/MADT advertises PCAT compatibility.
  [Thomas Gleixner]

  commit 128b0c9781c9f2651bea163cb85e52a6c7be0f9e upstream.

  David and a few others reported that on certain newer systems some legacy
  interrupts fail to work correctly.

  Debugging revealed that the BIOS of these systems leaves the legacy PIC in
  uninitialized state which makes the PIC detection fail and the kernel
  switches to a dummy implementation.

  Unfortunately this fallback causes quite some code to fail as it depends on
  checks for the number of legacy PIC interrupts or the availability of the
  real PIC.

  In theory there is no reason to use the PIC on any modern system when
  IO/APIC is available, but the dependencies on the related checks cannot be
  resolved trivially and on short notice. This needs lots of analysis and
  rework.

  The PIC detection has been added to avoid quirky checks and force selection
  of the dummy implementation all over the place, especially in VM guest
  scenarios. So it's not an option to revert the relevant commit as that
  would break a lot of other scenarios.

  One solution would be to try to initialize the PIC on detection fail and
  retry the detection, but that puts the burden on everything which does not
  have a PIC.

  Fortunately the ACPI/MADT table header has a flag field, which advertises
  in bit 0 that the system is PCAT compatible, which means it has a legacy
  8259 PIC.

  Evaluate that bit and if set avoid the detection routine and keep the real
  PIC installed, which then gets initialized (for nothing) and makes the rest
  of the code with all the dependencies work again.
- Iio: adc: xilinx-xadc: Don't clobber preset voltage/temperature
  thresholds. [Robert Hancock]

  [ Upstream commit 8d6b3ea4d9eaca80982442b68a292ce50ce0a135 ]

  In the probe function, the driver was reading out the thresholds already
  set in the core, which can be configured by the user in the Vivado tools
  when the FPGA image is built. However, it later clobbered those values
  with zero or maximum values. In particular, the overtemperature shutdown
  threshold register was overwritten with the max value, which effectively
  prevents the FPGA from shutting down when the desired threshold was
  eached, potentially risking hardware damage in that case.

  Remove this code to leave the preconfigured default threshold values
  intact.

  The code was also disabling all alarms regardless of what enable state
  they were left in by the FPGA image, including the overtemperature
  shutdown feature. Leave these bits in their original state so they are
  not unconditionally disabled.
- Iio: adc: xilinx: use more devres helpers and remove remove() [Bartosz
  Golaszewski]

  [ Upstream commit 2a9685d1a3b7644ca08d8355fc238b43faef7c3e ]

  In order to simplify resource management and error paths in probe() and
  entirely drop the remove() callback - use devres helpers wherever
  possible. Define devm actions for cancelling the delayed work and
  disabling the clock.
- Iio: adc: xilinx: use devm_krealloc() instead of kfree() + kcalloc()
  [Bartosz Golaszewski]

  [ Upstream commit eab64715709ed440d54cac42f239e2d49df26c1f ]

  We now have devm_krealloc() in the kernel Use it indstead of calling
  kfree() and kcalloc() separately.
- Iio: adc: xilinx: use helper variable for &pdev->dev. [Bartosz
  Golaszewski]

  [ Upstream commit 9d8fd2a06a2bcce8eada1bad26cbe0fbfc27cdf4 ]

  It's more elegant to use a helper local variable to store the address
  of the underlying struct device than to dereference pdev everywhere.
- Clk: Sanitize possible_parent_show to Handle Return Value of
  of_clk_get_parent_name. [Alessandro Carminati]

  commit ceb87a361d0b079ecbc7d2831618c19087f304a9 upstream.

  In the possible_parent_show function, ensure proper handling of the return
  value from of_clk_get_parent_name to prevent potential issues arising from
  a NULL return.
  The current implementation invokes seq_puts directly on the result of
  of_clk_get_parent_name without verifying the return value, which can lead
  to kernel panic if the function returns NULL.

  This patch addresses the concern by introducing a check on the return
  value of of_clk_get_parent_name. If the return value is not NULL, the
  function proceeds to call seq_puts, providing the returned value as
  argument.
  However, if of_clk_get_parent_name returns NULL, the function provides a
  static string as argument, avoiding the panic.
- Sparc32: fix a braino in fault handling in csum_and_copy_..._user()
  [Al Viro]

  commit 1f36cd05e0081f2c75769a551d584c4ffb2a5660 upstream.

  Fault handler used to make non-trivial calls, so it needed
  to set a stack frame up.  Used to be
  	save ... - grab a stack frame, old %o... become %i...
  	....
  	ret	- go back to address originally in %o7, currently %i7
  	 restore - switch to previous stack frame, in delay slot
  Non-trivial calls had been gone since ab5e8b331244 and that code should
  have become
  	retl	- go back to address in %o7
  	 clr %o0 - have return value set to 0
  What it had become instead was
  	ret	- go back to address in %i7 - return address of *caller*
  	 clr %o0 - have return value set to 0
  which is not good, to put it mildly - we forcibly return 0 from
  csum_and_copy_{from,to}_iter() (which is what the call of that
  thing had been inlined into) and do that without dropping the
  stack frame of said csum_and_copy_..._iter().  Confuses the
  hell out of the caller of csum_and_copy_..._iter(), obviously...
- Perf/core: Fix potential NULL deref. [Peter Zijlstra]

  commit a71ef31485bb51b846e8db8b3a35e432cc15afb5 upstream.

  Smatch is awesome.
- Nvmem: imx: correct nregs for i.MX6UL. [Peng Fan]

  commit 7d6e10f5d254681983b53d979422c8de3fadbefb upstream.

  The nregs for i.MX6UL should be 144 per fuse map, correct it.
- Nvmem: imx: correct nregs for i.MX6SLL. [Peng Fan]

  commit 414a98abbefd82d591f4e2d1efd2917bcd3b6f6d upstream.

  The nregs for i.MX6SLL should be 80 per fuse map, correct it.
- Nvmem: imx: correct nregs for i.MX6ULL. [Peng Fan]

  commit 2382c1b044231fd49eaf9aa82bc7113fc55487b8 upstream.

  The nregs for i.MX6ULL should be 80 per fuse map, correct it.
- Misc: fastrpc: Clean buffers on remote invocation failures. [Ekansh
  Gupta]

  commit 1c8093591d1e372d700fe65423e7315a8ecf721b upstream.

  With current design, buffers and dma handles are not freed in case
  of remote invocation failures returned from DSP. This could result
  in buffer leakings and dma handle pointing to wrong memory in the
  fastrpc kernel. Adding changes to clean buffers and dma handles
  even when remote invocation to DSP returns failures.
- Tracing/kprobes: Fix the description of variable length arguments.
  [Yujie Liu]

  commit e0f831836cead677fb07d54bd6bf499df35640c2 upstream.

  Fix the following kernel-doc warnings:

  kernel/trace/trace_kprobe.c:1029: warning: Excess function parameter 'args' description in '__kprobe_event_gen_cmd_start'
  kernel/trace/trace_kprobe.c:1097: warning: Excess function parameter 'args' description in '__kprobe_event_add_fields'

  Refer to the usage of variable length arguments elsewhere in the kernel
  code, "@..." is the proper way to express it in the description.
- I2c: aspeed: Fix i2c bus hang in slave read. [Jian Zhang]

  commit 54f1840ddee9bbdc8dd89fbbfdfa632401244146 upstream.

  When the `CONFIG_I2C_SLAVE` option is enabled and the device operates
  as a slave, a situation arises where the master sends a START signal
  without the accompanying STOP signal. This action results in a
  persistent I2C bus timeout. The core issue stems from the fact that
  the i2c controller remains in a slave read state without a timeout
  mechanism. As a consequence, the bus perpetually experiences timeouts.

  In this case, the i2c bus will be reset, but the slave_state reset is
  missing.
- I2c: stm32f7: Fix PEC handling in case of SMBUS transfers. [Alain
  Volmat]

  commit c896ff2dd8f30a6b0a922c83a96f6d43f05f0e92 upstream.

  In case of SMBUS byte read with PEC enabled, the whole transfer
  is split into two commands.  A first write command, followed by
  a read command.  The write command does not have any PEC byte
  and a PEC byte is appended at the end of the read command.
  (cf Read byte protocol with PEC in SMBUS specification)

  Within the STM32 I2C controller, handling (either sending
  or receiving) of the PEC byte is done via the PECBYTE bit in
  register CR2.

  Currently, the PECBYTE is set at the beginning of a transfer,
  which lead to sending a PEC byte at the end of the write command
  (hence losing the real last byte), and also does not check the
  PEC byte received during the read command.

  This patch corrects the function stm32f7_i2c_smbus_xfer_msg
  in order to only set the PECBYTE during the read command.
- I2c: muxes: i2c-demux-pinctrl: Use of_get_i2c_adapter_by_node() [Herve
  Codina]

  commit 0fb118de5003028ad092a4e66fc6d07b86c3bc94 upstream.

  i2c-demux-pinctrl uses the pair of_find_i2c_adapter_by_node() /
  i2c_put_adapter(). These pair alone is not correct to properly lock the
  I2C parent adapter.

  Indeed, i2c_put_adapter() decrements the module refcount while
  of_find_i2c_adapter_by_node() does not increment it. This leads to an
  underflow of the parent module refcount.

  Use the	dedicated function, of_get_i2c_adapter_by_node(), to handle
  correctly the module refcount.
- I2c: muxes: i2c-mux-gpmux: Use of_get_i2c_adapter_by_node() [Herve
  Codina]

  commit 3dc0ec46f6e7511fc4fdf6b6cda439382bc957f1 upstream.

  i2c-mux-gpmux uses the pair of_find_i2c_adapter_by_node() /
  i2c_put_adapter(). These pair alone is not correct to properly lock the
  I2C parent adapter.

  Indeed, i2c_put_adapter() decrements the module refcount while
  of_find_i2c_adapter_by_node() does not increment it. This leads to an
  underflow of the parent module refcount.

  Use the dedicated function, of_get_i2c_adapter_by_node(), to handle
  correctly the module refcount.
- I2c: muxes: i2c-mux-pinctrl: Use of_get_i2c_adapter_by_node() [Herve
  Codina]

  commit 3171d37b58a76e1febbf3f4af2d06234a98cf88b upstream.

  i2c-mux-pinctrl uses the pair of_find_i2c_adapter_by_node() /
  i2c_put_adapter(). These pair alone is not correct to properly lock the
  I2C parent adapter.

  Indeed, i2c_put_adapter() decrements the module refcount while
  of_find_i2c_adapter_by_node() does not increment it. This leads to an
  underflow of the parent module refcount.

  Use the dedicated function, of_get_i2c_adapter_by_node(), to handle
  correctly the module refcount.
- Iio: exynos-adc: request second interupt only when touchscreen mode is
  used. [Marek Szyprowski]

  commit 865b080e3229102f160889328ce2e8e97aa65ea0 upstream.

  Second interrupt is needed only when touchscreen mode is used, so don't
  request it unconditionally. This removes the following annoying warning
  during boot:

  exynos-adc 14d10000.adc: error -ENXIO: IRQ index 1 not found
- Kasan: print the original fault addr when access invalid shadow.
  [Haibo Li]

  commit babddbfb7d7d70ae7f10fedd75a45d8ad75fdddf upstream.

  when the checked address is illegal,the corresponding shadow address from
  kasan_mem_to_shadow may have no mapping in mmu table.  Access such shadow
  address causes kernel oops.  Here is a sample about oops on arm64(VA
  39bit) with KASAN_SW_TAGS and KASAN_OUTLINE on:

  [ffffffb80aaaaaaa] pgd=000000005d3ce003, p4d=000000005d3ce003,
      pud=000000005d3ce003, pmd=0000000000000000
  Internal error: Oops: 0000000096000006 [#1] PREEMPT SMP
  Modules linked in:
  CPU: 3 PID: 100 Comm: sh Not tainted 6.6.0-rc1-dirty #43
  Hardware name: linux,dummy-virt (DT)
  pstate: 80000005 (Nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  pc : __hwasan_load8_noabort+0x5c/0x90
  lr : do_ib_ob+0xf4/0x110
  ffffffb80aaaaaaa is the shadow address for efffff80aaaaaaaa.
  The problem is reading invalid shadow in kasan_check_range.

  The generic kasan also has similar oops.

  It only reports the shadow address which causes oops but not
  the original address.

  Commit 2f004eea0fc8("x86/kasan: Print original address on #GP")
  introduce to kasan_non_canonical_hook but limit it to KASAN_INLINE.

  This patch extends it to KASAN_OUTLINE mode.
- I40e: Fix wrong check for I40E_TXR_FLAGS_WB_ON_ITR. [Ivan Vecera]

  [ Upstream commit 77a8c982ff0d4c3a14022c6fe9e3dbfb327552ec ]

  The I40E_TXR_FLAGS_WB_ON_ITR is i40e_ring flag and not i40e_pf one.
- Gtp: fix fragmentation needed check with gso. [Pablo Neira Ayuso]

  [ Upstream commit 4530e5b8e2dad63dcad2206232dd86e4b1489b6c ]

  Call skb_gso_validate_network_len() to check if packet is over PMTU.
- Gtp: uapi: fix GTPA_MAX. [Pablo Neira Ayuso]

  [ Upstream commit adc8df12d91a2b8350b0cd4c7fec3e8546c9d1f8 ]

  Subtract one to __GTPA_MAX, otherwise GTPA_MAX is off by 2.
- Tcp: fix wrong RTO timeout when received SACK reneging. [Fred Chen]

  [ Upstream commit d2a0fc372aca561556e765d0a9ec365c7c12f0ad ]

  This commit fix wrong RTO timeout when received SACK reneging.

  When an ACK arrived pointing to a SACK reneging, tcp_check_sack_reneging()
  will rearm the RTO timer for min(1/2*srtt, 10ms) into to the future.

  But since the commit 62d9f1a6945b ("tcp: fix TLP timer not set when
  CA_STATE changes from DISORDER to OPEN") merged, the tcp_set_xmit_timer()
  is moved after tcp_fastretrans_alert()(which do the SACK reneging check),
  so the RTO timeout will be overwrited by tcp_set_xmit_timer() with
  icsk_rto instead of 1/2*srtt.

  Here is a packetdrill script to check this bug:
  0     socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
  +0    bind(3, ..., ...) = 0
  +0    listen(3, 1) = 0

  // simulate srtt to 100ms
  +0    < S 0:0(0) win 32792 <mss 1000, sackOK,nop,nop,nop,wscale 7>
  +0    > S. 0:0(0) ack 1 <mss 1460,nop,nop,sackOK,nop,wscale 7>
  +.1    < . 1:1(0) ack 1 win 1024

  +0    accept(3, ..., ...) = 4

  +0    write(4, ..., 10000) = 10000
  +0    > P. 1:10001(10000) ack 1

  // inject sack
  +.1    < . 1:1(0) ack 1 win 257 <sack 1001:10001,nop,nop>
  +0    > . 1:1001(1000) ack 1

  // inject sack reneging
  +.1    < . 1:1(0) ack 1001 win 257 <sack 9001:10001,nop,nop>

  // we expect rto fired in 1/2*srtt (50ms)
  +.05    > . 1001:2001(1000) ack 1

  This fix remove the FLAG_SET_XMIT_TIMER from ack_flag when
  tcp_check_sack_reneging() set RTO timer with 1/2*srtt to avoid
  being overwrited later.
- R8152: Release firmware if we have an error in probe. [Douglas
  Anderson]

  [ Upstream commit b8d35024d4059ca550cba11ac9ab23a6c238d929 ]

  The error handling in rtl8152_probe() is missing a call to release
  firmware. Add it in to match what's in the cleanup code in
  rtl8152_disconnect().
- R8152: Cancel hw_phy_work if we have an error in probe. [Douglas
  Anderson]

  [ Upstream commit bb8adff9123e492598162ac1baad01a53891aef6 ]

  The error handling in rtl8152_probe() is missing a call to cancel the
  hw_phy_work. Add it in to match what's in the cleanup code in
  rtl8152_disconnect().
- R8152: Run the unload routine if we have errors during probe. [Douglas
  Anderson]

  [ Upstream commit 5dd17689526971c5ae12bc8398f34bd68cd0499e ]

  The rtl8152_probe() function lacks a call to the chip-specific
  unload() routine when it sees an error in probe. Add it in to match
  the cleanup code in rtl8152_disconnect().
- R8152: Increase USB control msg timeout to 5000ms as per spec.
  [Douglas Anderson]

  [ Upstream commit a5feba71ec9c14a54c3babdc732c5b6866d8ee43 ]

  According to the comment next to USB_CTRL_GET_TIMEOUT and
  USB_CTRL_SET_TIMEOUT, although sending/receiving control messages is
  usually quite fast, the spec allows them to take up to 5 seconds.
  Let's increase the timeout in the Realtek driver from 500ms to 5000ms
  (using the #defines) to account for this.

  This is not just a theoretical change. The need for the longer timeout
  was seen in testing. Specifically, if you drop a sc7180-trogdor based
  Chromebook into the kdb debugger and then "go" again after sitting in
  the debugger for a while, the next USB control message takes a long
  time. Out of ~40 tests the slowest USB control message was 4.5
  seconds.

  While dropping into kdb is not exactly an end-user scenario, the above
  is similar to what could happen due to an temporary interrupt storm,
  what could happen if there was a host controller (HW or SW) issue, or
  what could happen if the Realtek device got into a confused state and
  needed time to recover.

  This change is fairly critical since the r8152 driver in Linux doesn't
  expect register reads/writes (which are backed by USB control
  messages) to fail.
- Net: usb: smsc95xx: Fix uninit-value access in smsc95xx_read_reg.
  [Shigeru Yoshida]

  [ Upstream commit 51a32e828109b4a209efde44505baa356b37a4ce ]

  syzbot reported the following uninit-value access issue [1]:

  smsc95xx 1-1:0.0 (unnamed net_device) (uninitialized): Failed to read reg index 0x00000030: -32
  smsc95xx 1-1:0.0 (unnamed net_device) (uninitialized): Error reading E2P_CMD
  =====================================================
  BUG: KMSAN: uninit-value in smsc95xx_reset+0x409/0x25f0 drivers/net/usb/smsc95xx.c:896
   smsc95xx_reset+0x409/0x25f0 drivers/net/usb/smsc95xx.c:896
   smsc95xx_bind+0x9bc/0x22e0 drivers/net/usb/smsc95xx.c:1131
   usbnet_probe+0x100b/0x4060 drivers/net/usb/usbnet.c:1750
   usb_probe_interface+0xc75/0x1210 drivers/usb/core/driver.c:396
   really_probe+0x506/0xf40 drivers/base/dd.c:658
   __driver_probe_device+0x2a7/0x5d0 drivers/base/dd.c:800
   driver_probe_device+0x72/0x7b0 drivers/base/dd.c:830
   __device_attach_driver+0x55a/0x8f0 drivers/base/dd.c:958
   bus_for_each_drv+0x3ff/0x620 drivers/base/bus.c:457
   __device_attach+0x3bd/0x640 drivers/base/dd.c:1030
   device_initial_probe+0x32/0x40 drivers/base/dd.c:1079
   bus_probe_device+0x3d8/0x5a0 drivers/base/bus.c:532
   device_add+0x16ae/0x1f20 drivers/base/core.c:3622
   usb_set_configuration+0x31c9/0x38c0 drivers/usb/core/message.c:2207
   usb_generic_driver_probe+0x109/0x2a0 drivers/usb/core/generic.c:238
   usb_probe_device+0x290/0x4a0 drivers/usb/core/driver.c:293
   really_probe+0x506/0xf40 drivers/base/dd.c:658
   __driver_probe_device+0x2a7/0x5d0 drivers/base/dd.c:800
   driver_probe_device+0x72/0x7b0 drivers/base/dd.c:830
   __device_attach_driver+0x55a/0x8f0 drivers/base/dd.c:958
   bus_for_each_drv+0x3ff/0x620 drivers/base/bus.c:457
   __device_attach+0x3bd/0x640 drivers/base/dd.c:1030
   device_initial_probe+0x32/0x40 drivers/base/dd.c:1079
   bus_probe_device+0x3d8/0x5a0 drivers/base/bus.c:532
   device_add+0x16ae/0x1f20 drivers/base/core.c:3622
   usb_new_device+0x15f6/0x22f0 drivers/usb/core/hub.c:2589
   hub_port_connect drivers/usb/core/hub.c:5440 [inline]
   hub_port_connect_change drivers/usb/core/hub.c:5580 [inline]
   port_event drivers/usb/core/hub.c:5740 [inline]
   hub_event+0x53bc/0x7290 drivers/usb/core/hub.c:5822
   process_one_work kernel/workqueue.c:2630 [inline]
   process_scheduled_works+0x104e/0x1e70 kernel/workqueue.c:2703
   worker_thread+0xf45/0x1490 kernel/workqueue.c:2784
   kthread+0x3e8/0x540 kernel/kthread.c:388
   ret_from_fork+0x66/0x80 arch/x86/kernel/process.c:147
   ret_from_fork_asm+0x11/0x20 arch/x86/entry/entry_64.S:304

  Local variable buf.i225 created at:
   smsc95xx_read_reg drivers/net/usb/smsc95xx.c:90 [inline]
   smsc95xx_reset+0x203/0x25f0 drivers/net/usb/smsc95xx.c:892
   smsc95xx_bind+0x9bc/0x22e0 drivers/net/usb/smsc95xx.c:1131

  CPU: 1 PID: 773 Comm: kworker/1:2 Not tainted 6.6.0-rc1-syzkaller-00125-ge42bebf6db29 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/04/2023
  Workqueue: usb_hub_wq hub_event
  =====================================================

  Similar to e9c65989920f ("net: usb: smsc75xx: Fix uninit-value access in
  __smsc75xx_read_reg"), this issue is caused because usbnet_read_cmd() reads
  less bytes than requested (zero byte in the reproducer). In this case,
  'buf' is not properly filled.

  This patch fixes the issue by returning -ENODATA if usbnet_read_cmd() reads
  less bytes than requested.

  sysbot reported similar uninit-value access issue [2]. The root cause is
  the same as mentioned above, and this patch addresses it as well.
- Net: ieee802154: adf7242: Fix some potential buffer overflow in
  adf7242_stats_show() [Christophe JAILLET]

  [ Upstream commit ca082f019d8fbb983f03080487946da714154bae ]

  strncat() usage in adf7242_debugfs_init() is wrong.
  The size given to strncat() is the maximum number of bytes that can be
  written, excluding the trailing NULL.

  Here, the size that is passed, DNAME_INLINE_LEN, does not take into account
  the size of "adf7242-" that is already in the array.

  In order to fix it, use snprintf() instead.
- Igc: Fix ambiguity in the ethtool advertising. [Sasha Neftin]

  [ Upstream commit e7684d29efdf37304c62bb337ea55b3428ca118e ]

  The 'ethtool_convert_link_mode_to_legacy_u32' method does not allow us to
  advertise 2500M speed support and TP (twisted pair) properly. Convert to
  'ethtool_link_ksettings_test_link_mode' to advertise supported speed and
  eliminate ambiguity.
- Neighbour: fix various data-races. [Eric Dumazet]

  [ Upstream commit a9beb7e81bcb876615e1fbb3c07f3f9dba69831f ]

  1) tbl->gc_thresh1, tbl->gc_thresh2, tbl->gc_thresh3 and tbl->gc_interval
     can be written from sysfs.

  2) tbl->last_flush is read locklessly from neigh_alloc()

  3) tbl->proxy_queue.qlen is read locklessly from neightbl_fill_info()

  4) neightbl_fill_info() reads cpu stats that can be changed concurrently.
- Igb: Fix potential memory leak in igb_add_ethtool_nfc_entry. [Mateusz
  Palczewski]

  [ Upstream commit 8c0b48e01daba5ca58f939a8425855d3f4f2ed14 ]

  Add check for return of igb_update_ethtool_nfc_entry so that in case
  of any potential errors the memory alocated for input will be freed.
- Treewide: Spelling fix in comment. [Kunwu Chan]

  [ Upstream commit fb71ba0ed8be9534493c80ba00142a64d9972a72 ]

  reques -> request
- R8169: fix the KCSAN reported data race in rtl_rx while reading
  desc->opts1. [Mirsad Goran Todorovac]

  [ Upstream commit f97eee484e71890131f9c563c5cc6d5a69e4308d ]

  KCSAN reported the following data-race bug:

  ==================================================================
  BUG: KCSAN: data-race in rtl8169_poll (drivers/net/ethernet/realtek/r8169_main.c:4430 drivers/net/ethernet/realtek/r8169_main.c:4583) r8169

  race at unknown origin, with read to 0xffff888117e43510 of 4 bytes by interrupt on cpu 21:
  rtl8169_poll (drivers/net/ethernet/realtek/r8169_main.c:4430 drivers/net/ethernet/realtek/r8169_main.c:4583) r8169
  __napi_poll (net/core/dev.c:6527)
  net_rx_action (net/core/dev.c:6596 net/core/dev.c:6727)
  __do_softirq (kernel/softirq.c:553)
  __irq_exit_rcu (kernel/softirq.c:427 kernel/softirq.c:632)
  irq_exit_rcu (kernel/softirq.c:647)
  sysvec_apic_timer_interrupt (arch/x86/kernel/apic/apic.c:1074 (discriminator 14))
  asm_sysvec_apic_timer_interrupt (./arch/x86/include/asm/idtentry.h:645)
  cpuidle_enter_state (drivers/cpuidle/cpuidle.c:291)
  cpuidle_enter (drivers/cpuidle/cpuidle.c:390)
  call_cpuidle (kernel/sched/idle.c:135)
  do_idle (kernel/sched/idle.c:219 kernel/sched/idle.c:282)
  cpu_startup_entry (kernel/sched/idle.c:378 (discriminator 1))
  start_secondary (arch/x86/kernel/smpboot.c:210 arch/x86/kernel/smpboot.c:294)
  secondary_startup_64_no_verify (arch/x86/kernel/head_64.S:433)

  value changed: 0x80003fff -> 0x3402805f

  Reported by Kernel Concurrency Sanitizer on:
  CPU: 21 PID: 0 Comm: swapper/21 Tainted: G             L     6.6.0-rc2-kcsan-00143-gb5cbe7c00aa0 #41
  Hardware name: ASRock X670E PG Lightning/X670E PG Lightning, BIOS 1.21 04/26/2023
  ==================================================================

  drivers/net/ethernet/realtek/r8169_main.c:
  ==========================================
     4429
   → 4430                 status = le32_to_cpu(desc->opts1);
     4431                 if (status & DescOwn)
     4432                         break;
     4433
     4434                 /* This barrier is needed to keep us from reading
     4435                  * any other fields out of the Rx descriptor until
     4436                  * we know the status of DescOwn
     4437                  */
     4438                 dma_rmb();
     4439
     4440                 if (unlikely(status & RxRES)) {
     4441                         if (net_ratelimit())
     4442                                 netdev_warn(dev, "Rx ERROR. status = %08x\n",

  Marco Elver explained that dma_rmb() doesn't prevent the compiler to tear up the access to
  desc->opts1 which can be written to concurrently. READ_ONCE() should prevent that from
  happening:

     4429
   → 4430                 status = le32_to_cpu(READ_ONCE(desc->opts1));
     4431                 if (status & DescOwn)
     4432                         break;
     4433

  As the consequence of this fix, this KCSAN warning was eliminated.
- R8169: fix the KCSAN reported data-race in rtl_tx while reading
  TxDescArray[entry].opts1. [Mirsad Goran Todorovac]

  [ Upstream commit dcf75a0f6bc136de94e88178ae5f51b7f879abc9 ]

  KCSAN reported the following data-race:

  ==================================================================
  BUG: KCSAN: data-race in rtl8169_poll (drivers/net/ethernet/realtek/r8169_main.c:4368 drivers/net/ethernet/realtek/r8169_main.c:4581) r8169

  race at unknown origin, with read to 0xffff888140d37570 of 4 bytes by interrupt on cpu 21:
  rtl8169_poll (drivers/net/ethernet/realtek/r8169_main.c:4368 drivers/net/ethernet/realtek/r8169_main.c:4581) r8169
  __napi_poll (net/core/dev.c:6527)
  net_rx_action (net/core/dev.c:6596 net/core/dev.c:6727)
  __do_softirq (kernel/softirq.c:553)
  __irq_exit_rcu (kernel/softirq.c:427 kernel/softirq.c:632)
  irq_exit_rcu (kernel/softirq.c:647)
  sysvec_apic_timer_interrupt (arch/x86/kernel/apic/apic.c:1074 (discriminator 14))
  asm_sysvec_apic_timer_interrupt (./arch/x86/include/asm/idtentry.h:645)
  cpuidle_enter_state (drivers/cpuidle/cpuidle.c:291)
  cpuidle_enter (drivers/cpuidle/cpuidle.c:390)
  call_cpuidle (kernel/sched/idle.c:135)
  do_idle (kernel/sched/idle.c:219 kernel/sched/idle.c:282)
  cpu_startup_entry (kernel/sched/idle.c:378 (discriminator 1))
  start_secondary (arch/x86/kernel/smpboot.c:210 arch/x86/kernel/smpboot.c:294)
  secondary_startup_64_no_verify (arch/x86/kernel/head_64.S:433)

  value changed: 0xb0000042 -> 0x00000000

  Reported by Kernel Concurrency Sanitizer on:
  CPU: 21 PID: 0 Comm: swapper/21 Tainted: G             L     6.6.0-rc2-kcsan-00143-gb5cbe7c00aa0 #41
  Hardware name: ASRock X670E PG Lightning/X670E PG Lightning, BIOS 1.21 04/26/2023
  ==================================================================

  The read side is in

  drivers/net/ethernet/realtek/r8169_main.c
  =========================================
     4355 static void rtl_tx(struct net_device *dev, struct rtl8169_private *tp,
     4356                    int budget)
     4357 {
     4358         unsigned int dirty_tx, bytes_compl = 0, pkts_compl = 0;
     4359         struct sk_buff *skb;
     4360
     4361         dirty_tx = tp->dirty_tx;
     4362
     4363         while (READ_ONCE(tp->cur_tx) != dirty_tx) {
     4364                 unsigned int entry = dirty_tx % NUM_TX_DESC;
     4365                 u32 status;
     4366
   → 4367                 status = le32_to_cpu(tp->TxDescArray[entry].opts1);
     4368                 if (status & DescOwn)
     4369                         break;
     4370
     4371                 skb = tp->tx_skb[entry].skb;
     4372                 rtl8169_unmap_tx_skb(tp, entry);
     4373
     4374                 if (skb) {
     4375                         pkts_compl++;
     4376                         bytes_compl += skb->len;
     4377                         napi_consume_skb(skb, budget);
     4378                 }
     4379                 dirty_tx++;
     4380         }
     4381
     4382         if (tp->dirty_tx != dirty_tx) {
     4383                 dev_sw_netstats_tx_add(dev, pkts_compl, bytes_compl);
     4384                 WRITE_ONCE(tp->dirty_tx, dirty_tx);
     4385
     4386                 netif_subqueue_completed_wake(dev, 0, pkts_compl, bytes_compl,
     4387                                               rtl_tx_slots_avail(tp),
     4388                                               R8169_TX_START_THRS);
     4389                 /*
     4390                  * 8168 hack: TxPoll requests are lost when the Tx packets are
     4391                  * too close. Let's kick an extra TxPoll request when a burst
     4392                  * of start_xmit activity is detected (if it is not detected,
     4393                  * it is slow enough). -- FR
     4394                  * If skb is NULL then we come here again once a tx irq is
     4395                  * triggered after the last fragment is marked transmitted.
     4396                  */
     4397                 if (READ_ONCE(tp->cur_tx) != dirty_tx && skb)
     4398                         rtl8169_doorbell(tp);
     4399         }
     4400 }

  tp->TxDescArray[entry].opts1 is reported to have a data-race and READ_ONCE() fixes
  this KCSAN warning.

     4366
   → 4367                 status = le32_to_cpu(READ_ONCE(tp->TxDescArray[entry].opts1));
     4368                 if (status & DescOwn)
     4369                         break;
     4370
- Drm/dp_mst: Fix NULL deref in get_mst_branch_device_by_guid_helper()
  [Lukasz Majczak]

  [ Upstream commit 3d887d512494d678b17c57b835c32f4e48d34f26 ]

  As drm_dp_get_mst_branch_device_by_guid() is called from
  drm_dp_get_mst_branch_device_by_guid(), mstb parameter has to be checked,
  otherwise NULL dereference may occur in the call to
  the memcpy() and cause following:

  [12579.365869] BUG: kernel NULL pointer dereference, address: 0000000000000049
  [12579.365878] #PF: supervisor read access in kernel mode
  [12579.365880] #PF: error_code(0x0000) - not-present page
  [12579.365882] PGD 0 P4D 0
  [12579.365887] Oops: 0000 [#1] PREEMPT SMP NOPTI
  ...
  [12579.365895] Workqueue: events_long drm_dp_mst_up_req_work
  [12579.365899] RIP: 0010:memcmp+0xb/0x29
  [12579.365921] Call Trace:
  [12579.365927] get_mst_branch_device_by_guid_helper+0x22/0x64
  [12579.365930] drm_dp_mst_up_req_work+0x137/0x416
  [12579.365933] process_one_work+0x1d0/0x419
  [12579.365935] worker_thread+0x11a/0x289
  [12579.365938] kthread+0x13e/0x14f
  [12579.365941] ? process_one_work+0x419/0x419
  [12579.365943] ? kthread_blkcg+0x31/0x31
  [12579.365946] ret_from_fork+0x1f/0x30

  As get_mst_branch_device_by_guid_helper() is recursive, moving condition
  to the first line allow to remove a similar one for step over of NULL elements
  inside a loop.
- Mmc: renesas_sdhi: use custom mask for TMIO_MASK_ALL. [Wolfram Sang]

  commit 9f12cac1bb88e3296990e760d867a98308d6b0ac upstream.

  Populate the new member for custom mask values to make sure this value
  is applied whenever needed. Also, rename the define holding the value
  because this is not only about initialization anymore.

  Signed-off-by: Wolfram Sang <wsa+renesas@sang-engineering.com>
  Reviewed-by: Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>
  Tested-by: Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>
  Link: https://lore.kernel.org/r/20210304092903.8534-1-wsa+renesas@sang-engineering.com
  Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
  [geert: Backport to v5.10.199]
- Mm/page_alloc: correct start page when guard page debug is enabled.
  [Kemeng Shi]

  commit 61e21cf2d2c3cc5e60e8d0a62a77e250fccda62c upstream.

  When guard page debug is enabled and set_page_guard returns success, we
  miss to forward page to point to start of next split range and we will do
  split unexpectedly in page range without target page.  Move start page
  update before set_page_guard to fix this.

  As we split to wrong target page, then splited pages are not able to merge
  back to original order when target page is put back and splited pages
  except target page is not usable.  To be specific:

  Consider target page is the third page in buddy page with order 2.
  | buddy-2 | Page | Target | Page |

  After break down to target page, we will only set first page to Guard
  because of bug.
  | Guard   | Page | Target | Page |

  When we try put_page_back_buddy with target page, the buddy page of target
  if neither guard nor buddy, Then it's not able to construct original page
  with order 2
  | Guard | Page | buddy-0 | Page |

  All pages except target page is not in free list and is not usable.
- Virtio-mmio: fix memory leak of vm_dev. [Maximilian Heyne]

  commit fab7f259227b8f70aa6d54e1de1a1f5f4729041c upstream.

  With the recent removal of vm_dev from devres its memory is only freed
  via the callback virtio_mmio_release_dev. However, this only takes
  effect after device_add is called by register_virtio_device. Until then
  it's an unmanaged resource and must be explicitly freed on error exit.

  This bug was discovered and resolved using Coverity Static Analysis
  Security Testing (SAST) by Synopsys, Inc.
- Virtio_balloon: Fix endless deflation and inflation on arm64. [Gavin
  Shan]

  commit 07622bd415639e9709579f400afd19e7e9866e5e upstream.

  The deflation request to the target, which isn't unaligned to the
  guest page size causes endless deflation and inflation actions. For
  example, we receive the flooding QMP events for the changes on memory
  balloon's size after a deflation request to the unaligned target is
  sent for the ARM64 guest, where we have 64KB base page size.

    /home/gavin/sandbox/qemu.main/build/qemu-system-aarch64      \
    -accel kvm -machine virt,gic-version=host -cpu host          \
    -smp maxcpus=8,cpus=8,sockets=2,clusters=2,cores=2,threads=1 \
    -m 1024M,slots=16,maxmem=64G                                 \
    -object memory-backend-ram,id=mem0,size=512M                 \
    -object memory-backend-ram,id=mem1,size=512M                 \
    -numa node,nodeid=0,memdev=mem0,cpus=0-3                     \
    -numa node,nodeid=1,memdev=mem1,cpus=4-7                     \
      :                                                          \
    -device virtio-balloon-pci,id=balloon0,bus=pcie.10

    { "execute" : "balloon", "arguments": { "value" : 1073672192 } }
    {"return": {}}
    {"timestamp": {"seconds": 1693272173, "microseconds": 88667},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272174, "microseconds": 89704},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272175, "microseconds": 90819},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272176, "microseconds": 91961},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272177, "microseconds": 93040},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073676288}}
    {"timestamp": {"seconds": 1693272178, "microseconds": 94117},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073676288}}
    {"timestamp": {"seconds": 1693272179, "microseconds": 95337},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272180, "microseconds": 96615},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073676288}}
    {"timestamp": {"seconds": 1693272181, "microseconds": 97626},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272182, "microseconds": 98693},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073676288}}
    {"timestamp": {"seconds": 1693272183, "microseconds": 99698},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272184, "microseconds": 100727},  \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272185, "microseconds": 90430},   \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    {"timestamp": {"seconds": 1693272186, "microseconds": 102999},  \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073676288}}
       :
    <The similar QMP events repeat>

  Fix it by aligning the target up to the guest page size, 64KB in this
  specific case. With this applied, no flooding QMP events are observed
  and the memory balloon's size can be stablizied to 0x3ffe0000 soon
  after the deflation request is sent.

    { "execute" : "balloon", "arguments": { "value" : 1073672192 } }
    {"return": {}}
    {"timestamp": {"seconds": 1693273328, "microseconds": 793075},  \
     "event": "BALLOON_CHANGE", "data": {"actual": 1073610752}}
    { "execute" : "query-balloon" }
    {"return": {"actual": 1073610752}}
- Mcb-lpc: Reallocate memory region to avoid memory overlapping.
  [Rodríguez Barbarin, José Javier]

  [ Upstream commit 2025b2ca8004c04861903d076c67a73a0ec6dfca ]

  mcb-lpc requests a fixed-size memory region to parse the chameleon
  table, however, if the chameleon table is smaller that the allocated
  region, it could overlap with the IP Cores' memory regions.

  After parsing the chameleon table, drop/reallocate the memory region
  with the actual chameleon table size.
- Mcb: Return actual parsed size when reading chameleon table.
  [Rodríguez Barbarin, José Javier]

  [ Upstream commit a889c276d33d333ae96697510f33533f6e9d9591 ]

  The function chameleon_parse_cells() returns the number of cells
  parsed which has an undetermined size. This return value is only
  used for error checking but the number of cells is never used.

  Change return value to be number of bytes parsed to allow for
  memory management improvements.
- Selftests/ftrace: Add new test case which checks non unique symbol.
  [Francis Laniel]

  [ Upstream commit 03b80ff8023adae6780e491f66e932df8165e3a0 ]

  If name_show() is non unique, this test will try to install a kprobe on this
  function which should fail returning EADDRNOTAVAIL.
  On kernel where name_show() is not unique, this test is skipped.
- Linux 5.10.199. [Greg Kroah-Hartman]
- Xfrm6: fix inet6_dev refcount underflow problem. [Zhang Changzhong]

  [ Upstream commit cc9b364bb1d58d3dae270c7a931a8cc717dc2b3b ]

  There are race conditions that may lead to inet6_dev refcount underflow
  in xfrm6_dst_destroy() and rt6_uncached_list_flush_dev().

  One of the refcount underflow bugs is shown below:
  	(cpu 1)                	|	(cpu 2)
  xfrm6_dst_destroy()             |
    ...                           |
    in6_dev_put()                 |
  				|  rt6_uncached_list_flush_dev()
    ...				|    ...
  				|    in6_dev_put()
    rt6_uncached_list_del()       |    ...
    ...                           |

  xfrm6_dst_destroy() calls rt6_uncached_list_del() after in6_dev_put(),
  so rt6_uncached_list_flush_dev() has a chance to call in6_dev_put()
  again for the same inet6_dev.

  Fix it by moving in6_dev_put() after rt6_uncached_list_del() in
  xfrm6_dst_destroy().
- Bluetooth: hci_sock: Correctly bounds check and pad HCI_MON_NEW_INDEX
  name. [Kees Cook]

  commit cb3871b1cd135a6662b732fbc6b3db4afcdb4a64 upstream.

  The code pattern of memcpy(dst, src, strlen(src)) is almost always
  wrong. In this case it is wrong because it leaves memory uninitialized
  if it is less than sizeof(ni->name), and overflows ni->name when longer.

  Normally strtomem_pad() could be used here, but since ni->name is a
  trailing array in struct hci_mon_new_index, compilers that don't support
  -fstrict-flex-arrays=3 can't tell how large this array is via
  __builtin_object_size(). Instead, open-code the helper and use sizeof()
  since it will work correctly.

  Additionally mark ni->name as __nonstring since it appears to not be a
  %NUL terminated C string.
- Bluetooth: hci_sock: fix slab oob read in create_monitor_event.
  [Edward AD]

  commit 18f547f3fc074500ab5d419cf482240324e73a7e upstream.

  When accessing hdev->name, the actual string length should prevail
- Phy: mapphone-mdm6600: Fix pinctrl_pm handling for sleep pins. [Tony
  Lindgren]

  [ Upstream commit 3b384cc74b00b5ac21d18e4c1efc3c1da5300971 ]

  Looks like the driver sleep pins configuration is unusable. Adding the
  sleep pins causes the usb phy to not respond. We need to use the default
  pins in probe, and only set sleep pins at phy_mdm6600_device_power_off().

  As the modem can also be booted to a serial port mode for firmware
  flashing, let's make the pin changes limited to probe and remove. For
  probe, we get the default pins automatically. We only need to set the
  sleep pins in phy_mdm6600_device_power_off() to prevent the modem from
  waking up because the gpio line glitches.

  If it turns out that we need a separate state for phy_mdm6600_power_on()
  and phy_mdm6600_power_off(), we can use the pinctrl idle state.
- Phy: mapphone-mdm6600: Fix runtime PM for remove. [Tony Lindgren]

  [ Upstream commit b99e0ba9633af51638e5ee1668da2e33620c134f ]

  Otherwise we will get an underflow on remove.
- Phy: mapphone-mdm6600: Fix runtime disable on probe. [Tony Lindgren]

  [ Upstream commit 719606154c7033c068a5d4c1dc5f9163b814b3c8 ]

  Commit d644e0d79829 ("phy: mapphone-mdm6600: Fix PM error handling in
  phy_mdm6600_probe") caused a regression where we now unconditionally
  disable runtime PM at the end of the probe while it is only needed on
  errors.
- ASoC: pxa: fix a memory leak in probe() [Dan Carpenter]

  [ Upstream commit aa6464edbd51af4a2f8db43df866a7642b244b5f ]

  Free the "priv" pointer before returning the error code.
- Gpio: vf610: set value before the direction to avoid a glitch. [Haibo
  Chen]

  commit fc363413ef8ea842ae7a99e3caf5465dafdd3a49 upstream.

  We found a glitch when configuring the pad as output high. To avoid this
  glitch, move the data value setting before direction config in the
  function vf610_gpio_direction_output().

  Fixes: 659d8a62311f ("gpio: vf610: add imx7ulp support")
  Signed-off-by: Haibo Chen <haibo.chen@nxp.com>
  [Bartosz: tweak the commit message]
- Platform/x86: asus-wmi: Map 0x2a code, Ignore 0x2b and 0x2c events.
  [Hans de Goede]

  commit 235985d1763f7aba92c1c64e5f5aaec26c2c9b18 upstream.

  Newer Asus laptops send the following new WMI event codes when some
  of the F1 - F12 "media" hotkeys are pressed:

  0x2a Screen Capture
  0x2b PrintScreen
  0x2c CapsLock

  Map 0x2a to KEY_SELECTIVE_SCREENSHOT mirroring how similar hotkeys
  are mapped on other laptops.

  PrintScreem and CapsLock are also reported as normal PS/2 keyboard events,
  map these event codes to KE_IGNORE to avoid "Unknown key code 0x%x\n" log
  messages.
- Platform/x86: asus-wmi: Change ASUS_WMI_BRN_DOWN code from 0x20 to
  0x2e. [Hans de Goede]

  commit f37cc2fc277b371fc491890afb7d8a26e36bb3a1 upstream.

  Older Asus laptops change the backlight level themselves and then send
  WMI events with different codes for different backlight levels.

  The asus-wmi.c code maps the entire range of codes reported on
  brightness down keypresses to an internal ASUS_WMI_BRN_DOWN code:

  define NOTIFY_BRNUP_MIN                0x11
  define NOTIFY_BRNUP_MAX                0x1f
  define NOTIFY_BRNDOWN_MIN              0x20
  define NOTIFY_BRNDOWN_MAX              0x2e

          if (code >= NOTIFY_BRNUP_MIN && code <= NOTIFY_BRNUP_MAX)
                  code = ASUS_WMI_BRN_UP;
          else if (code >= NOTIFY_BRNDOWN_MIN && code <= NOTIFY_BRNDOWN_MAX)
                  code = ASUS_WMI_BRN_DOWN;

  Before this commit all the NOTIFY_BRNDOWN_MIN - NOTIFY_BRNDOWN_MAX
  aka 0x20 - 0x2e events were mapped to 0x20.

  This mapping is causing issues on new laptop models which actually
  send 0x2b events for printscreen presses and 0x2c events for
  capslock presses, which get translated into spurious brightness-down
  presses.

  The plan is disable the 0x11-0x2e special mapping on laptops
  where asus-wmi does not register a backlight-device to avoid
  the spurious brightness-down keypresses. New laptops always send
  0x2e for brightness-down presses, change the special internal
  ASUS_WMI_BRN_DOWN value from 0x20 to 0x2e to match this in
  preparation for fixing the spurious brightness-down presses.

  This change does not have any functional impact since all
  of 0x20 - 0x2e is mapped to ASUS_WMI_BRN_DOWN first and only
  then checked against the keymap code and the new 0x2e
  value is still in the 0x20 - 0x2e range.
- S390/pci: fix iommu bitmap allocation. [Niklas Schnelle]

  commit c1ae1c59c8c6e0b66a718308c623e0cb394dab6b upstream.

  Since the fixed commits both zdev->iommu_bitmap and zdev->lazy_bitmap
  are allocated as vzalloc(zdev->iommu_pages / 8). The problem is that
  zdev->iommu_bitmap is a pointer to unsigned long but the above only
  yields an allocation that is a multiple of sizeof(unsigned long) which
  is 8 on s390x if the number of IOMMU pages is a multiple of 64.
  This in turn is the case only if the effective IOMMU aperture is
  a multiple of 64 * 4K = 256K. This is usually the case and so didn't
  cause visible issues since both the virt_to_phys(high_memory) reduced
  limit and hardware limits use nice numbers.

  Under KVM, and in particular with QEMU limiting the IOMMU aperture to
  the vfio DMA limit (default 65535), it is possible for the reported
  aperture not to be a multiple of 256K however. In this case we end up
  with an iommu_bitmap whose allocation is not a multiple of
  8 causing bitmap operations to access it out of bounds.

  Sadly we can't just fix this in the obvious way and use bitmap_zalloc()
  because for large RAM systems (tested on 8 TiB) the zdev->iommu_bitmap
  grows too large for kmalloc(). So add our own bitmap_vzalloc() wrapper.
  This might be a candidate for common code, but this area of code will
  be replaced by the upcoming conversion to use the common code DMA API on
  s390 so just add a local routine.
- Perf: Disallow mis-matched inherited group reads. [Peter Zijlstra]

  commit 32671e3799ca2e4590773fd0e63aaa4229e50c06 upstream.

  Because group consistency is non-atomic between parent (filedesc) and children
  (inherited) events, it is possible for PERF_FORMAT_GROUP read() to try and sum
  non-matching counter groups -- with non-sensical results.

  Add group_generation to distinguish the case where a parent group removes and
  adds an event and thus has the same number, but a different configuration of
  events as inherited groups.

  This became a problem when commit fa8c269353d5 ("perf/core: Invert
  perf_read_group() loops") flipped the order of child_list and sibling_list.
  Previously it would iterate the group (sibling_list) first, and for each
  sibling traverse the child_list. In this order, only the group composition of
  the parent is relevant. By flipping the order the group composition of the
  child (inherited) events becomes an issue and the mis-match in group
  composition becomes evident.

  That said; even prior to this commit, while reading of a group that is not
  equally inherited was not broken, it still made no sense.

  (Ab)use ECHILD as error return to indicate issues with child process group
  composition.
- USB: serial: option: add Fibocom to DELL custom modem FM101R-GL.
  [Puliang Lu]

  commit 52480e1f1a259c93d749ba3961af0bffedfe7a7a upstream.

  Update the USB serial option driver support for the Fibocom
  FM101R-GL LTE modules as there are actually several different variants.

  - VID:PID 413C:8213, FM101R-GL are laptop M.2 cards (with
    MBIM interfaces for Linux)

  - VID:PID 413C:8215, FM101R-GL ESIM are laptop M.2 cards (with
    MBIM interface for Linux)

  0x8213: mbim, tty
  0x8215: mbim, tty

  T:  Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  2 Spd=5000 MxCh= 0
  D:  Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs=  1
  P:  Vendor=413c ProdID=8213 Rev= 5.04
  S:  Manufacturer=Fibocom Wireless Inc.
  S:  Product=Fibocom FM101-GL Module
  S:  SerialNumber=a3b7cbf0
  C:* #Ifs= 3 Cfg#= 1 Atr=a0 MxPwr=896mA
  A:  FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=0e Prot=00
  I:* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=0e Prot=00 Driver=cdc_mbim
  E:  Ad=81(I) Atr=03(Int.) MxPS=  64 Ivl=32ms
  I:  If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  I:* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  E:  Ad=8e(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=0f(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=40 Driver=(none)
  E:  Ad=83(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms

  T:  Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  3 Spd=5000 MxCh= 0
  D:  Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs=  1
  P:  Vendor=413c ProdID=8215 Rev= 5.04
  S:  Manufacturer=Fibocom Wireless Inc.
  S:  Product=Fibocom FM101-GL Module
  S:  SerialNumber=a3b7cbf0
  C:* #Ifs= 3 Cfg#= 1 Atr=a0 MxPwr=896mA
  A:  FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=0e Prot=00
  I:* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=0e Prot=00 Driver=cdc_mbim
  E:  Ad=81(I) Atr=03(Int.) MxPS=  64 Ivl=32ms
  I:  If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  I:* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  E:  Ad=8e(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=0f(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  I:* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=40 Driver=(none)
  E:  Ad=83(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
  E:  Ad=01(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
- USB: serial: option: add entry for Sierra EM9191 with new firmware.
  [Benoît Monin]

  commit 064f6e2ba9eb59b2c87b866e1e968e79ccedf9dd upstream.

  Following a firmware update of the modem, the interface for the AT
  command port changed, so add it back.

  T:  Bus=08 Lev=01 Prnt=01 Port=01 Cnt=02 Dev#=  2 Spd=5000 MxCh= 0
  D:  Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs=  1
  P:  Vendor=1199 ProdID=90d3 Rev=00.06
  S:  Manufacturer=Sierra Wireless, Incorporated
  S:  Product=Sierra Wireless EM9191
  S:  SerialNumber=xxxxxxxxxxxxxxxx
  C:  #Ifs= 4 Cfg#= 1 Atr=a0 MxPwr=896mA
  I:  If#=0x0 Alt= 0 #EPs= 1 Cls=02(commc) Sub=0e Prot=00 Driver=cdc_mbim
  I:  If#=0x1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc_mbim
  I:  If#=0x3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=40 Driver=(none)
  I:  If#=0x4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=30 Driver=option
- USB: serial: option: add Telit LE910C4-WWX 0x1035 composition. [Fabio
  Porcedda]

  commit 6a7be48e9bd18d309ba25c223a27790ad1bf0fa3 upstream.

  Add support for the following Telit LE910C4-WWX composition:

  0x1035: TTY, TTY, ECM

  T:  Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  5 Spd=480 MxCh= 0
  D:  Ver= 2.00 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs=  1
  P:  Vendor=1bc7 ProdID=1035 Rev=00.00
  S:  Manufacturer=Telit
  S:  Product=LE910C4-WWX
  S:  SerialNumber=e1b117c7
  C:  #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=500mA
  I:  If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
  E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=81(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:  If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=fe Prot=ff Driver=option
  E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=83(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  E:  Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  I:  If#= 2 Alt= 0 #EPs= 1 Cls=02(commc) Sub=06 Prot=00 Driver=cdc_ether
  E:  Ad=85(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
  I:  If#= 3 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc_ether
  E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
  E:  Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
- Nvme-rdma: do not try to stop unallocated queues. [Maurizio Lombardi]

  commit 3820c4fdc247b6f0a4162733bdb8ddf8f2e8a1e4 upstream.

  Trying to stop a queue which hasn't been allocated will result
  in a warning due to calling mutex_lock() against an uninitialized mutex.

   DEBUG_LOCKS_WARN_ON(lock->magic != lock)
   WARNING: CPU: 4 PID: 104150 at kernel/locking/mutex.c:579

   Call trace:
    RIP: 0010:__mutex_lock+0x1173/0x14a0
    nvme_rdma_stop_queue+0x1b/0xa0 [nvme_rdma]
    nvme_rdma_teardown_io_queues.part.0+0xb0/0x1d0 [nvme_rdma]
    nvme_rdma_delete_ctrl+0x50/0x100 [nvme_rdma]
    nvme_do_delete_ctrl+0x149/0x158 [nvme_core]
- Nvme-pci: add BOGUS_NID for Intel 0a54 device. [Keith Busch]

  commit 5c3f4066462a5f6cac04d3dd81c9f551fabbc6c7 upstream.

  These ones claim cmic and nmic capable, so need special consideration to ignore
  their duplicate identifiers.
- ACPI: irq: Fix incorrect return value in acpi_register_gsi() [Sunil V
  L]

  commit 0c21a18d5d6c6a73d098fb9b4701572370942df9 upstream.

  acpi_register_gsi() should return a negative value in case of failure.

  Currently, it returns the return value from irq_create_fwspec_mapping().
  However, irq_create_fwspec_mapping() returns 0 for failure. Fix the
  issue by returning -EINVAL if irq_create_fwspec_mapping() returns zero.

  Fixes: d44fa3d46079 ("ACPI: Add support for ResourceSource/IRQ domain mapping")
  Cc: 4.11+ <stable@vger.kernel.org> # 4.11+
  Signed-off-by: Sunil V L <sunilvl@ventanamicro.com>
  [ rjw: Rename a new local variable ]
- PNFS: Fix a hang in nfs4_evict_inode() [Trond Myklebust]

  commit f63955721a8020e979b99cc417dcb6da3106aa24 upstream.

  We are not allowed to call pnfs_mark_matching_lsegs_return() without
  also holding a reference to the layout header, since doing so could lead
  to the reference count going to zero when we call
  pnfs_layout_remove_lseg(). This again can lead to a hang when we get to
  nfs4_evict_inode() and are unable to clear the layout pointer.

  pnfs_layout_return_unused_byserver() is guilty of this behaviour, and
  has been seen to trigger the refcount warning prior to a hang.
- Revert "pinctrl: avoid unsafe code pattern in find_pinctrl()" [Andy
  Shevchenko]

  commit 62140a1e4dec4594d5d1e1d353747bf2ef434e8b upstream.

  The commit breaks MMC enumeration on the Intel Merrifield
  plaform.

  Before:
  [   36.439057] mmc0: SDHCI controller on PCI [0000:00:01.0] using ADMA
  [   36.450924] mmc2: SDHCI controller on PCI [0000:00:01.3] using ADMA
  [   36.459355] mmc1: SDHCI controller on PCI [0000:00:01.2] using ADMA
  [   36.706399] mmc0: new DDR MMC card at address 0001
  [   37.058972] mmc2: new ultra high speed DDR50 SDIO card at address 0001
  [   37.278977] mmcblk0: mmc0:0001 H4G1d 3.64 GiB
  [   37.297300]  mmcblk0: p1 p2 p3 p4 p5 p6 p7 p8 p9 p10

  After:
  [   36.436704] mmc2: SDHCI controller on PCI [0000:00:01.3] using ADMA
  [   36.436720] mmc1: SDHCI controller on PCI [0000:00:01.0] using ADMA
  [   36.463685] mmc0: SDHCI controller on PCI [0000:00:01.2] using ADMA
  [   36.720627] mmc1: new DDR MMC card at address 0001
  [   37.068181] mmc2: new ultra high speed DDR50 SDIO card at address 0001
  [   37.279998] mmcblk1: mmc1:0001 H4G1d 3.64 GiB
  [   37.302670]  mmcblk1: p1 p2 p3 p4 p5 p6 p7 p8 p9 p10

  This reverts commit c153a4edff6ab01370fcac8e46f9c89cca1060c2.
- Mmc: core: Capture correct oemid-bits for eMMC cards. [Avri Altman]

  commit 84ee19bffc9306128cd0f1c650e89767079efeff upstream.

  The OEMID is an 8-bit binary number rather than 16-bit as the current code
  parses for. The OEMID occupies bits [111:104] in the CID register, see the
  eMMC spec JESD84-B51 paragraph 7.2.3. It seems that the 16-bit comes from
  the legacy MMC specs (v3.31 and before).

  Let's fix the parsing by simply move to use 8-bit instead of 16-bit. This
  means we ignore the impact on some of those old MMC cards that may be out
  there, but on the other hand this shouldn't be a problem as the OEMID seems
  not be an important feature for these cards.
- Mmc: core: sdio: hold retuning if sdio in 1-bit mode. [Haibo Chen]

  commit 32a9cdb8869dc111a0c96cf8e1762be9684af15b upstream.

  tuning only support in 4-bit mode or 8 bit mode, so in 1-bit mode,
  need to hold retuning.

  Find this issue when use manual tuning method on imx93. When system
  resume back, SDIO WIFI try to switch back to 4 bit mode, first will
  trigger retuning, and all tuning command failed.
- Mtd: physmap-core: Restore map_rom fallback. [Geert Uytterhoeven]

  commit 6792b7fce610bcd1cf3e07af3607fe7e2c38c1d8 upstream.

  When the exact mapping type driver was not available, the old
  physmap_of_core driver fell back to mapping the region as ROM.
  Unfortunately this feature was lost when the DT and pdata cases were
  merged.  Revive this useful feature.
- Mtd: spinand: micron: correct bitmask for ecc status. [Martin
  Kurbanov]

  commit 9836a987860e33943945d4b257729a4f94eae576 upstream.

  Valid bitmask is 0x70 in the status register.
- Mtd: rawnand: arasan: Ensure program page operations are successful.
  [Miquel Raynal]

  commit 3a4a893dbb19e229db3b753f0462520b561dee98 upstream.

  The NAND core complies with the ONFI specification, which itself
  mentions that after any program or erase operation, a status check
  should be performed to see whether the operation was finished *and*
  successful.

  The NAND core offers helpers to finish a page write (sending the
  "PAGE PROG" command, waiting for the NAND chip to be ready again, and
  checking the operation status). But in some cases, advanced controller
  drivers might want to optimize this and craft their own page write
  helper to leverage additional hardware capabilities, thus not always
  using the core facilities.

  Some drivers, like this one, do not use the core helper to finish a page
  write because the final cycles are automatically managed by the
  hardware. In this case, the additional care must be taken to manually
  perform the final status check.

  Let's read the NAND chip status at the end of the page write helper and
  return -EIO upon error.
- Mtd: rawnand: marvell: Ensure program page operations are successful.
  [Miquel Raynal]

  commit 3e01d5254698ea3d18e09d96b974c762328352cd upstream.

  The NAND core complies with the ONFI specification, which itself
  mentions that after any program or erase operation, a status check
  should be performed to see whether the operation was finished *and*
  successful.

  The NAND core offers helpers to finish a page write (sending the
  "PAGE PROG" command, waiting for the NAND chip to be ready again, and
  checking the operation status). But in some cases, advanced controller
  drivers might want to optimize this and craft their own page write
  helper to leverage additional hardware capabilities, thus not always
  using the core facilities.

  Some drivers, like this one, do not use the core helper to finish a page
  write because the final cycles are automatically managed by the
  hardware. In this case, the additional care must be taken to manually
  perform the final status check.

  Let's read the NAND chip status at the end of the page write helper and
  return -EIO upon error.
- Mtd: rawnand: qcom: Unmap the right resource upon probe failure.
  [Bibek Kumar Patro]

  commit 5279f4a9eed3ee7d222b76511ea7a22c89e7eefd upstream.

  We currently provide the physical address of the DMA region
  rather than the output of dma_map_resource() which is obviously wrong.
- Bluetooth: hci_event: Fix using memcmp when comparing keys. [Luiz
  Augusto von Dentz]

  [ Upstream commit b541260615f601ae1b5d6d0cc54e790de706303b ]

  memcmp is not consider safe to use with cryptographic secrets:

   'Do  not  use memcmp() to compare security critical data, such as
   cryptographic secrets, because the required CPU time depends on the
   number of equal bytes.'

  While usage of memcmp for ZERO_KEY may not be considered a security
  critical data, it can lead to more usage of memcmp with pairing keys
  which could introduce more security problems.
- Net/mlx5: Handle fw tracer change ownership event based on MTRC.
  [Maher Sanalla]

  [ Upstream commit 92fd39634541eb0a11bf1bafbc8ba92d6ddb8dba ]

  Currently, whenever fw issues a change ownership event, the PF that owns
  the fw tracer drops its ownership directly and the other PFs try to pick
  up the ownership via what MTRC register suggests.

  In some cases, driver releases the ownership of the tracer and reacquires
  it later on. Whenever the driver releases ownership of the tracer, fw
  issues a change ownership event. This event can be delayed and come after
  driver has reacquired ownership of the tracer. Thus the late event will
  trigger the tracer owner PF to release the ownership again and lead to a
  scenario where no PF is owning the tracer.

  To prevent the scenario described above, when handling a change
  ownership event, do not drop ownership of the tracer directly, instead
  read the fw MTRC register to retrieve the up-to-date owner of the tracer
  and set it accordingly in driver level.
- Platform/x86: touchscreen_dmi: Add info for the Positivo C4128B.
  [Renan Guilherme Lebre Ramos]

  [ Upstream commit aa7dcba3bae6869122828b144a3cfd231718089d ]

  Add information for the Positivo C4128B, a notebook/tablet convertible.
- HID: multitouch: Add required quirk for Synaptics 0xcd7e device.
  [Rahul Rameshbabu]

  [ Upstream commit 1437e4547edf41689d7135faaca4222ef0081bc1 ]

  Register the Synaptics device as a special multitouch device with certain
  quirks that may improve usability of the touchpad device.
- Btrfs: fix some -Wmaybe-uninitialized warnings in ioctl.c. [Josef
  Bacik]

  [ Upstream commit 9147b9ded499d9853bdf0e9804b7eaa99c4429ed ]

  Jens reported the following warnings from -Wmaybe-uninitialized recent
  Linus' branch.

    In file included from ./include/asm-generic/rwonce.h:26,
  		   from ./arch/arm64/include/asm/rwonce.h:71,
  		   from ./include/linux/compiler.h:246,
  		   from ./include/linux/export.h:5,
  		   from ./include/linux/linkage.h:7,
  		   from ./include/linux/kernel.h:17,
  		   from fs/btrfs/ioctl.c:6:
    In function ‘instrument_copy_from_user_before’,
        inlined from ‘_copy_from_user’ at ./include/linux/uaccess.h:148:3,
        inlined from ‘copy_from_user’ at ./include/linux/uaccess.h:183:7,
        inlined from ‘btrfs_ioctl_space_info’ at fs/btrfs/ioctl.c:2999:6,
        inlined from ‘btrfs_ioctl’ at fs/btrfs/ioctl.c:4616:10:
    ./include/linux/kasan-checks.h:38:27: warning: ‘space_args’ may be used
    uninitialized [-Wmaybe-uninitialized]
       38 | #define kasan_check_write __kasan_check_write
    ./include/linux/instrumented.h:129:9: note: in expansion of macro
    ‘kasan_check_write’
      129 |         kasan_check_write(to, n);
  	|         ^~~~~~~~~~~~~~~~~
    ./include/linux/kasan-checks.h: In function ‘btrfs_ioctl’:
    ./include/linux/kasan-checks.h:20:6: note: by argument 1 of type ‘const
    volatile void *’ to ‘__kasan_check_write’ declared here
       20 | bool __kasan_check_write(const volatile void *p, unsigned int
  	size);
  	|      ^~~~~~~~~~~~~~~~~~~
    fs/btrfs/ioctl.c:2981:39: note: ‘space_args’ declared here
     2981 |         struct btrfs_ioctl_space_args space_args;
  	|                                       ^~~~~~~~~~
    In function ‘instrument_copy_from_user_before’,
        inlined from ‘_copy_from_user’ at ./include/linux/uaccess.h:148:3,
        inlined from ‘copy_from_user’ at ./include/linux/uaccess.h:183:7,
        inlined from ‘_btrfs_ioctl_send’ at fs/btrfs/ioctl.c:4343:9,
        inlined from ‘btrfs_ioctl’ at fs/btrfs/ioctl.c:4658:10:
    ./include/linux/kasan-checks.h:38:27: warning: ‘args32’ may be used
    uninitialized [-Wmaybe-uninitialized]
       38 | #define kasan_check_write __kasan_check_write
    ./include/linux/instrumented.h:129:9: note: in expansion of macro
    ‘kasan_check_write’
      129 |         kasan_check_write(to, n);
  	|         ^~~~~~~~~~~~~~~~~
    ./include/linux/kasan-checks.h: In function ‘btrfs_ioctl’:
    ./include/linux/kasan-checks.h:20:6: note: by argument 1 of type ‘const
    volatile void *’ to ‘__kasan_check_write’ declared here
       20 | bool __kasan_check_write(const volatile void *p, unsigned int
  	size);
  	|      ^~~~~~~~~~~~~~~~~~~
    fs/btrfs/ioctl.c:4341:49: note: ‘args32’ declared here
     4341 |                 struct btrfs_ioctl_send_args_32 args32;
  	|                                                 ^~~~~~

  This was due to his config options and having KASAN turned on,
  which adds some extra checks around copy_from_user(), which then
  triggered the -Wmaybe-uninitialized checker for these cases.

  Fix the warnings by initializing the different structs we're copying
  into.
- Drm: panel-orientation-quirks: Add quirk for One Mix 2S. [Kai Uwe
  Broulik]

  [ Upstream commit cbb7eb2dbd9472816e42a1b0fdb51af49abbf812 ]

  The One Mix 2S is a mini laptop with a 1200x1920 portrait screen
  mounted in a landscape oriented clamshell case. Because of the too
  generic DMI strings this entry is also doing bios-date matching.
- Ipv4/fib: send notify when delete source address routes. [Hangbin Liu]

  [ Upstream commit 4b2b606075e50cdae62ab2356b0a1e206947c354 ]

  After deleting an interface address in fib_del_ifaddr(), the function
  scans the fib_info list for stray entries and calls fib_flush() and
  fib_table_flush(). Then the stray entries will be deleted silently and no
  RTM_DELROUTE notification will be sent.

  This lack of notification can make routing daemons, or monitor like
  `ip monitor route` miss the routing changes. e.g.

  + ip link add dummy1 type dummy
  + ip link add dummy2 type dummy
  + ip link set dummy1 up
  + ip link set dummy2 up
  + ip addr add 192.168.5.5/24 dev dummy1
  + ip route add 7.7.7.0/24 dev dummy2 src 192.168.5.5
  + ip -4 route
  7.7.7.0/24 dev dummy2 scope link src 192.168.5.5
  192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
  + ip monitor route
  + ip addr del 192.168.5.5/24 dev dummy1
  Deleted 192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
  Deleted broadcast 192.168.5.255 dev dummy1 table local proto kernel scope link src 192.168.5.5
  Deleted local 192.168.5.5 dev dummy1 table local proto kernel scope host src 192.168.5.5

  As Ido reminded, fib_table_flush() isn't only called when an address is
  deleted, but also when an interface is deleted or put down. The lack of
  notification in these cases is deliberate. And commit 7c6bb7d2faaf
  ("net/ipv6: Add knob to skip DELROUTE message on device down") introduced
  a sysctl to make IPv6 behave like IPv4 in this regard. So we can't send
  the route delete notify blindly in fib_table_flush().

  To fix this issue, let's add a new flag in "struct fib_info" to track the
  deleted prefer source address routes, and only send notify for them.

  After update:
  + ip monitor route
  + ip addr del 192.168.5.5/24 dev dummy1
  Deleted 192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
  Deleted broadcast 192.168.5.255 dev dummy1 table local proto kernel scope link src 192.168.5.5
  Deleted local 192.168.5.5 dev dummy1 table local proto kernel scope host src 192.168.5.5
  Deleted 7.7.7.0/24 dev dummy2 scope link src 192.168.5.5
- Sky2: Make sure there is at least one frag_addr available. [Kees Cook]

  [ Upstream commit 6a70e5cbedaf8ad10528ac9ac114f3ec20f422df ]

  In the pathological case of building sky2 with 16k PAGE_SIZE, the
  frag_addr[] array would never be used, so the original code was correct
  that size should be 0. But the compiler now gets upset with 0 size arrays
  in places where it hasn't eliminated the code that might access such an
  array (it can't figure out that in this case an rx skb with fragments
  would never be created). To keep the compiler happy, make sure there is
  at least 1 frag_addr in struct rx_ring_info:

     In file included from include/linux/skbuff.h:28,
                      from include/net/net_namespace.h:43,
                      from include/linux/netdevice.h:38,
                      from drivers/net/ethernet/marvell/sky2.c:18:
     drivers/net/ethernet/marvell/sky2.c: In function 'sky2_rx_unmap_skb':
     include/linux/dma-mapping.h:416:36: warning: array subscript i is outside array bounds of 'dma_addr_t[0]' {aka 'long long unsigned int[]'} [-Warray-bounds=]
       416 | #define dma_unmap_page(d, a, s, r) dma_unmap_page_attrs(d, a, s, r, 0)
           |                                    ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     drivers/net/ethernet/marvell/sky2.c:1257:17: note: in expansion of macro 'dma_unmap_page'
      1257 |                 dma_unmap_page(&pdev->dev, re->frag_addr[i],
           |                 ^~~~~~~~~~~~~~
     In file included from drivers/net/ethernet/marvell/sky2.c:41:
     drivers/net/ethernet/marvell/sky2.h:2198:25: note: while referencing 'frag_addr'
      2198 |         dma_addr_t      frag_addr[ETH_JUMBO_MTU >> PAGE_SHIFT];
           |                         ^~~~~~~~~

  With CONFIG_PAGE_SIZE_16KB=y, PAGE_SHIFT == 14, so:

    #define ETH_JUMBO_MTU   9000

  causes "ETH_JUMBO_MTU >> PAGE_SHIFT" to be 0. Use "?: 1" to solve this build warning.
- Regulator/core: Revert "fix kobject release warning and memory leak in
  regulator_register()" [Michał Mirosław]

  [ Upstream commit 6e800968f6a715c0661716d2ec5e1f56ed9f9c08 ]

  This reverts commit 5f4b204b6b8153923d5be8002c5f7082985d153f.

  Since rdev->dev now has a release() callback, the proper way of freeing
  the initialized device can be restored.
- Wifi: cfg80211: avoid leaking stack data into trace. [Benjamin Berg]

  [ Upstream commit 334bf33eec5701a1e4e967bcb7cc8611a998334b ]

  If the structure is not initialized then boolean types might be copied
  into the tracing data without being initialised. This causes data from
  the stack to leak into the trace and also triggers a UBSAN failure which
  can easily be avoided here.
- Wifi: mac80211: allow transmitting EAPOL frames with tainted key. [Wen
  Gong]

  [ Upstream commit 61304336c67358d49a989e5e0060d8c99bad6ca8 ]

  Lower layer device driver stop/wake TX by calling ieee80211_stop_queue()/
  ieee80211_wake_queue() while hw scan. Sometimes hw scan and PTK rekey are
  running in parallel, when M4 sent from wpa_supplicant arrive while the TX
  queue is stopped, then the M4 will pending send, and then new key install
  from wpa_supplicant. After TX queue wake up by lower layer device driver,
  the M4 will be dropped by below call stack.

  When key install started, the current key flag is set KEY_FLAG_TAINTED in
  ieee80211_pairwise_rekey(), and then mac80211 wait key install complete by
  lower layer device driver. Meanwhile ieee80211_tx_h_select_key() will return
  TX_DROP for the M4 in step 12 below, and then ieee80211_free_txskb() called
  by ieee80211_tx_dequeue(), so the M4 will not send and free, then the rekey
  process failed becaue AP not receive M4. Please see details in steps below.

  There are a interval between KEY_FLAG_TAINTED set for current key flag and
  install key complete by lower layer device driver, the KEY_FLAG_TAINTED is
  set in this interval, all packet including M4 will be dropped in this
  interval, the interval is step 8~13 as below.

  issue steps:
        TX thread                 install key thread
  1.   stop_queue                      -idle-
  2.   sending M4                      -idle-
  3.   M4 pending                      -idle-
  4.     -idle-                  starting install key from wpa_supplicant
  5.     -idle-                  =>ieee80211_key_replace()
  6.     -idle-                  =>ieee80211_pairwise_rekey() and set
                                   currently key->flags |= KEY_FLAG_TAINTED
  7.     -idle-                  =>ieee80211_key_enable_hw_accel()
  8.     -idle-                  =>drv_set_key() and waiting key install
                                   complete from lower layer device driver
  9.   wake_queue                     -waiting state-
  10.  re-sending M4                  -waiting state-
  11.  =>ieee80211_tx_h_select_key()  -waiting state-
  12.  drop M4 by KEY_FLAG_TAINTED    -waiting state-
  13.    -idle-                   install key complete with success/fail
                                    success: clear flag KEY_FLAG_TAINTED
                                    fail: start disconnect

  Hence add check in step 11 above to allow the EAPOL send out in the
  interval. If lower layer device driver use the old key/cipher to encrypt
  the M4, then AP received/decrypt M4 correctly, after M4 send out, lower
  layer device driver install the new key/cipher to hardware and return
  success.

  If lower layer device driver use new key/cipher to send the M4, then AP
  will/should drop the M4, then it is same result with this issue, AP will/
  should kick out station as well as this issue.

  issue log:
  kworker/u16:4-5238  [000]  6456.108926: stop_queue:           phy1 queue:0, reason:0
  wpa_supplicant-961  [003]  6456.119737: rdev_tx_control_port: wiphy_name=phy1 name=wlan0 ifindex=6 dest=ARRAY[9e, 05, 31, 20, 9b, d0] proto=36488 unencrypted=0
  wpa_supplicant-961  [003]  6456.119839: rdev_return_int_cookie: phy1, returned 0, cookie: 504
  wpa_supplicant-961  [003]  6456.120287: rdev_add_key:         phy1, netdev:wlan0(6), key_index: 0, mode: 0, pairwise: true, mac addr: 9e:05:31:20:9b:d0
  wpa_supplicant-961  [003]  6456.120453: drv_set_key:          phy1 vif:wlan0(2) sta:9e:05:31:20:9b:d0 cipher:0xfac04, flags=0x9, keyidx=0, hw_key_idx=0
  kworker/u16:9-3829  [001]  6456.168240: wake_queue:           phy1 queue:0, reason:0
  kworker/u16:9-3829  [001]  6456.168255: drv_wake_tx_queue:    phy1 vif:wlan0(2) sta:9e:05:31:20:9b:d0 ac:0 tid:7
  kworker/u16:9-3829  [001]  6456.168305: cfg80211_control_port_tx_status: wdev(1), cookie: 504, ack: false
  wpa_supplicant-961  [003]  6459.167982: drv_return_int:       phy1 - -110

  issue call stack:
  nl80211_frame_tx_status+0x230/0x340 [cfg80211]
  cfg80211_control_port_tx_status+0x1c/0x28 [cfg80211]
  ieee80211_report_used_skb+0x374/0x3e8 [mac80211]
  ieee80211_free_txskb+0x24/0x40 [mac80211]
  ieee80211_tx_dequeue+0x644/0x954 [mac80211]
  ath10k_mac_tx_push_txq+0xac/0x238 [ath10k_core]
  ath10k_mac_op_wake_tx_queue+0xac/0xe0 [ath10k_core]
  drv_wake_tx_queue+0x80/0x168 [mac80211]
  __ieee80211_wake_txqs+0xe8/0x1c8 [mac80211]
  _ieee80211_wake_txqs+0xb4/0x120 [mac80211]
  ieee80211_wake_txqs+0x48/0x80 [mac80211]
  tasklet_action_common+0xa8/0x254
  tasklet_action+0x2c/0x38
  __do_softirq+0xdc/0x384
- Wifi: cfg80211: Fix 6GHz scan configuration. [Ilan Peer]

  [ Upstream commit 0914468adf92296c4cba8a2134e06e3dea150f2e ]

  When the scan request includes a non broadcast BSSID, when adding the
  scan parameters for 6GHz collocated scanning, do not include entries
  that do not match the given BSSID.
- Bluetooth: hci_core: Fix build warnings. [Luiz Augusto von Dentz]

  [ Upstream commit dcda165706b9fbfd685898d46a6749d7d397e0c0 ]

  This fixes the following warnings:

  net/bluetooth/hci_core.c: In function ‘hci_register_dev’:
  net/bluetooth/hci_core.c:2620:54: warning: ‘%d’ directive output may
  be truncated writing between 1 and 10 bytes into a region of size 5
  [-Wformat-truncation=]
   2620 |         snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
        |                                                      ^~
  net/bluetooth/hci_core.c:2620:50: note: directive argument in the range
  [0, 2147483647]
   2620 |         snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
        |                                                  ^~~~~~~
  net/bluetooth/hci_core.c:2620:9: note: ‘snprintf’ output between 5 and
  14 bytes into a destination of size 8
   2620 |         snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
        |         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Bluetooth: Avoid redundant authentication. [Ying Hsu]

  [ Upstream commit 1d8e801422d66e4b8c7b187c52196bef94eed887 ]

  While executing the Android 13 CTS Verifier Secure Server test on a
  ChromeOS device, it was observed that the Bluetooth host initiates
  authentication for an RFCOMM connection after SSP completes.
  When this happens, some Intel Bluetooth controllers, like AC9560, would
  disconnect with "Connection Rejected due to Security Reasons (0x0e)".

  Historically, BlueZ did not mandate this authentication while an
  authenticated combination key was already in use for the connection.
  This behavior was changed since commit 7b5a9241b780
  ("Bluetooth: Introduce requirements for security level 4").
  So, this patch addresses the aforementioned disconnection issue by
  restoring the previous behavior.
- HID: holtek: fix slab-out-of-bounds Write in holtek_kbd_input_event.
  [Ma Ke]

  [ Upstream commit ffe3b7837a2bb421df84d0177481db9f52c93a71 ]

  There is a slab-out-of-bounds Write bug in hid-holtek-kbd driver.
  The problem is the driver assumes the device must have an input
  but some malicious devices violate this assumption.

  Fix this by checking hid_device's input is non-empty before its usage.
- Tracing: relax trace_event_eval_update() execution with cond_resched()
  [Clément Léger]

  [ Upstream commit 23cce5f25491968b23fb9c399bbfb25f13870cd9 ]

  When kernel is compiled without preemption, the eval_map_work_func()
  (which calls trace_event_eval_update()) will not be preempted up to its
  complete execution. This can actually cause a problem since if another
  CPU call stop_machine(), the call will have to wait for the
  eval_map_work_func() function to finish executing in the workqueue
  before being able to be scheduled. This problem was observe on a SMP
  system at boot time, when the CPU calling the initcalls executed
  clocksource_done_booting() which in the end calls stop_machine(). We
  observed a 1 second delay because one CPU was executing
  eval_map_work_func() and was not preempted by the stop_machine() task.

  Adding a call to cond_resched() in trace_event_eval_update() allows
  other tasks to be executed and thus continue working asynchronously
  like before without blocking any pending task at boot time.
- Ata: libata-eh: Fix compilation warning in ata_eh_link_report()
  [Damien Le Moal]

  [ Upstream commit 49728bdc702391902a473b9393f1620eea32acb0 ]

  The 6 bytes length of the tries_buf string in ata_eh_link_report() is
  too short and results in a gcc compilation warning with W-!:

  drivers/ata/libata-eh.c: In function ‘ata_eh_link_report’:
  drivers/ata/libata-eh.c:2371:59: warning: ‘%d’ directive output may be truncated writing between 1 and 11 bytes into a region of size 4 [-Wformat-truncation=]
   2371 |                 snprintf(tries_buf, sizeof(tries_buf), " t%d",
        |                                                           ^~
  drivers/ata/libata-eh.c:2371:56: note: directive argument in the range [-2147483648, 4]
   2371 |                 snprintf(tries_buf, sizeof(tries_buf), " t%d",
        |                                                        ^~~~~~
  drivers/ata/libata-eh.c:2371:17: note: ‘snprintf’ output between 4 and 14 bytes into a destination of size 6
   2371 |                 snprintf(tries_buf, sizeof(tries_buf), " t%d",
        |                 ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   2372 |                          ap->eh_tries);
        |                          ~~~~~~~~~~~~~

  Avoid this warning by increasing the string size to 16B.
- Gpio: timberdale: Fix potential deadlock on &tgpio->lock. [Chengfeng
  Ye]

  [ Upstream commit 9e8bc2dda5a7a8e2babc9975f4b11c9a6196e490 ]

  As timbgpio_irq_enable()/timbgpio_irq_disable() callback could be
  executed under irq context, it could introduce double locks on
  &tgpio->lock if it preempts other execution units requiring
  the same locks.

  timbgpio_gpio_set()
  --> timbgpio_update_bit()
  --> spin_lock(&tgpio->lock)
  <interrupt>
     --> timbgpio_irq_disable()
     --> spin_lock_irqsave(&tgpio->lock)

  This flaw was found by an experimental static analysis tool I am
  developing for irq-related deadlock.

  To prevent the potential deadlock, the patch uses spin_lock_irqsave()
  on &tgpio->lock inside timbgpio_gpio_set() to prevent the possible
  deadlock scenario.
- Overlayfs: set ctime when setting mtime and atime. [Jeff Layton]

  [ Upstream commit 03dbab3bba5f009d053635c729d1244f2c8bad38 ]

  Nathan reported that he was seeing the new warning in
  setattr_copy_mgtime pop when starting podman containers. Overlayfs is
  trying to set the atime and mtime via notify_change without also
  setting the ctime.

  POSIX states that when the atime and mtime are updated via utimes() that
  we must also update the ctime to the current time. The situation with
  overlayfs copy-up is analogies, so add ATTR_CTIME to the bitmask.
  notify_change will fill in the value.
- I2c: mux: Avoid potential false error message in i2c_mux_add_adapter.
  [Heiner Kallweit]

  [ Upstream commit b13e59e74ff71a1004e0508107e91e9a84fd7388 ]

  I2C_CLASS_DEPRECATED is a flag and not an actual class.
  There's nothing speaking against both, parent and child, having
  I2C_CLASS_DEPRECATED set. Therefore exclude it from the check.
- Btrfs: initialize start_slot in btrfs_log_prealloc_extents. [Josef
  Bacik]

  [ Upstream commit b4c639f699349880b7918b861e1bd360442ec450 ]

  Jens reported a compiler warning when using
  CONFIG_CC_OPTIMIZE_FOR_SIZE=y that looks like this

    fs/btrfs/tree-log.c: In function ‘btrfs_log_prealloc_extents’:
    fs/btrfs/tree-log.c:4828:23: warning: ‘start_slot’ may be used
    uninitialized [-Wmaybe-uninitialized]
     4828 |                 ret = copy_items(trans, inode, dst_path, path,
  	|                       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     4829 |                                  start_slot, ins_nr, 1, 0);
  	|                                  ~~~~~~~~~~~~~~~~~~~~~~~~~
    fs/btrfs/tree-log.c:4725:13: note: ‘start_slot’ was declared here
     4725 |         int start_slot;
  	|             ^~~~~~~~~~

  The compiler is incorrect, as we only use this code when ins_len > 0,
  and when ins_len > 0 we have start_slot properly initialized.  However
  we generally find the -Wmaybe-uninitialized warnings valuable, so
  initialize start_slot to get rid of the warning.
- Btrfs: return -EUCLEAN for delayed tree ref with a ref count not
  equals to 1. [Filipe Manana]

  [ Upstream commit 1bf76df3fee56d6637718e267f7c34ed70d0c7dc ]

  When running a delayed tree reference, if we find a ref count different
  from 1, we return -EIO. This isn't an IO error, as it indicates either a
  bug in the delayed refs code or a memory corruption, so change the error
  code from -EIO to -EUCLEAN. Also tag the branch as 'unlikely' as this is
  not expected to ever happen, and change the error message to print the
  tree block's bytenr without the parenthesis (and there was a missing space
  between the 'block' word and the opening parenthesis), for consistency as
  that's the style we used everywhere else.
- ARM: dts: ti: omap: Fix noisy serial with overrun-throttle-ms for
  mapphone. [Tony Lindgren]

  [ Upstream commit 5ad37b5e30433afa7a5513e3eb61f69fa0976785 ]

  On mapphone devices we may get lots of noise on the micro-USB port in debug
  uart mode until the phy-cpcap-usb driver probes. Let's limit the noise by
  using overrun-throttle-ms.

  Note that there is also a related separate issue where the charger cable
  connected may cause random sysrq requests until phy-cpcap-usb probes that
  still remains.
- Usb: typec: altmodes/displayport: Signal hpd low when exiting mode.
  [RD Babiera]

  [ Upstream commit 89434b069e460967624903b049e5cf5c9e6b99b9 ]

  Upon receiving an ACK for a sent EXIT_MODE message, the DisplayPort
  driver currently resets the status and configuration of the port partner.
  The hpd signal is not updated despite being part of the status, so the
  Display stack can still transmit video despite typec_altmode_exit placing
  the lanes in a Safe State.

  Set hpd to low when a sent EXIT_MODE message is ACK'ed.
- Usb: typec: altmodes/displayport: Notify drm subsys of hotplug events.
  [Hans de Goede]

  [ Upstream commit 7f811394878535ed9a6849717de8c2959ae38899 ]

  Use the new drm_connector_oob_hotplug_event() functions to let drm/kms
  drivers know about DisplayPort over Type-C hotplug events.
- Drm/connector: Add support for out-of-band hotplug notification (v3)
  [Hans de Goede]

  [ Upstream commit 72ad49682dde3d9de5708b8699dc8e0b44962322 ]

  Add a new drm_connector_oob_hotplug_event() function and
  oob_hotplug_event drm_connector_funcs member.

  On some hardware a hotplug event notification may come from outside the
  display driver / device. An example of this is some USB Type-C setups
  where the hardware muxes the DisplayPort data and aux-lines but does
  not pass the altmode HPD status bit to the GPU's DP HPD pin.

  In cases like this the new drm_connector_oob_hotplug_event() function can
  be used to report these out-of-band events.

  Changes in v2:
  - Make drm_connector_oob_hotplug_event() take a fwnode as argument and
    have it call drm_connector_find_by_fwnode() internally. This allows
    making drm_connector_find_by_fwnode() a drm-internal function and
    avoids code outside the drm subsystem potentially holding on the
    a drm_connector reference for a longer period.

  Changes in v3:
  - Drop the data argument to the drm_connector_oob_hotplug_event
    function since it is not used atm. This can be re-added later when
    a use for it actually arises.
- Drm/connector: Add drm_connector_find_by_fwnode() function (v3) [Hans
  de Goede]

  [ Upstream commit 3d3f7c1e68691574c1d87cd0f9f2348323bc0199 ]

  Add a function to find a connector based on a fwnode.

  This will be used by the new drm_connector_oob_hotplug_event()
  function which is added by the next patch in this patch-set.

  Changes in v2:
  - Complete rewrite to use a global connector list in drm_connector.c
    rather then using a class-dev-iter in drm_sysfs.c

  Changes in v3:
  - Add forward declaration for struct fwnode_handle to drm_crtc_internal.h
    (fixes warning reported by kernel test robot <lkp@intel.com>)
- Drm/connector: Add a fwnode pointer to drm_connector and register with
  ACPI (v2) [Hans de Goede]

  [ Upstream commit 48c429c6d18db115c277b75000152d8fa4cd35d0 ]

  Add a fwnode pointer to struct drm_connector and register an acpi_bus_type
  for the connectors with the ACPI subsystem (when CONFIG_ACPI is enabled).

  The adding of the fwnode pointer allows drivers to associate a fwnode
  that represents a connector with that connector.

  When the new fwnode pointer points to an ACPI-companion, then the new
  acpi_bus_type will cause the ACPI subsys to bind the device instantiated
  for the connector with the fwnode by calling acpi_bind_one(). This will
  result in a firmware_node symlink under /sys/class/card#-<connecter-name>/
  which helps to verify that the fwnode-s and connectors are properly
  matched.

  Changes in v2:
  - Make drm_connector_cleanup() call fwnode_handle_put() on
    connector->fwnode and document this
- Drm/connector: Give connector sysfs devices there own device_type.
  [Hans de Goede]

  [ Upstream commit 331de7db3012b8e8e8d77beebc8f743e288d4c42 ]

  Give connector sysfs devices there own device_type, this allows us to
  check if a device passed to functions dealing with generic devices is
  a drm_connector or not.

  A check like this is necessary in the drm_connector_acpi_bus_match()
  function added in the next patch in this series.
- Drm/amd/display: Don't set dpms_off for seamless boot. [Daniel Miess]

  [ Upstream commit 23645bca98304a2772f0de96f97370dd567d0ae6 ]

  [Why]
  eDPs fail to light up with seamless boot enabled

  [How]
  When seamless boot is enabled don't configure dpms_off
  in disable_vbios_mode_if_required.
- Drm/amd/display: only check available pipe to disable vbios mode.
  [Yongqiang Sun]

  [ Upstream commit 850d2fcf3e346a35e4e59e310b867e90e3ef8e5a ]

  [Why & How]
  1. only need to check first ODM pipe.
  2. Only need to check eDP which is on.
- Serial: 8250_omap: Fix errors with no_console_suspend. [Tony Lindgren]

  [ Upstream commit 560706eff7c8e5621b0d63afe0866e0e1906e87e ]

  We now get errors on system suspend if no_console_suspend is set as
  reported by Thomas. The errors started with commit 20a41a62618d ("serial:
  8250_omap: Use force_suspend and resume for system suspend").

  Let's fix the issue by checking for console_suspend_enabled in the system
  suspend and resume path.

  Note that with this fix the checks for console_suspend_enabled in
  omap8250_runtime_suspend() become useless. We now keep runtime PM usage
  count for an attached kernel console starting with commit bedb404e91bb
  ("serial: 8250_port: Don't use power management for kernel console").
- Serial: 8250: omap: Fix imprecise external abort for omap_8250_pm()
  [Tony Lindgren]

  [ Upstream commit 398cecc24846e867b9f90a0bd22730e3df6b05be ]

  We must idle the uart only after serial8250_unregister_port(). Otherwise
  unbinding the uart via sysfs while doing cat on the port produces an
  imprecise external abort:

  mem_serial_in from omap_8250_pm+0x44/0xf4
  omap_8250_pm from uart_hangup+0xe0/0x194
  uart_hangup from __tty_hangup.part.0+0x37c/0x3a8
  __tty_hangup.part.0 from uart_remove_one_port+0x9c/0x22c
  uart_remove_one_port from serial8250_unregister_port+0x60/0xe8
  serial8250_unregister_port from omap8250_remove+0x6c/0xd0
  omap8250_remove from platform_remove+0x28/0x54

  Turns out the driver needs to have runtime PM functional before the
  driver probe calls serial8250_register_8250_port(). And it needs
  runtime PM after driver remove calls serial8250_unregister_port().

  On probe, we need to read registers before registering the port in
  omap_serial_fill_features_erratas(). We do that with custom uart_read()
  already.

  On remove, after serial8250_unregister_port(), we need to write to the
  uart registers to idle the device. Let's add a custom uart_write() for
  that.

  Currently the uart register access depends on port->membase to be
  initialized, which won't work after serial8250_unregister_port().
  Let's use priv->membase instead, and use it for runtime PM related
  functions to remove the dependency to port->membase for early and
  late register access.

  Note that during use, we need to check for a valid port in the runtime PM
  related functions. This is needed for the optional wakeup configuration.
  We now need to set the drvdata a bit earlier so it's available for the
  runtime PM functions.

  With the port checks in runtime PM functions, the old checks for priv in
  omap8250_runtime_suspend() and omap8250_runtime_resume() functions are no
  longer needed and are removed.
- Xhci: track port suspend state correctly in unsuccessful resume cases.
  [Mathias Nyman]

  [ Upstream commit d7cdfc319b2bcf6899ab0a05eec0958bc802a9a1 ]

  xhci-hub.c tracks suspended ports in a suspended_port bitfield.
  This is checked when responding to a Get_Status(PORT) request to see if a
  port in running U0 state was recently resumed, and adds the required
  USB_PORT_STAT_C_SUSPEND change bit in those cases.

  The suspended_port bit was left uncleared if a device is disconnected
  during suspend. The bit remained set even when a new device was connected
  and enumerated. The set bit resulted in a incorrect Get_Status(PORT)
  response with a bogus USB_PORT_STAT_C_SUSPEND change
  bit set once the new device reached U0 link state.

  USB_PORT_STAT_C_SUSPEND change bit is only used for USB2 ports, but
  xhci-hub keeps track of both USB2 and USB3 suspended ports.
- Xhci: decouple usb2 port resume and get_port_status request handling.
  [Mathias Nyman]

  [ Upstream commit b0425784b942fffbbdb804896197f1dbccda37c5 ]

  The get port status hub request code in xhci-hub.c will complete usb2
  port resume signalling if signalling has been going on for long enough.

  The code that completes the resume signalling, and the code that returns
  the port status have gotten too intertwined, so separate them a bit.
- Xhci: clear usb2 resume related variables in one place. [Mathias
  Nyman]

  [ Upstream commit 0e6275452ce26d7ff274a5c1b15ed581a26f7986 ]

  Initially resume related USB2 variables were cleared once port
  successfully resumed to U0. Later code was added to clean up
  stale resume variables in case of port failed to resume to U0.

  Clear the variables in one place after port is no longer resuming
  or in suspended U3 state.
- Xhci: rename resume_done to resume_timestamp. [Mathias Nyman]

  [ Upstream commit a909d629ae77b97b6288bc3cfe68560454bf79c6 ]

  resume_done is just a timestamp, avoid confusing it with completions
  related to port state transitions that are named *_done
- Xhci: move port specific items such as state completions to port
  structure. [Mathias Nyman]

  [ Upstream commit 2996e9fc00c378987c18ecbafe5624581b18c0d6 ]

  Now that we have a port structure for each port it makes sense to
  move per port variables, timestamps and completions there.
  Get rid of storing bitfileds and arrays of port specific items per bus.

  Move
  unsigned long           resume_done;
  insigned long		rexit_ports
  struct completion       rexit_done;
  struct completion       u3exit_done;

  Rename rexit_ports to rexit_active, and remove a redundant hcd
  speed check while checking if rexit_active is set.
- Xhci: cleanup xhci_hub_control port references. [Mathias Nyman]

  [ Upstream commit faaae0190dcd1e230616c85bbc3b339f27ba5b81 ]

  Both port number and port structure of a port are referred to several
  times when handing hub requests in xhci.

  Use more suitable data types and readable names for these.
  Cleanup only, no functional changes
- Usb: core: Track SuperSpeed Plus GenXxY. [Thinh Nguyen]

  [ Upstream commit 0299809be415567366b66f248eed93848b8dc9f3 ]

  Introduce ssp_rate field to usb_device structure to capture the
  connected SuperSpeed Plus signaling rate generation and lane count with
  the corresponding usb_ssp_rate enum.
- Selftests/mm: fix awk usage in charge_reserved_hugetlb.sh and
  hugetlb_reparenting_test.sh that may cause error. [Juntong Deng]

  [ Upstream commit bbe246f875d064ecfb872fe4f66152e743dfd22d ]

  According to the awk manual, the -e option does not need to be specified
  in front of 'program' (unless you need to mix program-file).

  The redundant -e option can cause error when users use awk tools other
  than gawk (for example, mawk does not support the -e option).

  Error Example:
  awk: not an option: -e
- Selftests/vm: make charge_reserved_hugetlb.sh work with existing
  cgroup setting. [Waiman Long]

  [ Upstream commit 209376ed2a8431ccb4c40fdcef11194fc1e749b0 ]

  The hugetlb cgroup reservation test charge_reserved_hugetlb.sh assume
  that no cgroup filesystems are mounted before running the test.  That is
  not true in many cases.  As a result, the test fails to run.  Fix that
  by querying the current cgroup mount setting and using the existing
  cgroup setup instead before attempting to freshly mount a cgroup
  filesystem.

  Similar change is also made for hugetlb_reparenting_test.sh as well,
  though it still has problem if cgroup v2 isn't used.

  The patched test scripts were run on a centos 8 based system to verify
  that they ran properly.
- ACPI: resource: Skip IRQ override on ASUS ExpertBook B1402CBA. [Hans
  de Goede]

  [ Upstream commit c1ed72171ed580fbf159e703b77685aa4b0d0df5 ]

  Like various other ASUS ExpertBook-s, the ASUS ExpertBook B1402CBA
  has an ACPI DSDT table that describes IRQ 1 as ActiveLow while
  the kernel overrides it to EdgeHigh.

  This prevents the keyboard from working. To fix this issue, add this laptop
  to the skip_override_table so that the kernel does not override IRQ 1.
- ACPI: resource: Skip IRQ override on ASUS ExpertBook B1502CBA. [Paul
  Menzel]

  [ Upstream commit 05cda427126f30ce3fc8ffd82fd6f5196398d502 ]

  Like the ASUS ExpertBook B2502CBA and various ASUS Vivobook laptops, the
  ASUS ExpertBook B1502CBA has an ACPI DSDT table that describes IRQ 1 as
  ActiveLow while the kernel overrides it to Edge_High.

      $ sudo dmesg | grep DMI
      DMI: ASUSTeK COMPUTER INC. ASUS EXPERTBOOK B1502CBA_B1502CBA/B1502CBA, BIOS B1502CBA.300 01/18/2023
      $ grep -A 40 PS2K dsdt.dsl | grep IRQ -A 1
                      IRQ (Level, ActiveLow, Exclusive, )
                          {1}

  This prevents the keyboard from working. To fix this issue, add this laptop
  to the skip_override_table so that the kernel does not override IRQ 1.
- ACPI: resource: Skip IRQ override on Asus Expertbook B2402CBA. [Tamim
  Khan]

  [ Upstream commit 77c7248882385397cd7dffe9e1437f59f32ce2de ]

  Like the Asus Expertbook B2502CBA and various Asus Vivobook laptops,
  the Asus Expertbook B2402CBA has an ACPI DSDT table that describes IRQ 1
  as ActiveLow while the kernel overrides it to Edge_High. This prevents the
  keyboard from working. To fix this issue, add this laptop to the
  skip_override_table so that the kernel does not override IRQ 1.
- ACPI: resource: Add Asus ExpertBook B2502 to Asus quirks. [Hans de
  Goede]

  [ Upstream commit 7203481fd12b1257938519efb2460ea02b9236ee ]

  The Asus ExpertBook B2502 has the same keyboard issue as Asus Vivobook
  K3402ZA/K3502ZA. The kernel overrides IRQ 1 to Edge_High when it
  should be Active_Low.

  This patch adds the ExpertBook B2502 model to the existing
  quirk list of Asus laptops with this issue.
- ACPI: resource: Skip IRQ override on Asus Vivobook S5602ZA. [Tamim
  Khan]

  [ Upstream commit b5f9223a105d9b56954ad1ca3eace4eaf26c99ed ]

  Like the Asus Vivobook K3402ZA/K3502ZA/S5402ZA Asus Vivobook S5602ZA
  has an ACPI DSDT table the describes IRQ 1 as ActiveLow while the kernel
  overrides it to Edge_High. This prevents the keyboard on this laptop
  from working. To fix this add this laptop to the skip_override_table so
  that the kernel does not override IRQ 1.
- ACPI: resource: Add ASUS model S5402ZA to quirks. [Kellen Renshaw]

  [ Upstream commit 6e5cbe7c4b41824e500acbb42411da692d1435f1 ]

  The Asus Vivobook S5402ZA has the same keyboard issue as Asus Vivobook
  K3402ZA/K3502ZA. The kernel overrides IRQ 1 to Edge_High when it
  should be Active_Low.

  This patch adds the S5402ZA model to the quirk list.
- ACPI: resource: Skip IRQ override on Asus Vivobook K3402ZA/K3502ZA.
  [Tamim Khan]

  [ Upstream commit e12dee3736731e24b1e7367f87d66ac0fcd73ce7 ]

  In the ACPI DSDT table for Asus VivoBook K3402ZA/K3502ZA
  IRQ 1 is described as ActiveLow; however, the kernel overrides
  it to Edge_High. This prevents the internal keyboard from working
  on these laptops. In order to fix this add these laptops to the
  skip_override_table so that the kernel does not override IRQ 1 to
  Edge_High.
- ACPI: resources: Add DMI-based legacy IRQ override quirk. [Hui Wang]

  [ Upstream commit 892a012699fc0b91a2ed6309078936191447f480 ]

  After the commit 0ec4e55e9f57 ("ACPI: resources: Add checks for ACPI
  IRQ override") is reverted, the keyboard on Medion laptops can't
  work again.

  To fix the keyboard issue, add a DMI-based override check that will
  not affect other machines along the lines of prt_quirks[] in
  drivers/acpi/pci_irq.c.

  If similar issues are seen on other platforms, the quirk table could
  be expanded in the future.

  BugLink: https://bugzilla.kernel.org/show_bug.cgi?id=213031
  BugLink: http://bugs.launchpad.net/bugs/1909814
  Suggested-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
  Reported-by: Manuel Krause <manuelkrause@netscape.net>
  Tested-by: Manuel Krause <manuelkrause@netscape.net>
  Signed-off-by: Hui Wang <hui.wang@canonical.com>
  [ rjw: Subject and changelog edits ]
- ACPI: Drop acpi_dev_irqresource_disabled() [John Garry]

  [ Upstream commit 1c3f69b4543af0aad514c127298e5ea40392575d ]

  The functionality of acpi_dev_irqresource_disabled() is same as in common
  irqresource_disabled(), so drop acpi_dev_irqresource_disabled() in favour
  of that function.
- Resource: Add irqresource_disabled() [John Garry]

  [ Upstream commit 9806731db684a475ade1e95d166089b9edbd9da3 ]

  Add a common function to set the fields for a irq resource to disabled,
  which mimics what is done in acpi_dev_irqresource_disabled(), with a view
  to replace that function.
- Thunderbolt: Workaround an IOMMU fault on certain systems with Intel
  Maple Ridge. [Mika Westerberg]

  [ Upstream commit 582620d9f6b352552bc9a3316fe2b1c3acd8742d ]

  On some systems the IOMMU blocks the first couple of driver ready
  messages to the connection manager firmware as can be seen in below
  excerpts:

    thunderbolt 0000:06:00.0: AMD-Vi: Event logged [IO_PAGE_FAULT domain=0x0010 address=0xbb0e3400 flags=0x0020]

  or

    DMAR: DRHD: handling fault status reg 2
    DMAR: [DMA Write] Request device [04:00.0] PASID ffffffff fault addr 69974000 [fault reason 05] PTE Write access is not set

  The reason is unknown and hard to debug because we were not able to
  reproduce this locally. This only happens on certain systems with Intel
  Maple Ridge Thunderbolt controller. If there is a device connected when
  the driver is loaded the issue does not happen either. Only when there
  is nothing connected (so typically when the system is booted up).

  We can work this around by sending the driver ready several times. After
  a couple of retries the message goes through and the controller works
  just fine. For this reason make the number of retries a parameter for
  icm_request() and then for Maple Ridge (and Titan Ridge as they us the
  same function but this should not matter) increase number of retries
  while shortening the timeout accordingly.
- Net: pktgen: Fix interface flags printing. [Gavrilov Ilia]

  commit 1d30162f35c7a73fc2f8cdcdcdbd690bedb99d1a upstream.

  Device flags are displayed incorrectly:
  1) The comparison (i == F_FLOW_SEQ) is always false, because F_FLOW_SEQ
  is equal to (1 << FLOW_SEQ_SHIFT) == 2048, and the maximum value
  of the 'i' variable is (NR_PKT_FLAG - 1) == 17. It should be compared
  with FLOW_SEQ_SHIFT.

  2) Similarly to the F_IPSEC flag.

  3) Also add spaces to the print end of the string literal "spi:%u"
  to prevent the output from merging with the flag that follows.

  Found by InfoTeCS on behalf of Linux Verification Center
  (linuxtesting.org) with SVACE.
- Netfilter: nft_set_rbtree: .deactivate fails if element has expired.
  [Pablo Neira Ayuso]

  commit d111692a59c1470ae530cbb39bcf0346c950ecc7 upstream.

  This allows to remove an expired element which is not possible in other
  existing set backends, this is more noticeable if gc-interval is high so
  expired elements remain in the tree. On-demand gc also does not help in
  this case, because this is delete element path. Return NULL if element
  has expired.
- Neighbor: tracing: Move pin6 inside CONFIG_IPV6=y section. [Geert
  Uytterhoeven]

  commit 2915240eddba96b37de4c7e9a3d0ac6f9548454b upstream.

  When CONFIG_IPV6=n, and building with W=1:

      In file included from include/trace/define_trace.h:102,
  		     from include/trace/events/neigh.h:255,
  		     from net/core/net-traces.c:51:
      include/trace/events/neigh.h: In function ‘trace_event_raw_event_neigh_create’:
      include/trace/events/neigh.h:42:34: error: variable ‘pin6’ set but not used [-Werror=unused-but-set-variable]
         42 |                 struct in6_addr *pin6;
  	  |                                  ^~~~
      include/trace/trace_events.h:402:11: note: in definition of macro ‘DECLARE_EVENT_CLASS’
        402 |         { assign; }                                                     \
  	  |           ^~~~~~
      include/trace/trace_events.h:44:30: note: in expansion of macro ‘PARAMS’
         44 |                              PARAMS(assign),                   \
  	  |                              ^~~~~~
      include/trace/events/neigh.h:23:1: note: in expansion of macro ‘TRACE_EVENT’
         23 | TRACE_EVENT(neigh_create,
  	  | ^~~~~~~~~~~
      include/trace/events/neigh.h:41:9: note: in expansion of macro ‘TP_fast_assign’
         41 |         TP_fast_assign(
  	  |         ^~~~~~~~~~~~~~
      In file included from include/trace/define_trace.h:103,
  		     from include/trace/events/neigh.h:255,
  		     from net/core/net-traces.c:51:
      include/trace/events/neigh.h: In function ‘perf_trace_neigh_create’:
      include/trace/events/neigh.h:42:34: error: variable ‘pin6’ set but not used [-Werror=unused-but-set-variable]
         42 |                 struct in6_addr *pin6;
  	  |                                  ^~~~
      include/trace/perf.h:51:11: note: in definition of macro ‘DECLARE_EVENT_CLASS’
         51 |         { assign; }                                                     \
  	  |           ^~~~~~
      include/trace/trace_events.h:44:30: note: in expansion of macro ‘PARAMS’
         44 |                              PARAMS(assign),                   \
  	  |                              ^~~~~~
      include/trace/events/neigh.h:23:1: note: in expansion of macro ‘TRACE_EVENT’
         23 | TRACE_EVENT(neigh_create,
  	  | ^~~~~~~~~~~
      include/trace/events/neigh.h:41:9: note: in expansion of macro ‘TP_fast_assign’
         41 |         TP_fast_assign(
  	  |         ^~~~~~~~~~~~~~

  Indeed, the variable pin6 is declared and initialized unconditionally,
  while it is only used and needlessly re-initialized when support for
  IPv6 is enabled.

  Fix this by dropping the unused variable initialization, and moving the
  variable declaration inside the existing section protected by a check
  for CONFIG_IPV6.
- Net/sched: sch_hfsc: upgrade 'rt' to 'sc' when it becomes a inner
  curve. [Pedro Tammela]

  commit a13b67c9a015c4e21601ef9aa4ec9c5d972df1b4 upstream.

  Christian Theune says:
     I upgraded from 6.1.38 to 6.1.55 this morning and it broke my traffic shaping script,
     leaving me with a non-functional uplink on a remote router.

  A 'rt' curve cannot be used as a inner curve (parent class), but we were
  allowing such configurations since the qdisc was introduced. Such
  configurations would trigger a UAF as Budimir explains:
     The parent will have vttree_insert() called on it in init_vf(),
     but will not have vttree_remove() called on it in update_vf()
     because it does not have the HFSC_FSC flag set.

  The qdisc always assumes that inner classes have the HFSC_FSC flag set.
  This is by design as it doesn't make sense 'qdisc wise' for an 'rt'
  curve to be an inner curve.

  Budimir's original patch disallows users to add classes with a 'rt'
  parent, but this is too strict as it breaks users that have been using
  'rt' as a inner class. Another approach, taken by this patch, is to
  upgrade the inner 'rt' into a 'sc', warning the user in the process.
  It avoids the UAF reported by Budimir while also being more permissive
  to bad scripts/users/code using 'rt' as a inner class.

  Users checking the `tc class ls [...]` or `tc class get [...]` dumps would
  observe the curve change and are potentially breaking with this change.

  v1->v2: https://lore.kernel.org/all/20231013151057.2611860-1-pctammela@mojatatu.com/
  - Correct 'Fixes' tag and merge with revert (Jakub)
- Net: dsa: bcm_sf2: Fix possible memory leak in bcm_sf2_mdio_register()
  [Jinjie Ruan]

  commit 61b40cefe51af005c72dbdcf975a3d166c6e6406 upstream.

  In bcm_sf2_mdio_register(), the class_find_device() will call get_device()
  to increment reference count for priv->master_mii_bus->dev if
  of_mdio_find_bus() succeeds. If mdiobus_alloc() or mdiobus_register()
  fails, it will call get_device() twice without decrement reference count
  for the device. And it is the same if bcm_sf2_mdio_register() succeeds but
  fails in bcm_sf2_sw_probe(), or if bcm_sf2_sw_probe() succeeds. If the
  reference count has not decremented to zero, the dev related resource will
  not be freed.

  So remove the get_device() in bcm_sf2_mdio_register(), and call
  put_device() if mdiobus_alloc() or mdiobus_register() fails and in
  bcm_sf2_mdio_unregister() to solve the issue.

  And as Simon suggested, unwind from errors for bcm_sf2_mdio_register() and
  just return 0 if it succeeds to make it cleaner.
- I40e: prevent crash on probe if hw registers have invalid values.
  [Michal Schmidt]

  commit fc6f716a5069180c40a8c9b63631e97da34f64a3 upstream.

  The hardware provides the indexes of the first and the last available
  queue and VF. From the indexes, the driver calculates the numbers of
  queues and VFs. In theory, a faulty device might say the last index is
  smaller than the first index. In that case, the driver's calculation
  would underflow, it would attempt to write to non-existent registers
  outside of the ioremapped range and crash.

  I ran into this not by having a faulty device, but by an operator error.
  I accidentally ran a QE test meant for i40e devices on an ice device.
  The test used 'echo i40e > /sys/...ice PCI device.../driver_override',
  bound the driver to the device and crashed in one of the wr32 calls in
  i40e_clear_hw.

  Add checks to prevent underflows in the calculations of num_queues and
  num_vfs. With this fix, the wrong device probing reports errors and
  returns a failure without crashing.
- Net: usb: smsc95xx: Fix an error code in smsc95xx_reset() [Dan
  Carpenter]

  commit c53647a5df9e66dd9fedf240198e1fe50d88c286 upstream.

  Return a negative error code instead of success.
- Ipv4: fib: annotate races around nh->nh_saddr_genid and nh->nh_saddr.
  [Eric Dumazet]

  commit 195374d893681da43a39796e53b30ac4f20400c4 upstream.

  syzbot reported a data-race while accessing nh->nh_saddr_genid [1]

  Add annotations, but leave the code lazy as intended.

  [1]
  BUG: KCSAN: data-race in fib_select_path / fib_select_path

  write to 0xffff8881387166f0 of 4 bytes by task 6778 on cpu 1:
  fib_info_update_nhc_saddr net/ipv4/fib_semantics.c:1334 [inline]
  fib_result_prefsrc net/ipv4/fib_semantics.c:1354 [inline]
  fib_select_path+0x292/0x330 net/ipv4/fib_semantics.c:2269
  ip_route_output_key_hash_rcu+0x659/0x12c0 net/ipv4/route.c:2810
  ip_route_output_key_hash net/ipv4/route.c:2644 [inline]
  __ip_route_output_key include/net/route.h:134 [inline]
  ip_route_output_flow+0xa6/0x150 net/ipv4/route.c:2872
  send4+0x1f5/0x520 drivers/net/wireguard/socket.c:61
  wg_socket_send_skb_to_peer+0x94/0x130 drivers/net/wireguard/socket.c:175
  wg_socket_send_buffer_to_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
  wg_packet_send_handshake_initiation drivers/net/wireguard/send.c:40 [inline]
  wg_packet_handshake_send_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
  process_one_work kernel/workqueue.c:2630 [inline]
  process_scheduled_works+0x5b8/0xa30 kernel/workqueue.c:2703
  worker_thread+0x525/0x730 kernel/workqueue.c:2784
  kthread+0x1d7/0x210 kernel/kthread.c:388
  ret_from_fork+0x48/0x60 arch/x86/kernel/process.c:147
  ret_from_fork_asm+0x11/0x20 arch/x86/entry/entry_64.S:304

  read to 0xffff8881387166f0 of 4 bytes by task 6759 on cpu 0:
  fib_result_prefsrc net/ipv4/fib_semantics.c:1350 [inline]
  fib_select_path+0x1cb/0x330 net/ipv4/fib_semantics.c:2269
  ip_route_output_key_hash_rcu+0x659/0x12c0 net/ipv4/route.c:2810
  ip_route_output_key_hash net/ipv4/route.c:2644 [inline]
  __ip_route_output_key include/net/route.h:134 [inline]
  ip_route_output_flow+0xa6/0x150 net/ipv4/route.c:2872
  send4+0x1f5/0x520 drivers/net/wireguard/socket.c:61
  wg_socket_send_skb_to_peer+0x94/0x130 drivers/net/wireguard/socket.c:175
  wg_socket_send_buffer_to_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
  wg_packet_send_handshake_initiation drivers/net/wireguard/send.c:40 [inline]
  wg_packet_handshake_send_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
  process_one_work kernel/workqueue.c:2630 [inline]
  process_scheduled_works+0x5b8/0xa30 kernel/workqueue.c:2703
  worker_thread+0x525/0x730 kernel/workqueue.c:2784
  kthread+0x1d7/0x210 kernel/kthread.c:388
  ret_from_fork+0x48/0x60 arch/x86/kernel/process.c:147
  ret_from_fork_asm+0x11/0x20 arch/x86/entry/entry_64.S:304

  value changed: 0x959d3217 -> 0x959d3218

  Reported by Kernel Concurrency Sanitizer on:
  CPU: 0 PID: 6759 Comm: kworker/u4:15 Not tainted 6.6.0-rc4-syzkaller-00029-gcbf3a2cb156a #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/06/2023
- Tun: prevent negative ifindex. [Eric Dumazet]

  commit cbfbfe3aee718dc4c3c837f5d2463170ee59d78c upstream.

  After commit 956db0a13b47 ("net: warn about attempts to register
  negative ifindex") syzbot is able to trigger the following splat.

  Negative ifindex are not supported.

  WARNING: CPU: 1 PID: 6003 at net/core/dev.c:9596 dev_index_reserve+0x104/0x210
  Modules linked in:
  CPU: 1 PID: 6003 Comm: syz-executor926 Not tainted 6.6.0-rc4-syzkaller-g19af4a4ed414 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/06/2023
  pstate: 80400005 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  pc : dev_index_reserve+0x104/0x210
  lr : dev_index_reserve+0x100/0x210
  sp : ffff800096a878e0
  x29: ffff800096a87930 x28: ffff0000d04380d0 x27: ffff0000d04380f8
  x26: ffff0000d04380f0 x25: 1ffff00012d50f20 x24: 1ffff00012d50f1c
  x23: dfff800000000000 x22: ffff8000929c21c0 x21: 00000000ffffffea
  x20: ffff0000d04380e0 x19: ffff800096a87900 x18: ffff800096a874c0
  x17: ffff800084df5008 x16: ffff80008051f9c4 x15: 0000000000000001
  x14: 1fffe0001a087198 x13: 0000000000000000 x12: 0000000000000000
  x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
  x8 : ffff0000d41c9bc0 x7 : 0000000000000000 x6 : 0000000000000000
  x5 : ffff800091763d88 x4 : 0000000000000000 x3 : ffff800084e04748
  x2 : 0000000000000001 x1 : 00000000fead71c7 x0 : 0000000000000000
  Call trace:
  dev_index_reserve+0x104/0x210
  register_netdevice+0x598/0x1074 net/core/dev.c:10084
  tun_set_iff+0x630/0xb0c drivers/net/tun.c:2850
  __tun_chr_ioctl+0x788/0x2af8 drivers/net/tun.c:3118
  tun_chr_ioctl+0x38/0x4c drivers/net/tun.c:3403
  vfs_ioctl fs/ioctl.c:51 [inline]
  __do_sys_ioctl fs/ioctl.c:871 [inline]
  __se_sys_ioctl fs/ioctl.c:857 [inline]
  __arm64_sys_ioctl+0x14c/0x1c8 fs/ioctl.c:857
  __invoke_syscall arch/arm64/kernel/syscall.c:37 [inline]
  invoke_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:51
  el0_svc_common+0x130/0x23c arch/arm64/kernel/syscall.c:136
  do_el0_svc+0x48/0x58 arch/arm64/kernel/syscall.c:155
  el0_svc+0x58/0x16c arch/arm64/kernel/entry-common.c:678
  el0t_64_sync_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:696
  el0t_64_sync+0x190/0x194 arch/arm64/kernel/entry.S:595
  irq event stamp: 11348
  hardirqs last enabled at (11347): [<ffff80008a716574>] __raw_spin_unlock_irqrestore include/linux/spinlock_api_smp.h:151 [inline]
  hardirqs last enabled at (11347): [<ffff80008a716574>] _raw_spin_unlock_irqrestore+0x38/0x98 kernel/locking/spinlock.c:194
  hardirqs last disabled at (11348): [<ffff80008a627820>] el1_dbg+0x24/0x80 arch/arm64/kernel/entry-common.c:436
  softirqs last enabled at (11138): [<ffff8000887ca53c>] spin_unlock_bh include/linux/spinlock.h:396 [inline]
  softirqs last enabled at (11138): [<ffff8000887ca53c>] release_sock+0x15c/0x1b0 net/core/sock.c:3531
  softirqs last disabled at (11136): [<ffff8000887ca41c>] spin_lock_bh include/linux/spinlock.h:356 [inline]
  softirqs last disabled at (11136): [<ffff8000887ca41c>] release_sock+0x3c/0x1b0 net/core/sock.c:3518
- Tcp: tsq: relax tcp_small_queue_check() when rtx queue contains a
  single skb. [Eric Dumazet]

  commit f921a4a5bffa8a0005b190fb9421a7fc1fd716b6 upstream.

  In commit 75eefc6c59fd ("tcp: tsq: add a shortcut in tcp_small_queue_check()")
  we allowed to send an skb regardless of TSQ limits being hit if rtx queue
  was empty or had a single skb, in order to better fill the pipe
  when/if TX completions were slow.

  Then later, commit 75c119afe14f ("tcp: implement rb-tree based
  retransmit queue") accidentally removed the special case for
  one skb in rtx queue.

  Stefan Wahren reported a regression in single TCP flow throughput
  using a 100Mbit fec link, starting from commit 65466904b015 ("tcp: adjust
  TSO packet sizes based on min_rtt"). This last commit only made the
  regression more visible, because it locked the TCP flow on a particular
  behavior where TSQ prevented two skbs being pushed downstream,
  adding silences on the wire between each TSO packet.

  Many thanks to Stefan for his invaluable help !
- Tcp: fix excessive TLP and RACK timeouts from HZ rounding. [Neal
  Cardwell]

  commit 1c2709cfff1dedbb9591e989e2f001484208d914 upstream.

  We discovered from packet traces of slow loss recovery on kernels with
  the default HZ=250 setting (and min_rtt < 1ms) that after reordering,
  when receiving a SACKed sequence range, the RACK reordering timer was
  firing after about 16ms rather than the desired value of roughly
  min_rtt/4 + 2ms. The problem is largely due to the RACK reorder timer
  calculation adding in TCP_TIMEOUT_MIN, which is 2 jiffies. On kernels
  with HZ=250, this is 2*4ms = 8ms. The TLP timer calculation has the
  exact same issue.

  This commit fixes the TLP transmit timer and RACK reordering timer
  floor calculation to more closely match the intended 2ms floor even on
  kernels with HZ=250. It does this by adding in a new
  TCP_TIMEOUT_MIN_US floor of 2000 us and then converting to jiffies,
  instead of the current approach of converting to jiffies and then
  adding th TCP_TIMEOUT_MIN value of 2 jiffies.

  Our testing has verified that on kernels with HZ=1000, as expected,
  this does not produce significant changes in behavior, but on kernels
  with the default HZ=250 the latency improvement can be large. For
  example, our tests show that for HZ=250 kernels at low RTTs this fix
  roughly halves the latency for the RACK reorder timer: instead of
  mostly firing at 16ms it mostly fires at 8ms.
- Net: rfkill: gpio: prevent value glitch during probe. [Josua Mayer]

  commit b2f750c3a80b285cd60c9346f8c96bd0a2a66cde upstream.

  When either reset- or shutdown-gpio have are initially deasserted,
  e.g. after a reboot - or when the hardware does not include pull-down,
  there will be a short toggle of both IOs to logical 0 and back to 1.

  It seems that the rfkill default is unblocked, so the driver should not
  glitch to output low during probe.
  It can lead e.g. to unexpected lte modem reconnect:

  [1] root@localhost:~# dmesg | grep "usb 2-1"
  [    2.136124] usb 2-1: new SuperSpeed USB device number 2 using xhci-hcd
  [   21.215278] usb 2-1: USB disconnect, device number 2
  [   28.833977] usb 2-1: new SuperSpeed USB device number 3 using xhci-hcd

  The glitch has been discovered on an arm64 board, now that device-tree
  support for the rfkill-gpio driver has finally appeared :).

  Change the flags for devm_gpiod_get_optional from GPIOD_OUT_LOW to
  GPIOD_ASIS to avoid any glitches.
  The rfkill driver will set the intended value during rfkill_sync_work.
- Net: ipv6: fix return value check in esp_remove_trailer. [Ma Ke]

  commit dad4e491e30b20f4dc615c9da65d2142d703b5c2 upstream.

  In esp_remove_trailer(), to avoid an unexpected result returned by
  pskb_trim, we should check the return value of pskb_trim().
- Net: ipv4: fix return value check in esp_remove_trailer. [Ma Ke]

  commit 513f61e2193350c7a345da98559b80f61aec4fa6 upstream.

  In esp_remove_trailer(), to avoid an unexpected result returned by
  pskb_trim, we should check the return value of pskb_trim().
- Xfrm: interface: use DEV_STATS_INC() [Eric Dumazet]

  commit f7c4e3e5d4f6609b4725a97451948ca2e425379a upstream.

  syzbot/KCSAN reported data-races in xfrm whenever dev->stats fields
  are updated.

  It appears all of these updates can happen from multiple cpus.

  Adopt SMP safe DEV_STATS_INC() to update dev->stats fields.

  BUG: KCSAN: data-race in xfrmi_xmit / xfrmi_xmit

  read-write to 0xffff88813726b160 of 8 bytes by task 23986 on cpu 1:
  xfrmi_xmit+0x74e/0xb20 net/xfrm/xfrm_interface_core.c:583
  __netdev_start_xmit include/linux/netdevice.h:4889 [inline]
  netdev_start_xmit include/linux/netdevice.h:4903 [inline]
  xmit_one net/core/dev.c:3544 [inline]
  dev_hard_start_xmit+0x11b/0x3f0 net/core/dev.c:3560
  __dev_queue_xmit+0xeee/0x1de0 net/core/dev.c:4340
  dev_queue_xmit include/linux/netdevice.h:3082 [inline]
  neigh_connected_output+0x231/0x2a0 net/core/neighbour.c:1581
  neigh_output include/net/neighbour.h:542 [inline]
  ip_finish_output2+0x74a/0x850 net/ipv4/ip_output.c:230
  ip_finish_output+0xf4/0x240 net/ipv4/ip_output.c:318
  NF_HOOK_COND include/linux/netfilter.h:293 [inline]
  ip_output+0xe5/0x1b0 net/ipv4/ip_output.c:432
  dst_output include/net/dst.h:458 [inline]
  ip_local_out net/ipv4/ip_output.c:127 [inline]
  ip_send_skb+0x72/0xe0 net/ipv4/ip_output.c:1487
  udp_send_skb+0x6a4/0x990 net/ipv4/udp.c:963
  udp_sendmsg+0x1249/0x12d0 net/ipv4/udp.c:1246
  inet_sendmsg+0x63/0x80 net/ipv4/af_inet.c:840
  sock_sendmsg_nosec net/socket.c:730 [inline]
  sock_sendmsg net/socket.c:753 [inline]
  ____sys_sendmsg+0x37c/0x4d0 net/socket.c:2540
  ___sys_sendmsg net/socket.c:2594 [inline]
  __sys_sendmmsg+0x269/0x500 net/socket.c:2680
  __do_sys_sendmmsg net/socket.c:2709 [inline]
  __se_sys_sendmmsg net/socket.c:2706 [inline]
  __x64_sys_sendmmsg+0x57/0x60 net/socket.c:2706
  do_syscall_x64 arch/x86/entry/common.c:50 [inline]
  do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x63/0xcd

  read-write to 0xffff88813726b160 of 8 bytes by task 23987 on cpu 0:
  xfrmi_xmit+0x74e/0xb20 net/xfrm/xfrm_interface_core.c:583
  __netdev_start_xmit include/linux/netdevice.h:4889 [inline]
  netdev_start_xmit include/linux/netdevice.h:4903 [inline]
  xmit_one net/core/dev.c:3544 [inline]
  dev_hard_start_xmit+0x11b/0x3f0 net/core/dev.c:3560
  __dev_queue_xmit+0xeee/0x1de0 net/core/dev.c:4340
  dev_queue_xmit include/linux/netdevice.h:3082 [inline]
  neigh_connected_output+0x231/0x2a0 net/core/neighbour.c:1581
  neigh_output include/net/neighbour.h:542 [inline]
  ip_finish_output2+0x74a/0x850 net/ipv4/ip_output.c:230
  ip_finish_output+0xf4/0x240 net/ipv4/ip_output.c:318
  NF_HOOK_COND include/linux/netfilter.h:293 [inline]
  ip_output+0xe5/0x1b0 net/ipv4/ip_output.c:432
  dst_output include/net/dst.h:458 [inline]
  ip_local_out net/ipv4/ip_output.c:127 [inline]
  ip_send_skb+0x72/0xe0 net/ipv4/ip_output.c:1487
  udp_send_skb+0x6a4/0x990 net/ipv4/udp.c:963
  udp_sendmsg+0x1249/0x12d0 net/ipv4/udp.c:1246
  inet_sendmsg+0x63/0x80 net/ipv4/af_inet.c:840
  sock_sendmsg_nosec net/socket.c:730 [inline]
  sock_sendmsg net/socket.c:753 [inline]
  ____sys_sendmsg+0x37c/0x4d0 net/socket.c:2540
  ___sys_sendmsg net/socket.c:2594 [inline]
  __sys_sendmmsg+0x269/0x500 net/socket.c:2680
  __do_sys_sendmmsg net/socket.c:2709 [inline]
  __se_sys_sendmmsg net/socket.c:2706 [inline]
  __x64_sys_sendmmsg+0x57/0x60 net/socket.c:2706
  do_syscall_x64 arch/x86/entry/common.c:50 [inline]
  do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x63/0xcd

  value changed: 0x00000000000010d7 -> 0x00000000000010d8

  Reported by Kernel Concurrency Sanitizer on:
  CPU: 0 PID: 23987 Comm: syz-executor.5 Not tainted 6.5.0-syzkaller-10885-g0468be89b3fa #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
- Xfrm: fix a data-race in xfrm_gen_index() [Eric Dumazet]

  commit 3e4bc23926b83c3c67e5f61ae8571602754131a6 upstream.

  xfrm_gen_index() mutual exclusion uses net->xfrm.xfrm_policy_lock.

  This means we must use a per-netns idx_generator variable,
  instead of a static one.
  Alternative would be to use an atomic variable.

  syzbot reported:

  BUG: KCSAN: data-race in xfrm_sk_policy_insert / xfrm_sk_policy_insert

  write to 0xffffffff87005938 of 4 bytes by task 29466 on cpu 0:
  xfrm_gen_index net/xfrm/xfrm_policy.c:1385 [inline]
  xfrm_sk_policy_insert+0x262/0x640 net/xfrm/xfrm_policy.c:2347
  xfrm_user_policy+0x413/0x540 net/xfrm/xfrm_state.c:2639
  do_ipv6_setsockopt+0x1317/0x2ce0 net/ipv6/ipv6_sockglue.c:943
  ipv6_setsockopt+0x57/0x130 net/ipv6/ipv6_sockglue.c:1012
  rawv6_setsockopt+0x21e/0x410 net/ipv6/raw.c:1054
  sock_common_setsockopt+0x61/0x70 net/core/sock.c:3697
  __sys_setsockopt+0x1c9/0x230 net/socket.c:2263
  __do_sys_setsockopt net/socket.c:2274 [inline]
  __se_sys_setsockopt net/socket.c:2271 [inline]
  __x64_sys_setsockopt+0x66/0x80 net/socket.c:2271
  do_syscall_x64 arch/x86/entry/common.c:50 [inline]
  do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x63/0xcd

  read to 0xffffffff87005938 of 4 bytes by task 29460 on cpu 1:
  xfrm_sk_policy_insert+0x13e/0x640
  xfrm_user_policy+0x413/0x540 net/xfrm/xfrm_state.c:2639
  do_ipv6_setsockopt+0x1317/0x2ce0 net/ipv6/ipv6_sockglue.c:943
  ipv6_setsockopt+0x57/0x130 net/ipv6/ipv6_sockglue.c:1012
  rawv6_setsockopt+0x21e/0x410 net/ipv6/raw.c:1054
  sock_common_setsockopt+0x61/0x70 net/core/sock.c:3697
  __sys_setsockopt+0x1c9/0x230 net/socket.c:2263
  __do_sys_setsockopt net/socket.c:2274 [inline]
  __se_sys_setsockopt net/socket.c:2271 [inline]
  __x64_sys_setsockopt+0x66/0x80 net/socket.c:2271
  do_syscall_x64 arch/x86/entry/common.c:50 [inline]
  do_syscall_64+0x41/0xc0 arch/x86/entry/common.c:80
  entry_SYSCALL_64_after_hwframe+0x63/0xcd

  value changed: 0x00006ad8 -> 0x00006b18

  Reported by Kernel Concurrency Sanitizer on:
  CPU: 1 PID: 29460 Comm: syz-executor.1 Not tainted 6.5.0-rc5-syzkaller-00243-g9106536c1aa3 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
- Qed: fix LL2 RX buffer allocation. [Manish Chopra]

  commit 2f3389c73832ad90b63208c0fc281ad080114c7a upstream.

  Driver allocates the LL2 rx buffers from kmalloc()
  area to construct the skb using slab_build_skb()

  The required size allocation seems to have overlooked
  for accounting both skb_shared_info size and device
  placement padding bytes which results into the below
  panic when doing skb_put() for a standard MTU sized frame.

  skbuff: skb_over_panic: text:ffffffffc0b0225f len:1514 put:1514
  head:ff3dabceaf39c000 data:ff3dabceaf39c042 tail:0x62c end:0x566
  dev:<NULL>
  …
  skb_panic+0x48/0x4a
  skb_put.cold+0x10/0x10
  qed_ll2b_complete_rx_packet+0x14f/0x260 [qed]
  qed_ll2_rxq_handle_completion.constprop.0+0x169/0x200 [qed]
  qed_ll2_rxq_completion+0xba/0x320 [qed]
  qed_int_sp_dpc+0x1a7/0x1e0 [qed]

  This patch fixes this by accouting skb_shared_info and device
  placement padding size bytes when allocating the buffers.
- Drm/i915: Retry gtt fault when out of fence registers. [Ville Syrjälä]

  commit e339c6d628fe66c9b64bf31040a55770952aec57 upstream.

  If we can't find a free fence register to handle a fault in the GMADR
  range just return VM_FAULT_NOPAGE without populating the PTE so that
  userspace will retry the access and trigger another fault. Eventually
  we should find a free fence and the fault will get properly handled.

  A further improvement idea might be to reserve a fence (or one per CPU?)
  for the express purpose of handling faults without having to retry. But
  that would require some additional work.

  Looks like this may have gotten broken originally by
  commit 39965b376601 ("drm/i915: don't trash the gtt when running out of fences")
  as that changed the errno to -EDEADLK which wasn't handle by the gtt
  fault code either. But later in commit 2feeb52859fc ("drm/i915/gt: Fix
  -EDEADLK handling regression") I changed it again to -ENOBUFS as -EDEADLK
  was now getting used for the ww mutex dance. So this fix only makes
  sense after that last commit.

  Cc: stable@vger.kernel.org
  Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/9479
  Fixes: 2feeb52859fc ("drm/i915/gt: Fix -EDEADLK handling regression")
  Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
  Link: https://patchwork.freedesktop.org/patch/msgid/20231012132801.16292-1-ville.syrjala@linux.intel.com
  Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
  (cherry picked from commit 7f403caabe811b88ab0de3811ff3f4782c415761)
- Nvmet-tcp: Fix a possible UAF in queue intialization setup. [Sagi
  Grimberg]

  commit d920abd1e7c4884f9ecd0749d1921b7ab19ddfbd upstream.

  From Alon:
  "Due to a logical bug in the NVMe-oF/TCP subsystem in the Linux kernel,
  a malicious user can cause a UAF and a double free, which may lead to
  RCE (may also lead to an LPE in case the attacker already has local
  privileges)."

  Hence, when a queue initialization fails after the ahash requests are
  allocated, it is guaranteed that the queue removal async work will be
  called, hence leave the deallocation to the queue removal.

  Also, be extra careful not to continue processing the socket, so set
  queue rcv_state to NVMET_TCP_RECV_ERR upon a socket error.
- Netfilter: nft_payload: fix wrong mac header matching. [Florian
  Westphal]

  commit d351c1ea2de3e36e608fc355d8ae7d0cc80e6cd6 upstream.

  mcast packets get looped back to the local machine.
  Such packets have a 0-length mac header, we should treat
  this like "mac header not set" and abort rule evaluation.

  As-is, we just copy data from the network header instead.
- Tcp: check mptcp-level constraints for backlog coalescing. [Paolo
  Abeni]

  commit 6db8a37dfc541e059851652cfd4f0bb13b8ff6af upstream.

  The MPTCP protocol can acquire the subflow-level socket lock and
  cause the tcp backlog usage. When inserting new skbs into the
  backlog, the stack will try to coalesce them.

  Currently, we have no check in place to ensure that such coalescing
  will respect the MPTCP-level DSS, and that may cause data stream
  corruption, as reported by Christoph.

  Address the issue by adding the relevant admission check for coalescing
  in tcp_add_backlog().

  Note the issue is not easy to reproduce, as the MPTCP protocol tries
  hard to avoid acquiring the subflow-level socket lock.
- X86/sev: Check for user-space IOIO pointing to kernel space. [Joerg
  Roedel]

  Upstream commit: 63e44bc52047f182601e7817da969a105aa1f721

  Check the memory operand of INS/OUTS before emulating the instruction.
  The #VC exception can get raised from user-space, but the memory operand
  can be manipulated to access kernel memory before the emulation actually
  begins and after the exception handler has run.

    [ bp: Massage commit message. ]
- X86/sev: Check IOBM for IOIO exceptions from user-space. [Joerg
  Roedel]

  Upstream commit: b9cb9c45583b911e0db71d09caa6b56469eb2bdf

  Check the IO permission bitmap (if present) before emulating IOIO #VC
  exceptions for user-space. These permissions are checked by hardware
  already before the #VC is raised, but due to the VC-handler decoding
  race it needs to be checked again in software.
- X86/sev: Disable MMIO emulation from user mode. [Borislav Petkov
  (AMD)]

  Upstream commit: a37cd2a59d0cb270b1bba568fd3a3b8668b9d3ba

  A virt scenario can be constructed where MMIO memory can be user memory.
  When that happens, a race condition opens between when the hardware
  raises the #VC and when the #VC handler gets to emulate the instruction.

  If the MOVS is replaced with a MOVS accessing kernel memory in that
  small race window, then write to kernel memory happens as the access
  checks are not done at emulation time.

  Disable MMIO emulation in user mode temporarily until a sensible use
  case appears and justifies properly handling the race window.
- KVM: x86: Mask LVTPC when handling a PMI. [Jim Mattson]

  commit a16eb25b09c02a54c1c1b449d4b6cfa2cf3f013a upstream.

  Per the SDM, "When the local APIC handles a performance-monitoring
  counters interrupt, it automatically sets the mask flag in the LVT
  performance counter register."  Add this behavior to KVM's local APIC
  emulation.

  Failure to mask the LVTPC entry results in spurious PMIs, e.g. when
  running Linux as a guest, PMI handlers that do a "late_ack" spew a large
  number of "dazed and confused" spurious NMI warnings.

  Fixes: f5132b01386b ("KVM: Expose a version 2 architectural PMU to a guests")
  Cc: stable@vger.kernel.org
  Signed-off-by: Jim Mattson <jmattson@google.com>
  Tested-by: Mingwei Zhang <mizhang@google.com>
  Signed-off-by: Mingwei Zhang <mizhang@google.com>
  Link: https://lore.kernel.org/r/20230925173448.3518223-3-mizhang@google.com
  [sean: massage changelog, correct Fixes]
- Regmap: fix NULL deref on lookup. [Johan Hovold]

  commit c6df843348d6b71ea986266c12831cb60c2cf325 upstream.

  Not all regmaps have a name so make sure to check for that to avoid
  dereferencing a NULL pointer when dev_get_regmap() is used to lookup a
  named regmap.
- Nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
  [Krzysztof Kozlowski]

  commit 7937609cd387246aed994e81aa4fa951358fba41 upstream.

  Handle memory allocation failure from nci_skb_alloc() (calling
  alloc_skb()) to avoid possible NULL pointer dereference.
- Ice: reset first in crash dump kernels. [Jesse Brandeburg]

  commit 0288c3e709e5fabd51e84715c5c798a02f43061a upstream.

  When the system boots into the crash dump kernel after a panic, the ice
  networking device may still have pending transactions that can cause errors
  or machine checks when the device is re-enabled. This can prevent the crash
  dump kernel from loading the driver or collecting the crash data.

  To avoid this issue, perform a function level reset (FLR) on the ice device
  via PCIe config space before enabling it on the crash kernel. This will
  clear any outstanding transactions and stop all queues and interrupts.
  Restore the config space after the FLR, otherwise it was found in testing
  that the driver wouldn't load successfully.

  The following sequence causes the original issue:
  - Load the ice driver with modprobe ice
  - Enable SR-IOV with 2 VFs: echo 2 > /sys/class/net/eth0/device/sriov_num_vfs
  - Trigger a crash with echo c > /proc/sysrq-trigger
  - Load the ice driver again (or let it load automatically) with modprobe ice
  - The system crashes again during pcim_enable_device()
- Ice: fix over-shifted variable. [Jesse Brandeburg]

  commit 242e34500a32631f85c2b4eb6cb42a368a39e54f upstream.

  Since the introduction of the ice driver the code has been
  double-shifting the RSS enabling field, because the define already has
  shifts in it and can't have the regular pattern of "a << shiftval &
  mask" applied.

  Most places in the code got it right, but one line was still wrong. Fix
  this one location for easy backports to stable. An in-progress patch
  fixes the defines to "standard" and will be applied as part of the
  regular -next process sometime after this one.
- Bluetooth: avoid memcmp() out of bounds warning. [Arnd Bergmann]

  commit 9d1a3c74746428102d55371fbf74b484733937d9 upstream.

  bacmp() is a wrapper around memcpy(), which contain compile-time
  checks for buffer overflow. Since the hci_conn_request_evt() also calls
  bt_dev_dbg() with an implicit NULL pointer check, the compiler is now
  aware of a case where 'hdev' is NULL and treats this as meaning that
  zero bytes are available:

  In file included from net/bluetooth/hci_event.c:32:
  In function 'bacmp',
      inlined from 'hci_conn_request_evt' at net/bluetooth/hci_event.c:3276:7:
  include/net/bluetooth/bluetooth.h:364:16: error: 'memcmp' specified bound 6 exceeds source size 0 [-Werror=stringop-overread]
    364 |         return memcmp(ba1, ba2, sizeof(bdaddr_t));
        |                ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  Add another NULL pointer check before the bacmp() to ensure the compiler
  understands the code flow enough to not warn about it.  Since the patch
  that introduced the warning is marked for stable backports, this one
  should also go that way to avoid introducing build regressions.
- Bluetooth: hci_event: Fix coding style. [Luiz Augusto von Dentz]

  commit 35d91d95a0cd61ebb90e0246dc917fd25e519b8c upstream.

  This fixes the following code style problem:

  ERROR: that open brace { should be on the previous line
  +	if (!bacmp(&hdev->bdaddr, &ev->bdaddr))
  +	{
- Bluetooth: vhci: Fix race when opening vhci device. [Arkadiusz Bokowy]

  commit 92d4abd66f7080075793970fc8f241239e58a9e7 upstream.

  When the vhci device is opened in the two-step way, i.e.: open device
  then write a vendor packet with requested controller type, the device
  shall respond with a vendor packet which includes HCI index of created
  interface.

  When the virtual HCI is created, the host sends a reset request to the
  controller. This request is processed by the vhci_send_frame() function.
  However, this request is send by a different thread, so it might happen
  that this HCI request will be received before the vendor response is
  queued in the read queue. This results in the HCI vendor response and
  HCI reset request inversion in the read queue which leads to improper
  behavior of btvirt:

  > dmesg
  [1754256.640122] Bluetooth: MGMT ver 1.22
  [1754263.023806] Bluetooth: MGMT ver 1.22
  [1754265.043775] Bluetooth: hci1: Opcode 0x c03 failed: -110

  In order to synchronize vhci two-step open/setup process with virtual
  HCI initialization, this patch adds internal lock when queuing data in
  the vhci_send_frame() function.
- Bluetooth: Fix a refcnt underflow problem for hci_conn. [Ziyang Xuan]

  commit c7f59461f5a78994613afc112cdd73688aef9076 upstream.

  Syzbot reports a warning as follows:

  WARNING: CPU: 1 PID: 26946 at net/bluetooth/hci_conn.c:619
  hci_conn_timeout+0x122/0x210 net/bluetooth/hci_conn.c:619
  ...
  Call Trace:
   <TASK>
   process_one_work+0x884/0x15c0 kernel/workqueue.c:2630
   process_scheduled_works kernel/workqueue.c:2703 [inline]
   worker_thread+0x8b9/0x1290 kernel/workqueue.c:2784
   kthread+0x33c/0x440 kernel/kthread.c:388
   ret_from_fork+0x45/0x80 arch/x86/kernel/process.c:147
   ret_from_fork_asm+0x11/0x20 arch/x86/entry/entry_64.S:304
   </TASK>

  It is because the HCI_EV_SIMPLE_PAIR_COMPLETE event handler drops
  hci_conn directly without check Simple Pairing whether be enabled. But
  the Simple Pairing process can only be used if both sides have the
  support enabled in the host stack.

  Add hci_conn_ssp_enabled() for hci_conn in HCI_EV_IO_CAPA_REQUEST and
  HCI_EV_SIMPLE_PAIR_COMPLETE event handlers to fix the problem.
- Bluetooth: Reject connection with the device which has same BD_ADDR.
  [Lee, Chun-Yi]

  commit 1ffc6f8cc33268731fcf9629fc4438f6db1191fc upstream.

  This change is used to relieve CVE-2020-26555. The description of
  the CVE:

  Bluetooth legacy BR/EDR PIN code pairing in Bluetooth Core Specification
  1.0B through 5.2 may permit an unauthenticated nearby device to spoof
  the BD_ADDR of the peer device to complete pairing without knowledge
  of the PIN. [1]

  The detail of this attack is in IEEE paper:
  BlueMirror: Reflections on Bluetooth Pairing and Provisioning Protocols
  [2]

  It's a reflection attack. The paper mentioned that attacker can induce
  the attacked target to generate null link key (zero key) without PIN
  code. In BR/EDR, the key generation is actually handled in the controller
  which is below HCI.

  A condition of this attack is that attacker should change the
  BR_ADDR of his hacking device (Host B) to equal to the BR_ADDR with
  the target device being attacked (Host A).

  Thus, we reject the connection with device which has same BD_ADDR
  both on HCI_Create_Connection and HCI_Connection_Request to prevent
  the attack. A similar implementation also shows in btstack project.
  [3][4]
- Bluetooth: hci_event: Ignore NULL link key. [Lee, Chun-Yi]

  commit 33155c4aae5260475def6f7438e4e35564f4f3ba upstream.

  This change is used to relieve CVE-2020-26555. The description of the
  CVE:

  Bluetooth legacy BR/EDR PIN code pairing in Bluetooth Core Specification
  1.0B through 5.2 may permit an unauthenticated nearby device to spoof
  the BD_ADDR of the peer device to complete pairing without knowledge
  of the PIN. [1]

  The detail of this attack is in IEEE paper:
  BlueMirror: Reflections on Bluetooth Pairing and Provisioning Protocols
  [2]

  It's a reflection attack. The paper mentioned that attacker can induce
  the attacked target to generate null link key (zero key) without PIN
  code. In BR/EDR, the key generation is actually handled in the controller
  which is below HCI.

  Thus, we can ignore null link key in the handler of "Link Key Notification
  event" to relieve the attack. A similar implementation also shows in
  btstack project. [3]

  v3: Drop the connection when null link key be detected.

  v2:
  - Used Link: tag instead of Closes:
  - Used bt_dev_dbg instead of BT_DBG
  - Added Fixes: tag
- Usb: hub: Guard against accesses to uninitialized BOS descriptors.
  [Ricardo Cañuelo]

  commit f74a7afc224acd5e922c7a2e52244d891bbe44ee upstream.

  Many functions in drivers/usb/core/hub.c and drivers/usb/core/hub.h
  access fields inside udev->bos without checking if it was allocated and
  initialized. If usb_get_bos_descriptor() fails for whatever
  reason, udev->bos will be NULL and those accesses will result in a
  crash:

  BUG: kernel NULL pointer dereference, address: 0000000000000018
  PGD 0 P4D 0
  Oops: 0000 [#1] PREEMPT SMP NOPTI
  CPU: 5 PID: 17818 Comm: kworker/5:1 Tainted: G W 5.15.108-18910-gab0e1cb584e1 #1 <HASH:1f9e 1>
  Hardware name: Google Kindred/Kindred, BIOS Google_Kindred.12672.413.0 02/03/2021
  Workqueue: usb_hub_wq hub_event
  RIP: 0010:hub_port_reset+0x193/0x788
  Code: 89 f7 e8 20 f7 15 00 48 8b 43 08 80 b8 96 03 00 00 03 75 36 0f b7 88 92 03 00 00 81 f9 10 03 00 00 72 27 48 8b 80 a8 03 00 00 <48> 83 78 18 00 74 19 48 89 df 48 8b 75 b0 ba 02 00 00 00 4c 89 e9
  RSP: 0018:ffffab740c53fcf8 EFLAGS: 00010246
  RAX: 0000000000000000 RBX: ffffa1bc5f678000 RCX: 0000000000000310
  RDX: fffffffffffffdff RSI: 0000000000000286 RDI: ffffa1be9655b840
  RBP: ffffab740c53fd70 R08: 00001b7d5edaa20c R09: ffffffffb005e060
  R10: 0000000000000001 R11: 0000000000000000 R12: 0000000000000000
  R13: ffffab740c53fd3e R14: 0000000000000032 R15: 0000000000000000
  FS: 0000000000000000(0000) GS:ffffa1be96540000(0000) knlGS:0000000000000000
  CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 0000000000000018 CR3: 000000022e80c005 CR4: 00000000003706e0
  Call Trace:
  hub_event+0x73f/0x156e
  ? hub_activate+0x5b7/0x68f
  process_one_work+0x1a2/0x487
  worker_thread+0x11a/0x288
  kthread+0x13a/0x152
  ? process_one_work+0x487/0x487
  ? kthread_associate_blkcg+0x70/0x70
  ret_from_fork+0x1f/0x30

  Fall back to a default behavior if the BOS descriptor isn't accessible
  and skip all the functionalities that depend on it: LPM support checks,
  Super Speed capabilitiy checks, U1/U2 states setup.
- Documentation: sysctl: align cells in second content column. [Bagas
  Sanjaya]

  commit 1faa34672f8a17a3e155e74bde9648564e9480d6 upstream.

  Stephen Rothwell reported htmldocs warning when merging net-next tree:

  Documentation/admin-guide/sysctl/net.rst:37: WARNING: Malformed table.
  Text in column margin in table line 4.

  ========= =================== = ========== ==================
  Directory Content               Directory  Content
  ========= =================== = ========== ==================
  802       E802 protocol         mptcp     Multipath TCP
  appletalk Appletalk protocol    netfilter Network Filter
  ax25      AX25                  netrom     NET/ROM
  bridge    Bridging              rose      X.25 PLP layer
  core      General parameter     tipc      TIPC
  ethernet  Ethernet protocol     unix      Unix domain sockets
  ipv4      IP version 4          x25       X.25 protocol
  ipv6      IP version 6
  ========= =================== = ========== ==================

  The warning above is caused by cells in second "Content" column of
  /proc/sys/net subdirectory table which are in column margin.

  Align these cells against the column header to fix the warning.
- Mm/memory_hotplug: rate limit page migration warnings. [Liam Mark]

  commit 786dee864804f8e851cf0f258df2ccbb4ee03d80 upstream.

  When offlining memory the system can attempt to migrate a lot of pages, if
  there are problems with migration this can flood the logs.  Printing all
  the data hogs the CPU and cause some RT threads to run for a long time,
  which may have some bad consequences.

  Rate limit the page migration warnings in order to avoid this.
- Lib/Kconfig.debug: do not enable DEBUG_PREEMPT by default. [Hyeonggon
  Yoo]

  commit cc6003916ed46d7a67d91ee32de0f9138047d55f upstream.

  In workloads where this_cpu operations are frequently performed,
  enabling DEBUG_PREEMPT may result in significant increase in
  runtime overhead due to frequent invocation of
  __this_cpu_preempt_check() function.

  This can be demonstrated through benchmarks such as hackbench where this
  configuration results in a 10% reduction in performance, primarily due to
  the added overhead within memcg charging path.

  Therefore, do not to enable DEBUG_PREEMPT by default and make users aware
  of its potential impact on performance in some workloads.

  hackbench-process-sockets
  		      debug_preempt	 no_debug_preempt
  Amean     1       0.4743 (   0.00%)      0.4295 *   9.45%*
  Amean     4       1.4191 (   0.00%)      1.2650 *  10.86%*
  Amean     7       2.2677 (   0.00%)      2.0094 *  11.39%*
  Amean     12      3.6821 (   0.00%)      3.2115 *  12.78%*
  Amean     21      6.6752 (   0.00%)      5.7956 *  13.18%*
  Amean     30      9.6646 (   0.00%)      8.5197 *  11.85%*
  Amean     48     15.3363 (   0.00%)     13.5559 *  11.61%*
  Amean     79     24.8603 (   0.00%)     22.0597 *  11.27%*
  Amean     96     30.1240 (   0.00%)     26.8073 *  11.01%*
- Dev_forward_skb: do not scrub skb mark within the same name space.
  [Nicolas Dichtel]

  commit ff70202b2d1ad522275c6aadc8c53519b6a22c57 upstream.

  The goal is to keep the mark during a bpf_redirect(), like it is done for
  legacy encapsulation / decapsulation, when there is no x-netns.
  This was initially done in commit 213dd74aee76 ("skbuff: Do not scrub skb
  mark within the same name space").

  When the call to skb_scrub_packet() was added in dev_forward_skb() (commit
  8b27f27797ca ("skb: allow skb_scrub_packet() to be used by tunnels")), the
  second argument (xnet) was set to true to force a call to skb_orphan(). At
  this time, the mark was always cleanned up by skb_scrub_packet(), whatever
  xnet value was.
  This call to skb_orphan() was removed later in commit
  9c4c325252c5 ("skbuff: preserve sock reference when scrubbing the skb.").
  But this 'true' stayed here without any real reason.

  Let's correctly set xnet in ____dev_forward_skb(), this function has access
  to the previous interface and to the new interface.
- Ravb: Fix use-after-free issue in ravb_tx_timeout_work() [Yoshihiro
  Shimoda]

  commit 3971442870713de527684398416970cf025b4f89 upstream.

  The ravb_stop() should call cancel_work_sync(). Otherwise,
  ravb_tx_timeout_work() is possible to use the freed priv after
  ravb_remove() was called like below:

  CPU0			CPU1
  			ravb_tx_timeout()
  ravb_remove()
  unregister_netdev()
  free_netdev(ndev)
  // free priv
  			ravb_tx_timeout_work()
  			// use priv

  unregister_netdev() will call .ndo_stop() so that ravb_stop() is
  called. And, after phy_stop() is called, netif_carrier_off()
  is also called. So that .ndo_tx_timeout() will not be called
  after phy_stop().
- RDMA/srp: Fix srp_abort() [Bart Van Assche]

  commit 6dbe4a8dead84de474483910b02ec9e6a10fc1a9 upstream.

  Fix the code for converting a SCSI command pointer into an SRP request
  pointer.
- RDMA/srp: Set scmnd->result only when scmnd is not NULL.
  [yangx.jy@fujitsu.com]

  commit 12f35199a2c0551187edbf8eb01379f0598659fa upstream.

  This change fixes the following kernel NULL pointer dereference
  which is reproduced by blktests srp/007 occasionally.

  BUG: kernel NULL pointer dereference, address: 0000000000000170
  PGD 0 P4D 0
  Oops: 0002 [#1] PREEMPT SMP NOPTI
  CPU: 0 PID: 9 Comm: kworker/0:1H Kdump: loaded Not tainted 6.0.0-rc1+ #37
  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.15.0-29-g6a62e0cb0dfe-prebuilt.qemu.org 04/01/2014
  Workqueue:  0x0 (kblockd)
  RIP: 0010:srp_recv_done+0x176/0x500 [ib_srp]
  Code: 00 4d 85 ff 0f 84 52 02 00 00 48 c7 82 80 02 00 00 00 00 00 00 4c 89 df 4c 89 14 24 e8 53 d3 4a f6 4c 8b 14 24 41 0f b6 42 13 <41> 89 87 70 01 00 00 41 0f b6 52 12 f6 c2 02 74 44 41 8b 42 1c b9
  RSP: 0018:ffffaef7c0003e28 EFLAGS: 00000282
  RAX: 0000000000000000 RBX: ffff9bc9486dea60 RCX: 0000000000000000
  RDX: 0000000000000102 RSI: ffffffffb76bbd0e RDI: 00000000ffffffff
  RBP: ffff9bc980099a00 R08: 0000000000000001 R09: 0000000000000001
  R10: ffff9bca53ef0000 R11: ffff9bc980099a10 R12: ffff9bc956e14000
  R13: ffff9bc9836b9cb0 R14: ffff9bc9557b4480 R15: 0000000000000000
  FS:  0000000000000000(0000) GS:ffff9bc97ec00000(0000) knlGS:0000000000000000
  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 0000000000000170 CR3: 0000000007e04000 CR4: 00000000000006f0
  Call Trace:
   <IRQ>
   __ib_process_cq+0xb7/0x280 [ib_core]
   ib_poll_handler+0x2b/0x130 [ib_core]
   irq_poll_softirq+0x93/0x150
   __do_softirq+0xee/0x4b8
   irq_exit_rcu+0xf7/0x130
   sysvec_apic_timer_interrupt+0x8e/0xc0
   </IRQ>
- Arm64: armv8_deprecated: fix unused-function error. [Ren Zhijie]

  commit 223d3a0d30b6e9f979f5642e430e1753d3e29f89 upstream.

  If CONFIG_SWP_EMULATION is not set and
  CONFIG_CP15_BARRIER_EMULATION is not set,
  aarch64-linux-gnu complained about unused-function :

  arch/arm64/kernel/armv8_deprecated.c:67:21: error: ‘aarch32_check_condition’ defined but not used [-Werror=unused-function]
   static unsigned int aarch32_check_condition(u32 opcode, u32 psr)
                       ^~~~~~~~~~~~~~~~~~~~~~~
  cc1: all warnings being treated as errors

  To fix this warning, modify aarch32_check_condition() with __maybe_unused.
- Arm64: armv8_deprecated: rework deprected instruction handling. [Mark
  Rutland]

  commit 124c49b1b5d947b7180c5d6cbb09ddf76ea45ea2 upstream.

  Support for deprecated instructions can be enabled or disabled at
  runtime. To handle this, the code in armv8_deprecated.c registers and
  unregisters undef_hooks, and makes cross CPU calls to configure HW
  support. This is rather complicated, and the synchronization required to
  make this safe ends up serializing the handling of instructions which
  have been trapped.

  This patch simplifies the deprecated instruction handling by removing
  the dynamic registration and unregistration, and changing the trap
  handling code to determine whether a handler should be invoked. This
  removes the need for dynamic list management, and simplifies the locking
  requirements, making it possible to handle trapped instructions entirely
  in parallel.

  Where changing the emulation state requires a cross-call, this is
  serialized by locally disabling interrupts, ensuring that the CPU is not
  left in an inconsistent state.

  To simplify sysctl management, each insn_emulation is given a separate
  sysctl table, permitting these to be registered separately. The core
  sysctl code will iterate over all of these when walking sysfs.

  I've tested this with userspace programs which use each of the
  deprecated instructions, and I've concurrently modified the support
  level for each of the features back-and-forth between HW and emulated to
  check that there are no spurious SIGILLs sent to userspace when the
  support level is changed.
- Arm64: armv8_deprecated: move aarch32 helper earlier. [Mark Rutland]

  commit 0c5f416219da3795dc8b33e5bb7865a6b3c4e55c upstream.

  Subsequent patches will rework the logic in armv8_deprecated.c.

  In preparation for subsequent changes, this patch moves some shared logic
  earlier in the file. This will make subsequent diffs simpler and easier to
  read.

  At the same time, drop the `__kprobes` annotation from
  aarch32_check_condition(), as this is only used for traps from compat
  userspace, and has no risk of recursion within kprobes. As this is the
  last kprobes annotation in armve8_deprecated.c, we no longer need to
  include <asm/kprobes.h>.
- Arm64: armv8_deprecated move emulation functions. [Mark Rutland]

  commit 25eeac0cfe7c97ade1be07340e11e7143aab57a6 upstream.

  Subsequent patches will rework the logic in armv8_deprecated.c.

  In preparation for subsequent changes, this patch moves the emulation
  logic earlier in the file, and moves the infrastructure later in the
  file. This will make subsequent diffs simpler and easier to read.

  This is purely a move. There should be no functional change as a result
  of this patch.
- Arm64: armv8_deprecated: fold ops into insn_emulation. [Mark Rutland]

  commit b4453cc8a7ebbd45436a8cd3ffeaa069ceac146f upstream.

  The code for emulating deprecated instructions has two related
  structures: struct insn_emulation_ops and struct insn_emulation, where
  each struct insn_emulation_ops is associated 1-1 with a struct
  insn_emulation.

  It would be simpler to combine the two into a single structure, removing
  the need for (unconditional) dynamic allocation at boot time, and
  simplifying some runtime pointer chasing.

  This patch merges the two structures together.

  There should be no functional change as a result of this patch.
- Arm64: rework EL0 MRS emulation. [Mark Rutland]

  commit f5962add74b61f8ae31c6311f75ca35d7e1d2d8f upstream.

  On CPUs without FEAT_IDST, ID register emulation is slower than it needs
  to be, as all threads contend for the same lock to perform the
  emulation. This patch reworks the emulation to avoid this unnecessary
  contention.

  On CPUs with FEAT_IDST (which is mandatory from ARMv8.4 onwards), EL0
  accesses to ID registers result in a SYS trap, and emulation of these is
  handled with a sys64_hook. These hooks are statically allocated, and no
  locking is required to iterate through the hooks and perform the
  emulation, allowing emulation to occur in parallel with no contention.

  On CPUs without FEAT_IDST, EL0 accesses to ID registers result in an
  UNDEFINED exception, and emulation of these accesses is handled with an
  undef_hook. When an EL0 MRS instruction is trapped to EL1, the kernel
  finds the relevant handler by iterating through all of the undef_hooks,
  requiring undef_lock to be held during this lookup.

  This locking is only required to safely traverse the list of undef_hooks
  (as it can be concurrently modified), and the actual emulation of the
  MRS does not require any mutual exclusion. This locking is an
  unfortunate bottleneck, especially given that MRS emulation is enabled
  unconditionally and is never disabled.

  This patch reworks the non-FEAT_IDST MRS emulation logic so that it can
  be invoked directly from do_el0_undef(). This removes the bottleneck,
  allowing MRS traps to be handled entirely in parallel, and is a stepping
  stone to making all of the undef_hooks lock-free.

  I've tested this in a 64-vCPU VM on a 64-CPU ThunderX2 host, with a
  benchmark which spawns a number of threads which each try to read
  ID_AA64ISAR0_EL1 1000000 times. This is vastly more contention than will
  ever be seen in realistic usage, but clearly demonstrates the removal of
  the bottleneck:

    | Threads || Time (seconds)                       |
    |         || Before           || After            |
    |         || Real   | System  || Real   | System  |
    |---------++--------+---------++--------+---------|
    |       1 ||   0.29 |    0.20 ||   0.24 |    0.12 |
    |       2 ||   0.35 |    0.51 ||   0.23 |    0.27 |
    |       4 ||   1.08 |    3.87 ||   0.24 |    0.56 |
    |       8 ||   4.31 |   33.60 ||   0.24 |    1.11 |
    |      16 ||   9.47 |  149.39 ||   0.23 |    2.15 |
    |      32 ||  19.07 |  605.27 ||   0.24 |    4.38 |
    |      64 ||  65.40 | 3609.09 ||   0.33 |   11.27 |

  Aside from the speedup, there should be no functional change as a result
  of this patch.
- Arm64: factor insn read out of call_undef_hook() [Mark Rutland]

  commit dbfbd87efa79575491af0ba1a87bf567eaea6cae upstream.

  Subsequent patches will rework EL0 UNDEF handling, removing the need for
  struct undef_hook and call_undef_hook. In preparation for those changes,
  this patch factors the logic for reading user instructions out of
  call_undef_hook() and into a new user_insn_read() helper, matching the
  style of the existing aarch64_insn_read() helper used for reading kernel
  instructions.

  There should be no functional change as a result of this patch.
- Arm64: factor out EL1 SSBS emulation hook. [Mark Rutland]

  commit bff8f413c71ffc3cb679dbd9a5632b33af563f9f upstream.

  Currently call_undef_hook() is used to handle UNDEFINED exceptions from
  EL0 and EL1. As support for deprecated instructions may be enabled
  independently, the handlers for individual instructions are organised as
  a linked list of struct undef_hook which can be manipulated dynamically.
  As this can be manipulated dynamically, the list is protected with a
  raw_spinlock which must be acquired when handling UNDEFINED exceptions
  or when manipulating the list of handlers.

  This locking is unfortunate as it serialises handling of UNDEFINED
  exceptions, and requires RCU to be enabled for lockdep, requiring the
  use of RCU_NONIDLE() in resume path of cpu_suspend() since commit:

    a2c42bbabbe260b7 ("arm64: spectre: Prevent lockdep splat on v4 mitigation enable path")

  The list of UNDEFINED handlers largely consist of handlers for
  exceptions taken from EL0, and the only handler for exceptions taken
  from EL1 handles `MSR SSBS, #imm` on CPUs which feature PSTATE.SSBS but
  lack the corresponding MSR (Immediate) instruction. Other than this we
  never expect to take an UNDEFINED exception from EL1 in normal
  operation.

  This patch reworks do_el0_undef() to invoke the EL1 SSBS handler
  directly, relegating call_undef_hook() to only handle EL0 UNDEFs. This
  removes redundant work to iterate the list for EL1 UNDEFs, and removes
  the need for locking, permitting EL1 UNDEFs to be handled in parallel
  without contention.

  The RCU_NONIDLE() call in cpu_suspend() will be removed in a subsequent
  patch, as there are other potential issues with the use of
  instrumentable code and RCU in the CPU suspend code.

  I've tested this by forcing the detection of SSBS on a CPU that doesn't
  have it, and verifying that the try_emulate_el1_ssbs() callback is
  invoked.
- Arm64: split EL0/EL1 UNDEF handlers. [Mark Rutland]

  commit 61d64a376ea80f9097e7ea599bcd68671b836dc6 upstream.

  In general, exceptions taken from EL1 need to be handled separately from
  exceptions taken from EL0, as the logic to handle the two cases can be
  significantly divergent, and exceptions taken from EL1 typically have
  more stringent requirements on locking and instrumentation.

  Subsequent patches will rework the way EL1 UNDEFs are handled in order
  to address longstanding soundness issues with instrumentation and RCU.
  In preparation for that rework, this patch splits the existing
  do_undefinstr() handler into separate do_el0_undef() and do_el1_undef()
  handlers.

  Prior to this patch, do_undefinstr() was marked with NOKPROBE_SYMBOL(),
  preventing instrumentation via kprobes. However, do_undefinstr() invokes
  other code which can be instrumented, and:

  * For UNDEFINED exceptions taken from EL0, there is no risk of recursion
    within kprobes. Therefore it is safe for do_el0_undef to be
    instrumented with kprobes, and it does not need to be marked with
    NOKPROBE_SYMBOL().

  * For UNDEFINED exceptions taken from EL1, either:

    (a) The exception is has been taken when manipulating SSBS; these cases
        are limited and do not occur within code that can be invoked
        recursively via kprobes. Hence, in these cases instrumentation
        with kprobes is benign.

    (b) The exception has been taken for an unknown reason, as other than
        manipulating SSBS we do not expect to take UNDEFINED exceptions
        from EL1. Any handling of these exception is best-effort.

    ... and in either case, marking do_el1_undef() with NOKPROBE_SYMBOL()
    isn't sufficient to prevent recursion via kprobes as functions it
    calls (including die()) are instrumentable via kprobes.

    Hence, it's not worthwhile to mark do_el1_undef() with
    NOKPROBE_SYMBOL(). The same applies to do_el1_bti() and do_el1_fpac(),
    so their NOKPROBE_SYMBOL() annotations are also removed.

  Aside from the new instrumentability, there should be no functional
  change as a result of this patch.
- Arm64: allow kprobes on EL0 handlers. [Mark Rutland]

  commit b3a0c010e900a9f89dcd99f10bd8f7538d21b0a9 upstream.

  Currently do_sysinstr() and do_cp15instr() are marked with
  NOKPROBE_SYMBOL(). However, these are only called for exceptions taken
  from EL0, and there is no risk of recursion in kprobes, so this is not
  necessary.

  Remove the NOKPROBE_SYMBOL() annotation, and rename the two functions to
  more clearly indicate that these are solely for exceptions taken from
  EL0, better matching the names used by the lower level entry points in
  entry-common.c.
- Arm64: rework BTI exception handling. [Mark Rutland]

  commit 830a2a4d853f2c4a1e4606aa03341b7f273b0e9b upstream.

  If a BTI exception is taken from EL1, the entry code will treat this as
  an unhandled exception and will panic() the kernel. This is inconsistent
  with the way we handle FPAC exceptions, which have a dedicated handler
  and only necessarily kill the thread from which the exception was taken
  from, and we don't log all the information that could be relevant to
  debug the issue.

  The code in do_bti() has:

  	BUG_ON(!user_mode(regs));

  ... and it seems like the intent was to call this for EL1 BTI
  exceptions, as with FPAC, but this was omitted due to an oversight.

  This patch adds separate EL0 and EL1 BTI exception handlers, with the
  latter calling die() directly to report the original context the BTI
  exception was taken from. This matches our handling of FPAC exceptions.

  Prior to this patch, a BTI failure is reported as:

  | Unhandled 64-bit el1h sync exception on CPU0, ESR 0x0000000034000002 -- BTI
  | CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.19.0-rc3-00131-g7d937ff0221d-dirty #9
  | Hardware name: linux,dummy-virt (DT)
  | pstate: 20400809 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=-c)
  | pc : test_bti_callee+0x4/0x10
  | lr : test_bti_caller+0x1c/0x28
  | sp : ffff80000800bdf0
  | x29: ffff80000800bdf0 x28: 0000000000000000 x27: 0000000000000000
  | x26: 0000000000000000 x25: 0000000000000000 x24: 0000000000000000
  | x23: ffff80000a2b8000 x22: 0000000000000000 x21: 0000000000000000
  | x20: ffff8000099fa5b0 x19: ffff800009ff7000 x18: fffffbfffda37000
  | x17: 3120676e696d7573 x16: 7361202c6e6f6974 x15: 0000000041a90000
  | x14: 0040000000000041 x13: 0040000000000001 x12: ffff000001a90000
  | x11: fffffbfffda37480 x10: 0068000000000703 x9 : 0001000040000000
  | x8 : 0000000000090000 x7 : 0068000000000f03 x6 : 0060000000000f83
  | x5 : ffff80000a2b6000 x4 : ffff0000028d0000 x3 : ffff800009f78378
  | x2 : 0000000000000000 x1 : 0000000040210000 x0 : ffff8000080257e4
  | Kernel panic - not syncing: Unhandled exception
  | CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.19.0-rc3-00131-g7d937ff0221d-dirty #9
  | Hardware name: linux,dummy-virt (DT)
  | Call trace:
  |  dump_backtrace.part.0+0xcc/0xe0
  |  show_stack+0x18/0x5c
  |  dump_stack_lvl+0x64/0x80
  |  dump_stack+0x18/0x34
  |  panic+0x170/0x360
  |  arm64_exit_nmi.isra.0+0x0/0x80
  |  el1h_64_sync_handler+0x64/0xd0
  |  el1h_64_sync+0x64/0x68
  |  test_bti_callee+0x4/0x10
  |  smp_cpus_done+0xb0/0xbc
  |  smp_init+0x7c/0x8c
  |  kernel_init_freeable+0x128/0x28c
  |  kernel_init+0x28/0x13c
  |  ret_from_fork+0x10/0x20

  With this patch applied, a BTI failure is reported as:

  | Internal error: Oops - BTI: 0000000034000002 [#1] PREEMPT SMP
  | Modules linked in:
  | CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.19.0-rc3-00132-g0ad98265d582-dirty #8
  | Hardware name: linux,dummy-virt (DT)
  | pstate: 20400809 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=-c)
  | pc : test_bti_callee+0x4/0x10
  | lr : test_bti_caller+0x1c/0x28
  | sp : ffff80000800bdf0
  | x29: ffff80000800bdf0 x28: 0000000000000000 x27: 0000000000000000
  | x26: 0000000000000000 x25: 0000000000000000 x24: 0000000000000000
  | x23: ffff80000a2b8000 x22: 0000000000000000 x21: 0000000000000000
  | x20: ffff8000099fa5b0 x19: ffff800009ff7000 x18: fffffbfffda37000
  | x17: 3120676e696d7573 x16: 7361202c6e6f6974 x15: 0000000041a90000
  | x14: 0040000000000041 x13: 0040000000000001 x12: ffff000001a90000
  | x11: fffffbfffda37480 x10: 0068000000000703 x9 : 0001000040000000
  | x8 : 0000000000090000 x7 : 0068000000000f03 x6 : 0060000000000f83
  | x5 : ffff80000a2b6000 x4 : ffff0000028d0000 x3 : ffff800009f78378
  | x2 : 0000000000000000 x1 : 0000000040210000 x0 : ffff800008025804
  | Call trace:
  |  test_bti_callee+0x4/0x10
  |  smp_cpus_done+0xb0/0xbc
  |  smp_init+0x7c/0x8c
  |  kernel_init_freeable+0x128/0x28c
  |  kernel_init+0x28/0x13c
  |  ret_from_fork+0x10/0x20
  | Code: d50323bf d53cd040 d65f03c0 d503233f (d50323bf)
- Arm64: rework FPAC exception handling. [Mark Rutland]

  commit a1fafa3b24a70461bbf3e5c0770893feb0a49292 upstream.

  If an FPAC exception is taken from EL1, the entry code will call
  do_ptrauth_fault(), where due to:

  	BUG_ON(!user_mode(regs))

  ... the kernel will report a problem within do_ptrauth_fault() rather
  than reporting the original context the FPAC exception was taken from.
  The pt_regs and ESR value reported will be from within
  do_ptrauth_fault() and the code dump will be for the BRK in BUG_ON(),
  which isn't sufficient to debug the cause of the original exception.

  This patch makes the reporting better by having separate EL0 and EL1
  FPAC exception handlers, with the latter calling die() directly to
  report the original context the FPAC exception was taken from.

  Note that we only need to prevent kprobes of the EL1 FPAC handler, since
  the EL0 FPAC handler cannot be called recursively.

  For consistency with do_el0_svc*(), I've named the split functions
  do_el{0,1}_fpac() rather than do_el{0,1}_ptrauth_fault(). I've also
  clarified the comment to not imply there are casues other than FPAC
  exceptions.

  Prior to this patch FPAC exceptions are reported as:

  | kernel BUG at arch/arm64/kernel/traps.c:517!
  | Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP
  | Modules linked in:
  | CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.19.0-rc3-00130-g9c8a180a1cdf-dirty #12
  | Hardware name: FVP Base RevC (DT)
  | pstate: 00400009 (nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  | pc : do_ptrauth_fault+0x3c/0x40
  | lr : el1_fpac+0x34/0x54
  | sp : ffff80000a3bbc80
  | x29: ffff80000a3bbc80 x28: ffff0008001d8000 x27: 0000000000000000
  | x26: 0000000000000000 x25: 0000000000000000 x24: 0000000000000000
  | x23: 0000000020400009 x22: ffff800008f70fa4 x21: ffff80000a3bbe00
  | x20: 0000000072000000 x19: ffff80000a3bbcb0 x18: fffffbfffda37000
  | x17: 3120676e696d7573 x16: 7361202c6e6f6974 x15: 0000000081a90000
  | x14: 0040000000000041 x13: 0040000000000001 x12: ffff000001a90000
  | x11: fffffbfffda37480 x10: 0068000000000703 x9 : 0001000080000000
  | x8 : 0000000000090000 x7 : 0068000000000f03 x6 : 0060000000000783
  | x5 : ffff80000a3bbcb0 x4 : ffff0008001d8000 x3 : 0000000072000000
  | x2 : 0000000000000000 x1 : 0000000020400009 x0 : ffff80000a3bbcb0
  | Call trace:
  |  do_ptrauth_fault+0x3c/0x40
  |  el1h_64_sync_handler+0xc4/0xd0
  |  el1h_64_sync+0x64/0x68
  |  test_pac+0x8/0x10
  |  smp_init+0x7c/0x8c
  |  kernel_init_freeable+0x128/0x28c
  |  kernel_init+0x28/0x13c
  |  ret_from_fork+0x10/0x20
  | Code: 97fffe5e a8c17bfd d50323bf d65f03c0 (d4210000)

  With this patch applied FPAC exceptions are reported as:

  | Internal error: Oops - FPAC: 0000000072000000 [#1] PREEMPT SMP
  | Modules linked in:
  | CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.19.0-rc3-00132-g78846e1c4757-dirty #11
  | Hardware name: FVP Base RevC (DT)
  | pstate: 20400009 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  | pc : test_pac+0x8/0x10
  | lr : 0x0
  | sp : ffff80000a3bbe00
  | x29: ffff80000a3bbe00 x28: 0000000000000000 x27: 0000000000000000
  | x26: 0000000000000000 x25: 0000000000000000 x24: 0000000000000000
  | x23: ffff80000a2c8000 x22: 0000000000000000 x21: 0000000000000000
  | x20: ffff8000099fa5b0 x19: ffff80000a007000 x18: fffffbfffda37000
  | x17: 3120676e696d7573 x16: 7361202c6e6f6974 x15: 0000000081a90000
  | x14: 0040000000000041 x13: 0040000000000001 x12: ffff000001a90000
  | x11: fffffbfffda37480 x10: 0068000000000703 x9 : 0001000080000000
  | x8 : 0000000000090000 x7 : 0068000000000f03 x6 : 0060000000000783
  | x5 : ffff80000a2c6000 x4 : ffff0008001d8000 x3 : ffff800009f88378
  | x2 : 0000000000000000 x1 : 0000000080210000 x0 : ffff000001a90000
  | Call trace:
  |  test_pac+0x8/0x10
  |  smp_init+0x7c/0x8c
  |  kernel_init_freeable+0x128/0x28c
  |  kernel_init+0x28/0x13c
  |  ret_from_fork+0x10/0x20
  | Code: d50323bf d65f03c0 d503233f aa1f03fe (d50323bf)
- Arm64: consistently pass ESR_ELx to die() [Mark Rutland]

  commit 0f2cb928a1547ae8f89e80a4b8df2c6c02ae5f96 upstream.

  Currently, bug_handler() and kasan_handler() call die() with '0' as the
  'err' value, whereas die_kernel_fault() passes the ESR_ELx value.

  For consistency, this patch ensures we always pass the ESR_ELx value to
  die(). As this is only called for exceptions taken from kernel mode,
  there should be no user-visible change as a result of this patch.

  For UNDEFINED exceptions, I've had to modify do_undefinstr() and its
  callers to pass the ESR_ELx value. In all cases the ESR_ELx value had
  already been read and was available.
- Arm64: die(): pass 'err' as long. [Mark Rutland]

  commit 18906ff9af6517c20763ed63dab602a4150794f7 upstream.

  Recently, we reworked a lot of code to consistentlt pass ESR_ELx as a
  64-bit quantity. However, we missed that this can be passed into die()
  and __die() as the 'err' parameter where it is truncated to a 32-bit
  int.

  As notify_die() already takes 'err' as a long, this patch changes die()
  and __die() to also take 'err' as a long, ensuring that the full value
  of ESR_ELx is retained.

  At the same time, die() is updated to consistently log 'err' as a
  zero-padded 64-bit quantity.

  Subsequent patches will pass the ESR_ELx value to die() for a number of
  exceptions.
- Arm64: report EL1 UNDEFs better. [Mark Rutland]

  commit b502c87d2a26c349acbc231ff2acd6f17147926b upstream.

  If an UNDEFINED exception is taken from EL1, and do_undefinstr() doesn't
  find any suitable undef_hook, it will call:

  	BUG_ON(!user_mode(regs))

  ... and the kernel will report a failure witin do_undefinstr() rather
  than reporting the original context that the UNDEFINED exception was
  taken from. The pt_regs and ESR value reported within the BUG() handler
  will be from within do_undefinstr() and the code dump will be for the
  BRK in BUG_ON(), which isn't sufficient to debug the cause of the
  original exception.

  This patch makes the reporting better by having do_undefinstr() call
  die() directly in this case to report the original context from which
  the UNDEFINED exception was taken.

  Prior to this patch, an undefined instruction is reported as:

  | kernel BUG at arch/arm64/kernel/traps.c:497!
  | Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
  | Modules linked in:
  | CPU: 0 PID: 0 Comm: swapper Not tainted 5.19.0-rc3-00127-geff044f1b04e-dirty #3
  | Hardware name: linux,dummy-virt (DT)
  | pstate: 000000c5 (nzcv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  | pc : do_undefinstr+0x28c/0x2ac
  | lr : do_undefinstr+0x298/0x2ac
  | sp : ffff800009f63bc0
  | x29: ffff800009f63bc0 x28: ffff800009f73c00 x27: ffff800009644a70
  | x26: ffff8000096778a8 x25: 0000000000000040 x24: 0000000000000000
  | x23: 00000000800000c5 x22: ffff800009894060 x21: ffff800009f63d90
  | x20: 0000000000000000 x19: ffff800009f63c40 x18: 0000000000000006
  | x17: 0000000000403000 x16: 00000000bfbfd000 x15: ffff800009f63830
  | x14: ffffffffffffffff x13: 0000000000000000 x12: 0000000000000019
  | x11: 0101010101010101 x10: 0000000000161b98 x9 : 0000000000000000
  | x8 : 0000000000000000 x7 : 0000000000000000 x6 : 0000000000000000
  | x5 : ffff800009f761d0 x4 : 0000000000000000 x3 : ffff80000a2b80f8
  | x2 : 0000000000000000 x1 : ffff800009f73c00 x0 : 00000000800000c5
  | Call trace:
  |  do_undefinstr+0x28c/0x2ac
  |  el1_undef+0x2c/0x4c
  |  el1h_64_sync_handler+0x84/0xd0
  |  el1h_64_sync+0x64/0x68
  |  setup_arch+0x550/0x598
  |  start_kernel+0x88/0x6ac
  |  __primary_switched+0xb8/0xc0
  | Code: 17ffff95 a9425bf5 17ffffb8 a9025bf5 (d4210000)

  With this patch applied, an undefined instruction is reported as:

  | Internal error: Oops - Undefined instruction: 0 [#1] PREEMPT SMP
  | Modules linked in:
  | CPU: 0 PID: 0 Comm: swapper Not tainted 5.19.0-rc3-00128-gf27cfcc80e52-dirty #5
  | Hardware name: linux,dummy-virt (DT)
  | pstate: 800000c5 (Nzcv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  | pc : setup_arch+0x550/0x598
  | lr : setup_arch+0x50c/0x598
  | sp : ffff800009f63d90
  | x29: ffff800009f63d90 x28: 0000000081000200 x27: ffff800009644a70
  | x26: ffff8000096778c8 x25: 0000000000000040 x24: 0000000000000000
  | x23: 0000000000000100 x22: ffff800009f69a58 x21: ffff80000a2b80b8
  | x20: 0000000000000000 x19: 0000000000000000 x18: 0000000000000006
  | x17: 0000000000403000 x16: 00000000bfbfd000 x15: ffff800009f63830
  | x14: ffffffffffffffff x13: 0000000000000000 x12: 0000000000000019
  | x11: 0101010101010101 x10: 0000000000161b98 x9 : 0000000000000000
  | x8 : 0000000000000000 x7 : 0000000000000000 x6 : 0000000000000000
  | x5 : 0000000000000008 x4 : 0000000000000010 x3 : 0000000000000000
  | x2 : 0000000000000000 x1 : 0000000000000000 x0 : 0000000000000000
  | Call trace:
  |  setup_arch+0x550/0x598
  |  start_kernel+0x88/0x6ac
  |  __primary_switched+0xb8/0xc0
  | Code: b4000080 90ffed80 912ac000 97db745f (00000000)
- X86/alternatives: Disable KASAN in apply_alternatives() [Kirill A.
  Shutemov]

  commit d35652a5fc9944784f6f50a5c979518ff8dacf61 upstream.

  Fei has reported that KASAN triggers during apply_alternatives() on
  a 5-level paging machine:

  	BUG: KASAN: out-of-bounds in rcu_is_watching()
  	Read of size 4 at addr ff110003ee6419a0 by task swapper/0/0
  	...
  	__asan_load4()
  	rcu_is_watching()
  	trace_hardirqs_on()
  	text_poke_early()
  	apply_alternatives()
  	...

  On machines with 5-level paging, cpu_feature_enabled(X86_FEATURE_LA57)
  gets patched. It includes KASAN code, where KASAN_SHADOW_START depends on
  __VIRTUAL_MASK_SHIFT, which is defined with cpu_feature_enabled().

  KASAN gets confused when apply_alternatives() patches the
  KASAN_SHADOW_START users. A test patch that makes KASAN_SHADOW_START
  static, by replacing __VIRTUAL_MASK_SHIFT with 56, works around the issue.

  Fix it for real by disabling KASAN while the kernel is patching alternatives.

  [ mingo: updated the changelog ]
- Powerpc/64e: Fix wrong test in __ptep_test_and_clear_young()
  [Christophe Leroy]

  [ Upstream commit 5ea0bbaa32e8f54e9a57cfee4a3b8769b80be0d2 ]

  Commit 45201c879469 ("powerpc/nohash: Remove hash related code from
  nohash headers.") replaced:

    if ((pte_val(*ptep) & (_PAGE_ACCESSED | _PAGE_HASHPTE)) == 0)
  	return 0;

  By:

    if (pte_young(*ptep))
  	return 0;

  But it should be:

    if (!pte_young(*ptep))
  	return 0;

  Fix it.
- Powerpc/8xx: Fix pte_access_permitted() for PAGE_NONE. [Christophe
  Leroy]

  [ Upstream commit 5d9cea8a552ee122e21fbd5a3c5d4eb85f648e06 ]

  On 8xx, PAGE_NONE is handled by setting _PAGE_NA instead of clearing
  _PAGE_USER.

  But then pte_user() returns 1 also for PAGE_NONE.

  As _PAGE_NA prevent reads, add a specific version of pte_read()
  that returns 0 when _PAGE_NA is set instead of always returning 1.
- Dmaengine: mediatek: Fix deadlock caused by synchronize_irq() [Duoming
  Zhou]

  [ Upstream commit 01f1ae2733e2bb4de92fefcea5fda847d92aede1 ]

  The synchronize_irq(c->irq) will not return until the IRQ handler
  mtk_uart_apdma_irq_handler() is completed. If the synchronize_irq()
  holds a spin_lock and waits the IRQ handler to complete, but the
  IRQ handler also needs the same spin_lock. The deadlock will happen.
  The process is shown below:

            cpu0                        cpu1
  mtk_uart_apdma_device_pause() | mtk_uart_apdma_irq_handler()
    spin_lock_irqsave()         |
                                |   spin_lock_irqsave()
    //hold the lock to wait     |
    synchronize_irq()           |

  This patch reorders the synchronize_irq(c->irq) outside the spin_lock
  in order to mitigate the bug.
- Usb: gadget: ncm: Handle decoding of multiple NTB's in unwrap call.
  [Krishna Kurapati]

  commit 427694cfaafa565a3db5c5ea71df6bc095dca92f upstream.

  When NCM is used with hosts like Windows PC, it is observed that there are
  multiple NTB's contained in one usb request giveback. Since the driver
  unwraps the obtained request data assuming only one NTB is present, we
  loose the subsequent NTB's present resulting in data loss.

  Fix this by checking the parsed block length with the obtained data
  length in usb request and continue parsing after the last byte of current
  NTB.
- Usb: gadget: udc-xilinx: replace memcpy with memcpy_toio. [Piyush
  Mehta]

  commit 3061b6491f491197a35e14e49f805d661b02acd4 upstream.

  For ARM processor, unaligned access to device memory is not allowed.
  Method memcpy does not take care of alignment.

  USB detection failure with the unalingned address of memory, with
  below kernel crash. To fix the unalingned address kernel panic,
  replace memcpy with memcpy_toio method.

  Kernel crash:
  Unable to handle kernel paging request at virtual address ffff80000c05008a
  Mem abort info:
    ESR = 0x96000061
    EC = 0x25: DABT (current EL), IL = 32 bits
    SET = 0, FnV = 0
    EA = 0, S1PTW = 0
    FSC = 0x21: alignment fault
  Data abort info:
    ISV = 0, ISS = 0x00000061
    CM = 0, WnR = 1
  swapper pgtable: 4k pages, 48-bit VAs, pgdp=000000000143b000
  [ffff80000c05008a] pgd=100000087ffff003, p4d=100000087ffff003,
  pud=100000087fffe003, pmd=1000000800bcc003, pte=00680000a0010713
  Internal error: Oops: 96000061 [#1] SMP
  Modules linked in:
  CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.15.19-xilinx-v2022.1 #1
  Hardware name: ZynqMP ZCU102 Rev1.0 (DT)
  pstate: 200000c5 (nzCv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
  pc : __memcpy+0x30/0x260
  lr : __xudc_ep0_queue+0xf0/0x110
  sp : ffff800008003d00
  x29: ffff800008003d00 x28: ffff800009474e80 x27: 00000000000000a0
  x26: 0000000000000100 x25: 0000000000000012 x24: ffff000800bc8080
  x23: 0000000000000001 x22: 0000000000000012 x21: ffff000800bc8080
  x20: 0000000000000012 x19: ffff000800bc8080 x18: 0000000000000000
  x17: ffff800876482000 x16: ffff800008004000 x15: 0000000000004000
  x14: 00001f09785d0400 x13: 0103020101005567 x12: 0781400000000200
  x11: 00000000c5672a10 x10: 00000000000008d0 x9 : ffff800009463cf0
  x8 : ffff8000094757b0 x7 : 0201010055670781 x6 : 4000000002000112
  x5 : ffff80000c05009a x4 : ffff000800a15012 x3 : ffff00080362ad80
  x2 : 0000000000000012 x1 : ffff000800a15000 x0 : ffff80000c050088
  Call trace:
   __memcpy+0x30/0x260
   xudc_ep0_queue+0x3c/0x60
   usb_ep_queue+0x38/0x44
   composite_ep0_queue.constprop.0+0x2c/0xc0
   composite_setup+0x8d0/0x185c
   configfs_composite_setup+0x74/0xb0
   xudc_irq+0x570/0xa40
   __handle_irq_event_percpu+0x58/0x170
   handle_irq_event+0x60/0x120
   handle_fasteoi_irq+0xc0/0x220
   handle_domain_irq+0x60/0x90
   gic_handle_irq+0x74/0xa0
   call_on_irq_stack+0x2c/0x60
   do_interrupt_handler+0x54/0x60
   el1_interrupt+0x30/0x50
   el1h_64_irq_handler+0x18/0x24
   el1h_64_irq+0x78/0x7c
   arch_cpu_idle+0x18/0x2c
   do_idle+0xdc/0x15c
   cpu_startup_entry+0x28/0x60
   rest_init+0xc8/0xe0
   arch_call_rest_init+0x10/0x1c
   start_kernel+0x694/0x6d4
   __primary_switched+0xa4/0xac
- Counter: microchip-tcb-capture: Fix the use of internal GCLK logic.
  [Dharma Balasubiramani]

  commit df8fdd01c98b99d04915c04f3a5ce73f55456b7c upstream.

  As per the datasheet, the clock selection Bits 2:0 – TCCLKS[2:0] should
  be set to 0 while using the internal GCLK (TIMER_CLOCK1).
- Pinctrl: avoid unsafe code pattern in find_pinctrl() [Dmitry Torokhov]

  commit c153a4edff6ab01370fcac8e46f9c89cca1060c2 upstream.

  The code in find_pinctrl() takes a mutex and traverses a list of pinctrl
  structures. Later the caller bumps up reference count on the found
  structure. Such pattern is not safe as pinctrl that was found may get
  deleted before the caller gets around to increasing the reference count.

  Fix this by taking the reference count in find_pinctrl(), while it still
  holds the mutex.
- Cgroup: Remove duplicates in cgroup v1 tasks file. [Michal Koutný]

  commit 1ca0b605150501b7dc59f3016271da4eb3e96fce upstream.

  One PID may appear multiple times in a preloaded pidlist.
  (Possibly due to PID recycling but we have reports of the same
  task_struct appearing with different PIDs, thus possibly involving
  transfer of PID via de_thread().)

  Because v1 seq_file iterator uses PIDs as position, it leads to
  a message:
  > seq_file: buggy .next function kernfs_seq_next did not update position index

  Conservative and quick fix consists of removing duplicates from `tasks`
  file (as opposed to removing pidlists altogether). It doesn't affect
  correctness (it's sufficient to show a PID once), performance impact
  would be hidden by unconditional sorting of the pidlist already in place
  (asymptotically).
- Tee: amdtee: fix use-after-free vulnerability in amdtee_close_session.
  [Rijo Thomas]

  commit f4384b3e54ea813868bb81a861bf5b2406e15d8f upstream.

  There is a potential race condition in amdtee_close_session that may
  cause use-after-free in amdtee_open_session. For instance, if a session
  has refcount == 1, and one thread tries to free this session via:

      kref_put(&sess->refcount, destroy_session);

  the reference count will get decremented, and the next step would be to
  call destroy_session(). However, if in another thread,
  amdtee_open_session() is called before destroy_session() has completed
  execution, alloc_session() may return 'sess' that will be freed up
  later in destroy_session() leading to use-after-free in
  amdtee_open_session.

  To fix this issue, treat decrement of sess->refcount and removal of
  'sess' from session list in destroy_session() as a critical section, so
  that it is executed atomically.
- Input: goodix - ensure int GPIO is in input for gpio_count == 1 &&
  gpio_int_idx == 0 case. [Hans de Goede]

  commit 423622a90abb243944d1517b9f57db53729e45c4 upstream.

  Add a special case for gpio_count == 1 && gpio_int_idx == 0 to
  goodix_add_acpi_gpio_mappings().

  It seems that on newer x86/ACPI devices the reset and irq GPIOs are no
  longer listed as GPIO resources instead there is only 1 GpioInt resource
  and _PS0 does the whole reset sequence for us.

  This means that we must call acpi_device_fix_up_power() on these devices
  to ensure that the chip is reset before we try to use it.

  This part was already fixed in commit 3de93e6ed2df ("Input: goodix - call
  acpi_device_fix_up_power() in some cases") by adding a call to
  acpi_device_fix_up_power() to the generic "Unexpected ACPI resources"
  catch all.

  But it turns out that this case on some hw needs some more special
  handling. Specifically the firmware may bootup with the IRQ pin in
  output mode. The reset sequence from ACPI _PS0 (executed by
  acpi_device_fix_up_power()) should put the pin in input mode,
  but the GPIO subsystem has cached the direction at bootup, causing
  request_irq() to fail due to gpiochip_lock_as_irq() failure:

  [    9.119864] Goodix-TS i2c-GDIX1002:00: Unexpected ACPI resources: gpio_count 1, gpio_int_idx 0
  [    9.317443] Goodix-TS i2c-GDIX1002:00: ID 911, version: 1060
  [    9.321902] input: Goodix Capacitive TouchScreen as /devices/pci0000:00/0000:00:17.0/i2c_designware.4/i2c-5/i2c-GDIX1002:00/input/input8
  [    9.327840] gpio gpiochip0: (INT3453:00): gpiochip_lock_as_irq: tried to flag a GPIO set as output for IRQ
  [    9.327856] gpio gpiochip0: (INT3453:00): unable to lock HW IRQ 26 for IRQ
  [    9.327861] genirq: Failed to request resources for GDIX1002:00 (irq 131) on irqchip intel-gpio
  [    9.327912] Goodix-TS i2c-GDIX1002:00: request IRQ failed: -5

  Fix this by adding a special case for gpio_count == 1 && gpio_int_idx == 0
  which adds an ACPI GPIO lookup table for the int GPIO even though we cannot
  use it for reset purposes (as there is no reset GPIO).

  Adding the lookup will make the gpiod_int = gpiod_get(..., GPIOD_IN) call
  succeed, which will explicitly set the direction to input fixing the issue.

  Note this re-uses the acpi_goodix_int_first_gpios[] lookup table, since
  there is only 1 GPIO in the ACPI resources the reset entry in that
  lookup table will amount to a no-op.
- Input: i8042 - add Fujitsu Lifebook E5411 to i8042 quirk table.
  [Szilard Fabian]

  commit 80f39e1c27ba9e5a1ea7e68e21c569c9d8e46062 upstream.

  In the initial boot stage the integrated keyboard of Fujitsu Lifebook E5411
  refuses to work and it's not possible to type for example a dm-crypt
  passphrase without the help of an external keyboard.

  i8042.nomux kernel parameter resolves this issue but using that a PS/2
  mouse is detected. This input device is unused even when the i2c-hid-acpi
  kernel module is blacklisted making the integrated ELAN touchpad
  (04F3:308A) not working at all.

  Since the integrated touchpad is managed by the i2c_designware input
  driver in the Linux kernel and you can't find a PS/2 mouse port on the
  computer I think it's safe to not use the PS/2 mouse port at all.
- Input: xpad - add PXN V900 support. [Matthias Berndt]

  commit a65cd7ef5a864bdbbe037267c327786b7759d4c6 upstream.

  Add VID and PID to the xpad_device table to allow driver to use the PXN
  V900 steering wheel, which is XTYPE_XBOX360 compatible in xinput mode.
- Input: psmouse - fix fast_reconnect function for PS/2 mode. [Jeffery
  Miller]

  commit e2cb5cc822b6c9ee72c56ce1d81671b22c05406a upstream.

  When the SMBus connection is attempted psmouse_smbus_init() sets
  the fast_reconnect pointer to psmouse_smbus_reconnecti(). If SMBus
  initialization fails, elantech_setup_ps2() and synaptics_init_ps2() will
  fallback to PS/2 mode, replacing the psmouse private data. This can cause
  issues on resume, since psmouse_smbus_reconnect() expects to find an
  instance of struct psmouse_smbus_dev in psmouse->private.

  The issue was uncovered when in 92e24e0e57f7 ("Input: psmouse - add
  delay when deactivating for SMBus mode") psmouse_smbus_reconnect()
  started attempting to use more of the data structure. The commit was
  since reverted, not because it was at fault, but because there was found
  a better way of doing what it was attempting to do.

  Fix the problem by resetting the fast_reconnect pointer in psmouse
  structure in elantech_setup_ps2() and synaptics_init_ps2() when the PS/2
  mode is used.
- Input: powermate - fix use-after-free in powermate_config_complete.
  [Javier Carrasco]

  commit 5c15c60e7be615f05a45cd905093a54b11f461bc upstream.

  syzbot has found a use-after-free bug [1] in the powermate driver. This
  happens when the device is disconnected, which leads to a memory free from
  the powermate_device struct.  When an asynchronous control message
  completes after the kfree and its callback is invoked, the lock does not
  exist anymore and hence the bug.

  Use usb_kill_urb() on pm->config to cancel any in-progress requests upon
  device disconnection.

  [1] https://syzkaller.appspot.com/bug?extid=0434ac83f907a1dbdd1e
- Ceph: fix type promotion bug on 32bit systems. [Dan Carpenter]

  commit 07bb00ef00ace88dd6f695fadbba76565756e55c upstream.

  In this code "ret" is type long and "src_objlen" is unsigned int.  The
  problem is that on 32bit systems, when we do the comparison signed longs
  are type promoted to unsigned int.  So negative error codes from
  do_splice_direct() are treated as success instead of failure.
- Ceph: fix incorrect revoked caps assert in ceph_fill_file_size()
  [Xiubo Li]

  commit 15c0a870dc44ed14e01efbdd319d232234ee639f upstream.

  When truncating the inode the MDS will acquire the xlock for the
  ifile Locker, which will revoke the 'Frwsxl' caps from the clients.
  But when the client just releases and flushes the 'Fw' caps to MDS,
  for exmaple, and once the MDS receives the caps flushing msg it
  just thought the revocation has finished. Then the MDS will continue
  truncating the inode and then issued the truncate notification to
  all the clients. While just before the clients receives the cap
  flushing ack they receive the truncation notification, the clients
  will detecte that the 'issued | dirty' is still holding the 'Fw'
  caps.
- Libceph: use kernel_connect() [Jordan Rife]

  commit 7563cf17dce0a875ba3d872acdc63a78ea344019 upstream.

  Direct calls to ops->connect() can overwrite the address parameter when
  used in conjunction with BPF SOCK_ADDR hooks. Recent changes to
  kernel_connect() ensure that callers are insulated from such side
  effects. This patch wraps the direct call to ops->connect() with
  kernel_connect() to prevent unexpected changes to the address passed to
  ceph_tcp_connect().

  This change was originally part of a larger patch targeting the net tree
  addressing all instances of unprotected calls to ops->connect()
  throughout the kernel, but this change was split up into several patches
  targeting various trees.
- Thunderbolt: Check that lane 1 is in CL0 before enabling lane bonding.
  [Mika Westerberg]

  commit a9fdf5f933a6f2b358fad0194b1287b67f6704b1 upstream.

  Marek reported that when BlackMagic UltraStudio device is connected the
  kernel repeatedly tries to enable lane bonding without success making
  the device non-functional. It looks like the device does not have lane 1
  connected at all so even though it is enabled we should not try to bond
  the lanes. For this reason check that lane 1 is in fact CL0 (connected,
  active) before attempting to bond the lanes.
- Mcb: remove is_added flag from mcb_device struct. [Jorge Sanjuan
  Garcia]

  commit 0f28ada1fbf0054557cddcdb93ad17f767105208 upstream.

  When calling mcb_bus_add_devices(), both mcb devices and the mcb
  bus will attempt to attach a device to a driver because they share
  the same bus_type. This causes an issue when trying to cast the
  container of the device to mcb_device struct using to_mcb_device(),
  leading to a wrong cast when the mcb_bus is added. A crash occurs
  when freing the ida resources as the bus numbering of mcb_bus gets
  confused with the is_added flag on the mcb_device struct.

  The only reason for this cast was to keep an is_added flag on the
  mcb_device struct that does not seem necessary. The function
  device_attach() handles already bound devices and the mcb subsystem
  does nothing special with this is_added flag so remove it completely.
- X86/cpu: Fix AMD erratum #1485 on Zen4-based CPUs. [Borislav Petkov
  (AMD)]

  commit f454b18e07f518bcd0c05af17a2239138bff52de upstream.

  Fix erratum #1485 on Zen4 parts where running with STIBP disabled can
  cause an #UD exception. The performance impact of the fix is negligible.
- Iio: pressure: ms5611: ms5611_prom_is_valid false negative bug.
  [Alexander Zangerl]

  commit fd39d9668f2ce9f4b05ad55e8c8d80c098073e0b upstream.

  The ms5611 driver falsely rejects lots of MS5607-02BA03-50 chips
  with "PROM integrity check failed" because it doesn't accept a prom crc
  value of zero as legitimate.

  According to the datasheet for this chip (and the manufacturer's
  application note about the PROM CRC), none of the possible values for the
  CRC are excluded - but the current code in ms5611_prom_is_valid() ends with

  return crc_orig != 0x0000 && crc == crc_orig

  Discussed with the driver author (Tomasz Duszynski) and he indicated that
  at that time (2015) he was dealing with some faulty chip samples which
  returned blank data under some circumstances and/or followed example code
  which indicated CRC zero being bad.

  As far as I can tell this exception should not be applied anymore; We've
  got a few hundred custom boards here with this chip where large numbers
  of the prom have a legitimate CRC value 0, and do work fine, but which the
  current driver code wrongly rejects.
- Iio: pressure: dps310: Adjust Timeout Settings. [Lakshmi Yadlapati]

  commit 901a293fd96fb9bab843ba4cc7be3094a5aa7c94 upstream.

  The DPS310 sensor chip has been encountering intermittent errors while
  reading the sensor device across various system designs. This issue causes
  the chip to become "stuck," preventing the indication of "ready" status
  for pressure and temperature measurements in the MEAS_CFG register.

  To address this issue, this commit fixes the timeout settings to improve
  sensor stability:
  - After sending a reset command to the chip, the timeout has been extended
    from 2.5 ms to 15 ms, aligning with the DPS310 specification.
  - The read timeout value of the MEAS_CFG register has been adjusted from
    20ms to 30ms to match the specification.
- Iio: pressure: bmp280: Fix NULL pointer exception. [Phil Elwell]

  commit 85dfb43bf69281adb1f345dfd9a39faf2e5a718d upstream.

  The bmp085 EOC IRQ support is optional, but the driver's common probe
  function queries the IRQ properties whether or not it exists, which
  can trigger a NULL pointer exception. Avoid any exception by making
  the query conditional on the possession of a valid IRQ.
- Usb: musb: Modify the "HWVers" register address. [Xingxing Luo]

  commit 6658a62e1ddf726483cb2d8bf45ea3f9bd533074 upstream.

  musb HWVers rgister address is not 0x69, if we operate the
  wrong address 0x69, it will cause a kernel crash, because
  there is no register corresponding to this address in the
  additional control register of musb. In fact, HWVers has
  been defined in musb_register.h, and the name is
  "MUSB_HWVERS", so We need to use this macro instead of 0x69.
- Usb: musb: Get the musb_qh poniter after musb_giveback. [Xingxing Luo]

  commit 33d7e37232155aadebe4145dcc592f00dabd7a2b upstream.

  When multiple threads are performing USB transmission, musb->lock will be
  unlocked when musb_giveback is executed. At this time, qh may be released
  in the dequeue process in other threads, resulting in a wild pointer, so
  it needs to be here get qh again, and judge whether qh is NULL, and when
  dequeue, you need to set qh to NULL.
- Usb: dwc3: Soft reset phy on probe for host. [Thinh Nguyen]

  commit 8bea147dfdf823eaa8d3baeccc7aeb041b41944b upstream.

  When there's phy initialization, we need to initiate a soft-reset
  sequence. That's done through USBCMD.HCRST in the xHCI driver and its
  initialization, However, the dwc3 driver may modify core configs before
  the soft-reset. This may result in some connection instability. So,
  ensure the phy is ready before the controller updates the GCTL.PRTCAPDIR
  or other settings by issuing phy soft-reset.

  Note that some host-mode configurations may not expose device registers
  to initiate the controller soft-reset (via DCTL.CoreSftRst). So we reset
  through GUSB3PIPECTL and GUSB2PHYCFG instead.
- Net: usb: dm9601: fix uninitialized variable use in dm9601_mdio_read.
  [Javier Carrasco]

  commit 8f8abb863fa5a4cc18955c6a0e17af0ded3e4a76 upstream.

  syzbot has found an uninit-value bug triggered by the dm9601 driver [1].

  This error happens because the variable res is not updated if the call
  to dm_read_shared_word returns an error. In this particular case -EPROTO
  was returned and res stayed uninitialized.

  This can be avoided by checking the return value of dm_read_shared_word
  and propagating the error if the read operation failed.

  [1] https://syzkaller.appspot.com/bug?extid=1f53a30781af65d2c955
- Usb: xhci: xhci-ring: Use sysdev for mapping bounce buffer. [Wesley
  Cheng]

  commit 41a43013d2366db5b88b42bbcd8e8f040b6ccf21 upstream.

  As mentioned in:
    commit 474ed23a6257 ("xhci: align the last trb before link if it is
  easily splittable.")

  A bounce buffer is utilized for ensuring that transfers that span across
  ring segments are aligned to the EP's max packet size.  However, the device
  that is used to map the DMA buffer to is currently using the XHCI HCD,
  which does not carry any DMA operations in certain configrations.
  Migration to using the sysdev entry was introduced for DWC3 based
  implementations where the IOMMU operations are present.

  Replace the reference to the controller device to sysdev instead.  This
  allows the bounce buffer to be properly mapped to any implementations that
  have an IOMMU involved.

  cc: stable@vger.kernel.org
- Dmaengine: stm32-mdma: abort resume if no ongoing transfer. [Amelie
  Delaunay]

  commit 81337b9a72dc58a5fa0ae8a042e8cb59f9bdec4a upstream.

  chan->desc can be null, if transfer is terminated when resume is called,
  leading to a NULL pointer when retrieving the hwdesc.
  To avoid this case, check that chan->desc is not null and channel is
  disabled (transfer previously paused or terminated).
- Media: mtk-jpeg: Fix use after free bug due to uncanceled work. [Zheng
  Wang]

  commit c677d7ae83141d390d1253abebafa49c962afb52 upstream.

  In mtk_jpeg_probe, &jpeg->job_timeout_work is bound with
  mtk_jpeg_job_timeout_work. Then mtk_jpeg_dec_device_run
  and mtk_jpeg_enc_device_run may be called to start the
  work.
  If we remove the module which will call mtk_jpeg_remove
  to make cleanup, there may be a unfinished work. The
  possible sequence is as follows, which will cause a
  typical UAF bug.

  Fix it by canceling the work before cleanup in the mtk_jpeg_remove

  CPU0                  CPU1

                      |mtk_jpeg_job_timeout_work
  mtk_jpeg_remove     |
    v4l2_m2m_release  |
      kfree(m2m_dev); |
                      |
                      | v4l2_m2m_get_curr_priv
                      |   m2m_dev->curr_ctx //use
- Net: release reference to inet6_dev pointer. [Patrick Rohr]

  commit 5cb249686e67dbef3ffe53887fa725eefc5a7144 upstream.

  addrconf_prefix_rcv returned early without releasing the inet6_dev
  pointer when the PIO lifetime is less than accept_ra_min_lft.
- Net: change accept_ra_min_rtr_lft to affect all RA lifetimes. [Patrick
  Rohr]

  commit 5027d54a9c30bc7ec808360378e2b4753f053f25 upstream.

  accept_ra_min_rtr_lft only considered the lifetime of the default route
  and discarded entire RAs accordingly.

  This change renames accept_ra_min_rtr_lft to accept_ra_min_lft, and
  applies the value to individual RA sections; in particular, router
  lifetime, PIO preferred lifetime, and RIO lifetime. If any of those
  lifetimes are lower than the configured value, the specific RA section
  is ignored.

  In order for the sysctl to be useful to Android, it should really apply
  to all lifetimes in the RA, since that is what determines the minimum
  frequency at which RAs must be processed by the kernel. Android uses
  hardware offloads to drop RAs for a fraction of the minimum of all
  lifetimes present in the RA (some networks have very frequent RAs (5s)
  with high lifetimes (2h)). Despite this, we have encountered networks
  that set the router lifetime to 30s which results in very frequent CPU
  wakeups. Instead of disabling IPv6 (and dropping IPv6 ethertype in the
  WiFi firmware) entirely on such networks, it seems better to ignore the
  misconfigured routers while still processing RAs from other IPv6 routers
  on the same network (i.e. to support IoT applications).

  The previous implementation dropped the entire RA based on router
  lifetime. This turned out to be hard to expand to the other lifetimes
  present in the RA in a consistent manner; dropping the entire RA based
  on RIO/PIO lifetimes would essentially require parsing the whole thing
  twice.
- Net: add sysctl accept_ra_min_rtr_lft. [Patrick Rohr]

  commit 1671bcfd76fdc0b9e65153cf759153083755fe4c upstream.

  This change adds a new sysctl accept_ra_min_rtr_lft to specify the
  minimum acceptable router lifetime in an RA. If the received RA router
  lifetime is less than the configured value (and not 0), the RA is
  ignored.
  This is useful for mobile devices, whose battery life can be impacted
  by networks that configure RAs with a short lifetime. On such networks,
  the device should never gain IPv6 provisioning and should attempt to
  drop RAs via hardware offload, if available.
- Revert "spi: spi-zynqmp-gqspi: Fix runtime PM imbalance in
  zynqmp_qspi_probe" [Sasha Levin]

  This reverts commit 2cdec9c13f81313dd9f41f09c7cdecbfa4bea91d.

  Reported issues with the backport, revert for now.
- Revert "spi: zynqmp-gqspi: fix clock imbalance on probe failure"
  [Sasha Levin]

  This reverts commit 19f3d5d13b756b913be582a9e0d0afdeca9c397e.

  Reported issues with backport, revert for now.
- Workqueue: Override implicit ordered attribute in
  workqueue_apply_unbound_cpumask() [Waiman Long]

  [ Upstream commit ca10d851b9ad0338c19e8e3089e24d565ebfffd7 ]

  Commit 5c0338c68706 ("workqueue: restore WQ_UNBOUND/max_active==1
  to be ordered") enabled implicit ordered attribute to be added to
  WQ_UNBOUND workqueues with max_active of 1. This prevented the changing
  of attributes to these workqueues leading to fix commit 0a94efb5acbb
  ("workqueue: implicit ordered attribute should be overridable").

  However, workqueue_apply_unbound_cpumask() was not updated at that time.
  So sysfs changes to wq_unbound_cpumask has no effect on WQ_UNBOUND
  workqueues with implicit ordered attribute. Since not all WQ_UNBOUND
  workqueues are visible on sysfs, we are not able to make all the
  necessary cpumask changes even if we iterates all the workqueue cpumasks
  in sysfs and changing them one by one.

  Fix this problem by applying the corresponding change made
  to apply_workqueue_attrs_locked() in the fix commit to
  workqueue_apply_unbound_cpumask().
- Nfc: nci: assert requested protocol is valid. [Jeremy Cline]

  [ Upstream commit 354a6e707e29cb0c007176ee5b8db8be7bd2dee0 ]

  The protocol is used in a bit mask to determine if the protocol is
  supported. Assert the provided protocol is less than the maximum
  defined so it doesn't potentially perform a shift-out-of-bounds and
  provide a clearer error for undefined protocols vs unsupported ones.
- Pinctrl: renesas: rzn1: Enable missing PINMUX. [Ralph Siemsen]

  [ Upstream commit f055ff23c331f28aa4ace4b72dc56f63b9a726c8 ]

  Enable pin muxing (eg. programmable function), so that the RZ/N1 GPIO
  pins will be configured as specified by the pinmux in the DTS.

  This used to be enabled implicitly via CONFIG_GENERIC_PINMUX_FUNCTIONS,
  however that was removed, since the RZ/N1 driver does not call any of
  the generic pinmux functions.
- Net: nfc: fix races in nfc_llcp_sock_get() and nfc_llcp_sock_get_sn()
  [Eric Dumazet]

  [ Upstream commit 31c07dffafce914c1d1543c135382a11ff058d93 ]

  Sili Luo reported a race in nfc_llcp_sock_get(), leading to UAF.

  Getting a reference on the socket found in a lookup while
  holding a lock should happen before releasing the lock.

  nfc_llcp_sock_get_sn() has a similar problem.

  Finally nfc_llcp_recv_snl() needs to make sure the socket
  found by nfc_llcp_sock_from_sn() does not disappear.
- Ixgbe: fix crash with empty VF macvlan list. [Dan Carpenter]

  [ Upstream commit 7b5add9af567c44e12196107f0fe106e194034fd ]

  The adapter->vf_mvs.l list needs to be initialized even if the list is
  empty.  Otherwise it will lead to crashes.
- Net: phy: mscc: macsec: reject PN update requests. [Radu Pirea (NXP
  OSS)]

  [ Upstream commit e0a8c918daa58700609ebd45e3fcd49965be8bbc ]

  Updating the PN is not supported.
  Return -EINVAL if update_pn is true.

  The following command succeeded, but it should fail because the driver
  does not update the PN:
  ip macsec set macsec0 tx sa 0 pn 232 on
- Net: macsec: indicate next pn update when offloading. [Radu Pirea (NXP
  OSS)]

  [ Upstream commit 0412cc846a1ef38697c3f321f9b174da91ecd3b5 ]

  Indicate next PN update using update_pn flag in macsec_context.
  Offloaded MACsec implementations does not know whether or not the
  MACSEC_SA_ATTR_PN attribute was passed for an SA update and assume
  that next PN should always updated, but this is not always true.

  The PN can be reset to its initial value using the following command:
  $ ip macsec set macsec0 tx sa 0 off #octeontx2-pf case

  Or, the update PN command will succeed even if the driver does not support
  PN updates.
  $ ip macsec set macsec0 tx sa 0 pn 1 on #mscc phy driver case

  Comparing the initial PN with the new PN value is not a solution. When
  the user updates the PN using its initial value the command will
  succeed, even if the driver does not support it. Like this:
  $ ip macsec add macsec0 tx sa 0 pn 1 on key 00 \
  ead3664f508eb06c40ac7104cdae4ce5
  $ ip macsec set macsec0 tx sa 0 pn 1 on #mlx5 case
- Drm/vmwgfx: fix typo of sizeof argument. [Konstantin Meskhidze]

  [ Upstream commit 39465cac283702a7d4a507a558db81898029c6d3 ]

  Since size of 'header' pointer and '*header' structure is equal on 64-bit
  machines issue probably didn't cause any wrong behavior. But anyway,
  fixing typo is required.
- Riscv, bpf: Sign-extend return values. [Björn Töpel]

  [ Upstream commit 2f1b0d3d733169eb11680bfa97c266ae5e757148 ]

  The RISC-V architecture does not expose sub-registers, and hold all
  32-bit values in a sign-extended format [1] [2]:

    | The compiler and calling convention maintain an invariant that all
    | 32-bit values are held in a sign-extended format in 64-bit
    | registers. Even 32-bit unsigned integers extend bit 31 into bits
    | 63 through 32. Consequently, conversion between unsigned and
    | signed 32-bit integers is a no-op, as is conversion from a signed
    | 32-bit integer to a signed 64-bit integer.

  While BPF, on the other hand, exposes sub-registers, and use
  zero-extension (similar to arm64/x86).

  This has led to some subtle bugs, where a BPF JITted program has not
  sign-extended the a0 register (return value in RISC-V land), passed
  the return value up the kernel, e.g.:

    | int from_bpf(void);
    |
    | long foo(void)
    | {
    |    return from_bpf();
    | }

  Here, a0 would be 0xffff_ffff, instead of the expected
  0xffff_ffff_ffff_ffff.

  Internally, the RISC-V JIT uses a5 as a dedicated register for BPF
  return values.

  Keep a5 zero-extended, but explicitly sign-extend a0 (which is used
  outside BPF land). Now that a0 (RISC-V ABI) and a5 (BPF ABI) differs,
  a0 is only moved to a5 for non-BPF native calls (BPF_PSEUDO_CALL).
- Riscv, bpf: Factor out emit_call for kernel and bpf context. [Pu
  Lehui]

  [ Upstream commit 0fd1fd0104954380477353aea29c347e85dff16d ]

  The current emit_call function is not suitable for kernel function call as
  it store return value to bpf R0 register. We can separate it out for common
  use. Meanwhile, simplify judgment logic, that is, fixed function address
  can use jal or auipc+jalr, while the unfixed can use only auipc+jalr.
- Xen-netback: use default TX queue size for vifs. [Roger Pau Monne]

  [ Upstream commit 66cf7435a26917c0c4d6245ad9137e7606e84fdf ]

  Do not set netback interfaces (vifs) default TX queue size to the ring size.
  The TX queue size is not related to the ring size, and using the ring size (32)
  as the queue size can lead to packet drops.  Note the TX side of the vif
  interface in the netback domain is the one receiving packets to be injected
  to the guest.

  Do not explicitly set the TX queue length to any value when creating the
  interface, and instead use the system default.  Note that the queue length can
  also be adjusted at runtime.
- Mlxsw: fix mlxsw_sp2_nve_vxlan_learning_set() return type. [Dan
  Carpenter]

  [ Upstream commit 1e0b72a2a6432c0ef67ee5ce8d9172a7c20bba25 ]

  The mlxsw_sp2_nve_vxlan_learning_set() function is supposed to return
  zero on success or negative error codes.  So it needs to be type int
  instead of bool.
- Ieee802154: ca8210: Fix a potential UAF in ca8210_probe. [Dinghao Liu]

  [ Upstream commit f990874b1c98fe8e57ee9385669f501822979258 ]

  If of_clk_add_provider() fails in ca8210_register_ext_clock(),
  it calls clk_unregister() to release priv->clk and returns an
  error. However, the caller ca8210_probe() then calls ca8210_remove(),
  where priv->clk is freed again in ca8210_unregister_ext_clock(). In
  this case, a use-after-free may happen in the second time we call
  clk_unregister().

  Fix this by removing the first clk_unregister(). Also, priv->clk could
  be an error code on failure of clk_register_fixed_rate(). Use
  IS_ERR_OR_NULL to catch this case in ca8210_unregister_ext_clock().
- Ravb: Fix up dma_free_coherent() call in ravb_remove() [Yoshihiro
  Shimoda]

  [ Upstream commit e6864af61493113558c502b5cd0d754c19b93277 ]

  In ravb_remove(), dma_free_coherent() should be call after
  unregister_netdev(). Otherwise, this controller is possible to use
  the freed buffer.
- Drm/msm/dpu: change _dpu_plane_calc_bw() to use u64 to avoid overflow.
  [Abhinav Kumar]

  [ Upstream commit 95e681ca3b65e4ce3d2537b47672d787b7d30375 ]

  _dpu_plane_calc_bw() uses integer variables to calculate the bandwidth
  used during plane bandwidth calculations. However for high resolution
  displays this overflows easily and leads to below errors

  [dpu error]crtc83 failed performance check -7

  Promote the intermediate variables to u64 to avoid overflow.

  changes in v2:
  	- change to u64 where actually needed in the math
- Drm/msm/dsi: skip the wait for video mode done if not applicable.
  [Abhinav Kumar]

  [ Upstream commit ab483e3adcc178254eb1ce0fbdfbea65f86f1006 ]

  dsi_wait4video_done() API waits for the DSI video mode engine to
  become idle so that we can transmit the DCS commands in the
  beginning of BLLP. However, with the current sequence, the MDP
  timing engine is turned on after the panel's pre_enable() callback
  which can send out the DCS commands needed to power up the panel.

  During those cases, this API will always timeout and print out the
  error spam leading to long bootup times and log flooding.

  Fix this by checking if the DSI video engine was actually busy before
  waiting for it to become idle otherwise this is a redundant wait.

  changes in v2:
  	- move the reg read below the video mode check
  	- minor fixes in commit text
- Drm/msm/dp: do not reinitialize phy unless retry during link training.
  [Kuogee Hsieh]

  [ Upstream commit 0c1a2e69bcb506f48ebf94bd199bab0b93f66da2 ]

  DP PHY re-initialization done using dp_ctrl_reinitialize_mainlink() will
  cause PLL unlocked initially and then PLL gets locked at the end of
  initialization. PLL_UNLOCKED interrupt will fire during this time if the
  interrupt mask is enabled.

  However currently DP driver link training implementation incorrectly
  re-initializes PHY unconditionally during link training as the PHY was
  already configured in dp_ctrl_enable_mainlink_clocks().

  Fix this by re-initializing the PHY only if the previous link training
  failed.

  [drm:dp_aux_isr] *ERROR* Unexpected DP AUX IRQ 0x01000000 when not busy

  Fixes: c943b4948b58 ("drm/msm/dp: add displayPort driver support")
  Closes: https://gitlab.freedesktop.org/drm/msm/-/issues/30
  Signed-off-by: Kuogee Hsieh <quic_khsieh@quicinc.com>
  Tested-by: Abhinav Kumar <quic_abhinavk@quicinc.com> # sc7280
  Reviewed-by: Abhinav Kumar <quic_abhinavk@quicinc.com>
  Reviewed-by: Stephen Boyd <swboyd@chromium.org>
  Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
  Tested-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
  Patchwork: https://patchwork.freedesktop.org/patch/551847/
  Link: https://lore.kernel.org/r/1691533190-19335-1-git-send-email-quic_khsieh@quicinc.com
  [quic_abhinavk@quicinc.com: added line break in commit text]
- Net: prevent address rewrite in kernel_bind() [Jordan Rife]

  commit c889a99a21bf124c3db08d09df919f0eccc5ea4c upstream.

  Similar to the change in commit 0bdf399342c5("net: Avoid address
  overwrite in kernel_connect"), BPF hooks run on bind may rewrite the
  address passed to kernel_bind(). This change

  1) Makes a copy of the bind address in kernel_bind() to insulate
     callers.
  2) Replaces direct calls to sock->ops->bind() in net with kernel_bind()
- Quota: Fix slow quotaoff. [Jan Kara]

  commit 869b6ea1609f655a43251bf41757aa44e5350a8f upstream.

  Eric has reported that commit dabc8b207566 ("quota: fix dqput() to
  follow the guarantees dquot_srcu should provide") heavily increases
  runtime of generic/270 xfstest for ext4 in nojournal mode. The reason
  for this is that ext4 in nojournal mode leaves dquots dirty until the last
  dqput() and thus the cleanup done in quota_release_workfn() has to write
  them all. Due to the way quota_release_workfn() is written this results
  in synchronize_srcu() call for each dirty dquot which makes the dquot
  cleanup when turning quotas off extremely slow.

  To be able to avoid synchronize_srcu() for each dirty dquot we need to
  rework how we track dquots to be cleaned up. Instead of keeping the last
  dquot reference while it is on releasing_dquots list, we drop it right
  away and mark the dquot with new DQ_RELEASING_B bit instead. This way we
  can we can remove dquot from releasing_dquots list when new reference to
  it is acquired and thus there's no need to call synchronize_srcu() each
  time we drop dq_list_lock.
- HID: logitech-hidpp: Fix kernel crash on receiver USB disconnect.
  [Hans de Goede]

  commit dac501397b9d81e4782232c39f94f4307b137452 upstream.

  hidpp_connect_event() has *four* time-of-check vs time-of-use (TOCTOU)
  races when it races with itself.

  hidpp_connect_event() primarily runs from a workqueue but it also runs
  on probe() and if a "device-connected" packet is received by the hw
  when the thread running hidpp_connect_event() from probe() is waiting on
  the hw, then a second thread running hidpp_connect_event() will be
  started from the workqueue.

  This opens the following races (note the below code is simplified):

  1. Retrieving + printing the protocol (harmless race):

  	if (!hidpp->protocol_major) {
  		hidpp_root_get_protocol_version()
  		hidpp->protocol_major = response.rap.params[0];
  	}

  We can actually see this race hit in the dmesg in the abrt output
  attached to rhbz#2227968:

  [ 3064.624215] logitech-hidpp-device 0003:046D:4071.0049: HID++ 4.5 device connected.
  [ 3064.658184] logitech-hidpp-device 0003:046D:4071.0049: HID++ 4.5 device connected.

  Testing with extra logging added has shown that after this the 2 threads
  take turn grabbing the hw access mutex (send_mutex) so they ping-pong
  through all the other TOCTOU cases managing to hit all of them:

  2. Updating the name to the HIDPP name (harmless race):

  	if (hidpp->name == hdev->name) {
  		...
  		hidpp->name = new_name;
  	}

  3. Initializing the power_supply class for the battery (problematic!):

  hidpp_initialize_battery()
  {
          if (hidpp->battery.ps)
                  return 0;

  	probe_battery(); /* Blocks, threads take turns executing this */

  	hidpp->battery.desc.properties =
  		devm_kmemdup(dev, hidpp_battery_props, cnt, GFP_KERNEL);

  	hidpp->battery.ps =
  		devm_power_supply_register(&hidpp->hid_dev->dev,
  					   &hidpp->battery.desc, cfg);
  }

  4. Creating delayed input_device (potentially problematic):

  	if (hidpp->delayed_input)
  		return;

  	hidpp->delayed_input = hidpp_allocate_input(hdev);

  The really big problem here is 3. Hitting the race leads to the following
  sequence:

  	hidpp->battery.desc.properties =
  		devm_kmemdup(dev, hidpp_battery_props, cnt, GFP_KERNEL);

  	hidpp->battery.ps =
  		devm_power_supply_register(&hidpp->hid_dev->dev,
  					   &hidpp->battery.desc, cfg);

  	...

  	hidpp->battery.desc.properties =
  		devm_kmemdup(dev, hidpp_battery_props, cnt, GFP_KERNEL);

  	hidpp->battery.ps =
  		devm_power_supply_register(&hidpp->hid_dev->dev,
  					   &hidpp->battery.desc, cfg);

  So now we have registered 2 power supplies for the same battery,
  which looks a bit weird from userspace's pov but this is not even
  the really big problem.

  Notice how:

  1. This is all devm-maganaged
  2. The hidpp->battery.desc struct is shared between the 2 power supplies
  3. hidpp->battery.desc.properties points to the result from the second
     devm_kmemdup()

  This causes a use after free scenario on USB disconnect of the receiver:
  1. The last registered power supply class device gets unregistered
  2. The memory from the last devm_kmemdup() call gets freed,
     hidpp->battery.desc.properties now points to freed memory
  3. The first registered power supply class device gets unregistered,
     this involves sending a remove uevent to userspace which invokes
     power_supply_uevent() to fill the uevent data
  4. power_supply_uevent() uses hidpp->battery.desc.properties which
     now points to freed memory leading to backtraces like this one:

  Sep 22 20:01:35 eric kernel: BUG: unable to handle page fault for address: ffffb2140e017f08
  ...
  Sep 22 20:01:35 eric kernel: Workqueue: usb_hub_wq hub_event
  Sep 22 20:01:35 eric kernel: RIP: 0010:power_supply_uevent+0xee/0x1d0
  ...
  Sep 22 20:01:35 eric kernel:  ? asm_exc_page_fault+0x26/0x30
  Sep 22 20:01:35 eric kernel:  ? power_supply_uevent+0xee/0x1d0
  Sep 22 20:01:35 eric kernel:  ? power_supply_uevent+0x10d/0x1d0
  Sep 22 20:01:35 eric kernel:  dev_uevent+0x10f/0x2d0
  Sep 22 20:01:35 eric kernel:  kobject_uevent_env+0x291/0x680
  Sep 22 20:01:35 eric kernel:  power_supply_unregister+0x8e/0xa0
  Sep 22 20:01:35 eric kernel:  release_nodes+0x3d/0xb0
  Sep 22 20:01:35 eric kernel:  devres_release_group+0xfc/0x130
  Sep 22 20:01:35 eric kernel:  hid_device_remove+0x56/0xa0
  Sep 22 20:01:35 eric kernel:  device_release_driver_internal+0x19f/0x200
  Sep 22 20:01:35 eric kernel:  bus_remove_device+0xc6/0x130
  Sep 22 20:01:35 eric kernel:  device_del+0x15c/0x3f0
  Sep 22 20:01:35 eric kernel:  ? __queue_work+0x1df/0x440
  Sep 22 20:01:35 eric kernel:  hid_destroy_device+0x4b/0x60
  Sep 22 20:01:35 eric kernel:  logi_dj_remove+0x9a/0x100 [hid_logitech_dj 5c91534a0ead2b65e04dd799a0437e3b99b21bc4]
  Sep 22 20:01:35 eric kernel:  hid_device_remove+0x44/0xa0
  Sep 22 20:01:35 eric kernel:  device_release_driver_internal+0x19f/0x200
  Sep 22 20:01:35 eric kernel:  bus_remove_device+0xc6/0x130
  Sep 22 20:01:35 eric kernel:  device_del+0x15c/0x3f0
  Sep 22 20:01:35 eric kernel:  ? __queue_work+0x1df/0x440
  Sep 22 20:01:35 eric kernel:  hid_destroy_device+0x4b/0x60
  Sep 22 20:01:35 eric kernel:  usbhid_disconnect+0x47/0x60 [usbhid 727dcc1c0b94e6b4418727a468398ac3bca492f3]
  Sep 22 20:01:35 eric kernel:  usb_unbind_interface+0x90/0x270
  Sep 22 20:01:35 eric kernel:  device_release_driver_internal+0x19f/0x200
  Sep 22 20:01:35 eric kernel:  bus_remove_device+0xc6/0x130
  Sep 22 20:01:35 eric kernel:  device_del+0x15c/0x3f0
  Sep 22 20:01:35 eric kernel:  ? kobject_put+0xa0/0x1d0
  Sep 22 20:01:35 eric kernel:  usb_disable_device+0xcd/0x1e0
  Sep 22 20:01:35 eric kernel:  usb_disconnect+0xde/0x2c0
  Sep 22 20:01:35 eric kernel:  usb_disconnect+0xc3/0x2c0
  Sep 22 20:01:35 eric kernel:  hub_event+0xe80/0x1c10

  There have been quite a few bug reports (see Link tags) about this crash.

  Fix all the TOCTOU issues, including the really bad power-supply related
  system crash on USB disconnect, by making probe() use the workqueue for
  running hidpp_connect_event() too, so that it can never run more then once.
- Lib/test_meminit: fix off-by-one error in test_pages() [Greg Kroah-
  Hartman]

  commit efb78fa86e95 ("lib/test_meminit: allocate pages up to order
  MAX_ORDER") works great in kernels 6.4 and newer thanks to commit
  23baf831a32c ("mm, treewide: redefine MAX_ORDER sanely"), but for older
  kernels, the loop is off by one, which causes crashes when the test
  runs.

  Fix this up by changing "<= MAX_ORDER" "< MAX_ORDER" to allow the test
  to work properly for older kernel branches.
- Perf/arm-cmn: Fix the unhandled overflow status of counter 4 to 7.
  [Jing Zhang]

  [ Upstream commit 7f949f6f54ff593123ab95b6247bfa4542a65580 ]

  The register por_dt_pmovsr Bits[7:0] indicates overflow from counters 7
  to 0. But in arm_cmn_handle_irq(), only handled the overflow status of
  Bits[3:0] which results in unhandled overflow status of counters 4 to 7.

  So let the overflow status of DTC counters 4 to 7 to be handled.
- RDMA/cxgb4: Check skb value for failure to allocate. [Artem
  Chernyshev]

  [ Upstream commit 8fb8a82086f5bda6893ea6557c5a458e4549c6d7 ]

  get_skb() can fail to allocate skb, so check it.

  Found by Linux Verification Center (linuxtesting.org) with SVACE.
- RDMA/srp: Do not call scsi_done() from srp_abort() [Bart Van Assche]

  [ Upstream commit e193b7955dfad68035b983a0011f4ef3590c85eb ]

  After scmd_eh_abort_handler() has called the SCSI LLD eh_abort_handler
  callback, it performs one of the following actions:
  * Call scsi_queue_insert().
  * Call scsi_finish_command().
  * Call scsi_eh_scmd_add().
  Hence, SCSI abort handlers must not call scsi_done(). Otherwise all
  the above actions would trigger a use-after-free. Hence remove the
  scsi_done() call from srp_abort(). Keep the srp_free_req() call
  before returning SUCCESS because we may not see the command again if
  SUCCESS is returned.
- RDMA/srp: Make struct scsi_cmnd and struct srp_request adjacent. [Bart
  Van Assche]

  [ Upstream commit ad215aaea4f9d637f441566cdbbc610e9849e1fa ]

  Define .init_cmd_priv and .exit_cmd_priv callback functions in struct
  scsi_host_template. Set .cmd_size such that the SCSI core allocates
  per-command private data. Use scsi_cmd_priv() to access that private
  data. Remove the req_ring pointer from struct srp_rdma_ch since it is no
  longer necessary. Convert srp_alloc_req_data() and srp_free_req_data()
  into functions that initialize one instance of the SRP-private command
  data. This is a micro-optimization since this patch removes several
  pointer dereferences from the hot path.

  Note: due to commit e73a5e8e8003 ("scsi: core: Only return started
  requests from scsi_host_find_tag()"), it is no longer necessary to protect
  the completion path against duplicate responses.


